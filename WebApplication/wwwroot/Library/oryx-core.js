XMLNS={ATOM:"http://www.w3.org/2005/Atom",XHTML:"http://www.w3.org/1999/xhtml",ERDF:"http://purl.org/NET/erdf/profile",RDFS:"http://www.w3.org/2000/01/rdf-schema#",RDF:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",RAZIEL:"http://b3mn.org/Raziel",SCHEMA:""};if(!Repository){Repository={}}
if(!Repository.Config){Repository.Config={}}
Repository.Config.BACKEND_PATH=Repository.contextPath+'/poem';Repository.Config.STENCILSET_URI=Repository.contextPath+"/stencilsets/stencilsets.json";Repository.Config.PATH=Repository.contextPath+'/repository2/';Repository.Config.PLUGIN_PATH='plugins/';Repository.Config.PLUGIN_CONFIG='plugins.xml';Repository.Config.SORT_DESC='desc';Repository.Config.SORT_ASC='asc';Repository.Config.ABOUT_DIALOG_HEIGHT=480;Repository.Config.ABOUT_DIALOG_WIDTH=640;Repository.Config.POLL_INTERVAL_MINUTES=10;Repository.Config.SMP_VERSION='SMP_7.0.3';ORYX.Utils={getParamFromUrl:function(name){name=name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");var regexS="[\\?&]"+name+"=([^&#]*)";var regex=new RegExp(regexS);var results=regex.exec(window.location.href);if(results==null){return null;}
else{return results[1];}},adjustGradient:function(gradient,reference){if(ORYX.CONFIG.DISABLE_GRADIENT&&gradient){var col=reference.getAttributeNS(null,"stop-color")||"#ffffff";$A(gradient.getElementsByTagName("stop")).each(function(stop){if(stop==reference){return;}
stop.setAttributeNS(null,"stop-color",col);})}},setDocumentTitle:function(title){document.title=title.replace(/&amp;/g,"&");}}
if(!ORYX.Utils.I18NHelper){ORYX.Utils.I18NHelper={};}
ORYX.Utils.I18NHelper.getChannel=function(channelObj){var i18nString=null;if(ORYX.I18N.PropertyWindow.channel[channelObj.id]!==undefined){i18nString=ORYX.I18N.PropertyWindow.channel[channelObj.id];}else{i18nString=String.format(ORYX.I18N.PropertyWindow.channel.other,channelObj.name);}
return i18nString;};XMLNS={ATOM:"http://www.w3.org/2005/Atom",XHTML:"http://www.w3.org/1999/xhtml",ERDF:"http://purl.org/NET/erdf/profile",RDFS:"http://www.w3.org/2000/01/rdf-schema#",RDF:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",RAZIEL:"http://b3mn.org/Raziel",SCHEMA:""};var Kickstart={started:false,callbacks:[],alreadyLoaded:[],PATH:'',load:function(){Kickstart.kick();},kick:function(){if(!Kickstart.started){Kickstart.started=true;Kickstart.callbacks.each(function(callback){window.setTimeout(callback,1);});}},register:function(callback){with(Kickstart){if(started)window.setTimeout(callback,1);else Kickstart.callbacks.push(callback)}},require:function(url){if(Kickstart.alreadyLoaded.member(url))
return false;return Kickstart.include(url);},include:function(url){var head=document.getElementsByTagNameNS(XMLNS.XHTML,'head')[0];var s=document.createElementNS(XMLNS.XHTML,"script");s.setAttributeNS(XMLNS.XHTML,'type','text/javascript');s.src=Kickstart.PATH+url;head.appendChild(s);Kickstart.alreadyLoaded.push(url);return true;}}
Event.observe(window,'load',Kickstart.load);var ERDF={LITERAL:0x01,RESOURCE:0x02,DELIMITERS:['.','-'],HASH:'#',HYPHEN:"-",schemas:[],callback:undefined,log:undefined,init:function(callback){ERDF.callback=callback;ERDF.registerSchema('schema',XMLNS.SCHEMA);ERDF.registerSchema('rdfs',XMLNS.RDFS);},run:function(){return ERDF._checkProfile()&&ERDF.parse();},parse:function(){ERDF.__startTime=new Date();var bodies=document.getElementsByTagNameNS(XMLNS.XHTML,'body');var subject={type:ERDF.RESOURCE,value:''};var result=ERDF._parseDocumentMetadata()&&ERDF._parseFromTag(bodies[0],subject);ERDF.__stopTime=new Date();var duration=(ERDF.__stopTime-ERDF.__startTime)/1000.;return result;},_parseDocumentMetadata:function(){var heads=document.getElementsByTagNameNS(XMLNS.XHTML,'head');var links=heads[0].getElementsByTagNameNS(XMLNS.XHTML,'link');var metas=heads[0].getElementsByTagNameNS(XMLNS.XHTML,'meta');$A(links).each(function(link){var properties=link.getAttribute('rel');var reversedProperties=link.getAttribute('rev');var value=link.getAttribute('href');ERDF._parseTriplesFrom(ERDF.RESOURCE,'',properties,ERDF.RESOURCE,value);ERDF._parseTriplesFrom(ERDF.RESOURCE,value,reversedProperties,ERDF.RESOURCE,'');});$A(metas).each(function(meta){var property=meta.getAttribute('name');var value=meta.getAttribute('content');ERDF._parseTriplesFrom(ERDF.RESOURCE,'',property,ERDF.LITERAL,value);});return true;},_parseFromTag:function(node,subject,depth){if(node.namespaceURI!=XMLNS.XHTML){return;}
if(!depth)depth=0;var id=node.getAttribute('id');if(node.nodeName.endsWith(':a')||node.nodeName=='a'){var properties=node.getAttribute('rel');var reversedProperties=node.getAttribute('rev');var value=node.getAttribute('href');var title=node.getAttribute('title');var content=node.textContent;ERDF._parseTriplesFrom(subject.type,subject.value,properties,ERDF.RESOURCE,value,function(triple){var label=title?title:content;ERDF._parseTriplesFrom(triple.object.type,triple.object.value,'rdfs.label',ERDF.LITERAL,label);});ERDF._parseTriplesFrom(subject.type,subject.value,reversedProperties,ERDF.RESOURCE,'');ERDF._parseTypeTriplesFrom(subject.type,subject.value,properties);}else if(node.nodeName.endsWith(':img')||node.nodeName=='img'){var properties=node.getAttribute('class');var value=node.getAttribute('src');var alt=node.getAttribute('alt');ERDF._parseTriplesFrom(subject.type,subject.value,properties,ERDF.RESOURCE,value,function(triple){var label=alt;ERDF._parseTriplesFrom(triple.object.type,triple.object.value,'rdfs.label',ERDF.LITERAL,label);});}
var properties=node.getAttribute('class');var title=node.getAttribute('title');var content=node.textContent;var label=title?title:content;ERDF._parseTriplesFrom(subject.type,subject.value,properties,ERDF.LITERAL,label);if(id)subject={type:ERDF.RESOURCE,value:ERDF.HASH+id};ERDF._parseTypeTriplesFrom(subject.type,subject.value,properties);var children=node.childNodes;if(children)$A(children).each(function(_node){if(_node.nodeType==_node.ELEMENT_NODE)
ERDF._parseFromTag(_node,subject,depth+1);});},_parseTriplesFrom:function(subjectType,subject,properties,objectType,object,callback){if(!properties)return;properties.toLowerCase().split(' ').each(function(property){var schema=ERDF.schemas.find(function(schema){return false||ERDF.DELIMITERS.find(function(delimiter){return property.startsWith(schema.prefix+delimiter);});});if(schema&&object){property=property.substring(schema.prefix.length+1,property.length);var triple=ERDF.registerTriple(new ERDF.Resource(subject),{prefix:schema.prefix,name:property},(objectType==ERDF.RESOURCE)?new ERDF.Resource(object):new ERDF.Literal(object));if(callback)callback(triple);}});},_parseTypeTriplesFrom:function(subjectType,subject,properties,callback){if(!properties)return;properties.toLowerCase().split(' ').each(function(property){var schema=ERDF.schemas.find(function(schema){return false||ERDF.DELIMITERS.find(function(delimiter){return property.startsWith(ERDF.HYPHEN+schema.prefix+delimiter);});});if(schema&&subject){property=property.substring(schema.prefix.length+2,property.length);var triple=ERDF.registerTriple((subjectType==ERDF.RESOURCE)?new ERDF.Resource(subject):new ERDF.Literal(subject),{prefix:'rdf',name:'type'},new ERDF.Resource(schema.namespace+property));if(callback)callback(triple);}});},_checkProfile:function(){var heads=document.getElementsByTagNameNS(XMLNS.XHTML,'head');var profiles=heads[0].getAttribute("profile");var found=false;if(profiles&&profiles.split(" ").member(XMLNS.ERDF)){return true;}else{return false;}},__stripHashes:function(s){return(s&&s.substring(0,1)=='#')?s.substring(1,s.length):s;},registerSchema:function(prefix,namespace){ERDF.schemas.push({prefix:prefix,namespace:namespace});},registerTriple:function(subject,predicate,object){if(predicate.prefix.toLowerCase()=='schema')
this.registerSchema(predicate.name,object.value);var triple=new ERDF.Triple(subject,predicate,object);ERDF.callback(triple);return triple;},__enhanceObject:function(){this.isResource=function(){return this.type==ERDF.RESOURCE};this.isLocal=function(){return this.isResource()&&this.value.startsWith('#')};this.isCurrentDocument=function(){return this.isResource()&&(this.value=='')};this.getId=function(){return this.isLocal()?ERDF.__stripHashes(this.value):false;};this.isLiteral=function(){return this.type==ERDF.LIITERAL};},serialize:function(literal){if(!literal){return"";}else if(literal.constructor==String){return literal;}else if(literal.constructor==Boolean){return literal?'true':'false';}else{return literal.toString();}}};ERDF.Triple=function(subject,predicate,object){this.subject=subject;this.predicate=predicate;this.object=object;this.toString=function(){return"[ERDF.Triple] "+
this.subject.toString()+' '+
this.predicate.prefix+':'+this.predicate.name+' '+
this.object.toString();};};ERDF.Resource=function(uri){this.type=ERDF.RESOURCE;this.value=uri;ERDF.__enhanceObject.apply(this);this.toString=function(){return'&lt;'+this.value+'&gt;';}};ERDF.Literal=function(literal){this.type=ERDF.LITERAL;this.value=ERDF.serialize(literal);ERDF.__enhanceObject.apply(this);this.toString=function(){return'"'+this.value+'"';}};var USE_ASYNCHRONOUS_REQUESTS=true;var DISCARD_UNUSED_TRIPLES=true;var PREFER_SPANS_OVER_DIVS=true;var PREFER_TITLE_OVER_TEXTNODE=false;var RESOURCE_ID_PREFIX='resource';var SHOW_DEBUG_ALERTS_WHEN_SAVING=false;var SHOW_EXTENDED_DEBUG_INFORMATION=false;var USE_ARESS_WORKAROUNDS=true;var RESOURCE_CREATED=0x01;var RESOURCE_REMOVED=0x02;var RESOURCE_SAVED=0x04;var RESOURCE_RELOADED=0x08;var RESOURCE_SYNCHRONIZED=0x10;var TRIPLE_REMOVE=0x01;var TRIPLE_ADD=0x02;var TRIPLE_RELOAD=0x04;var TRIPLE_SAVE=0x08;var PROCESSDATA_REF='processdata';var DataManager={init:function(){ERDF.init(DataManager._registerTriple);DataManager.__synclocal();},_triples:[],_registerTriple:function(triple){DataManager._triples.push(triple)},__synclocal:function(){DataManager._triples=[];ERDF.run();},__synchronizeShape:function(shape){var r=ResourceManager.getResource(shape.resourceId);var serialize=shape.serialize();serialize.each(function(ser){var resource=(ser.type=='resource');var _triple=new ERDF.Triple(new ERDF.Resource(shape.resourceId),{prefix:ser.prefix,name:ser.name},resource?new ERDF.Resource(ser.value):new ERDF.Literal(ser.value));DataManager.setObject(_triple);});return r;},__storeShape:function(shape){var resource=DataManager.__synchronizeShape(shape);resource.save();},__forceExistance:function(shape){if(!$(shape.resourceId)){if(!$$('.'+PROCESSDATA_REF)[0])
DataManager.graft(XMLNS.XHTML,document.getElementsByTagNameNS(XMLNS.XHTML,'body').item(0),['div',{'class':PROCESSDATA_REF,'style':'display:none;'}]);DataManager.graft(XMLNS.XHTML,$$('.'+PROCESSDATA_REF)[0],['div',{'id':shape.resourceId,'class':(shape instanceof ORYX.Core.Canvas)?"-oryx-canvas":undefined}]);}else{var resource=$(shape.resourceId)
var children=$A(resource.childNodes)
children.each(function(child){resource.removeChild(child);});};},__persistShape:function(shape){var shapeData=shape.serialize();var triplesArray=[];var shapeResource=new ERDF.Resource(shape.resourceId);DataManager.removeTriples(DataManager.query(shapeResource,undefined,undefined));shapeData.each(function(data){var value=(data.type=='resource')?new ERDF.Resource(data.value):new ERDF.Literal(data.value);DataManager.addTriple(new ERDF.Triple(shapeResource,{prefix:data.prefix,name:data.name},value));});},__persistDOM:function(facade){var canvas=facade.getCanvas();var shapes=canvas.getChildShapes(true);var result='';shapes.each(function(shape){DataManager.__forceExistance(shape);});DataManager.__renderCanvas(facade);result+=DataManager.serialize($(ERDF.__stripHashes(facade.getCanvas().resourceId)),true);shapes.each(function(shape){DataManager.__persistShape(shape);result+=DataManager.serialize($(ERDF.__stripHashes(shape.resourceId)),true);});return result;},__renderCanvas:function(facade){var canvas=facade.getCanvas();var stencilSets=facade.getStencilSets();var shapes=canvas.getChildShapes(true);DataManager.__forceExistance(canvas);DataManager.__persistShape(canvas);var shapeResource=new ERDF.Resource(canvas.resourceId);DataManager.removeTriples(DataManager.query(shapeResource,undefined,undefined));DataManager.addTriple(new ERDF.Triple(shapeResource,{prefix:"oryx",name:"mode"},new ERDF.Literal("writable")));DataManager.addTriple(new ERDF.Triple(shapeResource,{prefix:"oryx",name:"mode"},new ERDF.Literal("fullscreen")));stencilSets.values().each(function(stencilset){DataManager.addTriple(new ERDF.Triple(shapeResource,{prefix:"oryx",name:"stencilset"},new ERDF.Resource(stencilset.source().replace(/&/g,"%26"))));DataManager.addTriple(new ERDF.Triple(shapeResource,{prefix:"oryx",name:"ssnamespace"},new ERDF.Resource(stencilset.namespace())));stencilset.extensions().keys().each(function(extension){DataManager.addTriple(new ERDF.Triple(shapeResource,{prefix:"oryx",name:"ssextension"},new ERDF.Literal(extension)));});});shapes.each(function(shape){DataManager.addTriple(new ERDF.Triple(shapeResource,{prefix:"oryx",name:"render"},new ERDF.Resource("#"+shape.resourceId)));});},__counter:0,__provideId:function(){while($(RESOURCE_ID_PREFIX+DataManager.__counter))
DataManager.__counter++;return RESOURCE_ID_PREFIX+DataManager.__counter;},serializeDOM:function(facade){return DataManager.__persistDOM(facade);},syncGlobal:function(facade){return DataManager.__syncglobal(facade);},__syncglobal:function(facade){var canvas=facade.getCanvas();var shapes=canvas.getChildShapes(true);shapes.select(function(shape){return!($(shape.resourceId));}).each(function(shape){if(USE_ARESS_WORKAROUNDS){var razielType=shape.properties['raziel-type'];var div='<div xmlns="http://www.w3.org/1999/xhtml">'+'<span class="raziel-type">'+razielType+'</span></div>';var r=ResourceManager.__createResource(div);shape.resourceId=r.id();}else{var r=ResourceManager.__createResource();shape.resourceId=r.id();}});shapes.each(function(shape){DataManager.__storeShape(shape);});},serialize:function(node,preserveNamespace){if(node.nodeType==node.ELEMENT_NODE){var children=$A(node.childNodes);var attributes=$A(node.attributes);var clazz=new String(node.getAttribute('class'));var ignore=clazz.split(' ').member('transient');if(ignore)
return'';var result='<'+node.nodeName;if(!preserveNamespace)
result+=' xmlns="'+(node.namespaceURI?node.namespaceURI:XMLNS.XHTML)+'" xmlns:oryx="http://oryx-editor.org"';attributes.each(function(attribute){result+=' '+attribute.nodeName+'="'+
attribute.nodeValue+'"';});if(children.length==0)
result+='/>';else{result+='>';children.each(function(_node){result+=DataManager.serialize(_node,true)});result+='</'+node.nodeName+'>'}
return result;}else if(node.nodeType==node.TEXT_NODE){return node.nodeValue;}},addTriple:function(triple){if(!triple.subject.type==ERDF.LITERAL)
throw'Cannot add the triple '+triple.toString()+' because the subject is not a resource.'
var elementId=ERDF.__stripHashes(triple.subject.value);var element=$(elementId);if(!element)
throw'Cannot add the triple '+triple.toString()+' because the subject "'+elementId+'" is not in the document.';if(triple.object.type==ERDF.LITERAL)
DataManager.graft(XMLNS.XHTML,element,['span',{'class':(triple.predicate.prefix+"-"+
triple.predicate.name)},triple.object.value.escapeHTML()]);else{DataManager.graft(XMLNS.XHTML,element,['a',{'rel':(triple.predicate.prefix+"-"+
triple.predicate.name),'href':triple.object.value}]);}
return true;},removeTriples:function(triples){var removed=triples.select(function(triple){return DataManager.__removeTriple(triple);});return removed;},removeTriple:function(triple){var result=DataManager.__removeTriple(triple);return result;},__removeTriple:function(triple){if(!triple.subject.type==ERDF.LITERAL)
throw'Cannot remove the triple '+triple.toString()+' because the subject is not a resource.';var elementId=ERDF.__stripHashes(triple.subject.value);var element=$(elementId);if(!element)
throw'Cannot remove the triple '+triple.toString()+' because the subject is not in the document.';if(triple.object.type==ERDF.LITERAL){var result=DataManager.__removeTripleRecursively(triple,element);return result;}},__removeTripleRecursively:function(triple,continueFrom){if(continueFrom.nodeType!=continueFrom.ELEMENT_NODE)
return false;var classes=new String(continueFrom.getAttribute('class'));var children=$A(continueFrom.childNodes);if(classes.include(triple.predicate.prefix+'-'+triple.predicate.name)){var content=continueFrom.textContent;if((triple.object.type==ERDF.LITERAL)&&(triple.object.value==content))
continueFrom.parentNode.removeChild(continueFrom);return true;}else{children.each(function(_node){DataManager.__removeTripleRecursively(triple,_node)});return false;}},graft:function(namespace,parent,t,doc){doc=(doc||(parent&&parent.ownerDocument)||document);var e;if(t===undefined){echo("Can't graft an undefined value");}else if(t.constructor==String){e=doc.createTextNode(t);}else{for(var i=0;i<t.length;i++){if(i===0&&t[i].constructor==String){var snared=t[i].match(/^([a-z][a-z0-9]*)\.([^\s\.]+)$/i);if(snared){e=doc.createElementNS(namespace,snared[1]);e.setAttributeNS(null,'class',snared[2]);continue;}
snared=t[i].match(/^([a-z][a-z0-9]*)$/i);if(snared){e=doc.createElementNS(namespace,snared[1]);continue;}
e=doc.createElementNS(namespace,"span");e.setAttribute(null,"class","namelessFromLOL");}
if(t[i]===undefined){echo("Can't graft an undefined value in a list!");}else if(t[i].constructor==String||t[i].constructor==Array){this.graft(namespace,e,t[i],doc);}else if(t[i].constructor==Number){this.graft(namespace,e,t[i].toString(),doc);}else if(t[i].constructor==Object){for(var k in t[i]){e.setAttributeNS(null,k,t[i][k]);}}else if(t[i].constructor==Boolean){this.graft(namespace,e,t[i]?'true':'false',doc);}else
throw"Object "+t[i]+" is inscrutable as an graft arglet.";}}
if(parent)parent.appendChild(e);return Element.extend(e);},setObject:function(triple){var triples=DataManager.query(triple.subject,triple.predicate,undefined);DataManager.removeTriples(triples);DataManager.addTriple(triple);return true;},query:function(subject,predicate,object){return DataManager._triples.select(function(triple){var select=((subject)?(triple.subject.type==subject.type)&&(triple.subject.value==subject.value):true);if(predicate){select=select&&((predicate.prefix)?(triple.predicate.prefix==predicate.prefix):true);select=select&&((predicate.name)?(triple.predicate.name==predicate.name):true);}
select=select&&((object)?(triple.object.type==object.type)&&(triple.object.value==object.value):true);return select;});}}
Kickstart.register(DataManager.init);function assert(expr,m){if(!expr)throw m;};function DMCommand(action,triple){this.action=action;this.triple=triple;this.toString=function(){return'Command('+action+', '+triple+')';};}
function DMCommandHandler(nextHandler){this.__setNext=function(handler){var _next=this.__next;this.__next=nextHandler;return _next?_next:true;};this.__setNext(nextHandler);this.__invokeNext=function(command){return this.__next?this.__next.handle(command):false;};this.handle=function(command){return this.process(command)?true:this.__invokeNext(command);}
this.process=function(command){return false;};};function MetaTagHandler(next){DMCommandHandler.apply(this,[next]);this.process=function(command){with(command.triple){if(!((subject instanceof ERDF.Resource)&&(subject.isCurrentDocument())&&(object instanceof ERDF.Literal)))return false;}};};var chain=new MetaTagHandler();var command=new DMCommand(TRIPLE_ADD,new ERDF.Triple(new ERDF.Resource(''),'rdf:tool',new ERDF.Literal('')));ResourceManager={__corrupt:false,__latelyCreatedResource:undefined,__listeners:$H(),__token:1,addListener:function(listener,mask){if(!(listener instanceof Function))
throw'Resource event listener is not a function!';if(!(mask))
throw'Invalid mask for resource event listener registration.';var controller={listener:listener,mask:mask};var token=ResourceManager.__token++;ResourceManager.__listeners[token]=controller;return token;},removeListener:function(token){return ResourceManager.__listners.remove(token);},__Event:function(action,resourceId){this.action=action;this.resourceId=resourceId;},__dispatchEvent:function(event){ResourceManager.__listeners.values().each(function(controller){if(event.action&controller.mask)
return controller.listener(event);});},getResource:function(id){id=ERDF.__stripHashes(id);var resources=DataManager.query(new ERDF.Resource('#'+id),{prefix:'raziel',name:'entry'},undefined);if((resources.length==1)&&(resources[0].object.isResource())){var entryUrl=resources[0].object.value;return new ResourceManager.__Resource(id,entryUrl);}
throw('Resource with id '+id+' not recognized as such. '+
((resources.length>1)?' There is more than one raziel:entry URL.':' There is no raziel:entry URL.'));return false;},__createResource:function(alternativeDiv){var collectionUrls=DataManager.query(new ERDF.Resource(''),{prefix:'raziel',name:'collection'},undefined);if((collectionUrls.length==1)&&(collectionUrls[0].object.isResource())){var collectionUrl=collectionUrls[0].object.value;var resource=undefined;var serialization=alternativeDiv?alternativeDiv:'<div xmlns="http://www.w3.org/1999/xhtml"></div>';ResourceManager.__request('POST',collectionUrl,serialization,function(){var response=(this.responseXML);var div=response.childNodes[0];var id=div.getAttribute('id');if(!$$('.'+PROCESSDATA_REF)[0])
DataManager.graft(XMLNS.XHTML,document.getElementsByTagNameNS(XMLNS.XHTML,'body').item(0),['div',{'class':PROCESSDATA_REF,'style':'display:none;'}]);$$('.'+PROCESSDATA_REF)[0].appendChild(div.cloneNode(true));DataManager.__synclocal();resource=new ResourceManager.getResource(id);ResourceManager.__resourceActionSucceeded(this,RESOURCE_CREATED,undefined);},function(){ResourceManager.__resourceActionFailed(this,RESOURCE_CREATED,undefined);},false);return resource;}
throw'Could not create resource! raziel:collection URL is missing!';return false;},__Resource:function(id,url){this.__id=id;this.__url=url;this.id=function(){return this.__id;}
this.url=function(){return this.__url;}
this.reload=function(){var _url=this.__url;var _id=this.__id;ResourceManager.__request('GET',_url,null,function(){ResourceManager.__resourceActionSucceeded(this,RESOURCE_RELOADED,_id);},function(){ResourceManager.__resourceActionFailed(this,RESURCE_RELOADED,_id);},USE_ASYNCHRONOUS_REQUESTS);};this.save=function(synchronize){var _url=this.__url;var _id=this.__id;data=DataManager.serialize($(_id));ResourceManager.__request('PUT',_url,data,function(){ResourceManager.__resourceActionSucceeded(this,synchronize?RESOURCE_SAVED|RESOURCE_SYNCHRONIZED:RESOURCE_SAVED,_id);},function(){ResourceManager.__resourceActionFailed(this,synchronize?RESOURCE_SAVED|RESOURCE_SYNCHRONIZED:RESOURCE.SAVED,_id);},USE_ASYNCHRONOUS_REQUESTS);};this.remove=function(){var _url=this.__url;var _id=this.__id;ResourceManager.__request('DELETE',_url,null,function(){ResourceManager.__resourceActionSucceeded(this,RESOURCE_REMOVED,_id);},function(){ResourceManager.__resourceActionFailed(this,RESOURCE_REMOVED,_id);},USE_ASYNCHRONOUS_REQUESTS);};},request:function(url,requestOptions){var options={method:'get',asynchronous:true,parameters:{}};Object.extend(options,requestOptions||{});var params=Hash.toQueryString(options.parameters);if(params)
url+=(url.include('?')?'&':'?')+params;return ResourceManager.__request(options.method,url,options.data,(options.onSuccess instanceof Function?function(){options.onSuccess(this);}:undefined),(options.onFailure instanceof Function?function(){options.onFailure(this);}:undefined),options.asynchronous&&USE_ASYNCHRONOUS_REQUESTS,options.headers);},__request:function(method,url,data,success,error,async,headers){var httpRequest=Try.these(function(){return new XMLHttpRequest();},function(){return new ActiveXObject("Msxml2.XMLHTTP");},function(){return new ActiveXObject("Microsoft.XMLHTTP")});if(!httpRequest){if(!this.__corrupt)
throw'This browser does not provide any AJAX functionality. You will not be able to use the software provided with the page you are viewing. Please consider installing appropriate extensions.';this.__corrupt=true;return false;}
if(success instanceof Function)
httpRequest.onload=success;if(error instanceof Function){httpRequest.onerror=error;}
var h=$H(headers)
h.keys().each(function(key){httpRequest.setRequestHeader(key,h[key]);});try{if(SHOW_DEBUG_ALERTS_WHEN_SAVING)
alert(method+' '+url+'\n'+
SHOW_EXTENDED_DEBUG_INFORMATION?data:'');httpRequest.open(method,url,!async?false:true);httpRequest.send(data);}catch(e){return false;}
return true;},__resourceActionSucceeded:function(transport,action,id){var status=transport.status;var response=transport.responseText;if(SHOW_DEBUG_ALERTS_WHEN_SAVING)
alert(status+' '+url+'\n'+
SHOW_EXTENDED_DEBUG_INFORMATION?data:'');if(status>=300)
throw'The server responded with an error: '+status+'\n'+(SHOW_EXTENDED_DEBUG_INFORMATION?+data:'If you need additional information here, including the data sent by the server, consider setting SHOW_EXTENDED_DEBUG_INFORMATION to true.');switch(action){case RESOURCE_REMOVED:var response=(transport.responseXML);var div=response.childNodes[0];var id=div.getAttribute('id');var localDiv=document.getElementById(id);localDiv.parentNode.removeChild(localDiv);break;case RESOURCE_CREATED:break;case RESOURCE_SAVED|RESOURCE_SYNCHRONIZED:DataManager.__synclocal();case RESOURCE_SAVED:break;case RESOURCE_RELOADED:var response=(transport.responseXML);var div=response.childNodes[0];var id=div.getAttribute('id');var localDiv=document.getElementById(id)
localDiv.parentNode.removeChild(localDiv);if(!$$(PROCESSDATA_REF)[0])
DataManager.graft(XMLNS.XHTML,document.getElementsByTagNameNS(XMLNS.XHTML,'body').item(0),['div',{'class':PROCESSDATA_REF,'style':'display:none;'}]);$$(PROCESSDATA_REF)[0].appendChild(div.cloneNode(true));DataManager.__synclocal();break;default:DataManager.__synclocal();}
ResourceManager.__dispatchEvent(new ResourceManager.__Event(action,id));},__resourceActionFailed:function(transport,action,id){throw"Fatal: Resource action failed. There is something horribly "+"wrong with either the server, the transport protocol or your "+"online status. Sure you're online?";}}
var Clazz=function(){};Clazz.prototype.construct=function(){};Clazz.extend=function(def){var classDef=function(){if(arguments[0]!==Clazz){this.construct.apply(this,arguments);}};var proto=new this(Clazz);var superClass=this.prototype;for(var n in def){var item=def[n];if(item instanceof Function)item.$=superClass;proto[n]=item;}
classDef.prototype=proto;classDef.extend=this.extend;return classDef;};if(!ORYX)var ORYX={};if(!ORYX.CONFIG)ORYX.CONFIG={};ORYX.CONFIG.ROOT_PATH=ORYX.contextPath+"/";ORYX.CONFIG.ROOT_ENGINE_PATH=ORYX.engineContextPath+"/";ORYX.CONFIG.WEB_URL="http://oryx-project.org";ORYX.CONFIG.VERSION_URL=ORYX.CONFIG.ROOT_PATH+"VERSION";ORYX.CONFIG.LICENSE_URL=ORYX.CONFIG.ROOT_PATH+"LICENSE";ORYX.CONFIG.INTERACTIVE_FLOW_STENCIL_NS="motive1.0#";ORYX.CONFIG.SERVER_HANDLER_ROOT="";ORYX.CONFIG.STENCILSET_HANDLER=ORYX.CONFIG.SERVER_HANDLER_ROOT+"";ORYX.CONFIG.MODE_READONLY="readonly";ORYX.CONFIG.MODE_FULLSCREEN="fullscreen";ORYX.CONFIG.SHOW_GRIDLINE=true;ORYX.CONFIG.DISABLE_GRADIENT=true;ORYX.CONFIG.PLUGINS_ENABLED=true;ORYX.CONFIG.PLUGINS_CONFIG=ORYX.CONFIG.ROOT_PATH+"plugins.xml";ORYX.CONFIG.PROFILE_PATH=ORYX.CONFIG.ROOT_PATH+"profiles/";ORYX.CONFIG.PLUGINS_FOLDER="Plugins/";ORYX.CONFIG.PDF_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"pdf";ORYX.CONFIG.PNML_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"pnml";ORYX.CONFIG.SIMPLE_PNML_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"simplepnmlexporter";ORYX.CONFIG.DESYNCHRONIZABILITY_URL=ORYX.CONFIG.ROOT_PATH+"desynchronizability";ORYX.CONFIG.IBPMN2BPMN_URL=ORYX.CONFIG.ROOT_PATH+"ibpmn2bpmn";ORYX.CONFIG.QUERYEVAL_URL=ORYX.CONFIG.ROOT_PATH+"query";ORYX.CONFIG.SYNTAXCHECKER_URL=ORYX.CONFIG.ROOT_PATH+"syntaxchecker";ORYX.CONFIG.VALIDATOR_URL=ORYX.CONFIG.ROOT_PATH+"validator";ORYX.CONFIG.AUTO_LAYOUTER_URL=ORYX.CONFIG.ROOT_PATH+"layouter";ORYX.CONFIG.SS_EXTENSIONS_FOLDER=ORYX.CONFIG.ROOT_PATH+"stencilsets/extensions/";ORYX.CONFIG.SS_EXTENSIONS_CONFIG=ORYX.CONFIG.ROOT_PATH+"stencilsets/extensions/extensions.json";ORYX.CONFIG.ORYX_NEW_URL="/new";ORYX.CONFIG.STEP_THROUGH=ORYX.CONFIG.ROOT_PATH+"stepthrough";ORYX.CONFIG.STEP_THROUGH_CHECKER=ORYX.CONFIG.ROOT_PATH+"stepthroughchecker";ORYX.CONFIG.XFORMS_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"xformsexport";ORYX.CONFIG.XFORMS_EXPORT_ORBEON_URL=ORYX.CONFIG.ROOT_PATH+"xformsexport-orbeon";ORYX.CONFIG.XFORMS_IMPORT_URL=ORYX.CONFIG.ROOT_PATH+"xformsimport";ORYX.CONFIG.BPEL_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"bpelexporter";ORYX.CONFIG.BPEL4CHOR_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"bpel4chorexporter";ORYX.CONFIG.BPEL4CHOR2BPEL_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"bpel4chor2bpelexporter";ORYX.CONFIG.TREEGRAPH_SUPPORT=ORYX.CONFIG.ROOT_PATH+"treegraphsupport";ORYX.CONFIG.XPDL4CHOR2BPEL4CHOR_TRANSFORMATION_URL=ORYX.CONFIG.ROOT_PATH+"xpdl4chor2bpel4chor";ORYX.CONFIG.RESOURCE_LIST=ORYX.CONFIG.ROOT_PATH+"resourceList";ORYX.CONFIG.BPMN_LAYOUTER=ORYX.CONFIG.ROOT_PATH+"bpmnlayouter";ORYX.CONFIG.EPC_LAYOUTER=ORYX.CONFIG.ROOT_PATH+"epclayouter";ORYX.CONFIG.BPMN2MIGRATION=ORYX.CONFIG.ROOT_PATH+"bpmn2migration";ORYX.CONFIG.BPMN20_SCHEMA_VALIDATION_ON=true;ORYX.CONFIG.NAMESPACE_ORYX="http://www.b3mn.org/oryx";ORYX.CONFIG.NAMESPACE_SVG="http://www.w3.org/2000/svg";ORYX.CONFIG.CANVAS_WIDTH=1485;ORYX.CONFIG.CANVAS_HEIGHT=1050;ORYX.CONFIG.CANVAS_RESIZE_INTERVAL=300;ORYX.CONFIG.SELECTED_AREA_PADDING=4;ORYX.CONFIG.CANVAS_BACKGROUND_COLOR="none";ORYX.CONFIG.GRID_DISTANCE=30;ORYX.CONFIG.GRID_ENABLED=true;ORYX.CONFIG.ZOOM_OFFSET=0.1;ORYX.CONFIG.DEFAULT_SHAPE_MARGIN=60;ORYX.CONFIG.SCALERS_SIZE=7;ORYX.CONFIG.MINIMUM_SIZE=20;ORYX.CONFIG.MAXIMUM_SIZE=10000;ORYX.CONFIG.OFFSET_MAGNET=15;ORYX.CONFIG.OFFSET_EDGE_LABEL_TOP=14;ORYX.CONFIG.OFFSET_EDGE_LABEL_BOTTOM=12;ORYX.CONFIG.OFFSET_EDGE_BOUNDS=5;ORYX.CONFIG.COPY_MOVE_OFFSET=30;ORYX.CONFIG.SHOW_GRIDLINE=true;ORYX.CONFIG.BORDER_OFFSET=14;ORYX.CONFIG.MAX_NUM_SHAPES_NO_GROUP=0;ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER=30;ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET=45;ORYX.CONFIG.SHAPEMENU_SLOT_WIDTH=200;ORYX.CONFIG.SHAPEMENU_SLOT_HEIGHT=22;ORYX.CONFIG.SHAPEMENU_SLOTS_PER_ROW=4;ORYX.CONFIG.SHAPEMENU_SLOTS_MAX=20;ORYX.CONFIG.SHAPEMENU_SLOT_TRUNCATE_LENGTH=18;ORYX.CONFIG.SHAPEMENU_RIGHT="Oryx_Right";ORYX.CONFIG.SHAPEMENU_BOTTOM="Oryx_Bottom";ORYX.CONFIG.SHAPEMENU_LEFT="Oryx_Left";ORYX.CONFIG.SHAPEMENU_TOP="Oryx_Top";ORYX.CONFIG.MORPHITEM_DISABLED="Oryx_MorphItem_disabled";ORYX.CONFIG.TYPE_STRING="string";ORYX.CONFIG.TYPE_BOOLEAN="boolean";ORYX.CONFIG.TYPE_INTEGER="integer";ORYX.CONFIG.TYPE_FLOAT="float";ORYX.CONFIG.TYPE_COLOR="color";ORYX.CONFIG.TYPE_DATE="date";ORYX.CONFIG.TYPE_CHOICE="choice";ORYX.CONFIG.TYPE_URL="url";ORYX.CONFIG.TYPE_DIAGRAM_LINK="diagramlink";ORYX.CONFIG.TYPE_COMPLEX="complex";ORYX.CONFIG.TYPE_MULTIPLECOMPLEX="multiplecomplex";ORYX.CONFIG.TYPE_SORTLIST="sortlist";ORYX.CONFIG.TYPE_TEXT="text";ORYX.CONFIG.TYPE_HTML="html";ORYX.CONFIG.TYPE_HTML_MIN="html-min";ORYX.CONFIG.TYPE_HTML_FULL="html-full";ORYX.CONFIG.TYPE_SIGNAL_CONFIG="signalcfg";ORYX.CONFIG.TYPE_EXPRESSION="expression";ORYX.CONFIG.TYPE_MODEL_INPUT="modelinput";ORYX.CONFIG.TYPE_CONDITIONAL="conditional";ORYX.CONFIG.TYPE_LIST="list";ORYX.CONFIG.TYPE_MAP="map";ORYX.CONFIG.LIST_DELIMITER=", ";ORYX.CONFIG.LABEL_LINE_DISTANCE=2;ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT=12;ORYX.CONFIG.LABEL_MAX_DISPLAYABLE_TSPANS=2;ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER=true;ORYX.CONFIG.EDITOR_ALIGN_BOTTOM=0x01;ORYX.CONFIG.EDITOR_ALIGN_MIDDLE=0x02;ORYX.CONFIG.EDITOR_ALIGN_TOP=0x04;ORYX.CONFIG.EDITOR_ALIGN_LEFT=0x08;ORYX.CONFIG.EDITOR_ALIGN_CENTER=0x10;ORYX.CONFIG.EDITOR_ALIGN_RIGHT=0x20;ORYX.CONFIG.EDITOR_ALIGN_SIZE=0x30;ORYX.CONFIG.EVENT_MOUSEDOWN="mousedown";ORYX.CONFIG.EVENT_MOUSEUP="mouseup";ORYX.CONFIG.EVENT_MOUSEOVER="mouseover";ORYX.CONFIG.EVENT_MOUSEOUT="mouseout";ORYX.CONFIG.EVENT_MOUSEMOVE="mousemove";ORYX.CONFIG.EVENT_DBLCLICK="dblclick";ORYX.CONFIG.EVENT_KEYDOWN="keydown";ORYX.CONFIG.EVENT_KEYUP="keyup";ORYX.CONFIG.EVENT_LOADED="editorloaded";ORYX.CONFIG.EVENT_EXECUTE_COMMANDS="executeCommands";ORYX.CONFIG.EVENT_STENCIL_SET_LOADED="stencilSetLoaded";ORYX.CONFIG.EVENT_SELECTION_CHANGED="selectionchanged";ORYX.CONFIG.EVENT_SHAPEADDED="shapeadded";ORYX.CONFIG.EVENT_PROPERTY_CHANGED="propertyChanged";ORYX.CONFIG.EVENT_DRAGDROP_START="dragdrop.start";ORYX.CONFIG.EVENT_SHAPE_MENU_CLOSE="shape.menu.close";ORYX.CONFIG.EVENT_DRAGDROP_END="dragdrop.end";ORYX.CONFIG.EVENT_RESIZE_START="resize.start";ORYX.CONFIG.EVENT_RESIZE_END="resize.end";ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED="dragDocker.docked";ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW="highlight.showHighlight";ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE="highlight.hideHighlight";ORYX.CONFIG.EVENT_LOADING_ENABLE="loading.enable";ORYX.CONFIG.EVENT_LOADING_DISABLE="loading.disable";ORYX.CONFIG.EVENT_LOADING_STATUS="loading.status";ORYX.CONFIG.EVENT_OVERLAY_SHOW="overlay.show";ORYX.CONFIG.EVENT_OVERLAY_HIDE="overlay.hide";ORYX.CONFIG.EVENT_ARRANGEMENT_TOP="arrangement.setToTop";ORYX.CONFIG.EVENT_ARRANGEMENT_BACK="arrangement.setToBack";ORYX.CONFIG.EVENT_ARRANGEMENT_FORWARD="arrangement.setForward";ORYX.CONFIG.EVENT_ARRANGEMENT_BACKWARD="arrangement.setBackward";ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED="propertyWindow.propertyChanged";ORYX.CONFIG.EVENT_LAYOUT_ROWS="layout.rows";ORYX.CONFIG.EVENT_LAYOUT_BPEL="layout.BPEL";ORYX.CONFIG.EVENT_LAYOUT_BPEL_VERTICAL="layout.BPEL.vertical";ORYX.CONFIG.EVENT_LAYOUT_BPEL_HORIZONTAL="layout.BPEL.horizontal";ORYX.CONFIG.EVENT_LAYOUT_BPEL_SINGLECHILD="layout.BPEL.singlechild";ORYX.CONFIG.EVENT_LAYOUT_BPEL_AUTORESIZE="layout.BPEL.autoresize";ORYX.CONFIG.EVENT_AUTOLAYOUT_LAYOUT="autolayout.layout";ORYX.CONFIG.EVENT_UNDO_EXECUTE="undo.execute";ORYX.CONFIG.EVENT_UNDO_ROLLBACK="undo.rollback";ORYX.CONFIG.EVENT_BUTTON_UPDATE="toolbar.button.update";ORYX.CONFIG.EVENT_LAYOUT="layout.dolayout";ORYX.CONFIG.EVENT_COLOR_CHANGE="color.change";ORYX.CONFIG.EVENT_SHOW_PROPERTYWINDOW="propertywindow.show";ORYX.CONFIG.EVENT_FLOW_VIEW_UPDATE="flowview.update";ORYX.CONFIG.EVENT_FLOW_VIEW_CHANGE="flowview.change";ORYX.CONFIG.EVENT_CHANNEL_CHANGED="channelchanged";ORYX.CONFIG.EVENT_FLOWEDITOR_FLOW_CHANGE="floweditor.flowchange";ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE=5;ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR="#4444FF";ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR2="#9999FF";ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_CORNER="corner";ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE="rectangle";ORYX.CONFIG.SELECTION_VALID_COLOR="#00FF00";ORYX.CONFIG.SELECTION_INVALID_COLOR="#FF0000";ORYX.CONFIG.DOCKER_DOCKED_COLOR="#00FF00";ORYX.CONFIG.DOCKER_UNDOCKED_COLOR="#FF0000";ORYX.CONFIG.DOCKER_SNAP_OFFSET=10;ORYX.CONFIG.EDIT_OFFSET_PASTE=10;ORYX.CONFIG.KEY_CODE_2=50;ORYX.CONFIG.KEY_CODE_X=88;ORYX.CONFIG.KEY_CODE_C=67;ORYX.CONFIG.KEY_CODE_V=86;ORYX.CONFIG.KEY_CODE_DELETE=46;ORYX.CONFIG.KEY_CODE_META=224;ORYX.CONFIG.KEY_CODE_BACKSPACE=8;ORYX.CONFIG.KEY_CODE_LEFT=37;ORYX.CONFIG.KEY_CODE_RIGHT=39;ORYX.CONFIG.KEY_CODE_UP=38;ORYX.CONFIG.KEY_CODE_DOWN=40;ORYX.CONFIG.KEY_Code_enter=12;ORYX.CONFIG.KEY_Code_left=37;ORYX.CONFIG.KEY_Code_right=39;ORYX.CONFIG.KEY_Code_top=38;ORYX.CONFIG.KEY_Code_bottom=40;ORYX.CONFIG.META_KEY_META_CTRL="metactrl";ORYX.CONFIG.META_KEY_ALT="alt";ORYX.CONFIG.META_KEY_SHIFT="shift";ORYX.CONFIG.KEY_ACTION_DOWN="down";ORYX.CONFIG.KEY_ACTION_UP="up";ORYX.CONFIG.CLIENT_RESOURCES_PATH=ORYX.CONFIG.ROOT_PATH+"resources";ORYX.CONFIG.TINYMCE_PATH=ORYX.CONFIG.ROOT_PATH+"lib/tiny_mce";ORYX.CONFIG.PANEL_LEFT_WIDTH=300;ORYX.CONFIG.PANEL_RIGHT_WIDTH=200;ORYX.CONFIG.LIVE_PREVIEW_URL=ORYX.CONFIG.ROOT_ENGINE_PATH+"Launcher.do?wfprocess={0}&test={1}&livepreview={2}&lpchannel={3}&defchannel={4}";ORYX.CONFIG.LIVE_PREVIEW_HEIGHT=600;ORYX.CONFIG.LIVE_PREVIEW_WIDTH=800;ORYX.CONFIG.LIVE_PREVIEW_DEFAULT_CHANNEL="desktop";ORYX.CONFIG.INACTIVITY_TIMEOUT_MINUTES=30;ORYX.CONFIG.POLL_INTERVAL_MINUTES=2;ORYX.CONFIG.KEEPALIVE_INTERVAL_MINUTES=10;ORYX.CONFIG.TEST_PANEL_WF_PREFIX="WFTEST-{0}-{1}";ORYX.CONFIG.TEST_PANEL_URL=ORYX.CONFIG.ROOT_ENGINE_PATH+"Launcher.do?wfprocess={0}&test={1}";ORYX.CONFIG.TEST_PANEL_HEIGHT=600;ORYX.CONFIG.TEST_PANEL_WIDTH=800;ORYX.CONFIG.EXT_AJAX_TIMEOUT=30000;ORYX.CONFIG.PUBLISH_TIMEOUT=600000;ORYX.CONFIG.AUTO_SAVE_INTERVAL=60000;ORYX.CONFIG.AUTO_SAVE_VERSION=-2;ORYX.RepositoryHelper={getModelMeta:function(callback){var meta={};var loc;var modelId=0;try{loc=location.href.split("/");modelId=loc[loc.length-1];if(location.href.indexOf("/model/")>0&&modelId!==""){var url=ORYX.PATH+"poem/model/"+modelId+"/meta";new Ajax.Request(url,{method:"get",parameters:{version:ORYX.contentVersion},onSuccess:function(transport){meta=transport.responseText.evalJSON();if(callback!==undefined){callback.call(meta);}}});}}catch(e){ORYX.Log.warn("Could not get model '%0' meta from url: %1",modelId,url);}},getKMPVersionMeta:function(callback){var meta={};var loc;var modelId=0;try{loc=location.href.split("/");modelId=loc[loc.length-1];if(location.href.indexOf("/model/")>0&&modelId!==""){var url=ORYX.PATH+"poem/model/"+modelId+"/kmpVersionMeta";new Ajax.Request(url,{method:"get",asynchronous:false,onSuccess:function(transport){meta=transport.responseText.evalJSON();if(callback!==undefined){callback.call(meta);}}});}}catch(e){ORYX.Log.warn("Could not get model '%0' kmp version meta from url: %1",modelId,url);}}}
function printf(){var result=arguments[0];for(var i=1;i<arguments.length;i++)
result=result.replace('%'+(i-1),arguments[i]);return result;}
var ORYX_LOGLEVEL_TRACE=5;var ORYX_LOGLEVEL_DEBUG=4;var ORYX_LOGLEVEL_INFO=3;var ORYX_LOGLEVEL_WARN=2;var ORYX_LOGLEVEL_ERROR=1;var ORYX_LOGLEVEL_FATAL=0;var ORYX_LOGLEVEL=0;var ORYX_CONFIGURATION_DELAY=100;var ORYX_CONFIGURATION_WAIT_ATTEMPTS=10;if(!ORYX)var ORYX={};ORYX=Object.extend(ORYX,{PATH:ORYX.CONFIG.ROOT_PATH,URLS:[],alreadyLoaded:[],configrationRetries:0,Version:'0.1.1',availablePlugins:[],Log:{__appenders:[{append:function(message){if(this.consoleAvailable==null)
this.consoleAvailable=window.console&&console.log;if(this.consoleAvailable)
console.log(message);}}],trace:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_TRACE)
ORYX.Log.__log('TRACE',arguments);},debug:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_DEBUG)
ORYX.Log.__log('DEBUG',arguments);},info:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_INFO)
ORYX.Log.__log('INFO',arguments);},warn:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_WARN)
ORYX.Log.__log('WARN',arguments);},error:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_ERROR)
ORYX.Log.__log('ERROR',arguments);},fatal:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_FATAL)
ORYX.Log.__log('FATAL',arguments);},__log:function(prefix,messageParts){messageParts[0]=(new Date()).getTime()+" "
+prefix+" "+messageParts[0];var message=printf.apply(null,messageParts);ORYX.Log.__appenders.each(function(appender){appender.append(message);});},addAppender:function(appender){ORYX.Log.__appenders.push(appender);}},load:function(){var d=new Date();var waitingpanel=new Ext.Window({renderTo:Ext.getBody(),id:'oryx-loading-panel',header:false,width:'auto',height:'auto',modal:true,resizable:false,closable:false,html:'<span class="copyright"><div>© Copyright 2011 - '+d.getFullYear()+' Nokia</div></span>'});waitingpanel.show();ORYX.Log.debug("Oryx begins loading procedure.");if((typeof Prototype=='undefined')||(typeof Element=='undefined')||(typeof Element.Methods=='undefined')||parseFloat(Prototype.Version.split(".")[0]+"."+
Prototype.Version.split(".")[1])<1.5)
throw("Application requires the Prototype JavaScript framework >= 1.5.3");ORYX.Log.debug("Prototype > 1.5 found.");ORYX._load();},_load:function(){ORYX.loadPlugins();},loadPlugins:function(){if(ORYX.CONFIG.PLUGINS_ENABLED)
ORYX._loadPlugins()
else
ORYX.Log.warn("Ignoring plugins, loading Core only.");init();},_loadPlugins:function(){var source=ORYX.CONFIG.PLUGINS_CONFIG;ORYX.Log.debug("Loading plugin configuration from '%0'.",source);new Ajax.Request(source,{asynchronous:false,method:'get',onSuccess:function(result){ORYX.Log.info("Plugin configuration file loaded.");var resultXml=result.responseXML;var globalProperties=[];var preferences=$A(resultXml.getElementsByTagName("properties"));preferences.each(function(p){var props=$A(p.childNodes);props.each(function(prop){var property=new Hash();var attributes=$A(prop.attributes)
attributes.each(function(attr){property[attr.nodeName]=attr.nodeValue});if(attributes.length>0){globalProperties.push(property)};});});var plugin=resultXml.getElementsByTagName("plugin");$A(plugin).each(function(node){var pluginData=new Hash();$A(node.attributes).each(function(attr){pluginData[attr.nodeName]=attr.nodeValue});if(!pluginData['name']){ORYX.Log.error("A plugin is not providing a name. Ingnoring this plugin.");return;}
if(!pluginData['source']){ORYX.Log.error("Plugin with name '%0' doesn't provide a source attribute.",pluginData['name']);return;}
var propertyNodes=node.getElementsByTagName("property");var properties=[];$A(propertyNodes).each(function(prop){var property=new Hash();var attributes=$A(prop.attributes)
attributes.each(function(attr){property[attr.nodeName]=attr.nodeValue});if(attributes.length>0){properties.push(property)};});properties=properties.concat(globalProperties);pluginData['properties']=properties;var requireNodes=node.getElementsByTagName("requires");var requires;$A(requireNodes).each(function(req){var namespace=$A(req.attributes).find(function(attr){return attr.name=="namespace"})
if(namespace&&namespace.nodeValue){if(!requires){requires={namespaces:[]}}
requires.namespaces.push(namespace.nodeValue)}});if(requires){pluginData['requires']=requires;}
var notUsesInNodes=node.getElementsByTagName("notUsesIn");var notUsesIn;$A(notUsesInNodes).each(function(not){var namespace=$A(not.attributes).find(function(attr){return attr.name=="namespace"})
if(namespace&&namespace.nodeValue){if(!notUsesIn){notUsesIn={namespaces:[]}}
notUsesIn.namespaces.push(namespace.nodeValue)}});if(notUsesIn){pluginData['notUsesIn']=notUsesIn;}
var url=ORYX.PATH+ORYX.CONFIG.PLUGINS_FOLDER+pluginData['source'];ORYX.Log.debug("Requireing '%0'",url);ORYX.Log.info("Plugin '%0' successfully loaded.",pluginData['name']);ORYX.availablePlugins.push(pluginData);});},onFailure:this._loadPluginsOnFails});},_loadPluginsOnFails:function(result){ORYX.Log.error("Plugin configuration file not available.");}});ORYX.Log.debug('Registering Oryx with Kickstart');Kickstart.register(ORYX.load);if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.SVG){ORYX.Core.SVG={};}
ORYX.Core.SVG.EditPathHandler=Clazz.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.x=0;this.y=0;this.oldX=0;this.oldY=0;this.deltaWidth=1;this.deltaHeight=1;this.d="";},init:function(x,y,oldX,oldY,deltaWidth,deltaHeight){this.x=x;this.y=y;this.oldX=oldX;this.oldY=oldY;this.deltaWidth=deltaWidth;this.deltaHeight=deltaHeight;this.d="";},editPointsAbs:function(points){if(points instanceof Array){var newPoints=[];var x,y;for(var i=0;i<points.length;i++){x=(parseFloat(points[i])-this.oldX)*this.deltaWidth+this.x;i++;y=(parseFloat(points[i])-this.oldY)*this.deltaHeight+this.y;newPoints.push(x);newPoints.push(y);}
return newPoints;}else{}},editPointsRel:function(points){if(points instanceof Array){var newPoints=[];var x,y;for(var i=0;i<points.length;i++){x=parseFloat(points[i])*this.deltaWidth;i++;y=parseFloat(points[i])*this.deltaHeight;newPoints.push(x);newPoints.push(y);}
return newPoints;}else{}},arcAbs:function(rx,ry,xAxisRotation,largeArcFlag,sweepFlag,x,y){var pointsAbs=this.editPointsAbs([x,y]);var pointsRel=this.editPointsRel([rx,ry]);this.d=this.d.concat(" A"+pointsRel[0]+" "+pointsRel[1]+" "+xAxisRotation+" "+largeArcFlag+" "+sweepFlag+" "+pointsAbs[0]+" "+
pointsAbs[1]+" ");},arcRel:function(rx,ry,xAxisRotation,largeArcFlag,sweepFlag,x,y){var pointsRel=this.editPointsRel([rx,ry,x,y]);this.d=this.d.concat(" a"+pointsRel[0]+" "+pointsRel[1]+" "+xAxisRotation+" "+largeArcFlag+" "+sweepFlag+" "+pointsRel[2]+" "+
pointsRel[3]+" ");},curvetoCubicAbs:function(x1,y1,x2,y2,x,y){var pointsAbs=this.editPointsAbs([x1,y1,x2,y2,x,y]);this.d=this.d.concat(" C"+pointsAbs[0]+" "+pointsAbs[1]+" "+pointsAbs[2]+" "+pointsAbs[3]+" "+pointsAbs[4]+" "+pointsAbs[5]+" ");},curvetoCubicRel:function(x1,y1,x2,y2,x,y){var pointsRel=this.editPointsRel([x1,y1,x2,y2,x,y]);this.d=this.d.concat(" c"+pointsRel[0]+" "+pointsRel[1]+" "+pointsRel[2]+" "+pointsRel[3]+" "+pointsRel[4]+" "+pointsRel[5]+" ");},linetoHorizontalAbs:function(x){var pointsAbs=this.editPointsAbs([x,0]);this.d=this.d.concat(" H"+pointsAbs[0]+" ");},linetoHorizontalRel:function(x){var pointsRel=this.editPointsRel([x,0]);this.d=this.d.concat(" h"+pointsRel[0]+" ");},linetoAbs:function(x,y){var pointsAbs=this.editPointsAbs([x,y]);this.d=this.d.concat(" L"+pointsAbs[0]+" "+pointsAbs[1]+" ");},linetoRel:function(x,y){var pointsRel=this.editPointsRel([x,y]);this.d=this.d.concat(" l"+pointsRel[0]+" "+pointsRel[1]+" ");},movetoAbs:function(x,y){var pointsAbs=this.editPointsAbs([x,y]);this.d=this.d.concat(" M"+pointsAbs[0]+" "+pointsAbs[1]+" ");},movetoRel:function(x,y){var pointsRel;if(this.d===""){pointsRel=this.editPointsAbs([x,y]);}else{pointsRel=this.editPointsRel([x,y]);}
this.d=this.d.concat(" m"+pointsRel[0]+" "+pointsRel[1]+" ");},curvetoQuadraticAbs:function(x1,y1,x,y){var pointsAbs=this.editPointsAbs([x1,y1,x,y]);this.d=this.d.concat(" Q"+pointsAbs[0]+" "+pointsAbs[1]+" "+
pointsAbs[2]+" "+pointsAbs[3]+" ");},curvetoQuadraticRel:function(x1,y1,x,y){var pointsRel=this.editPointsRel([x1,y1,x,y]);this.d=this.d.concat(" q"+pointsRel[0]+" "+pointsRel[1]+" "+
pointsRel[2]+" "+pointsRel[3]+" ");},curvetoCubicSmoothAbs:function(x2,y2,x,y){var pointsAbs=this.editPointsAbs([x2,y2,x,y]);this.d=this.d.concat(" S"+pointsAbs[0]+" "+pointsAbs[1]+" "+
pointsAbs[2]+" "+pointsAbs[3]+" ");},curvetoCubicSmoothRel:function(x2,y2,x,y){var pointsRel=this.editPointsRel([x2,y2,x,y]);this.d=this.d.concat(" s"+pointsRel[0]+" "+pointsRel[1]+" "+
pointsRel[2]+" "+pointsRel[3]+" ");},curvetoQuadraticSmoothAbs:function(x,y){var pointsAbs=this.editPointsAbs([x,y]);this.d=this.d.concat(" T"+pointsAbs[0]+" "+pointsAbs[1]+" ");},curvetoQuadraticSmoothRel:function(x,y){var pointsRel=this.editPointsRel([x,y]);this.d=this.d.concat(" t"+pointsRel[0]+" "+pointsRel[1]+" ");},linetoVerticalAbs:function(y){var pointsAbs=this.editPointsAbs([0,y]);this.d=this.d.concat(" V"+pointsAbs[1]+" ");},linetoVerticalRel:function(y){var pointsRel=this.editPointsRel([0,y]);this.d=this.d.concat(" v"+pointsRel[1]+" ");},closePath:function(){this.d=this.d.concat(" z");}});if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.SVG){ORYX.Core.SVG={};}
ORYX.Core.SVG.MinMaxPathHandler=Clazz.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.minX=undefined;this.minY=undefined;this.maxX=undefined;this.maxY=undefined;this._lastAbsX=undefined;this._lastAbsY=undefined;},calculateMinMax:function(points){if(points instanceof Array){var x,y;for(var i=0;i<points.length;i++){x=parseFloat(points[i]);i++;y=parseFloat(points[i]);this.minX=(this.minX!==undefined)?Math.min(this.minX,x):x;this.maxX=(this.maxX!==undefined)?Math.max(this.maxX,x):x;this.minY=(this.minY!==undefined)?Math.min(this.minY,y):y;this.maxY=(this.maxY!==undefined)?Math.max(this.maxY,y):y;this._lastAbsX=x;this._lastAbsY=y;}}else{}},arcAbs:function(rx,ry,xAxisRotation,largeArcFlag,sweepFlag,x,y){this.calculateMinMax([x,y]);},arcRel:function(rx,ry,xAxisRotation,largeArcFlag,sweepFlag,x,y){this.calculateMinMax([this._lastAbsX+x,this._lastAbsY+y]);},curvetoCubicAbs:function(x1,y1,x2,y2,x,y){this.calculateMinMax([x1,y1,x2,y2,x,y]);},curvetoCubicRel:function(x1,y1,x2,y2,x,y){this.calculateMinMax([this._lastAbsX+x1,this._lastAbsY+y1,this._lastAbsX+x2,this._lastAbsY+y2,this._lastAbsX+x,this._lastAbsY+y]);},linetoHorizontalAbs:function(x){this.calculateMinMax([x,this._lastAbsY]);},linetoHorizontalRel:function(x){this.calculateMinMax([this._lastAbsX+x,this._lastAbsY]);},linetoAbs:function(x,y){this.calculateMinMax([x,y]);},linetoRel:function(x,y){this.calculateMinMax([this._lastAbsX+x,this._lastAbsY+y]);},movetoAbs:function(x,y){this.calculateMinMax([x,y]);},movetoRel:function(x,y){if(this._lastAbsX&&this._lastAbsY){this.calculateMinMax([this._lastAbsX+x,this._lastAbsY+y]);}else{this.calculateMinMax([x,y]);}},curvetoQuadraticAbs:function(x1,y1,x,y){this.calculateMinMax([x1,y1,x,y]);},curvetoQuadraticRel:function(x1,y1,x,y){this.calculateMinMax([this._lastAbsX+x1,this._lastAbsY+y1,this._lastAbsX+x,this._lastAbsY+y]);},curvetoCubicSmoothAbs:function(x2,y2,x,y){this.calculateMinMax([x2,y2,x,y]);},curvetoCubicSmoothRel:function(x2,y2,x,y){this.calculateMinMax([this._lastAbsX+x2,this._lastAbsY+y2,this._lastAbsX+x,this._lastAbsY+y]);},curvetoQuadraticSmoothAbs:function(x,y){this.calculateMinMax([x,y]);},curvetoQuadraticSmoothRel:function(x,y){this.calculateMinMax([this._lastAbsX+x,this._lastAbsY+y]);},linetoVerticalAbs:function(y){this.calculateMinMax([this._lastAbsX,y]);},linetoVerticalRel:function(y){this.calculateMinMax([this._lastAbsX,this._lastAbsY+y]);},closePath:function(){return;}});if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.SVG){ORYX.Core.SVG={};}
ORYX.Core.SVG.PointsPathHandler=Clazz.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.points=[];this._lastAbsX=undefined;this._lastAbsY=undefined;},addPoints:function(points){if(points instanceof Array){var x,y;for(var i=0;i<points.length;i++){x=parseFloat(points[i]);i++;y=parseFloat(points[i]);this.points.push(x);this.points.push(y);this._lastAbsX=x;this._lastAbsY=y;}}else{}},arcAbs:function(rx,ry,xAxisRotation,largeArcFlag,sweepFlag,x,y){this.addPoints([x,y]);},arcRel:function(rx,ry,xAxisRotation,largeArcFlag,sweepFlag,x,y){this.addPoints([this._lastAbsX+x,this._lastAbsY+y]);},curvetoCubicAbs:function(x1,y1,x2,y2,x,y){this.addPoints([x,y]);},curvetoCubicRel:function(x1,y1,x2,y2,x,y){this.addPoints([this._lastAbsX+x,this._lastAbsY+y]);},linetoHorizontalAbs:function(x){this.addPoints([x,this._lastAbsY]);},linetoHorizontalRel:function(x){this.addPoints([this._lastAbsX+x,this._lastAbsY]);},linetoAbs:function(x,y){this.addPoints([x,y]);},linetoRel:function(x,y){this.addPoints([this._lastAbsX+x,this._lastAbsY+y]);},movetoAbs:function(x,y){this.addPoints([x,y]);},movetoRel:function(x,y){if(this._lastAbsX&&this._lastAbsY){this.addPoints([this._lastAbsX+x,this._lastAbsY+y]);}else{this.addPoints([x,y]);}},curvetoQuadraticAbs:function(x1,y1,x,y){this.addPoints([x,y]);},curvetoQuadraticRel:function(x1,y1,x,y){this.addPoints([this._lastAbsX+x,this._lastAbsY+y]);},curvetoCubicSmoothAbs:function(x2,y2,x,y){this.addPoints([x,y]);},curvetoCubicSmoothRel:function(x2,y2,x,y){this.addPoints([this._lastAbsX+x,this._lastAbsY+y]);},curvetoQuadraticSmoothAbs:function(x,y){this.addPoints([x,y]);},curvetoQuadraticSmoothRel:function(x,y){this.addPoints([this._lastAbsX+x,this._lastAbsY+y]);},linetoVerticalAbs:function(y){this.addPoints([this._lastAbsX,y]);},linetoVerticalRel:function(y){this.addPoints([this._lastAbsX,this._lastAbsY+y]);},closePath:function(){return;}});NAMESPACE_ORYX="http://www.b3mn.org/oryx";NAMESPACE_SVG="http://www.w3.org/2000/svg/";if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.SVG){ORYX.Core.SVG={};}
ORYX.Core.SVG.SVGMarker=Clazz.extend({construct:function(markerElement){arguments.callee.$.construct.apply(this,arguments);this.id=undefined;this.element=markerElement;this.refX=undefined;this.refY=undefined;this.markerWidth=undefined;this.markerHeight=undefined;this.oldRefX=undefined;this.oldRefY=undefined;this.oldMarkerWidth=undefined;this.oldMarkerHeight=undefined;this.optional=false;this.enabled=true;this.minimumLength=undefined;this.resize=false;this.svgShapes=[];this._init();},_init:function(){if(!(this.element=="[object SVGMarkerElement]")){throw"SVGMarker: Argument is not an instance of SVGMarkerElement.";}
this.id=this.element.getAttributeNS(null,"id");var refXValue=this.element.getAttributeNS(null,"refX");if(refXValue){this.refX=parseFloat(refXValue);}else{this.refX=0;}
var refYValue=this.element.getAttributeNS(null,"refY");if(refYValue){this.refY=parseFloat(refYValue);}else{this.refY=0;}
var markerWidthValue=this.element.getAttributeNS(null,"markerWidth");if(markerWidthValue){this.markerWidth=parseFloat(markerWidthValue);}else{this.markerWidth=3;}
var markerHeightValue=this.element.getAttributeNS(null,"markerHeight");if(markerHeightValue){this.markerHeight=parseFloat(markerHeightValue);}else{this.markerHeight=3;}
this.oldRefX=this.refX;this.oldRefY=this.refY;this.oldMarkerWidth=this.markerWidth;this.oldMarkerHeight=this.markerHeight;var optionalAttr=this.element.getAttributeNS(NAMESPACE_ORYX,"optional");if(optionalAttr){optionalAttr=optionalAttr.strip();this.optional=(optionalAttr.toLowerCase()==="yes");}else{this.optional=false;}
var enabledAttr=this.element.getAttributeNS(NAMESPACE_ORYX,"enabled");if(enabledAttr){enabledAttr=enabledAttr.strip();this.enabled=!(enabledAttr.toLowerCase()==="no");}else{this.enabled=true;}
var minLengthAttr=this.element.getAttributeNS(NAMESPACE_ORYX,"minimumLength");if(minLengthAttr){this.minimumLength=parseFloat(minLengthAttr);}
var resizeAttr=this.element.getAttributeNS(NAMESPACE_ORYX,"resize");if(resizeAttr){resizeAttr=resizeAttr.strip();this.resize=(resizeAttr.toLowerCase()==="yes");}else{this.resize=false;}},_getSVGShapes:function(svgElement){if(svgElement.hasChildNodes){var svgShapes=[];var me=this;$A(svgElement.childNodes).each(function(svgChild){try{var svgShape=new ORYX.Core.SVG.SVGShape(svgChild);svgShapes.push(svgShape);}catch(e){svgShapes=svgShapes.concat(me._getSVGShapes(svgChild));}});return svgShapes;}},update:function(){this.oldRefX=this.refX;this.oldRefY=this.refY;this.oldMarkerWidth=this.markerWidth;this.oldMarkerHeight=this.markerHeight;},toString:function(){return(this.element)?"SVGMarker "+this.element.id:"SVGMarker "+this.element;}});NAMESPACE_ORYX="http://www.b3mn.org/oryx";NAMESPACE_SVG="http://www.w3.org/2000/svg/";if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.SVG){ORYX.Core.SVG={};}
ORYX.Core.SVG.SVGShape=Clazz.extend({construct:function(svgElem){arguments.callee.$.construct.apply(this,arguments);this.type;this.element=svgElem;this.x=undefined;this.y=undefined;this.width=undefined;this.height=undefined;this.oldX=undefined;this.oldY=undefined;this.oldWidth=undefined;this.oldHeight=undefined;this.radiusX=undefined;this.radiusY=undefined;this.isHorizontallyResizable=false;this.isVerticallyResizable=false;this.anchorLeft=false;this.anchorRight=false;this.anchorTop=false;this.anchorBottom=false;this.allowDockers=true;this.resizeMarkerMid=false;this.editPathParser;this.editPathHandler;this.init();},init:function(){if(ORYX.Editor.checkClassType(this.element,SVGRectElement)||ORYX.Editor.checkClassType(this.element,SVGImageElement)){this.type="Rect";var xAttr=this.element.getAttributeNS(null,"x");if(xAttr){this.oldX=parseFloat(xAttr);}else{throw"Missing attribute in element "+this.element;}
var yAttr=this.element.getAttributeNS(null,"y");if(yAttr){this.oldY=parseFloat(yAttr);}else{throw"Missing attribute in element "+this.element;}
var widthAttr=this.element.getAttributeNS(null,"width");if(widthAttr){this.oldWidth=parseFloat(widthAttr);}else{throw"Missing attribute in element "+this.element;}
var heightAttr=this.element.getAttributeNS(null,"height");if(heightAttr){this.oldHeight=parseFloat(heightAttr);}else{throw"Missing attribute in element "+this.element;}}else if(ORYX.Editor.checkClassType(this.element,SVGCircleElement)){this.type="Circle";var cx=undefined;var cy=undefined;var cxAttr=this.element.getAttributeNS(null,"cx");if(cxAttr){cx=parseFloat(cxAttr);}else{throw"Missing attribute in element "+this.element;}
var cyAttr=this.element.getAttributeNS(null,"cy");if(cyAttr){cy=parseFloat(cyAttr);}else{throw"Missing attribute in element "+this.element;}
var rAttr=this.element.getAttributeNS(null,"r");if(rAttr){this.radiusX=parseFloat(rAttr);}else{throw"Missing attribute in element "+this.element;}
this.oldX=cx-this.radiusX;this.oldY=cy-this.radiusX;this.oldWidth=2*this.radiusX;this.oldHeight=2*this.radiusX;}else if(ORYX.Editor.checkClassType(this.element,SVGEllipseElement)){this.type="Ellipse";var cx=undefined;var cy=undefined;var cxAttr=this.element.getAttributeNS(null,"cx");if(cxAttr){cx=parseFloat(cxAttr);}else{throw"Missing attribute in element "+this.element;}
var cyAttr=this.element.getAttributeNS(null,"cy");if(cyAttr){cy=parseFloat(cyAttr);}else{throw"Missing attribute in element "+this.element;}
var rxAttr=this.element.getAttributeNS(null,"rx");if(rxAttr){this.radiusX=parseFloat(rxAttr);}else{throw"Missing attribute in element "+this.element;}
var ryAttr=this.element.getAttributeNS(null,"ry");if(ryAttr){this.radiusY=parseFloat(ryAttr);}else{throw"Missing attribute in element "+this.element;}
this.oldX=cx-this.radiusX;this.oldY=cy-this.radiusY;this.oldWidth=2*this.radiusX;this.oldHeight=2*this.radiusY;}else if(ORYX.Editor.checkClassType(this.element,SVGLineElement)){this.type="Line";var x1=undefined;var y1=undefined;var x2=undefined;var y2=undefined;var x1Attr=this.element.getAttributeNS(null,"x1");if(x1Attr){x1=parseFloat(x1Attr);}else{throw"Missing attribute in element "+this.element;}
var y1Attr=this.element.getAttributeNS(null,"y1");if(y1Attr){y1=parseFloat(y1Attr);}else{throw"Missing attribute in element "+this.element;}
var x2Attr=this.element.getAttributeNS(null,"x2");if(x2Attr){x2=parseFloat(x2Attr);}else{throw"Missing attribute in element "+this.element;}
var y2Attr=this.element.getAttributeNS(null,"y2");if(y2Attr){y2=parseFloat(y2Attr);}else{throw"Missing attribute in element "+this.element;}
this.oldX=Math.min(x1,x2);this.oldY=Math.min(y1,y2);this.oldWidth=Math.abs(x1-x2);this.oldHeight=Math.abs(y1-y2);}else if(ORYX.Editor.checkClassType(this.element,SVGPolylineElement)||ORYX.Editor.checkClassType(this.element,SVGPolygonElement)){this.type="Polyline";var points=this.element.getAttributeNS(null,"points");if(points){points=points.replace(/,/g," ");var pointsArray=points.split(" ");pointsArray=pointsArray.without("");if(pointsArray&&pointsArray.length&&pointsArray.length>1){var minX=parseFloat(pointsArray[0]);var minY=parseFloat(pointsArray[1]);var maxX=parseFloat(pointsArray[0]);var maxY=parseFloat(pointsArray[1]);for(var i=0;i<pointsArray.length;i++){minX=Math.min(minX,parseFloat(pointsArray[i]));maxX=Math.max(maxX,parseFloat(pointsArray[i]));i++;minY=Math.min(minY,parseFloat(pointsArray[i]));maxY=Math.max(maxY,parseFloat(pointsArray[i]));}
this.oldX=minX;this.oldY=minY;this.oldWidth=maxX-minX;this.oldHeight=maxY-minY;}else{throw"Missing attribute in element "+this.element;}}else{throw"Missing attribute in element "+this.element;}}else if(ORYX.Editor.checkClassType(this.element,SVGPathElement)){this.type="Path";this.editPathParser=new PathParser();this.editPathHandler=new ORYX.Core.SVG.EditPathHandler();this.editPathParser.setHandler(this.editPathHandler);var parser=new PathParser();var handler=new ORYX.Core.SVG.MinMaxPathHandler();parser.setHandler(handler);parser.parsePath(this.element);this.oldX=handler.minX;this.oldY=handler.minY;this.oldWidth=handler.maxX-handler.minX;this.oldHeight=handler.maxY-handler.minY;delete parser;delete handler;}else{throw"Element is not a shape.";}
var resizeAttr=this.element.getAttributeNS(NAMESPACE_ORYX,"resize");if(resizeAttr){resizeAttr=resizeAttr.toLowerCase();if(resizeAttr.match(/horizontal/)){this.isHorizontallyResizable=true;}else{this.isHorizontallyResizable=false;}
if(resizeAttr.match(/vertical/)){this.isVerticallyResizable=true;}else{this.isVerticallyResizable=false;}}else{this.isHorizontallyResizable=false;this.isVerticallyResizable=false;}
var anchorAttr=this.element.getAttributeNS(NAMESPACE_ORYX,"anchors");if(anchorAttr){anchorAttr=anchorAttr.replace("/,/g"," ");var anchors=anchorAttr.split(" ").without("");for(var i=0;i<anchors.length;i++){switch(anchors[i].toLowerCase()){case"left":this.anchorLeft=true;break;case"right":this.anchorRight=true;break;case"top":this.anchorTop=true;break;case"bottom":this.anchorBottom=true;break;}}}
if(ORYX.Editor.checkClassType(this.element,SVGPathElement)){var allowDockersAttr=this.element.getAttributeNS(NAMESPACE_ORYX,"allowDockers");if(allowDockersAttr){if(allowDockersAttr.toLowerCase()==="no"){this.allowDockers=false;}else{this.allowDockers=true;}}
var resizeMarkerMidAttr=this.element.getAttributeNS(NAMESPACE_ORYX,"resizeMarker-mid");if(resizeMarkerMidAttr){if(resizeMarkerMidAttr.toLowerCase()==="yes"){this.resizeMarkerMid=true;}else{this.resizeMarkerMid=false;}}}
this.x=this.oldX;this.y=this.oldY;this.width=this.oldWidth;this.height=this.oldHeight;},update:function(){if(this.x!==this.oldX||this.y!==this.oldY||this.width!==this.oldWidth||this.height!==this.oldHeight){switch(this.type){case"Rect":if(this.x!==this.oldX)this.element.setAttributeNS(null,"x",this.x);if(this.y!==this.oldY)this.element.setAttributeNS(null,"y",this.y);if(this.width!==this.oldWidth)this.element.setAttributeNS(null,"width",this.width);if(this.height!==this.oldHeight)this.element.setAttributeNS(null,"height",this.height);break;case"Circle":this.radiusX=((this.width<this.height)?this.width:this.height)/2.0;this.element.setAttributeNS(null,"cx",this.x+this.width/2.0);this.element.setAttributeNS(null,"cy",this.y+this.height/2.0);this.element.setAttributeNS(null,"r",this.radiusX);break;case"Ellipse":this.radiusX=this.width/2;this.radiusY=this.height/2;this.element.setAttributeNS(null,"cx",this.x+this.radiusX);this.element.setAttributeNS(null,"cy",this.y+this.radiusY);this.element.setAttributeNS(null,"rx",this.radiusX);this.element.setAttributeNS(null,"ry",this.radiusY);break;case"Line":if(this.x!==this.oldX)
this.element.setAttributeNS(null,"x1",this.x);if(this.y!==this.oldY)
this.element.setAttributeNS(null,"y1",this.y);if(this.x!==this.oldX||this.width!==this.oldWidth)
this.element.setAttributeNS(null,"x2",this.x+this.width);if(this.y!==this.oldY||this.height!==this.oldHeight)
this.element.setAttributeNS(null,"y2",this.y+this.height);break;case"Polyline":var points=this.element.getAttributeNS(null,"points");if(points){points=points.replace(/,/g," ").split(" ").without("");if(points&&points.length&&points.length>1){var widthDelta=(this.oldWidth===0)?0:this.width/this.oldWidth;var heightDelta=(this.oldHeight===0)?0:this.height/this.oldHeight;var updatedPoints="";for(var i=0;i<points.length;i++){var x=(parseFloat(points[i])-this.oldX)*widthDelta+this.x;i++;var y=(parseFloat(points[i])-this.oldY)*heightDelta+this.y;updatedPoints+=x+" "+y+" ";}
this.element.setAttributeNS(null,"points",updatedPoints);}else{}}else{}
break;case"Path":var widthDelta=(this.oldWidth===0)?0:this.width/this.oldWidth;var heightDelta=(this.oldHeight===0)?0:this.height/this.oldHeight;this.editPathHandler.init(this.x,this.y,this.oldX,this.oldY,widthDelta,heightDelta);this.editPathParser.parsePath(this.element);this.element.setAttributeNS(null,"d",this.editPathHandler.d);break;}
this.oldX=this.x;this.oldY=this.y;this.oldWidth=this.width;this.oldHeight=this.height;}},isPointIncluded:function(pointX,pointY){if(!pointX||!pointY||!this.isVisible()){return false;}
switch(this.type){case"Rect":return(pointX>=this.x&&pointX<=this.x+this.width&&pointY>=this.y&&pointY<=this.y+this.height);break;case"Circle":return ORYX.Core.Math.isPointInEllipse(pointX,pointY,this.x+this.width/2.0,this.y+this.height/2.0,this.radiusX,this.radiusX);break;case"Ellipse":return ORYX.Core.Math.isPointInEllipse(pointX,pointY,this.x+this.radiusX,this.y+this.radiusY,this.radiusX,this.radiusY);break;case"Line":return ORYX.Core.Math.isPointInLine(pointX,pointY,this.x,this.y,this.x+this.width,this.y+this.height);break;case"Polyline":var points=this.element.getAttributeNS(null,"points");if(points){points=points.replace(/,/g," ").split(" ").without("");points=points.collect(function(n){return parseFloat(n);});return ORYX.Core.Math.isPointInPolygone(pointX,pointY,points);}else{return false;}
break;case"Path":var parser=new PathParser();var handler=new ORYX.Core.SVG.PointsPathHandler();parser.setHandler(handler);parser.parsePath(this.element);return ORYX.Core.Math.isPointInPolygone(pointX,pointY,handler.points);break;default:return false;}},isVisible:function(elem){if(!elem){elem=this.element;}
var hasOwnerSVG=false;try{hasOwnerSVG=!!elem.ownerSVGElement;}catch(e){}
if(hasOwnerSVG){if(ORYX.Editor.checkClassType(elem,SVGGElement)){if(elem.className&&elem.className.baseVal=="me")
return true;}
var fill=elem.getAttributeNS(null,"fill");var stroke=elem.getAttributeNS(null,"stroke");if(fill&&fill=="none"&&stroke&&stroke=="none"){return false;}
var attr=elem.getAttributeNS(null,"display");if(!attr)
return this.isVisible(elem.parentNode);else if(attr=="none")
return false;else{return true;}}
return true;},toString:function(){return(this.element)?"SVGShape "+this.element.id:"SVGShape "+this.element;}});if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.SVG){ORYX.Core.SVG={};}
ORYX.Core.SVG.Label=Clazz.extend({_characterSets:["%W","@","m","wDGMOQÖ#+=<>~^","ABCHKNRSUVXZÜÄ&","bdghnopquxöüETY1234567890ß_§${}*´`µ€","aeksvyzäFLP?°²³","c-","rtJ\"/()[]:;!|\\","fjI., ","'","il"],_characterSetValues:[15,14,13,11,10,9,8,7,6,5,4,3],construct:function(options){ORYX.Log.trace("ORYX.Core.SVG.Label.construct - Begin");arguments.callee.$.construct.apply(this,arguments);if(!options.textElement){throw"Label: No parameter textElement."}else if(!ORYX.Editor.checkClassType(options.textElement,SVGTextElement)){throw"Label: Parameter textElement is not an SVGTextElement."}
this.invisibleRenderPoint=-5000;this.node=options.textElement;this.node.setAttributeNS(null,'stroke-width','0pt');this.node.setAttributeNS(null,'letter-spacing','-0.01px');this.shapeId=options.shapeId;this.id;this.fitToElemId;this.edgePosition;this.x;this.y;this.oldX;this.oldY;this.isVisible=true;this._text;this._verticalAlign;this._horizontalAlign;this._rotate;this._rotationPoint;this.anchorLeft;this.anchorRight;this.anchorTop;this.anchorBottom;this._isChanged=true;var _id=this.node.getAttributeNS(null,'id');if(_id){this.id=_id;}
this.fitToElemId=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,'fittoelem');if(this.fitToElemId)
this.fitToElemId=this.shapeId+this.fitToElemId;var alignValues=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,'align');if(alignValues){alignValues=alignValues.replace(/,/g," ");alignValues=alignValues.split(" ");alignValues=alignValues.without("");alignValues.each((function(alignValue){switch(alignValue){case'top':case'middle':case'bottom':if(!this._verticalAlign){this._verticalAlign=alignValue;}
break;case'left':case'center':case'right':if(!this._horizontalAlign){this._horizontalAlign=alignValue;}
break;}}).bind(this));}
this.edgePosition=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,'edgePosition');if(this.edgePosition){this.edgePosition=this.edgePosition.toLowerCase();}
this.offsetTop=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,'offsetTop')||ORYX.CONFIG.OFFSET_EDGE_LABEL_TOP;if(this.offsetTop){this.offsetTop=parseInt(this.offsetTop);}
this.offsetBottom=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,'offsetBottom')||ORYX.CONFIG.OFFSET_EDGE_LABEL_BOTTOM;if(this.offsetBottom){this.offsetBottom=parseInt(this.offsetBottom);}
var rotateValue=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,'rotate');if(rotateValue){try{this._rotate=parseFloat(rotateValue);}catch(e){this._rotate=0;}}else{this._rotate=0;}
var anchorAttr=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"anchors");if(anchorAttr){anchorAttr=anchorAttr.replace("/,/g"," ");var anchors=anchorAttr.split(" ").without("");for(var i=0;i<anchors.length;i++){switch(anchors[i].toLowerCase()){case"left":this.anchorLeft=true;break;case"right":this.anchorRight=true;break;case"top":this.anchorTop=true;break;case"bottom":this.anchorBottom=true;break;}}}
if(!this._verticalAlign){this._verticalAlign='bottom';}
if(!this._horizontalAlign){this._horizontalAlign='left';}
var xValue=this.node.getAttributeNS(null,'x');if(xValue){this.x=parseFloat(xValue);this.oldX=this.x;}else{}
var yValue=this.node.getAttributeNS(null,'y');if(yValue){this.y=parseFloat(yValue);this.oldY=this.y;}else{}
this.text(this.node.textContent);},changed:function(){this._isChanged=true;},update:function(){ORYX.Log.trace("ORYX.Core.SVG.Label.update - Begin");if(this._isChanged||this.x!==this.oldX||this.y!==this.oldY){if(this.isVisible){this._isChanged=false;this.node.setAttributeNS(null,'x',this.x);this.node.setAttributeNS(null,'y',this.y);switch(this._horizontalAlign){case'left':this.node.setAttributeNS(null,'text-anchor','start');break;case'center':this.node.setAttributeNS(null,'text-anchor','middle');break;case'right':this.node.setAttributeNS(null,'text-anchor','end');break;}
this.oldX=this.x;this.oldY=this.y;if(this._rotate!==undefined){if(this._rotationPoint)
this.node.setAttributeNS(null,'transform','rotate('+this._rotate+' '+this._rotationPoint.x+' '+this._rotationPoint.y+')');else
this.node.setAttributeNS(null,'transform','rotate('+this._rotate+' '+this.x+' '+this.y+')');}
var textLines=this._text.split("\n");while(textLines.last()=="")
textLines.pop();this.node.textContent="";if(this.node.ownerDocument){textLines.each((function(textLine,index){var tspan=this.node.ownerDocument.createElementNS(ORYX.CONFIG.NAMESPACE_SVG,'tspan');tspan.textContent=textLine;tspan.setAttributeNS(null,'x',this.invisibleRenderPoint);tspan.setAttributeNS(null,'y',this.invisibleRenderPoint);if(tspan.textContent===""){tspan.textContent=" ";}
this.node.appendChild(tspan);}).bind(this));if(this.isVisible){this.node.setAttributeNS(null,'visibility','hidden');}
if(this.fitToElemId){this._positionText.bind(this);window.setTimeout(this._checkFittingToReferencedElem.bind(this),100);}else
window.setTimeout(this._positionText.bind(this),0);}}else{this.node.textContent="";}}},_checkFittingToReferencedElem:function(){ORYX.Log.trace("ORYX.Core.SVG.Label._checkFittingToReferencedElem - Begin");try{var tspans=$A(this.node.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,'tspan'));var newtspans=[];var refNode=this.node.ownerDocument.getElementById(this.fitToElemId);ORYX.Log.trace("ORYX.Core.SVG.Label._checkFittingToReferencedElem - fitToElemId="+this.fitToElemId+", refNode.id="+refNode.id);if(refNode){var refbb=refNode.getBBox();var fontSize=this.getFontSize();for(var j=0;j<tspans.length;j++){var tspan=tspans[j];var textLength=this._getRenderedTextLength(tspan,undefined,undefined,fontSize);if(textLength>refbb.width){var startIndex=0;var lastSeperatorIndex=0;var numOfChars=this.getTrimmedTextLength(tspan.textContent);for(var i=0;i<numOfChars;i++){var sslength=this._getRenderedTextLength(tspan,startIndex,i-startIndex,fontSize);if(sslength>refbb.width-2){var newtspan=this.node.ownerDocument.createElementNS(ORYX.CONFIG.NAMESPACE_SVG,'tspan');if(lastSeperatorIndex<=startIndex){lastSeperatorIndex=(i==0)?i:i-1;newtspan.textContent=tspan.textContent.slice(startIndex,lastSeperatorIndex);}
else{newtspan.textContent=tspan.textContent.slice(startIndex,++lastSeperatorIndex);}
newtspan.setAttributeNS(null,'x',this.invisibleRenderPoint);newtspan.setAttributeNS(null,'y',this.invisibleRenderPoint);newtspans.push(newtspan);startIndex=lastSeperatorIndex;}
else{var curChar=tspan.textContent.charAt(i);if(curChar==' '||curChar=='-'||curChar=="."||curChar==","||curChar==";"||curChar==":"){lastSeperatorIndex=i;}}}
tspan.textContent=tspan.textContent.slice(startIndex);}
newtspans.push(tspan);}
while(this.node.hasChildNodes()){this.node.removeChild(this.node.childNodes[0]);}
if(refNode.id!==undefined&&refNode.id.endsWith("textannotationrect")){while(newtspans.length>0){this.node.appendChild(newtspans.shift());}}else{var maxTspans=ORYX.CONFIG.LABEL_MAX_DISPLAYABLE_TSPANS||2;var numDisplayed=0;var numTspans=newtspans.length;while(newtspans.length>0){var tspan=newtspans.shift();var tspanContent=tspan.textContent;if(numDisplayed<maxTspans){if(numTspans>maxTspans&&numDisplayed>0&&numDisplayed==maxTspans-1){tspan.textContent=(tspanContent.length>=3)?tspanContent.substring(0,tspanContent.length-3)+"...":tspanContent;}
this.node.appendChild(tspan);numDisplayed++;}}}}}catch(e){}
window.setTimeout(this._positionText.bind(this),0);},_positionText:function(){ORYX.Log.trace("ORYX.Core.SVG.Label._positionText - Begin");try{var tspans=this.node.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,'tspan');var fontSize=this.getFontSize(this.node);var invalidTSpans=[];$A(tspans).each((function(tspan,index){if(tspan.textContent.trim()===""){invalidTSpans.push(tspan);}else{var dy=0;switch(this._verticalAlign){case'bottom':dy=-(tspans.length-index-1)*(fontSize);break;case'middle':dy=-(tspans.length/2.0-index-1)*(fontSize);dy-=ORYX.CONFIG.LABEL_LINE_DISTANCE/2;break;case'top':dy=index*(fontSize);dy+=fontSize;break;}
tspan.setAttributeNS(null,'dy',dy);tspan.setAttributeNS(null,'x',this.x);tspan.setAttributeNS(null,'y',this.y);}}).bind(this));invalidTSpans.each(function(tspan){this.node.removeChild(tspan)}.bind(this));}catch(e){this._isChanged=true;}
if(this.isVisible){this.node.setAttributeNS(null,'visibility','inherit');}},_getRenderedTextLength:function(tspan,startIndex,endIndex,fontSize){if(/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent)&&new Number(RegExp.$1)>=3){if(startIndex===undefined){return tspan.getComputedTextLength();}else{return tspan.getSubStringLength(startIndex,endIndex);}}else{if(startIndex===undefined){return this._estimateTextWidth(tspan.textContent,fontSize);}else{return this._estimateTextWidth(tspan.textContent.substr(startIndex,endIndex).trim(),fontSize);}}},_estimateTextWidth:function(text,fontSize){ORYX.Log.trace("ORYX.Core.SVG.Label._estimateTextWidth - Begin");var sum=0.0;for(var i=0;i<text.length;i++){sum+=this._estimateCharacterWidth(text.charAt(i));}
return sum*(fontSize/14.0);},_estimateCharacterWidth:function(character){ORYX.Log.trace("ORYX.Core.SVG.Label._estimateCharacterWidth - Begin");for(var i=0;i<this._characterSets.length;i++){if(this._characterSets[i].indexOf(character)>=0){return this._characterSetValues[i];}}
return 9;},getReferencedElementWidth:function(){ORYX.Log.trace("ORYX.Core.SVG.Label.getReferencedElementWidth - Begin");var refNode=this.node.ownerDocument.getElementById(this.fitToElemId);if(refNode){var refbb=refNode.getBBox();if(refbb){return refbb.width;}else{return undefined;}}else{return undefined;}},text:function(){ORYX.Log.trace("ORYX.Core.SVG.Label.text - Begin");switch(arguments.length){case 0:return this._text
break;case 1:var oldText=this._text;if(arguments[0]){this._text=arguments[0].toString();}else{this._text="";}
if(oldText!==this._text){this._isChanged=true;}
break;default:break;}},verticalAlign:function(){ORYX.Log.trace("ORYX.Core.SVG.Label.verticalAlign - Begin");switch(arguments.length){case 0:return this._verticalAlign;case 1:if(['top','middle','bottom'].member(arguments[0])){var oldValue=this._verticalAlign;this._verticalAlign=arguments[0];if(this._verticalAlign!==oldValue){this._isChanged=true;}}
break;default:break;}},horizontalAlign:function(){ORYX.Log.trace("ORYX.Core.SVG.Label.horizontalAlign - Begin");switch(arguments.length){case 0:return this._horizontalAlign;case 1:if(['left','center','right'].member(arguments[0])){var oldValue=this._horizontalAlign;this._horizontalAlign=arguments[0];if(this._horizontalAlign!==oldValue){this._isChanged=true;}}
break;default:break;}},rotate:function(){ORYX.Log.trace("ORYX.Core.SVG.Label.rotate - Begin");switch(arguments.length){case 0:return this._rotate;case 1:if(this._rotate!=arguments[0]){this._rotate=arguments[0];this._rotationPoint=undefined;this._isChanged=true;}
case 2:if(this._rotate!=arguments[0]||!this._rotationPoint||this._rotationPoint.x!=arguments[1].x||this._rotationPoint.y!=arguments[1].y){this._rotate=arguments[0];this._rotationPoint=arguments[1];this._isChanged=true;}}},hide:function(){ORYX.Log.trace("ORYX.Core.SVG.Label.hide - Begin");if(this.isVisible){this.isVisible=false;this._isChanged=true;}},show:function(){ORYX.Log.trace("ORYX.Core.SVG.Label.show - Begin");if(!this.isVisible){this.isVisible=true;this._isChanged=true;}},getInheritedFontSize:function(node){ORYX.Log.trace("ORYX.Core.SVG.Label.getInheritedFontSize - Begin");if(!node||!node.getAttributeNS)
return;var attr=node.getAttributeNS(null,"font-size");if(attr){return parseFloat(attr);}else if(!ORYX.Editor.checkClassType(node,SVGSVGElement)){return this.getInheritedFontSize(node.parentNode);}},getFontSize:function(node){ORYX.Log.trace("ORYX.Core.SVG.Label.getFontSize - Begin");var tspans=this.node.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,'tspan');var fontSize=this.getInheritedFontSize(this.node);if(!fontSize){if(tspans[0]&&/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent)&&new Number(RegExp.$1)>=3){fontSize=tspans[0].getExtentOfChar(0).height;}
else{fontSize=ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT;}
if(fontSize<=0){fontSize=ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT;}}
if(fontSize)
this.node.setAttribute("oryx:fontSize",fontSize);return fontSize;},getTrimmedTextLength:function(text){ORYX.Log.trace("ORYX.Core.SVG.Label.getTrimmedTextLength - Begin");text=text.strip().gsub('  ',' ');var oldLength;do{oldLength=text.length;text=text.gsub('  ',' ');}while(oldLength>text.length);return text.length;},getOffsetBottom:function(){return this.offsetBottom;},getOffsetTop:function(){return this.offsetTop;},toString:function(){ORYX.Log.trace("ORYX.Core.SVG.Label.toString - Begin");return"Label "+this.id;}});if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.Math){ORYX.Core.Math={};}
ORYX.Core.Math.midPoint=function(point1,point2){return{x:(point1.x+point2.x)/2.0,y:(point1.y+point2.y)/2.0};};ORYX.Core.Math.isPointInLine=function(pointX,pointY,lPoint1X,lPoint1Y,lPoint2X,lPoint2Y,offset){offset=offset?Math.abs(offset):1;if(Math.abs(lPoint1X-lPoint2X)<=offset&&Math.abs(pointX-lPoint1X)<=offset&&pointY-Math.max(lPoint1Y,lPoint2Y)<=offset&&Math.min(lPoint1Y,lPoint2Y)-pointY<=offset){return true;}
if(Math.abs(lPoint1Y-lPoint2Y)<=offset&&Math.abs(pointY-lPoint1Y)<=offset&&pointX-Math.max(lPoint1X,lPoint2X)<=offset&&Math.min(lPoint1X,lPoint2X)-pointX<=offset){return true;}
if(pointX>Math.max(lPoint1X,lPoint2X)||pointX<Math.min(lPoint1X,lPoint2X)){return false;}
if(pointY>Math.max(lPoint1Y,lPoint2Y)||pointY<Math.min(lPoint1Y,lPoint2Y)){return false;}
var s=(lPoint1Y-lPoint2Y)/(lPoint1X-lPoint2X);return Math.abs(pointY-((s*pointX)+lPoint1Y-s*lPoint1X))<offset;};ORYX.Core.Math.isPointInEllipse=function(pointX,pointY,cx,cy,rx,ry){if(cx===undefined||cy===undefined||rx===undefined||ry===undefined){throw"ORYX.Core.Math.isPointInEllipse needs a ellipse with these properties: x, y, radiusX, radiusY";}
var tx=(pointX-cx)/rx;var ty=(pointY-cy)/ry;return tx*tx+ty*ty<1.0;};ORYX.Core.Math.isPointInPolygone=function(pointX,pointY,polygone){if(arguments.length<3){throw"ORYX.Core.Math.isPointInPolygone needs two arguments";}
var lastIndex=polygone.length-1;if(polygone[0]!==polygone[lastIndex-1]||polygone[1]!==polygone[lastIndex]){polygone.push(polygone[0]);polygone.push(polygone[1]);}
var crossings=0;var x1,y1,x2,y2,d;for(var i=0;i<polygone.length-3;){x1=polygone[i];y1=polygone[++i];x2=polygone[++i];y2=polygone[i+1];d=(pointY-y1)*(x2-x1)-(pointX-x1)*(y2-y1);if((y1>=pointY)!=(y2>=pointY)){crossings+=y2-y1>=0?d>=0:d<=0;}
if(!d&&Math.min(x1,x2)<=pointX&&pointX<=Math.max(x1,x2)&&Math.min(y1,y2)<=pointY&&pointY<=Math.max(y1,y2)){return true;}}
return(crossings%2)?true:false;};ORYX.Core.Math.distancePointLinie=function(lineP1,lineP2,point,toSegmentOnly){var intersectionPoint=ORYX.Core.Math.getPointOfIntersectionPointLine(lineP1,lineP2,point,toSegmentOnly);if(!intersectionPoint){return null;}
return ORYX.Core.Math.getDistancePointToPoint(point,intersectionPoint);};ORYX.Core.Math.getDistancePointToPoint=function(point1,point2){return Math.sqrt(Math.pow(point1.x-point2.x,2)+Math.pow(point1.y-point2.y,2));};ORYX.Core.Math.getPointOfIntersectionPointLine=function(lineP1,lineP2,point,onSegmentOnly){var denominator=Math.pow(lineP2.x-lineP1.x,2)+
Math.pow(lineP2.y-lineP1.y,2);if(denominator===0){return undefined;}
var u=((point.x-lineP1.x)*(lineP2.x-lineP1.x)+
(point.y-lineP1.y)*(lineP2.y-lineP1.y))/denominator;if(onSegmentOnly){if(!(0<=u&&u<=1)){return undefined;}}
var pointOfIntersection={};pointOfIntersection.x=lineP1.x+u*(lineP2.x-lineP1.x);pointOfIntersection.y=lineP1.y+u*(lineP2.y-lineP1.y);return pointOfIntersection;};if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={};}
ORYX.Core.StencilSet.Stencil={construct:function(jsonStencil,namespace,source,stencilSet,propertyPackages,defaultPosition){arguments.callee.$.construct.apply(this,arguments);if(!jsonStencil)throw"Stencilset seems corrupt.";if(!namespace)throw"Stencil does not provide namespace.";if(!source)throw"Stencil does not provide SVG source.";if(!stencilSet)throw"Fatal internal error loading stencilset.";this._source=source;this._jsonStencil=jsonStencil;this._stencilSet=stencilSet;this._namespace=namespace;this._propertyPackages=propertyPackages;if(defaultPosition&&!this._jsonStencil.position)
this._jsonStencil.position=defaultPosition;this._view;this._properties=new Hash();this.visible=true;if(this._jsonStencil.visible!=undefined)
{this.visible=this._jsonStencil.visible;}
this.generateOutgoing=false;if(this._jsonStencil.generateOutgoing!=undefined)
{this.generateOutgoing=this._jsonStencil.generateOutgoing;}else if(this._jsonStencil.id.indexOf("motv-so-")>=0)
{this.generateOutgoing=true;}
this.outgoingTransitionNames=[];if(this._jsonStencil.outgoingTransitionNames!=undefined&&this._jsonStencil.outgoingTransitionNames.length){this.outgoingTransitionNames=this._jsonStencil.outgoingTransitionNames;}
this.quickTransitionNode=false;if(this._jsonStencil.isQuickTransitionNode!=undefined)
{this.quickTransitionNode=this._jsonStencil.isQuickTransitionNode;}
var modifiedSrc=(this._source.startsWith("/")?this._source.substring(1):this._source);this.contextVal="/"+modifiedSrc.substring(0,modifiedSrc.indexOf("/")+1);if(!this._jsonStencil.type||!(this._jsonStencil.type==="edge"||this._jsonStencil.type==="node")){throw"ORYX.Core.StencilSet.Stencil(construct): Type is not defined.";}
if(!this._jsonStencil.id||this._jsonStencil.id===""){throw"ORYX.Core.StencilSet.Stencil(construct): Id is not defined.";}
if(!this._jsonStencil.title||this._jsonStencil.title===""){throw"ORYX.Core.StencilSet.Stencil(construct): Title is not defined.";}
if(!this._jsonStencil.description){this._jsonStencil.description="";};if(!this._jsonStencil.groups){this._jsonStencil.groups=[];}
if(!this._jsonStencil.roles){this._jsonStencil.roles=[];}
if(!this._jsonStencil.channels){this._jsonStencil.channels=[];}
this._jsonStencil.roles.push(this._jsonStencil.id);this._jsonStencil.roles.each((function(role,index){this._jsonStencil.roles[index]=namespace+role;}).bind(this));this._jsonStencil.roles=this._jsonStencil.roles.uniq();this._jsonStencil.id=namespace+this._jsonStencil.id;this.hasHierarchicalProperties=false;this.postProcessProperties();if(!this._jsonStencil.serialize){this._jsonStencil.serialize={};}
if(!this._jsonStencil.deserialize){this._jsonStencil.deserialize={};}
if(!this._jsonStencil.layout){this._jsonStencil.layout=[]}
var url="";if(this._jsonStencil.resourceLoad){var url1=this.contextVal+"smpresource/"+jsonStencil.view;url=url1;}else{var url2=source+"view/"+jsonStencil.view;url=url2;}
if(this._jsonStencil.view.trim().match(/</)){var parser=new DOMParser();var xml=parser.parseFromString(this._jsonStencil.view,"text/xml");if(ORYX.Editor.checkClassType(xml.documentElement,SVGSVGElement)){this._updateImageLinks.call(this,xml.documentElement);}else{throw"ORYX.Core.StencilSet.Stencil(_loadSVGOnSuccess): The response is not a SVG document."}}else{new Ajax.Request(url,{asynchronous:false,method:'get',onSuccess:this._loadSVGOnSuccess.bind(this),onFailure:this._loadSVGOnFailure.bind(this)});}},postProcessProperties:function(){if(this._jsonStencil.icon&&this._jsonStencil.icon.indexOf("://")===-1){if(this._jsonStencil.resourceLoad){var iconurl=this.contextVal+"smpresource/"+this._jsonStencil.icon;this._jsonStencil.icon=iconurl;}else{this._jsonStencil.icon=this._source+"icons/"+this._jsonStencil.icon;}}else{this._jsonStencil.icon="";}
if(this._jsonStencil.propertyPackages&&this._jsonStencil.propertyPackages instanceof Array){this._jsonStencil.propertyPackages.each((function(ppId){var pp=this._propertyPackages[ppId];if(pp){pp.each((function(prop){var oProp=new ORYX.Core.StencilSet.Property(prop,this._namespace,this);this._properties[oProp.prefix()+"-"+oProp.id()]=oProp;}).bind(this));}}).bind(this));}
if(this._jsonStencil.properties&&this._jsonStencil.properties instanceof Array){var channels=this._stencilSet.jsonChannels();this._jsonStencil.properties.each((function(prop){var oProp=new ORYX.Core.StencilSet.Property(prop,this._namespace,this);if(prop.hierarchy!==undefined){var hash=new Hash();channels.each(function(channel){hash[channel.id]="";});oProp.setValuesByChannel(hash);}
this._properties[oProp.prefix()+"-"+oProp.id()]=oProp;if(!this.hasHierarchicalProperties)
this.hasHierarchicalProperties=prop.hierarchy!==undefined;}).bind(this));}},equals:function(stencil){return(this.id()===stencil.id());},stencilSet:function(){return this._stencilSet;},type:function(){return this._jsonStencil.type;},namespace:function(){return this._namespace;},id:function(){return this._jsonStencil.id;},idWithoutNs:function(){return this.id().replace(this.namespace(),"");},isDisplayNode:function(){return this._jsonStencil.isDisplayNode;},isUUIDRequiredForStencil:function()
{return ORYX.Editor.autoUUID(this.idWithoutNs());},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonStencil,"title");},description:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonStencil,"description");},groups:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonStencil,"groups");},position:function(){return(isNaN(this._jsonStencil.position)?0:this._jsonStencil.position);},view:function(){return this._view.cloneNode(true)||this._view;},icon:function(){return this._jsonStencil.icon;},fixedAspectRatio:function(){return this._jsonStencil.fixedAspectRatio===true;},hasMultipleRepositoryEntries:function(){return(this.getRepositoryEntries().length>0);},getRepositoryEntries:function(){return(this._jsonStencil.repositoryEntries)?$A(this._jsonStencil.repositoryEntries):$A([]);},properties:function(){return this._properties.values();},property:function(id){return this._properties[id];},roles:function(){return this._jsonStencil.roles;},channels:function(){return this._jsonStencil.channels;},hasBackFocus:function(){return/^.+#reference$/.test(this._jsonStencil.id);},showFocusReference:function(){return/^.+#goto-reference$/.test(this._jsonStencil.id);},showQuickEdit:function(){return this._jsonStencil.quick_edit||false;},defaultAlign:function(){if(!this._jsonStencil.defaultAlign)
return"east";return this._jsonStencil.defaultAlign;},serialize:function(shape,data){return this._jsonStencil.serialize;},deserialize:function(shape,data){return this._jsonStencil.deserialize;},layout:function(shape){return this._jsonStencil.layout},addProperty:function(property,namespace){if(property&&namespace){var oProp=new ORYX.Core.StencilSet.Property(property,namespace,this);this._properties[oProp.prefix()+"-"+oProp.id()]=oProp;}},removeProperty:function(propertyId){if(propertyId){var oProp=this._properties.values().find(function(prop){return(propertyId==prop.id());});if(oProp)
delete this._properties[oProp.prefix()+"-"+oProp.id()];}},_loadSVGOnSuccess:function(result){var xml=null;xml=result.responseXML;if(ORYX.Editor.checkClassType(xml.documentElement,SVGSVGElement)){this._updateImageLinks.call(this,xml.documentElement);}else{throw"ORYX.Core.StencilSet.Stencil(_loadSVGOnSuccess): The response is not a SVG document."}},_loadSVGOnFailure:function(result){throw"ORYX.Core.StencilSet.Stencil(_loadSVGOnFailure): Loading SVG document failed."},_updateImageLinks:function(xmldoc){this._view=xmldoc;var imageElems=this._view.getElementsByTagNameNS("http://www.w3.org/2000/svg","image");$A(imageElems).each((function(imageElem){var link=imageElem.getAttributeNodeNS("http://www.w3.org/1999/xlink","href");ORYX.Log.debug("ORYX.Core.StencilSet.Stencil._updateImageLinks()::link.value="+link.value);if(link&&link.value.indexOf("://")==-1){if(this._jsonStencil.resourceLoad){link.textContent=this.contextVal+"smpresource/"+link.value;}else{link.textContent=this._source+"view/"+link.value;}
ORYX.Log.debug("ORYX.Core.StencilSet.Stencil._updateImageLinks()::link.textContent="+link.textContent);}}).bind(this));},toString:function(){return"Stencil "+this.title()+" ("+this.id()+")";}};ORYX.Core.StencilSet.Stencil=Clazz.extend(ORYX.Core.StencilSet.Stencil);function _evenMoreEvilHack(str,contentType){if(window.ActiveXObject){var d=new ActiveXObject("MSXML.DomDocument");d.loadXML(str);return d;}else if(window.XMLHttpRequest){var req=new XMLHttpRequest;req.open("GET","data:"+(contentType||"application/xml")+";charset=utf-8,"+encodeURIComponent(str),false);if(req.overrideMimeType){req.overrideMimeType(contentType);}
req.send(null);return req.responseXML;}}
function _evilSafariHack(serializedXML){var xml=serializedXML;var url="data:text/xml;charset=utf-8,"+encodeURIComponent(xml);var dom=null;var req=new XMLHttpRequest();req.open("GET",url);req.onload=function(){dom=req.responseXML;}
req.send(null);return dom;}
if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={};}
ORYX.Core.StencilSet.Property=Clazz.extend({construct:function(jsonProp,namespace,stencil){arguments.callee.$.construct.apply(this,arguments);this._jsonProp=jsonProp||ORYX.Log.error("Parameter jsonProp is not defined.");this._namespace=namespace||ORYX.Log.error("Parameter namespace is not defined.");this._stencil=stencil||ORYX.Log.error("Parameter stencil is not defined.");this._items=new Hash();this._complexItems=new Hash();this._dynamicItems=new Hash();this._valuesByChannel=new Hash();jsonProp.id=jsonProp.id||ORYX.Log.error("ORYX.Core.StencilSet.Property(construct): Id is not defined.");jsonProp.id=jsonProp.id.toLowerCase();if(!jsonProp.type){ORYX.Log.info("Type is not defined for stencil '%0', id '%1'. Falling back to 'String'.",stencil,jsonProp.id);jsonProp.type="string";}
else{jsonProp.type=jsonProp.type.toLowerCase();}
jsonProp.prefix=jsonProp.prefix||"oryx";jsonProp.title=jsonProp.title||"";jsonProp.value=jsonProp.value||"";jsonProp.description=jsonProp.description||"";jsonProp.icon=jsonProp.icon||"";jsonProp.readonly=jsonProp.readonly||false;jsonProp.language=jsonProp.language||"";jsonProp.scriptLanguage=jsonProp.scriptLanguage||false;if(jsonProp.optional!=false)
jsonProp.optional=true;if(this._jsonProp.refToView){if(!(this._jsonProp.refToView instanceof Array)){this._jsonProp.refToView=[this._jsonProp.refToView];}}
else{this._jsonProp.refToView=[];}
if(jsonProp.min===undefined||jsonProp.min===null){jsonProp.min=Number.MIN_VALUE;}
if(jsonProp.max===undefined||jsonProp.max===null){jsonProp.max=Number.MAX_VALUE;}
if(!jsonProp.fillOpacity){jsonProp.fillOpacity=false;}
if(!jsonProp.strokeOpacity){jsonProp.strokeOpacity=false;}
if(jsonProp.length===undefined||jsonProp.length===null){jsonProp.length=Number.MAX_VALUE;}
if(!jsonProp.wrapLines){jsonProp.wrapLines=false;}
if(!jsonProp.dateFormat){jsonProp.dataFormat="m/d/y";}
if(!jsonProp.fill){jsonProp.fill=false;}
if(!jsonProp.stroke){jsonProp.stroke=false;}
if(!jsonProp.inverseBoolean){jsonProp.inverseBoolean=false;}
if(!jsonProp.directlyEditable&&jsonProp.directlyEditable!=false){jsonProp.directlyEditable=true;}
if(jsonProp.visible!==false){jsonProp.visible=true;}
if(!jsonProp.popular){jsonProp.popular=false;}
if(!jsonProp.channel){jsonProp.channel="";}
if(!jsonProp.group){jsonProp.group="";}
if(!jsonProp.groupPriority){jsonProp.groupPriority=0;}
if(jsonProp.type===ORYX.CONFIG.TYPE_CHOICE){if(jsonProp.itemFunc){this._itemFunc=jsonProp.itemFunc;this._dynamicItems=null;}else if(jsonProp.items&&jsonProp.items instanceof Array){jsonProp.items.each((function(jsonItem){this._items[jsonItem.value]=new ORYX.Core.StencilSet.PropertyItem(jsonItem,namespace,this);}).bind(this));}
else{throw"ORYX.Core.StencilSet.Property(construct): No property items defined."}}
else
if(jsonProp.type===ORYX.CONFIG.TYPE_COMPLEX||jsonProp.type==ORYX.CONFIG.TYPE_MULTIPLECOMPLEX){if(jsonProp.complexItems&&jsonProp.complexItems instanceof Array){jsonProp.complexItems.each((function(jsonComplexItem){this._complexItems[jsonComplexItem.id]=new ORYX.Core.StencilSet.ComplexPropertyItem(jsonComplexItem,namespace,this);}).bind(this));}
else{throw"ORYX.Core.StencilSet.Property(construct): No complex property items defined."}}},equals:function(property){return(this._namespace===property.namespace()&&this.id()===property.id())?true:false;},namespace:function(){return this._namespace;},stencil:function(){return this._stencil;},icon:function(){return this._jsonProp.icon;},id:function(){return this._jsonProp.id;},prefix:function(){return this._jsonProp.prefix;},type:function(){return this._jsonProp.type;},inverseBoolean:function(){return this._jsonProp.inverseBoolean;},channel:function(){return this._jsonProp.channel;},group:function(){return this._jsonProp.group;},groupPriority:function(){return this._jsonProp.groupPriority;},popular:function(){return this._jsonProp.popular;},setPopular:function(){this._jsonProp.popular=true;},directlyEditable:function(){return this._jsonProp.directlyEditable;},visible:function(){return this._jsonProp.visible;},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonProp,"title");},value:function(){return this._jsonProp.value;},readonly:function(){return this._jsonProp.readonly;},optional:function(){return this._jsonProp.optional;},description:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonProp,"description");},language:function(){return this._jsonProp.language;},scriptLanguage:function(){return this._jsonProp.scriptLanguage;},refToView:function(){return this._jsonProp.refToView;},min:function(){return this._jsonProp.min;},max:function(){return this._jsonProp.max;},fillOpacity:function(){return this._jsonProp.fillOpacity;},strokeOpacity:function(){return this._jsonProp.strokeOpacity;},length:function(){return this._jsonProp.length?this._jsonProp.length:Number.MAX_VALUE;},wrapLines:function(){return this._jsonProp.wrapLines;},dateFormat:function(){return this._jsonProp.dateFormat;},fill:function(){return this._jsonProp.fill;},stroke:function(){return this._jsonProp.stroke;},items:function(){if(this._itemFunc){if(this._dynamicItems!=null){return this._dynamicItems.values();}
return this._itemFunc(this).values();}
return this._items.values();},setItems:function(items){this._dynamicItems=items;},setValuesByChannel:function(hash){this._valuesByChannel=hash;},item:function(value){if(this._itemFunc){if(this._dynamicItems!=null){return this._dynamicItems[value];}
return this._itemFunc(this)[value];}
return this.items()[value];},toString:function(){return"Property "+this.title()+" ("+this.id()+")";},complexItems:function(){return this._complexItems.values();},complexItem:function(id){return this._complexItems[id];},complexAttributeToView:function(){return this._jsonProp.complexAttributeToView||"";}});if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={};}
ORYX.Core.StencilSet.PropertyItem=Clazz.extend({construct:function(jsonItem,namespace,property){arguments.callee.$.construct.apply(this,arguments);if(!jsonItem){throw"ORYX.Core.StencilSet.PropertyItem(construct): Parameter jsonItem is not defined.";}
if(!namespace){throw"ORYX.Core.StencilSet.PropertyItem(construct): Parameter namespace is not defined.";}
if(!property){throw"ORYX.Core.StencilSet.PropertyItem(construct): Parameter property is not defined.";}
this._jsonItem=jsonItem;this._namespace=namespace;this._property=property;if(jsonItem.value===undefined){throw"ORYX.Core.StencilSet.PropertyItem(construct): Value is not defined.";}
if(jsonItem.visible===undefined){this._jsonItem.visible=true;}
if(this._jsonItem.refToView){if(!(this._jsonItem.refToView instanceof Array)){this._jsonItem.refToView=[this._jsonItem.refToView];}}else{this._jsonItem.refToView=[];}
if(this._jsonItem.hasChildren===undefined||this._jsonItem.hasChildren!==true)
this._jsonItem.hasChildren=false;},equals:function(item){return(this.property().equals(item.property())&&this.value()===item.value());},namespace:function(){return this._namespace;},property:function(){return this._property;},value:function(){return this._jsonItem.value;},visible:function(){return this._jsonItem.visible;},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonItem,"title");},refToView:function(){return this._jsonItem.refToView;},icon:function(){return(this._jsonItem.icon)?this.property().stencil()._source+"icons/"+this._jsonItem.icon:"";},hasChildren:function(){return this._jsonItem.hasChildren;},toString:function(){return"PropertyItem "+this.property()+" ("+this.value()+")";}});if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={};}
ORYX.Core.StencilSet.ComplexPropertyItem=Clazz.extend({construct:function(jsonItem,namespace,property){arguments.callee.$.construct.apply(this,arguments);if(!jsonItem){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Parameter jsonItem is not defined.";}
if(!namespace){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Parameter namespace is not defined.";}
if(!property){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Parameter property is not defined.";}
this._jsonItem=jsonItem;this._namespace=namespace;this._property=property;this._items=new Hash();this._complexItems=new Hash();if(!jsonItem.name){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Name is not defined.";}
if(!jsonItem.type){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Type is not defined.";}else{jsonItem.type=jsonItem.type.toLowerCase();}
if(jsonItem.type===ORYX.CONFIG.TYPE_CHOICE){if(jsonItem.items&&jsonItem.items instanceof Array){jsonItem.items.each((function(item){this._items[item.value]=new ORYX.Core.StencilSet.PropertyItem(item,namespace,this);}).bind(this));}else{throw"ORYX.Core.StencilSet.Property(construct): No property items defined."}}
else if(jsonItem.type===ORYX.CONFIG.TYPE_COMPLEX){if(jsonItem.complexItems&&jsonItem.complexItems instanceof Array){jsonItem.complexItems.each((function(complexItem){this._complexItems[complexItem.id]=new ORYX.Core.StencilSet.ComplexPropertyItem(complexItem,namespace,this);}).bind(this));}else{throw"ORYX.Core.StencilSet.Property(construct): No property items defined."}}},equals:function(item){return(this.property().equals(item.property())&&this.name()===item.name());},namespace:function(){return this._namespace;},property:function(){return this._property;},name:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonItem,"name");},id:function(){return this._jsonItem.id;},type:function(){return this._jsonItem.type;},optional:function(){return this._jsonItem.optional;},width:function(){return this._jsonItem.width;},value:function(){return this._jsonItem.value;},items:function(){return this._items.values();},complexItems:function(){return this._complexItems.values();},disable:function(){return this._jsonItem.disable;}});if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={};}
ORYX.Core.StencilSet.Rules={construct:function(){arguments.callee.$.construct.apply(this,arguments);this._stencilSets=[];this._stencils=[];this._cachedConnectSET=new Hash();this._cachedConnectSE=new Hash();this._cachedConnectTE=new Hash();this._cachedCardSE=new Hash();this._cachedCardTE=new Hash();this._cachedContainPC=new Hash();this._cachedMorphRS=new Hash();this._connectionRules=new Hash();this._cardinalityRules=new Hash();this._containmentRules=new Hash();this._morphingRules=new Hash();this._layoutRules=new Hash();},initializeRules:function(stencilSet){var existingSS=this._stencilSets.find(function(ss){return(ss.namespace()==stencilSet.namespace());});if(existingSS){var stencilsets=this._stencilSets.clone();stencilsets=stencilsets.without(existingSS);stencilsets.push(stencilSet);this._stencilSets=[];this._stencils=[];this._cachedConnectSET=new Hash();this._cachedConnectSE=new Hash();this._cachedConnectTE=new Hash();this._cachedCardSE=new Hash();this._cachedCardTE=new Hash();this._cachedContainPC=new Hash();this._cachedMorphRS=new Hash();this._connectionRules=new Hash();this._cardinalityRules=new Hash();this._containmentRules=new Hash();this._morphingRules=new Hash();this._layoutRules=new Hash();stencilsets.each(function(ss){this.initializeRules(ss);}.bind(this));return;}
else{this._stencilSets.push(stencilSet);var jsonRules=new Hash(stencilSet.jsonRules());var namespace=stencilSet.namespace();var stencils=stencilSet.stencils();stencilSet.extensions().values().each(function(extension){if(extension.rules){if(extension.rules.connectionRules)
jsonRules.connectionRules=jsonRules.connectionRules.concat(extension.rules.connectionRules);if(extension.rules.cardinalityRules)
jsonRules.cardinalityRules=jsonRules.cardinalityRules.concat(extension.rules.cardinalityRules);if(extension.rules.containmentRules)
jsonRules.containmentRules=jsonRules.containmentRules.concat(extension.rules.containmentRules);if(extension.rules.morphingRules)
jsonRules.morphingRules=jsonRules.morphingRules.concat(extension.rules.morphingRules);}
if(extension.stencils)
stencils=stencils.concat(extension.stencils);});this._stencils=this._stencils.concat(stencilSet.stencils());var cr=this._connectionRules;if(jsonRules.connectionRules){jsonRules.connectionRules.each((function(rules){if(this._isRoleOfOtherNamespace(rules.role)){if(!cr[rules.role]){cr[rules.role]=new Hash();}}
else{if(!cr[namespace+rules.role])
cr[namespace+rules.role]=new Hash();}
rules.connects.each((function(connect){var toRoles=[];if(connect.to){if(!(connect.to instanceof Array)){connect.to=[connect.to];}
connect.to.each((function(to){if(this._isRoleOfOtherNamespace(to)){toRoles.push(to);}
else{toRoles.push(namespace+to);}}).bind(this));}
var role,from;if(this._isRoleOfOtherNamespace(rules.role))
role=rules.role;else
role=namespace+rules.role;if(this._isRoleOfOtherNamespace(connect.from))
from=connect.from;else
from=namespace+connect.from;if(!cr[role][from])
cr[role][from]=toRoles;else
cr[role][from]=cr[role][from].concat(toRoles);}).bind(this));}).bind(this));}
var cardr=this._cardinalityRules;if(jsonRules.cardinalityRules){jsonRules.cardinalityRules.each((function(rules){var cardrKey;if(this._isRoleOfOtherNamespace(rules.role)){cardrKey=rules.role;}
else{cardrKey=namespace+rules.role;}
if(!cardr[cardrKey]){cardr[cardrKey]={};for(i in rules){cardr[cardrKey][i]=rules[i];}}
var oe=new Hash();if(rules.outgoingEdges){rules.outgoingEdges.each((function(rule){if(this._isRoleOfOtherNamespace(rule.role)){oe[rule.role]=rule;}
else{oe[namespace+rule.role]=rule;}}).bind(this));}
cardr[cardrKey].outgoingEdges=oe;var ie=new Hash();if(rules.incomingEdges){rules.incomingEdges.each((function(rule){if(this._isRoleOfOtherNamespace(rule.role)){ie[rule.role]=rule;}
else{ie[namespace+rule.role]=rule;}}).bind(this));}
cardr[cardrKey].incomingEdges=ie;}).bind(this));}
var conr=this._containmentRules;if(jsonRules.containmentRules){jsonRules.containmentRules.each((function(rules){var conrKey;if(this._isRoleOfOtherNamespace(rules.role)){conrKey=rules.role;}
else{conrKey=namespace+rules.role;}
if(!conr[conrKey]){conr[conrKey]=[];}
rules.contains.each((function(containRole){if(this._isRoleOfOtherNamespace(containRole)){conr[conrKey].push(containRole);}
else{conr[conrKey].push(namespace+containRole);}}).bind(this));}).bind(this));}
var morphr=this._morphingRules;if(jsonRules.morphingRules){jsonRules.morphingRules.each((function(rules){var morphrKey;if(this._isRoleOfOtherNamespace(rules.role)){morphrKey=rules.role;}
else{morphrKey=namespace+rules.role;}
if(!morphr[morphrKey]){morphr[morphrKey]=[];}
if(!rules.preserveBounds){rules.preserveBounds=false;}
rules.baseMorphs.each((function(baseMorphStencilId){morphr[morphrKey].push(this._getStencilById(namespace+baseMorphStencilId));}).bind(this));}).bind(this));}
var layoutRules=this._layoutRules;if(jsonRules.layoutRules){var getDirections=function(o){return{"edgeRole":o.edgeRole||undefined,"t":o["t"]||1,"r":o["r"]||1,"b":o["b"]||1,"l":o["l"]||1}}
jsonRules.layoutRules.each(function(rules){var layoutKey;if(this._isRoleOfOtherNamespace(rules.role)){layoutKey=rules.role;}
else{layoutKey=namespace+rules.role;}
if(!layoutRules[layoutKey]){layoutRules[layoutKey]={};}
if(rules["in"]){layoutRules[layoutKey]["in"]=getDirections(rules["in"]);}
if(rules["ins"]){layoutRules[layoutKey]["ins"]=(rules["ins"]||[]).map(function(e){return getDirections(e)})}
if(rules["out"]){layoutRules[layoutKey]["out"]=getDirections(rules["out"]);}
if(rules["outs"]){layoutRules[layoutKey]["outs"]=(rules["outs"]||[]).map(function(e){return getDirections(e)})}}.bind(this));}}},_getStencilById:function(id){return this._stencils.find(function(stencil){return stencil.id()==id;});},_cacheConnect:function(args){result=this._canConnect(args);if(args.sourceStencil&&args.targetStencil){var source=this._cachedConnectSET[args.sourceStencil.id()];if(!source){source=new Hash();this._cachedConnectSET[args.sourceStencil.id()]=source;}
var edge=source[args.edgeStencil.id()];if(!edge){edge=new Hash();source[args.edgeStencil.id()]=edge;}
edge[args.targetStencil.id()]=result;}else if(args.sourceStencil){var source=this._cachedConnectSE[args.sourceStencil.id()];if(!source){source=new Hash();this._cachedConnectSE[args.sourceStencil.id()]=source;}
source[args.edgeStencil.id()]=result;}else{var target=this._cachedConnectTE[args.targetStencil.id()];if(!target){target=new Hash();this._cachedConnectTE[args.targetStencil.id()]=target;}
target[args.edgeStencil.id()]=result;}
return result;},_cacheCard:function(args){if(args.sourceStencil){var source=this._cachedCardSE[args.sourceStencil.id()]
if(!source){source=new Hash();this._cachedCardSE[args.sourceStencil.id()]=source;}
var max=this._getMaximumNumberOfOutgoingEdge(args);if(max==undefined)
max=-1;source[args.edgeStencil.id()]=max;}
if(args.targetStencil){var target=this._cachedCardTE[args.targetStencil.id()]
if(!target){target=new Hash();this._cachedCardTE[args.targetStencil.id()]=target;}
var max=this._getMaximumNumberOfIncomingEdge(args);if(max==undefined)
max=-1;target[args.edgeStencil.id()]=max;}},_cacheContain:function(args){var result=[this._canContain(args),this._getMaximumOccurrence(args.containingStencil,args.containedStencil)]
if(result[1]==undefined)
result[1]=-1;var children=this._cachedContainPC[args.containingStencil.id()];if(!children){children=new Hash();this._cachedContainPC[args.containingStencil.id()]=children;}
children[args.containedStencil.id()]=result;return result;},_cacheMorph:function(role){var morphs=this._cachedMorphRS[role];if(!morphs){morphs=[];if(this._morphingRules.keys().include(role)){morphs=this._stencils.select(function(stencil){return stencil.roles().include(role);});}
this._cachedMorphRS[role]=morphs;}
return morphs;},outgoingEdgeStencils:function(args){if(!args.sourceShape&&!args.sourceStencil){return[];}
if(args.sourceShape){args.sourceStencil=args.sourceShape.getStencil();}
var _edges=[];this._stencils.each((function(stencil){if(stencil.type()==="edge"){var newArgs=Object.clone(args);newArgs.edgeStencil=stencil;if(this.canConnect(newArgs)){_edges.push(stencil);}}}).bind(this));return _edges;},incomingEdgeStencils:function(args){if(!args.targetShape&&!args.targetStencil){return[];}
if(args.targetShape){args.targetStencil=args.targetShape.getStencil();}
var _edges=[];this._stencils.each((function(stencil){if(stencil.type()==="edge"){var newArgs=Object.clone(args);newArgs.edgeStencil=stencil;if(this.canConnect(newArgs)){_edges.push(stencil);}}}).bind(this));return _edges;},sourceStencils:function(args){if(!args||!args.edgeShape&&!args.edgeStencil){return[];}
if(args.targetShape){args.targetStencil=args.targetShape.getStencil();}
if(args.edgeShape){args.edgeStencil=args.edgeShape.getStencil();}
var _sources=[];this._stencils.each((function(stencil){var newArgs=Object.clone(args);newArgs.sourceStencil=stencil;if(this.canConnect(newArgs)){_sources.push(stencil);}}).bind(this));return _sources;},targetStencils:function(args){if(!args||!args.edgeShape&&!args.edgeStencil){return[];}
if(args.sourceShape){args.sourceStencil=args.sourceShape.getStencil();}
if(args.edgeShape){args.edgeStencil=args.edgeShape.getStencil();}
var _targets=[];this._stencils.each((function(stencil){var newArgs=Object.clone(args);newArgs.targetStencil=stencil;if(this.canConnect(newArgs)){_targets.push(stencil);}}).bind(this));return _targets;},canConnect:function(args){if(!args||(!args.sourceShape&&!args.sourceStencil&&!args.targetShape&&!args.targetStencil)||!args.edgeShape&&!args.edgeStencil){return false;}
if(args.sourceShape){args.sourceStencil=args.sourceShape.getStencil();}
if(args.targetShape){args.targetStencil=args.targetShape.getStencil();}
if(args.edgeShape){args.edgeStencil=args.edgeShape.getStencil();}
var result;if(args.sourceStencil&&args.targetStencil){var source=this._cachedConnectSET[args.sourceStencil.id()];if(!source)
result=this._cacheConnect(args);else{var edge=source[args.edgeStencil.id()];if(!edge)
result=this._cacheConnect(args);else{var target=edge[args.targetStencil.id()];if(target==undefined)
result=this._cacheConnect(args);else
result=target;}}}else if(args.sourceStencil){var source=this._cachedConnectSE[args.sourceStencil.id()];if(!source)
result=this._cacheConnect(args);else{var edge=source[args.edgeStencil.id()];if(edge==undefined)
result=this._cacheConnect(args);else
result=edge;}}else{var target=this._cachedConnectTE[args.targetStencil.id()];if(!target)
result=this._cacheConnect(args);else{var edge=target[args.edgeStencil.id()];if(edge==undefined)
result=this._cacheConnect(args);else
result=edge;}}
if(result){if(args.sourceShape){var source=this._cachedCardSE[args.sourceStencil.id()];if(!source){this._cacheCard(args);source=this._cachedCardSE[args.sourceStencil.id()];}
var max=source[args.edgeStencil.id()];if(max==undefined){this._cacheCard(args);}
max=source[args.edgeStencil.id()];if(max!=-1){result=args.sourceShape.getOutgoingShapes().all(function(cs){if((cs.getStencil().id()===args.edgeStencil.id())&&((args.edgeShape)?cs!==args.edgeShape:true)){max--;return(max>0)?true:false;}else{return true;}});}}
if(args.targetShape){var target=this._cachedCardTE[args.targetStencil.id()];if(!target){this._cacheCard(args);target=this._cachedCardTE[args.targetStencil.id()];}
var max=target[args.edgeStencil.id()];if(max==undefined){this._cacheCard(args);}
max=target[args.edgeStencil.id()];if(max!=-1){result=args.targetShape.getIncomingShapes().all(function(cs){if((cs.getStencil().id()===args.edgeStencil.id())&&((args.edgeShape)?cs!==args.edgeShape:true)){max--;return(max>0)?true:false;}
else{return true;}});}}}
return result;},_canConnect:function(args){if(!args||(!args.sourceShape&&!args.sourceStencil&&!args.targetShape&&!args.targetStencil)||!args.edgeShape&&!args.edgeStencil){return false;}
if(args.sourceShape){args.sourceStencil=args.sourceShape.getStencil();}
if(args.targetShape){args.targetStencil=args.targetShape.getStencil();}
if(args.edgeShape){args.edgeStencil=args.edgeShape.getStencil();}
var resultCR;var edgeRules=this._getConnectionRulesOfEdgeStencil(args.edgeStencil);if(edgeRules.keys().length===0){resultCR=false;}else{if(args.sourceStencil){resultCR=args.sourceStencil.roles().any(function(sourceRole){var targetRoles=edgeRules[sourceRole];if(!targetRoles){return false;}
if(args.targetStencil){return(targetRoles.any(function(targetRole){return args.targetStencil.roles().member(targetRole);}));}else{return true;}});}else{resultCR=edgeRules.values().any(function(targetRoles){return args.targetStencil.roles().any(function(targetRole){return targetRoles.member(targetRole);});});}}
return resultCR;},canContain:function(args){if(!args||!args.containingStencil&&!args.containingShape||!args.containedStencil&&!args.containedShape){return false;}
if(args.containedShape){args.containedStencil=args.containedShape.getStencil();}
if(args.containingShape){args.containingStencil=args.containingShape.getStencil();}
if(args.containedStencil.type()=='edge')
return false;var childValues;var parent=this._cachedContainPC[args.containingStencil.id()];if(!parent)
childValues=this._cacheContain(args);else{childValues=parent[args.containedStencil.id()];if(!childValues)
childValues=this._cacheContain(args);}
if(!childValues[0])
return false;else if(childValues[1]==-1)
return true;else{if(args.containingShape){var max=childValues[1];return args.containingShape.getChildShapes(false).all(function(as){if(as.getStencil().id()===args.containedStencil.id()){max--;return(max>0)?true:false;}else{return true;}});}else{return true;}}},_canContain:function(args){if(!args||!args.containingStencil&&!args.containingShape||!args.containedStencil&&!args.containedShape){return false;}
if(args.containedShape){args.containedStencil=args.containedShape.getStencil();}
if(args.containingShape){args.containingStencil=args.containingShape.getStencil();}
var result;result=args.containingStencil.roles().any((function(role){var roles=this._containmentRules[role];if(roles){return roles.any(function(role){return args.containedStencil.roles().member(role);});}else{return false;}}).bind(this));return result;},morphStencils:function(args){if(!args.stencil&&!args.shape){return[];}
if(args.shape){args.stencil=args.shape.getStencil();}
var _morphStencils=[];args.stencil.roles().each(function(role){this._cacheMorph(role).each(function(stencil){_morphStencils.push(stencil);})}.bind(this));return _morphStencils.uniq();},baseMorphs:function(){var _baseMorphs=[];this._morphingRules.each(function(pair){pair.value.each(function(baseMorph){_baseMorphs.push(baseMorph);});});return _baseMorphs;},containsMorphingRules:function(){return this._stencilSets.any(function(ss){return!!ss.jsonRules().morphingRules});},connectMorph:function(args){if(!args||(!args.sourceShape&&!args.sourceStencil&&!args.targetShape&&!args.targetStencil)){return false;}
if(args.sourceShape){args.sourceStencil=args.sourceShape.getStencil();}
if(args.targetShape){args.targetStencil=args.targetShape.getStencil();}
var incoming=this.incomingEdgeStencils(args);var outgoing=this.outgoingEdgeStencils(args);var edgeStencils=incoming.select(function(e){return outgoing.member(e);});var baseEdgeStencils=this.baseMorphs().select(function(e){return edgeStencils.member(e);});if(baseEdgeStencils.size()>0)
return baseEdgeStencils[0];else if(edgeStencils.size()>0)
return edgeStencils[0];return null;},showInShapeMenu:function(stencil){return this._stencilSets.any(function(ss){return ss.jsonRules().morphingRules.any(function(r){return stencil.roles().include(ss.namespace()+r.role)&&r.showInShapeMenu!==false;})});},preserveBounds:function(stencil){return this._stencilSets.any(function(ss){return ss.jsonRules().morphingRules.any(function(r){return stencil.roles().include(ss.namespace()+r.role)&&r.preserveBounds;})})},getLayoutingRules:function(shape,edgeShape){if(!shape||!(shape instanceof ORYX.Core.Shape)){return}
var layout={"in":{},"out":{}};var parseValues=function(o,v){if(o&&o[v]){["t","r","b","l"].each(function(d){layout[v][d]=Math.max(o[v][d],layout[v][d]||0);});}
if(o&&o[v+"s"]instanceof Array){["t","r","b","l"].each(function(d){var defaultRule=o[v+"s"].find(function(e){return!e.edgeRole});var edgeRule;if(edgeShape instanceof ORYX.Core.Edge){edgeRule=o[v+"s"].find(function(e){return this._hasRole(edgeShape,e.edgeRole)}.bind(this));}
layout[v][d]=Math.max(edgeRule?edgeRule[d]:defaultRule[d],layout[v][d]||0);}.bind(this));}}.bind(this)
shape.getStencil().roles().each(function(role){if(this._layoutRules[role]){parseValues(this._layoutRules[role],"in");parseValues(this._layoutRules[role],"out");}}.bind(this));["in","out"].each(function(v){["t","r","b","l"].each(function(d){layout[v][d]=layout[v][d]!==undefined?layout[v][d]:1;});})
return layout;},_hasRole:function(shape,role){if(!(shape instanceof ORYX.Core.Shape)||!role){return}
var isRole=shape.getStencil().roles().any(function(r){return r==role});return isRole||shape.getStencil().id()==(shape.getStencil().namespace()+role);},_stencilsWithRole:function(role){return this._stencils.findAll(function(stencil){return(stencil.roles().member(role))?true:false;});},_edgesWithRole:function(role){return this._stencils.findAll(function(stencil){return(stencil.roles().member(role)&&stencil.type()==="edge")?true:false;});},_nodesWithRole:function(role){return this._stencils.findAll(function(stencil){return(stencil.roles().member(role)&&stencil.type()==="node")?true:false;});},_getMaximumOccurrence:function(parent,child){var max;child.roles().each((function(role){var cardRule=this._cardinalityRules[role];if(cardRule&&cardRule.maximumOccurrence){if(max){max=Math.min(max,cardRule.maximumOccurrence);}else{max=cardRule.maximumOccurrence;}}}).bind(this));return max;},_getMaximumNumberOfOutgoingEdge:function(args){if(!args||!args.sourceStencil||!args.edgeStencil){return false;}
var max;args.sourceStencil.roles().each((function(role){var cardRule=this._cardinalityRules[role];if(cardRule&&cardRule.outgoingEdges){args.edgeStencil.roles().each(function(edgeRole){var oe=cardRule.outgoingEdges[edgeRole];if(oe&&oe.maximum){if(max){max=Math.min(max,oe.maximum);}else{max=oe.maximum;}}});}}).bind(this));return max;},_getMaximumNumberOfIncomingEdge:function(args){if(!args||!args.targetStencil||!args.edgeStencil){return false;}
var max;args.targetStencil.roles().each((function(role){var cardRule=this._cardinalityRules[role];if(cardRule&&cardRule.incomingEdges){args.edgeStencil.roles().each(function(edgeRole){var ie=cardRule.incomingEdges[edgeRole];if(ie&&ie.maximum){if(max){max=Math.min(max,ie.maximum);}else{max=ie.maximum;}}});}}).bind(this));return max;},_getConnectionRulesOfEdgeStencil:function(edgeStencil){var edgeRules=new Hash();edgeStencil.roles().each((function(role){if(this._connectionRules[role]){this._connectionRules[role].each(function(cr){if(edgeRules[cr.key]){edgeRules[cr.key]=edgeRules[cr.key].concat(cr.value);}else{edgeRules[cr.key]=cr.value;}});}}).bind(this));return edgeRules;},_isRoleOfOtherNamespace:function(role){return(role.indexOf("#")>0);},toString:function(){return"Rules";}}
ORYX.Core.StencilSet.Rules=Clazz.extend(ORYX.Core.StencilSet.Rules);if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={};}
ORYX.Core.StencilSet.StencilSet=Clazz.extend({construct:function(source){arguments.callee.$.construct.apply(this,arguments);if(!source){throw"ORYX.Core.StencilSet.StencilSet(construct): Parameter 'source' is not defined.";}
if(source.endsWith("/")){source=source.substr(0,source.length-1);}
this._extensions=new Hash();this._source=source;this._baseUrl=source.substring(0,source.lastIndexOf("/")+1);this._jsonObject={};this._stencils=new Hash();this._availableStencils=new Hash();if(ORYX.CONFIG.BACKEND_SWITCH){new Ajax.Request(source,{asynchronous:false,method:'get',onSuccess:this._getJSONURL.bind(this),onFailure:this._cancelInit.bind(this)});}else{new Ajax.Request(source,{asynchronous:false,method:'get',onSuccess:this._init.bind(this),onFailure:this._cancelInit.bind(this)});}
if(this.errornous)
throw"Loading stencil set "+source+" failed.";},findRootStencilName:function(){var rootStencil=this._stencils.values().find(function(stencil){return stencil._jsonStencil.mayBeRoot});if(!rootStencil){ORYX.Log.warn("Did not find any stencil that may be root. Taking a guess.");rootStencil=this._stencils.values()[0];}
return rootStencil.id();},equals:function(stencilSet){return(this.namespace()===stencilSet.namespace());},stencils:function(rootStencil,rules,sortByGroup){if(rootStencil&&rules){var stencils=this._availableStencils.values();var containers=[rootStencil];var checkedContainers=[];var result=[];while(containers.size()>0){var container=containers.pop();checkedContainers.push(container);var children=stencils.findAll(function(stencil){var args={containingStencil:container,containedStencil:stencil};return rules.canContain(args);});for(var i=0;i<children.size();i++){if(!checkedContainers.member(children[i])){containers.push(children[i]);}}
result=result.concat(children).uniq();}
result=result.sortBy(function(stencil){return stencils.indexOf(stencil);});if(sortByGroup){result=result.sortBy(function(stencil){return stencil.groups().first();});}
var edges=stencils.findAll(function(stencil){return stencil.type()=="edge";});result=result.concat(edges);return result;}else{if(sortByGroup){return this._availableStencils.values().sortBy(function(stencil){return stencil.groups().first();});}else{return this._availableStencils.values();}}},nodes:function(){return this._availableStencils.values().findAll(function(stencil){return(stencil.type()==='node')});},edges:function(){return this._availableStencils.values().findAll(function(stencil){return(stencil.type()==='edge')});},stencil:function(id){return this._stencils[id];},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonObject,"title");},description:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonObject,"description");},jsonChannels:function(){return this._jsonObject?this._jsonObject.channels:null;},namespace:function(){return this._jsonObject?this._jsonObject.namespace:null;},jsonRules:function(){return this._jsonObject?this._jsonObject.rules:null;},source:function(){return this._source;},extensions:function(){return this._extensions;},addExtension:function(url){new Ajax.Request(url,{method:'GET',asynchronous:false,onSuccess:(function(transport){this.addExtensionDirectly(transport.responseText);}).bind(this),onFailure:(function(transport){ORYX.Log.debug("Loading stencil set extension file failed. The request returned an error."+transport);}).bind(this),onException:(function(transport){ORYX.Log.debug("Loading stencil set extension file failed. The request returned an error."+transport);}).bind(this)});},addExtensionDirectly:function(str){try{eval("var jsonExtension = "+str);if(!(jsonExtension["extends"].endsWith("#")))
jsonExtension["extends"]+="#";if(jsonExtension["extends"]==this.namespace()){this._extensions[jsonExtension.namespace]=jsonExtension;var defaultPosition=this._stencils.keys().size();if(jsonExtension.stencils){$A(jsonExtension.stencils).each(function(stencil){defaultPosition++;var oStencil=new ORYX.Core.StencilSet.Stencil(stencil,this.namespace(),this._baseUrl,this,undefined,defaultPosition);this._stencils[oStencil.id()]=oStencil;this._availableStencils[oStencil.id()]=oStencil;}.bind(this));}
if(jsonExtension.properties){var stencils=this._stencils.values();stencils.each(function(stencil){var roles=stencil.roles();jsonExtension.properties.each(function(prop){prop.roles.any(function(role){role=jsonExtension["extends"]+role;if(roles.member(role)){prop.properties.each(function(property){stencil.addProperty(property,jsonExtension.namespace);});return true;}
else
return false;})})}.bind(this));}
if(jsonExtension.removeproperties){jsonExtension.removeproperties.each(function(remprop){var stencil=this.stencil(jsonExtension["extends"]+remprop.stencil);if(stencil){remprop.properties.each(function(propId){stencil.removeProperty(propId);});}}.bind(this));}
if(jsonExtension.removestencils){$A(jsonExtension.removestencils).each(function(remstencil){delete this._availableStencils[jsonExtension["extends"]+remstencil];}.bind(this));}}}catch(e){ORYX.Log.debug("StencilSet.addExtension: Something went wrong when initialising the stencil set extension. "+e);}},removeExtension:function(namespace){var jsonExtension=this._extensions[namespace];if(jsonExtension){if(jsonExtension.stencils){$A(jsonExtension.stencils).each(function(stencil){var oStencil=new ORYX.Core.StencilSet.Stencil(stencil,this.namespace(),this._baseUrl,this);delete this._stencils[oStencil.id()];delete this._availableStencils[oStencil.id()];}.bind(this));}
if(jsonExtension.properties){var stencils=this._stencils.values();stencils.each(function(stencil){var roles=stencil.roles();jsonExtension.properties.each(function(prop){prop.roles.any(function(role){role=jsonExtension["extends"]+role;if(roles.member(role)){prop.properties.each(function(property){stencil.removeProperty(property.id);});return true;}
else
return false;})})}.bind(this));}
if(jsonExtension.removeproperties){jsonExtension.removeproperties.each(function(remprop){var stencil=this.stencil(jsonExtension["extends"]+remprop.stencil);if(stencil){var stencilJson=$A(this._jsonObject.stencils).find(function(s){return s.id==stencil.id()});remprop.properties.each(function(propId){var propertyJson=$A(stencilJson.properties).find(function(p){return p.id==propId});stencil.addProperty(propertyJson,this.namespace());}.bind(this));}}.bind(this));}
if(jsonExtension.removestencils){$A(jsonExtension.removestencils).each(function(remstencil){var sId=jsonExtension["extends"]+remstencil;this._availableStencils[sId]=this._stencils[sId];}.bind(this));}}
delete this._extensions[namespace];},__handleStencilset:function(response){try{eval("this._jsonObject ="+response.responseText);}
catch(e){throw"Stenciset corrupt: "+e;}
if(!this._jsonObject){throw"Error evaluating stencilset. It may be corrupt.";}
with(this._jsonObject){if(!namespace||namespace==="")
throw"Namespace definition missing in stencilset.";if(!(stencils instanceof Array))
throw"Stencilset corrupt.";if(!namespace.endsWith("#"))
namespace=namespace+"#";if(!title)
title="";if(!description)
description="";}},_getJSONURL:function(response){this._baseUrl=response.responseText.substring(0,response.responseText.lastIndexOf("/")+1);this._source=response.responseText;new Ajax.Request(response.responseText,{asynchronous:false,method:'get',onSuccess:this._init.bind(this),onFailure:this._cancelInit.bind(this)});},_init:function(response){this.__handleStencilset(response);var pps=new Hash();if(this._jsonObject.propertyPackages){$A(this._jsonObject.propertyPackages).each((function(pp){pps[pp.name]=pp.properties;}).bind(this));}
var defaultPosition=0;$A(this._jsonObject.stencils).each((function(stencil){defaultPosition++;var oStencil=new ORYX.Core.StencilSet.Stencil(stencil,this.namespace(),this._baseUrl,this,pps,defaultPosition);if(oStencil.visible)
{this._stencils[oStencil.id()]=oStencil;this._availableStencils[oStencil.id()]=oStencil;}}).bind(this));},_cancelInit:function(response){this.errornous=true;},toString:function(){return"StencilSet "+this.title()+" ("+this.namespace()+")";}});if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={};}
ORYX.Core.StencilSet._stencilSetsByNamespace=new Hash();ORYX.Core.StencilSet._stencilSetsByUrl=new Hash();ORYX.Core.StencilSet._StencilSetNSByEditorInstance=new Hash();ORYX.Core.StencilSet._rulesByEditorInstance=new Hash();ORYX.Core.StencilSet.stencilSets=function(editorId){var stencilSetNSs=ORYX.Core.StencilSet._StencilSetNSByEditorInstance[editorId];var stencilSets=new Hash();if(stencilSetNSs){stencilSetNSs.each(function(stencilSetNS){var stencilSet=ORYX.Core.StencilSet.stencilSet(stencilSetNS)
stencilSets[stencilSet.namespace()]=stencilSet;});}
return stencilSets;};ORYX.Core.StencilSet.stencilSet=function(namespace){ORYX.Log.trace("Getting stencil set %0",namespace);var splitted=namespace.split("#",1);if(splitted.length===1){ORYX.Log.trace("Getting stencil set %0",splitted[0]);return ORYX.Core.StencilSet._stencilSetsByNamespace[splitted[0]+"#"];}else{return undefined;}};ORYX.Core.StencilSet.stencil=function(id){ORYX.Log.trace("Getting stencil for %0",id);var ss=ORYX.Core.StencilSet.stencilSet(id);if(ss){return ss.stencil(id);}else{ORYX.Log.trace("Cannot fild stencil for %0",id);return undefined;}};ORYX.Core.StencilSet.rules=function(editorId){if(!ORYX.Core.StencilSet._rulesByEditorInstance[editorId]){ORYX.Core.StencilSet._rulesByEditorInstance[editorId]=new ORYX.Core.StencilSet.Rules();;}
return ORYX.Core.StencilSet._rulesByEditorInstance[editorId];};ORYX.Core.StencilSet.loadStencilSet=function(url,editorId){var stencilSet=ORYX.Core.StencilSet._stencilSetsByUrl[url];if(!stencilSet){stencilSet=new ORYX.Core.StencilSet.StencilSet(url);ORYX.Core.StencilSet._stencilSetsByNamespace[stencilSet.namespace()]=stencilSet;ORYX.Core.StencilSet._stencilSetsByUrl[url]=stencilSet;}
var namespace=stencilSet.namespace();if(ORYX.Core.StencilSet._StencilSetNSByEditorInstance[editorId]){ORYX.Core.StencilSet._StencilSetNSByEditorInstance[editorId].push(namespace);}else{ORYX.Core.StencilSet._StencilSetNSByEditorInstance[editorId]=[namespace];}
if(ORYX.Core.StencilSet._rulesByEditorInstance[editorId]){ORYX.Core.StencilSet._rulesByEditorInstance[editorId].initializeRules(stencilSet);}else{var rules=new ORYX.Core.StencilSet.Rules();rules.initializeRules(stencilSet);ORYX.Core.StencilSet._rulesByEditorInstance[editorId]=rules;}};ORYX.Core.StencilSet.getTranslation=function(jsonObject,name){var lang=ORYX.I18N.Language.toLowerCase();var result=jsonObject[name+"_"+lang];if(result)
return result;result=jsonObject[name+"_"+lang.substr(0,2)];if(result)
return result;return jsonObject[name];};if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
ORYX.Core.Command=Clazz.extend({construct:function(){},execute:function(){throw"Command.execute() has to be implemented!"},rollback:function(){throw"Command.rollback() has to be implemented!"}});if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
ORYX.Core.Bounds={construct:function(){this._changedCallbacks=[];this.a={};this.b={};this.set.apply(this,arguments);this.suspendChange=false;this.changedWhileSuspend=false;},_changed:function(sizeChanged){if(!this.suspendChange){this._changedCallbacks.each(function(callback){callback(this,sizeChanged);}.bind(this));this.changedWhileSuspend=false;}else
this.changedWhileSuspend=true;},registerCallback:function(callback){if(!this._changedCallbacks.member(callback)){this._changedCallbacks.push(callback);}},unregisterCallback:function(callback){this._changedCallbacks=this._changedCallbacks.without(callback);},set:function(){var changed=false;switch(arguments.length){case 1:if(this.a.x!==arguments[0].a.x){changed=true;this.a.x=arguments[0].a.x;}
if(this.a.y!==arguments[0].a.y){changed=true;this.a.y=arguments[0].a.y;}
if(this.b.x!==arguments[0].b.x){changed=true;this.b.x=arguments[0].b.x;}
if(this.b.y!==arguments[0].b.y){changed=true;this.b.y=arguments[0].b.y;}
break;case 2:var ax=Math.min(arguments[0].x,arguments[1].x);var ay=Math.min(arguments[0].y,arguments[1].y);var bx=Math.max(arguments[0].x,arguments[1].x);var by=Math.max(arguments[0].y,arguments[1].y);if(this.a.x!==ax){changed=true;this.a.x=ax;}
if(this.a.y!==ay){changed=true;this.a.y=ay;}
if(this.b.x!==bx){changed=true;this.b.x=bx;}
if(this.b.y!==by){changed=true;this.b.y=by;}
break;case 4:var ax=Math.min(arguments[0],arguments[2]);var ay=Math.min(arguments[1],arguments[3]);var bx=Math.max(arguments[0],arguments[2]);var by=Math.max(arguments[1],arguments[3]);if(this.a.x!==ax){changed=true;this.a.x=ax;}
if(this.a.y!==ay){changed=true;this.a.y=ay;}
if(this.b.x!==bx){changed=true;this.b.x=bx;}
if(this.b.y!==by){changed=true;this.b.y=by;}
break;}
if(changed){this._changed(true);}},moveTo:function(){var currentPosition=this.upperLeft();switch(arguments.length){case 1:this.moveBy({x:arguments[0].x-currentPosition.x,y:arguments[0].y-currentPosition.y});break;case 2:this.moveBy({x:arguments[0]-currentPosition.x,y:arguments[1]-currentPosition.y});break;default:}},moveBy:function(){var changed=false;switch(arguments.length){case 1:var p=arguments[0];if(p.x!==0||p.y!==0){changed=true;this.a.x+=p.x;this.b.x+=p.x;this.a.y+=p.y;this.b.y+=p.y;}
break;case 2:var x=arguments[0];var y=arguments[1];if(x!==0||y!==0){changed=true;this.a.x+=x;this.b.x+=x;this.a.y+=y;this.b.y+=y;}
break;default:}
if(changed){this._changed();}},include:function(b){if((this.a.x===undefined)&&(this.a.y===undefined)&&(this.b.x===undefined)&&(this.b.y===undefined)){return b;};var cx=Math.min(this.a.x,b.a.x);var cy=Math.min(this.a.y,b.a.y);var dx=Math.max(this.b.x,b.b.x);var dy=Math.max(this.b.y,b.b.y);this.set(cx,cy,dx,dy);},extend:function(p){if(p.x!==0||p.y!==0){this.b.x+=p.x;this.b.y+=p.y;this._changed(true);}},widen:function(x){if(x!==0){this.suspendChange=true;this.moveBy({x:-x,y:-x});this.extend({x:2*x,y:2*x});this.suspendChange=false;if(this.changedWhileSuspend){this._changed(true);}}},upperLeft:function(){return{x:this.a.x,y:this.a.y};},lowerRight:function(){return{x:this.b.x,y:this.b.y};},width:function(){return this.b.x-this.a.x;},height:function(){return this.b.y-this.a.y;},center:function(){return{x:(this.a.x+this.b.x)/2.0,y:(this.a.y+this.b.y)/2.0};},midPoint:function(){return{x:(this.b.x-this.a.x)/2.0,y:(this.b.y-this.a.y)/2.0};},centerMoveTo:function(){var currentPosition=this.center();switch(arguments.length){case 1:this.moveBy(arguments[0].x-currentPosition.x,arguments[0].y-currentPosition.y);break;case 2:this.moveBy(arguments[0]-currentPosition.x,arguments[1]-currentPosition.y);break;}},isIncluded:function(point,offset){var pointX,pointY,offset;switch(arguments.length){case 1:pointX=arguments[0].x;pointY=arguments[0].y;offset=0;break;case 2:if(arguments[0].x&&arguments[0].y){pointX=arguments[0].x;pointY=arguments[0].y;offset=Math.abs(arguments[1]);}else{pointX=arguments[0];pointY=arguments[1];offset=0;}
break;case 3:pointX=arguments[0];pointY=arguments[1];offset=Math.abs(arguments[2]);break;default:throw"isIncluded needs one, two or three arguments";}
var ul=this.upperLeft();var lr=this.lowerRight();if(pointX>=ul.x-offset&&pointX<=lr.x+offset&&pointY>=ul.y-offset&&pointY<=lr.y+offset)
return true;else
return false;},isBoundsContained:function(bounds){if(!(bounds instanceof ORYX.Core.Bounds))
return false;if(this.a.x>bounds.a.x||this.a.y>bounds.a.y)
return false;if(this.b.x<bounds.b.x||this.b.y<bounds.b.y)
return false;return true;},clone:function(){return new ORYX.Core.Bounds(this);},toString:function(){return"( "+this.a.x+" | "+this.a.y+" )/( "+this.b.x+" | "+this.b.y+" )";},serializeForERDF:function(){return this.a.x+","+this.a.y+","+this.b.x+","+this.b.y;}};ORYX.Core.Bounds=Clazz.extend(ORYX.Core.Bounds);if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
ORYX.Core.UIObject={construct:function(options){this.isChanged=true;this.isResized=true;this.isVisible=true;this.isSelectable=false;this.isResizable=false;this.isMovable=false;this.id=ORYX.Editor.provideId();this.parent=undefined;this.node=undefined;this.children=[];this.bounds=new ORYX.Core.Bounds();this._changedCallback=this._changed.bind(this);this.bounds.registerCallback(this._changedCallback);if(options&&options.eventHandlerCallback){this.eventHandlerCallback=options.eventHandlerCallback;}},_changed:function(bounds,isResized){this.isChanged=true;if(this.bounds==bounds)
this.isResized=isResized||this.isResized;},update:function(){if(this.isChanged){this.refresh();this.isChanged=false;this.children.each(function(value){value.update();});}},refresh:function(){},getChildren:function(){return this.children.clone();},getParents:function(){var parents=[];var parent=this.parent;while(parent){parents.push(parent);parent=parent.parent;}
return parents;},isParent:function(parent){var cparent=this;while(cparent){if(cparent===parent){return true;}
cparent=cparent.parent;}
return false;},getId:function(){return this.id;},getChildById:function(id,deep){return this.children.find(function(uiObj){if(uiObj.getId()===id){return uiObj;}else{if(deep){var obj=uiObj.getChildById(id,deep);if(obj){return obj;}}}});},add:function(uiObject){if(!(this.children.member(uiObject))){if(uiObject.parent){uiObject.remove(uiObject);}
this.children.push(uiObject);uiObject.parent=this;uiObject.node=this.node.appendChild(uiObject.node);uiObject.bounds.registerCallback(this._changedCallback);if(this.eventHandlerCallback)
this.eventHandlerCallback({type:ORYX.CONFIG.EVENT_SHAPEADDED,shape:uiObject})}else{ORYX.Log.info("add: ORYX.Core.UIObject is already a child of this object.");}},remove:function(uiObject){if(this.children.member(uiObject)){this.children=this._uiObjects.without(uiObject);uiObject.parent=undefined;uiObject.node=this.node.removeChild(uiObject.node);uiObject.bounds.unregisterCallback(this._changedCallback);}else{ORYX.Log.info("remove: ORYX.Core.UIObject is not a child of this object.");}},absoluteBounds:function(){if(this.parent){var absUL=this.absoluteXY();return new ORYX.Core.Bounds(absUL.x,absUL.y,absUL.x+this.bounds.width(),absUL.y+this.bounds.height());}else{return this.bounds.clone();}},absoluteXY:function(){if(this.parent){var pXY=this.parent.absoluteXY();return{x:pXY.x+this.bounds.upperLeft().x,y:pXY.y+this.bounds.upperLeft().y};}else{return{x:this.bounds.upperLeft().x,y:this.bounds.upperLeft().y};}},absoluteCenterXY:function(){if(this.parent){var pXY=this.parent.absoluteXY();return{x:pXY.x+this.bounds.center().x,y:pXY.y+this.bounds.center().y};}else{return{x:this.bounds.center().x,y:this.bounds.center().y};}},hide:function(){this.node.setAttributeNS(null,'display','none');this.isVisible=false;this.children.each(function(uiObj){uiObj.hide();});},show:function(){this.node.setAttributeNS(null,'display','inherit');this.isVisible=true;this.children.each(function(uiObj){uiObj.show();});},addEventHandlers:function(node){node.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this._delegateEvent.bind(this),false);node.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this._delegateEvent.bind(this),false);node.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this._delegateEvent.bind(this),false);node.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,this._delegateEvent.bind(this),false);node.addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,this._delegateEvent.bind(this),false);node.addEventListener('click',this._delegateEvent.bind(this),false);node.addEventListener(ORYX.CONFIG.EVENT_DBLCLICK,this._delegateEvent.bind(this),false);},_delegateEvent:function(event){if(this.eventHandlerCallback){this.eventHandlerCallback(event,this);}},toString:function(){return"UIObject "+this.id}};ORYX.Core.UIObject=Clazz.extend(ORYX.Core.UIObject);if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
ORYX.Core.AbstractShape=ORYX.Core.UIObject.extend({construct:function(options,stencil){arguments.callee.$.construct.apply(this,arguments);this.resourceId=ORYX.Editor.provideId();this._stencil=stencil;if(this._stencil._jsonStencil.superId){stencilId=this._stencil.id()
superStencilId=stencilId.substring(0,stencilId.indexOf("#")+1)+stencil._jsonStencil.superId;stencilSet=this._stencil.stencilSet();this._stencil=stencilSet.stencil(superStencilId);}
this.properties=new Hash();this.propertiesChanged=new Hash();this.channelsBasedPropetyValues=new Hash();this.hiddenProperties=new Hash();this._stencil.properties().each((function(property){var key=property.prefix()+"-"+property.id();var val=property.value();if(property.id()==="overrideid"){val=this._stencil.idWithoutNs()+this.resourceId.substring(4);val=val.replace(/\s+/g,"_");}else if(property.id()=="name"&&this._stencil.isUUIDRequiredForStencil()){val+=this.resourceId.substring(4);}
if(property._jsonProp.hierarchy!==undefined&&this._stencil.isUUIDRequiredForStencil())
{var channels=property._valuesByChannel.keys();channels.each(function(channel){this.properties[key]=property._valuesByChannel[channel];this.setChannelsBasedPropetyValues(key,channel,property._valuesByChannel[channel]);this.propertiesChanged[key]=true;}.bind(this));}
else
{this.properties[key]=val;this.propertiesChanged[key]=true;}}).bind(this));if(stencil._jsonStencil.superId){stencil.properties().each((function(property){var key=property.prefix()+"-"+property.id();var value=property.value();var oldValue=this.properties[key];this.properties[key]=value;this.propertiesChanged[key]=true;this._delegateEvent({type:ORYX.CONFIG.EVENT_PROPERTY_CHANGED,name:key,value:value,oldValue:oldValue});}).bind(this));}},layout:function(){},getStencil:function(){return this._stencil;},getChildShapeByResourceId:function(resourceId){resourceId=ERDF.__stripHashes(resourceId);return this.getChildShapes(true).find(function(shape){return shape.resourceId==resourceId});},getChildShapes:function(deep,iterator){var result=[];this.children.each(function(uiObject){if(uiObject instanceof ORYX.Core.Shape&&uiObject.isVisible){if(iterator){iterator(uiObject);}
result.push(uiObject);if(deep){result=result.concat(uiObject.getChildShapes(deep,iterator));}}});return result;},hasChildShape:function(shape){return this.getChildShapes().any(function(child){return(child===shape)||child.hasChildShape(shape);});},getChildNodes:function(deep,iterator){var result=[];this.children.each(function(uiObject){if(uiObject instanceof ORYX.Core.Node&&uiObject.isVisible){if(iterator){iterator(uiObject);}
result.push(uiObject);}
if(uiObject instanceof ORYX.Core.Shape){if(deep){result=result.concat(uiObject.getChildNodes(deep,iterator));}}});return result;},getChildEdges:function(deep,iterator){var result=[];this.children.each(function(uiObject){if(uiObject instanceof ORYX.Core.Edge&&uiObject.isVisible){if(iterator){iterator(uiObject);}
result.push(uiObject);}
if(uiObject instanceof ORYX.Core.Shape){if(deep){result=result.concat(uiObject.getChildEdges(deep,iterator));}}});return result;},getAbstractShapesAtPosition:function(){var x,y;switch(arguments.length){case 1:x=arguments[0].x;y=arguments[0].y;break;case 2:x=arguments[0];y=arguments[1];break;default:throw"getAbstractShapesAtPosition needs 1 or 2 arguments!"}
if(this.isPointIncluded(x,y)){var result=[];result.push(this);var childNodes=this.getChildNodes();var childEdges=this.getChildEdges();[childNodes,childEdges].each(function(ne){var nodesAtPosition=new Hash();ne.each(function(node){if(!node.isVisible){return}
var candidates=node.getAbstractShapesAtPosition(x,y);if(candidates.length>0){var nodesInZOrder=$A(node.node.parentNode.childNodes);var zOrderIndex=nodesInZOrder.indexOf(node.node);nodesAtPosition[zOrderIndex]=candidates;}});nodesAtPosition.keys().sort().each(function(key){result=result.concat(nodesAtPosition[key]);});});return result;}else{return[];}},setProperty:function(key,value,force){var oldValue=this.properties[key];if(oldValue!==value||force===true){this.properties[key]=value;this.propertiesChanged[key]=true;this._changed();if(!this._isInSetProperty){this._isInSetProperty=true;this._delegateEvent({type:ORYX.CONFIG.EVENT_PROPERTY_CHANGED,elements:[this],name:key,value:value,oldValue:oldValue});delete this._isInSetProperty;}}},setPropertyByType:function(key,type,value,force){var propertyObj=(this.properties[key].length)?JSON.parse(this.properties[key]):{};if(!propertyObj.hasOwnProperty(type)){propertyObj[type]=null;}
var oldValue=propertyObj[type];var newValue=JSON.stringify(value);if(oldValue!==newValue||force===true){propertyObj[type]=value;this.properties[key]=JSON.stringify(propertyObj);this.propertiesChanged[key]=true;this._changed();if(!this._isInSetProperty){this._isInSetProperty=true;this._delegateEvent({type:ORYX.CONFIG.EVENT_PROPERTY_CHANGED,elements:[this],name:key,value:this.properties[key],oldValue:oldValue});delete this._isInSetProperty;}}},decodeChannelsBasedPropetyValues:function(key){if(typeof this.channelsBasedPropetyValues[key]!="object")
this.channelsBasedPropetyValues[key]=Ext.decode(this.channelsBasedPropetyValues[key]);},setChannelsBasedPropetyValues:function(key,channel,value,force){if(value!==""){if(!this.channelsBasedPropetyValues.hasOwnProperty(key)){this.channelsBasedPropetyValues[key]=new Hash();}else{this.decodeChannelsBasedPropetyValues(key);}
this.channelsBasedPropetyValues[key][channel]=value;}},setHiddenProperty:function(key,value){if(value===undefined){delete this.hiddenProperties[key];return;}
var oldValue=this.hiddenProperties[key];if(oldValue!==value){this.hiddenProperties[key]=value;}},isPointIncluded:function(pointX,pointY,absoluteBounds){var absBounds=absoluteBounds?absoluteBounds:this.absoluteBounds();return absBounds.isIncluded(pointX,pointY);},serialize:function(){var serializedObject=[];serializedObject.push({name:'type',prefix:'oryx',value:this.getStencil().id(),type:'literal'});this.hiddenProperties.each(function(prop){serializedObject.push({name:prop.key.replace("oryx-",""),prefix:"oryx",value:prop.value,type:'literal'});}.bind(this));this.getStencil().properties().each((function(property){var prefix=property.prefix();var name=property.id();serializedObject.push({name:name,prefix:prefix,value:this.properties[prefix+'-'+name],type:'literal'});}).bind(this));return serializedObject;},deserialize:function(serialize){var initializedDocker=0;serialize=serialize.sort(function(a,b){return Number(this.properties.keys().member(a.prefix+"-"+a.name))>Number(this.properties.keys().member(b.prefix+"-"+b.name))?-1:0}.bind(this));serialize.each((function(obj){var name=obj.name;var prefix=obj.prefix;var value=obj.value;if(Ext.type(value)==="object")value=Ext.encode(value);switch(prefix+"-"+name){case'raziel-parent':if(!this.parent){break};var parent=this.getCanvas().getChildShapeByResourceId(value);if(parent){parent.add(this);}
break;default:if(this.properties.keys().member(prefix+"-"+name)){this.setProperty(prefix+"-"+name,value);}else if(/^level\d$/.test(name)){this.setProperty(prefix+"-"+name,value);}else if(!(name==="bounds"||name==="parent"||name==="target"||name==="dockers"||name==="docker"||name==="outgoing"||name==="incoming")){this.setHiddenProperty(prefix+"-"+name,value);}}}).bind(this));},toString:function(){return"ORYX.Core.AbstractShape "+this.id},toJSON:function(){var json={resourceId:this.resourceId,properties:Ext.apply({},this.properties,this.hiddenProperties).inject({},function(props,prop){var key=prop[0];var value=prop[1];if(this.getStencil().property(key)&&this.getStencil().property(key).type()===ORYX.CONFIG.TYPE_COMPLEX&&Ext.type(value)==="string"){try{value=Ext.decode(value);}catch(error){}}
if(this.channelsBasedPropetyValues.hasOwnProperty(key)){this.decodeChannelsBasedPropetyValues(key);value=this.channelsBasedPropetyValues[key];}
key=key.replace(/^[\w_]+-/,"");props[key]=value;return props;}.bind(this)),stencil:{id:this.getStencil().idWithoutNs()},childShapes:this.getChildShapes().map(function(shape){return shape.toJSON()})};if(this.getOutgoingShapes){json.outgoing=this.getOutgoingShapes().map(function(shape){return{resourceId:shape.resourceId};});}
if(this.bounds){json.bounds={lowerRight:this.bounds.lowerRight(),upperLeft:this.bounds.upperLeft()};}
if(this.dockers){json.dockers=this.dockers.map(function(docker){var d=docker.getDockedShape()&&docker.referencePoint?docker.referencePoint:docker.bounds.center();d.getDocker=function(){return docker;};return d;})}
Ext.apply(json,ORYX.Core.AbstractShape.JSONHelper);json.getShape=function(){return this;}.bind(this);return json;}});ORYX.Core.AbstractShape.JSONHelper={eachChild:function(iterator,deep,modify){if(!this.childShapes)return;var newChildShapes=[];this.childShapes.each(function(shape){var res=iterator(shape,this);if(res)newChildShapes.push(res);if(deep)shape.eachChild(iterator,deep,modify);}.bind(this));if(modify)this.childShapes=newChildShapes;},getChildShapes:function(deep){var allShapes=this.childShapes;if(deep){this.eachChild(function(shape){allShapes=allShapes.concat(shape.getChildShapes(deep));},true);}
return allShapes;},serialize:function(){return Ext.encode(this);}}
if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
ORYX.Core.Canvas=ORYX.Core.AbstractShape.extend({zoomLevel:1,construct:function(options){arguments.callee.$.construct.apply(this,arguments);if(!(options&&options.width&&options.height)){ORYX.Log.fatal("Canvas is missing mandatory parameters options.width and options.height.");return;}
this.resourceId=options.id;this.nodes=[];this.edges=[];this.rootNode=ORYX.Editor.graft("http://www.w3.org/2000/svg",options.parentNode,['svg',{id:this.id,width:options.width,height:options.height,display:"inline"},['defs',{}]]);this.rootNode.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");this.rootNode.setAttribute("xmlns:svg","http://www.w3.org/2000/svg");this._htmlContainer=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",options.parentNode,['div',{id:"oryx_canvas_htmlContainer",style:"position:absolute; top:0px"}]);this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.rootNode,['g',{},['g',{"class":"stencils"},['g',{"class":"me"}],['g',{"class":"children"}],['g',{"class":"edge"}]],['g',{"class":"svgcontainer"}]]);this.node.setAttributeNS(null,'stroke','black');this.node.setAttributeNS(null,'font-family','Verdana, sans-serif');this.node.setAttributeNS(null,'font-size-adjust','none');this.node.setAttributeNS(null,'font-style','normal');this.node.setAttributeNS(null,'font-variant','normal');this.node.setAttributeNS(null,'font-weight','normal');this.node.setAttributeNS(null,'line-heigth','normal');this.node.setAttributeNS(null,'font-size',ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT);this.bounds.set(0,0,options.width,options.height);this.addEventHandlers(this.rootNode.parentNode);this.rootNode.oncontextmenu=function(){return false;};},focus:function(){if(!this.headerA){this.headerA=Ext.get("oryx_editor_header").child("a").dom}
this.headerA.focus();this.headerA.blur();},update:function(){this.nodes.each(function(node){this._traverseForUpdate(node);}.bind(this));var layoutEvents=this.getStencil().layout();if(layoutEvents){layoutEvents.each(function(event){event.shape=this;event.forceExecution=true;event.target=this.rootNode;this._delegateEvent(event);}.bind(this));}
this.nodes.invoke("_update");this.edges.invoke("_update",true);},_traverseForUpdate:function(shape){var childRet=shape.isChanged;shape.getChildNodes(false,function(child){if(this._traverseForUpdate(child)){childRet=true;}}.bind(this));if(childRet){shape.layout();return true;}else{return false;}},layout:function(){},getChildNodes:function(deep,iterator){if(!deep&&!iterator){return this.nodes.clone();}else{var result=[];this.nodes.each(function(uiObject){if(iterator){iterator(uiObject);}
result.push(uiObject);if(deep&&uiObject instanceof ORYX.Core.Shape){result=result.concat(uiObject.getChildNodes(deep,iterator));}});return result;}},add:function(uiObject){if(uiObject instanceof ORYX.Core.UIObject){if(!(this.children.member(uiObject))){if(uiObject.parent){uiObject.parent.remove(uiObject);}
this.children.push(uiObject);uiObject.parent=this;if(uiObject instanceof ORYX.Core.Shape){if(uiObject instanceof ORYX.Core.Edge){uiObject.addMarkers(this.rootNode.getElementsByTagNameNS(NAMESPACE_SVG,"defs")[0]);uiObject.node=this.node.childNodes[0].childNodes[2].appendChild(uiObject.node);this.edges.push(uiObject);}else{uiObject.node=this.node.childNodes[0].childNodes[1].appendChild(uiObject.node);this.nodes.push(uiObject);}}else{uiObject.node=this.node.appendChild(uiObject.node);}
uiObject.bounds.registerCallback(this._changedCallback);if(this.eventHandlerCallback)
this.eventHandlerCallback({type:ORYX.CONFIG.EVENT_SHAPEADDED,shape:uiObject})}else{ORYX.Log.warn("add: ORYX.Core.UIObject is already a child of this object.");}}else{ORYX.Log.fatal("add: Parameter is not of type ORYX.Core.UIObject.");}},remove:function(uiObject){if(this.children.member(uiObject)){this.children=this.children.without(uiObject);uiObject.parent=undefined;if(uiObject instanceof ORYX.Core.Shape){if(uiObject instanceof ORYX.Core.Edge){uiObject.removeMarkers();uiObject.node=this.node.childNodes[0].childNodes[2].removeChild(uiObject.node);this.edges=this.edges.without(uiObject);}else{uiObject.node=this.node.childNodes[0].childNodes[1].removeChild(uiObject.node);this.nodes=this.nodes.without(uiObject);}}else{uiObject.node=this.node.removeChild(uiObject.node);}
uiObject.bounds.unregisterCallback(this._changedCallback);}else{ORYX.Log.warn("remove: ORYX.Core.UIObject is not a child of this object.");}},addShapeObjects:function(shapeObjects,eventHandler){if(!shapeObjects)return;var addShape=function(shape,parent){try{var stencil=ORYX.Core.StencilSet.stencil(this.getStencil().namespace()+shape.stencil.id);var ShapeClass=(stencil.type()=="node")?ORYX.Core.Node:ORYX.Core.Edge;var newShape=new ShapeClass({'eventHandlerCallback':eventHandler},stencil);newShape.resourceId=shape.resourceId;shape.parent="#"+((shape.parent&&shape.parent.resourceId)||parent.resourceId);this.add(newShape);return{json:shape,object:newShape};}catch(e){ORYX.Log.warn("LoadingContent: Stencil could not create.");}}.bind(this);var addChildShapesRecursively=function(shape){var addedShapes=[];shape.childShapes.each(function(childShape){var xy=addShape(childShape,shape);if(!(typeof xy==="undefined")){addedShapes.push(xy);}
addedShapes=addedShapes.concat(addChildShapesRecursively(childShape));});return addedShapes;}.bind(this);var shapes=addChildShapesRecursively({childShapes:shapeObjects,resourceId:this.resourceId});shapes.each(function(shape){var properties=[];for(field in shape.json.properties){properties.push({prefix:'oryx',name:field,value:shape.json.properties[field]});}
shape.json.outgoing.each(function(out){properties.push({prefix:'raziel',name:'outgoing',value:"#"+out.resourceId});});if(shape.object instanceof ORYX.Core.Edge){var target=shape.json.target||shape.json.outgoing[0];if(target){properties.push({prefix:'raziel',name:'target',value:"#"+target.resourceId});}}
if(shape.json.bounds){properties.push({prefix:'oryx',name:'bounds',value:shape.json.bounds.upperLeft.x+","+shape.json.bounds.upperLeft.y+","+shape.json.bounds.lowerRight.x+","+shape.json.bounds.lowerRight.y});}
if(shape.json.dockers){properties.push({prefix:'oryx',name:'dockers',value:shape.json.dockers.inject("",function(dockersStr,docker){return dockersStr+docker.x+" "+docker.y+" ";})+" #"});}
properties.push({prefix:'raziel',name:'parent',value:shape.json.parent});shape.__properties=properties;}.bind(this));shapes.each(function(shape){if(shape.object instanceof ORYX.Core.Node){shape.object.deserialize(shape.__properties);}});shapes.each(function(shape){if(shape.object instanceof ORYX.Core.Edge){shape.object.deserialize(shape.__properties);}});if(/stencilset\/motivepof3\.0#$/.test(this.getStencil().namespace())){ORYX.Plugins.ShapeRepository.disableTreeNodeByShape(this.nodes);}
return shapes.pluck("object");},updateSize:function(){var maxWidth=0;var maxHeight=0;var offset=100;this.getChildShapes(true,function(shape){var b=shape.bounds;maxWidth=Math.max(maxWidth,b.lowerRight().x+offset)
maxHeight=Math.max(maxHeight,b.lowerRight().y+offset)});if(this.bounds.width()<maxWidth||this.bounds.height()<maxHeight){this.setSize({width:Math.max(this.bounds.width(),maxWidth),height:Math.max(this.bounds.height(),maxHeight)})}},getShape:function(id){var nodeCount=this.nodes.length;for(var x=0;x<nodeCount;x++){if(this.nodes[x].resourceId===id)
return this.nodes[x];}
var edgeCount=this.edges.length;for(var x=0;x<edgeCount;x++){if(this.edges[x].resourceId===id)
return this.edges[x];}
return null;},getRootNode:function(){return this.rootNode;},getSvgContainer:function(){return this.node.childNodes[1];},getHTMLContainer:function(){return this._htmlContainer;},getShapesWithSharedParent:function(elements){if(!elements||elements.length<1){return[]}
if(elements.length==1){return elements}
return elements.findAll(function(value){var parentShape=value.parent;while(parentShape){if(elements.member(parentShape))return false;parentShape=parentShape.parent}
return true;});},setSize:function(size,dontSetBounds){if(!size||!size.width||!size.height){return}
if(this.rootNode.parentNode){this.rootNode.parentNode.style.width=size.width+'px';this.rootNode.parentNode.style.height=size.height+'px';}
this.rootNode.setAttributeNS(null,'width',size.width);this.rootNode.setAttributeNS(null,'height',size.height);if(!dontSetBounds){this.bounds.set({a:{x:0,y:0},b:{x:size.width/this.zoomLevel,y:size.height/this.zoomLevel}})}
var rootNode=this.rootNode;this.rootNode.style.display="none";window.setTimeout(function(){rootNode.style.display="inline";},10);},getSVGRepresentation:function(escapeText){var svgClone=this.getRootNode().cloneNode(true);this._removeInvisibleElements(svgClone);var x1,y1,x2,y2;try{var bb=this.getRootNode().childNodes[1].getBBox();x1=bb.x;y1=bb.y;x2=bb.x+bb.width;y2=bb.y+bb.height;}catch(e){this.getChildShapes(true).each(function(shape){var absBounds=shape.absoluteBounds();var ul=absBounds.upperLeft();var lr=absBounds.lowerRight();if(x1==undefined){x1=ul.x;y1=ul.y;x2=lr.x;y2=lr.y;}else{x1=Math.min(x1,ul.x);y1=Math.min(y1,ul.y);x2=Math.max(x2,lr.x);y2=Math.max(y2,lr.y);}});}
var margin=50;var width,height,tx,ty;if(x1==undefined){width=0;height=0;tx=0;ty=0;}else{width=x2-x1;height=y2-y1;tx=-x1+margin/2;ty=-y1+margin/2;}
svgClone.setAttributeNS(null,'width',width+margin);svgClone.setAttributeNS(null,'height',height+margin);svgClone.childNodes[1].firstChild.setAttributeNS(null,'transform','translate('+tx+", "+ty+')');svgClone.childNodes[1].removeAttributeNS(null,'transform');try{var svgCont=svgClone.childNodes[1].childNodes[1];svgCont.parentNode.removeChild(svgCont);}catch(e){}
if(escapeText){$A(svgClone.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,'tspan')).each(function(elem){elem.textContent=elem.textContent.escapeHTML();});$A(svgClone.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,'text')).each(function(elem){if(elem.childNodes.length==0)
elem.textContent=elem.textContent.escapeHTML();});}
$A(svgClone.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,'a')).each(function(elem){elem.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",(elem.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").escapeHTML());});return svgClone;},_removeInvisibleElements:function(element){var index=0;while(index<element.childNodes.length){var child=element.childNodes[index];if(child.getAttributeNS&&child.getAttributeNS(null,"visibility")==="hidden"){element.removeChild(child);}else{this._removeInvisibleElements(child);index++;}}},_delegateEvent:function(event){if(this.eventHandlerCallback&&(event.target==this.rootNode||event.target==this.rootNode.parentNode)){this.eventHandlerCallback(event,this);}},toString:function(){return"Canvas "+this.id},toJSON:function(){var json=arguments.callee.$.toJSON.apply(this,arguments);json.stencilset={url:this.getStencil().stencilSet().source(),namespace:this.getStencil().stencilSet().namespace()};return json;}});var idCounter=0;var ID_PREFIX="resource";var top_editor=null;function init(){Ext.BLANK_IMAGE_URL=ORYX.PATH+'ext-2.0.2/resources/images/default/s.gif';ORYX.Log.debug("Querying editor instances");ORYX.Editor.setMissingClasses();if(window.onOryxResourcesLoaded){ORYX.Log.debug("main.js - onOryxResourcesLoaded");window.onOryxResourcesLoaded();}
else if(window.location.pathname.include(ORYX.CONFIG.ORYX_NEW_URL)){var stencilsetUrl=ORYX.Utils.getParamFromUrl("stencilset");if(stencilsetUrl.indexOf("/")==0){stencilsetUrl=stencilsetUrl.substring(1,stencilsetUrl.length);}
ORYX.Log.debug("main.js - New model. stencilsetUrl = "+stencilsetUrl);top_editor=new ORYX.Editor({id:'oryx-canvas123',fullscreen:true,stencilset:{url:ORYX.PATH+stencilsetUrl}});}
else{var modelUrl=window.location.href.replace(/#.*/g,"");if(modelUrl.endsWith("/self")){modelUrl=modelUrl.replace("/self","/json");}else{modelUrl+="&data";}
ORYX.Log.debug("main.js - fetch model from server. modelUrl = "+modelUrl);top_editor=ORYX.Editor.createByUrl(modelUrl,{id:modelUrl});}}
if(!ORYX){var ORYX={};}
ORYX.Editor={DOMEventListeners:new Hash(),selection:[],zoomLevel:1.0,autoSave:false,origContentVersion:"-1",changeDifference:0,construct:function(config){this._eventsQueue=[];this.loadedPlugins=[];this.pluginsData=[];this.propertyWindow=null;this.activityOrder=(config.properties&&config.properties.activityOrder)?config.properties.activityOrder:[];this.pofParams=config.pofParams?config.pofParams:null;this.activityImplMetaData=config.activityImplMetaData?config.activityImplMetaData:null;this.modelMetaData=config;var model=config;if(config.model){model=config.model;}
if(!model.flowViews){model.flowViews=[];}
this._currentFlowView=-1;this._currentLocale={displayName:'Default',languagecode:'!!',isDefault:true};this._localeConfig=Ext.util.JSON.decode(window.opener.RepositoryCore._localeConfig);this._localeConfig.push(this._currentLocale);this.id=model.resourceId;if(!this.id){this.id=model.id;if(!this.id){this.id=ORYX.Editor.provideId();}}
this.fullscreen=model.fullscreen||true;this._initEventListener();if(ORYX.CONFIG.BACKEND_SWITCH){var ssUrl=(model.stencilset.namespace||model.stencilset.url).replace("#","%23");ORYX.Core.StencilSet.loadStencilSet(ORYX.CONFIG.STENCILSET_HANDLER+ssUrl,this.id);}else{var ssUrl=model.stencilset.url;ORYX.Core.StencilSet.loadStencilSet(ssUrl,this.id);}
this._loadStencilSetExtensionConfig();if(!!ORYX.CONFIG.SSEXTS){ORYX.CONFIG.SSEXTS.each(function(ssext){this.loadSSExtension(ssext.namespace);}.bind(this));}
this._createCanvas(model.stencil?model.stencil.id:null,model.properties);this._generateGUI();var loadPluginFinished=false;var loadContentFinished=false;var initFinished=function(){if(!loadPluginFinished||!loadContentFinished){return}
this._finishedLoading();}.bind(this)
ORYX.Editor.makeExtModalWindowKeysave(this._getPluginFacade());window.setTimeout(function(){this.loadPlugins();loadPluginFinished=true;initFinished();}.bind(this),100);window.setTimeout(function(){this._topfloweditor.setFlowDefinition(this.modelMetaData);loadContentFinished=true;initFinished();}.bind(this),200);},_finishedLoading:function(){this.setAutoSave(ORYX.RepositoryHelper.modelMeta&&ORYX.RepositoryHelper.modelMeta.autosave);if(Ext.getCmp('oryx-loading-panel')){Ext.getCmp('oryx-loading-panel').hide()}
this.layout.doLayout();new Ext.dd.DropTarget(this.getCanvas().rootNode.parentNode);if(ORYX.CONFIG.PANEL_RIGHT_COLLAPSED===true){this.layout_regions.east.collapse();}
if(ORYX.CONFIG.PANEL_LEFT_COLLAPSED===true){this.layout_regions.west.collapse();}
this.handleEvents({type:ORYX.CONFIG.EVENT_LOADED})
if(ORYX.kmpNewVersionExists===true){Ext.Msg.alert(Repository.I18N.Repository.newKmpVersionTitle,Repository.I18N.Repository.newKmpVersionMsg);}},_initEventListener:function(){document.documentElement.addEventListener(ORYX.CONFIG.EVENT_KEYDOWN,this.catchKeyDownEvents.bind(this),true);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_KEYUP,this.catchKeyUpEvents.bind(this),true);this._keydownEnabled=true;this._keyupEnabled=true;this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEDOWN]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEUP]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEOVER]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEOUT]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_SELECTION_CHANGED]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEMOVE]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_UNDO_EXECUTE]=[function(){ORYX.Log.trace("ORYX.Editor._initEventListener()::ORYX.CONFIG.EVENT_UNDO_EXECUTE");this.changeDifference++;}.bind(this)];this.DOMEventListeners[ORYX.CONFIG.EVENT_EXECUTE_COMMANDS]=[function(){ORYX.Log.trace("ORYX.Editor._initEventListener()::ORYX.CONFIG.EVENT_EXECUTE_COMMANDS");if(this.changeDifference<0){this.changeDifference=1000;}else{this.changeDifference++;}}.bind(this)];this.DOMEventListeners[ORYX.CONFIG.EVENT_UNDO_ROLLBACK]=[function(){ORYX.Log.trace("ORYX.Editor._initEventListener()::ORYX.CONFIG.EVENT_UNDO_ROLLBACK");this.changeDifference--;}.bind(this)];},_generateGUI:function(){var layoutHeight=400;var canvasParent=this.getCanvas().rootNode.parentNode;this._editorTabPanel=new ORYX.Editor.CanvasTabPanel({id:'x-panel-editor-center-cmp-id',region:'center',cls:'x-panel-editor-center',autoScroll:true,activeTab:0,tabPosition:"bottom"});this._topfloweditor=new ORYX.FlowEditorView(null,"Main",null,this);this._toolTabPanel=new Ext.TabPanel({autoScroll:false});this.layout_regions={north:new Ext.Panel({region:'north',cls:'x-panel-editor-north',autoEl:'div',border:false}),east:new Ext.Panel({id:'x-panel-editor-right-cmp-id',region:'east',layout:'fit',cls:'x-panel-editor-east',autoEl:'div',border:false,cmargins:{left:0,right:0},collapsible:true,collapsed:window.opener.RepositoryCookie.getUserPreference('editorRightPanelCollapsed',false),width:window.opener.RepositoryCookie.getUserPreference('wfEditorRightPanelWidth',ORYX.CONFIG.PANEL_RIGHT_WIDTH||200),split:true,title:"East",listeners:{"collapse":{fn:function(){window.opener.RepositoryCookie.setUserPreference('editorRightPanelCollapsed',true);}},"expand":{fn:function(){window.opener.RepositoryCookie.setUserPreference('editorRightPanelCollapsed',false);}},"resize":{fn:function(){window.opener.RepositoryCookie.setUserPreference('wfEditorRightPanelWidth',this.getSize().width);}}}}),statusBar:new Ext.Panel({region:'south',cls:'x-panel-editor-south',autoEl:'div',border:false,height:28,html:'<table id="x-panel-editor-south-statusbar" width="100%" cellspacing="0" cellpadding="0" border="0"><tr></tr></table>'}),west:new Ext.Panel({region:'west',layout:'anchor',autoEl:'div',cls:'x-panel-editor-west',collapsible:true,collapsed:window.opener.RepositoryCookie.getUserPreference('editorLeftPanelCollapsed',false),width:window.opener.RepositoryCookie.getUserPreference('wfEditorLeftPanelWidth',ORYX.CONFIG.PANEL_LEFT_WIDTH||200),autoScroll:true,cmargins:{left:0,right:0},split:true,title:"West",listeners:{"collapse":{fn:function(){window.opener.RepositoryCookie.setUserPreference('editorLeftPanelCollapsed',true);}},"expand":{fn:function(){window.opener.RepositoryCookie.setUserPreference('editorLeftPanelCollapsed',false);}},"resize":{fn:function(){window.opener.RepositoryCookie.setUserPreference('wfEditorLeftPanelWidth',this.getSize().width);}}}}),center:this._editorTabPanel,southPanel:new Ext.Panel({region:'south',layout:'fit',collapsible:true,collapsed:false,autoScroll:false,cmargins:{left:0,right:0},split:true,minHeight:150,height:150,collapseMode:"mini",floatable:true,items:this._toolTabPanel})}
for(region in this.layout_regions){if(region!="center"){}}
var layout_config={layout:'border',items:[this.layout_regions.north,this.layout_regions.east,this.layout_regions.southPanel,this.layout_regions.west,this.layout_regions.center]}
this.layout=new Ext.Panel(layout_config);this.layout.region="center";var top_view_config={layout:'border',items:[this.layout,this.layout_regions.statusBar]};if(this.fullscreen){this.layout=new Ext.Viewport(top_view_config)}else{layout_config.renderTo=this.id;layout_config.height=layoutHeight;this.layout=new Ext.Panel(top_view_config)}
this._generateHeader();canvasParent.parentNode.setAttributeNS(null,'align','center');canvasParent.setAttributeNS(null,'align','left');this.getCanvas().setSize({width:ORYX.CONFIG.CANVAS_WIDTH,height:ORYX.CONFIG.CANVAS_HEIGHT});},openSouthPanel:function(){if(this.layout_regions.southPanel.collapsed){this.layout_regions.southPanel.toggleCollapse();}},_generateHeader:function(){new Ajax.Request(ORYX.PATH+"poem/isReadOnly",{method:'POST',asynchronous:false,onSuccess:this.onIsReadOnlySuccess.bind(this),onFailure:this.onIsReadOnlyFailure.bind(this)});},onIsReadOnlySuccess:function(response){this._generateHeaderContent(Ext.util.JSON.decode(response.responseText).isReadOnly);},onIsReadOnlyFailure:function(response){this._generateHeaderContent(false);},setWorkflowTitleHeader:function(wfTitle){$j('.nokia_workflowbuilder_subtext .subject_title').text(wfTitle);},_generateHeaderContent:function(isReadOnly){var headerPanel=new Ext.Panel({height:60,autoHeight:false,border:false,html:'<div id="oryx_editor_header"><a id="oryx_editor_header_focus"></a></div>'});var maActive=ORYX.MashupAPI&&ORYX.MashupAPI.isUsed;var maKey=maActive?ORYX.MashupAPI.key:"";var maCanRun=maActive?ORYX.MashupAPI.canRun:false;var maIsRemoteM=maActive?ORYX.MashupAPI.isModelRemote:true;var maModelImage=maIsRemoteM?"<img src='"+ORYX.PATH+"images/page_white_put.png'/>":"";var maModelAuthI=maActive?"<span class='mashupinfo'><img src='"+ORYX.PATH+"images/"+(maCanRun?"plugin_error":"plugin")+".png'/>"+maModelImage+"</span>":"";var fn=function(val){var publicText=ORYX.I18N.Oryx.notLoggedOn;var user=val&&val.identifier&&val.identifier!="public"?decodeURI(val.identifier.gsub('"',"")).replace(/\+/g," "):"";if(user.length<=0){user=publicText;}
var readOnlyHdr=isReadOnly?"<div id='readOnlyHdr'><h3>"+
Repository.I18N.Repository.readOnly+"</h3>"+"<p>"+
Repository.I18N.Repository.readOnlyTxt+"</p>"+"</div>":"";var content="<div id='oryx_editor_header'><a id='oryx_editor_header_focus'></a>"+'     <div class="nokia_workflowbuilder_subtext">'+'          <h2 class="application_title">'+MOTV.I18N.WorkflowBuilder+'</h2>'+'          <h3 class="subject_title"></h3>'+'     </div>'+
readOnlyHdr+"<span class='openid "+(publicText==user?"not":"")+"'>"+
ORYX.I18N.openid.greetingPrefix+" "+
user+
ORYX.I18N.openid.greetingSuffix+
maModelAuthI+"</span>"+"</div>";if(headerPanel.body){headerPanel.body.dom.innerHTML=content;}else{headerPanel.html=content}};ORYX.Editor.Cookie.onChange(fn);fn(ORYX.Editor.Cookie.getParams());this.addToRegion("north",headerPanel);var pattern1=new RegExp(ORYX.I18N.Oryx.title+' : ');var pattern2=new RegExp(' - '+ORYX.I18N.Oryx.title);var wfTitle;if(pattern1.test(document.title)){wfTitle="New "+document.title.replace(pattern1,'')+" Workflow";}else if(pattern2.test(document.title)){wfTitle=document.title.replace(pattern2,'');}
this.setWorkflowTitleHeader(wfTitle);},addToRegion:function(region,component,title){if(region.toLowerCase&&this.layout_regions[region.toLowerCase()]){var current_region=this.layout_regions[region.toLowerCase()];current_region.add(component);ORYX.Log.debug("original dimensions of region %0: %1 x %2",current_region.region,current_region.width,current_region.height)
if(!current_region.width&&component.initialConfig&&component.initialConfig.width){ORYX.Log.debug("resizing width of region %0: %1",current_region.region,component.initialConfig.width)
current_region.setWidth(component.initialConfig.width)}
if(component.initialConfig&&component.initialConfig.height){ORYX.Log.debug("resizing height of region %0: %1",current_region.region,component.initialConfig.height)
var current_height=current_region.height||0;current_region.height=component.initialConfig.height+current_height;current_region.setHeight(component.initialConfig.height+current_height)}
if(typeof title=="string"){current_region.setTitle(title);}
current_region.ownerCt.doLayout();current_region.show();if(Ext.isMac)
ORYX.Editor.resizeFix();return current_region;}
return null;},getAvailablePlugins:function(){var curAvailablePlugins=ORYX.availablePlugins.clone();curAvailablePlugins.each(function(plugin){if(this.loadedPlugins.find(function(loadedPlugin){return loadedPlugin.type==this.name;}.bind(plugin))){plugin.engaged=true;}else{plugin.engaged=false;}}.bind(this));return curAvailablePlugins;},getVisibleCanvasBounds:function(){var bodyEl=this._editorTabPanel.body;var viewScrollPosition=bodyEl.getScroll();var canvasZoomLevel=this.getCanvas().zoomLevel;var x=viewScrollPosition.left/canvasZoomLevel,y=viewScrollPosition.top/canvasZoomLevel,viewHeight=bodyEl.getHeight()/canvasZoomLevel,viewWidth=bodyEl.getWidth()/canvasZoomLevel;var bounds=new ORYX.Core.Bounds(x,y,viewWidth,viewHeight);return bounds;},isShapeVisible:function(shape){if(shape==null)
return false;return this.getVisibleCanvasBounds().isBoundsContained(shape.bounds);},_getEditorFromResourceId:function(resourceId){var activeEditor=this.getActiveEditor();var editor=null;if(activeEditor){editor=activeEditor.getEditorForShape(resourceId);if(editor)
return editor;}
editor=this._topfloweditor.getEditorForShape(resourceId);return editor;},displayShapeInCanvas:function(shape,selectShape){if(shape==null)
return false;var resourceID=shape;if(shape instanceof ORYX.Core.AbstractShape){resourceID=shape.resourceId;}
var shapeEditor=this._getEditorFromResourceId(resourceID);if(!shapeEditor)
return false;shapeEditor.setAsActiveEditor();if(typeof shape==="string"){shape=this.getCanvas().getShape(shape);}
if(!(shape instanceof ORYX.Core.AbstractShape))
return false;if(!this.isShapeVisible(shape)){var shapeCenterPoint=shape.bounds.center(),canvasBounds=this.getVisibleCanvasBounds(),bodyEl=this._editorTabPanel.body,canvasZoomLevel=this.getCanvas().zoomLevel;var viewWidth=bodyEl.getWidth(),viewHeight=bodyEl.getHeight();var newX=shapeCenterPoint.x*canvasZoomLevel-(viewWidth/2),newY=shapeCenterPoint.y*canvasZoomLevel-(viewHeight/2);bodyEl.scrollTo("left",newX);bodyEl.scrollTo("top",newY);}
if(selectShape){this.setSelection([shape]);}
return true;},loadScript:function(url,callback){var script=document.createElement("script")
script.type="text/javascript";if(script.readyState){script.onreadystatechange=function(){if(script.readyState=="loaded"||script.readyState=="complete"){script.onreadystatechange=null;callback();}};}else{script.onload=function(){callback();};}
script.src=url;document.getElementsByTagName("head")[0].appendChild(script);},activatePluginByName:function(name,callback,loadTry){var match=this.getAvailablePlugins().find(function(value){return value.name==name});if(match&&(!match.engaged||(match.engaged==='false'))){var loadedStencilSetsNamespaces=this.getStencilSets().keys();var facade=this._getPluginFacade();var newPlugin;var me=this;ORYX.Log.debug("Initializing plugin '%0'",match.name);if(!match.requires||!match.requires.namespaces||match.requires.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0})){if(!match.notUsesIn||!match.notUsesIn.namespaces||!match.notUsesIn.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0})){try{var className=eval(match.name);var newPlugin=new className(facade,match);newPlugin.type=match.name;if(newPlugin.registryChanged)
newPlugin.registryChanged(me.pluginsData);if(newPlugin.onSelectionChanged)
me.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,newPlugin.onSelectionChanged.bind(newPlugin));this.loadedPlugins.push(newPlugin);this.loadedPlugins.each(function(loaded){if(loaded.registryChanged)
loaded.registryChanged(this.pluginsData);}.bind(me));callback(true);}catch(e){ORYX.Log.warn("Plugin %0 is not available",match.name);if(!!loadTry){callback(false,"INITFAILED");return;}
this.loadScript("plugins/scripts/"+match.source,this.activatePluginByName.bind(this,match.name,callback,true));}}else{callback(false,"NOTUSEINSTENCILSET");ORYX.Log.info("Plugin need a stencilset which is not loaded'",match.name);}}else{callback(false,"REQUIRESTENCILSET");ORYX.Log.info("Plugin need a stencilset which is not loaded'",match.name);}}else{callback(false,match?"NOTFOUND":"YETACTIVATED");}},loadPlugins:function(){var me=this;var newPlugins=[];var loadedStencilSetsNamespaces=this.getStencilSets().keys();var facade=this._getPluginFacade();if(ORYX.MashupAPI&&ORYX.MashupAPI.loadablePlugins&&ORYX.MashupAPI.loadablePlugins instanceof Array){ORYX.availablePlugins=$A(ORYX.availablePlugins).findAll(function(value){return ORYX.MashupAPI.loadablePlugins.include(value.name)})
ORYX.MashupAPI.loadablePlugins.each(function(className){if(!(ORYX.availablePlugins.find(function(val){return val.name==className}))){ORYX.availablePlugins.push({name:className});}})}
ORYX.availablePlugins.each(function(value){ORYX.Log.debug("Initializing plugin '%0'",value.name);if((!value.requires||!value.requires.namespaces||value.requires.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0}))&&(!value.notUsesIn||!value.notUsesIn.namespaces||!value.notUsesIn.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0}))&&(value.engaged||(value.engaged===undefined))){try{var className=eval(value.name);if(className){var plugin=new className(facade,value);plugin.type=value.name;newPlugins.push(plugin);plugin.engaged=true;}}catch(e){ORYX.Log.warn("Plugin %0 is not available",value.name);}}else{ORYX.Log.info("Plugin need a stencilset which is not loaded'",value.name);}});newPlugins.each(function(value){if(value.registryChanged)
value.registryChanged(me.pluginsData);if(value.onSelectionChanged)
me.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,value.onSelectionChanged.bind(value));});this.loadedPlugins=newPlugins;if(Ext.isMac){ORYX.Editor.resizeFix();}
this.registerPluginsOnKeyEvents();this.setSelection();},_loadStencilSetExtensionConfig:function(){new Ajax.Request(ORYX.CONFIG.SS_EXTENSIONS_CONFIG,{method:'GET',asynchronous:false,onSuccess:(function(transport){var jsonObject=Ext.decode(transport.responseText);this.ss_extensions_def=jsonObject;}).bind(this),onFailure:(function(transport){ORYX.Log.error("Editor._loadStencilSetExtensionConfig: Loading stencil set extension configuration file failed."+transport);}).bind(this)});},_createCanvas:function(stencilType,canvasConfig){if(stencilType){if(stencilType.search(/^http/)===-1){stencilType=this.getStencilSets().values()[0].namespace()+stencilType;}}
else{stencilType=this.getStencilSets().values()[0].findRootStencilName();}
var canvasStencil=ORYX.Core.StencilSet.stencil(stencilType);if(!canvasStencil)
ORYX.Log.fatal("Initialisation failed, because the stencil with the type %0 is not part of one of the loaded stencil sets.",stencilType);var div=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",null,['div']);div.addClassName("ORYX_Editor");this._canvas=new ORYX.Core.Canvas({width:ORYX.CONFIG.CANVAS_WIDTH,height:ORYX.CONFIG.CANVAS_HEIGHT,'eventHandlerCallback':this.handleEvents.bind(this),id:this.id,parentNode:div},canvasStencil);if(canvasConfig){var properties=[];for(field in canvasConfig){properties.push({prefix:'oryx',name:field,value:canvasConfig[field]});}
this._canvas.deserialize(properties);}},_getPluginFacade:function(){if(!(this._pluginFacade))
this._pluginFacade={isReadonly:false,isAutoSave:this.isAutoSave.bind(this),isBPMN4:this.isBPMN4.bind(this),isPOF:this.isPOF.bind(this),setAutoSave:this.setAutoSave.bind(this),getOrigContentVersion:this.getOrigContentVersion.bind(this),setOrigContentVersion:this.setOrigContentVersion.bind(this),statusbar:null,activatePluginByName:this.activatePluginByName.bind(this),getAvailablePlugins:this.getAvailablePlugins.bind(this),offer:this.offer.bind(this),getStencilSets:this.getStencilSets.bind(this),getRules:this.getRules.bind(this),loadStencilSet:this.loadStencilSet.bind(this),createShape:this.createShape.bind(this),deleteShape:this.deleteShape.bind(this),getSelection:this.getSelection.bind(this),setSelection:this.setSelection.bind(this),updateSelection:this.updateSelection.bind(this),getCanvas:this.getCanvas.bind(this),setWorkflowTitleHeader:this.setWorkflowTitleHeader.bind(this),getChangeDifference:this.getChangeDifference.bind(this),resetChangeDifference:this.resetChangeDifference.bind(this),getSavingPromise:this.getSavingPromise.bind(this),resolveSavingPromise:this.resolveSavingPromise.bind(this),setSavingPromise:this.setSavingPromise.bind(this),getCurrentLanguage:this.getCurrentLanguage.bind(this),setCurrentLanguage:this.setCurrentLanguage.bind(this),getCurrentLocale:this.getCurrentLocale.bind(this),setCurrentLocale:this.setCurrentLocale.bind(this),getLocaleConfig:this.getLocaleConfig.bind(this),getLocaleConfigString:this.getLocaleConfigString.bind(this),importJSON:this.importJSON.bind(this),importERDF:this.importERDF.bind(this),getERDF:this.getERDF.bind(this),getJSON:this.getJSON.bind(this),getSerializedJSON:this.getSerializedJSON.bind(this),executeCommands:this.executeCommands.bind(this),registerOnEvent:this.registerOnEvent.bind(this),unregisterOnEvent:this.unregisterOnEvent.bind(this),raiseEvent:this.handleEvents.bind(this),enableEvent:this.enableEvent.bind(this),disableEvent:this.disableEvent.bind(this),eventCoordinates:this.eventCoordinates.bind(this),addToRegion:this.addToRegion.bind(this),getActivityImplMetaData:this.getActivityImplMetaData.bind(this),setActivityImplMetaData:this.setActivityImplMetaData.bind(this),getModelMetaData:this.getModelMetaData.bind(this),getActivityOrder:this.getActivityOrder.bind(this),setActivityOrder:this.setActivityOrder.bind(this),getPofParams:this.getPofParams.bind(this),setPofParams:this.setPofParams.bind(this),getPropertyWindow:this.getPropertyWindow.bind(this),setPropertyWindow:this.setPropertyWindow.bind(this),getCurrentFlowView:this.getCurrentFlowView.bind(this),getCurrentFlowViewGroupItems:this.getCurrentFlowViewGroupItems.bind(this),setCurrentFlowView:this.setCurrentFlowView.bind(this),updateFlowViews:this.updateFlowViews.bind(this),getFlowViews:this.getFlowViews.bind(this),getActiveEditor:this.getActiveEditor.bind(this),getChannels:this.getChannels.bind(this),getChannelMetaData:this.getChannelMetaData.bind(this),dockToolPanel:this.dockToolPanel.bind(this),removeToolFromPanel:this.removeToolFromPanel.bind(this),focusToolPanel:this.focusToolPanel.bind(this),openSouthPanel:this.openSouthPanel.bind(this),displayShapeInCanvas:this.displayShapeInCanvas.bind(this),getModelID:this.getModelID.bind(this),getFlowViewByName:this.getFlowViewByName.bind(this),getSelectedPool:this.getSelectedPool.bind(this),setSelectedPool:this.setSelectedPool.bind(this)};return this._pluginFacade;},executeCommands:function(commands){if(commands instanceof Array&&commands.length>0&&commands.all(function(command){return command instanceof ORYX.Core.Command})){this.handleEvents({type:ORYX.CONFIG.EVENT_EXECUTE_COMMANDS,commands:commands});commands.each(function(command){command.execute();})}},isAutoSave:function(){return this.autoSave;},isBPMN4:function(){return/motivebpmn4\.0\.json$/.test(this.getStencilSets().values()[0]._source);},isPOF:function(){return/motivepof3\.0\.json$/.test(this.getStencilSets().values()[0]._source);},getModelID:function(){var id,matchArray=window.location.href.match(/.+model\/(\d+)/);if(matchArray[1]){id=matchArray[1];}
return id;},getSavingPromise:function(){return this.savingPromise.promise();},resolveSavingPromise:function(){if(this.savingPromise!==undefined){this.savingPromise.resolve();}},setSavingPromise:function(){this.savingPromise=$j.Deferred();},setAutoSave:function(autoSave){this.autoSave=autoSave;},getOrigContentVersion:function(){return this.origContentVersion;},setOrigContentVersion:function(origContentVersion){this.origContentVersion=origContentVersion;},getChangeDifference:function(){return this.changeDifference;},resetChangeDifference:function(){this.changeDifference=0;},getCurrentLanguage:function(){return this._currentLanguage;},setCurrentLanguage:function(lang){this._currentLanguage=lang;},getCurrentLocale:function(){return this._currentLocale;},setCurrentLocale:function(locale){this._currentLocale=locale;},getLocaleConfig:function(){return this._localeConfig;},getLocaleConfigString:function(){var availableLocales=[];var availableLocalesCfg=undefined;this._localeConfig.each(function(locale){var key=locale.languagecode+(locale.countrycode?"_"+locale.countrycode:"");var aLocale={displayName:locale.displayName,key:key};availableLocales.push(aLocale);}.bind(this));availableLocalesCfg=Ext.util.JSON.encode(availableLocales);return availableLocalesCfg;},getChannels:function(){var channels=new Hash();var jsonArray=this.getStencilSets().values()[0].jsonChannels();for(i=0;i<jsonArray.length;i++){channels[jsonArray[i].id]=jsonArray[i];}
return channels;},getChannelMetaData:function(ch){return this.getChannels()[ch];},dockToolPanel:function(panel,focusPanel){if(panel==null||panel.getId==null)
return false;if(this._toolTabPanel.findById(panel.getId()))
return true;this._toolTabPanel.add(panel);if(focusPanel||this._toolTabPanel.items.length==1)
this._toolTabPanel.activate(panel);return true;},removeToolFromPanel:function(panel){if(panel==null||panel.getId==null)
return false;if(this._toolTabPanel.findById(panel.getId())){this._toolTabPanel.remove(panel);}
return true;},focusToolPanel:function(panel){if(panel==null||panel.getId==null)
return false;if(!this._toolTabPanel.findById(panel.getId()))
return false;this.layout_regions.southPanel.expand();this._toolTabPanel.activate(panel);return true;},getActivityImplMetaData:function(){return this.activityImplMetaData;},setActivityImplMetaData:function(arr){this.activityImplMetaData=arr;},getActivityOrder:function(){return this.activityOrder;},setActivityOrder:function(arr){this.activityOrder=arr;},setPofParams:function(params){this.pofParams=params;},getPofParams:function(){return this.pofParams;},getSelectedPool:function(){return this.selectedPool;},setSelectedPool:function(pool){this.selectedPool=pool;},getPropertyWindow:function(){return this.propertyWindow;},setPropertyWindow:function(propertyWindow){this.propertyWindow=propertyWindow;},getJSON:function(){var canvas=this._topfloweditor.toJSON();var diagram=this._topfloweditor.getSVGRepresentation();canvas.flowViews=[];var i;for(i=0;i<this.modelMetaData.flowViews.length;++i){canvas.flowViews.push(this.modelMetaData.flowViews[i]);if(this._currentFlowView===i){canvas.flowViews[i].flowViewShapes=canvas.childShapes;canvas.flowViews[i].diagram={};canvas.flowViews[i].diagram[canvas.flowViews[i].name]=diagram;}
if(canvas.flowViews[i].diagram==null){canvas.flowViews[i].diagram={};canvas.flowViews[i].diagram[canvas.flowViews[i].name]={"svg":""};}}
if(this._currentFlowView!=-1){canvas.childShapes=this.modelMetaData.childShapes;canvas.diagram=this.modelMetaData.diagram;}else{canvas.diagram={"default":diagram};}
canvas.ssextensions=this.getStencilSets().values()[0].extensions().keys();canvas.baseEditVersion=ORYX.contentVersion;var activityImplMetaData=this.getActivityImplMetaData();if(activityImplMetaData){canvas.activityImplMetaData=activityImplMetaData;}
var activityOrder=this.getActivityOrder();if(activityOrder){canvas.properties.activityOrder=activityOrder;}
var pofParams=this.getPofParams();if(pofParams){canvas.pofParams=pofParams;}
return canvas;},getSerializedJSON:function(){return Ext.encode(this.getJSON());},getERDF:function(){var serializedDOM=DataManager.serializeDOM(this._getPluginFacade());serializedDOM='<?xml version="1.0" encoding="utf-8"?>'+'<html xmlns="http://www.w3.org/1999/xhtml" '+'xmlns:b3mn="http://b3mn.org/2007/b3mn" '+'xmlns:ext="http://b3mn.org/2007/ext" '+'xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" '+'xmlns:atom="http://b3mn.org/2007/atom+xhtml">'+'<head profile="http://purl.org/NET/erdf/profile">'+'<link rel="schema.dc" href="http://purl.org/dc/elements/1.1/" />'+'<link rel="schema.dcTerms" href="http://purl.org/dc/terms/ " />'+'<link rel="schema.b3mn" href="http://b3mn.org" />'+'<link rel="schema.oryx" href="http://oryx-editor.org/" />'+'<link rel="schema.raziel" href="http://raziel.org/" />'+'<base href="'+
location.href.split("?")[0]+'" />'+'</head><body>'+
serializedDOM+'</body></html>';return serializedDOM;},importJSON:function(jsonObject,noSelectionAfterImport){try{jsonObject=this.renewResourceIds(jsonObject);}catch(error){throw error;}
if(jsonObject.stencilset.namespace&&jsonObject.stencilset.namespace!==this.getCanvas().getStencil().stencilSet().namespace()){Ext.Msg.alert(ORYX.I18N.JSONImport.title,String.format(ORYX.I18N.JSONImport.wrongSS,jsonObject.stencilset.namespace,this.getCanvas().getStencil().stencilSet().namespace()));return null;}else{var commandClass=ORYX.Core.Command.extend({construct:function(jsonObject,loadSerializedCB,noSelectionAfterImport,facade){this.jsonObject=jsonObject;this.noSelection=noSelectionAfterImport;this.facade=facade;this.shapes;this.connections=[];this.parents=new Hash();this.selection=this.facade.getSelection();this.loadSerialized=loadSerializedCB;},execute:function(){if(!this.shapes){this.shapes=this.loadSerialized(this.jsonObject);this.shapes.each(function(shape){if(shape.getDockers){var dockers=shape.getDockers();if(dockers){if(dockers.length>0){this.connections.push([dockers.first(),dockers.first().getDockedShape(),dockers.first().referencePoint]);}
if(dockers.length>1){this.connections.push([dockers.last(),dockers.last().getDockedShape(),dockers.last().referencePoint]);}}}
this.parents[shape.id]=shape.parent;}.bind(this));}else{this.shapes.each(function(shape){this.parents[shape.id].add(shape);}.bind(this));this.connections.each(function(con){con[0].setDockedShape(con[1]);con[0].setReferencePoint(con[2]);});}
this.facade.getCanvas().update();if(!this.noSelection)
this.facade.setSelection(this.shapes);else
this.facade.updateSelection();},rollback:function(){var selection=this.facade.getSelection();this.shapes.each(function(shape){selection=selection.without(shape);this.facade.deleteShape(shape);}.bind(this));this.facade.getCanvas().update();this.facade.setSelection(selection);}})
var activeEditor=this.getActiveEditor();var command=new commandClass(jsonObject,activeEditor.addShapesFromModel.bind(activeEditor),noSelectionAfterImport,this._getPluginFacade());this.executeCommands([command]);return command.shapes.clone();}},renewResourceIds:function(jsonObject){if(Ext.type(jsonObject)==="string"){try{var serJsonObject=jsonObject;jsonObject=Ext.decode(jsonObject);}catch(error){throw new SyntaxError(error.message);}}else{var serJsonObject=Ext.encode(jsonObject);}
var collectResourceIds=function(shapes){if(!shapes)return[];return shapes.map(function(shape){return collectResourceIds(shape.childShapes).concat(shape.resourceId);}).flatten();}
var resourceIds=collectResourceIds(jsonObject.childShapes);resourceIds.each(function(oldResourceId){var newResourceId=ORYX.Editor.provideId();serJsonObject=serJsonObject.gsub('"'+oldResourceId+'"','"'+newResourceId+'"')});return Ext.decode(serJsonObject);},importERDF:function(erdfDOM){var serialized=this.parseToSerializeObjects(erdfDOM);if(serialized)
return this.importJSON(serialized,true);},parseToSerializeObjects:function(oneProcessData){if(oneProcessData.normalize)oneProcessData.normalize();try{var xsl="";var source=ORYX.PATH+"lib/extract-rdf.xsl";new Ajax.Request(source,{asynchronous:false,method:'get',onSuccess:function(transport){xsl=transport.responseText}.bind(this),onFailure:(function(transport){ORYX.Log.error("XSL load failed"+transport);}).bind(this)});var domParser=new DOMParser();var xmlObject=oneProcessData;var xslObject=domParser.parseFromString(xsl,"text/xml");var xsltProcessor=new XSLTProcessor();var xslRef=document.implementation.createDocument("","",null);xsltProcessor.importStylesheet(xslObject);var new_rdf=xsltProcessor.transformToFragment(xmlObject,document);var serialized_rdf=(new XMLSerializer()).serializeToString(new_rdf);}catch(e){Ext.Msg.alert("Oryx",error);var serialized_rdf="";}
serialized_rdf=!serialized_rdf.startsWith("<?xml")?"<?xml version=\"1.0\" encoding=\"UTF-8\"?>"+serialized_rdf:serialized_rdf;var req=new Ajax.Request(ORYX.CONFIG.ROOT_PATH+"rdf2json",{method:'POST',asynchronous:false,onSuccess:function(transport){Ext.decode(transport.responseText);},parameters:{rdf:serialized_rdf}});return Ext.decode(req.transport.responseText);},loadSSExtensions:function(ss_extension_namespaces){if(!ss_extension_namespaces)return;ss_extension_namespaces.each(function(ss_extension_namespace){this.loadSSExtension(ss_extension_namespace);}.bind(this));},loadSSExtension:function(ss_extension_namespace){if(this.ss_extensions_def){var extension=this.ss_extensions_def.extensions.find(function(ex){return(ex.namespace==ss_extension_namespace);});if(!extension){return;}
var stencilset=this.getStencilSets()[extension["extends"]];if(!stencilset){return;}
stencilset.addExtension(ORYX.CONFIG.SS_EXTENSIONS_FOLDER+extension["definition"])
this.getRules().initializeRules(stencilset);this._getPluginFacade().raiseEvent({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED});}},disableEvent:function(eventType){if(eventType==ORYX.CONFIG.EVENT_KEYDOWN){this._keydownEnabled=false;}
if(eventType==ORYX.CONFIG.EVENT_KEYUP){this._keyupEnabled=false;}
if(this.DOMEventListeners.keys().member(eventType)){var value=this.DOMEventListeners.remove(eventType);this.DOMEventListeners['disable_'+eventType]=value;}},enableEvent:function(eventType){if(eventType==ORYX.CONFIG.EVENT_KEYDOWN){this._keydownEnabled=true;}
if(eventType==ORYX.CONFIG.EVENT_KEYUP){this._keyupEnabled=true;}
if(this.DOMEventListeners.keys().member("disable_"+eventType)){var value=this.DOMEventListeners.remove("disable_"+eventType);this.DOMEventListeners[eventType]=value;}},registerOnEvent:function(eventType,callback){if(!(this.DOMEventListeners.keys().member(eventType))){this.DOMEventListeners[eventType]=[];}
this.DOMEventListeners[eventType].push(callback);},unregisterOnEvent:function(eventType,callback){if(this.DOMEventListeners.keys().member(eventType)){this.DOMEventListeners[eventType]=this.DOMEventListeners[eventType].without(callback);}else{}},getSelection:function(){return this.selection;},getStencilSets:function(){return ORYX.Core.StencilSet.stencilSets(this.id);},getRules:function(){return ORYX.Core.StencilSet.rules(this.id);},loadStencilSet:function(source){try{ORYX.Core.StencilSet.loadStencilSet(source,this.id);this.handleEvents({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED});}catch(e){ORYX.Log.warn("Requesting stencil set file failed. ("+e+")");}},offer:function(pluginData){if(!this.pluginsData.member(pluginData)){this.pluginsData.push(pluginData);}},registerPluginsOnKeyEvents:function(){this.pluginsData.each(function(pluginData){if(pluginData.keyCodes){pluginData.keyCodes.each(function(keyComb){var eventName="key.event";eventName+='.'+keyComb.keyAction;if(keyComb.metaKeys){if(keyComb.metaKeys.indexOf(ORYX.CONFIG.META_KEY_META_CTRL)>-1){eventName+="."+ORYX.CONFIG.META_KEY_META_CTRL;}
if(keyComb.metaKeys.indexOf(ORYX.CONFIG.META_KEY_ALT)>-1){eventName+='.'+ORYX.CONFIG.META_KEY_ALT;}
if(keyComb.metaKeys.indexOf(ORYX.CONFIG.META_KEY_SHIFT)>-1){eventName+='.'+ORYX.CONFIG.META_KEY_SHIFT;}}
if(keyComb.keyCode){eventName+='.'+keyComb.keyCode;}
ORYX.Log.debug("Register Plugin on Key Event: %0",eventName);this.registerOnEvent(eventName,pluginData.functionality);}.bind(this));}}.bind(this));},setSelection:function(elements,subSelectionElement,force){if(!elements){elements=[]}
elements=elements.compact().findAll(function(n){return n instanceof ORYX.Core.Shape});if(elements.first()instanceof ORYX.Core.Canvas){elements=[];}
if(!force&&elements.length===this.selection.length&&this.selection.all(function(r){return elements.include(r)})){return;}
this.selection=elements;this._subSelection=subSelectionElement;this.handleEvents({type:ORYX.CONFIG.EVENT_SELECTION_CHANGED,elements:elements,subSelection:subSelectionElement})},updateSelection:function(){this.setSelection(this.selection,this._subSelection,true);},getCanvas:function(){return this._canvas;},createShape:function(option,addToCanvas){if(option&&option.serialize&&option.serialize instanceof Array){var type=option.serialize.find(function(obj){return(obj.prefix+"-"+obj.name)=="oryx-type"});var stencil=ORYX.Core.StencilSet.stencil(type.value);if(stencil.type()=='node'){var newShapeObject=new ORYX.Core.Node({'eventHandlerCallback':this.handleEvents.bind(this)},stencil);}else{var newShapeObject=new ORYX.Core.Edge({'eventHandlerCallback':this.handleEvents.bind(this)},stencil);}
this.getCanvas().add(newShapeObject);newShapeObject.deserialize(option.serialize);return newShapeObject;}
if(!option||!option.type||!option.namespace){throw"To create a new shape you have to give an argument with type and namespace";}
var canvas=this.getCanvas();var newShapeObject;var shapetype=option.type;var sset=ORYX.Core.StencilSet.stencilSet(option.namespace);if(sset.stencil(shapetype).type()=="node"){newShapeObject=new ORYX.Core.Node({'eventHandlerCallback':this.handleEvents.bind(this)},sset.stencil(shapetype))}else{newShapeObject=new ORYX.Core.Edge({'eventHandlerCallback':this.handleEvents.bind(this)},sset.stencil(shapetype))}
if(option.template){newShapeObject._jsonStencil.properties=option.template._jsonStencil.properties;newShapeObject.postProcessProperties();}
if(option.properties){newShapeObject.properties=option.properties;}
if(addToCanvas!==false){if(option.parent&&newShapeObject instanceof ORYX.Core.Node){option.parent.add(newShapeObject);}else{canvas.add(newShapeObject);}}
var point=option.position?option.position:{x:100,y:200};var con;if(option.connectingType&&option.connectedShape&&!(newShapeObject instanceof ORYX.Core.Edge)){con=new ORYX.Core.Edge({'eventHandlerCallback':this.handleEvents.bind(this)},sset.stencil(option.connectingType));con.dockers.first().setDockedShape(option.connectedShape);var magnet=option.connectedShape.getDefaultMagnet()
var cPoint=magnet?magnet.bounds.center():option.connectedShape.bounds.midPoint();con.dockers.first().setReferencePoint(cPoint);con.dockers.last().setDockedShape(newShapeObject);con.dockers.last().setReferencePoint(newShapeObject.getDefaultMagnet().bounds.center());canvas.add(con);}
if(newShapeObject instanceof ORYX.Core.Edge&&option.connectedShape){newShapeObject.dockers.first().setDockedShape(option.connectedShape);if(option.connectedShape instanceof ORYX.Core.Node){newShapeObject.dockers.first().setReferencePoint(option.connectedShape.getDefaultMagnet().bounds.center());newShapeObject.dockers.last().bounds.centerMoveTo(point);}else{newShapeObject.dockers.first().setReferencePoint(option.connectedShape.bounds.midPoint());}}else{var b=newShapeObject.bounds
if(newShapeObject instanceof ORYX.Core.Node&&newShapeObject.dockers.length==1){b=newShapeObject.dockers.first().bounds}
b.centerMoveTo(point);var upL=b.upperLeft();b.moveBy(-Math.min(upL.x,0),-Math.min(upL.y,0))
var lwR=b.lowerRight();b.moveBy(-Math.max(lwR.x-canvas.bounds.width(),0),-Math.max(lwR.y-canvas.bounds.height(),0))}
if(newShapeObject instanceof ORYX.Core.Edge){newShapeObject._update(false);}
if(!(newShapeObject instanceof ORYX.Core.Edge)){this.setSelection([newShapeObject]);}
if(con&&con.alignDockers){con.alignDockers();}
if(newShapeObject.alignDockers){newShapeObject.alignDockers();}
return newShapeObject;},deleteShape:function(shape){if(!shape||!shape.parent){return}
shape.parent.remove(shape);shape.getOutgoingShapes().each(function(os){var docker=os.getDockers().first();if(docker&&docker.getDockedShape()==shape){docker.setDockedShape(undefined);}});shape.getIncomingShapes().each(function(is){var docker=is.getDockers().last();if(docker&&docker.getDockedShape()==shape){docker.setDockedShape(undefined);}});shape.getDockers().each(function(docker){docker.setDockedShape(undefined);});},getModelMetaData:function(){return this.modelMetaData;},_executeEventImmediately:function(eventObj){if(this.DOMEventListeners.keys().member(eventObj.event.type)){this.DOMEventListeners[eventObj.event.type].each((function(value){if(eventObj.event.type==="propertyChanged"){value(eventObj.event,eventObj.arg);}else{value(eventObj.event,eventObj.arg);if(eventObj.event.promise&&this.savingPromise!==undefined){this.resolveSavingPromise();}}}).bind(this));}},_executeEvents:function(){this._queueRunning=true;while(this._eventsQueue.length>0){var val=this._eventsQueue.shift();this._executeEventImmediately(val);}
this._queueRunning=false;},handleEvents:function(event,uiObj){ORYX.Log.trace("Dispatching event type %0 on %1",event.type,uiObj);switch(event.type){case ORYX.CONFIG.EVENT_MOUSEDOWN:this._handleMouseDown(event,uiObj);break;case ORYX.CONFIG.EVENT_MOUSEMOVE:this._handleMouseMove(event,uiObj);break;case ORYX.CONFIG.EVENT_MOUSEUP:this._handleMouseUp(event,uiObj);break;case ORYX.CONFIG.EVENT_MOUSEOVER:this._handleMouseHover(event,uiObj);break;case ORYX.CONFIG.EVENT_MOUSEOUT:this._handleMouseOut(event,uiObj);break;}
if(event.forceExecution){this._executeEventImmediately({event:event,arg:uiObj});}else{this._eventsQueue.push({event:event,arg:uiObj});}
if(!this._queueRunning){this._executeEvents();}
var ctrlMatches=/^key\.event\.up\.metactrl\.(\d+)$/.exec(event.type);if(ctrlMatches){this._handleControlKeyEvent(event,ctrlMatches[1]);}
return false;},catchKeyUpEvents:function(event){if(!this._keyupEnabled){return;}
if(!event)
event=window.event;if(["INPUT","TEXTAREA"].include(event.target.tagName.toUpperCase())){return;}
var keyUpEvent=this.createKeyCombEvent(event,ORYX.CONFIG.KEY_ACTION_UP);ORYX.Log.debug("Key Event to handle: %0",keyUpEvent);this.handleEvents({type:keyUpEvent,event:event});},catchKeyDownEvents:function(event){if(!this._keydownEnabled){return;}
if(!event)
event=window.event;if(["INPUT","TEXTAREA"].include(event.target.tagName.toUpperCase())){return;}
var keyDownEvent=this.createKeyCombEvent(event,ORYX.CONFIG.KEY_ACTION_DOWN);ORYX.Log.debug("Key Event to handle: %0",keyDownEvent);this.handleEvents({type:keyDownEvent,event:event});},createKeyCombEvent:function(keyEvent,keyAction){var pressedKey=keyEvent.which||keyEvent.keyCode;var eventName="key.event";if(keyAction){eventName+="."+keyAction;}
if(keyEvent.ctrlKey||keyEvent.metaKey){eventName+="."+ORYX.CONFIG.META_KEY_META_CTRL;}
if(keyEvent.altKey){eventName+="."+ORYX.CONFIG.META_KEY_ALT;}
if(keyEvent.shiftKey){eventName+="."+ORYX.CONFIG.META_KEY_SHIFT;}
return eventName+"."+pressedKey;},_handleControlKeyEvent:function(event,keycode){if(keycode==ORYX.CONFIG.KEY_CODE_2){var popularProps=this.propertyWindow.popularProperties;var displayNamePropArr;var row;var col=this.propertyWindow.grid.colModel.getIndexById("propertywindow_column_value");popularProps.each(function(prop,index){if(prop[2]==="Display Name"){displayNamePropArr=prop;row=index;}});if(displayNamePropArr!==undefined){var configObj=displayNamePropArr[5];var type=configObj.type;var field=configObj.editor.field;field.hotKey=true;if(/^html.*$/.test(type)){field.onTriggerClick();}else{this.propertyWindow.grid.startEditing(row,col);}}}},_handleMouseDown:function(event,uiObj){var canvas=this.getCanvas();canvas.focus()
var element=event.currentTarget;var elementController=uiObj;var currentIsSelectable=(elementController!==null)&&(elementController!==undefined)&&(elementController.isSelectable);var currentIsMovable=(elementController!==null)&&(elementController!==undefined)&&(elementController.isMovable);var modifierKeyPressed=event.shiftKey||event.ctrlKey;var noObjectsSelected=this.selection.length===0;var currentIsSelected=this.selection.member(elementController);if(currentIsSelectable&&noObjectsSelected){this.setSelection([elementController]);ORYX.Log.trace("Rule #1 applied for mouse down on %0",element.id);}else if(currentIsSelectable&&!noObjectsSelected&&!modifierKeyPressed&&!currentIsSelected){this.setSelection([elementController]);ORYX.Log.trace("Rule #3 applied for mouse down on %0",element.id);}else if(currentIsSelectable&&modifierKeyPressed&&!currentIsSelected){var newSelection=this.selection.clone();newSelection.push(elementController)
this.setSelection(newSelection)
ORYX.Log.trace("Rule #4 applied for mouse down on %0",element.id);}else if(currentIsSelectable&&currentIsSelected&&modifierKeyPressed){var newSelection=this.selection.clone();this.setSelection(newSelection.without(elementController))
ORYX.Log.trace("Rule #6 applied for mouse down on %0",elementController.id);}else if(!currentIsSelectable&&!currentIsMovable){this.setSelection([]);ORYX.Log.trace("Rule #2 applied for mouse down on %0",element.id);return;}else if(!currentIsSelectable&&currentIsMovable&&!(elementController instanceof ORYX.Core.Controls.Docker)){ORYX.Log.trace("Rule #7 applied for mouse down on %0",element.id);}else if(currentIsSelectable&&currentIsSelected&&!modifierKeyPressed){this._subSelection=this._subSelection!=elementController?elementController:undefined;this.setSelection(this.selection,this._subSelection);ORYX.Log.trace("Rule #8 applied for mouse down on %0",element.id);}
return;},_handleMouseMove:function(event,uiObj){return;},_handleMouseUp:function(event,uiObj){var canvas=this.getCanvas();var elementController=uiObj;var evPos=this.eventCoordinates(event);},_handleMouseHover:function(event,uiObj){return;},_handleMouseOut:function(event,uiObj){return;},eventCoordinates:function(event){var canvas=this.getCanvas();var svgPoint=canvas.node.ownerSVGElement.createSVGPoint();svgPoint.x=event.clientX;svgPoint.y=event.clientY;var matrix=canvas.node.getScreenCTM();return svgPoint.matrixTransform(matrix.inverse());},getCurrentFlowView:function(){var flowViewName=null;if(this._currentFlowView===-1){flowViewName=MOTV.I18N.FlowView.defaultFlowView;}else if(this._currentFlowView<this.modelMetaData.flowViews.length){flowViewName=this.modelMetaData.flowViews[this._currentFlowView].name;}
return flowViewName;},getCurrentFlowViewGroupItems:function(){var groupItems=null;if(this._currentFlowView===-1){groupItems=this.getChannels().keys();this.getFlowViews().each(function(flowView){if(flowView.groupItems){flowView.groupItems.each(function(groupItem){groupItems=groupItems.without(groupItem);});}});}else{groupItems=this.modelMetaData.flowViews[this._currentFlowView].groupItems;}
return groupItems;},getFlowViewByName:function(flowViewName){if(this._getFlowViewIndex(flowViewName)===-1){return{flowViewShapes:this.modelMetaData.childShapes};}
return this.modelMetaData.flowViews[this._getFlowViewIndex(flowViewName)]},_getFlowViewIndex:function(flowViewName){var flowViewIndex=-1;var i;for(i=0;i<this.modelMetaData.flowViews.length;++i){if(this.modelMetaData.flowViews[i].name===flowViewName){flowViewIndex=i;}}
return flowViewIndex;},setCurrentFlowView:function(flowViewName){var newFlowView=this._getFlowViewIndex(flowViewName);if(newFlowView!=this._currentFlowView){this._changeFlowView(newFlowView,true);}},_changeFlowView:function(newFlowViewIdx,saveCurrentCanvas){this._topfloweditor.setAsActiveEditor();this._topfloweditor.closeEditor(true);var shapes=this._topfloweditor.toJSON().childShapes;var svg=this._topfloweditor.getSVGRepresentation();if(saveCurrentCanvas){if(this._currentFlowView===-1){this.modelMetaData.childShapes=shapes;this.modelMetaData.diagram={"default":svg};}else{var name=this.modelMetaData.flowViews[this._currentFlowView].name;this.modelMetaData.flowViews[this._currentFlowView].flowViewShapes=shapes;this.modelMetaData.flowViews[this._currentFlowView].diagram={};this.modelMetaData.flowViews[this._currentFlowView].diagram[name]=svg;}}
this._clearCanvas();var oldFlowView=this.getCurrentFlowView();this._currentFlowView=newFlowViewIdx;var newFlowView=this.getCurrentFlowView();var model={};model.childShapes=this.modelMetaData.childShapes;if(this._currentFlowView!=-1){var flowView=this.modelMetaData.flowViews[this._currentFlowView];if(flowView&&flowView.flowViewShapes){model.childShapes=flowView.flowViewShapes;}}
model.ssextensions=this.modelMetaData.ssextensions;model.properties=this.modelMetaData.properties;this._topfloweditor.setFlowDefinition(model);this.handleEvents({type:ORYX.CONFIG.EVENT_FLOW_VIEW_CHANGE,previousFlowView:oldFlowView,newFlowView:newFlowView});},updateFlowViews:function(flowViews){var newFlowViews=[];var oldFlowViews=this.modelMetaData.flowViews;var currentFlowViewName=this.getCurrentFlowView();var newFlowViewIndex=-1;flowViews.each(function(newFlowViewData,idx){var newFlowView={name:newFlowViewData.data.name,groupItems:newFlowViewData.data.groupItems.split(","),flowViewShapes:[]};newFlowView[newFlowViewData.data.name]={"svg":""};if(newFlowViewData.data.flowViewShapes){newFlowView.flowViewShapes=newFlowViewData.data.flowViewShapes;newFlowView.diagram=newFlowViewData.data.diagram;}else{oldFlowViews.each(function(flowView){if(flowView.name===newFlowView.name){newFlowView.flowViewShapes=flowView.flowViewShapes;newFlowView.diagram=flowView.diagram;}});}
newFlowViews.push(newFlowView);if(newFlowView.name===currentFlowViewName){newFlowViewIndex=idx;}});this.modelMetaData.flowViews=newFlowViews;this._currentFlowView=newFlowViewIndex;var newFlowViewName=this.getCurrentFlowView();if(newFlowViewName!=currentFlowViewName){this._changeFlowView(this._currentFlowView,false);}
this.handleEvents({type:ORYX.CONFIG.EVENT_FLOW_VIEW_UPDATE});},getFlowViews:function(){return this.modelMetaData.flowViews;},getActiveEditor:function(){var activeTab=this._editorTabPanel.getActiveTab();if(!activeTab)
return null;return activeTab.editor;},_serializeCanvas:function(){var shapes=this.getCanvas().getChildShapes();return shapes.map(function(shape){return shape.toJSON();});},_clearCanvas:function(){var shapes=this.getCanvas().getChildShapes();shapes.each(function(shape){this.deleteShape(shape);}.bind(this));this.setSelection([]);}};ORYX.Editor=Clazz.extend(ORYX.Editor);ORYX.Editor.createByUrl=function(modelUrl,config){if(!config)config={};new Ajax.Request(modelUrl,{method:'GET',onSuccess:function(transport){try{var editorConfig=Ext.decode(transport.responseText);editorConfig=Ext.applyIf(editorConfig,config);top_editor=new ORYX.Editor(editorConfig);}catch(e){Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Oryx.modelLoadError+e.message);throw e;}}.bind(this)});}
ORYX.Editor.graft=function(namespace,parent,t,doc){doc=(doc||(parent&&parent.ownerDocument)||document);var e;if(t===undefined){throw"Can't graft an undefined value";}else if(t.constructor==String){e=doc.createTextNode(t);}else{for(var i=0;i<t.length;i++){if(i===0&&t[i].constructor==String){var snared;snared=t[i].match(/^([a-z][a-z0-9]*)\.([^\s\.]+)$/i);if(snared){e=doc.createElementNS(namespace,snared[1]);e.setAttributeNS(null,'class',snared[2]);continue;}
snared=t[i].match(/^([a-z][a-z0-9]*)$/i);if(snared){e=doc.createElementNS(namespace,snared[1]);continue;}
e=doc.createElementNS(namespace,"span");e.setAttribute(null,"class","namelessFromLOL");}
if(t[i]===undefined){throw"Can't graft an undefined value in a list!";}else if(t[i].constructor==String||t[i].constructor==Array){this.graft(namespace,e,t[i],doc);}else if(t[i].constructor==Number){this.graft(namespace,e,t[i].toString(),doc);}else if(t[i].constructor==Object){for(var k in t[i]){if(k==="xlink:href"){e.setAttributeNS("http://www.w3.org/1999/xlink","href",t[i][k]);}else{e.setAttributeNS(null,k,t[i][k]);}}}else{}}}
if(parent){parent.appendChild(e);}else{}
return e;};ORYX.Editor.provideId=function(){var res=[],hex='0123456789ABCDEF';for(var i=0;i<36;i++)res[i]=Math.floor(Math.random()*0x10);res[14]=4;res[19]=(res[19]&0x3)|0x8;for(var i=0;i<36;i++)res[i]=hex[res[i]];res[8]=res[13]=res[18]=res[23]='-';return"oryx_"+res.join('');};ORYX.Editor.autoUUID=function(stencilId)
{var uuidRequiredStencilIds=new Array("motv","Exclusive","script","subproc","subflow","kpi","bpfLauncher","problemType","problemResolution","autoSuspend");for(i=0;i<uuidRequiredStencilIds.length;i++)
{if(stencilId.indexOf(uuidRequiredStencilIds[i])!=-1)
{return true;}}
return false;};ORYX.Editor.isGUUID=function(guid)
{if(!guid||guid.length<24)
return false;if(guid[8]=='-'&&guid[13]=='-'&&guid[18]=='-'&&guid[23]=='-')
{return true;}
return false;}
ORYX.Editor.resizeFix=function(){if(!ORYX.Editor._resizeFixTimeout){ORYX.Editor._resizeFixTimeout=window.setTimeout(function(){window.resizeBy(1,1);window.resizeBy(-1,-1);ORYX.Editor._resizefixTimeout=null;},100);}};ORYX.Editor.Cookie={callbacks:[],onChange:function(callback,interval){this.callbacks.push(callback);this.start(interval)},start:function(interval){if(this.pe){return;}
var currentString=document.cookie;this.pe=new PeriodicalExecuter(function(){if(currentString!=document.cookie){currentString=document.cookie;this.callbacks.each(function(callback){callback(this.getParams())}.bind(this));}}.bind(this),(interval||10000)/1000);},stop:function(){if(this.pe){this.pe.stop();this.pe=null;}},getParams:function(){var res={};var p=document.cookie;p.split("; ").each(function(param){res[param.split("=")[0]]=param.split("=")[1];});return res;},toString:function(){return document.cookie;}};ORYX.Editor.SVGClassElementsAreAvailable=true;ORYX.Editor.setMissingClasses=function(){try{SVGElement;}catch(e){ORYX.Editor.SVGClassElementsAreAvailable=false;SVGSVGElement=document.createElementNS('http://www.w3.org/2000/svg','svg').toString();SVGGElement=document.createElementNS('http://www.w3.org/2000/svg','g').toString();SVGPathElement=document.createElementNS('http://www.w3.org/2000/svg','path').toString();SVGTextElement=document.createElementNS('http://www.w3.org/2000/svg','text').toString();SVGRectElement=document.createElementNS('http://www.w3.org/2000/svg','rect').toString();SVGImageElement=document.createElementNS('http://www.w3.org/2000/svg','image').toString();SVGCircleElement=document.createElementNS('http://www.w3.org/2000/svg','circle').toString();SVGEllipseElement=document.createElementNS('http://www.w3.org/2000/svg','ellipse').toString();SVGLineElement=document.createElementNS('http://www.w3.org/2000/svg','line').toString();SVGPolylineElement=document.createElementNS('http://www.w3.org/2000/svg','polyline').toString();SVGPolygonElement=document.createElementNS('http://www.w3.org/2000/svg','polygon').toString();}}
ORYX.Editor.checkClassType=function(classInst,classType){if(ORYX.Editor.SVGClassElementsAreAvailable){return classInst instanceof classType}else{return classInst==classType}};ORYX.Editor.makeExtModalWindowKeysave=function(facade){Ext.override(Ext.Window,{beforeShow:function(){delete this.el.lastXY;delete this.el.lastLT;if(this.x===undefined||this.y===undefined){var xy=this.el.getAlignToXY(this.container,'c-c');var pos=this.el.translatePoints(xy[0],xy[1]);this.x=this.x===undefined?pos.left:this.x;this.y=this.y===undefined?pos.top:this.y;}
this.el.setLeftTop(this.x,this.y);if(this.expandOnShow){this.expand(false);}
if(this.modal){facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);Ext.getBody().addClass("x-body-masked");this.mask.setSize(Ext.lib.Dom.getViewWidth(true),Ext.lib.Dom.getViewHeight(true));this.mask.show();}},afterHide:function(){this.proxy.hide();if(this.monitorResize||this.modal||this.constrain||this.constrainHeader){Ext.EventManager.removeResizeListener(this.onWindowResize,this);}
if(this.modal){this.mask.hide();facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);Ext.getBody().removeClass("x-body-masked");}
if(this.keyMap){this.keyMap.disable();}
this.fireEvent("hide",this);},beforeDestroy:function(){if(this.modal)
facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);Ext.destroy(this.resizer,this.dd,this.proxy,this.mask);Ext.Window.superclass.beforeDestroy.call(this);}});}
ORYX.FlowEditorView=Clazz.extend({parent:null,title:null,_isEditing:false,_dirty:false,_panel:null,_topEditor:null,_flowDefinitionCache:null,_flowDefinition:null,_svgRepresentation:null,_embeddedFlowChildNodes:null,_children:null,construct:function(flowDefinition,title,parent,topEditor,lazyPanelCreate){this.parent=parent;this.title=title;this._topEditor=topEditor;this._flowDefinition=flowDefinition;this._children={};this._updateCache(this._flowDefinition);if(!lazyPanelCreate)
this._createPanel();},setTitle:function(title){this.title=title;if(this._panel){this._panel.setTitle(title);}},setFlowDefinition:function(flowDefinition){this._clearFlowDefinition();this._flowDefinition=flowDefinition;this._updateCache(this._flowDefinition);if(this.isCurrentlyEditing()){this._displayFlow();}},createChildContainerEditor:function(node,title,nodeProperty,lazyPanelCreate){if(this._children[node.resourceId]){var child=this._children[node.resourceId];if(title)
child.setTitle(title);if(!lazyPanelCreate)
child._createPanel();return child;}
var childEditor=new ORYX.FlowContainerNodeEditor(node,this,nodeProperty,title,this._topEditor,lazyPanelCreate);this._children[node.resourceId]=childEditor;return childEditor;},getChildContainerEditor:function(node){return this._children[node.resourceId];},isDirty:function(){return this._dirty;},clean:function(){if(!this.isCurrentlyEditing()){this._dirty=false;}
for(var id in this._children){var childEditor=this._children[id];childEditor.clean();}},getID:function(){return id;},closeEditor:function(closeChildEditors){var childrenClosed=false;if(closeChildEditors){for(var id in this._children){var childEditor=this._children[id];if(childEditor.closeEditor(true))
childrenClosed=true;}}
if(!this.parent||!this._panel){return childrenClosed;}
this._topEditor._editorTabPanel.remove(this._panel);return true;},addShapesFromModel:function(model){if(this.isCurrentlyEditing()){return this._loadModelIntoCanvas(model);}else{}},getEditorForShape:function(resourceID){if(resourceID==null)
return null;if(this.isCurrentlyEditing()){var canvas=this._topEditor.getCanvas();if(canvas.getShape(resourceID)!=null)
return this;}else{if(this._getNode(resourceID))
return this;}
for(var id in this._children){var childEditor=this._children[id];var shapeEditor=childEditor.getEditorForShape(resourceID);if(shapeEditor!=null)
return shapeEditor;}
var embeddableChildNodes=this._getEmbeddableFlowChildNodes();if(embeddableChildNodes){var x=0,numNodes=embeddableChildNodes.length;for(;x<numNodes;x++){var node=embeddableChildNodes[x];if(!this._children[node.resourceId]){var flowSubviewName=node.properties["displayname"];if(flowSubviewName==null||flowSubviewName===""){flowSubviewName=node.properties["name"];}
var childEditor=this.createChildContainerEditor(node,flowSubviewName,null,true);var shapeEditor=childEditor.getEditorForShape(resourceID);if(shapeEditor){shapeEditor._createPanel();return shapeEditor;}else{delete this._children[node.resourceId];}}}}
return null;},isCurrentlyEditing:function(){return this._isEditing;},setAsActiveEditor:function(){if(!this._panel)
this._createPanel();if(this._panel)
this._topEditor._editorTabPanel.activate(this._panel);},beginEditing:function(){if(this.isCurrentlyEditing())
return;if(this._topEditor._editorTabPanel.getActiveTab()!=this._panel){this.setAsActiveEditor();return;}
this._createPanel();this._displayFlow();},endEditing:function(){if(!this.isCurrentlyEditing())
return;this._serializeCanvas();this._topEditor._clearCanvas();this._isEditing=false;},getSVGRepresentation:function(){if(this.isCurrentlyEditing())
this._serializeCanvas();if(this._svgRepresentation==null)
return this._getEmptySVGRepresentation();var childSVGs={};for(var x=0;x<this._embeddedFlowChildNodes.length;x++){var childID=this._embeddedFlowChildNodes[x];var childEditor=this._children[childID];childSVGs[childID]=childEditor?childEditor.getSVGRepresentation():this._getEmptySVGRepresentation();}
return{"svg":DataManager.serialize(this._svgRepresentation),"children":childSVGs};},toJSON:function(encoded){if(this.isCurrentlyEditing()){this._serializeCanvas();}
for(var id in this._children){var childEditor=this._children[id];var node=this._getNode(id);if(node)
node.properties["flowdefinition"]=childEditor.toJSON(true);}
var encodedDefinition=Ext.encode(this._flowDefinitionCache);if(encoded)
return encodedDefinition
return Ext.decode(encodedDefinition);},getPanel:function(){return this._panel;},_clearFlowDefinition:function(){this._dirty=false;this._flowDefinitionCache=null;this._flowDefinition=null;this._svgRepresentation=null;this._embeddedFlowChildNodes=null;if(this._children){for(var id in this._children){var child=this._children[id];if(child)
child.closeEditor();delete this._children[id];}}
this._children={};},_isEmbeddedFlowNode:function(node){if(!node)
return false;var stencil=null;if(node.getStencil)
stencil=node.getStencil();else if(node.stencil){stencil=ORYX.Core.StencilSet.stencil(this._getCurrentStencilSet().namespace()+node.stencil.id);}else{return false;}
return stencil.roles().member(stencil.namespace()+"EmbeddedFlowContainer");},_serializeCanvas:function(){var canvas=this._topEditor.getCanvas();this._svgRepresentation=canvas.getSVGRepresentation(true);this._embeddedFlowChildNodes=[];canvas.nodes.each(function(shape){if(this._isEmbeddedFlowNode(shape)){this._embeddedFlowChildNodes.push(shape.resourceId);}}.bind(this));var flowDefinition=canvas.toJSON();this._updateCache(flowDefinition);},_getEmptySVGRepresentation:function(){return{"svg":""};},_getNode:function(resourceID){if(!this._flowDefinitionCache)
return null;var shapes=this._flowDefinitionCache.childShapes;if(shapes){var node=null;for(var x=0;x<shapes.length;x++){if(shapes[x].resourceId==resourceID)
return shapes[x];}}
return null;},_getCurrentStencilSet:function(){var canvas=this._topEditor.getCanvas();return canvas.getStencil();},_getEmbeddableFlowChildNodes:function(){if(!this._flowDefinitionCache)
return null;var shapes=this._flowDefinitionCache.childShapes;var node=null;var embeddableFlowChildNodes=[];for(var x=0;x<shapes.length;x++){if(this._isEmbeddedFlowNode(shapes[x]))
embeddableFlowChildNodes.push(shapes[x]);}
return embeddableFlowChildNodes;},_displayFlow:function(){if(this._flowDefinitionCache){this._topEditor._clearCanvas();var model={};for(var prop in this._flowDefinitionCache){model[prop]=this._flowDefinitionCache[prop];}
this._loadModelIntoCanvas(model);var canvas=this._topEditor.getCanvas();canvas.update();canvas.updateSize();}
this._isEditing=true;this._dirty=true;this._topEditor.handleEvents({type:ORYX.CONFIG.EVENT_FLOWEDITOR_FLOW_CHANGE});},_loadModelIntoCanvas:function(model){var canvas=this._topEditor.getCanvas();this._topEditor.loadSSExtensions(model.ssextensions);var childShapes=model.childShapes;var shapes=canvas.addShapeObjects(childShapes,this._topEditor.handleEvents.bind(this._topEditor));if(model.properties){for(key in model.properties){var prop=model.properties[key];if(!(typeof prop==="string")){prop=Ext.encode(prop);}
canvas.setProperty("oryx-"+key,prop);}}
canvas.updateSize();return shapes;},_createPanel:function(){if(this._panel)
return false;var el=null;var closeable=true;var style=null;if(!this.parent){el=this._topEditor.getCanvas().rootNode.parentNode;closeable=false;style="position:relative";}
var panelEl=new Ext.Element(document.createElement("div"));this._panel=new Ext.Panel({closable:closeable,title:this._getUniqueTitle(),cls:'x-panel-editor-center',layout:"fit",autoHeight:true,el:panelEl,style:style,listeners:{"activate":function(self){this.beginEditing();}.bind(this),"deactivate":function(self){this.endEditing();}.bind(this)}});if(el){panelEl.appendChild(el);}
this._panel.editor=this;this._topEditor._editorTabPanel.add(this._panel);this._topEditor._editorTabPanel.on({"beforeremove":function(container,tab){if(tab.editor!=this){return true;}
this.endEditing();this._panel=null;return true;}.bind(this)});return true;},_isPanelTitleUnique:function(title){var items=this._topEditor._editorTabPanel.items;if(!items){return true;}
var count=items.getCount();for(var x=0;x<count;x++){if(title===items.get(x).title)
return false;}
return true;},_getUniqueTitle:function(){var uniqueTitle=this.title;var editor=this;var count=1;var precountUniqueTitle=null;while(!this._isPanelTitleUnique(uniqueTitle)){editor=editor.parent;if(!editor){if(!precountUniqueTitle)
precountUniqueTitle=uniqueTitle;uniqueTitle=precountUniqueTitle+"("+count+")"
count++;}else{uniqueTitle=editor.title+ORYX.FlowEditorView.TITLE_SEPARATOR+uniqueTitle;}}
return uniqueTitle;},_updateCache:function(flowDef){var cache={};this._flowDefinitionCache={};for(var x in flowDef){this._flowDefinitionCache[x]=flowDef[x];}}});ORYX.FlowEditorView.TITLE_SEPARATOR="::";ORYX.FlowContainerNodeEditor=ORYX.FlowEditorView.extend({node:null,construct:function(node,parent,nodeProperty,title,topEditor,lazyPanelCreate){if(!nodeProperty)
nodeProperty="flowdefinition";var flowDefinition=null;if(node.properties["oryx-"+nodeProperty])
flowDefinition=Ext.decode(node.properties["oryx-"+nodeProperty]);else if(node.properties[nodeProperty])
flowDefinition=Ext.decode(node.properties[nodeProperty]);this.node=node;arguments.callee.$.construct.call(this,flowDefinition,title,parent,topEditor,lazyPanelCreate);}});ORYX.Editor.CanvasTabPanel=Ext.extend(Ext.TabPanel,{initComponent:function(){ORYX.Editor.CanvasTabPanel.superclass.initComponent.call(this);this.setLayout(new Ext.layout.SinglePanelCardLayout({deferredRender:this.deferredRender}));}});Ext.onReady(function(){RepositoryCore=window.opener.RepositoryCore;RepositoryClipBoard=window.opener.RepositoryClipBoard;RepositoryCookie=window.opener.RepositoryCookie;});var $j=jQuery.noConflict();if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
ORYX.Core.UIEnableDrag=function(event,uiObj,option){this.uiObj=uiObj;var upL=uiObj.bounds.upperLeft();var a=uiObj.node.getScreenCTM();this.faktorXY={x:a.a,y:a.d};this.scrollNode=uiObj.node.ownerSVGElement.parentNode.parentNode;this.offSetPosition={x:Event.pointerX(event)-(upL.x*this.faktorXY.x),y:Event.pointerY(event)-(upL.y*this.faktorXY.y)};this.offsetScroll={x:this.scrollNode.scrollLeft,y:this.scrollNode.scrollTop};this.dragCallback=ORYX.Core.UIDragCallback.bind(this);this.disableCallback=ORYX.Core.UIDisableDrag.bind(this);this.movedCallback=option?option.movedCallback:undefined;this.upCallback=option?option.upCallback:undefined;document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.disableCallback,true);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.dragCallback,false);};ORYX.Core.UIDragCallback=function(event){var position={x:Event.pointerX(event)-this.offSetPosition.x,y:Event.pointerY(event)-this.offSetPosition.y}
position.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;position.y-=this.offsetScroll.y-this.scrollNode.scrollTop;position.x/=this.faktorXY.x;position.y/=this.faktorXY.y;this.uiObj.bounds.moveTo(position);if(this.movedCallback)
this.movedCallback(event);Event.stop(event);};ORYX.Core.UIDisableDrag=function(event){document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.dragCallback,false);document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.disableCallback,true);if(this.upCallback)
this.upCallback(event);this.upCallback=undefined;this.movedCallback=undefined;Event.stop(event);};if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
ORYX.Core.Shape={construct:function(options,stencil){arguments.callee.$.construct.apply(this,arguments);this.dockers=[];this.magnets=[];this._defaultMagnet;this.incoming=[];this.outgoing=[];this.nodes=[];this.swimlanes=[];this._dockerChangedCallback=this._dockerChanged.bind(this);this._labels=new Hash();this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,['g',{id:this.id},['g',{"class":"stencils"},['g',{"class":"me"}],['g',{"class":"children",style:"overflow:hidden"}],['g',{"class":"edge"}]],['g',{"class":"controls"},['g',{"class":"dockers"}],['g',{"class":"magnets"}]]]);this.poolDivided=false;},update:function(){},_update:function(){},refresh:function(){ORYX.Log.trace("ORYX.Core.Shape.refresh::Begin");arguments.callee.$.refresh.apply(this,arguments);if(this.node.ownerDocument){var me=this;this.propertiesChanged.each((function(propChanged){if(propChanged.value){var prop=this.properties[propChanged.key];var property=this.getStencil().property(propChanged.key);if(property===undefined&&/level\d+$/.test(propChanged.key)){var id=propChanged.key.substr(5);var matches=/^level(\d+)$/.exec(id);if(matches){var level=matches[1];var stencil=this.getStencil();var levelProp={id:id,type:ORYX.CONFIG.TYPE_CHOICE,hierarchy:parseInt(level)-1,title:"Level "+level,value:"",description:"Level "+level+" Problem type",readonly:false,optional:false,refToView:"",items:[]}
property=new ORYX.Core.StencilSet.Property(levelProp,stencil._namespace,stencil);}}
this.propertiesChanged[propChanged.key]=false;if(property.type()==ORYX.CONFIG.TYPE_CHOICE){var refreshedSvgElements=new Hash();property.refToView().each((function(ref){if(ref!==""){var label=this._labels[this.id+ref];if(label){var labelText=null;var propObj=property.item(prop);if(propObj==null)
labelText=prop;else
labelText=propObj.title();label.text(labelText);}
var svgElem=this.node.ownerDocument.getElementById(this.id+ref);svgElem.setAttributeNS(null,'display',(prop!=="")?'inherit':'none');refreshedSvgElements[svgElem.id]=svgElem;}}).bind(this));property.items().each((function(item){if(property.id()=="cancelactivity"||property.id()=="isinterrupting"){me.refreshInterruptingSvg(prop);}
item.refToView().each((function(itemRef){if(itemRef==""){this.propertiesChanged[propChanged.key]=true;return;}
var svgElem=this.node.ownerDocument.getElementById(this.id+itemRef);if(!svgElem){this.propertiesChanged[propChanged.key]=true;return;}
if(!refreshedSvgElements[svgElem.id]||prop==item.value()){svgElem.setAttributeNS(null,'display',((prop==item.value())?'inherit':'none'));refreshedSvgElements[svgElem.id]=svgElem;}
if(ORYX.Editor.checkClassType(svgElem,SVGImageElement)){svgElem.setAttributeNS('http://www.w3.org/1999/xlink','href',svgElem.getAttributeNS('http://www.w3.org/1999/xlink','href'));}}).bind(this));}).bind(this));if(Object.getOwnPropertyNames(property._valuesByChannel).length!==0&&prop!==""){var valuesByChannel=Ext.decode(prop);for(var channel in valuesByChannel){me.setChannelsBasedPropetyValues(propChanged.key,channel,valuesByChannel[channel]);}}}else{if(property.id()=="isforcompensation"){ORYX.Plugins.ShapeMenuPlugin.handleCompensationProperty(prop);}
if(property.id()=="cancelactivity"||property.id()=="isinterrupting"){me.refreshInterruptingSvg(prop);}else{property.refToView().each((function(ref){if(ref===""){this.propertiesChanged[propChanged.key]=true;return;}
var refId=this.id+ref;var svgElem=this.node.ownerDocument.getElementById(refId);if(!svgElem||!(svgElem.ownerSVGElement)){if(property.type()===ORYX.CONFIG.TYPE_URL||property.type()===ORYX.CONFIG.TYPE_DIAGRAM_LINK){var svgElems=this.node.ownerDocument.getElementsByTagNameNS('http://www.w3.org/2000/svg','a');svgElem=$A(svgElems).find(function(elem){return elem.getAttributeNS(null,'id')===refId;});if(!svgElem){this.propertiesChanged[propChanged.key]=true;return;}}else{this.propertiesChanged[propChanged.key]=true;return;}}
if(property.complexAttributeToView()){var label=this._labels[refId];if(label){try{propJson=prop.evalJSON();var value=propJson[property.complexAttributeToView()]
label.text(value?value:prop);}catch(e){label.text(prop);}}}else{switch(property.type()){case ORYX.CONFIG.TYPE_BOOLEAN:if(typeof prop=="string")
prop=(prop==="true"||prop==="Default");svgElem.setAttributeNS(null,'display',(!(prop===property.inverseBoolean()))?'inherit':'none');break;case ORYX.CONFIG.TYPE_MODEL_INPUT:if(typeof prop=="string")
prop=prop.length>0;svgElem.setAttributeNS(null,'display',(!(prop===property.inverseBoolean()))?'inherit':'none');break;case ORYX.CONFIG.TYPE_COLOR:if(property.fill()){var oryxId=this.id;var stops=$A(svgElem.parentNode.getElementsByTagName('stop'));if(stops.length){stops.each(function(stop){var stopId=stop.getAttributeNS(null,'id');if(stop.getAttributeNS(null,'id')==oryxId+"fill_el")
stop.setAttributeNS(null,"stop-color",prop);});}else if(svgElem.tagName.toLowerCase()==="stop"){svgElem.setAttributeNS(null,"stop-color",prop);if(svgElem.parentNode.tagName.toLowerCase()==="radialgradient"){ORYX.Utils.adjustGradient(svgElem.parentNode,svgElem);}}else{svgElem.setAttributeNS(null,'fill',prop);}}
if(property.stroke()){svgElem.setAttributeNS(null,'stroke',prop);}
break;case ORYX.CONFIG.TYPE_STRING:var label=this._labels[refId];if(label){label.text(prop);}
break;case ORYX.CONFIG.TYPE_HTML_MIN:if(/({["]locale["]:["][a-zA-Z!_-]+["],["]value["]:["].+?(?=")["]})+,*/.test(prop)){var defaultObj=Ext.util.JSON.decode(prop).values.filter(function(obj){return obj.locale=='!!';});prop=(defaultObj[0]!==undefined)?defaultObj[0].value:prop;}
var label=this._labels[refId];if(label){label.text(prop);}
break;case ORYX.CONFIG.TYPE_INTEGER:var label=this._labels[refId];if(label){label.text(prop);}
break;case ORYX.CONFIG.TYPE_FLOAT:if(property.fillOpacity()){svgElem.setAttributeNS(null,'fill-opacity',prop);}
if(property.strokeOpacity()){svgElem.setAttributeNS(null,'stroke-opacity',prop);}
if(!property.fillOpacity()&&!property.strokeOpacity()){var label=this._labels[refId];if(label){label.text(prop);}}
break;case ORYX.CONFIG.TYPE_URL:case ORYX.CONFIG.TYPE_DIAGRAM_LINK:var hrefAttr=svgElem.getAttributeNodeNS('http://www.w3.org/1999/xlink','xlink:href');if(hrefAttr){hrefAttr.textContent=prop;}else{svgElem.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href',prop);}
break;}}}).bind(this));}}}}).bind(this));this._labels.values().each(function(label){if(/.*title$/.test(label.id)&&ORYX.Plugins.LanguageSelectorPlugin!==undefined){label.text(ORYX.Plugins.LanguageSelectorPlugin.getLabelText(this,"oryx-displayname"));}
label.update();}.bind(this));}},refreshInterruptingSvg:function(prop){var svgElems=this.node.ownerDocument.getElementsByTagNameNS('http://www.w3.org/2000/svg','circle');var isInterrupting=prop;if(typeof prop=='string'){isInterrupting=(/^(yes|true)$/i.test(prop));}
for(var i=0;i<svgElems.length;i++){var node=svgElems[i];if(node.getAttributeNS(null,'id')===this.id+"frame"){if(!isInterrupting){node.setAttributeNS(null,'fill','url(#background) white');node.setAttributeNS(null,'style','stroke-dasharray: 5.5, 3');}else if(isInterrupting){node.setAttributeNS(null,'fill','none');node.setAttributeNS(null,'style','none');}}
if(node.getAttributeNS(null,'id')===this.id+"frame2"){if(!isInterrupting){node.setAttributeNS(null,'style','stroke-dasharray: 4.5, 3');}else if(isInterrupting){node.setAttributeNS(null,'style','none');}}}},layout:function(){var layoutEvents=this.getStencil().layout()
if(this instanceof ORYX.Core.Node&&layoutEvents){layoutEvents.each(function(event){event.shape=this;event.forceExecution=true;this._delegateEvent(event);}.bind(this))}},getLabels:function(){return this._labels.values();},getDockers:function(){return this.dockers;},getMagnets:function(){return this.magnets;},getDefaultMagnet:function(){if(this._defaultMagnet){return this._defaultMagnet;}else if(this.magnets.length>0){return this.magnets[0];}else{return undefined;}},getParentShape:function(){return this.parent;},getIncomingShapes:function(iterator){if(iterator){this.incoming.each(iterator);}
return this.incoming;},getIncomingNodes:function(iterator){return this.incoming.select(function(incoming){var isNode=(incoming instanceof ORYX.Core.Node);if(isNode&&iterator)iterator(incoming);return isNode;});},getOutgoingShapes:function(iterator){if(iterator){this.outgoing.each(iterator);}
return this.outgoing;},getOutgoingNodes:function(iterator){return this.outgoing.select(function(out){var isNode=(out instanceof ORYX.Core.Node);if(isNode&&iterator)iterator(out);return isNode;});},getAllDockedShapes:function(iterator){var result=this.incoming.concat(this.outgoing);if(iterator){result.each(iterator);}
return result},getCanvas:function(){if(this.parent instanceof ORYX.Core.Canvas){return this.parent;}else if(this.parent instanceof ORYX.Core.Shape){return this.parent.getCanvas();}else{return undefined;}},getChildNodes:function(deep,iterator){if(!deep&&!iterator){return this.nodes.clone();}else{var result=[];this.nodes.each(function(uiObject){if(!uiObject.isVisible){return}
if(iterator){iterator(uiObject);}
result.push(uiObject);if(deep&&uiObject instanceof ORYX.Core.Shape){result=result.concat(uiObject.getChildNodes(deep,iterator));}});return result;}},isPoolDivided:function(){return this.poolDivided;},setPoolDivided:function(bool){this.poolDivided=bool;},add:function(uiObject,index){if(uiObject instanceof ORYX.Core.UIObject&&!(uiObject instanceof ORYX.Core.Edge)){if(!(this.children.member(uiObject))){if(uiObject.parent){uiObject.parent.remove(uiObject);}
if(index!=undefined)
this.children.splice(index,0,uiObject);else
this.children.push(uiObject);uiObject.parent=this;var parent;if(uiObject instanceof ORYX.Core.Node){parent=this.node.childNodes[0].childNodes[1];this.nodes.push(uiObject);}else if(uiObject instanceof ORYX.Core.Controls.Control){var ctrls=this.node.childNodes[1];if(uiObject instanceof ORYX.Core.Controls.Docker){parent=ctrls.childNodes[0];if(this.dockers.length>=2){this.dockers.splice(index!==undefined?Math.min(index,this.dockers.length-1):this.dockers.length-1,0,uiObject);}else{this.dockers.push(uiObject);}}else if(uiObject instanceof ORYX.Core.Controls.Magnet){parent=ctrls.childNodes[1];this.magnets.push(uiObject);}else{parent=ctrls;}}else{parent=this.node;}
if(index!=undefined&&index<parent.childNodes.length)
uiObject.node=parent.insertBefore(uiObject.node,parent.childNodes[index]);else
uiObject.node=parent.appendChild(uiObject.node);this._changed();if(this.eventHandlerCallback)
this.eventHandlerCallback({type:ORYX.CONFIG.EVENT_SHAPEADDED,shape:uiObject})}else{ORYX.Log.warn("add: ORYX.Core.UIObject is already a child of this object.");}}else{ORYX.Log.warn("add: Parameter is not of type ORYX.Core.UIObject.");}},addSwimlane:function(lane){this.swimlanes.push(lane);},getSwimlanes:function(){return this.swimlanes;},remove:function(uiObject){if(this.children.member(uiObject)){this.children=this.children.without(uiObject);uiObject.parent=undefined;if(uiObject instanceof ORYX.Core.Shape){if(uiObject instanceof ORYX.Core.Edge){uiObject.removeMarkers();uiObject.node=this.node.childNodes[0].childNodes[2].removeChild(uiObject.node);}else{uiObject.node=this.node.childNodes[0].childNodes[1].removeChild(uiObject.node);this.nodes=this.nodes.without(uiObject);}}else if(uiObject instanceof ORYX.Core.Controls.Control){if(uiObject instanceof ORYX.Core.Controls.Docker){uiObject.node=this.node.childNodes[1].childNodes[0].removeChild(uiObject.node);this.dockers=this.dockers.without(uiObject);}else if(uiObject instanceof ORYX.Core.Controls.Magnet){uiObject.node=this.node.childNodes[1].childNodes[1].removeChild(uiObject.node);this.magnets=this.magnets.without(uiObject);}else{uiObject.node=this.node.childNodes[1].removeChild(uiObject.node);}}
this._changed();}else{ORYX.Log.warn("remove: ORYX.Core.UIObject is not a child of this object.");}},getIntersectionPoint:function(){var pointAX,pointAY,pointBX,pointBY;switch(arguments.length){case 2:pointAX=arguments[0].x;pointAY=arguments[0].y;pointBX=arguments[1].x;pointBY=arguments[1].y;break;case 4:pointAX=arguments[0];pointAY=arguments[1];pointBX=arguments[2];pointBY=arguments[3];break;default:throw"getIntersectionPoints needs two or four arguments";}
var includePointX,includePointY,excludePointX,excludePointY;var bounds=this.absoluteBounds();if(this.isPointIncluded(pointAX,pointAY,bounds)){includePointX=pointAX;includePointY=pointAY;}else{excludePointX=pointAX;excludePointY=pointAY;}
if(this.isPointIncluded(pointBX,pointBY,bounds)){includePointX=pointBX;includePointY=pointBY;}else{excludePointX=pointBX;excludePointY=pointBY;}
if(!includePointX||!includePointY||!excludePointX||!excludePointY){return undefined;}
var midPointX=0;var midPointY=0;var refPointX,refPointY;var minDifferent=1;var i=0;while(true){var minX=Math.min(includePointX,excludePointX);var minY=Math.min(includePointY,excludePointY);midPointX=Math.round(minX+((Math.max(includePointX,excludePointX)-minX)/2.0));midPointY=Math.round(minY+((Math.max(includePointY,excludePointY)-minY)/2.0));if(this.isPointIncluded(midPointX,midPointY,bounds)){includePointX=midPointX;includePointY=midPointY;}else{excludePointX=midPointX;excludePointY=midPointY;}
var length=Math.sqrt(Math.pow(includePointX-excludePointX,2)+Math.pow(includePointY-excludePointY,2))
refPointX=Math.round(includePointX+((excludePointX-includePointX)/length));refPointY=Math.round(includePointY+((excludePointY-includePointY)/length));if(!this.isPointIncluded(refPointX,refPointY,bounds)){break}}
return{x:refPointX,y:refPointY};},isPointIncluded:function(){return false},isPointOverOffset:function(){return this.isPointIncluded.apply(this,arguments)},_dockerChanged:function(){},createDocker:function(index,position){var docker=new ORYX.Core.Controls.Docker({eventHandlerCallback:this.eventHandlerCallback});docker.bounds.registerCallback(this._dockerChangedCallback);if(position){docker.bounds.centerMoveTo(position);}
this.add(docker,index);return docker},serialize:function(){var serializedObject=arguments.callee.$.serialize.apply(this);serializedObject.push({name:'bounds',prefix:'oryx',value:this.bounds.serializeForERDF(),type:'literal'});this.getOutgoingShapes().each((function(followingShape){serializedObject.push({name:'outgoing',prefix:'raziel',value:'#'+ERDF.__stripHashes(followingShape.resourceId),type:'resource'});}).bind(this));serializedObject.push({name:'parent',prefix:'raziel',value:'#'+ERDF.__stripHashes(this.parent.resourceId),type:'resource'});return serializedObject;},deserialize:function(serialze){arguments.callee.$.deserialize.apply(this,arguments);var bounds=serialze.find(function(ser){return(ser.prefix+"-"+ser.name)=='oryx-bounds'});if(bounds){var b=bounds.value.replace(/,/g," ").split(" ").without("");if(this instanceof ORYX.Core.Edge){this.dockers.first().bounds.centerMoveTo(parseFloat(b[0]),parseFloat(b[1]));this.dockers.last().bounds.centerMoveTo(parseFloat(b[2]),parseFloat(b[3]));}else{this.bounds.set(parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2]),parseFloat(b[3]));}}},_init:function(svgDocument){this._adjustIds(svgDocument,0);},_adjustIds:function(element,idIndex){if(element instanceof Element){var eid=element.getAttributeNS(null,'id');if(eid&&eid!==""){element.setAttributeNS(null,'id',this.id+eid);}else{element.setAttributeNS(null,'id',this.id+"_"+this.id+"_"+idIndex);idIndex++;}
var fill=element.getAttributeNS(null,'fill');if(fill&&fill.include("url(#")){fill=fill.replace(/url\(#/g,'url(#'+this.id);element.setAttributeNS(null,'fill',fill);}
if(element.hasChildNodes()){for(var i=0;i<element.childNodes.length;i++){idIndex=this._adjustIds(element.childNodes[i],idIndex);}}}
return idIndex;},toString:function(){return"ORYX.Core.Shape "+this.getId()}};ORYX.Core.Shape=ORYX.Core.AbstractShape.extend(ORYX.Core.Shape);if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.Controls){ORYX.Core.Controls={};}
ORYX.Core.Controls.Control=ORYX.Core.UIObject.extend({toString:function(){return"Control "+this.id;}});if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.Controls){ORYX.Core.Controls={};}
ORYX.Core.Controls.Docker=ORYX.Core.Controls.Control.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.isMovable=true;this.bounds.set(0,0,16,16);this.referencePoint=undefined;this._dockedShapeBounds=undefined;this._dockedShape=undefined;this._oldRefPoint1=undefined;this._oldRefPoint2=undefined;this.anchorLeft;this.anchorRight;this.anchorTop;this.anchorBottom;this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,['g']);this._dockerNode=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,['g',{"pointer-events":"all"},['circle',{cx:"8",cy:"8",r:"8",stroke:"none",fill:"none"}],['circle',{cx:"8",cy:"8",r:"3",stroke:"black",fill:"red","stroke-width":"1"}]]);this._referencePointNode=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,['g',{"pointer-events":"none"},['circle',{cx:this.bounds.upperLeft().x,cy:this.bounds.upperLeft().y,r:3,fill:"red","fill-opacity":0.4}]]);this.hide();this.addEventHandlers(this.node);this._updateCallback=this._changed.bind(this);},update:function(){if(this._dockedShape){if(this._dockedShapeBounds&&this._dockedShape instanceof ORYX.Core.Node){var dswidth=this._dockedShapeBounds.width();var dsheight=this._dockedShapeBounds.height();if(!dswidth)
dswidth=1;if(!dsheight)
dsheight=1;var widthDelta=this._dockedShape.bounds.width()/dswidth;var heightDelta=this._dockedShape.bounds.height()/dsheight;if(widthDelta!==1.0||heightDelta!==1.0){this.referencePoint.x*=widthDelta;this.referencePoint.y*=heightDelta;}
this._dockedShapeBounds=this._dockedShape.bounds.clone();}
var dockerIndex=this.parent.dockers.indexOf(this)
var dock1=this;var dock2=this.parent.dockers.length>1?(dockerIndex===0?this.parent.dockers[dockerIndex+1]:this.parent.dockers[dockerIndex-1]):undefined;var absoluteReferenzPoint1=dock1.getDockedShape()?dock1.getAbsoluteReferencePoint():dock1.bounds.center();var absoluteReferenzPoint2=dock2&&dock2.getDockedShape()?dock2.getAbsoluteReferencePoint():dock2?dock2.bounds.center():undefined;if(!absoluteReferenzPoint2){var center=this._dockedShape.absoluteCenterXY();var minDimension=this._dockedShape.bounds.width()*this._dockedShape.bounds.height();absoluteReferenzPoint2={x:absoluteReferenzPoint1.x+(center.x-absoluteReferenzPoint1.x)* -minDimension,y:absoluteReferenzPoint1.y+(center.y-absoluteReferenzPoint1.y)* -minDimension}}
var newPoint=undefined;newPoint=this._dockedShape.getIntersectionPoint(absoluteReferenzPoint1,absoluteReferenzPoint2);if(!newPoint){newPoint=this.getAbsoluteReferencePoint();}
if(this.parent&&this.parent.parent){var grandParentPos=this.parent.parent.absoluteXY();newPoint.x-=grandParentPos.x;newPoint.y-=grandParentPos.y;}
this.bounds.centerMoveTo(newPoint)
this._oldRefPoint1=absoluteReferenzPoint1;this._oldRefPoint2=absoluteReferenzPoint2;}
arguments.callee.$.update.apply(this,arguments);},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var p=this.bounds.upperLeft();this._dockerNode.setAttributeNS(null,'transform','translate('+p.x+', '+p.y+')');p=Object.clone(this.referencePoint);if(p&&this._dockedShape){var upL
if(this.parent instanceof ORYX.Core.Edge){upL=this._dockedShape.absoluteXY();}else{upL=this._dockedShape.bounds.upperLeft();}
p.x+=upL.x;p.y+=upL.y;}else{p=this.bounds.center();}
this._referencePointNode.setAttributeNS(null,'transform','translate('+p.x+', '+p.y+')');},setReferencePoint:function(point){if(this.referencePoint!==point&&(!this.referencePoint||!point||this.referencePoint.x!==point.x||this.referencePoint.y!==point.y)){this.referencePoint=point;this._changed();}},getAbsoluteReferencePoint:function(){if(!this.referencePoint||!this._dockedShape){return undefined;}else{var absUL=this._dockedShape.absoluteXY();return{x:this.referencePoint.x+absUL.x,y:this.referencePoint.y+absUL.y}}},setDockedShape:function(shape){if(this._dockedShape){this._dockedShape.bounds.unregisterCallback(this._updateCallback)
if(this===this.parent.dockers.first()){this.parent.incoming=this.parent.incoming.without(this._dockedShape);this._dockedShape.outgoing=this._dockedShape.outgoing.without(this.parent);}else if(this===this.parent.dockers.last()){this.parent.outgoing=this.parent.outgoing.without(this._dockedShape);this._dockedShape.incoming=this._dockedShape.incoming.without(this.parent);}}
this._dockedShape=shape;this._dockedShapeBounds=undefined;var referencePoint=undefined;if(this._dockedShape){if(this===this.parent.dockers.first()){this.parent.incoming.push(shape);shape.outgoing.push(this.parent);}else if(this===this.parent.dockers.last()){this.parent.outgoing.push(shape);shape.incoming.push(this.parent);}
var bounds=this.bounds;var absUL=shape.absoluteXY();referencePoint={x:bounds.center().x-absUL.x,y:bounds.center().y-absUL.y}
this._dockedShapeBounds=this._dockedShape.bounds.clone();this._dockedShape.bounds.registerCallback(this._updateCallback);this.setDockerColor(ORYX.CONFIG.DOCKER_DOCKED_COLOR);}else{this.setDockerColor(ORYX.CONFIG.DOCKER_UNDOCKED_COLOR);}
this.setReferencePoint(referencePoint);this._changed();},getDockedShape:function(){return this._dockedShape;},isDocked:function(){return!!this._dockedShape;},setDockerColor:function(color){this._dockerNode.lastChild.setAttributeNS(null,"fill",color);},hide:function(){this.node.setAttributeNS(null,'visibility','hidden');this.children.each(function(uiObj){uiObj.hide();});},show:function(){this.node.setAttributeNS(null,'visibility','visible');this.children.each(function(uiObj){uiObj.show();});},toString:function(){return"Docker "+this.id}});if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
if(!ORYX.Core.Controls){ORYX.Core.Controls={};}
ORYX.Core.Controls.Magnet=ORYX.Core.Controls.Control.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.anchorLeft;this.anchorRight;this.anchorTop;this.anchorBottom;this.bounds.set(0,0,16,16);this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,['g',{"pointer-events":"all"},['circle',{cx:"8",cy:"8",r:"4",stroke:"none",fill:"red","fill-opacity":"0.3"}],]);this.hide();},update:function(){arguments.callee.$.update.apply(this,arguments);},_update:function(){arguments.callee.$.update.apply(this,arguments);},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var p=this.bounds.upperLeft();this.node.setAttributeNS(null,'transform','translate('+p.x+', '+p.y+')');},show:function(){arguments.callee.$.show.apply(this,arguments);},toString:function(){return"Magnet "+this.id;}});if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
ORYX.Core.Node={construct:function(options,stencil){arguments.callee.$.construct.apply(this,arguments);this.isSelectable=true;this.isMovable=true;this._dockerUpdated=false;this._oldBounds=new ORYX.Core.Bounds();this._svgShapes=[];this.minimumSize=undefined;this.maximumSize=undefined;this.isHorizontallyResizable=false;this.isVerticallyResizable=false;this.dataId=undefined;this._init(this._stencil.view());},_update:function(){this.dockers.invoke("update");if(this.isChanged){var bounds=this.bounds;var oldBounds=this._oldBounds;if(this.isResized){var widthDelta=bounds.width()/oldBounds.width();var heightDelta=bounds.height()/oldBounds.height();this._svgShapes.each(function(svgShape){if(svgShape.isHorizontallyResizable){svgShape.width=svgShape.oldWidth*widthDelta;}
if(svgShape.isVerticallyResizable){svgShape.height=svgShape.oldHeight*heightDelta;}
var anchorOffset;var leftIncluded=svgShape.anchorLeft;var rightIncluded=svgShape.anchorRight;if(rightIncluded){anchorOffset=oldBounds.width()-(svgShape.oldX+svgShape.oldWidth);if(leftIncluded){svgShape.width=bounds.width()-svgShape.x-anchorOffset;}
else{svgShape.x=bounds.width()-(anchorOffset+svgShape.width);}}
else
if(!leftIncluded){svgShape.x=widthDelta*svgShape.oldX;if(!svgShape.isHorizontallyResizable){svgShape.x=svgShape.x+svgShape.width*widthDelta/2-svgShape.width/2;}}
var topIncluded=svgShape.anchorTop;var bottomIncluded=svgShape.anchorBottom;if(bottomIncluded){anchorOffset=oldBounds.height()-(svgShape.oldY+svgShape.oldHeight);if(topIncluded){svgShape.height=bounds.height()-svgShape.y-anchorOffset;}
else{if(!svgShape._isYLocked){svgShape.y=bounds.height()-(anchorOffset+svgShape.height);}}}
else
if(!topIncluded){svgShape.y=heightDelta*svgShape.oldY;if(!svgShape.isVerticallyResizable){svgShape.y=svgShape.y+svgShape.height*heightDelta/2-svgShape.height/2;}}});var p={x:0,y:0};if(!this.isHorizontallyResizable&&bounds.width()!==oldBounds.width()){p.x=oldBounds.width()-bounds.width();}
if(!this.isVerticallyResizable&&bounds.height()!==oldBounds.height()){p.y=oldBounds.height()-bounds.height();}
if(p.x!==0||p.y!==0){bounds.extend(p);}
p={x:0,y:0};var widthDifference,heightDifference;if(this.minimumSize){ORYX.Log.debug("Shape (%0)'s min size: (%1x%2)",this,this.minimumSize.width,this.minimumSize.height);widthDifference=this.minimumSize.width-bounds.width();if(widthDifference>0){p.x+=widthDifference;}
heightDifference=this.minimumSize.height-bounds.height();if(heightDifference>0){p.y+=heightDifference;}}
if(this.maximumSize){ORYX.Log.debug("Shape (%0)'s max size: (%1x%2)",this,this.maximumSize.width,this.maximumSize.height);widthDifference=bounds.width()-this.maximumSize.width;if(widthDifference>0){p.x-=widthDifference;}
heightDifference=bounds.height()-this.maximumSize.height;if(heightDifference>0){p.y-=heightDifference;}}
if(p.x!==0||p.y!==0){bounds.extend(p);}
var widthDelta=bounds.width()/oldBounds.width();var heightDelta=bounds.height()/oldBounds.height();var leftIncluded,rightIncluded,topIncluded,bottomIncluded,center,newX,newY;this.magnets.each(function(magnet){leftIncluded=magnet.anchorLeft;rightIncluded=magnet.anchorRight;topIncluded=magnet.anchorTop;bottomIncluded=magnet.anchorBottom;center=magnet.bounds.center();if(leftIncluded){newX=center.x;}
else
if(rightIncluded){newX=bounds.width()-(oldBounds.width()-center.x)}
else{newX=center.x*widthDelta;}
if(topIncluded){newY=center.y;}
else
if(bottomIncluded){newY=bounds.height()-(oldBounds.height()-center.y);}
else{newY=center.y*heightDelta;}
if(center.x!==newX||center.y!==newY){magnet.bounds.centerMoveTo(newX,newY);}});this.getLabels().each(function(label){leftIncluded=label.anchorLeft;rightIncluded=label.anchorRight;topIncluded=label.anchorTop;bottomIncluded=label.anchorBottom;if(leftIncluded){}
else
if(rightIncluded){label.x=bounds.width()-(oldBounds.width()-label.oldX)}
else{label.x*=widthDelta;}
if(topIncluded){}
else
if(bottomIncluded){label.y=bounds.height()-(oldBounds.height()-label.oldY);}
else{label.y*=heightDelta;}});var docker=this.dockers[0];if(docker){docker.bounds.unregisterCallback(this._dockerChangedCallback);if(!this._dockerUpdated){docker.bounds.centerMoveTo(this.bounds.center());this._dockerUpdated=false;}
docker.update();docker.bounds.registerCallback(this._dockerChangedCallback);}
this.isResized=false;}
this.refresh();this.isChanged=false;this._oldBounds=this.bounds.clone();}
this.children.each(function(value){if(!(value instanceof ORYX.Core.Controls.Docker)){value._update();}});if(this.dockers.length>0&&!this.dockers.first().getDockedShape()){this.dockers.each(function(docker){docker.bounds.centerMoveTo(this.bounds.center())}.bind(this))}},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var x=this.bounds.upperLeft().x;var y=this.bounds.upperLeft().y;this.node.firstChild.setAttributeNS(null,"transform","translate("+x+", "+y+")");this.node.childNodes[1].childNodes[1].setAttributeNS(null,"transform","translate("+x+", "+y+")");this._svgShapes.each(function(svgShape){svgShape.update();});},_dockerChanged:function(){var docker=this.dockers[0];this.bounds.centerMoveTo(docker.bounds.center());this._dockerUpdated=true;},_initSVGShapes:function(svgNode){var svgShapes=[];try{var svgShape=new ORYX.Core.SVG.SVGShape(svgNode);svgShapes.push(svgShape);}
catch(e){}
if(svgNode.hasChildNodes()){for(var i=0;i<svgNode.childNodes.length;i++){svgShapes=svgShapes.concat(this._initSVGShapes(svgNode.childNodes[i]));}}
return svgShapes;},_pushSVGShapes:function(svgNode){var shapesToPush=this._initSVGShapes(svgNode);this._svgShapes=this._svgShapes.concat(shapesToPush);},isPointIncluded:function(pointX,pointY,absoluteBounds){var absBounds=absoluteBounds&&absoluteBounds instanceof ORYX.Core.Bounds?absoluteBounds:this.absoluteBounds();if(!absBounds.isIncluded(pointX,pointY)){return false;}else{}
var ul=absBounds.upperLeft();var x=pointX-ul.x;var y=pointY-ul.y;var i=0;do{var isPointIncluded=this._svgShapes[i++].isPointIncluded(x,y);}while(!isPointIncluded&&i<this._svgShapes.length)
return isPointIncluded;},isPointOverOffset:function(pointX,pointY){var isOverEl=arguments.callee.$.isPointOverOffset.apply(this,arguments);if(isOverEl){var absBounds=this.absoluteBounds();absBounds.widen(-ORYX.CONFIG.BORDER_OFFSET);if(!absBounds.isIncluded(pointX,pointY)){return true;}}
return false;},serialize:function(){var result=arguments.callee.$.serialize.apply(this);this.dockers.each((function(docker){if(docker.getDockedShape()){var center=docker.referencePoint;center=center?center:docker.bounds.center();result.push({name:'docker',prefix:'oryx',value:$H(center).values().join(','),type:'literal'});}}).bind(this));try{var serializeEvent=this.getStencil().serialize();if(serializeEvent.type){serializeEvent.shape=this;serializeEvent.data=result;serializeEvent.result=undefined;serializeEvent.forceExecution=true;this._delegateEvent(serializeEvent);if(serializeEvent.result){result=serializeEvent.result;}}}
catch(e){}
return result;},deserialize:function(data){arguments.callee.$.deserialize.apply(this,[data]);try{var deserializeEvent=this.getStencil().deserialize();if(deserializeEvent.type){deserializeEvent.shape=this;deserializeEvent.data=data;deserializeEvent.result=undefined;deserializeEvent.forceExecution=true;this._delegateEvent(deserializeEvent);if(deserializeEvent.result){data=deserializeEvent.result;}}}
catch(e){}
var outgoing=data.findAll(function(ser){return(ser.prefix+"-"+ser.name)=='raziel-outgoing'});outgoing.each((function(obj){if(!this.parent){return};var next=this.getCanvas().getChildShapeByResourceId(obj.value);if(next){if(next instanceof ORYX.Core.Edge){next.dockers.first().setDockedShape(this);next.dockers.first().setReferencePoint(next.dockers.first().bounds.center());}else if(next.dockers.length>0){next.dockers.first().setDockedShape(this);}}}).bind(this));if(this.dockers.length===1){var dockerPos;dockerPos=data.find(function(entry){return(entry.prefix+"-"+entry.name==="oryx-dockers");});if(dockerPos){var points=dockerPos.value.replace(/,/g," ").split(" ").without("").without("#");if(points.length===2&&this.dockers[0].getDockedShape()){this.dockers[0].setReferencePoint({x:parseFloat(points[0]),y:parseFloat(points[1])});}
else{this.dockers[0].bounds.centerMoveTo(parseFloat(points[0]),parseFloat(points[1]));}}}
this.node.childNodes[0].childNodes[0].childNodes[0].setAttributeNS(null,"resourceId",this.resourceId);},_init:function(svgDocument){arguments.callee.$._init.apply(this,arguments);var svgNode=svgDocument.getElementsByTagName("g")[0];var attributeTitle=svgDocument.ownerDocument.createAttributeNS(null,"title");attributeTitle.nodeValue=this.getStencil().title();svgNode.setAttributeNode(attributeTitle);var attributeId=svgDocument.ownerDocument.createAttributeNS(null,"id");attributeId.nodeValue=this.id;svgNode.setAttributeNode(attributeId);var attributeResId=svgDocument.ownerDocument.createAttributeNS(null,"resourceId");attributeResId.nodeValue=this.resourceId;svgNode.setAttributeNode(attributeResId);var stencilTargetNode=this.node.childNodes[0].childNodes[0];svgNode=stencilTargetNode.appendChild(svgNode);this.addEventHandlers(svgNode);var minSizeAttr=svgNode.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"minimumSize");if(minSizeAttr){minSizeAttr=minSizeAttr.replace("/,/g"," ");var minSizeValues=minSizeAttr.split(" ");minSizeValues=minSizeValues.without("");if(minSizeValues.length>1){this.minimumSize={width:parseFloat(minSizeValues[0]),height:parseFloat(minSizeValues[1])};}
else{this.minimumSize={width:1,height:1};}}
var maxSizeAttr=svgNode.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"maximumSize");if(maxSizeAttr){maxSizeAttr=maxSizeAttr.replace("/,/g"," ");var maxSizeValues=maxSizeAttr.split(" ");maxSizeValues=maxSizeValues.without("");if(maxSizeValues.length>1){this.maximumSize={width:parseFloat(maxSizeValues[0]),height:parseFloat(maxSizeValues[1])};}}
if(this.minimumSize&&this.maximumSize&&(this.minimumSize.width>this.maximumSize.width||this.minimumSize.height>this.maximumSize.height)){throw this+": Minimum Size must be greater than maxiumSize.";}
this._svgShapes=this._initSVGShapes(svgNode);var upperLeft={x:undefined,y:undefined};var lowerRight={x:undefined,y:undefined};var me=this;this._svgShapes.each(function(svgShape){upperLeft.x=(upperLeft.x!==undefined)?Math.min(upperLeft.x,svgShape.x):svgShape.x;upperLeft.y=(upperLeft.y!==undefined)?Math.min(upperLeft.y,svgShape.y):svgShape.y;lowerRight.x=(lowerRight.x!==undefined)?Math.max(lowerRight.x,svgShape.x+svgShape.width):svgShape.x+svgShape.width;lowerRight.y=(lowerRight.y!==undefined)?Math.max(lowerRight.y,svgShape.y+svgShape.height):svgShape.y+svgShape.height;if(svgShape.isHorizontallyResizable){me.isHorizontallyResizable=true;me.isResizable=true;}
if(svgShape.isVerticallyResizable){me.isVerticallyResizable=true;me.isResizable=true;}
if(svgShape.anchorTop&&svgShape.anchorBottom){me.isVerticallyResizable=true;me.isResizable=true;}
if(svgShape.anchorLeft&&svgShape.anchorRight){me.isHorizontallyResizable=true;me.isResizable=true;}});this._svgShapes.each(function(svgShape){svgShape.x-=upperLeft.x;svgShape.y-=upperLeft.y;svgShape.update();});var offsetX=upperLeft.x;var offsetY=upperLeft.y;lowerRight.x-=offsetX;lowerRight.y-=offsetY;upperLeft.x=0;upperLeft.y=0;if(lowerRight.x===0){lowerRight.x=1;}
if(lowerRight.y===0){lowerRight.y=1;}
this._oldBounds.set(upperLeft,lowerRight);this.bounds.set(upperLeft,lowerRight);var magnets=svgDocument.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_ORYX,"magnets");if(magnets&&magnets.length>0){magnets=$A(magnets[0].getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_ORYX,"magnet"));var me=this;magnets.each(function(magnetElem){var magnet=new ORYX.Core.Controls.Magnet({eventHandlerCallback:me.eventHandlerCallback});var cx=parseFloat(magnetElem.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cx"));var cy=parseFloat(magnetElem.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cy"));magnet.bounds.centerMoveTo({x:cx-offsetX,y:cy-offsetY});var anchors=magnetElem.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"anchors");if(anchors){anchors=anchors.replace("/,/g"," ");anchors=anchors.split(" ").without("");for(var i=0;i<anchors.length;i++){switch(anchors[i].toLowerCase()){case"left":magnet.anchorLeft=true;break;case"right":magnet.anchorRight=true;break;case"top":magnet.anchorTop=true;break;case"bottom":magnet.anchorBottom=true;break;}}}
me.add(magnet);if(!this._defaultMagnet){var defaultAttr=magnetElem.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"default");if(defaultAttr&&defaultAttr.toLowerCase()==="yes"){me._defaultMagnet=magnet;}}});}
else{var magnet=new ORYX.Core.Controls.Magnet();magnet.bounds.centerMoveTo(this.bounds.width()/2,this.bounds.height()/2);this.add(magnet);}
var dockerElem=svgDocument.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_ORYX,"docker");if(dockerElem&&dockerElem.length>0){dockerElem=dockerElem[0];var docker=this.createDocker();var cx=parseFloat(dockerElem.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cx"));var cy=parseFloat(dockerElem.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cy"));docker.bounds.centerMoveTo({x:cx-offsetX,y:cy-offsetY});var anchors=dockerElem.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"anchors");if(anchors){anchors=anchors.replace("/,/g"," ");anchors=anchors.split(" ").without("");for(var i=0;i<anchors.length;i++){switch(anchors[i].toLowerCase()){case"left":docker.anchorLeft=true;break;case"right":docker.anchorRight=true;break;case"top":docker.anchorTop=true;break;case"bottom":docker.anchorBottom=true;break;}}}}
var textElems=svgNode.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,'text');$A(textElems).each((function(textElem){var label=new ORYX.Core.SVG.Label({textElement:textElem,shapeId:this.id});label.x-=offsetX;label.y-=offsetY;this._labels[label.id]=label;}).bind(this));},createDocker:function(){var docker=new ORYX.Core.Controls.Docker({eventHandlerCallback:this.eventHandlerCallback});docker.bounds.registerCallback(this._dockerChangedCallback);this.dockers.push(docker);docker.parent=this;docker.bounds.registerCallback(this._changedCallback);return docker},toString:function(){return this._stencil.title()+" "+this.id}};ORYX.Core.Node=ORYX.Core.Shape.extend(ORYX.Core.Node);NAMESPACE_SVG="http://www.w3.org/2000/svg";NAMESPACE_ORYX="http://www.b3mn.org/oryx";if(!ORYX){var ORYX={};}
if(!ORYX.Core){ORYX.Core={};}
ORYX.Core.Edge={construct:function(options,stencil){arguments.callee.$.construct.apply(this,arguments);this.isMovable=true;this.isSelectable=true;this._dockerUpdated=false;this._markers=new Hash();this._paths=[];this._interactionPaths=[];this._dockersByPath=new Hash();this._markersByPath=new Hash();this.attachedNodePositionData=new Hash();var stencilNode=this.node.childNodes[0].childNodes[0];stencilNode=ORYX.Editor.graft("http://www.w3.org/2000/svg",stencilNode,['g',{"pointer-events":"painted"}]);this.addEventHandlers(stencilNode);this._oldBounds=this.bounds.clone();this._init(this._stencil.view());if(stencil instanceof Array){this.deserialize(stencil);}},_update:function(force){if(this._dockerUpdated||this.isChanged||force){this.dockers.invoke("update");if(this.bounds.width()===0||this.bounds.height()===0){this.bounds.moveBy({x:this.bounds.width()===0?-1:0,y:this.bounds.height()===0?-1:0});this.bounds.extend({x:this.bounds.width()===0?2:0,y:this.bounds.height()===0?2:0});}
var upL=this.bounds.upperLeft();var oldUpL=this._oldBounds.upperLeft();var oldWidth=this._oldBounds.width()===0?this.bounds.width():this._oldBounds.width();var oldHeight=this._oldBounds.height()===0?this.bounds.height():this._oldBounds.height();var diffX=upL.x-oldUpL.x;var diffY=upL.y-oldUpL.y;var diffWidth=this.bounds.width()/oldWidth;var diffHeight=this.bounds.height()/oldHeight;this.dockers.each((function(docker){docker.bounds.unregisterCallback(this._dockerChangedCallback);if(!this._dockerUpdated){docker.bounds.moveBy(diffX,diffY);if(diffWidth!==1||diffHeight!==1){var relX=docker.bounds.upperLeft().x-upL.x;var relY=docker.bounds.upperLeft().y-upL.y;docker.bounds.moveTo(upL.x+relX*diffWidth,upL.y+relY*diffHeight);}}
docker.update();docker.bounds.registerCallback(this._dockerChangedCallback);}).bind(this));if(this._dockerUpdated){var a=this.dockers.first().bounds.center();var b=this.dockers.first().bounds.center();this.dockers.each((function(docker){var center=docker.bounds.center();a.x=Math.min(a.x,center.x);a.y=Math.min(a.y,center.y);b.x=Math.max(b.x,center.x);b.y=Math.max(b.y,center.y);}).bind(this));this.bounds.set(Object.clone(a),Object.clone(b));}
this.getLabels().each(function(label){switch(label.edgePosition){case"starttop":var angle=this._getAngle(this.dockers[0],this.dockers[1]);var pos=this.dockers.first().bounds.center();if(angle<=90||angle>270){label.horizontalAlign("left");label.verticalAlign("bottom");label.x=pos.x+label.getOffsetTop();label.y=pos.y-label.getOffsetTop();label.rotate(360-angle,pos);}else{label.horizontalAlign("right");label.verticalAlign("bottom");label.x=pos.x-label.getOffsetTop();label.y=pos.y-label.getOffsetTop();label.rotate(180-angle,pos);}
break;case"startbottom":var angle=this._getAngle(this.dockers[0],this.dockers[1]);var pos=this.dockers.first().bounds.center();if(angle<=90||angle>270){label.horizontalAlign("left");label.verticalAlign("top");label.x=pos.x+label.getOffsetBottom();label.y=pos.y+label.getOffsetBottom();label.rotate(360-angle,pos);}else{label.horizontalAlign("right");label.verticalAlign("top");label.x=pos.x-label.getOffsetBottom();label.y=pos.y+label.getOffsetBottom();label.rotate(180-angle,pos);}
break;case"midtop":var numOfDockers=this.dockers.length;if(numOfDockers%2===0){var angle=this._getAngle(this.dockers[numOfDockers/2-1],this.dockers[numOfDockers/2]);var pos1=this.dockers[numOfDockers/2-1].bounds.center();var pos2=this.dockers[numOfDockers/2].bounds.center();var pos={x:(pos1.x+pos2.x)/2.0,y:(pos1.y+pos2.y)/2.0};label.horizontalAlign("center");label.verticalAlign("bottom");label.x=pos.x;label.y=pos.y-label.getOffsetTop();if(angle<=90||angle>270){label.rotate(360-angle,pos);}else{label.rotate(180-angle,pos);}}else{var index=parseInt(numOfDockers/2);var angle=this._getAngle(this.dockers[index],this.dockers[index+1]);var pos=this.dockers[index].bounds.center();if(angle<=90||angle>270){label.horizontalAlign("left");label.verticalAlign("bottom");label.x=pos.x+label.getOffsetTop();label.y=pos.y-label.getOffsetTop();label.rotate(360-angle,pos);}else{label.horizontalAlign("right");label.verticalAlign("bottom");label.x=pos.x-label.getOffsetTop();label.y=pos.y-label.getOffsetTop();label.rotate(180-angle,pos);}}
break;case"midbottom":var numOfDockers=this.dockers.length;if(numOfDockers%2===0){var angle=this._getAngle(this.dockers[numOfDockers/2-1],this.dockers[numOfDockers/2]);var pos1=this.dockers[numOfDockers/2-1].bounds.center();var pos2=this.dockers[numOfDockers/2].bounds.center();var pos={x:(pos1.x+pos2.x)/2.0,y:(pos1.y+pos2.y)/2.0};label.horizontalAlign("center");label.verticalAlign("top");label.x=pos.x;label.y=pos.y+label.getOffsetTop();if(angle<=90||angle>270){label.rotate(360-angle,pos);}else{label.rotate(180-angle,pos);}}else{var index=parseInt(numOfDockers/2);var angle=this._getAngle(this.dockers[index],this.dockers[index+1]);var pos=this.dockers[index].bounds.center();if(angle<=90||angle>270){label.horizontalAlign("left");label.verticalAlign("top");label.x=pos.x+label.getOffsetBottom();label.y=pos.y+label.getOffsetBottom();label.rotate(360-angle,pos);}else{label.horizontalAlign("right");label.verticalAlign("top");label.x=pos.x-label.getOffsetBottom();label.y=pos.y+label.getOffsetBottom();label.rotate(180-angle,pos);}}
break;case"endtop":var length=this.dockers.length;var angle=this._getAngle(this.dockers[length-2],this.dockers[length-1]);var pos=this.dockers.last().bounds.center();if(angle<=90||angle>270){label.horizontalAlign("right");label.verticalAlign("bottom");label.x=pos.x-label.getOffsetTop();label.y=pos.y-label.getOffsetTop();label.rotate(360-angle,pos);}else{label.horizontalAlign("left");label.verticalAlign("bottom");label.x=pos.x+label.getOffsetTop();label.y=pos.y-label.getOffsetTop();label.rotate(180-angle,pos);}
break;case"endbottom":var length=this.dockers.length;var angle=this._getAngle(this.dockers[length-2],this.dockers[length-1]);var pos=this.dockers.last().bounds.center();if(angle<=90||angle>270){label.horizontalAlign("right");label.verticalAlign("top");label.x=pos.x-label.getOffsetBottom();label.y=pos.y+label.getOffsetBottom();label.rotate(360-angle,pos);}else{label.horizontalAlign("left");label.verticalAlign("top");label.x=pos.x+label.getOffsetBottom();label.y=pos.y+label.getOffsetBottom();label.rotate(180-angle,pos);}
break;}}.bind(this));this.children.each(function(value){if(value instanceof ORYX.Core.Node){this.calculatePositionOfAttachedChildNode.call(this,value);}}.bind(this));this.refreshAttachedNodes();this.refresh();this.isChanged=false;this._dockerUpdated=false;this._oldBounds=this.bounds.clone();}},movePointToUpperLeftOfNode:function(point,bounds){point.x-=bounds.width()/2;point.y-=bounds.height()/2;},refreshAttachedNodes:function(){this.attachedNodePositionData.values().each(function(nodeData){var startPoint=nodeData.segment.docker1.bounds.center();var endPoint=nodeData.segment.docker2.bounds.center();this.relativizePoint(startPoint);this.relativizePoint(endPoint);var newNodePosition={};newNodePosition.x=startPoint.x+
nodeData.relativDistanceFromDocker1*(endPoint.x-startPoint.x);newNodePosition.y=startPoint.y+
nodeData.relativDistanceFromDocker1*(endPoint.y-startPoint.y);this.movePointToUpperLeftOfNode(newNodePosition,nodeData.node.bounds);nodeData.node.bounds.moveTo(newNodePosition);nodeData.node._update();}.bind(this));},calculatePositionOfAttachedChildNode:function(node){var position={};position.x=0;position.y=0;if(!this.attachedNodePositionData[node.getId()]){this.attachedNodePositionData[node.getId()]={};this.attachedNodePositionData[node.getId()].relativDistanceFromDocker1=0;this.attachedNodePositionData[node.getId()].node=node;this.attachedNodePositionData[node.getId()].segment={};this.findEdgeSegmentForNode(node);}else if(node.isChanged){this.findEdgeSegmentForNode(node);}},findEdgeSegmentForNode:function(node){var length=this.dockers.length;var smallestDistance;var i;for(i=1;i<length;i++){var lineP1=this.dockers[i-1].bounds.center();var lineP2=this.dockers[i].bounds.center();this.relativizePoint(lineP1);this.relativizePoint(lineP2);var nodeCenterPoint=node.bounds.center();var distance=ORYX.Core.Math.distancePointLinie(lineP1,lineP2,nodeCenterPoint,true);if((distance||distance===0)&&((!smallestDistance&&smallestDistance!==0)||distance<smallestDistance)){smallestDistance=distance;this.attachedNodePositionData[node.getId()].segment.docker1=this.dockers[i-1];this.attachedNodePositionData[node.getId()].segment.docker2=this.dockers[i];}
if(!distance&&!smallestDistance&&smallestDistance!==0){if(ORYX.Core.Math.getDistancePointToPoint(nodeCenterPoint,lineP1)<ORYX.Core.Math.getDistancePointToPoint(nodeCenterPoint,lineP2)){this.attachedNodePositionData[node.getId()].relativDistanceFromDocker1=0;}else{this.attachedNodePositionData[node.getId()].relativDistanceFromDocker1=1;}
this.attachedNodePositionData[node.getId()].segment.docker1=this.dockers[i-1];this.attachedNodePositionData[node.getId()].segment.docker2=this.dockers[i];}}
if(smallestDistance||smallestDistance===0){this.attachedNodePositionData[node.getId()].relativDistanceFromDocker1=this.getLineParameterForPosition(this.attachedNodePositionData[node.getId()].segment.docker1,this.attachedNodePositionData[node.getId()].segment.docker2,node);}},getLineParameterForPosition:function(docker1,docker2,node){var dockerPoint1=docker1.bounds.center();var dockerPoint2=docker2.bounds.center();this.relativizePoint(dockerPoint1);this.relativizePoint(dockerPoint2);var intersectionPoint=ORYX.Core.Math.getPointOfIntersectionPointLine(dockerPoint1,dockerPoint2,node.bounds.center(),true);if(!intersectionPoint){return 0;}
var relativeDistance=ORYX.Core.Math.getDistancePointToPoint(intersectionPoint,dockerPoint1)/ORYX.Core.Math.getDistancePointToPoint(dockerPoint1,dockerPoint2);return relativeDistance;},relativizePoint:function(point){point.x-=this.bounds.upperLeft().x;point.y-=this.bounds.upperLeft().y;},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var lastPoint;this._paths.each((function(path,index){var dockers=this._dockersByPath[path.id];var c;var d;if(lastPoint){d="M"+lastPoint.x+" "+lastPoint.y;}
else{c=dockers[0].bounds.center();lastPoint=c;d="M"+c.x+" "+c.y;}
for(var i=1;i<dockers.length;i++){c=dockers[i].bounds.center();d=d+"L"+c.x+" "+c.y+" ";lastPoint=c;}
path.setAttributeNS(null,"d",d);this._interactionPaths[index].setAttributeNS(null,"d",d);}).bind(this));if(this.getChildNodes().length>0){var x=this.bounds.upperLeft().x;var y=this.bounds.upperLeft().y;this.node.firstChild.childNodes[1].setAttributeNS(null,"transform","translate("+x+", "+y+")");}},getIntersectionPoint:function(){var length=Math.floor(this.dockers.length/2);return ORYX.Core.Math.midPoint(this.dockers[length-1].bounds.center(),this.dockers[length].bounds.center());},isPointIncluded:function(pointX,pointY){var isbetweenAB=this.absoluteBounds().isIncluded(pointX,pointY,ORYX.CONFIG.OFFSET_EDGE_BOUNDS);var isPointIncluded;if(isbetweenAB&&this.dockers.length>0){var i=0;var point1,point2;do{point1=this.dockers[i].bounds.center();point2=this.dockers[++i].bounds.center();isPointIncluded=ORYX.Core.Math.isPointInLine(pointX,pointY,point1.x,point1.y,point2.x,point2.y,ORYX.CONFIG.OFFSET_EDGE_BOUNDS);}while(!isPointIncluded&&i<this.dockers.length-1)}
return isPointIncluded;},isPointOverOffset:function(){return false;},_getAngle:function(docker1,docker2){var p1=docker1.absoluteCenterXY();var p2=docker2.absoluteCenterXY();if(p1.x==p2.x&&p1.y==p2.y){return 0;}
var angle=Math.asin(Math.sqrt(Math.pow(p1.y-p2.y,2))/(Math.sqrt(Math.pow(p2.x-p1.x,2)+Math.pow(p1.y-p2.y,2))))*180/Math.PI;if(p2.x>=p1.x&&p2.y<=p1.y){return angle;}else if(p2.x<p1.x&&p2.y<=p1.y){return 180-angle;}else if(p2.x<p1.x&&p2.y>p1.y){return 180+angle;}else{return 360-angle;}},alignDockers:function(){this._update(true);var firstPoint=this.dockers.first().bounds.center();var lastPoint=this.dockers.last().bounds.center();var deltaX=lastPoint.x-firstPoint.x;var deltaY=lastPoint.y-firstPoint.y;var numOfDockers=this.dockers.length-1;this.dockers.each((function(docker,index){var part=index/numOfDockers;docker.bounds.unregisterCallback(this._dockerChangedCallback);docker.bounds.moveTo(firstPoint.x+part*deltaX,firstPoint.y+part*deltaY);docker.bounds.registerCallback(this._dockerChangedCallback);}).bind(this));this._dockerChanged();},add:function(shape){arguments.callee.$.add.apply(this,arguments);if(shape instanceof ORYX.Core.Controls.Docker&&this.dockers.include(shape)){var pathArray=this._dockersByPath.values()[0];if(pathArray){pathArray.splice(this.dockers.indexOf(shape),0,shape);}
this.handleChildShapesAfterAddDocker(shape);}},handleChildShapesAfterAddDocker:function(docker){if(!docker instanceof ORYX.Core.Controls.Docker){return undefined;}
var index=this.dockers.indexOf(docker);if(!(0<index&&index<this.dockers.length-1)){return undefined;}
var startDocker=this.dockers[index-1];var endDocker=this.dockers[index+1];var segmentElements=this.getAttachedNodePositionDataForSegment(startDocker,endDocker);var lengthSegmentPart1=ORYX.Core.Math.getDistancePointToPoint(startDocker.bounds.center(),docker.bounds.center());var lengthSegmentPart2=ORYX.Core.Math.getDistancePointToPoint(endDocker.bounds.center(),docker.bounds.center());if(!(lengthSegmentPart1+lengthSegmentPart2)){return;}
var relativDockerPosition=lengthSegmentPart1/(lengthSegmentPart1+lengthSegmentPart2);segmentElements.each(function(nodePositionData){if(nodePositionData.value.relativDistanceFromDocker1<relativDockerPosition){nodePositionData.value.segment.docker2=docker;nodePositionData.value.relativDistanceFromDocker1=nodePositionData.value.relativDistanceFromDocker1/relativDockerPosition;}else{nodePositionData.value.segment.docker1=docker;var newFullDistance=1-relativDockerPosition;var relativPartOfSegment=nodePositionData.value.relativDistanceFromDocker1-
relativDockerPosition;nodePositionData.value.relativDistanceFromDocker1=relativPartOfSegment/newFullDistance;}})
this.refreshAttachedNodes();},getAttachedNodePositionDataForSegment:function(startDocker,endDocker){if(!((startDocker instanceof ORYX.Core.Controls.Docker)&&(endDocker instanceof ORYX.Core.Controls.Docker))){return[];}
var elementsOfSegment=this.attachedNodePositionData.findAll(function(nodePositionData){return nodePositionData.value.segment.docker1===startDocker&&nodePositionData.value.segment.docker2===endDocker;});if(!elementsOfSegment){return[];}
return elementsOfSegment;},remove:function(shape){arguments.callee.$.remove.apply(this,arguments);if(this.attachedNodePositionData[shape.getId()]){delete this.attachedNodePositionData[shape.getId()];}
if(shape instanceof ORYX.Core.Controls.Docker){this.handleChildShapesAfterRemoveDocker(shape);}},handleChildShapesAfterRemoveDocker:function(docker){if(!(docker instanceof ORYX.Core.Controls.Docker)){return;}
this.attachedNodePositionData.each(function(nodePositionData){if(nodePositionData.value.segment.docker1===docker){var index=this.dockers.indexOf(nodePositionData.value.segment.docker2);if(index==-1){return;}
nodePositionData.value.segment.docker1=this.dockers[index-1];}
else if(nodePositionData.value.segment.docker2===docker){var index=this.dockers.indexOf(nodePositionData.value.segment.docker1);if(index==-1){return;}
nodePositionData.value.segment.docker2=this.dockers[index+1];}}.bind(this));this.refreshAttachedNodes();},addDocker:function(position,exDocker){var lastDocker;var result;this._dockersByPath.any((function(pair){return pair.value.any((function(docker,index){if(!lastDocker){lastDocker=docker;return false;}
else{var point1=lastDocker.bounds.center();var point2=docker.bounds.center();if(ORYX.Core.Math.isPointInLine(position.x,position.y,point1.x,point1.y,point2.x,point2.y,10)){var path=this._paths.find(function(path){return path.id===pair.key;});if(path){var allowAttr=path.getAttributeNS(NAMESPACE_ORYX,'allowDockers');if(allowAttr&&allowAttr.toLowerCase()==="no"){return true;}}
var newDocker=(exDocker)?exDocker:this.createDocker(this.dockers.indexOf(lastDocker)+1,position);newDocker.bounds.centerMoveTo(position);if(exDocker){this.add(newDocker,this.dockers.indexOf(lastDocker)+1);}
result=newDocker;return true;}
else{lastDocker=docker;return false;}}}).bind(this));}).bind(this));return result;},removeDocker:function(docker){if(this.dockers.length>2&&this.dockers.first()!==docker){this._dockersByPath.any((function(pair){if(pair.value.member(docker)){if(docker===pair.value.last()){return true;}
else{this.remove(docker);this._dockersByPath[pair.key]=pair.value.without(docker);this.isChanged=true;this._dockerChanged();return true;}}
return false;}).bind(this));}},removeUnusedDockers:function(){var marked=$H({});this.dockers.each(function(docker,i){if(i===0||i==this.dockers.length-1){return;}
var previous=this.dockers[i-1];if(marked.values().indexOf(previous)!=-1&&this.dockers[i-2]){previous=this.dockers[i-2];}
var next=this.dockers[i+1];var cp=previous.getDockedShape()&&previous.referencePoint?previous.getAbsoluteReferencePoint():previous.bounds.center();var cn=next.getDockedShape()&&next.referencePoint?next.getAbsoluteReferencePoint():next.bounds.center();var cd=docker.bounds.center();if(ORYX.Core.Math.isPointInLine(cd.x,cd.y,cp.x,cp.y,cn.x,cn.y,1)){marked[i]=docker;}}.bind(this));marked.each(function(docker){this.removeDocker(docker.value);}.bind(this));if(marked.values().length>0){this._update(true);}
return marked;},_init:function(svgDocument){arguments.callee.$._init.apply(this,arguments);var minPointX,minPointY,maxPointX,maxPointY;var defs=svgDocument.getElementsByTagNameNS(NAMESPACE_SVG,"defs");if(defs.length>0){defs=defs[0];var markerElements=$A(defs.getElementsByTagNameNS(NAMESPACE_SVG,"marker"));var marker;var me=this;markerElements.each(function(markerElement){try{marker=new ORYX.Core.SVG.SVGMarker(markerElement.cloneNode(true));me._markers[marker.id]=marker;var textElements=$A(marker.element.getElementsByTagNameNS(NAMESPACE_SVG,"text"));var label;textElements.each(function(textElement){label=new ORYX.Core.SVG.Label({textElement:textElement,shapeId:this.id});me._labels[label.id]=label;});}
catch(e){}});}
var gs=svgDocument.getElementsByTagNameNS(NAMESPACE_SVG,"g");if(gs.length<=0){throw"Edge: No g element found.";}
var g=gs[0];g.setAttributeNS(null,"id",null);var isFirst=true;$A(g.childNodes).each((function(path,index){if(ORYX.Editor.checkClassType(path,SVGPathElement)){path=path.cloneNode(false);var pathId=this.id+"_"+index;path.setAttributeNS(null,"id",pathId);this._paths.push(path);var markersByThisPath=[];var markerUrl=path.getAttributeNS(null,"marker-start");if(markerUrl&&markerUrl!==""){markerUrl=markerUrl.strip();markerUrl=markerUrl.replace(/^url\(#/,'');var markerStartId=this.id.concat(markerUrl.replace(/\)$/,''));path.setAttributeNS(null,"marker-start","url(#"+markerStartId+")");markersByThisPath.push(this._markers[markerStartId]);}
markerUrl=path.getAttributeNS(null,"marker-mid");if(markerUrl&&markerUrl!==""){markerUrl=markerUrl.strip();markerUrl=markerUrl.replace(/^url\(#/,'');var markerMidId=this.id.concat(markerUrl.replace(/\)$/,''));path.setAttributeNS(null,"marker-mid","url(#"+markerMidId+")");markersByThisPath.push(this._markers[markerMidId]);}
markerUrl=path.getAttributeNS(null,"marker-end");if(markerUrl&&markerUrl!==""){markerUrl=markerUrl.strip();markerUrl=markerUrl.replace(/^url\(#/,'');var markerEndId=this.id.concat(markerUrl.replace(/\)$/,''));path.setAttributeNS(null,"marker-end","url(#"+markerEndId+")");markersByThisPath.push(this._markers[markerEndId]);}
this._markersByPath[pathId]=markersByThisPath;var parser=new PathParser();var handler=new ORYX.Core.SVG.PointsPathHandler();parser.setHandler(handler);parser.parsePath(path);if(handler.points.length<4){throw"Edge: Path has to have two or more points specified.";}
this._dockersByPath[pathId]=[];for(var i=0;i<handler.points.length;i+=2){var x=handler.points[i];var y=handler.points[i+1];if(isFirst||i>0){var docker=new ORYX.Core.Controls.Docker({eventHandlerCallback:this.eventHandlerCallback});docker.bounds.centerMoveTo(x,y);docker.bounds.registerCallback(this._dockerChangedCallback);this.add(docker,this.dockers.length);if(minPointX){minPointX=Math.min(x,minPointX);minPointY=Math.min(y,minPointY);}
else{minPointX=x;minPointY=y;}
if(maxPointX){maxPointX=Math.max(x,maxPointX);maxPointY=Math.max(y,maxPointY);}
else{maxPointX=x;maxPointY=y;}}}
isFirst=false;}}).bind(this));this.bounds.set(minPointX,minPointY,maxPointX,maxPointY);if(this.bounds.width()===0||this.bounds.height()===0){this.bounds.extend({x:this.bounds.width()===0?2:0,y:this.bounds.height()===0?2:0});this.bounds.moveBy({x:this.bounds.width()===0?-1:0,y:this.bounds.height()===0?-1:0});}
this._oldBounds=this.bounds.clone();this._paths.reverse();var paths=[];this._paths.each((function(path){paths.push(this.node.childNodes[0].childNodes[0].childNodes[0].appendChild(path));}).bind(this));this._paths=paths;this._paths.each((function(path){var iPath=path.cloneNode(false);iPath.setAttributeNS(null,"id",undefined);iPath.setAttributeNS(null,"stroke-width",10);iPath.setAttributeNS(null,"visibility","hidden");iPath.setAttributeNS(null,"stroke-dasharray",null);iPath.setAttributeNS(null,"stroke","black");iPath.setAttributeNS(null,"fill","none");this._interactionPaths.push(this.node.childNodes[0].childNodes[0].childNodes[0].appendChild(iPath));}).bind(this));this._paths.reverse();this._interactionPaths.reverse();var textElems=svgDocument.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,'text');$A(textElems).each((function(textElem){var label=new ORYX.Core.SVG.Label({textElement:textElem,shapeId:this.id});this.node.childNodes[0].childNodes[0].appendChild(label.node);this._labels[label.id]=label;}).bind(this));this.node.childNodes[0].childNodes[0].setAttributeNS(null,"title",this.getStencil().title());this.node.setAttributeNS(null,"resourceId",this.resourceId);this.propertiesChanged.each(function(pair){pair.value=true;});},addMarkers:function(defs){this._markers.each(function(marker){if(!defs.ownerDocument.getElementById(marker.value.id)){marker.value.element=defs.appendChild(marker.value.element);}});},removeMarkers:function(){var svgElement=this.node.ownerSVGElement;if(svgElement){var defs=svgElement.getElementsByTagNameNS(NAMESPACE_SVG,"defs");if(defs.length>0){defs=defs[0];this._markers.each(function(marker){var foundMarker=defs.ownerDocument.getElementById(marker.value.id);if(foundMarker){marker.value.element=defs.removeChild(marker.value.element);}});}}},_dockerChanged:function(){this._dockerUpdated=true;},serialize:function(){var result=arguments.callee.$.serialize.apply(this);var value="";this._dockersByPath.each((function(pair){pair.value.each(function(docker){var position=docker.getDockedShape()&&docker.referencePoint?docker.referencePoint:docker.bounds.center();value=value.concat(position.x+" "+position.y+" ");});value+=" # ";}).bind(this));result.push({name:'dockers',prefix:'oryx',value:value,type:'literal'});var lastDocker=this.dockers.last();var target=lastDocker.getDockedShape();if(target){result.push({name:'target',prefix:'raziel',value:'#'+ERDF.__stripHashes(target.resourceId),type:'resource'});}
try{var serializeEvent=this.getStencil().serialize();if(serializeEvent.type){serializeEvent.shape=this;serializeEvent.data=result;serializeEvent.result=undefined;serializeEvent.forceExecution=true;this._delegateEvent(serializeEvent);if(serializeEvent.result){result=serializeEvent.result;}}}
catch(e){}
return result;},deserialize:function(data){try{var deserializeEvent=this.getStencil().deserialize();if(deserializeEvent.type){deserializeEvent.shape=this;deserializeEvent.data=data;deserializeEvent.result=undefined;deserializeEvent.forceExecution=true;this._delegateEvent(deserializeEvent);if(deserializeEvent.result){data=deserializeEvent.result;}}}
catch(e){}
var target=data.find(function(ser){return(ser.prefix+"-"+ser.name)=='raziel-target';});var targetShape;if(target){targetShape=this.getCanvas().getChildShapeByResourceId(target.value);}
var outgoing=data.findAll(function(ser){return(ser.prefix+"-"+ser.name)=='raziel-outgoing';});outgoing.each((function(obj){if(!this.parent){return;}
var next=this.getCanvas().getChildShapeByResourceId(obj.value);if(next){if(next==targetShape){this.dockers.last().setDockedShape(next);this.dockers.last().setReferencePoint({x:next.bounds.width()/2.0,y:next.bounds.height()/2.0});}else if(next instanceof ORYX.Core.Edge){next.dockers.first().setDockedShape(this);}}}).bind(this));arguments.callee.$.deserialize.apply(this,[data]);var oryxDockers=data.find(function(obj){return(obj.prefix==="oryx"&&obj.name==="dockers");});if(oryxDockers){var dataByPath=oryxDockers.value.split("#").without("").without(" ");dataByPath.each((function(data,index){var values=data.replace(/,/g," ").split(" ").without("");if(values.length%2===0){var path=this._paths[index];if(path){if(index===0){while(this._dockersByPath[path.id].length>2){this.removeDocker(this._dockersByPath[path.id][1]);}}
else{while(this._dockersByPath[path.id].length>1){this.removeDocker(this._dockersByPath[path.id][0]);}}
var dockersByPath=this._dockersByPath[path.id];var x;var y;if(index===0){x=parseFloat(values.shift());y=parseFloat(values.shift());if(dockersByPath.first().getDockedShape()){dockersByPath.first().setReferencePoint({x:x,y:y});}
else{dockersByPath.first().bounds.centerMoveTo(x,y);}}
y=parseFloat(values.pop());x=parseFloat(values.pop());if(dockersByPath.last().getDockedShape()){dockersByPath.last().setReferencePoint({x:x,y:y});}
else{dockersByPath.last().bounds.centerMoveTo(x,y);}
for(var i=0;i<values.length;i++){x=parseFloat(values[i]);y=parseFloat(values[++i]);var newDocker=this.createDocker();newDocker.bounds.centerMoveTo(x,y);}}}}).bind(this));}
else{this.alignDockers();}
this.node.setAttributeNS(null,"resourceId",this.resourceId);this._changed();},toString:function(){return this.getStencil().title()+" "+this.id;},getTarget:function(){return this.dockers.last()?this.dockers.last().getDockedShape():null;},getSource:function(){return this.dockers.first()?this.dockers.first().getDockedShape():null;},isDocked:function(){var isDocked=false;this.dockers.each(function(docker){if(docker.isDocked()){isDocked=true;throw $break;}});return isDocked;},toJSON:function(){var json=arguments.callee.$.toJSON.apply(this,arguments);if(this.getTarget()){json.target={resourceId:this.getTarget().resourceId};}
return json;}};ORYX.Core.Edge=ORYX.Core.Shape.extend(ORYX.Core.Edge);if(!ORYX){var ORYX={}}
if(!ORYX.Plugins){ORYX.Plugins={}}
ORYX.Plugins.AbstractPlugin=Clazz.extend({facade:null,construct:function(facade){this.facade=facade;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.onLoaded.bind(this));},onLoaded:function(){},onSelectionChanged:function(){},showOverlay:function(shapes,attributes,svgNode,svgNodePosition){if(!(shapes instanceof Array)){shapes=[shapes]}
shapes=shapes.map(function(shape){var el=shape;if(typeof shape=="string"){el=this.facade.getCanvas().getChildShapeByResourceId(shape);el=el||this.facade.getCanvas().getChildById(shape,true);}
return el;}.bind(this)).compact();if(!this.overlayID){this.overlayID=this.type+ORYX.Editor.provideId();}
this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:this.overlayID,shapes:shapes,attributes:attributes,node:svgNode,nodePosition:svgNodePosition||"NW"});},hideOverlay:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:this.overlayID});},doTransform:function(data,stylesheet){if(!stylesheet||!data){return""}
var parser=new DOMParser();var parsedData=parser.parseFromString(data,"text/xml");source=stylesheet;new Ajax.Request(source,{asynchronous:false,method:'get',onSuccess:function(transport){xsl=transport.responseText}.bind(this),onFailure:(function(transport){ORYX.Log.error("XSL load failed"+transport);}).bind(this)});var xsltProcessor=new XSLTProcessor();var domParser=new DOMParser();var xslObject=domParser.parseFromString(xsl,"text/xml");xsltProcessor.importStylesheet(xslObject);try{var newData=xsltProcessor.transformToFragment(parsedData,document);var serializedData=(new XMLSerializer()).serializeToString(newData);serializedData=!serializedData.startsWith("<?xml")?"<?xml version=\"1.0\" encoding=\"UTF-8\"?>"+serializedData:serializedData;return serializedData;}catch(error){return-1;}},openXMLWindow:function(content){var win=window.open('data:application/xml,'+encodeURIComponent(content),'_blank',"resizable=yes,width=600,height=600,toolbar=0,scrollbars=yes");},openDownloadWindow:function(filename,content){var win=window.open("");if(win!=null){win.document.open();win.document.write("<html><body>");var submitForm=win.document.createElement("form");win.document.body.appendChild(submitForm);var createHiddenElement=function(name,value){var newElement=document.createElement("input");newElement.name=name;newElement.type="hidden";newElement.value=value;return newElement}
submitForm.appendChild(createHiddenElement("download",content));submitForm.appendChild(createHiddenElement("file",filename));submitForm.method="POST";win.document.write("</body></html>");win.document.close();submitForm.action=ORYX.PATH+"download";submitForm.submit();}},getSerializedDOM:function(){var serializedDOM=DataManager.serializeDOM(this.facade);serializedDOM='<?xml version="1.0" encoding="utf-8"?>'+'<html xmlns="http://www.w3.org/1999/xhtml" '+'xmlns:b3mn="http://b3mn.org/2007/b3mn" '+'xmlns:ext="http://b3mn.org/2007/ext" '+'xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" '+'xmlns:atom="http://b3mn.org/2007/atom+xhtml">'+'<head profile="http://purl.org/NET/erdf/profile">'+'<link rel="schema.dc" href="http://purl.org/dc/elements/1.1/" />'+'<link rel="schema.dcTerms" href="http://purl.org/dc/terms/ " />'+'<link rel="schema.b3mn" href="http://b3mn.org" />'+'<link rel="schema.oryx" href="http://oryx-editor.org/" />'+'<link rel="schema.raziel" href="http://raziel.org/" />'+'<base href="'+
location.href.split("?")[0]+'" />'+'</head><body>'+
serializedDOM+'</body></html>';return serializedDOM;},enableReadOnlyMode:function(){this.facade.disableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN);this._stopSelectionChange=function(){if(this.facade.getSelection().length>0){this.facade.setSelection([]);}};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this._stopSelectionChange.bind(this));},disableReadOnlyMode:function(){this.facade.enableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN);if(this._stopSelectionChange){this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this._stopSelectionChange.bind(this));this._stopSelectionChange=undefined;}},getRDFFromDOM:function(){try{var xsl="";source=ORYX.PATH+"lib/extract-rdf.xsl";new Ajax.Request(source,{asynchronous:false,method:'get',onSuccess:function(transport){xsl=transport.responseText}.bind(this),onFailure:(function(transport){ORYX.Log.error("XSL load failed"+transport);}).bind(this)});var domParser=new DOMParser();var xmlObject=domParser.parseFromString(this.getSerializedDOM(),"text/xml");var xslObject=domParser.parseFromString(xsl,"text/xml");var xsltProcessor=new XSLTProcessor();xsltProcessor.importStylesheet(xslObject);var result=xsltProcessor.transformToFragment(xmlObject,document);var serializer=new XMLSerializer();return serializer.serializeToString(result);}catch(e){Ext.Msg.alert("Oryx",error);return"";}},isStencilSetExtensionLoaded:function(stencilSetExtensionNamespace){return this.facade.getStencilSets().values().any(function(ss){return ss.extensions().keys().any(function(extensionKey){return extensionKey==stencilSetExtensionNamespace;}.bind(this));}.bind(this));},doLayout:function(shapes){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LAYOUT,shapes:shapes});},layoutEdges:function(node,allEdges,offset){var edges=allEdges.findAll(function(r){return r.dockers.length>2}.bind(this))
if(edges.length>0){var center=node.absoluteXY();var ulo={x:center.x-offset.x,y:center.y-offset.y}
center.x+=node.bounds.width()/2;center.y+=node.bounds.height()/2;oldCenter=Object.clone(center);oldCenter.x-=offset?offset.x:0;oldCenter.y-=offset?offset.y:0;var ul={x:center.x-(node.bounds.width()/2),y:center.y-(node.bounds.height()/2)}
var lr={x:center.x+(node.bounds.width()/2),y:center.y+(node.bounds.height()/2)}
var align=function(bounds,bounds2){var xdif=bounds.center().x-bounds2.center().x;var ydif=bounds.center().y-bounds2.center().y;if(Math.abs(xdif)<3){bounds.moveBy({x:(offset.xs?(((offset.xs*(bounds.center().x-ulo.x))+offset.x+ulo.x)-bounds.center().x):offset.x)-xdif,y:0});}else if(Math.abs(ydif)<3){bounds.moveBy({x:0,y:(offset.ys?(((offset.ys*(bounds.center().y-ulo.y))+offset.y+ulo.y)-bounds.center().y):offset.y)-ydif});}};var isBendPointIncluded=function(edge){var ab=edge.dockers.first().getDockedShape();var bb=edge.dockers.last().getDockedShape();if(ab){ab=ab.absoluteBounds();ab.widen(5);}
if(bb){bb=bb.absoluteBounds();bb.widen(20);}
return edge.dockers.any(function(docker,i){var c=docker.bounds.center();return i!=0&&i!=edge.dockers.length-1&&((ab&&ab.isIncluded(c))||(bb&&bb.isIncluded(c)))})}
edges.each(function(edge){if(edge.dockers.first().getDockedShape()===node){var second=edge.dockers[1];if(align(second.bounds,edge.dockers.first().bounds)){second.update();}}else if(edge.dockers.last().getDockedShape()===node){var beforeLast=edge.dockers[edge.dockers.length-2];if(align(beforeLast.bounds,edge.dockers.last().bounds)){beforeLast.update();}}
edge._update(true);edge.removeUnusedDockers();if(isBendPointIncluded(edge)){this.doLayout(edge);return;}}.bind(this))}
allEdges.each(function(edge){if(edge.dockers.length==2){var p1=edge.dockers.first().bounds.center();var p2=edge.dockers.last().bounds.center();if(Math.abs(p1.x-p2.x)<2||Math.abs(p1.y-p2.y)<2){edge.dockers.first().update();edge.dockers.last().update();this.doLayout(edge);}}}.bind(this));}});if(!ORYX){var ORYX={}}
if(!ORYX.Plugins){ORYX.Plugins={}}
ORYX.Plugins.AbstractLayouter=ORYX.Plugins.AbstractPlugin.extend({layouted:[],construct:function(facade){arguments.callee.$.construct.apply(this,arguments);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LAYOUT,this._initLayout.bind(this));},isIncludedInLayout:function(shape){if(!(this.layouted instanceof Array)){this.layouted=[this.layouted].compact();}
if(this.layouted.length<=0){return true;}
return this.layouted.any(function(s){if(typeof s=="string"){return shape.getStencil().id().include(s);}else{return shape instanceof s;}})},_initLayout:function(event){var shapes=[event.shapes].flatten().compact();var toLayout=shapes.findAll(function(shape){return this.isIncludedInLayout(shape)}.bind(this))
if(toLayout.length>0){this.layout(toLayout);}},layout:function(shapes){throw new Error("Layouter has to implement the layout function.")}});