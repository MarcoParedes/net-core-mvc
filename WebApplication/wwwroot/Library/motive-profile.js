Ext.namespace("ORYX.Plugins");ORYX.Plugins.FlowViewPlugin=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);var cfg={'id':'FlowView','name':"Flow View",'functionality':function(){},'group':MOTV.I18N.FlowView.group,'description':MOTV.I18N.FlowView.flowViewConfigurationDescription,'index':0,'toggle':false,'minShape':0,'maxShape':0,'isEnabled':function(){return true;},'customButtonCreateCallback':this.createFlowViewSelectionButton.bind(this)};this.facade.offer(cfg);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_FLOW_VIEW_UPDATE,function(){this._loadFlowViewItems();}.bind(this));this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.SYNTAX_ERRORS_SHOWN_EVENT,this._showFlowViewErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.SYNTAX_ERRORS_RESET_EVENT,this._hideFlowViewErrors.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_FLOW_VIEW_CHANGE,function(params){this._onFlowViewChange(params.newFlowView);}.bind(this));},createFlowViewSelectionButton:function(){this.splitButtonIcon=ORYX.PATH+"images/silk/page_green.png";this.splitButton=new Ext.Toolbar.DynamicIconSplitButton({text:"",icon:this.splitButtonIcon,iconCls:"x-btn-text-icon",showText:true,menu:new Ext.menu.Menu({items:[{text:MOTV.I18N.FlowView.flowViewConfigure,icon:ORYX.PATH+"images/silk/page_edit.png",handler:this.configureFlowViews.bind(this)},new Ext.menu.Separator()],}),listeners:{click:function(button,event){if(!button.menu.isVisible()&&!button.ignoreNextClick){button.showMenu();}else{button.hideMenu();}}}});this._loadFlowViewItems();return this.splitButton;},_loadFlowViewItems:function(){var i;var items=this.splitButton.menu.items;for(i=items.getCount()-1;i>=2;--i){var item=items.get(i);item.destroy();}
var currentFlowView=this.facade.getCurrentFlowView();this._addFlowViewItem(MOTV.I18N.FlowView.defaultFlowView,currentFlowView===MOTV.I18N.FlowView.defaultFlowView);Ext.each(this.facade.getFlowViews(),function(flowView){this._addFlowViewItem(flowView.name,currentFlowView===flowView.name);}.bind(this));},_addFlowViewItem:function(name,defaultChecked){this.splitButton.menu.add(new Ext.menu.CheckItem({text:name,checked:defaultChecked,group:"FlowViews",handler:this.switchFlowView.bind(this)}));if(defaultChecked){this._onFlowViewChange(name);}},_onFlowViewChange:function(name){var flowViews=this.facade.getFlowViews();this.splitButton.setText(name+" ("+flowViews.length+")");this.splitButton.menu.items.each(function(item){if(item.text==name)
item.setChecked(true);});},configureFlowViews:function(button,pressed){var flowViews=this.facade.getFlowViews();var dsFlowViews=[];flowViews.each(function(flowView,idx){dsFlowViews.push({order:idx+1,name:flowView.name,groupItems:flowView.groupItems.join(",")});});var ds=new Ext.data.JsonStore({data:{flowViews:dsFlowViews},root:"flowViews",fields:['order','name','groupItems']});var editorGridCfg={region:'center',layout:'fit',store:ds,facade:this.facade};var centerPanel=new Ext.form.FlowViewGrid(editorGridCfg);var dialog=null;var self=this;dialog=new Ext.Window({layout:'border',autoCreate:true,title:MOTV.I18N.FlowView.flowViewConfiguration,height:480,width:776,modal:true,collapsible:false,closable:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){closeDialog(true);}}],items:[centerPanel],listeners:{show:{fn:function(){},scope:this}},buttons:[{text:MOTV.I18N.FlowView.ok,handler:function(){flowViews=ds.getRange();var invalidFlowViews=[];flowViews.each(function(flowViewData,idx){if(!flowViewData.data.groupItems){invalidFlowViews.push(flowViewData.data.name);}});if(invalidFlowViews.length>0){Ext.Msg.alert(MOTV.I18N.FlowView.flowViewConfigurationError,MOTV.I18N.FlowView.flowViewAssociation);return false;}
dialog.close();var command=new ORYX.Plugins.FlowViewPlugin.UpdateCommand(this.facade,ds.getRange());this.facade.executeCommands([command]);}.bind(this)},{text:MOTV.I18N.FlowView.cancel,handler:function(){dialog.close();}.bind(this)}]});dialog.show();},switchFlowView:function(button,pressed){var flowViewName=button.text;this._doSwitchFlowView(flowViewName);},_doSwitchFlowView:function(flowViewName){this.facade.setCurrentFlowView(flowViewName);},_showFlowViewErrors:function(event,args){var currentFlowView=this.facade.getCurrentFlowView();var otherFlowViewsWithErrors=event.flowViewsWithErrors.without(currentFlowView);if(otherFlowViewsWithErrors.length>0){this.splitButton.setIcon(ORYX.PATH+"images/silk/exclamation.png");}else{this.splitButton.setIcon(this.splitButtonIcon);}
this.splitButton.menu.items.each(function(item,idx){if(idx>1){if(event.flowViewsWithErrors.indexOf(item.text)!=-1){item.addClass("flowview-validation-error");}else{item.removeClass("flowview-validation-error");}}});},_hideFlowViewErrors:function(event,args){this.splitButton.setIcon(this.splitButtonIcon);this.splitButton.menu.items.each(function(item,idx){if(idx>1){item.removeClass("flowview-validation-error");}});}});ORYX.Plugins.FlowViewPlugin.UpdateCommand=ORYX.Core.Command.extend({construct:function(facade,updatedFlowViewData){this.facade=facade;this.origFlowViewData=[];facade.getFlowViews().each(function(flowView){var flowViewData={};flowViewData.data={};flowViewData.data.name=flowView.name;flowViewData.data.groupItems=flowView.groupItems.join(",");flowViewData.data.flowViewShapes=flowView.flowViewShapes;this.origFlowViewData.push(flowViewData);}.bind(this));this.origCurrFlowView=facade.getCurrentFlowView();this.origSelection=facade.getSelection();this.updatedFlowViewData=updatedFlowViewData;},execute:function(){this.facade.updateFlowViews(this.updatedFlowViewData);this.facade.updateSelection();},rollback:function(){this.facade.updateFlowViews(this.origFlowViewData);this.facade.setCurrentFlowView(this.origCurrFlowView);this.facade.setSelection(this.origSelection);this.facade.updateSelection();}});Ext.Toolbar.DynamicIconSplitButton=Ext.extend(Ext.Toolbar.SplitButton,{setIcon:function(icon){this.icon=icon;if(this.el){this.el.child(this.buttonSelector).setStyle('background-image','url('+this.icon+')');}}});Ext.form.FlowViewGrid=Ext.extend(Ext.grid.EditorGridPanel,{activeRow:-1,removedFlowViews:[],view:new Ext.grid.GridView({getRowClass:function(record,rowParams,store){if(record.data['default']==true){return"default-edge";}}}),_editObj:null,initComponent:function(){var autoExpandColumn=null;if(this.cm==null){this.selModel=new Ext.grid.RowSelectionModel({singleSelect:true,listeners:{beforerowselect:function(sm,i,ke,row){var ele=Ext.fly(grid.getView().getRow(i)).child("table");grid.ddText="<table>"+ele.dom.innerHTML.replace(/&nbsp;/g,"")+"</table>";}}});var columns=[{id:'order',header:"Order",width:55,sortable:false,dataIndex:'order',editor:new Ext.form.TextField({regex:/^[1-9][0-9]*$/,regexText:'Value must be a number greater than 0'})},{header:MOTV.I18N.FlowView.flowViewName,width:150,sortable:false,renderer:Ext.util.Format.htmlEncode,dataIndex:'name',editor:null}];var groupItemsArray=[];var channels=this.facade.getChannels();if(channels){channels.each(function(pair){groupItemsArray.push([pair.key,pair.value.name]);});}
var groupItemsStore=new Ext.data.SimpleStore({data:groupItemsArray,sortInfo:{field:'text'},fields:['value','text']});columns.push({id:"groupItems",header:MOTV.I18N.FlowView.groupItems,width:200,dataIndex:'groupItems',sortable:false,renderer:Ext.util.Format.htmlEncode,editor:new Ext.form.MultiSelectField({allowBlank:false,store:groupItemsStore,containerHeight:300})});if(this.autoExpandColumn==null||!this.autoExpandColumn)
this.autoExpandColumn=columns[columns.length-1].id;this.cm=new Ext.grid.ColumnModel(columns);}
var grid=this;var cfg={enableDragDrop:true,enableColumnHide:false,enableColumnMove:false,enableHdMenu:false,clicksToEdit:1,stripeRows:true,ddGroup:'flowviewgrid-dd',bbar:[{iconCls:"icon-add",text:MOTV.I18N.FlowView.addFlowView,handler:function(){var ds=this.getStore();var order=this.getNextAvailableOrder();var grid=this;var flowViewName="";var dlg=this._getFlowViewNameDialog(ds,function(text){var newRec={flowViews:[{order:order,name:text,}]};ds.loadData(newRec,true);grid.startEditing(ds.getCount()-1,2);});dlg.show();},scope:this},{iconCls:"icon-delete",text:MOTV.I18N.FlowView.deleteFlowView,scope:this,handler:function(){var selectedRecord=this.getSelectionModel().getSelected();if(selectedRecord==null)
return;var ds=this.getStore();var recIndex=ds.indexOf(selectedRecord);for(var i=recIndex+1;i<ds.getCount();i++){var rec=ds.getAt(i);rec.set("order",rec.get("order")-1);}
ds.remove(selectedRecord);if(selectedRecord.id!=-1)
this.removedFlowViews.push(selectedRecord.name);}}]};Ext.apply(this,cfg);Ext.form.FlowViewGrid.superclass.initComponent.call(this);this.on('keydown',function(e){var stopProp=true;var sm=this.getSelectionModel();var selectedRow=sm.getSelected();if(selectedRow!=null){var store=this.getStore();switch(e.keyCode){case e.ENTER:case e.SPACE:this.toggleRowActivation(store.indexOf(selectedRow));break;default:stopProp=false;};}
if(stopProp)
e.stopPropagation();});this.on('validateedit',function(e){if(e.field==='order'){var rowIndex=e.row;var newIndex=this.reorderRow(rowIndex,parseInt(e.value));var sm=this.getSelectionModel();sm.selectRow(newIndex);return false;}
return true;});this.on({"beforeedit":{fn:function(obj){this._editObj=obj;},scope:this},"afteredit":{fn:function(obj){this._editObj=null;},scope:this}});},getRemovedFlowViews:function(){return this.removedFlowViews;},toggleRowActivation:function(rowIndex){var activate=this.activeRow!=rowIndex;if(this.activeRow>-1){this.activeRow=-1;}
if(activate&&rowIndex>=0){this.activeRow=rowIndex;}},reorderRow:function(rowIndex,newOrder){var store=this.getStore();var rowData=store.getAt(rowIndex);if(rowData==null)return rowIndex;var oldOrder=rowData.get("order");if(oldOrder==newOrder)return rowIndex;var nextAvailableOrder=this.getNextAvailableOrder();if(oldOrder===nextAvailableOrder-1&&newOrder>oldOrder){newOrder=oldOrder;}
if(newOrder<=0||newOrder>nextAvailableOrder)
newOrder=nextAvailableOrder;var targetIndex=this._getRecordIndexByOrder(newOrder);if(targetIndex==-1){targetIndex=store.getCount()-1;}
if(oldOrder<newOrder){var lastOrder=-1;for(var i=rowIndex+1;i<=targetIndex;i++){var record=store.getAt(i);lastOrder=record.get("order")-1;record.set("order",lastOrder);}
newOrder=lastOrder+1;rowData.set("order",newOrder);}else{rowData.set("order",newOrder);for(var i=targetIndex;i<rowIndex;i++){var record=store.getAt(i);record.set("order",record.get("order")+1);}}
store.sort("order","ASC");return this._getRecordIndexByOrder(newOrder);},getNextAvailableOrder:function(){var store=this.getStore();if(store.getCount()<=0)
return 1;return store.getAt(store.getCount()-1).get("order")+1;},_getRecordIndexByOrder:function(order){var store=this.getStore();return store.find("order",String(order));},afterRender:function(){Ext.form.FlowViewGrid.superclass.afterRender.apply(this,arguments);var grid=this;this.dtarget=new Ext.dd.DropTarget(this.getView().mainBody,{ddGroup:'flowviewgrid-dd',notifyDrop:function(dd,e,data){var sm=grid.getSelectionModel();var row=sm.getSelected();if(row!=null){var store=grid.getStore();var selectedIndex=store.indexOfId(row.id);var cindex=dd.getDragData(e).rowIndex;var targetRow=store.getAt(cindex);sm.selectRow(grid.reorderRow(selectedIndex,targetRow.get("order")));}}});this.rowNav=new Ext.KeyNav(this.getGridEl(),{"up":function(e){var sm=this.getSelectionModel();var store=this.getStore();if(this.activeRow>0){this.activeRow=this.reorderRow(this.activeRow,store.getAt(this.activeRow).get("order")-1);sm.selectRow(this.activeRow);e.stopEvent();}},"down":function(e){var sm=this.getSelectionModel();var store=this.getStore();if(this.activeRow>=0&&this.activeRow<store.getCount()-1){this.activeRow=this.reorderRow(this.activeRow,store.getAt(this.activeRow).get("order")+1);sm.selectRow(this.activeRow);e.stopEvent();}},"scope":this});this.focus(false,500);if(this.getStore().getCount()>0){if(this.selectRec){this.getSelectionModel().selectRecords([this.store.data.items[this.selectRec]],false);}
else{this.getSelectionModel().selectRow(0);this.getView().focusRow(0);}}},_getFlowViewNameDialog:function(ds,okHandler){var form=new Ext.form.FormPanel({region:'center',labelWidth:150,bodyStyle:'padding:15px',width:325,labelPad:5,defaultType:'textfield',defaults:{width:175,msgTarget:'side'},layoutConfig:{labelSeparator:''},items:[{fieldLabel:MOTV.I18N.FlowView.flowViewName,name:'flowViewName',allowBlank:false,validator:function(text){if(!text.match(/^(?=.*[a-zA-Z])[a-zA-Z0-9_ -]*$/)){flowViewNameDialog.buttons[0].disable();return MOTV.I18N.FlowView.flowViewNameValidation;}
for(var i=0;i<ds.getCount();i++){if(text===ds.getAt(i).get("name")){return MOTV.I18N.FlowView.flowViewNameMustBeUnique;}}
flowViewNameDialog.buttons[0].enable();return true;},listeners:{invalid:function(){if(arguments[1]==this.blankText)
flowViewNameDialog.buttons[0].disable();}}}]});var flowViewNameDialog=null;flowViewNameDialog=new Ext.Window({layout:'border',autoCreate:true,title:MOTV.I18N.FlowView.flowViewConfiguration,height:125,width:400,modal:true,collapsible:false,closable:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){closeDialog(true);}}],items:[form],listeners:{show:{fn:function(){},scope:this}},buttons:[{text:MOTV.I18N.FlowView.nameOk,disabled:true,handler:function(){if(form.getForm().isValid()){var flowViewName=form.getForm().getValues().flowViewName;flowViewNameDialog.close();okHandler(flowViewName);}}.bind(this)},{text:MOTV.I18N.FlowView.nameCancel,handler:function(){flowViewNameDialog.close();}.bind(this)}]});return flowViewNameDialog;}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.Overlay=Clazz.extend({facade:undefined,styleNode:undefined,construct:function(facade){this.facade=facade;this.changes=[];this.facade.registerOnEvent(ORYX.CONFIG.EVENT_OVERLAY_SHOW,this.show.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_OVERLAY_HIDE,this.hide.bind(this));this.styleNode=document.createElement('style')
this.styleNode.setAttributeNS(null,'type','text/css')
document.getElementsByTagName('head')[0].appendChild(this.styleNode)},show:function(options){if(!options||!options.shapes||!options.shapes instanceof Array||!options.id||!options.id instanceof String||options.id.length==0){return}
if(options.attributes){options.shapes.each(function(el){if(!el instanceof ORYX.Core.Shape){return}
this.setAttributes(el.node,options.attributes)}.bind(this))}
var isSVG=true
try{isSVG=options.node&&options.node instanceof SVGElement;}catch(e){}
if(options.node&&isSVG){options["_temps"]=[]
options.shapes.each(function(el,index){if(!el instanceof ORYX.Core.Shape){return}
var _temp={}
_temp.svg=options.dontCloneNode?options.node:options.node.cloneNode(true);el.node.firstChild.appendChild(_temp.svg)
if(el instanceof ORYX.Core.Edge&&!options.nodePosition){options['nodePosition']="START"}
if(options.nodePosition){var b=el.bounds;var p=options.nodePosition.toUpperCase();if(el instanceof ORYX.Core.Node&&p=="START"){p="NW";}else if(el instanceof ORYX.Core.Node&&p=="END"){p="SE";}else if(el instanceof ORYX.Core.Edge&&p=="START"){b=el.getDockers().first().bounds}else if(el instanceof ORYX.Core.Edge&&p=="END"){b=el.getDockers().last().bounds}
_temp.callback=function(){var x=0;var y=0;if(p=="NW"){}else if(p=="N"){x=b.width()/2;}else if(p=="NE"){x=b.width();}else if(p=="E"){x=b.width();y=b.height()/2;}else if(p=="SE"){x=b.width();y=b.height();}else if(p=="S"){x=b.width()/2;y=b.height();}else if(p=="SW"){y=b.height();}else if(p=="W"){y=b.height()/2;}else if(p=="C"){y=b.height()/2;x=b.width()/2;}else if(p=="START"||p=="END"){x=b.width()/2;y=b.height()/2;}else{return}
if(el instanceof ORYX.Core.Edge){x+=b.upperLeft().x;y+=b.upperLeft().y;}
_temp.svg.setAttributeNS(null,"transform","translate("+x+", "+y+")")}.bind(this)
_temp.element=el;_temp.callback();b.registerCallback(_temp.callback);}
options._temps.push(_temp)}.bind(this))}
if(!this.changes[options.id]){this.changes[options.id]=[];}
this.changes[options.id].push(options);},hide:function(options){if(!options||!options.id||!options.id instanceof String||options.id.length==0||!this.changes[options.id]){return}
this.changes[options.id].each(function(option){option.shapes.each(function(el,index){if(!el instanceof ORYX.Core.Shape){return}
this.deleteAttributes(el.node)}.bind(this));if(option._temps){option._temps.each(function(tmp){if(tmp.svg&&tmp.svg.parentNode){tmp.svg.parentNode.removeChild(tmp.svg)}
if(tmp.callback&&tmp.element){tmp.element.bounds.unregisterCallback(tmp.callback)}}.bind(this))}}.bind(this));this.changes[options.id]=null;},setAttributes:function(node,attributes){var childs=this.getAllChilds(node.firstChild.firstChild)
var ids=[]
childs.each(function(e){ids.push($A(e.attributes).findAll(function(attr){return attr.nodeValue.startsWith('url(#')}))})
ids=ids.flatten().compact();ids=ids.collect(function(s){return s.nodeValue}).uniq();ids=ids.collect(function(s){return s.slice(5,s.length-1)})
ids.unshift(node.id+' .me')
var attr=$H(attributes);var attrValue=attr.toJSON().gsub(',',';').gsub('"','');var attrMarkerValue=attributes.stroke?attrValue.slice(0,attrValue.length-1)+"; fill:"+attributes.stroke+";}":attrValue;var attrTextValue;if(attributes.fill){var copyAttr=Object.clone(attributes);copyAttr.fill="black";attrTextValue=$H(copyAttr).toJSON().gsub(',',';').gsub('"','');}
csstags=ids.collect(function(s,i){return"#"+s+" * "+(!i?attrValue:attrMarkerValue)+""+(attrTextValue?" #"+s+" text * "+attrTextValue:"")})
var s=csstags.join(" ")+"\n"
this.styleNode.appendChild(document.createTextNode(s));},deleteAttributes:function(node){var delEl=$A(this.styleNode.childNodes).findAll(function(e){return e.textContent.include('#'+node.id)});delEl.each(function(el){el.parentNode.removeChild(el);});},getAllChilds:function(node){var childs=$A(node.childNodes)
$A(node.childNodes).each(function(e){childs.push(this.getAllChilds(e))}.bind(this))
return childs.flatten();}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.KeysMove=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(facade){this.facade=facade;this.copyElements=[];this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:65,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.selectAll.bind(this)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_LEFT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_LEFT,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_LEFT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_LEFT,true)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_RIGHT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_RIGHT,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_RIGHT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_RIGHT,true)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_UP,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_UP,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_UP,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_UP,true)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_DOWN,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_DOWN,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_DOWN,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_DOWN,true)});},selectAll:function(e){Event.stop(e.event);this.facade.setSelection(this.facade.getCanvas().getChildShapes(true))},move:function(key,far,e){Event.stop(e.event);var distance=far?20:5;var selection=this.facade.getSelection();var currentSelection=this.facade.getSelection();var p={x:0,y:0};switch(key){case ORYX.CONFIG.KEY_CODE_LEFT:p.x=-1*distance;break;case ORYX.CONFIG.KEY_CODE_RIGHT:p.x=distance;break;case ORYX.CONFIG.KEY_CODE_UP:p.y=-1*distance;break;case ORYX.CONFIG.KEY_CODE_DOWN:p.y=distance;break;}
selection=selection.findAll(function(shape){if(shape instanceof ORYX.Core.Node&&shape.dockers.length==1&&selection.include(shape.dockers.first().getDockedShape())){return false}
var s=shape.parent;do{if(selection.include(s)){return false}}while(s=s.parent);return true;});var edgesMovable=true;var onlyEdgesSelected=selection.all(function(shape){if(shape instanceof ORYX.Core.Edge){if(shape.isDocked()){edgesMovable=false;}
return true;}
return false;});if(onlyEdgesSelected&&!edgesMovable){return;}
selection=selection.map(function(shape){if(shape instanceof ORYX.Core.Node){return shape}else if(shape instanceof ORYX.Core.Edge){var dockers=shape.dockers;if(selection.include(shape.dockers.first().getDockedShape())){dockers=dockers.without(shape.dockers.first())}
if(selection.include(shape.dockers.last().getDockedShape())){dockers=dockers.without(shape.dockers.last())}
return dockers}else{return null}}).flatten().compact();if(selection.size()>0){var selectionBounds=[this.facade.getCanvas().bounds.lowerRight().x,this.facade.getCanvas().bounds.lowerRight().y,0,0];selection.each(function(s){selectionBounds[0]=Math.min(selectionBounds[0],s.bounds.upperLeft().x);selectionBounds[1]=Math.min(selectionBounds[1],s.bounds.upperLeft().y);selectionBounds[2]=Math.max(selectionBounds[2],s.bounds.lowerRight().x);selectionBounds[3]=Math.max(selectionBounds[3],s.bounds.lowerRight().y);});if(selectionBounds[0]+p.x<0)
p.x=-selectionBounds[0];if(selectionBounds[1]+p.y<0)
p.y=-selectionBounds[1];if(selectionBounds[2]+p.x>this.facade.getCanvas().bounds.lowerRight().x)
p.x=this.facade.getCanvas().bounds.lowerRight().x-selectionBounds[2];if(selectionBounds[3]+p.y>this.facade.getCanvas().bounds.lowerRight().y)
p.y=this.facade.getCanvas().bounds.lowerRight().y-selectionBounds[3];if(p.x!=0||p.y!=0){var commands=[new ORYX.Core.Command.Move(selection,p,null,currentSelection,this)];this.facade.executeCommands(commands);}}},getUndockedCommant:function(shapes){var undockEdgeCommand=ORYX.Core.Command.extend({construct:function(moveShapes){this.dockers=moveShapes.collect(function(shape){return shape instanceof ORYX.Core.Controls.Docker?{docker:shape,dockedShape:shape.getDockedShape(),refPoint:shape.referencePoint}:undefined}).compact();},execute:function(){this.dockers.each(function(el){el.docker.setDockedShape(undefined);})},rollback:function(){this.dockers.each(function(el){el.docker.setDockedShape(el.dockedShape);el.docker.setReferencePoint(el.refPoint);})}});command=new undockEdgeCommand(shapes);command.execute();return command;},});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.Save=Clazz.extend({autoSave:null,buttons:null,facade:undefined,processURI:undefined,construct:function(facade){this.buttons={};this.facade=facade;ORYX.Plugins.Save.facade=this.facade;this.autoSave={'hasSaved':false,'isAutoSaved':this.isAutoSaved.bind(this),'functionality':this.save.bind(this,false,true,true,null)};ORYX.Plugins.Save.autoSave=this.autoSave;this.saveForPublish={'functionality':this.save.bind(this,false,false)}
ORYX.Plugins.Save.saveForPublish=this.saveForPublish;this.buttons.save={'id':"saveButton",'name':ORYX.I18N.Save.save,'functionality':this.save.bind(this,false,false,false,null),'group':ORYX.I18N.Save.group,'icon':ORYX.PATH+"images/disk.png",'description':ORYX.I18N.Save.saveDesc,'index':1,'minShape':0,'maxShape':0,'toggle':false,'isEnabled':function(){var enabled=false;var changeDifference=this.facade.getChangeDifference();if(!this.facade.isReadonly&&(changeDifference!=0||this.facade.isAutoSave())){enabled=true;}
ORYX.Log.trace("ORYX.Plugins.Save.construct()::saveButton isEnabled = "+enabled+", changeDifference = "+changeDifference);return enabled;}.bind(this)};this.facade.offer(this.buttons.save);this.buttons.saveAs={'id':"saveAsButton",'name':ORYX.I18N.Save.saveAs,'functionality':this.save.bind(this,true,false,false,null),'group':ORYX.I18N.Save.group,'icon':ORYX.PATH+"images/disk_multi.png",'description':ORYX.I18N.Save.saveAsDesc,'index':2,'minShape':0,'maxShape':0};this.facade.offer(this.buttons.saveAs);ORYX.Plugins.Save.buttons=this.buttons;Event.observe(window,'beforeunload',this.onUnLoad.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,function(){ORYX.Log.trace("ORYX.Plugins.Save.construct()::ORYX.CONFIG.EVENT_LOADED");}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_STATUS,function(options){ORYX.Log.trace("ORYX.Plugins.Save.construct()::ORYX.CONFIG.EVENT_LOADING_STATUS");if(options.text===ORYX.I18N.Save.saved){this.facade.resetChangeDifference();}
this._updateButtonStatus();}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_EXECUTE,this._updateButtonStatus.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_ROLLBACK,this._updateButtonStatus.bind(this));},onUnLoad:function(evt){if(!this.facade.isReadonly&&(this.facade.getChangeDifference()!==0||this.autoSave.hasSaved)){evt.returnValue=ORYX.I18N.Save.unsavedData;return ORYX.I18N.Save.unsavedData;}},_isAlphaNumeric:function(s){var exp=new RegExp(/^([ a-zA-Z0-9_-]+)$/);return exp.test(s);},_isTitleTooLong:function(s){return(s.length>256?true:false);},_isDescriptionTooLong:function(s){return(s.length>512?true:false);},_updateButtonStatus:function(){if(this.buttons.save.isEnabled()){this.buttons.save["buttonInstance"].enable();}else{this.buttons.save["buttonInstance"].disable();}},_isJSON:function(s){var str=s;if(str.blank())return false;str=this.replace(/\\./g,'@').replace(/"[^"\\\n\r]*"/g,'');return(/^[,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]*$/).test(str);},isAutoSaved:function(){return this.autoSave.hasSaved;},saveSynchronously:function(forceNew,quickSave,isAuto,isPromise,summary){var self=this;this.autoSave.hasSaved=isAuto;var reqURI='';if(this.processURI){reqURI=this.processURI;}
else{if(!location.hash.slice(1)){reqURI=ORYX.PATH+"poem/new";}
else{reqURI=ORYX.PATH+'poem/'+(location.hash.slice(1).replace(/^\/?/,"").replace(/\/?$/,""))+"/self";}}
if(forceNew){var ss=this.facade.getStencilSets();var source=ss[ss.keys()[0]].source().split('stencilsets')[1];reqURI=ORYX.PATH+'poem'+ORYX.CONFIG.ORYX_NEW_URL+"?stencilset=/stencilsets"+source;}
var svgClone=this.facade.getCanvas().getSVGRepresentation(true);var svgDOM=DataManager.serialize(svgClone);this.serializedDOM=Ext.encode(this.facade.getJSON());if(reqURI.include(ORYX.CONFIG.ORYX_NEW_URL)){var ss=this.facade.getStencilSets().values()[0]
var defaultData={title:ORYX.I18N.Save.newProcess,summary:'',type:ss.title(),url:reqURI,namespace:ss.namespace()}
var dialog=new Ext.XTemplate('<form class="oryx_repository_edit_model" action="#" id="edit_model" onsubmit="return false;">','<fieldset>','<p class="description">'+ORYX.I18N.Save.dialogDesciption+'</p>','<input type="hidden" name="namespace" value="{namespace}" />','<p><label for="edit_model_title">'+ORYX.I18N.Save.dialogLabelTitle+'</label><input type="text" class="text" name="title" value="{title}" id="edit_model_title" maxlength="256" onfocus="this.className = \'text activated\'" onblur="this.className = \'text\'"/></p>','<p><label for="edit_model_summary">'+ORYX.I18N.Save.dialogLabelDesc+'</label>','   <textarea rows="5" name="summary" id="edit_model_summary" onfocus="this.className = \'activated\'">{summary}</textarea>','   <span style="padding-left:108px;" class="description">'+ORYX.I18N.Save.summaryMaxCharaters+'</span>','</p>','<p><label for="edit_model_type">'+ORYX.I18N.Save.dialogLabelType+'</label><input type="text" name="type" class="text disabled" value="{type}" disabled="disabled" id="edit_model_type" /></p>','<p id="save-validation-status" class="validation-error" style="display:none;">&#160;</p>','</fieldset>','</form>')
callback=function(form){var title=form.elements["title"].value.strip();title=title.length==0?defaultData.title:title;var summary=form.elements["summary"].value.strip();summary=summary.length==0?defaultData.summary:summary;var namespace=form.elements["namespace"].value.strip();namespace=namespace.length==0?defaultData.namespace:namespace;if(!this._isAlphaNumeric(title)){$('save-validation-status').update(ORYX.I18N.Save.dialogTitleValidation).show();}else if(this._isTitleTooLong(title)){$('save-validation-status').update(ORYX.I18N.Save.dialogTitleLengthValidation).show();}else if(this._isDescriptionTooLong(summary)){$('save-validation-status').update(ORYX.I18N.Save.dialogDescriptionLengthValidation).show();}else{win.destroy();this.facade.setWorkflowTitleHeader(title);this.sendSaveRequest(reqURI,{data:this.serializedDOM,svg:svgDOM,title:title,summary:summary,type:namespace},forceNew);}}.bind(this);win=new Ext.Window({id:'Propertie_Window',width:'auto',height:'auto',title:forceNew?ORYX.I18N.Save.saveAsTitle:ORYX.I18N.Save.save,modal:true,bodyStyle:'background:#FFFFFF',html:dialog.apply(defaultData),buttons:[{text:ORYX.I18N.Save.saveBtn,handler:function(){callback($('edit_model'))}},{text:ORYX.I18N.Save.close,handler:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});win.destroy();}.bind(this)}]});win.show();}else if(!quickSave&&isPromise){this.sendSaveRequest(reqURI,{data:this.serializedDOM,svg:svgDOM,description:summary?summary:""},forceNew,isPromise);}else{if(quickSave){this.sendSaveRequest(reqURI,{data:this.serializedDOM,svg:svgDOM,autoSave:isAuto},false,isPromise);}else{var defaultData={title:ORYX.I18N.Save.newProcess,summary:'',url:reqURI};var dialog=new Ext.XTemplate('<form class="oryx_repository_edit_model" action="#" id="save_existing_model" onsubmit="return false;">','<fieldset>','<p class="description">Please provide a description for this version</p>','<p><label for="edit_model_summary">'+ORYX.I18N.Save.dialogLabelDesc+'</label>','   <textarea rows="5" name="summary" id="edit_model_summary" onfocus="this.className = \'activated\'">{summary}</textarea>','   <span style="padding-left:108px;" class="description">'+ORYX.I18N.Save.summaryMaxCharaters+'</span>','</p>','<p id="save-validation-status" class="validation-error" style="display:none;">&#160;</p>','</fieldset>','</form>');var win=null;var callback=function(form){var summary=form.elements["summary"].value.strip();summary=summary.length==0?defaultData.summary:summary;if(this._isDescriptionTooLong(summary)){$('save-validation-status').update(ORYX.I18N.Save.dialogDescriptionLengthValidation).show();}else{win.destroy();this.sendSaveRequest(reqURI,{data:this.serializedDOM,svg:svgDOM,description:summary},forceNew,isPromise);}}.bind(this);win=new Ext.Window({id:'SaveExistingWindow',width:'auto',height:'auto',title:ORYX.I18N.Save.save,modal:true,bodyStyle:'background:#FFFFFF',html:dialog.apply(defaultData),buttons:[{text:ORYX.I18N.Save.saveBtn,handler:function(){callback($('save_existing_model'))}},{text:ORYX.I18N.Save.close,handler:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});win.destroy();}.bind(this)}]});win.show();}}},sendSaveRequest:function(url,params,forceNew,isPromise){var async=false;if(params.autoSave){async=true;}
new Ajax.Request(url,{method:'POST',asynchronous:async,parameters:params,onSuccess:(function(transport){ORYX.Log.debug("ORYX.Plugins.Save.sendSaveRequest()::onSuccess");var loc=transport.getResponseHeader("location");if(loc){this.processURI=loc;}
else{this.processURI=url;}
if(params.title!==undefined&&!params.title.blank()){this.facade.getCanvas().properties['oryx-name']=params.title;this.facade.getCanvas().properties['oryx-key']=params.title;window.document.title=params.title+" - "+ORYX.I18N.Oryx.title.replace(/&amp;/g,"&");}
this.facade.resetChangeDifference();this.facade.setAutoSave(params.autoSave);if(params.autoSave){if(ORYX.contentVersion!="-2"){this.facade.setOrigContentVersion(ORYX.contentVersion);}}
var version="1";if(transport.responseText){var responseJSON=Ext.util.JSON.decode(transport.responseText);if(responseJSON.version!==undefined&&responseJSON.version!==""){version=responseJSON.version;}
ORYX.contentVersion=version;}
if(this.facade.statusbar){if(params.autoSave)
version=ORYX.I18N.Save.autoSave;this.facade.statusbar.setItemText("version",version);}
var modelUri="/model"+this.processURI.split("model")[1].replace(/self\/?$/i,"");location.hash="#"+modelUri;if(forceNew){var newURLWin=new Ext.Window({title:ORYX.I18N.Save.savedAs,bodyStyle:"background:white;padding:10px",width:'auto',height:'auto',html:"<div style='font-weight:bold;margin-bottom:10px'>"+ORYX.I18N.Save.saveAsHint+"</div><span><a href='"+loc+"' target='_blank'>"+loc+"</a></span>",buttons:[{text:'Ok',handler:function(){newURLWin.destroy()}}]});newURLWin.show();}
this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.Save.saved,promise:isPromise});var managerFacade=window.opener.RepositoryCore.getFacade();managerFacade.applyFilter();managerFacade.modelCache.setData(managerFacade.getDisplayedModels(),"/meta",null,function(){managerFacade.applyFilter()});managerFacade.modelCache.setGetData(managerFacade.getDisplayedModels(),"/access",null,function(){managerFacade.applyFilter()});}).bind(this),onFailure:(function(transport){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});var errorMessage=ORYX.I18N.Save.failed;if(transport.responseText.include("MODEL_EXISTS")){errorMessage=String.format(ORYX.I18N.Save.notUnique,params.title);}
if(params.autoSave){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.Save.autosaveFailed});}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,errorMessage);}
ORYX.Log.warn("Saving failed: "+transport.responseText);}).bind(this),onException:(function(transport,e){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});var errorMessage=ORYX.I18N.Save.serverUnavailable;Ext.Msg.alert(ORYX.I18N.Oryx.title,errorMessage);ORYX.Log.warn("Saving failed: "+transport.responseText);}).bind(this),on403:(function(transport){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.noRights);ORYX.Log.warn("Saving failed: "+transport.responseText);}).bind(this)});},save:function(forceNew,isAuto,isPromise,summary,obj,event){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Save.saving});var quickSave=false;if((event&&event.shiftKey)||isAuto)
quickSave=true;window.setTimeout((function(){this.saveSynchronously(forceNew,quickSave,isAuto,isPromise,summary);}).bind(this),10);return true;}});ORYX.Plugins.File=Clazz.extend({facade:undefined,construct:function(facade){this.facade=facade;},info:function(){var info='<iframe src="'+ORYX.CONFIG.LICENSE_URL+'" type="text/plain" '+'style="border:none;display:block;width:575px;height:460px;"/>'+'\n\n<pre style="display:inline;">Version: </pre>'+'<iframe src="'+ORYX.CONFIG.VERSION_URL+'" type="text/plain" '+'style="border:none;overflow:hidden;display:inline;width:40px;height:20px;"/>';this.infoBox=Ext.Msg.show({title:ORYX.I18N.Oryx.title,msg:info,width:640,maxWidth:640,maxHeight:480,buttons:Ext.MessageBox.OK});return false;},exportPDF:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.File.genPDF});var resource=location.href;var svgClone=this.facade.getCanvas().getSVGRepresentation(true);var svgDOM=DataManager.serialize(svgClone);new Ajax.Request(ORYX.CONFIG.PDF_EXPORT_URL,{method:'POST',parameters:{resource:resource,data:svgDOM,format:"pdf"},onSuccess:(function(request){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});window.open(request.responseText);}).bind(this),onFailure:(function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.File.genPDFFailed);}).bind(this)});},print:function(){Ext.Msg.show({title:ORYX.I18N.File.printTitle,msg:ORYX.I18N.File.printMsg,buttons:Ext.Msg.YESNO,icon:Ext.MessageBox.QUESTION,fn:function(btn){if(btn=="yes"){var option=$H({width:300,height:400,toolbar:"no",status:"no",menubar:"yes",dependent:"yes",resizable:"yes",scrollbars:"yes"});var newWindow=window.open("","PrintWindow",option.invoke('join','=').join(','));var head=newWindow.document.getElementsByTagName('head')[0];var style=document.createElement("style");style.innerHTML=" body {padding:0px; margin:0px} .svgcontainer { display:none; }";head.appendChild(style);newWindow.document.getElementsByTagName('body')[0].appendChild(this.facade.getCanvas().getSVGRepresentation());var svg=newWindow.document.getElementsByTagName('body')[0].getElementsByTagName('svg')[0];svg.setAttributeNS(null,'width',1100);svg.setAttributeNS(null,'height',1400);svg.lastChild.setAttributeNS(null,'transform','scale(0.47, 0.47) rotate(270, 1510, 1470)');var markers=['marker-start','marker-mid','marker-end']
var path=$A(newWindow.document.getElementsByTagName('path'));path.each(function(pathNode){markers.each(function(marker){var url=pathNode.getAttributeNS(null,marker);if(!url){return};url="url(about:blank#"+url.slice(5);pathNode.setAttributeNS(null,marker,url);});});newWindow.print();return true;}}.bind(this)});}});window.onOryxResourcesLoaded=function(){if(location.hash.slice(1).length==0||location.hash.slice(1).indexOf('new')!=-1){var stencilset=ORYX.Utils.getParamFromUrl('stencilset')||ORYX.CONFIG.SSET;if(stencilset.indexOf("/")==0){stencilset=stencilset.substring(1,stencilset.length);}
top_editor=new ORYX.Editor({id:'oryx-canvas123',stencilset:{url:ORYX.PATH+stencilset}});}else{ORYX.Editor.createByUrl(ORYX.PATH+"poem"+location.hash.slice(1)+'/json'+location.search,{id:'oryx-canvas123'});}};Ext.namespace("ORYX.Plugins");ORYX.Plugins.LivePreviewPlugin=ORYX.Plugins.AbstractPlugin.extend({setup:function(){try{this.modelId=(location.hash.slice(1).replace(/^\/?/,"").replace(/\/?$/,"")).replace(/model\//,"");this.handlerURL=ORYX.PATH+"poem/livePreview";}catch(e){}},construct:function(facade){ORYX.Log.debug("LivePreviewPlugin.construct");this.facade=facade;ORYX.Plugins.LivePreviewPlugin.facade=this.facade;this.shapeSelection=new Hash();this.shapeSelection.shapes=new Array();this.selectedShape=null;arguments.callee.$.construct.apply(this,arguments);var previewButton={'id':'livePreviewButton','name':'Live Preview','functionality':this.showTestPanel.bind(this),'group':'Workflow Test','icon':ORYX.PATH+"images/application_lightning.png",'description':'Preview the display step to see how it would appear to the end user.','index':1,'minShape':1,'maxShape':1,'isEnabled':function(){if(this.shapeSelection.shapes.length==1&&this.shapeSelection.shapes.first().getStencil()){return this.shapeSelection.shapes.first().getStencil().isDisplayNode();}
return false;}.bind(this)};this.facade.offer(previewButton);this.previewButton=previewButton;this.setup();this.init();},init:function(){ORYX.Log.debug("LivePreviewPlugin.init");},onSelectionChanged:function(event){ORYX.Log.debug("LivePreviewPlugin.onSelectionChanged");this.selectedShape=null;this.shapeSelection.shapes=event.elements;if(event.elements.length==0){this.shapeSelection.shapes=[this.facade.getCanvas()];}
if(event.subSelection){this.shapeSelection.shapes=[event.subSelection];}
this.previewButton["buttonInstance"].disable();if(this.shapeSelection.shapes.length==1&&this.shapeSelection.shapes.first().getStencil()){var id=this.shapeSelection.shapes.first().getStencil().id();ORYX.Log.debug("LivePreviewPlugin.onSelectionChanged: id = "+id);var isDisplayNodeProp=this.shapeSelection.shapes.first().getStencil().isDisplayNode();if(isDisplayNodeProp==true){this.selectedShape=this.shapeSelection.shapes.first();ORYX.Plugins.LivePreviewPlugin.selectedShape=this.selectedShape;this.previewButton["buttonInstance"].enable();}}},showTestPanel:function(){ORYX.Log.debug("LivePreviewPlugin.showTestPanel");var self=this;var testName=String.format(ORYX.CONFIG.TEST_PANEL_WF_PREFIX,this.modelId,new Date().getTime());var channel=this.facade.getPropertyWindow().getChannel();var testURL=String.format(ORYX.CONFIG.LIVE_PREVIEW_URL,testName,"true","true",channel,ORYX.CONFIG.LIVE_PREVIEW_DEFAULT_CHANNEL);var center,south,dialog;center=new Ext.Panel({region:'center',html:'<iframe name="workflowTestPanel" id="workflowTestPanel" frameborder="0" height="100" width="100" scrolling="auto" src="about:blank"></iframe>',cls:'wf-test-body-panel'});south=new Ext.Panel({region:'south',height:28,html:'<div class="wf-wait"><span class="wait-message">'+MOTV.I18N.LivePreviewPanel.waitMsg+'</span></div>',cls:'wf-test-status-panel'});var _setupIframe=function(){var h=(south.isVisible())?dialog.getInnerHeight()-28:dialog.getInnerHeight()-4;var w=dialog.getInnerWidth()-4;Ext.get('workflowTestPanel').setSize(w,h,false);};var dw=ORYX.CONFIG.LIVE_PREVIEW_WIDTH||800;if(dw>window.innerWidth){dw=window.innerWidth-32;}
var dh=ORYX.CONFIG.LIVE_PREVIEW_HEIGHT||600;if(dh>window.innerHeight){dh=window.innerHeight-32;}
dialog=new Ext.Window({layout:'border',autoCreate:true,title:MOTV.I18N.LivePreviewPanel.pluginName,height:dh,width:dw,modal:true,collapsible:false,maximizable:true,fixedcenter:true,shadow:true,proxyDrag:true,plain:true,items:[center,south],keys:[{key:27,fn:function(){dialog.close()}.bind(this)}],listeners:{hide:function(){dialog.close();}.bind(this),show:function(){_setupIframe();}},buttons:[{text:'Close',handler:function(){dialog.close();}.bind(this)}]});dialog.show();dialog.on('bodyresize',function(){_setupIframe();});dialog.on('afterlayout',function(){_setupIframe();});var facadeJSON=this.facade.getJSON();function onShowError(response){south.hide();dialog.doLayout();ORYX.Log.error("LivePreviewPlugin.showTestPanel()::ajax request for publish failed, status was "+response.status);var responseJSON=Ext.util.JSON.decode(response.responseText);var errMsg=String.format(MOTV.I18N.LivePreviewPanel.errorMsg,Ext.util.Format.htmlEncode(responseJSON.errorMessage));if(responseJSON.extendedError)
errMsg+=" <a href='#' onclick='Ext.get(this).parent().child(\"#extended-error-info\").setVisibilityMode(Ext.Element.DISPLAY).toggle(); return false;'>More</a><pre id='extended-error-info' style='display:none;overflow:auto;width:100%;height:200px;margin-top:5px'>"+Ext.util.Format.htmlEncode(responseJSON.extendedError)+"</pre>";Ext.Msg.show({title:MOTV.I18N.LivePreviewPanel.error,msg:errMsg,minWidth:500,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR,fn:function(btn,text){if(btn=='ok'){dialog.close();}}});}
new Ajax.Request(this.handlerURL,{method:'post',parameters:{name:testName,json:Ext.encode(facadeJSON),selectedShapeId:this.selectedShape.resourceId},onSuccess:function(response){Ext.get('workflowTestPanel').addListener('load',function(){south.hide();dialog.doLayout();},self,{single:true});var responseJSON=Ext.util.JSON.decode(response.responseText);var launchUrl=testURL;if(responseJSON.wfName){launchUrl=String.format(ORYX.CONFIG.LIVE_PREVIEW_URL,responseJSON.wfName,"true","true",channel,ORYX.CONFIG.LIVE_PREVIEW_DEFAULT_CHANNEL);}
Ext.get('workflowTestPanel').dom.src=launchUrl;},onFailure:onShowError,onException:onShowError});}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.ERDFSupport=Clazz.extend({facade:undefined,ERDFServletURL:'/erdfsupport',construct:function(facade){this.facade=facade;},importERDF:function(){this._showImportDialog();},exportERDF:function(){Ext.Msg.show({title:ORYX.I18N.ERDFSupport.deprTitle,msg:ORYX.I18N.ERDFSupport.deprText,buttons:Ext.Msg.YESNO,fn:function(buttonId){if(buttonId==='yes'){var s=this.facade.getERDF();this.openDownloadWindow(window.document.title+".xml",s);}}.bind(this),icon:Ext.MessageBox.WARNING});},sendRequest:function(url,params,successcallback,failedcallback){var suc=false;new Ajax.Request(url,{method:'POST',asynchronous:false,parameters:params,onSuccess:function(transport){suc=true;if(successcallback){successcallback(transport.result)}}.bind(this),onFailure:function(transport){if(failedcallback){failedcallback();}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.ERDFSupport.impFailed);ORYX.log.warn("Import ERDF failed: "+transport.responseText);}}.bind(this)});return suc;},loadERDF:function(erdfString,success,failed){var s=erdfString;s=s.startsWith('<?xml')?s:'<?xml version="1.0" encoding="utf-8"?>'+s+'';var parser=new DOMParser();var doc=parser.parseFromString(s,"text/xml");if(doc.firstChild.tagName=="parsererror"){Ext.MessageBox.show({title:ORYX.I18N.ERDFSupport.error,msg:ORYX.I18N.ERDFSupport.impFailed2+doc.firstChild.textContent.escapeHTML(),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});if(failed)
failed();}else if(!this.hasStencilSet(doc)){if(failed)
failed();}else{this.facade.importERDF(doc);if(success)
success();}},hasStencilSet:function(doc){var getElementsByClassNameFromDiv=function(doc,id){return $A(doc.getElementsByTagName('div')).findAll(function(el){return $A(el.attributes).any(function(attr){return attr.nodeName=='class'&&attr.nodeValue==id})})}
var editorNode=getElementsByClassNameFromDiv(doc,'-oryx-canvas')[0];if(!editorNode){this.throwWarning(ORYX.I18N.ERDFSupport.noCanvas);return false}
var stencilSetNode=$A(editorNode.getElementsByTagName('a')).find(function(node){return node.getAttribute('rel')=='oryx-stencilset'});if(!stencilSetNode){this.throwWarning(ORYX.I18N.ERDFSupport.noSS);return false}
var stencilSetUrl=stencilSetNode.getAttribute('href').split("/")
stencilSetUrl=stencilSetUrl[stencilSetUrl.length-2]+"/"+stencilSetUrl[stencilSetUrl.length-1];return true;},throwWarning:function(text){Ext.MessageBox.show({title:ORYX.I18N.Oryx.title,msg:text,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});},openXMLWindow:function(content){var win=window.open('data:application/xml,'+encodeURIComponent(content),'_blank',"resizable=yes,width=600,height=600,toolbar=0,scrollbars=yes");},openDownloadWindow:function(file,content){var win=window.open("");if(win!=null){win.document.open();win.document.write("<html><body>");var submitForm=win.document.createElement("form");win.document.body.appendChild(submitForm);submitForm.appendChild(this.createHiddenElement("download",content));submitForm.appendChild(this.createHiddenElement("file",file));submitForm.method="POST";win.document.write("</body></html>");win.document.close();submitForm.action=ORYX.PATH+"download";submitForm.submit();}},createHiddenElement:function(name,value){var newElement=document.createElement("input");newElement.name=name;newElement.type="hidden";newElement.value=value;return newElement},_showImportDialog:function(successCallback){var form=new Ext.form.FormPanel({baseCls:'x-plain',labelWidth:50,defaultType:'textfield',items:[{text:ORYX.I18N.ERDFSupport.selectFile,style:'font-size:12px;margin-bottom:10px;display:block;',anchor:'100%',xtype:'label'},{fieldLabel:ORYX.I18N.ERDFSupport.file,name:'subject',inputType:'file',style:'margin-bottom:10px;display:block;',itemCls:'ext_specific_window_overflow'},{xtype:'textarea',hideLabel:true,name:'msg',anchor:'100% -63'}]});var dialog=new Ext.Window({autoCreate:true,layout:'fit',plain:true,bodyStyle:'padding:5px;',title:ORYX.I18N.ERDFSupport.impERDF,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[form],buttons:[{text:ORYX.I18N.ERDFSupport.impBtn,handler:function(){var loadMask=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.ERDFSupport.impProgress});loadMask.show();window.setTimeout(function(){var erdfString=form.items.items[2].getValue();this.loadERDF(erdfString,function(){loadMask.hide();dialog.hide()}.bind(this),function(){loadMask.hide();}.bind(this))}.bind(this),100);}.bind(this)},{text:ORYX.I18N.ERDFSupport.close,handler:function(){dialog.hide();}.bind(this)}]});dialog.on('hide',function(){dialog.destroy(true);delete dialog;});dialog.show();form.items.items[1].getEl().dom.addEventListener('change',function(evt){var text=evt.target.files[0].getAsText('UTF-8');form.items.items[2].setValue(text);},true)}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.ShapeHighlighting=Clazz.extend({construct:function(facade){this.parentNode=facade.getCanvas().getSvgContainer();this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parentNode,['g']);this.highlightNodes={};facade.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,this.setHighlight.bind(this));facade.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,this.hideHighlight.bind(this));},setHighlight:function(options){if(options&&options.highlightId){var node=this.highlightNodes[options.highlightId];if(!node){node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,['path',{"stroke-width":2.0,"fill":"none"}]);this.highlightNodes[options.highlightId]=node;}
if(options.elements&&options.elements.length>0){this.setAttributesByStyle(node,options);this.show(node);}else{this.hide(node);}}},hideHighlight:function(options){if(options&&options.highlightId&&this.highlightNodes[options.highlightId]){this.hide(this.highlightNodes[options.highlightId]);}},hide:function(node){node.setAttributeNS(null,'display','none');},show:function(node){node.setAttributeNS(null,'display','');},setAttributesByStyle:function(node,options){if(options.style&&options.style==ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE){var bo=options.elements[0].absoluteBounds();var strWidth=options.strokewidth?options.strokewidth:ORYX.CONFIG.BORDER_OFFSET
node.setAttributeNS(null,"d",this.getPathRectangle(bo.a,bo.b,strWidth));node.setAttributeNS(null,"stroke",options.color?options.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);node.setAttributeNS(null,"stroke-opacity",options.opacity?options.opacity:0.2);node.setAttributeNS(null,"stroke-width",strWidth);}else if(options.elements.length==1&&options.elements[0]instanceof ORYX.Core.Edge&&options.highlightId!="selection"){node.setAttributeNS(null,"d",this.getPathEdge(options.elements[0].dockers));node.setAttributeNS(null,"stroke",options.color?options.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);node.setAttributeNS(null,"stroke-opacity",options.opacity?options.opacity:0.2);node.setAttributeNS(null,"stroke-width",ORYX.CONFIG.OFFSET_EDGE_BOUNDS);}else{node.setAttributeNS(null,"d",this.getPathByElements(options.elements));node.setAttributeNS(null,"stroke",options.color?options.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);node.setAttributeNS(null,"stroke-opacity",options.opacity?options.opacity:1.0);node.setAttributeNS(null,"stroke-width",options.strokewidth?options.strokewidth:2.0);}},getPathByElements:function(elements){if(!elements||elements.length<=0){return undefined}
var padding=ORYX.CONFIG.SELECTED_AREA_PADDING;var path=""
elements.each((function(element){if(!element){return}
var bounds=element.absoluteBounds();bounds.widen(padding)
var a=bounds.upperLeft();var b=bounds.lowerRight();path=path+this.getPath(a,b);}).bind(this));return path;},getPath:function(a,b){return this.getPathCorners(a,b);},getPathCorners:function(a,b){var size=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var path=""
path=path+"M"+a.x+" "+(a.y+size)+" l0 -"+size+" l"+size+" 0 ";path=path+"M"+a.x+" "+(b.y-size)+" l0 "+size+" l"+size+" 0 ";path=path+"M"+b.x+" "+(b.y-size)+" l0 "+size+" l-"+size+" 0 ";path=path+"M"+b.x+" "+(a.y+size)+" l0 -"+size+" l-"+size+" 0 ";return path;},getPathRectangle:function(a,b,strokeWidth){var size=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var path=""
var offset=strokeWidth/2.0;path=path+"M"+(a.x+offset)+" "+(a.y);path=path+" L"+(a.x+offset)+" "+(b.y-offset);path=path+" L"+(b.x-offset)+" "+(b.y-offset);path=path+" L"+(b.x-offset)+" "+(a.y+offset);path=path+" L"+(a.x+offset)+" "+(a.y+offset);return path;},getPathEdge:function(edgeDockers){var length=edgeDockers.length;var path="M"+edgeDockers[0].bounds.center().x+" "
+edgeDockers[0].bounds.center().y;for(i=1;i<length;i++){var dockerPoint=edgeDockers[i].bounds.center();path=path+" L"+dockerPoint.x+" "+dockerPoint.y;}
return path;}});ORYX.Plugins.HighlightingSelectedShapes=Clazz.extend({construct:function(facade){this.facade=facade;this.opacityFull=0.9;this.opacityLow=0.4;},onSelectionChanged:function(event){if(event.elements&&event.elements.length>1){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:'selection',elements:event.elements.without(event.subSelection),color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:!event.subSelection?this.opacityFull:this.opacityLow});if(event.subSelection){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:'subselection',elements:[event.subSelection],color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:this.opacityFull});}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:'subselection'});}}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:'selection'});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:'subselection'});}}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.PluginLoader=Clazz.extend({facade:undefined,mask:undefined,processURI:undefined,construct:function(facade){this.facade=facade;},showManageDialog:function(){this.mask=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.Oryx.pleaseWait});this.mask.show();var data=[];var plugins=[];var loadedStencilSetsNamespaces=this.facade.getStencilSets().keys();this.facade.getAvailablePlugins().each(function(match){if((!match.requires||!match.requires.namespaces||match.requires.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0}))&&(!match.notUsesIn||!match.notUsesIn.namespaces||!match.notUsesIn.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0}))){plugins.push(match);}});plugins.each(function(plugin){data.push([plugin.name,plugin.engaged===true]);})
if(data.length==0){return};var reader=new Ext.data.ArrayReader({},[{name:'name'},{name:'engaged'}]);var sm=new Ext.grid.CheckboxSelectionModel({listeners:{beforerowselect:function(sm,nbr,exist,rec){this.mask=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.Oryx.pleaseWait});this.mask.show();this.facade.activatePluginByName(rec.data.name,function(sucess,err){this.mask.hide();if(!!sucess){sm.suspendEvents();sm.selectRow(nbr,true);sm.resumeEvents();}else{Ext.Msg.show({title:ORYX.I18N.PluginLoad.loadErrorTitle,msg:ORYX.I18N.PluginLoad.loadErrorDesc+ORYX.I18N.PluginLoad[err],buttons:Ext.MessageBox.OK});}}.bind(this));return false;}.bind(this),rowdeselect:function(sm,nbr,rec){sm.suspendEvents();sm.selectRow(nbr,true);sm.resumeEvents();}}});var grid2=new Ext.grid.GridPanel({store:new Ext.data.Store({reader:reader,data:data}),cm:new Ext.grid.ColumnModel([{id:'name',width:390,sortable:true,dataIndex:'name'},sm]),sm:sm,width:450,height:250,frame:true,hideHeaders:true,iconCls:'icon-grid',listeners:{render:function(){var recs=[];this.grid.getStore().each(function(rec){if(rec.data.engaged){recs.push(rec);}}.bind(this));this.suspendEvents();this.selectRecords(recs);this.resumeEvents();}.bind(sm)}});var newURLWin=new Ext.Window({title:ORYX.I18N.PluginLoad.WindowTitle,width:'auto',height:'auto',modal:true});newURLWin.add(grid2);newURLWin.show();this.mask.hide();}})
if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.SyntaxChecker=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.errorPanel=new ORYX.Editor.SyntaxErrorGridPanel({facade:this.facade,layout:'fit',autoScroll:true,refreshHandler:this.perform.bind(this)});this.facade.dockToolPanel(this.errorPanel);this.errorStore=this.errorPanel.getStore();this.errorStore.on("clear",function(store){this.resetErrors();},this);this.active=false;this.raisedEventIds=[];this.facade.offer({'name':ORYX.I18N.SyntaxChecker.name,'functionality':this.perform.bind(this),'group':'Workflow Test','icon':ORYX.PATH+"images/checker_syntax.png",'description':ORYX.I18N.SyntaxChecker.desc,'index':0,'toggle':false,'minShape':0,'maxShape':0});this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,this.checkForErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT,this.resetErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT,this.doShowErrors.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_FLOW_VIEW_CHANGE,this.updateShowErrors.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_FLOWEDITOR_FLOW_CHANGE,this.updateShowErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.MotivePlugin.PUBLISH.PUBLISH_SUCCESS,this.resetErrors.bind(this));},perform:function(button,pressed){this.resetErrors();this.checkForErrors({onNoErrors:function(){this.setActivated(button,false);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.noErrors,timeout:10000});}.bind(this),onErrors:function(){this.enableDeactivationHandler(button);var currentFlowView=this.facade.getCurrentFlowView();var syntaxCheckText=null;var flowViewsWithErrors=this.getFlowViewsWithErrors();var otherFlowViewsWithErrors=flowViewsWithErrors.without(currentFlowView);if(otherFlowViewsWithErrors.length>0){var otherFlowViewErrorsText=ORYX.I18N.SyntaxChecker.otherFlowViewErrors+otherFlowViewsWithErrors.join(",");if(syntaxCheckText){syntaxCheckText+="<p>"+otherFlowViewErrorsText+"</p>";}else{syntaxCheckText=otherFlowViewErrorsText;}}
this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:syntaxCheckText,timeout:10000});this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.SYNTAX_ERRORS_SHOWN_EVENT,flowViewsWithErrors:flowViewsWithErrors});this.setActivated(button,true);}.bind(this),onFailure:function(){this.setActivated(button,false);Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.SyntaxChecker.invalid);}.bind(this)});},enableDeactivationHandler:function(button){},setActivated:function(button,activated){if(activated===undefined){this.active=!this.active;}else{this.active=activated;}},checkForErrors:function(options){Ext.applyIf(options||{},{showErrors:true,onErrors:Ext.emptyFn,onNoErrors:Ext.emptyFn,onFailure:Ext.emptyFn});Ext.Msg.wait(ORYX.I18N.SyntaxChecker.checkingMessage);var ss=this.facade.getStencilSets();var data=null;var includesJson=false;if(ss.keys().include("http://b3mn.org/stencilset/bpmn2.0#")||ss.keys().include("http://b3mn.org/stencilset/bpmn2.0conversation#")||ss.keys().include("http://b3mn.org/stencilset/motive1.0#")||ss.keys().include("http://b3mn.org/stencilset/motivebpmn2.0#")||ss.keys().include("http://b3mn.org/stencilset/motivepof3.0#")||ss.keys().include("http://b3mn.org/stencilset/motivebpmn4.0#")){data=this.facade.getSerializedJSON();includesJson=true;}else{data=this.getRDFFromDOM();}
this.errorPanel.onBeforeLoad();new Ajax.Request(ORYX.CONFIG.SYNTAXCHECKER_URL,{method:'POST',asynchronous:true,parameters:{resource:location.href,data:data,context:options.context,isJson:includesJson},onSuccess:function(request){var resp=(request&&request.responseText?request.responseText:"{}").evalJSON();Ext.Msg.hide();if(resp instanceof Object){resp=$H(resp)
this._processErrors(resp);if(resp.size()>0){if(options.showErrors){this.showErrors();this.facade.focusToolPanel(this.errorPanel);}
options.onErrors();}
else{options.onNoErrors();}}
else{options.onFailure();}}.bind(this),onException:function(){Ext.Msg.hide();options.onFailure();},onFailure:function(){Ext.Msg.hide();options.onFailure();}});},_processErrors:function(errorsResponse){if(!(errorsResponse instanceof Hash)){errorsResponse=new Hash(errorsResponse);}
var datasource=[];if(errorsResponse.flowViewErrors){var errorCount=0;var errorsByFlowView=new Hash(errorsResponse.flowViewErrors);errorsByFlowView.each(function(flowView){var flowViewErrors=flowView[1];if(!(flowViewErrors instanceof Hash))
flowViewErrors=new Hash(flowViewErrors);flowViewErrors.keys().each(function(value){var errors=flowViewErrors[value];if(errors!=null){var numErrors=errors.length;for(var idx=0;idx<numErrors;idx++){var errorObj=errors[idx];datasource.push({flow:flowView[0],simulatable:errorObj.simulatable,resourceID:errorObj.elementID,nodeName:errorObj.name,errorMessage:errorObj.errorMessage,itemID:errorCount++});}}});});}
this.errorStore.loadData({"objects":datasource},false);},doShowErrors:function(event,args){this.showErrors(event.errors);},updateShowErrors:function(event,args){window.setTimeout(function(){if(this.active){this.showErrors();}}.bind(this),100);},showErrors:function(){var currentFlowView=this.facade.getCurrentFlowView();var canvas=this.facade.getCanvas();var processError=null;var raisedErrorOnShape=false;this._getUnfilteredErrorRecords().each(function(errorRecord){if(errorRecord.get("flow")!=currentFlowView)
return;var sh=canvas.getChildShapeByResourceId(errorRecord.get("resourceID"));if(sh){this.raiseOverlay(sh);raisedErrorOnShape=true;}else{if(errorRecord.get("resourceID")===canvas.resourceId){processError=this.parseCodeToMsg(errorRecord.get("errorMessage"));}}},this);var syntaxCheckText=null;if(processError){var processErrorText=ORYX.I18N.SyntaxChecker.flowLevelErrors+processError;if(syntaxCheckText){syntaxCheckText+="<p>"+processErrorText+"</p>";}else{syntaxCheckText=processErrorText;}}
if(syntaxCheckText){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:syntaxCheckText,timeout:10000});}
return raisedErrorOnShape;},getFlowViewsWithErrors:function(){var flowViewsWithErrors=[];if(this.errorStore){var flowNameHash={};this._getUnfilteredErrorRecords().each(function(record){flowNameHash[record.get("flow")]=true;});for(var flowName in flowNameHash){flowViewsWithErrors.push(flowName);}}
return flowViewsWithErrors;},parseCodeToMsg:function(code){var msg=code.replace(/: /g,"<br />").replace(/, /g,"<br />");var codes=msg.split("<br />");for(var i=0;i<codes.length;i++){var singleCode=codes[i];var replacement=this.parseSingleCodeToMsg(singleCode);if(singleCode!=replacement){msg=msg.replace(singleCode,replacement);}}
return msg;},parseSingleCodeToMsg:function(code){return ORYX.I18N.SyntaxChecker[code]||code;},resetErrors:function(){this.raisedEventIds.each(function(id){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:id});}.bind(this))
this.raisedEventIds=[];this._clearErrors();this.active=false;this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.SYNTAX_ERRORS_RESET_EVENT});},raiseOverlay:function(shape,errorMsg){var id="syntaxchecker."+this.raisedEventIds.length;var crossId=ORYX.Editor.provideId();var cross=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,['path',{"id":crossId,"title":"","stroke-width":5.0,"stroke":"red","d":"M20,-5 L5,-20 M5,-5 L20,-20","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:id,shapes:[shape],node:cross,nodePosition:shape instanceof ORYX.Core.Edge?"START":"NW"});var crossElem=Ext.get(crossId);crossElem.on("click",function(e,obj){var errorPanel=this.errorPanel;errorPanel.filterByResourceID(shape.resourceId);this.facade.focusToolPanel(errorPanel);e.stopPropagation();return false;}.bind(this));var tooltip=new Ext.ToolTip({showDelay:50,html:ORYX.I18N.SyntaxChecker.errorIconHover,target:crossId});this.raisedEventIds.push(id);return cross;},_getUnfilteredErrorRecords:function(){return this.errorStore.snapshot?this.errorStore.snapshot:this.errorStore.data;},_clearErrors:function(){this.errorStore.clearFilter(true);if(this.errorStore.getCount()>0)
this.errorStore.removeAll();}});ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT="checkForErrors";ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT="resetErrors";ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT="showErrors";ORYX.Plugins.SyntaxChecker.SYNTAX_ERRORS_SHOWN_EVENT="SyntaxChecker.errorsShown";ORYX.Plugins.SyntaxChecker.SYNTAX_ERRORS_RESET_EVENT="SyntaxChecker.errorsReset";ORYX.Plugins.PetrinetSyntaxChecker=ORYX.Plugins.SyntaxChecker.extend({getRDFFromDOM:function(){return this.facade.getERDF();}});ORYX.Editor.SyntaxErrorGridPanel=Ext.extend(Ext.grid.ShapeDetailsGridPanel,{columns:Ext.grid.ShapeDetailsGridPanel.prototype.columns.concat([{id:"simulatable",dataIndex:"simulatable",header:ORYX.I18N.SyntaxChecker.SyntaxErrorTool.simulatableHeader,width:110,sortable:true,align:"middle",renderer:function(value){var imgName="silk/cross.png";if(value)
imgName="can_simulate.png";var content="<img style='display:block;margin-left:auto;margin-right:auto;' src='images/"+imgName+"' />";return content;}},{id:"errorMessage",dataIndex:"errorMessage",header:ORYX.I18N.SyntaxChecker.SyntaxErrorTool.errorHeader,renderer:"htmlEncode"}]),autoExpandColumn:"errorMessage",storeFields:Ext.grid.ShapeDetailsGridPanel.prototype.storeFields.concat(['simulatable','errorMessage']),title:ORYX.I18N.SyntaxChecker.SyntaxErrorTool.title,flowSwitchDialogMsg:ORYX.I18N.SyntaxChecker.SyntaxErrorTool.FlowSwitchDialog.message});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.SSExtensionLoader={construct:function(facade){this.facade=facade;},addSSExtension:function(facade){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.SSExtensionLoader.loading});var url=ORYX.CONFIG.SS_EXTENSIONS_CONFIG;new Ajax.Request(url,{method:'GET',asynchronous:false,onSuccess:(function(transport){try{eval("var jsonObject = "+transport.responseText);var stencilsets=this.facade.getStencilSets();var validExtensions=jsonObject.extensions.findAll(function(extension){var stencilset=stencilsets[extension["extends"]];if(stencilset)return true;else return false;});var loadedExtensions=validExtensions.findAll(function(extension){return stencilsets.values().any(function(ss){if(ss.extensions()[extension.namespace])return true;else return false;})});if(validExtensions.size()==0)
Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.SSExtensionLoader.noExt);else
this._showPanel(validExtensions,loadedExtensions,this._loadExtensions.bind(this));}
catch(e){console.log(e);Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.SSExtensionLoader.failed1);}
this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});}).bind(this),onFailure:(function(transport){Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.SSExtensionLoader.failed2);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});}).bind(this)});},_loadExtensions:function(extensions){var stencilsets=this.facade.getStencilSets();var atLeastOne=false;stencilsets.values().each(function(stencilset){var unselected=stencilset.extensions().values().select(function(ext){return extensions[ext.namespace]==undefined});unselected.each(function(ext){stencilset.removeExtension(ext.namespace);atLeastOne=true;});});extensions.each(function(extension){var stencilset=stencilsets[extension["extends"]];if(stencilset){stencilset.addExtension(ORYX.CONFIG.SS_EXTENSIONS_FOLDER+extension.definition);atLeastOne=true;}}.bind(this));if(atLeastOne){stencilsets.values().each(function(stencilset){this.facade.getRules().initializeRules(stencilset);}.bind(this));this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,lazyLoaded:true});var selection=this.facade.getSelection();this.facade.setSelection();this.facade.setSelection(selection);}},_showPanel:function(validExtensions,loadedExtensions,successCallback){var data=[];validExtensions.each(function(value){data.push([value.title,value.definition,value["extends"]])});var sm=new Ext.grid.CheckboxSelectionModel();var grid=new Ext.grid.GridPanel({deferRowRender:false,id:'oryx_new_stencilset_extention_grid',store:new Ext.data.SimpleStore({fields:['title','definition','extends']}),cm:new Ext.grid.ColumnModel([sm,{header:ORYX.I18N.SSExtensionLoader.panelTitle,width:200,sortable:true,dataIndex:'title'}]),sm:sm,frame:true,width:200,height:200,iconCls:'icon-grid',listeners:{"render":function(){this.getStore().loadData(data);selectItems.defer(1);}}});function selectItems(){var selectedRecords=new Array();grid.store.each(function(rec){if(loadedExtensions.any(function(ext){return ext.definition==rec.get('definition')}))
selectedRecords.push(rec);});sm.selectRecords(selectedRecords);}
var panel=new Ext.Panel({items:[{xtype:'label',text:ORYX.I18N.SSExtensionLoader.panelText,style:'margin:10px;display:block'},grid],frame:true,buttons:[{text:ORYX.I18N.SSExtensionLoader.labelImport,handler:function(){var selectionModel=Ext.getCmp('oryx_new_stencilset_extention_grid').getSelectionModel();var result=selectionModel.selections.items.collect(function(item){return item.data;})
Ext.getCmp('oryx_new_stencilset_extention_window').close();successCallback(result);}.bind(this)},{text:ORYX.I18N.SSExtensionLoader.labelCancel,handler:function(){Ext.getCmp('oryx_new_stencilset_extention_window').close();}.bind(this)}]})
var window=new Ext.Window({id:'oryx_new_stencilset_extention_window',width:227,title:ORYX.I18N.Oryx.title,floating:true,shim:true,modal:true,resizable:false,autoHeight:true,items:[panel]})
window.show();}};ORYX.Plugins.SSExtensionLoader=Clazz.extend(ORYX.Plugins.SSExtensionLoader);Ext.form.SpecialtyEditor=function(config){this.isLegacy=true;this.complexPropertyKey=config.complexPropertyKey;this.type=config.propertyType;this.propertyObj=config.propertyObject;this.events=config.events;this.facade=config.facade;this.saveFn=config.saveFn;this.commonColWidth=200;this.fieldTypes=["text","choice","int","expression","list","map"];this.legacyPropertyItemKeys={input:["_list_value","_map_value","_name","_script_body","_script_format","_script_resource","_script_type","_text_value","_type"],output:["_list_value","_map_value","_name","_script_body","_script_format","_script_resource","_script_type","_text_value","_type"],execution_listener:["_class","_delegate_expression","_event_type","_expression","_script_body","_script_format","_script_resource","_script_type","_type"],task_listener:["_class","_delegate_expression","_event_type","_expression","_script_body","_script_format","_script_resource","_script_type","_type"]};this.getNewRow=function(index){var row={};this.fields.each(function(field){row[field.id]=(field.id==="id")?index:"";});return row;};this.setDataObject=function(arr){if(!this.propertyObj){this.propertyObj={};}
if(!this.propertyObj.hasOwnProperty(this.type)){this.propertyObj[this.type]=null;}
if(!arr&&this.propertyObj[this.type]){this.propertyObj[this.type]=JSON.parse(this.propertyObj[this.type]);}
if(arr!==undefined){this.propertyObj[this.type]=arr;}};this.setDataObjectFromLegacyData=function(){if($j.isEmptyObject(this.propertyObj)){this.propertyObj[this.type]=null;}else{tmpPropertyObj={};this.propertyObj.items.each(function(item){var realObj={};var type=item[this.propRoot+"_type"];if(type==="script"){switch(item[this.propRoot+"_script_type"]){case"externalresource":type="script-resource";break;case"inlinescript":type="script-inline-"+item[this.propRoot+"_script_format"];break;}}else if(type==="delegateExpression"){type="delegate_expression";}
if(!tmpPropertyObj.hasOwnProperty(type)){tmpPropertyObj[type]=[];}
for(var key in item){if(item.hasOwnProperty(key)){var val=item[key];if(val!==""){var trueKey=key.replace(this.propRoot+"_",'');switch(trueKey){case"class":trueKey="value";break;case"delegate_expression":trueKey="value";break;case"expression":trueKey="value";break;case"list_value":trueKey="value";break;case"map_value":trueKey="value";break;case"script_body":trueKey="body";break;case"script_format":trueKey="format";break;case"script_resource":trueKey="resource";break;case"text_value":trueKey="value";break;}
realObj[trueKey]=val;}}}
tmpPropertyObj[type].push(realObj);}.bind(this));this.propertyObj=tmpPropertyObj;}};this.setLegacyDataObjects=function(arr){this.ldos=[];for(var key in this.propertyObj){if(this.propertyObj.hasOwnProperty(key)&&this.propertyObj[key]){var arr=this.propertyObj[key];arr.each(function(item){var tmpObj=this.getLegacyPropertyItem();switch(key){case'delegate_expression':tmpObj[this.propRoot+"_type"]="delegateExpression";tmpObj[this.propRoot+"_event_type"]=item.event_type;tmpObj[this.propRoot+"_delegate_expression"]=item.value;break;case'expression':tmpObj[this.propRoot+"_type"]="expression";tmpObj[this.propRoot+"_event_type"]=item.event_type;tmpObj[this.propRoot+"_expression"]=item.value;break;case'java':tmpObj[this.propRoot+"_type"]="java";tmpObj[this.propRoot+"_event_type"]=item.event_type;tmpObj[this.propRoot+"_class"]=item.value;break;case'list':tmpObj[this.propRoot+"_type"]="list";tmpObj[this.propRoot+"_name"]=item.name;tmpObj[this.propRoot+"_list_value"]=item.value;break;case'map':tmpObj[this.propRoot+"_type"]="map";tmpObj[this.propRoot+"_name"]=item.name;tmpObj[this.propRoot+"_map_value"]=item.value;break;case'script-inline-javascript':tmpObj[this.propRoot+"_type"]="script";if(this.propRoot==="execution_listener"||this.propRoot==="task_listener"){tmpObj[this.propRoot+"_event_type"]=item.event_type;}else{tmpObj[this.propRoot+"_name"]=item.name;}
tmpObj[this.propRoot+"_script_type"]="inlinescript";tmpObj[this.propRoot+"_script_format"]="javascript";tmpObj[this.propRoot+"_script_body"]=item.body;break;case'script-inline-juel':tmpObj[this.propRoot+"_type"]="script";if(this.propRoot==="execution_listener"||this.propRoot==="task_listener"){tmpObj[this.propRoot+"_event_type"]=item.event_type;}else{tmpObj[this.propRoot+"_name"]=item.name;}
tmpObj[this.propRoot+"_script_type"]="inlinescript";tmpObj[this.propRoot+"_script_format"]="juel";tmpObj[this.propRoot+"_script_body"]=item.body;break;case'script-resource':tmpObj[this.propRoot+"_type"]="script";if(this.propRoot==="execution_listener"||this.propRoot==="task_listener"){tmpObj[this.propRoot+"_event_type"]=item.event_type;}else{tmpObj[this.propRoot+"_name"]=item.name;}
tmpObj[this.propRoot+"_script_type"]="externalresource";tmpObj[this.propRoot+"_script_format"]=item.format;tmpObj[this.propRoot+"_script_resource"]=item.resource;break;case'text':tmpObj[this.propRoot+"_type"]="text";tmpObj[this.propRoot+"_name"]=item.name;tmpObj[this.propRoot+"_text_value"]=item.value;break;}
this.ldos.push(tmpObj);}.bind(this));}}};this.setLegacyProperty=function(){this.legacyProperty={"totalCount":this.ldos.length,"items":this.ldos}};this.setTitle=function(){switch(this.complexPropertyKey){case"oryx-inputparameters":this.title="Input Parameters: ";break;case"oryx-outputparameters":this.title="Output Parameters: ";break;case"oryx-executionlisteners":this.title="Execution Listeners: ";break;case"oryx-tasklisteners":this.title="Task Listeners: ";break;}
switch(this.type){case'delegate_expression':this.title+="Delegate Expression";break;case'expression':this.title+="Expression";break;case'java':this.title+="Java Class";break;case'list':this.title+="List";break;case'map':this.title+="Map";break;case'text':this.title+="Text";break;case'script-inline-javascript':this.title+="Inline JavaScript";break;case'script-inline-juel':this.title+="Inline Juel Script";break;case'script-resource':this.title+="External Resource Script";break;}};this.setPropertyRoot=function(){switch(this.complexPropertyKey){case"oryx-inputparameters":this.propRoot="input";break;case"oryx-outputparameters":this.propRoot="output";break;case"oryx-executionlisteners":this.propRoot="execution_listener";break;case"oryx-tasklisteners":this.propRoot="task_listener";break;}};this.setEventItems=function(){if(!this.events||!this.events.length){return;}
this.eventItems=[];this.events.each(function(event){this.eventItems.push({id:event._jsonItem.id,title:event._jsonItem.title,value:event._jsonItem.value});}.bind(this));},this.setFields=function(){switch(this.type){case'delegate_expression':this.fields=[{id:'id',title:'Id',type:"int"},{id:'event_type',title:"Event",type:"choice",items:this.eventItems},{id:'value',title:ORYX.I18N.PropertyWindow.value,type:"text"}];break;case'expression':this.fields=[{id:'id',title:'Id',type:"int"},{id:'event_type',title:"Event",type:"choice",items:this.eventItems},{id:'value',title:ORYX.I18N.PropertyWindow.value,type:"text"}];break;case'java':this.fields=[{id:'id',title:'Id',type:"int"},{id:'event_type',title:"Event",type:"choice",items:this.eventItems},{id:'value',title:ORYX.I18N.PropertyWindow.value,type:"text"}];break;case'list':this.fields=[{id:'id',title:'Id',type:"int"},{id:'name',title:ORYX.I18N.PropertyWindow.name,type:"text"},{id:'value',title:ORYX.I18N.PropertyWindow.value,type:"list"}];break;case'map':this.fields=[{id:'id',title:'Id',type:"int"},{id:'name',title:ORYX.I18N.PropertyWindow.name,type:"text"},{id:'value',title:ORYX.I18N.PropertyWindow.value,type:"map"}];break;case'text':this.fields=[{id:'id',title:'Id',type:"int"},{id:'name',title:ORYX.I18N.PropertyWindow.name,type:"text"},{id:'value',title:ORYX.I18N.PropertyWindow.value,type:"text"}];break;case'script-inline-javascript':this.fields=[];this.fields.push({id:'id',title:'Id',type:"int"});if(this.propRoot==="execution_listener"||this.propRoot==="task_listener"){this.fields.push({id:'event_type',title:"Event",type:"choice",items:this.eventItems});}else{this.fields.push({id:'name',title:ORYX.I18N.PropertyWindow.name,type:"text"});}
this.fields.push({id:'body',title:'Body',type:"expression",language:"Javascript"});break;case'script-inline-juel':this.fields=[];this.fields.push({id:'id',title:'Id',type:"int"});if(this.propRoot==="execution_listener"||this.propRoot==="task_listener"){this.fields.push({id:'event_type',title:"Event",type:"choice",items:this.eventItems});}else{this.fields.push({id:'name',title:ORYX.I18N.PropertyWindow.name,type:"text"});}
this.fields.push({id:'body',title:'Body',type:"expression",language:"Juel"});break;case'script-resource':this.fields=[];this.fields.push({id:'id',title:'Id',type:"int"});if(this.propRoot==="execution_listener"||this.propRoot==="task_listener"){this.fields.push({id:'event_type',title:"Event",type:"choice",items:this.eventItems});}else{this.fields.push({id:'name',title:ORYX.I18N.PropertyWindow.name,type:"text"});}
this.fields.push({id:'format',title:'Format',type:"choice",items:[{title:'JavaScript',value:'javascript'},{title:'Juel',value:'juel'}]});this.fields.push({id:'resource',title:'Resource',type:"text"});break;}};this.setFieldsByType=function(){this.fieldsByType=new Hash();this.fieldTypes.each(function(fieldType){this.fieldsByType[fieldType]=this.fields.filter(function(field){return field.type===fieldType;});}.bind(this));};this.setFieldObjectArray=function(){this.fieldObjectArray=[];this.fields.each(function(field){this.fieldObjectArray.push({name:field.id,mapping:field.id});}.bind(this));};this.setChoiceOptionTitles=function(){this.choiceOptionTitles=new Hash();this.fieldsByType["choice"].each(function(field){this.choiceOptionTitles[field.id]=new Hash();field.items.each(function(item){this.choiceOptionTitles[field.id][item.value]=item.title;}.bind(this));}.bind(this));};this.setEditors=function(){this.editors=new Hash();this.setChoiceEditors();this.setTextEditors();this.setExpressionEditors();this.setListEditors();this.setMapEditors();};this.setChoiceEditors=function(){this.fieldsByType["choice"].each(function(field){var store=new Ext.data.Store({data:field,autoLoad:true,reader:new Ext.data.JsonReader({root:"items",idProperty:'value'},[{name:'title',mapping:'title'},{name:'value',mapping:'value'}]),sortInfo:{field:'title',direction:'ASC'}});this.editors[field.id]=new Ext.form.ComboBox({id:field.id,store:store,displayField:'title',valueField:'value',editable:true,mode:'local',triggerAction:'all',selectOnFocus:true,forceSelection:true,lazyRender:true,autoSelect:false,height:300,minHeight:100,maxHeight:300,listeners:{scope:this,select:function(box){this.isGridValid(box.id).done(function(){this.okButton.enable();}.bind(this)).fail(function(){this.okButton.disable();}.bind(this));}}});}.bind(this));};this.setExpressionEditors=function(){this.fieldsByType["expression"].each(function(field){this.editors[field.id]=new Ext.form.ExpressionField({id:field.id,allowBlank:false,scriptLanguage:true,language:field.language,width:100,validateFn:function(){this.editors[field.id].validate();}.bind(this)});this.editors[field.id].addListener('valid',function(box){if(box.hasFocus){this.isGridValid(box.id).done(function(){this.okButton.enable();}.bind(this)).fail(function(){this.okButton.disable();}.bind(this));}}.bind(this));}.bind(this));};this.setTextEditors=function(){this.fieldsByType["text"].each(function(field){this.editors[field.id]=new Ext.form.TextField({id:field.id,allowBlank:false,enableKeyEvents:true,listeners:{scope:this,invalid:function(field){this.okButton.disable();},valid:function(box){if(box.hasFocus){this.isGridValid(box.id).done(function(){this.okButton.enable();}.bind(this)).fail(function(){this.okButton.disable();}.bind(this));}}}});}.bind(this));};this.validateListRow=function(boxId,hasList){if(hasList){this.isGridValid(boxId).done(function(){this.okButton.enable();}.bind(this)).fail(function(){this.okButton.disable();}.bind(this));}};this.setListEditors=function(){this.fieldsByType["list"].each(function(field){var config={propertyType:"list",allowBlank:false,parent:this,id:field.id,key:this.complexPropertyKey,facade:this.facade};this.editors[field.id]=new Ext.form.EmbeddedListMapField(config);}.bind(this));};this.setMapEditors=function(){this.fieldsByType["map"].each(function(field){var config={propertyType:"map",allowBlank:false,parent:this,id:field.id,key:this.complexPropertyKey,facade:this.facade};this.editors[field.id]=new Ext.form.EmbeddedListMapField(config);}.bind(this));};this.setRenderers=function(){this.renderers=new Hash();this.setChoiceRenderers();};this.setChoiceRenderers=function(){this.fieldsByType["choice"].each(function(field){this.renderers[field.id]=function(value,metaData,record,rowIndex,colIndex,store){this.validateGrid();if(value.length&&this.choiceOptionTitles[field.id][value]!==undefined){return this.choiceOptionTitles[field.id][value];}
return value;}}.bind(this));};this.setRowDeleter=function(){this.rowDeleter=new Ext.form.SpecialtyEditorRowDeleter();this.rowDeleter.setPlugin(this);};this.setColumnModel=function(){var columnArray=[this.rowDeleter];this.fields.each(function(field){var config={id:field.id,header:field.title,dataIndex:field.id,width:200,hidden:(field.id==="id"),editor:this.editors[field.id]};if(this.renderers[field.id]!==undefined){config["renderer"]=this.renderers[field.id].bind(this);}
columnArray.push(config);}.bind(this));this.columnModel=new Ext.grid.ColumnModel({columns:columnArray,defaults:{sortable:true,menuDisabled:true}});};this.validateGrid=function(){this.isGridValid().done(function(){this.okButton.enable();}.bind(this)).fail(function(){this.okButton.disable();}.bind(this));};this.isGridValid=function(ignoreId){var deferred=$j.Deferred();var valid=true;for(var i=0;i<this.grid.store.data.items.length;i++){var item=this.grid.store.data.items[i];for(var key in item.data){if(valid&&item.data.hasOwnProperty(key)&&key!=="id"){if(ignoreId===undefined||(key!==ignoreId||this.grid.selModel.last!=i)){valid=item.data[key].length>0;}}}}
if(valid){deferred.resolve();}else{deferred.reject();}
return deferred.promise();};this.getTopBar=function(){var tbar=new Ext.Toolbar({id:'tbar_'+this.type,items:[{text:'Add',cls:'x-btn-text-icon',icon:'images/silk/add.png',handler:function(){this.okButton.disable();var ds=this.grid.getStore();var index=ds.getCount();this.grid.stopEditing();var gridRow=ds.recordType;var newRow=new gridRow(this.getNewRow(index));ds.insert(index,newRow);ds.commitChanges();this.grid.getView().refresh();this.grid.getSelectionModel().selectRow(index);this.grid.startEditing(index,0);}.bind(this)},'->']});return tbar;};this.saveCurrentData=function(){var oldData=$j.extend(true,{},this.propertyObj);var that=this;var commandClass=ORYX.Core.Command.extend({construct:function(){this.plugin=that;this.oldData=oldData;},doCore:function(){if(this.plugin.isLegacy){this.plugin.setLegacyDataObjects();this.plugin.setLegacyProperty();this.plugin.saveFn(this.plugin.complexPropertyKey,this.plugin.legacyProperty);}else{this.plugin.saveFn(this.plugin.complexPropertyKey,this.plugin.type,this.plugin.propertyObj);}},execute:function(){var tmpArr=[];this.plugin.grid.store.data.items.each(function(item){tmpArr.push(item.data);});this.plugin.setDataObject(tmpArr,true);this.doCore();},rollback:function(){this.plugin.propertyObj=this.oldData;this.doCore();}});var command=new commandClass();this.facade.executeCommands([command]);this.facade.updateSelection();};this.getLegacyPropertyItem=function(){var tmpPropItem={};this.legacyPropertyItemKeys[this.propRoot].each(function(key){tmpPropItem[this.propRoot+key]="";}.bind(this));return tmpPropItem;},this.setDataStore=function(){this.dataStore=new Ext.data.Store({reader:new Ext.data.JsonReader({root:this.type},this.fieldObjectArray)});if(!$j.isEmptyObject(this.propertyObj)&&this.propertyObj.hasOwnProperty(this.type)&&!$j.isEmptyObject(this.propertyObj[this.type])){this.dataStore.loadData(this.propertyObj);}};this.alignWindow=function(){var canvas=Ext.getCmp('x-panel-editor-center-cmp-id').getEl();var propertyBody=Ext.getCmp('x-panel-editor-right-cmp-id').getEl();var offsetX=0;var offsetY=100;this.dialog.alignTo(propertyBody,'tr-tr',[offsetX,offsetY]);};this.setPropertyRoot();this.setTitle();this.setEventItems();this.setFields();this.setFieldsByType();this.setFieldObjectArray();this.setChoiceOptionTitles();this.setEditors();this.setRenderers();this.setRowDeleter();this.setColumnModel();if(this.isLegacy){this.setDataObjectFromLegacyData();}else{this.setDataObject();}
this.setDataStore();this.grid=new Ext.grid.EditorGridPanel({clicksToEdit:1,store:this.dataStore,stripeRows:true,colModel:this.columnModel,selModel:this.rowDeleter,width:'auto',tbar:this.getTopBar(),viewConfig:{forceFit:true,getRowClass:function(record,rowIndex,rowParams,store){return this.type+rowIndex;}.bind(this)}});this.okButton=new Ext.Button({text:ORYX.I18N.PropertyWindow.ok,disabled:true,iconCls:"icon-ok",minWidth:70,handler:function(){this.saveCurrentData();this.dialog.close();}.bind(this)});this.dialog=new Ext.Window({autoScroll:true,autoCreate:true,title:this.title,width:this.columnModel.getTotalWidth()+20,constrain:true,height:350,layout:'fit',maximizable:true,modal:true,collapsible:false,shadow:true,keys:[{key:27,fn:function(){this.dialog.hide}.bind(this)}],items:[this.grid],bodyStyle:"background-color:#FFFFFF",buttons:[this.okButton,{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.dialog.close();}.bind(this)}],listeners:{scope:this,maximize:function(window){ORYX.Plugins.PropertyWindow.maximizeEditor(window);},show:function(){this.alignWindow();},close:function(){ORYX.Plugins.PropertyWindow.scrollGridBottom();}}});this.dialog.show();};Ext.form.SpecialtyEditorRowDeleter=Ext.extend(Ext.grid.RowSelectionModel,{width:22,sortable:false,dataIndex:0,menuDisabled:true,fixed:true,id:'deleter',initEvents:function(){Ext.form.SpecialtyEditorRowDeleter.superclass.initEvents.call(this);this.grid.on('cellclick',function(grid,rowIndex,columnIndex,e){var record=grid.getStore().getAt(rowIndex);var target=$j(e.target);var mbContent="";if(columnIndex==grid.getColumnModel().getIndexById('deleter')){mbContent+='Are you sure you want to delete '+record.data.name+'?'
Ext.Msg.show({title:'Confirm',msg:mbContent,buttons:Ext.Msg.YESNO,fn:function(btn){if(btn=='yes'){grid.getStore().remove(record);grid.getView().refresh();this.plugin.validateGrid();}}.bind(this),animEl:'elId',icon:Ext.MessageBox.QUESTION});$j('.ext-mb-content').css({float:'left'});}}.bind(this));},renderer:function(v,p,record,rowIndex){return'<img class="extensive-remove" src="images/trash-o.png" title="Delete"/>';},setPlugin:function(plugin){this.plugin=plugin;}});var $j=jQuery.noConflict();if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.View={facade:undefined,construct:function(facade,ownPluginData){this.facade=facade;this.zoomLevel=1.0;this.maxFitToScreenLevel=1.5;this.minZoomLevel=0.1;this.maxZoomLevel=2.5;this.diff=5;ownPluginData.properties.each(function(property){if(property.zoomLevel){this.zoomLevel=Number(1.0);}
if(property.maxFitToScreenLevel){this.maxFitToScreenLevel=Number(property.maxFitToScreenLevel);}
if(property.minZoomLevel){this.minZoomLevel=Number(property.minZoomLevel);}
if(property.maxZoomLevel){this.maxZoomLevel=Number(property.maxZoomLevel);}}.bind(this));this.facade.offer({'name':ORYX.I18N.View.zoomIn,'functionality':this.zoom.bind(this,[1.0+ORYX.CONFIG.ZOOM_OFFSET]),'group':ORYX.I18N.View.group,'icon':ORYX.PATH+"images/magnifier_zoom_in.png",'description':ORYX.I18N.View.zoomInDesc,'index':1,'minShape':0,'maxShape':0,'isEnabled':function(){return this.zoomLevel<this.maxZoomLevel}.bind(this)});this.facade.offer({'name':ORYX.I18N.View.zoomOut,'functionality':this.zoom.bind(this,[1.0-ORYX.CONFIG.ZOOM_OFFSET]),'group':ORYX.I18N.View.group,'icon':ORYX.PATH+"images/magnifier_zoom_out.png",'description':ORYX.I18N.View.zoomOutDesc,'index':2,'minShape':0,'maxShape':0,'isEnabled':function(){return this._checkSize()}.bind(this)});this.facade.offer({'name':ORYX.I18N.View.zoomStandard,'functionality':this.setAFixZoomLevel.bind(this,1),'group':ORYX.I18N.View.group,'icon':ORYX.PATH+"images/zoom_standard.png",'cls':'icon-large','description':ORYX.I18N.View.zoomStandardDesc,'index':3,'minShape':0,'maxShape':0,'isEnabled':function(){return this.zoomLevel!=1}.bind(this)});this.facade.offer({'name':ORYX.I18N.View.zoomFitToModel,'functionality':this.zoomFitToModel.bind(this),'group':ORYX.I18N.View.group,'icon':ORYX.PATH+"images/image.png",'description':ORYX.I18N.View.zoomFitToModelDesc,'index':4,'minShape':0,'maxShape':0});},setAFixZoomLevel:function(zoomLevel){this.zoomLevel=zoomLevel;this._checkZoomLevelRange();this.zoom(1);},zoom:function(factor){this.zoomLevel*=factor;var canvas=this.facade.getCanvas();var container=canvas.getHTMLContainer();var scrollNode=container.parentNode.parentNode;var newWidth=canvas.bounds.width()*this.zoomLevel;var newHeight=canvas.bounds.height()*this.zoomLevel;var newScrollTop=scrollNode.scrollTop-Math.round((scrollNode.getHeight()-newHeight)/2)+this.diff;var newScrollLeft=scrollNode.scrollLeft-Math.round((scrollNode.getWidth()-newWidth)/2)+this.diff;canvas.setSize({width:newWidth,height:newHeight},true);canvas.node.setAttributeNS(null,"transform","scale("+this.zoomLevel+")");this.facade.updateSelection();scrollNode.scrollTop=newScrollTop;scrollNode.scrollLeft=newScrollLeft;canvas.zoomLevel=this.zoomLevel;},zoomFitToModel:function(){var scrollNode=this.facade.getCanvas().getHTMLContainer().parentNode.parentNode.parentNode;var visibleHeight=scrollNode.getHeight()-8;var visibleWidth=scrollNode.getWidth()-8;var zoomOption=1;var fullHeight=0;var fullWidth=0;switch(zoomOption){case 1:var nodes=this.facade.getCanvas().getChildShapes();if(!nodes||nodes.length<1){return false;}
var bounds=nodes[0].absoluteBounds().clone();nodes.each(function(node){bounds.include(node.absoluteBounds().clone());});fullWidth=bounds.width()*1.05;fullHeight=bounds.height()*1.05;break;default:var el=Ext.get(Ext.query("*[class=ORYX_Editor]")[0]);fullHeight=el.getHeight();fullWidth=el.getWidth();}
var scaleFactorWidth=visibleWidth/fullWidth;var scaleFactorHeight=visibleHeight/fullHeight;var zoomFactor=scaleFactorHeight<scaleFactorWidth?scaleFactorHeight:scaleFactorWidth;if(zoomFactor>this.maxFitToScreenLevel){zoomFactor=this.maxFitToScreenLevel}
this.setAFixZoomLevel(zoomFactor);scrollNode.scrollTop=Math.round(bounds.upperLeft().y*this.zoomLevel)-5;scrollNode.scrollLeft=Math.round(bounds.upperLeft().x*this.zoomLevel)-5;},_checkSize:function(){var canvasParent=this.facade.getCanvas().getHTMLContainer().parentNode;var minForCanvas=Math.min((canvasParent.parentNode.getWidth()/canvasParent.getWidth()),(canvasParent.parentNode.getHeight()/canvasParent.getHeight()));return 1.05>minForCanvas;},_checkZoomLevelRange:function(){if(this.zoomLevel<this.minZoomLevel){this.zoomLevel=this.minZoomLevel;}
if(this.zoomLevel>this.maxZoomLevel){this.zoomLevel=this.maxZoomLevel;}}};ORYX.Plugins.View=Clazz.extend(ORYX.Plugins.View);Ext.namespace("ORYX.Plugins");ORYX.Plugins.WorkflowTestPanelPlugin=ORYX.Plugins.AbstractPlugin.extend({setup:function(){try{this.modelId=(location.hash.slice(1).replace(/^\/?/,"").replace(/\/?$/,"")).replace(/model\//,"");this.handlerURL=ORYX.PATH+"poem/model/"+this.modelId+"/publishTestWorkflow";}catch(e){}},construct:function(facade){ORYX.Log.debug("WorkflowTestPanelPlugin.construct");this.dialog=null;this.modelId=null;this.handlerURL=null;this.facade=facade;this.testButton={'id':'workflowTestButton','name':'Test Workflow','functionality':this.initializeTestPanel.bind(this),'group':'Workflow Test','icon':ORYX.PATH+"images/silk/control_play_blue.png",'description':'Opens a panel to test workflows with sample inputs.','index':2,'minShape':0,'maxShape':0,'isEnabled':function(){var enabled=false;if(location.hash.slice(1)&&ORYX.Editor.Cookie.getParams().publisher==="true"){enabled=true;}
return enabled;}};this.facade.offer(this.testButton);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_STATUS,function(options){this.setup();if(this.testButton.isEnabled()){this.testButton["buttonInstance"].enable();}else{this.testButton["buttonInstance"].disable();}}.bind(this));this.setup();this.init();},init:function(){ORYX.Log.debug("WorkflowTestPanelPlugin.init");},initializeTestPanel:function(){this.facade.setSavingPromise();ORYX.Plugins.AutoSave.autoSave();$j.when(this.facade.getSavingPromise()).done(function(){this.showTestPanel();}.bind(this));},showTestPanel:function(){ORYX.Log.debug("WorkflowTestPanelPlugin.showTestPanel");var self=this;var testName=String.format(ORYX.CONFIG.TEST_PANEL_WF_PREFIX,this.modelId,new Date().getTime());var testURL=String.format(ORYX.CONFIG.TEST_PANEL_URL,testName,"true");var center,south,dialog;center=new Ext.Panel({region:'center',html:'<iframe name="workflowTestPanel" id="workflowTestPanel" frameborder="0" height="100" width="100" scrolling="auto" src="about:blank"></iframe>',cls:'wf-test-body-panel'});south=new Ext.Panel({region:'south',height:28,html:'<div class="wf-wait"><span class="wait-message">'+MOTV.I18N.WorkflowTestPanel.waitMsg+'</span></div>',cls:'wf-test-status-panel'});var _setupIframe=function(){var h=(south.isVisible())?dialog.getInnerHeight()-28:dialog.getInnerHeight()-4;var w=dialog.getInnerWidth()-4;Ext.get('workflowTestPanel').setSize(w,h,false);};var dw=ORYX.CONFIG.TEST_PANEL_WIDTH||800;if(dw>window.innerWidth){dw=window.innerWidth-32;}
var dh=ORYX.CONFIG.TEST_PANEL_HEIGHT||600;if(dh>window.innerHeight){dh=window.innerHeight-32;}
dialog=new Ext.Window({layout:'border',autoCreate:true,title:MOTV.I18N.WorkflowTestPanel.pluginName,height:dh,width:dw,modal:true,collapsible:false,maximizable:true,fixedcenter:true,shadow:true,proxyDrag:true,plain:true,items:[center,south],keys:[{key:27,fn:function(){dialog.close()}.bind(this)}],listeners:{hide:function(){dialog.close();}.bind(this),show:function(){_setupIframe();}},buttons:[{text:'Close',handler:function(){dialog.close();}.bind(this)}]});dialog.show();dialog.on('bodyresize',function(){_setupIframe();});dialog.on('afterlayout',function(){_setupIframe();});var facadeJSON=this.facade.getJSON();function onShowError(response){south.hide();dialog.doLayout();ORYX.Log.error("WorkflowTestPanelPlugin.showTestPanel()::ajax request for publish failed, status was "+response.status);var responseJSON=Ext.util.JSON.decode(response.responseText);var errMsg=String.format(MOTV.I18N.WorkflowTestPanel.errorMsg,Ext.util.Format.htmlEncode(responseJSON.errorMessage));if(responseJSON.extendedError)
errMsg+=" <a href='#' onclick='Ext.get(this).parent().child(\"#extended-error-info\").setVisibilityMode(Ext.Element.DISPLAY).toggle(); return false;'>More</a><pre id='extended-error-info' style='display:none;overflow:auto;width:100%;height:200px;margin-top:5px'>"+Ext.util.Format.htmlEncode(responseJSON.extendedError)+"</pre>";Ext.Msg.show({title:MOTV.I18N.WorkflowTestPanel.error,msg:errMsg,minWidth:500,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR,fn:function(btn,text){if(btn=='ok'){dialog.close();}}});}
new Ajax.Request(this.handlerURL,{method:'post',parameters:{name:testName,version:ORYX.contentVersion,json:Ext.encode(facadeJSON)},onSuccess:function(response){Ext.get('workflowTestPanel').addListener('load',function(){south.hide();dialog.doLayout();},self,{single:true});var responseJSON=Ext.util.JSON.decode(response.responseText);var launchUrl=testURL;if(responseJSON.wfName){launchUrl=String.format(ORYX.CONFIG.TEST_PANEL_URL,responseJSON.wfName,"true");}
if(responseJSON.bpf)
launchUrl=launchUrl+"&bpf="+responseJSON.bpf;if(responseJSON.pof)
launchUrl=launchUrl+"&pof="+responseJSON.pof+"&pofName="+responseJSON.pofName+"&pofVersion="+responseJSON.pofVersion;Ext.get('workflowTestPanel').dom.src=launchUrl;},onFailure:onShowError,onException:onShowError});}});var $j=jQuery.noConflict();if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.SelectionFrame=Clazz.extend({construct:function(facade){this.facade=facade;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.handleMouseUp.bind(this),true);this.position={x:0,y:0};this.size={width:0,height:0};this.offsetPosition={x:0,y:0}
this.moveCallback=undefined;this.offsetScroll={x:0,y:0}
this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.facade.getCanvas().getHTMLContainer(),['div',{'class':'Oryx_SelectionFrame'}]);this.hide();},handleMouseDown:function(event,uiObj){if(uiObj instanceof ORYX.Core.Canvas){var scrollNode=uiObj.rootNode.parentNode.parentNode.parentNode;var a=this.facade.getCanvas().node.getScreenCTM();this.offsetPosition={x:a.e,y:a.f}
this.setPos({x:Event.pointerX(event)-this.offsetPosition.x,y:Event.pointerY(event)-this.offsetPosition.y});this.resize({width:0,height:0});this.moveCallback=this.handleMouseMove.bind(this);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.moveCallback,false);this.offsetScroll={x:scrollNode.scrollLeft,y:scrollNode.scrollTop};this.show();}
Event.stop(event);},handleMouseUp:function(event){if(this.moveCallback){this.hide();document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.moveCallback,false);this.moveCallback=undefined;var corrSVG=this.facade.getCanvas().node.getScreenCTM();var a={x:this.size.width>0?this.position.x:this.position.x+this.size.width,y:this.size.height>0?this.position.y:this.position.y+this.size.height}
var b={x:a.x+Math.abs(this.size.width),y:a.y+Math.abs(this.size.height)}
a.x/=corrSVG.a;a.y/=corrSVG.d;b.x/=corrSVG.a;b.y/=corrSVG.d;var elements=this.facade.getCanvas().getChildShapes(true).findAll(function(value){var absBounds=value.absoluteBounds();var bA=absBounds.upperLeft();var bB=absBounds.lowerRight();if(bA.x>a.x&&bA.y>a.y&&bB.x<b.x&&bB.y<b.y)
return true;return false});this.facade.setSelection(elements);}},handleMouseMove:function(event){var size={width:Event.pointerX(event)-this.position.x-this.offsetPosition.x,height:Event.pointerY(event)-this.position.y-this.offsetPosition.y,}
var scrollNode=this.facade.getCanvas().rootNode.parentNode.parentNode.parentNode;size.width-=this.offsetScroll.x-scrollNode.scrollLeft;size.height-=this.offsetScroll.y-scrollNode.scrollTop;this.resize(size);Event.stop(event);},hide:function(){this.node.style.display="none";},show:function(){this.node.style.display="";},setPos:function(pos){this.node.style.top=pos.y+"px";this.node.style.left=pos.x+"px";this.position=pos;},resize:function(size){this.setPos(this.position);this.size=Object.clone(size);if(size.width<0){this.node.style.left=(this.position.x+size.width)+"px";size.width=-size.width;}
if(size.height<0){this.node.style.top=(this.position.y+size.height)+"px";size.height=-size.height;}
this.node.style.width=size.width+"px";this.node.style.height=size.height+"px";}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.ContentSearch=ORYX.Plugins.AbstractPlugin.extend({setup:function(){try{this.handlerURL=ORYX.PATH+"poem/searchContent";}catch(e){}},construct:function(){arguments.callee.$.construct.apply(this,arguments);this.active=false;this.raisedEventIds=[];this.currentSearchString=null;this.currentOptions=null;this.facade.offer({'name':ORYX.I18N.ContentSearch.name,'functionality':this.perform.bind(this),'group':'Search','icon':ORYX.PATH+"images/silk/find.png",'description':ORYX.I18N.ContentSearch.desc,'index':0,'toggle':false,'minShape':0,'maxShape':0,keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:70,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}]});this.searchResultsPanel=new ORYX.Editor.SearchResultsGridPanel({facade:this.facade,layout:'fit',autoScroll:true,refreshHandler:function(){if(this.currentSearchString){this.sendRequest(this.currentSearchString,this.currentOptions);}}.bind(this)});this.facade.dockToolPanel(this.searchResultsPanel);this.searchResultStore=this.searchResultsPanel.getStore();this.searchResultStore.on("clear",function(store){this.resetResults();},this);this.facade.registerOnEvent(ORYX.Plugins.ContentSearch.CHECK_FOR_RESULTS_EVENT,this.checkForResults.bind(this));this.facade.registerOnEvent(ORYX.Plugins.ContentSearch.RESET_RESULTS_EVENT,this.resetResults.bind(this));this.facade.registerOnEvent(ORYX.Plugins.ContentSearch.SHOW_RESULTS_EVENT,this.doShowResults.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_FLOW_VIEW_CHANGE,this.updateShowResults.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_FLOWEDITOR_FLOW_CHANGE,this.updateShowResults.bind(this));this.setup();},perform:function(arg){if(arg&&arg.event){arg.event.preventDefault();}
this.checkForResults({onNoResults:function(){this.setActivated(false);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.ContentSearch.noResults,timeout:10000});}.bind(this),onResults:function(){this.enableDeactivationHandler();var currentFlowView=this.facade.getCurrentFlowView();var searchResultText=null;var flowViewsWithResults=this.getFlowViewsWithResults();var otherFlowViewsWithResults=flowViewsWithResults.without(currentFlowView);if(otherFlowViewsWithResults.length>0){var otherFlowViewResultsText=ORYX.I18N.ContentSearch.otherFlowViewResults+otherFlowViewsWithResults.join(",");if(searchResultText){searchResultText+="<p>"+otherFlowViewResultsText+"</p>";}else{searchResultText=otherFlowViewResultsText;}}
this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:searchResultText,timeout:10000});this.facade.raiseEvent({type:ORYX.Plugins.ContentSearch.SEARCH_RESULTS_SHOWN_EVENT,flowViewsWithResults:flowViewsWithResults});this.setActivated(true);}.bind(this),onFailure:function(){this.setActivated(false);Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.ContentSearch.invalid);}.bind(this)});},enableDeactivationHandler:function(button){},setActivated:function(activated){if(activated===undefined){this.active=!this.active;}else{this.active=activated;}},checkForResults:function(options){this.openSearchWin(options);},sendRequest:function(content,options){this.resetResults();Ext.applyIf(options||{},{showResults:true,onResults:Ext.emptyFn,onNoResults:Ext.emptyFn,onFailure:Ext.emptyFn});this.currentSearchString=content;this.currentOptions=options;Ext.Msg.wait(ORYX.I18N.ContentSearch.checkingMessage);var data=this.facade.getSerializedJSON();this.searchResultsPanel.onBeforeLoad();new Ajax.Request(this.handlerURL,{method:'POST',asynchronous:true,parameters:{resource:location.href,data:data,context:options.context,content:content},onSuccess:function(request){var resp=(request&&request.responseText?request.responseText:"{}").evalJSON();Ext.Msg.hide();if(resp instanceof Object){resp=$H(resp)
this._processResults(resp);if(resp.searchResults&&$H(resp.searchResults).size()>0){if(options.showResults){this.showResults();this.facade.focusToolPanel(this.searchResultsPanel);}
options.onResults();}else{options.onNoResults();}}else{options.onFailure();}}.bind(this),onException:function(){Ext.Msg.hide();options.onFailure();},onFailure:function(){Ext.Msg.hide();options.onFailure();}});},_processResults:function(results){if(!(results instanceof Hash)){results=new Hash(results);}
var datasource=[];if(results.searchResults){var resultCount=0;var resultsByFlowView=new Hash(results.searchResults);resultsByFlowView.each(function(flowView){var flowViewResults=flowView[1];if(!(flowViewResults instanceof Hash))
flowViewResults=new Hash(flowViewResults);flowViewResults.keys().each(function(resourceID){var results=flowViewResults[resourceID];if(results!=null){var numResults=results.length;for(var idx=0;idx<numResults;idx++){var resultObj=results[idx];datasource.push({flow:flowView[0],resourceID:resourceID,nodeName:resultObj.nodeName,propertyName:resultObj.property,itemID:resultCount++,stencilid:resultObj.stencilid});}}});});}
this.searchResultStore.loadData({"objects":datasource},false);},doShowResults:function(event,args){this.showResults(event.results);},updateShowResults:function(event,args){window.setTimeout(function(){if(this.active){this.showResults();}}.bind(this),100);},showResults:function(){var currentFlowView=this.facade.getCurrentFlowView();var canvas=this.facade.getCanvas();var processResult=null;var raisedResultOnShape=false;this._getUnfilteredResultRecords().each(function(resultRecord){if(resultRecord.get("flow")!=currentFlowView)
return;var sh=canvas.getChildShapeByResourceId(resultRecord.get("resourceID"));if(sh){this.raiseOverlay(sh);raisedResultOnShape=true;}else{if(resultRecord.get("resourceID")===canvas.resourceId){}}},this);var searchResultText=null;if(processResult){var processResultText=ORYX.I18N.SyntaxChecker.flowLevelErrors+processResult;if(searchResultText){searchResultText+="<p>"+processResultText+"</p>";}else{searchResultText=processResultText;}}
if(searchResultText){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:searchResultText,timeout:10000});}
return raisedResultOnShape;},getFlowViewsWithResults:function(){var flowViewsWithResults=[];if(this.searchResultStore){var flowNameHash={};this._getUnfilteredResultRecords().each(function(record){flowNameHash[record.get("flow")]=true;});for(var flowName in flowNameHash){flowViewsWithResults.push(flowName);}}
return flowViewsWithResults;},parseCodeToMsg:function(code){var msg=code.replace(/: /g,"<br />").replace(/, /g,"<br />");var codes=msg.split("<br />");for(var i=0;i<codes.length;i++){var singleCode=codes[i];var replacement=this.parseSingleCodeToMsg(singleCode);if(singleCode!=replacement){msg=msg.replace(singleCode,replacement);}}
return msg;},parseSingleCodeToMsg:function(code){return ORYX.I18N.ContentSearch[code]||code;},resetResults:function(){this.raisedEventIds.each(function(id){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:id});}.bind(this));this.raisedEventIds=[];this._clearResults();this.active=false;this.currentSearchString=null;this.currentOptions=null;this.facade.raiseEvent({type:ORYX.Plugins.ContentSearch.SEARCH_RESULTS_RESET_EVENT});},raiseOverlay:function(shape,contentMsg){var id="contentsearch."+this.raisedEventIds.length;var crossId=ORYX.Editor.provideId();var cross=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,['path',{"id":crossId,"title":"","stroke-width":5.0,"stroke":"#00A600","d":"M20,-5 L5,-20 M5,-5 L20,-20","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:id,shapes:[shape],node:cross,nodePosition:shape instanceof ORYX.Core.Edge?"START":"NW"});var crossElem=Ext.get(crossId);if(crossElem){crossElem.on("click",function(e,obj){var searchResultsPanel=this.searchResultsPanel;searchResultsPanel.filterByResourceID(shape.resourceId);this.facade.focusToolPanel(searchResultsPanel);e.stopPropagation();return false;}.bind(this));var tooltip=new Ext.ToolTip({showDelay:50,html:ORYX.I18N.ContentSearch.resultIconHover,target:crossId});}
this.raisedEventIds.push(id);return cross;},openSearchWin:function(options){var self=this;var defaultData={summary:''};var dialog=new Ext.XTemplate('<form class="oryx_repository_edit_model" action="#" id="search_existing_model" onsubmit="return false;">','<fieldset>','<p class="description">Please enter the search text</p>','<p><label for="search_model_text">'+ORYX.I18N.ContentSearch.dialogLabelDesc+'</label>','   <input type="text" class="text" name="content" value="{summary}" id="search_model_text" maxlength="256" onfocus="this.className = \'text activated\'" onblur="this.className = \'text\';"/></p>','</fieldset>','</form>');var win=null;var callback=function(form){var content=form.elements["content"].value;content=content.length==0?defaultData.summary:content;win.destroy();this.sendRequest(content,options);}.bind(this);win=new Ext.Window({id:'SearchWin',width:'auto',height:'auto',title:ORYX.I18N.ContentSearch.name,modal:true,bodyStyle:'background:#FFFFFF',html:dialog.apply(defaultData),buttons:[{text:ORYX.I18N.ContentSearch.searchBtn,handler:function(){callback($('search_existing_model'))}},{text:ORYX.I18N.ContentSearch.close,handler:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});win.destroy();this.setActivated(false);}.bind(this)}],listeners:{"show":function(){var el=this.getEl();var child=el.child("#search_model_text");child.addKeyMap({key:13,fn:function(){var defaultButton=win.buttons[0];defaultButton.getEl().dom.click();}});child.focus.defer(150,child);}}});win.show();},_getUnfilteredResultRecords:function(){return this.searchResultStore.snapshot?this.searchResultStore.snapshot:this.searchResultStore.data;},_clearResults:function(){this.searchResultStore.clearFilter(true);if(this.searchResultStore.getCount()>0)
this.searchResultStore.removeAll();}});ORYX.Editor.SearchResultsGridPanel=function(config){Ext.apply(this,config);ORYX.Editor.SearchResultsGridPanel.superclass.constructor.call(this);};ORYX.Editor.SearchResultsGridPanel=Ext.extend(Ext.grid.ShapeDetailsGridPanel,{columns:Ext.grid.ShapeDetailsGridPanel.prototype.columns.concat([{id:"propertyName",dataIndex:"propertyName",header:ORYX.I18N.ContentSearch.SearchResultsTool.propertyHeader},{id:"propertyChannel",header:ORYX.I18N.ContentSearch.SearchResultsTool.channelHeader}]),title:ORYX.I18N.ContentSearch.SearchResultsTool.title,storeFields:Ext.grid.ShapeDetailsGridPanel.prototype.storeFields.concat(['propertyName','stencilid']),flowSwitchDialogMsg:ORYX.I18N.ContentSearch.SearchResultsTool.FlowSwitchDialog.message,initComponent:function(){ORYX.Editor.SearchResultsGridPanel.superclass.initComponent.call(this);var colModel=this.getColumnModel();var colIdx=colModel.getIndexById("propertyName");colModel.setRenderer(colIdx,this._propertyNameColumnRenderer.bind(this));colIdx=colModel.getIndexById("propertyChannel");colModel.setRenderer(colIdx,this._propertyChannelColumnRenderer.bind(this));},_propertyNameColumnRenderer:function(value,metadata,record,rowIdx,colIdx,store){var property=this._getStencilProperty(record);return property?property.title():value;},_propertyChannelColumnRenderer:function(value,metadata,record,rowIdx,colIdx,store){var property=this._getStencilProperty(record);if(property){var channel=property.channel();if(channel!=null){if(channel=="")
return"";return this.facade.getChannelMetaData(channel).name;}}
return"";},_getStencilProperty:function(record){var stencilID=record.get("stencilid");if(stencilID){var stencilNamespace=this.facade.getCanvas().getStencil().namespace();var fullStencilID=stencilNamespace+stencilID;var stencil=ORYX.Core.StencilSet.stencil(fullStencilID);if(stencil){var propertyName=record.get("propertyName");if(propertyName)
return stencil.property("oryx-"+propertyName);}}
return null;}});ORYX.Plugins.ContentSearch.CHECK_FOR_RESULTS_EVENT="checkForResults";ORYX.Plugins.ContentSearch.RESET_RESULTS_EVENT="resetResults";ORYX.Plugins.ContentSearch.SHOW_RESULTS_EVENT="showResults";ORYX.Plugins.ContentSearch.SEARCH_RESULTS_SHOWN_EVENT="ContentSearch.resultsShown";ORYX.Plugins.ContentSearch.SEARCH_RESULTS_RESET_EVENT="ContentSearch.resultsReset";if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.JSONSupport=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);},exportJSON:function(){var json=this.facade.getSerializedJSON();this.openDownloadWindow(window.document.title+".json",json);},showImportDialog:function(successCallback){var allowFileInput=Ext.isGecko;var selectFileText=ORYX.I18N.JSONSupport.imp.selectFile;if(!allowFileInput)
selectFileText=ORYX.I18N.JSONSupport.imp.provideJSON;var formItems=[{text:selectFileText,style:'font-size:12px;margin-bottom:10px;display:block;',anchor:'100%',xtype:'label'}];if(allowFileInput){formItems.push({fieldLabel:ORYX.I18N.JSONSupport.imp.file,name:'subject',inputType:'file',style:'margin-bottom:10px;display:block;',itemCls:'ext_specific_window_overflow'});}
formItems.push({xtype:'textarea',hideLabel:true,name:'msg',anchor:'100% -63'});var form=new Ext.form.FormPanel({baseCls:'x-plain',labelWidth:50,defaultType:'textfield',items:formItems});var dialog=new Ext.Window({autoCreate:true,layout:'fit',plain:true,bodyStyle:'padding:5px;',title:ORYX.I18N.JSONSupport.imp.name,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[form],buttons:[{text:ORYX.I18N.JSONSupport.imp.btnImp,handler:function(){var loadMask=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.JSONSupport.imp.progress});loadMask.show();window.setTimeout(function(){var json=form.find("name","msg")[0].getValue();try{this.facade.importJSON(json,true);dialog.close();}
catch(error){Ext.Msg.alert(ORYX.I18N.JSONSupport.imp.syntaxError,error.message);}
finally{loadMask.hide();}}.bind(this),100);}.bind(this)},{text:ORYX.I18N.JSONSupport.imp.btnClose,handler:function(){dialog.close();}.bind(this)}]});dialog.show();if(allowFileInput){form.items.items[1].getEl().dom.addEventListener('change',function(evt){var text=evt.target.files[0].getAsText('UTF-8');form.items.items[2].setValue(text);},true);}}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.ActivityImplEditor=ORYX.Plugins.AbstractPlugin.extend({construct:function(facade){this.facade=facade;this.activitysREST_API='/wfe/rest/7.0/activitys/?limit=9001';this.editorWidth=800;this.editorHeight=450;this.contentMargin=20;this.formFieldWidth=300;this.currentActivityImplData={};this.invalidEndStates=[];this.endStatesPopoverId="endStatesPopover";this.channelCheckboxCls='channelCheckbox';this.channelCheckboxIdPattern=new RegExp(this.channelCheckboxCls+"-");this.channelCols=4;this.numOfDisplayedModels=10;this.pageIndex=0;ORYX.Plugins.ActivityImplEditor.openEditorWindow=this.openEditorWindow.bind(this);this.facade.offer({'name':"Activity Implementation Editor",'functionality':this.openEditorWindow.bind(this),'group':MOTV.I18N.FlowView.group,'icon':ORYX.PATH+"images/activity_imp.png",'description':"Activity Implementation Editor",'index':1,'toggle':false,'minShape':0,'maxShape':0});},disableCheckbox:function(checkbox){checkbox.disable();$j(checkbox).addClass('x-item-disabled');},enableCheckbox:function(checkbox){checkbox.enable();$j(checkbox).removeClass('x-item-disabled');},disableChannelCheckboxes:function(){this.enableChannelCheckboxes(false);$j('.'+this.channelCheckboxCls).next('label').addClass('disabled');},enableChannelCheckboxes:function(enable){var fn=(enable!==undefined&&enable===false)?this.disableCheckbox.bind(this):this.enableCheckbox.bind(this);$j.each(this.selectedActivityPanel.findChannelCheckboxes(),function(i,checkbox){fn(checkbox);}.bind(this));$j('.'+this.channelCheckboxCls).next('label').removeClass('disabled');},disableDefaultChannelCheckbox:function(){this.enableDefaultChannelCheckbox(false);},enableDefaultChannelCheckbox:function(enable){var checkbox=this.selectedActivityPanel.findDefaultCheckField();var fn=(enable!==undefined&&enable===false)?this.disableCheckbox.bind(this):this.enableCheckbox.bind(this);fn(checkbox);},enableSaveButton:function(){if(this.isCheckedDefault()||this.isCheckedChannel()){this.saveButton.enable();}else{this.saveButton.disable();}},isCheckedChannel:function(){return this.selectedActivityPanel.findChannelCheckboxes().some(function(chCheckbox){return chCheckbox.checked;});},isCheckedDefault:function(){return this.selectedActivityPanel.findDefaultCheckField().checked;},formatEndStatesArray:function(endStates){var tmpArr=[];$j.each(endStates,function(i,endState){tmpArr.push(endState);});tmpArr.sort(function(a,b){if(a.toLowerCase()==="success"){return-1;}else if(a.toLowerCase()==="failure"){return 0;}else{return 1;}});return tmpArr.join(', ');},getActivityGridPanel:function(isInit){if(isInit){if(this.grid){this.grid.destroy();this.grid=null;this.pagingPanel.destroy();this.pagingPanel=null;this.selectActivityPanel.destroy();this.selectActivityPanel=null;this.pageIndex=0;}}
if(this.pagingPanel){this.selectActivityPanel.remove(this.pagingPanel);}
_setRange=function(index){this.pageIndex=index;this.getActivityGridPanel();};_previous=function(){console.info('previous')
if(this.pageIndex!==0){this.pageIndex=this.pageIndex-this.numOfDisplayedModels;this.getActivityGridPanel();}};_next=function(){this.pageIndex=this.pageIndex+this.numOfDisplayedModels;this.getActivityGridPanel();};if(!this.activityStore){var rt=Ext.data.Record.create([{name:'id'},{name:'activity-name'},{name:'activity-type'},{name:'activity-descr'},{name:'activity-ends'},{name:'activity-version'},{name:'activity-expiration'},{name:'activity-author'},{name:'activity-createdTime'}]);this.activityStore=new Ext.data.Store({reader:new Ext.data.ArrayReader({idIndex:0},rt),sortInfo:{field:'activity-name',direction:'ASC'}});}
this.activityData.forEach((activityArray)=>{if(activityArray[2].startsWith('CUSTOM')){console.log('custom => ',activityArray[2]);activityArray[2]=activityArray[2].replace("CUSTOM",'Custom');}else{activityArray[2]=activityArray[2].toLowerCase().replace(/\b[a-z]/g,function(letter){return letter.toUpperCase();});}});this.activityStore.loadData(this.activityData.slice(this.pageIndex,(this.numOfDisplayedModels+this.pageIndex)));if(!this.grid){this.grid=new Ext.grid.GridPanel({region:'center',store:this.activityStore,stripeRows:true,colModel:new Ext.grid.ColumnModel({columns:[{header:'Activity Name',width:100,sortable:true,dataIndex:'activity-name'},{header:'Type',width:100,sortable:true,dataIndex:'activity-type'},{header:'Description',sortable:true,dataIndex:'activity-descr'},{header:'End States',sortable:true,dataIndex:'activity-ends'},{header:'Version',width:50,sortable:true,dataIndex:'activity-version'},{header:'Created Time',sortable:true,dataIndex:'activity-createdTime'},{header:'Expiration Time',sortable:true,dataIndex:'activity-expiration'},{header:'Author',sortable:true,dataIndex:'activity-author'}]}),anchor:'100% 88%',viewConfig:{forceFit:true},frame:false,iconCls:'icon-grid',listeners:{rowclick:this.selectActivityImplementation.bind(this)}});}
var buttons=[];var buttonStyle="padding:5px;";var activityCount=this.activityData.length;var shownModels=this.numOfDisplayedModels;var isFirstPage=this.pageIndex<shownModels;var isLastPage=this.pageIndex>=activityCount-shownModels;var currentPage=Math.max(Math.floor(this.pageIndex/shownModels),0);var lastPage=Math.max(Math.floor((activityCount-1)/shownModels),0);var endPage=Math.max(Math.min(currentPage+2,lastPage),0);var startPage=Math.max(endPage-4,0);endPage=Math.max(Math.min(startPage+4,lastPage),0);if(startPage!=0){buttons.push(new Ext.LinkButton({text:"1",click:_setRange.bind(this,0),style:buttonStyle,disabled:isFirstPage}));buttons.push({xtype:'label',text:'...',style:buttonStyle})}
for(var i=startPage;i<=endPage;i++){var style=currentPage==i?buttonStyle+"font-size:13px;font-weight:bold;color:#000000;":buttonStyle;buttons.push(new Ext.LinkButton({text:(i+1)+"",click:_setRange.bind(this,i*shownModels),style:style,disabled:currentPage==i}));}
var countLabel=(activityCount-this.pageIndex>5)?'('+(this.pageIndex+1)+'-'+(this.pageIndex+this.numOfDisplayedModels)+' from '+activityCount+' flows)':'('+(this.pageIndex+1)+'-'+activityCount+' from '+activityCount+' flows)';buttons.push({xtype:'label',text:countLabel,style:buttonStyle});if(endPage!==lastPage){buttons.push({xtype:'label',text:'...',style:buttonStyle});buttons.push(new Ext.LinkButton({text:lastPage+1,click:_setRange.bind(this,activityCount-(activityCount%shownModels)),style:buttonStyle,disabled:isLastPage}));}
buttons.push(new Ext.LinkButton({text:Repository.I18N.ModelRangeSelection['previous'],click:_previous.bind(this),style:"position:absolute;bottom:1px;left:10px;",disabled:isFirstPage}));buttons.push(new Ext.LinkButton({text:Repository.I18N.ModelRangeSelection['next'],click:_next.bind(this),style:"position:absolute;bottom:1px;right:10px;",disabled:isLastPage}));this.pagingPanel=new Ext.Panel({style:'padding:10px;white-space:nowrap;text-align:center',region:'south',border:false,items:buttons,anchor:'100% 12%'});if(!this.selectActivityPanel){this.selectActivityPanel=new Ext.Panel({viewConfig:{forceFit:true},region:'center',layout:'anchor',frame:false,items:[this.grid,this.pagingPanel]})}else{this.selectActivityPanel.add(this.pagingPanel);this.selectActivityPanel.doLayout();}
return this.selectActivityPanel;},initEditorWindow:function(){var keepOneOpen=function(panel){var array=this.accordionPanel.items.keys;if(array.length==2){this.accordionPanel.items.items[1-array.indexOf(panel.id)].expand();}}.bind(this);this.setSelectedActivityPanel();var instructionPanel=new Ext.Panel({title:ORYX.I18N.Oryx.instructionsTitle,region:'center',titleCollalpse:true,collapsed:true,layout:'fit',height:300,bodyStyle:'padding:15px; border-top:0;',html:'<p>'+MOTV.I18N.ActivityImpEditor.instructions+'</p>',listeners:{"collapse":keepOneOpen.bind(arguments[0]),scope:this}});var layout_config={layout:'fit',defaults:{split:true,frame:true},items:[this.selectedActivityPanel,this.getActivityGridPanel(true)]};var layout=new Ext.Panel(layout_config);layout.region="center";var accordionItems=[instructionPanel];accordionItems.push({title:ORYX.I18N.Oryx.implementationTitle,titleCollapse:true,layout:'border',items:[layout],listeners:{"collapse":keepOneOpen.bind(arguments[0]),scope:this}});this.accordionPanel=new Ext.Panel({region:'center',layout:'accordion',defaults:{bodyStyle:'padding:15px'},layoutConfig:{titleCollapse:true,animate:true,activeOnTop:false},items:accordionItems});var editorWindow=new Ext.Window({id:'activityImplEditor',layout:'border',title:"Activity Implementation Editor",iconCls:"activity_impl_editor",height:this.editorHeight,width:this.editorWidth,minWidth:500,modal:true,collapsible:false,closable:true,fixedcenter:true,shadow:true,proxyDrag:true,items:[this.accordionPanel],minButtonWidth:100,buttons:[{text:"Cancel",icon:'images/silk/cancel.png',cls:'x-btn-text-icon',handler:function(){editorWindow.close();}.bind(this)},{text:'Save',icon:'images/silk/disk.png',cls:'x-btn-text-icon',disabled:true,handler:function(){this.saveCurrentActivityImplData();editorWindow.close();}.bind(this)}],listeners:{resize:function(window){this.setEditorSize({height:window.el.getHeight(),width:window.el.getWidth()});this.selectedActivityPanel.setWidth(this.editorWidth-this.contentMargin);this.selectActivityPanel.setSize(this.editorWidth-this.contentMargin,this.editorHeight-120);}.bind(this),show:function(){this.selectActivityPanel.hide();this.populateSelectedActivityPanel();}.bind(this)}});this.saveButton=editorWindow.buttons[1];var canvas=Ext.getCmp('x-panel-editor-center-cmp-id').getEl();editorWindow.show();editorWindow.setWidth(canvas.getWidth()-60);editorWindow.alignTo(canvas,'tl-tl',[this.contentMargin,this.contentMargin]);},getActivityData:function(){return this.activityData;},getActivityExpirationDisplay:function(hours){if(hours<0){return"Never";}
var today=new Date();var dtExpire=today.addHours(hours);return RepositoryCore.renderLocalizedDate(dtExpire.getTime());},getChannelCheckboxId:function(ch){return this.channelCheckboxIdPattern.toString().replace(/^\/|\/$/g,'')+((typeof(ch)==='object'&&ch.id!==undefined)?ch.id:ch);},parseChannelId:function(checkboxId){return checkboxId.replace(this.channelCheckboxIdPattern,"");},setFlowEndStates:function(){this.flowEndStates=[];var shapes=this.facade.getCanvas().getChildShapes(true);if(shapes.length){$j.each(shapes,function(i,shape){if(shape.properties['oryx-ends']!==undefined&&shape.properties['oryx-name']!==undefined){this.flowEndStates.push(shape.properties['oryx-name']);}}.bind(this));}},openEditorWindow:function(){$j.when(this.setActivityData()).done(function(){this.setCurrentActivityImplData();this.setFlowEndStates();this.initEditorWindow();}.bind(this));},populateSelectedActivityPanel:function(){if($j.isEmptyObject(this.currentActivityImplData)||!this.currentActivityImplData['activity-name'].length){this.disableChannelCheckboxes();return;}
var record=this.grid.store.getAt(this.grid.store.find('activity-name',this.currentActivityImplData['activity-name']));this.selectedActivityPanel.findNameField().setValue(this.currentActivityImplData['activity-name']);if(record!==undefined){this.selectedActivityPanel.findEndStatesField().setValue(record.get('activity-ends'));}
this.selectedActivityPanel.findDefaultCheckField().setValue(this.currentActivityImplData['default']);$j.each(this.currentActivityImplData['channels'],function(i,channel){Ext.getCmp(this.getChannelCheckboxId(channel)).setValue(true);}.bind(this));this.enableChannelCheckboxes();this.enableDefaultChannelCheckbox();this.enableSaveButton();},setActivityData:function(){this.activityData=[];var that=this;var complete=$j.Deferred();$j.when($j.getJSON(this.activitysREST_API)).done(function(dataArray){$j.each(dataArray,function(i,data){var dtCreated=new Date(data.createdTime);var localizedDateCreated=RepositoryCore.renderLocalizedDate(dtCreated.getTime());var localizedDateExpire=that.getActivityExpirationDisplay(data.hoursToExpire);that.activityData.push([i,data.name,data.activityType,data.description,that.formatEndStatesArray(data.endStates),data.versionNumber,localizedDateExpire,data.author,localizedDateCreated]);});complete.resolve();}).fail(function(response){var respObj=$j.parseJSON(response.responseText);var errorMsg=(respObj&&respObj.errorMessage)?respObj.errorMessage:response.statusText;var errBox=$j('<div/>').css({'display':'inline-block'}).text(respObj.errorMessage).append($j('<div/>').text('method: '+this.type)).append($j('<div/>').text('url: '+this.url));that.showErrorModal(errBox);complete.reject();});return complete.promise();},selectActivityImplementation:function(myArg){var sm=this.grid.getSelectionModel();var store=this.grid.getStore();var nameField,endStatesField;if(sm.last!==undefined){nameField=this.selectedActivityPanel.findNameField();endStatesField=this.selectedActivityPanel.findEndStatesField();this.selectActivityPanel.hide();nameField.setValue(store.data.items[sm.last].data['activity-name']);endStatesField.setValue(store.data.items[sm.last].data['activity-ends']);this.selectedActivityPanel.show();this.enableChannelCheckboxes();this.enableDefaultChannelCheckbox();this.enableSaveButton();}else{Ext.Msg.show({title:"Info",msg:"Please select an activity",buttons:Ext.Msg.OK,animEl:'elId',icon:Ext.MessageBox.INFO});}},setChannelNames:function(){this.channels=[];$j.each(this.facade.getChannels(),function(key,ch){if(typeof(ch)==='object'&&ch.name!==undefined){this.channels.push(ch);}}.bind(this));},saveCurrentActivityImplData:function(){var currentMetaData={};this.oldActivityImplData=$j.extend(true,{},this.currentActivityImplData);this.currentActivityImplData={};var keyMap={'nameField':'activity-name','defaultCheckField':'default'}
this.currentActivityImplData['channels']=[];$j.each(this.selectedActivityPanel.findChannelCheckboxes(),function(i,checkbox){if(checkbox.checked){this.currentActivityImplData['channels'].push(this.parseChannelId(checkbox.id));}}.bind(this));$j.each(this.selectedActivityPanel.findAllFields(),function(i,fieldObj){if(keyMap[fieldObj.id]!==undefined){this.currentActivityImplData[keyMap[fieldObj.id]]=fieldObj.getValue();}}.bind(this));var command=new ORYX.Plugins.ActivityImplEditor.UpdateCommand(this.facade,this.currentActivityImplData,this.oldActivityImplData);this.facade.executeCommands([command]);},setCurrentActivityImplData:function(){if($j.isEmptyObject(this.currentActivityImplData)){this.currentActivityImplData=this.facade.getActivityImplMetaData();}},setEditorSize:function(size){this.editorHeight=size.height;this.editorWidth=size.width;},setSelectedActivityPanel:function(){var verticalMargin="5px";var activityNameField=new Ext.form.TextField({id:'nameField',fieldLabel:"Activity",width:this.formFieldWidth,style:{'margin-bottom':verticalMargin},listeners:{focus:function(){this.selectActivityPanel.show();this.selectActivityPanel.setWidth(this.editorWidth-this.contentMargin);this.selectedActivityPanel.hide();}.bind(this)}});var endStates=new Ext.form.TextField({id:"endStatesField",disabled:true,fieldLabel:"End States",width:this.formFieldWidth,style:{'margin-bottom':verticalMargin}});this.setChannelNames();var channelsPanelItems=[{html:'Channels',width:'105px'}];$j.each(this.channels,function(i,channel){if(i&&!(i%this.channelCols)){channelsPanelItems.push(new Ext.Panel());}
channelsPanelItems.push(new Ext.form.Checkbox({id:this.getChannelCheckboxId(channel),boxLabel:channel.name,cls:this.channelCheckboxCls,ctCls:this.channelCheckboxCls+'Container',disabled:true,listeners:{scope:this,check:function(){this.enableSaveButton();}}}));}.bind(this));var channelsPanel=new Ext.Panel({layout:'table',layoutConfig:{columns:this.channelCols+1},items:channelsPanelItems,style:{'margin-bottom':verticalMargin}});var defaultImplCheckbox=new Ext.form.Checkbox({id:"defaultCheckField",fieldLabel:"Default",ctCls:"defaultCheckFieldContainer",disabled:true,listeners:{scope:this,check:function(){this.enableSaveButton();}}});var form=new Ext.FormPanel({region:'center',width:780,labelWidth:100,items:[activityNameField,endStates,channelsPanel,defaultImplCheckbox]});Ext.apply(form,{'findAllFields':function(){return form.findBy(function(){return true;});},'findChannelCheckboxes':function(){return form.getEl().query('.'+this.channelCheckboxCls);}.bind(this),'findDefaultCheckField':function(){return form.findFieldById('defaultCheckField');},'findEndStatesField':function(){return form.findFieldById('endStatesField');},'findNameField':function(){return form.findFieldById('nameField');},'findFieldById':function(fieldId){var field=this.getComponent(fieldId);if(field!==undefined){return field;}else{alert("Error: Cannot find field id "+fieldId);}}});this.selectedActivityPanel=form;},showEndStatesBadge:function(isValid){var endStatesContainer=$j('#endStatesField').parent();var leftPos=parseFloat(endStatesContainer.css('padding-left').replace("px",""));var badgeCls='endStatesBadge';var endStatesBadge=$j('<div/>').addClass(badgeCls).addClass(isValid?"valid":"warning").css({'left':leftPos+280+"px"});$j('.'+badgeCls).remove();endStatesContainer.css({'position':'relative'}).append(endStatesBadge);endStatesBadge.filter('.warning').click(function(){this.showEndStatesPopover(false);}.bind(this));},removeEndStatesPopover:function(){$j('#'+this.endStatesPopoverId).remove();},showEndStatesPopover:function(delay){$j.fn.popoverClose=function(){this.slideUp("normal",function(){this.remove();});}
var missingEndsUL=$j('<ul/>');$j.each(this.invalidEndStates,function(i,end){missingEndsUL.append($j('<li/>').text(end));});var endStatesEl=$j('#endStatesField');var xForm=endStatesEl.parents('.x-form');var position=endStatesEl.position();var topPos=52;var leftPos=position.left;var closeIcon=$j('<div/>').addClass('closeIcon').attr('title','Close').html('&#215;');var popoverMsg=$j('<div/>').addClass('popoverMsg').html('The following activity end states are not present in the workflow:').append(missingEndsUL);var endStatesPopover=$j('<div/>').attr('id',this.endStatesPopoverId).addClass('popover').css({'left':leftPos+"px",'top':topPos+"px"}).append(closeIcon).append(popoverMsg);xForm.css({'position':'relative'}).append(endStatesPopover);var delayMillis=delay?1000:0;$j('#endStatesPopover').delay(delayMillis).slideDown();closeIcon.click(function(){$j(this).parent().popoverClose();});},showErrorModal:function(errBox){Ext.Msg.show({title:"Error",msg:errBox.prop('outerHTML'),buttons:Ext.Msg.OK,animEl:'elId',icon:Ext.MessageBox.ERROR});},showInfoModal:function(msgBox){Ext.Msg.show({title:"Information",msg:msgBox.prop('outerHTML'),buttons:Ext.Msg.OK,animEl:'elId',icon:Ext.MessageBox.INFO});},validateEndStates:function(){this.invalidEndStates=[];var activityEndStates=this.selectedActivityPanel.findEndStatesField().getValue().split(",");$j.each(activityEndStates,function(i,aes){var needle=aes.trim();if(this.flowEndStates.indexOf(needle)===-1){this.invalidEndStates.push(needle);}}.bind(this));this.removeEndStatesPopover();if(this.invalidEndStates.length){this.showEndStatesBadge(false);}else{this.showEndStatesBadge(true);}}});ORYX.Plugins.ActivityImplEditor.UpdateCommand=ORYX.Core.Command.extend({construct:function(facade,metadata,metadataOld){this.facade=facade;this.metadata=metadata;this.metadataOld=metadataOld;},execute:function(){this.facade.setActivityImplMetaData(this.metadata);this.facade.updateSelection();},rollback:function(){this.facade.setActivityImplMetaData(this.metadataOld);this.facade.updateSelection();}});Date.prototype.addHours=function(hours){var dt=new Date(this.valueOf());dt.setHours(dt.getHours()+hours);return dt;}
String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1).toLowerCase();};String.prototype.toTitleCase=function(){return this.charAt(0).toUpperCase()+this.slice(1).toLowerCase().replace(/(_)(.)/g,function(match,group1,group2){return group1+group2.toUpperCase();});}
var $j=jQuery.noConflict();Ext.LinkButton=Ext.extend(Ext.BoxComponent,{click:null,image:null,imageStyle:null,toggle:false,toggleStyle:null,selected:false,href:false,el:null,onRender:function(ct,position){if(this.el==null){this.el=document.createElement('a');this.el.id=this.getId();if(!this.disabled)
this.el.href=this.href?this.href:"#"+this.text;if(!this.disabled){Element.observe(this.el,'click',this.onClick.bind(this));}
if(this.image){this.el.innerHTML='<img src="'+this.image+'" title="'+this.text+'"'+(this.imageStyle?' style="'+this.imageStyle+'"/>':'/>')}else{this.el.innerHTML=this.text?Ext.util.Format.htmlEncode(this.text):(this.html||'');}
if(this.forId){this.el.setAttribute('htmlFor',this.forId);}}
Ext.LinkButton.superclass.onRender.call(this,ct,position);},onClick:function(e){if(this.disabled){Event.stop(e);return;}
if(this.toggle){this.selected=!this.selected;if(this.toggleStyle){this._setStyle(this.el.dom,'')
this.el.dom.setAttribute('style','')
if(this.selected){this.el.applyStyles(this.toggleStyle)}else{this.el.applyStyles(this.initialConfig.style)}}}
if(this.click instanceof Function)
this.click.apply(this.click,[this,e]);Event.stop(e)},setText:function(t,encode){this.text=t;if(this.rendered){this.el.dom.innerHTML=encode!==false?Ext.util.Format.htmlEncode(t):t;}
return this;},_setStyle:function(node,style){if(Ext.isIE){node.style.setAttribute('cssText',style);}else{node.setAttribute('style',style);}}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}
ORYX.Plugins.CanvasResize=Clazz.extend({construct:function(facade){this.facade=facade;new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"N",this.resize.bind(this));new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"W",this.resize.bind(this));new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"E",this.resize.bind(this));new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"S",this.resize.bind(this));},resize:function(position,shrink){resizeCanvas=function(position,extentionSize,facade){var canvas=facade.getCanvas();var b=canvas.bounds;var scrollNode=facade.getCanvas().getHTMLContainer().parentNode.parentNode;if(position=="E"||position=="W"){canvas.setSize({width:(b.width()+extentionSize)*canvas.zoomLevel,height:(b.height())*canvas.zoomLevel})}else if(position=="S"||position=="N"){canvas.setSize({width:(b.width())*canvas.zoomLevel,height:(b.height()+extentionSize)*canvas.zoomLevel})}
if(position=="N"||position=="W"){var move=position=="N"?{x:0,y:extentionSize}:{x:extentionSize,y:0};canvas.getChildNodes(false,function(shape){shape.bounds.moveBy(move)})
var edges=canvas.getChildEdges().findAll(function(edge){return edge.getAllDockedShapes().length>0})
var dockers=edges.collect(function(edge){return edge.dockers.findAll(function(docker){return!docker.getDockedShape()})}).flatten();dockers.each(function(docker){docker.bounds.moveBy(move)})}else if(position=="S"){scrollNode.scrollTop+=extentionSize;}else if(position=="E"){scrollNode.scrollLeft+=extentionSize;}
canvas.update();facade.updateSelection();}
var commandClass=ORYX.Core.Command.extend({construct:function(position,extentionSize,facade){this.position=position;this.extentionSize=extentionSize;this.facade=facade;},execute:function(){resizeCanvas(this.position,this.extentionSize,this.facade);},rollback:function(){resizeCanvas(this.position,-this.extentionSize,this.facade);},update:function(){}});var extentionSize=ORYX.CONFIG.CANVAS_RESIZE_INTERVAL;if(shrink)extentionSize=-extentionSize;var command=new commandClass(position,extentionSize,this.facade);this.facade.executeCommands([command]);}});ORYX.Plugins.CanvasResizeButton=Clazz.extend({construct:function(canvas,position,callback){this.canvas=canvas;var parentNode=canvas.getHTMLContainer().parentNode.parentNode.parentNode;window.myParent=parentNode
var scrollNode=parentNode.firstChild;var svgRootNode=scrollNode.firstChild.firstChild;var buttonGrow=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",parentNode,['div',{'class':'canvas_resize_indicator canvas_resize_indicator_grow'+' '+position,'title':ORYX.I18N.RESIZE.tipGrow+ORYX.I18N.RESIZE[position]}]);var buttonShrink=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",parentNode,['div',{'class':'canvas_resize_indicator canvas_resize_indicator_shrink'+' '+position,'title':ORYX.I18N.RESIZE.tipShrink+ORYX.I18N.RESIZE[position]}]);var offSetWidth=60;var isOverOffset=function(event){if(event.target!=parentNode&&event.target!=scrollNode&&event.target!=scrollNode.firstChild&&event.target!=svgRootNode&&event.target!=scrollNode)
return false;var X=event.layerX
var Y=event.layerY
if((X-scrollNode.scrollLeft)<0||Ext.isSafari){X+=scrollNode.scrollLeft;}
if((Y-scrollNode.scrollTop)<0||Ext.isSafari){Y+=scrollNode.scrollTop;}
if(position=="N"){return Y<offSetWidth+scrollNode.firstChild.offsetTop;}else if(position=="W"){return X<offSetWidth+scrollNode.firstChild.offsetLeft;}else if(position=="E"){var offsetRight=(scrollNode.offsetWidth-(scrollNode.firstChild.offsetLeft+scrollNode.firstChild.offsetWidth));if(offsetRight<0)offsetRight=0;return X>scrollNode.scrollWidth-offsetRight-offSetWidth;}else if(position=="S"){var offsetDown=(scrollNode.offsetHeight-(scrollNode.firstChild.offsetTop+scrollNode.firstChild.offsetHeight));if(offsetDown<0)offsetDown=0;return Y>scrollNode.scrollHeight-offsetDown-offSetWidth;}
return false;}
var showButtons=(function(){buttonGrow.show();var x1,y1,x2,y2;try{var bb=this.canvas.getRootNode().childNodes[1].getBBox();x1=bb.x;y1=bb.y;x2=bb.x+bb.width;y2=bb.y+bb.height;}catch(e){this.canvas.getChildShapes(true).each(function(shape){var absBounds=shape.absoluteBounds();var ul=absBounds.upperLeft();var lr=absBounds.lowerRight();if(x1==undefined){x1=ul.x;y1=ul.y;x2=lr.x;y2=lr.y;}else{x1=Math.min(x1,ul.x);y1=Math.min(y1,ul.y);x2=Math.max(x2,lr.x);y2=Math.max(y2,lr.y);}});}
var w=canvas.bounds.width();var h=canvas.bounds.height();var isEmpty=canvas.getChildNodes().size()==0;if(position=="N"&&(y1>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL||(isEmpty&&h>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL)))buttonShrink.show();else if(position=="E"&&(w-x2)>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL)buttonShrink.show();else if(position=="S"&&(h-y2)>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL)buttonShrink.show();else if(position=="W"&&(x1>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL||(isEmpty&&w>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL)))buttonShrink.show();else buttonShrink.hide();}).bind(this);var hideButtons=function(){buttonGrow.hide();buttonShrink.hide();}
scrollNode.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,function(event){if(isOverOffset(event)){showButtons();}else{hideButtons()}},false);buttonGrow.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,function(event){showButtons();},true);buttonShrink.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,function(event){showButtons();},true);parentNode.addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,function(event){hideButtons()},true);hideButtons();buttonGrow.addEventListener('click',function(){callback(position);showButtons();},true);buttonShrink.addEventListener('click',function(){callback(position,true);showButtons();},true);}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.RowLayouting={construct:function(facade){this.facade=facade;this.currentShapes=[];this.toMoveShapes=[];this.dragBounds=undefined;this.offSetPosition={x:0,y:0};this.evCoord={x:0,y:0};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LAYOUT_ROWS,this.handleLayoutRows.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));},onSelectionChanged:function(event){var elements=event.elements;if(!elements||elements.length==0){this.currentShapes=[];this.toMoveShapes=[];this.dragBounds=undefined;}else{this.currentShapes=elements;this.toMoveShapes=this.facade.getCanvas().getShapesWithSharedParent(elements);this.toMoveShapes=this.toMoveShapes.findAll(function(shape){return shape instanceof ORYX.Core.Node&&(shape.dockers.length===0||!elements.member(shape.dockers.first().getDockedShape()))});var newBounds=undefined;elements.each(function(value){if(!newBounds)
newBounds=value.absoluteBounds();else
newBounds.include(value.absoluteBounds());});this.dragBounds=newBounds;}
return;},handleMouseDown:function(event,uiObj){if(!this.dragBounds||!this.toMoveShapes.member(uiObj)){return};var evCoord=this.facade.eventCoordinates(event);var ul=this.dragBounds.upperLeft();this.offSetPosition={x:evCoord.x-ul.x,y:evCoord.y-ul.y}
return;},handleLayoutRows:function(event){var shape=event.shape;var offsetPos=this.offSetPosition;var marginLeft=event.marginLeft;var marginTop=event.marginTop;var spacingX=event.spacingX;var spacingY=event.spacingY;var elements=event.shape.getChildShapes(false);var movedShapes=this.toMoveShapes;movedShapes.each(function(shape){if(elements.include(shape))shape.bounds.moveBy(offsetPos);});if(event.exclude){elements=elements.filter(function(element){return!event.exclude.some(function(value){return element.getStencil().id()==value;});});}
var rowTop=marginTop;var rowBottom=marginTop-spacingY;if(event.horizontalLayout){elements.each(function(element){var ul=element.bounds.upperLeft();element.bounds.moveTo(ul.x,rowTop);})}
else
if(event.verticalLayout){elements.each(function(element){var ul=element.bounds.upperLeft();element.bounds.moveTo(marginLeft,ul.y);})}
elements=elements.sortBy(function(element){return element.bounds.upperLeft().y;});var insertRowOffset=0;var deleteRowOffset=0;var isNewRow=false;elements.each(function(element){var ul=element.bounds.upperLeft();var lr=element.bounds.lowerRight();var oldUlX=ul.x;var oldUlY=ul.y;var oldLrX=lr.x;var oldLrY=lr.y;if(movedShapes.include(element)){ul.y-=deleteRowOffset;if((ul.y>rowBottom)||((element==elements.first())&&ul.y<marginTop)){isNewRow=false;rowTop=rowBottom+spacingY;if(ul.y<rowTop){isNewRow=true;}}}
else{ul.y+=insertRowOffset;ul.y-=deleteRowOffset;if(ul.y>rowTop){isNewRow=false;rowTop=rowBottom+spacingY;}}
ul.y=rowTop;lr.y=ul.y+element.bounds.height();if(lr.y>rowBottom){if(isNewRow)
insertRowOffset+=lr.y-rowBottom;else
if(movedShapes.include(element))
insertRowOffset+=lr.y-rowBottom;rowBottom=lr.y;}
if((ul.x!=oldUlX)||(ul.y!=oldUlY)||(lr.x!=oldLrX)||(lr.y!=oldLrY)){if(!movedShapes.include(element)){if((oldUlY-ul.y)>deleteRowOffset)
deleteRowOffset=oldUlY-ul.y;}
element.bounds.set(ul.x,ul.y,lr.x,lr.y);}});elements=elements.sortBy(function(element){return element.bounds.upperLeft().y*10000+element.bounds.upperLeft().x;});rowTop=marginTop;var rowRight=marginLeft-spacingX;var maxRowRight=rowRight;var maxRowBottom=0;elements.each(function(element){var ul=element.bounds.upperLeft();var lr=element.bounds.lowerRight();var oldUlX=ul.x;var oldUlY=ul.y;var oldLrX=lr.x;var oldLrY=lr.y;if(ul.y>rowTop){rowTop=ul.y;rowRight=marginLeft-spacingX;}
ul.x=rowRight+spacingX;lr.x=ul.x+element.bounds.width();rowRight=lr.x;if(rowRight>maxRowRight)
maxRowRight=rowRight;if(lr.y>maxRowBottom)
maxRowBottom=lr.y;if((ul.x!=oldUlX)||(ul.y!=oldUlY)||(lr.x!=oldLrX)||(lr.y!=oldLrY)){element.bounds.set(ul.x,ul.y,lr.x,lr.y);}});if(event.shape!=this.facade.getCanvas()){var ul=event.shape.bounds.upperLeft();if(maxRowRight>marginLeft)
event.shape.bounds.set(ul.x,ul.y,ul.x+maxRowRight+marginLeft,ul.y+rowBottom+marginTop);}
else{if(maxRowRight>this.facade.getCanvas().bounds.width()){this.facade.getCanvas().setSize({width:(maxRowRight+marginLeft),height:this.facade.getCanvas().bounds.height()});}
if(maxRowBottom>this.facade.getCanvas().bounds.height()){this.facade.getCanvas().setSize({width:this.facade.getCanvas().bounds.width(),height:(rowBottom+marginTop)});}}
return;}};ORYX.Plugins.RowLayouting=Clazz.extend(ORYX.Plugins.RowLayouting);if(!ORYX.Plugins){ORYX.Plugins=new Object();}
ORYX.Plugins.Loading={construct:function(facade){this.facade=facade;this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.facade.getCanvas().getHTMLContainer().parentNode,['div',{'class':'LoadingIndicator'},'']);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_ENABLE,this.enableLoading.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_DISABLE,this.disableLoading.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_STATUS,this.showStatus.bind(this));this.disableLoading();},enableLoading:function(options){if(options.text)
this.node.innerHTML=options.text+"...";else
this.node.innerHTML=ORYX.I18N.Loading.waiting;this.node.removeClassName('StatusIndicator');this.node.addClassName('LoadingIndicator');this.node.style.display="block";var pos=this.facade.getCanvas().rootNode.parentNode.parentNode.parentNode.parentNode.parentNode;this.node.style.top=pos.offsetTop+'px';this.node.style.left=pos.offsetLeft+'px';},disableLoading:function(){this.timeout=null;this.node.style.display="none";},showStatus:function(options){if(options.text){this.node.innerHTML=options.text;this.node.addClassName('StatusIndicator');this.node.removeClassName('LoadingIndicator');this.node.style.display='block';var pos=this.facade.getCanvas().rootNode.parentNode.parentNode.parentNode.parentNode.parentNode;this.node.style.top=pos.offsetTop+'px';this.node.style.left=pos.offsetLeft+'px';var tout=options.timeout?options.timeout:2000;if(this.timeout){window.clearTimeout(this.timeout);}
this.timeout=window.setTimeout((function(){this.disableLoading();}).bind(this),tout);}}}
ORYX.Plugins.Loading=Clazz.extend(ORYX.Plugins.Loading);if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.MotiveSerialization={bpmnSerializationHandlerUrl:ORYX.CONFIG.ROOT_PATH+"motivebpmn2_0serialization",bpmnDeserializationHandlerUrl:ORYX.CONFIG.ROOT_PATH+"bpmn2_0deserialization",bpmn2XpdlSerializationHandlerUrl:ORYX.CONFIG.ROOT_PATH+"bpmn2xpdlserialization",construct:function(facade){this.facade=facade;},showBpmnXml:function(){this.generateBpmnXml(function(response){var json=response.evalJSON();this.showSchemaValidationEvent(json.validationEvents);this.openXMLWindow(json.xml);}.bind(this),this.bpmnSerializationHandlerUrl);},downloadBpmnXml:function(){this.generateBpmnXml(function(response){var json=response.evalJSON();this.showSchemaValidationEvent(json.validationEvents);this.openDownloadWindow("model.bpmn",json.xml);}.bind(this),this.bpmnSerializationHandlerUrl);},showSchemaValidationEvent:function(validationEvents){if(validationEvents&&ORYX.CONFIG.BPMN20_SCHEMA_VALIDATION_ON){this._showErrorMessageBox("Validation",validationEvents);}},generateBpmnXml:function(bpmnHandleFunction,handlerUrl){var loadMask=new Ext.LoadMask(Ext.getBody(),{msg:"Serialization of BPMN 2.0 model"});loadMask.show();var jsonString=this.facade.getSerializedJSON();this._sendRequest(handlerUrl,'POST',{'data':jsonString},function(response){bpmnHandleFunction(response);loadMask.hide();}.bind(this),function(transport){loadMask.hide();this._showErrorMessageBox(ORYX.I18N.Oryx.title,MOTV.I18N.MotiveSerialization.serialFailed);ORYX.log.warn("Serialization of BPMN 2.0 model failed: "+transport.responseText);}.bind(this));},_sendRequest:function(url,method,params,successcallback,failedcallback){var suc=false;new Ajax.Request(url,{method:method,asynchronous:false,parameters:params,onSuccess:function(transport){suc=true;if(successcallback){successcallback(transport.responseText);}}.bind(this),onFailure:function(transport){if(failedcallback){failedcallback(transport);}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Bpmn2Bpel.transfFailed);ORYX.log.warn("Serialization of BPMN 2.0 model failed: "+transport.responseText);}}.bind(this)});return suc;},_showErrorMessageBox:function(title,msg){Ext.MessageBox.show({title:title,msg:msg,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}};ORYX.Plugins.MotiveSerialization=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.MotiveSerialization);if(!ORYX.Plugins){ORYX.Plugins=new Object();}
ORYX.Plugins.ShapeMenuPlugin={construct:function(facade){this.facade=facade;this.noStencilSelected=false;this.alignGroups=new Hash();var containerNode=this.facade.getCanvas().getHTMLContainer();this.shapeMenu=new ORYX.Plugins.ShapeMenu(containerNode);this.currentShapes=[];this.soStencilIdPattern=new RegExp("^motv-so-");this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDROP_START,this.hideShapeMenu.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDROP_END,this.showShapeMenu.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DBLCLICK,(function(e,shape){var target=this.getGoToReferenceTarget([shape]);if(target)
this.focusReference(target,shape.resourceId);}).bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_RESIZE_START,(function(){this.hideShapeMenu();this.hideMorphMenu();this.hideQuickEditMenu();}).bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_RESIZE_END,this.showShapeMenu.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_CHANNEL_CHANGED,this.onChannelChanged.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.onPropertyChanged.bind(this));ORYX.Plugins.ShapeMenuPlugin.handleCompensationProperty=this.handleCompensationProperty.bind(this);var DragZone=new Ext.dd.DragZone(containerNode.parentNode,{shadow:!Ext.isMac});DragZone.afterDragDrop=this.afterDragging.bind(this,DragZone);DragZone.beforeDragOver=this.beforeDragOver.bind(this,DragZone);this.createdButtons={};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,(function(){this.registryChanged()}).bind(this));this.timer=null;this.resetElements=true;this.quickLaunchButton=null;this.quickLaunchState={active:new Hash(),collapsed:new Hash(),slots:new Hash()};for(var i=0;i<=ORYX.CONFIG.SHAPEMENU_SLOTS_MAX;i++){this.quickLaunchState.slots[i.toString()]=undefined;}},onChannelChanged:function(event,args){ORYX.Log.debug("ShapeMenuPlugin.onChannelChanged()::new:"+event.newChannel+", old:"+event.oldChannel);this.showShapeMenu(false);},onPropertyChanged:function(prop,node){ORYX.Log.debug("ShapeMenuPlugin.onPropertyChanged()::prop="+prop.name);var stencil=node.getStencil(),stencilId=stencil.idWithoutNs();var isEmbeddedFlowContainerNode=this._stencilHasRole(stencil,"EmbeddedFlowContainer");if((prop.name==="oryx-bpwfmodule"||prop.name==="oryx-processid"||prop.name==="oryx-callactivitycalledelement")&&this.quickLaunchButton!==null){if(prop.value!==""){this.quickLaunchButton.prepareToShow();}else{this.quickLaunchButton.prepareToHide();}
this.showShapeMenu(true);}else if((prop.name==="oryx-displayname"||prop.name==="oryx-name")&&isEmbeddedFlowContainerNode){var parentEditor=this.facade.getActiveEditor();if(parentEditor){var childEditor=parentEditor.getChildContainerEditor(node);if(childEditor){var flowSubviewName=node.properties["oryx-displayname"];if(flowSubviewName==null||flowSubviewName===""){flowSubviewName=node.properties["oryx-name"];}
childEditor.setTitle(flowSubviewName);}}}
if(this.currentShapes.length&&stencil.generateOutgoing&&prop.oldValue!=""&&node.outgoing.length>0&&stencil._properties[prop.name]._jsonProp.clearOutgoingOnChange){var that=this;Ext.MessageBox.confirm(ORYX.I18N.ShapeMenuPlugin.quickTransitionClearTitle,ORYX.I18N.ShapeMenuPlugin.quickTransitionClearMsg,function(response){if(response=="yes")
that.clearTransitions(node);});}},setNoStencilSelected:function(){this.noStencilSelected=true;var msgBox=$j('<div/>').css({'display':'inline-block'}).html(ORYX.I18N.ShapeMenuPlugin.doubleClickOffTargetMsg);this.showWarningModal(msgBox);},hideShapeMenu:function(event){window.clearTimeout(this.timer);this.timer=null;this.shapeMenu.hide();},showShapeMenu:function(dontGenerateNew){if(!dontGenerateNew||this.resetElements){this.noStencilSelected=false;window.clearTimeout(this.timer);this.timer=window.setTimeout(function(){this.shapeMenu.closeAllButtons();this.showMorphButton(this.currentShapes);this.showQuickDeleteButton(this.currentShapes);this.showStencilButtons(this.currentShapes);this.showQuickLaneButtons(this.currentShapes);this.showQuickEditButton(this.currentShapes);this.showQuickLaunchButton(this.currentShapes);this.showQuickDocumentationButton(this.currentShapes);this.showFocusReferenceButton(this.currentShapes);this.showBackReferenceButton(this.currentShapes);this.showQuickTransitionButton(this.currentShapes);this.shapeMenu.show(this.currentShapes);this.resetElements=false;}.bind(this),300)}else{window.clearTimeout(this.timer);this.timer=null;this.shapeMenu.show(this.currentShapes);}},getCommonPropertyValue:function(oryxPropertyName){var val=null;var propertyWindow=this.facade.getPropertyWindow();if(propertyWindow!==undefined&&propertyWindow!==null){try{val=propertyWindow.shapeSelection.commonPropertiesValues[oryxPropertyName];}catch(e){ORYX.Log.error("Error getting common property value "+oryxPropertyName+": "+e);}}
return val;},openProcessBlock:function(){var plugin=this.plugin;var node=this.element;var facade=plugin.facade;var flowSubviewName=node.properties["oryx-displayname"];if(flowSubviewName==null||flowSubviewName===""){flowSubviewName=node.properties["oryx-name"];}
var parentEditor=facade.getActiveEditor();if(parentEditor){var childEditor=parentEditor.createChildContainerEditor(node,flowSubviewName,false);childEditor.setAsActiveEditor();}},_createCanvas:function(stencilType,canvasConfig){if(stencilType){if(stencilType.search(/^http/)===-1){stencilType=this.facade.getStencilSets().values()[0].namespace()+stencilType;}}
else{stencilType=this.facade.getStencilSets().values()[0].findRootStencilName();}
var canvasStencil=ORYX.Core.StencilSet.stencil(stencilType);if(!canvasStencil)
ORYX.Log.fatal("Initialisation failed, because the stencil with the type %0 is not part of one of the loaded stencil sets.",stencilType);var div=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",null,['div']);div.addClassName("ORYX_Editor");var canvas=new ORYX.Core.Canvas({width:ORYX.CONFIG.CANVAS_WIDTH,height:ORYX.CONFIG.CANVAS_HEIGHT,id:"testidddd",parentNode:div},canvasStencil);if(canvasConfig){var properties=[];for(field in canvasConfig){properties.push({prefix:'oryx',name:field,value:canvasConfig[field]});}
canvas.deserialize(properties);}
return canvas;},quickLaunch:function(){ORYX.Log.trace("quickLaunch - Begin");var selectedProcessId=this.getCommonPropertyValue("oryx-processid");var selectedCallActivityId=this.getCommonPropertyValue("oryx-callactivitycalledelement");if(selectedProcessId==null){selectedProcessId=selectedCallActivityId;}
var selectedBpModule=this.getCommonPropertyValue("oryx-bpwfmodule");var win=null;var selectedFlow=null;var _self=this;if(selectedCallActivityId==null&&selectedBpModule==null){ORYX.Plugins.MotivePlugin.getAvailableFlows().each(function(flow){if(flow.value===selectedProcessId){selectedFlow=flow;}});}else if(selectedBpModule.length){ORYX.Plugins.MotivePlugin.getAvailableBpFlows().each(function(flow){if(flow.title===selectedBpModule){selectedFlow=flow;selectedProcessId=flow.value;}});}else{ORYX.Plugins.MotivePlugin.getAvailableBpFlows().each(function(flow){if(flow.value===selectedProcessId){selectedFlow=flow;}});}
if(this.quickLaunchState.active[selectedProcessId]!==undefined){return;}else if(this.quickLaunchState.collapsed[selectedProcessId]!==undefined){win=this.quickLaunchState.collapsed[selectedProcessId];win.expand(true);return;}
if(selectedFlow===null){Ext.Msg.alert('Quick Launch','The subflow/processtransfer/callactivity with process id '+selectedProcessId+' could not be found.  Please try again with a different subflow/processtransfer/callactivity.');return;}
var removeWinFromSlots=function(){var keys=_self.quickLaunchState.slots.keys();var slot=null;for(var i=0;i<keys.length;i++){slot=keys[i];if(_self.quickLaunchState.slots[slot]===selectedProcessId){_self.quickLaunchState.slots[slot]=undefined;ORYX.Log.debug("Removed  "+selectedFlow.title+" from slot "+slot);}}};var closeWin=function(){win.close();};var openEditor=function(){closeWin();window.open(ORYX.PATH+"editor;motive#/model/"+selectedFlow.identId);};win=new Ext.Window({processId:selectedProcessId,autoLoad:ORYX.PATH+"poem/model/"+selectedFlow.identId+"/svg",closable:true,collapsible:true,constrain:true,maximizable:true,minimizable:false,modal:false,title:selectedFlow.title,fixedcenter:true,shadow:true,proxyDrag:true,height:480,width:640,onEsc:Ext.emptyFn,buttons:[{text:"Close",handler:function(){closeWin();}.bind(this)},{text:"Open Editor...",handler:function(){openEditor();}.bind(this)}]});win.on("close",function(p){removeWinFromSlots();delete _self.quickLaunchState.active[p.initialConfig.processId];delete _self.quickLaunchState.collapsed[p.initialConfig.processId];});win.on("beforecollapse",function(p,animate){p.setWidth(ORYX.CONFIG.SHAPEMENU_SLOT_WIDTH);return true;});win.on("collapse",function(p){var numCollpased=_self.quickLaunchState.collapsed.keys().length;var ctr=Ext.getCmp("x-panel-editor-center-cmp-id");var xOffset=ctr.getPosition()[0];var yOffset=0;ORYX.Log.debug("Removing quick launch for process "+p.initialConfig.processId+" from active state");delete _self.quickLaunchState.active[p.initialConfig.processId];_self.quickLaunchState.collapsed[p.initialConfig.processId]=p;var keys=_self.quickLaunchState.slots.keys();var slot=null;var slotNum=0;var row=1;for(var i=0;i<keys.length;i++){slot=keys[i];slotNum=parseInt(slot);row=Math.floor(slotNum/ORYX.CONFIG.SHAPEMENU_SLOTS_PER_ROW);col=slotNum-(row*ORYX.CONFIG.SHAPEMENU_SLOTS_PER_ROW);yOffset=row*ORYX.CONFIG.SHAPEMENU_SLOT_HEIGHT;if(_self.quickLaunchState.slots[slot]===undefined){p.setPosition((col*ORYX.CONFIG.SHAPEMENU_SLOT_WIDTH)+xOffset,ctr.getPosition()[1]+yOffset);p.setTitle(Ext.util.Format.ellipsis(p.initialConfig.title,ORYX.CONFIG.SHAPEMENU_SLOT_TRUNCATE_LENGTH));p.setActive(false);_self.quickLaunchState.slots[slot]=p.initialConfig.processId;ORYX.Log.debug("Added "+selectedFlow.title+" to slot "+slot);break;}};});win.on("expand",function(p){ORYX.Log.debug("Adding quick launch for process "+p.initialConfig.processId+" to active state");delete _self.quickLaunchState.collapsed[p.initialConfig.processId];_self.quickLaunchState.active[p.initialConfig.processId]=p;p.setSize(p.initialConfig.width,p.initialConfig.height);p.center();p.setTitle(p.initialConfig.title);p.setActive(true);removeWinFromSlots();});win.show();ORYX.Log.debug("quickLaunch - opening quick launch dialog for subflow/processtransfer/callactivity: "+selectedProcessId);win.getEl().query(".x-window-body").each(function(el){Ext.get(el).applyStyles("overflow:auto;background-color:#EEF1FE;");});this.quickLaunchState.active[selectedProcessId]=win;ORYX.Plugins.ShapeMenuPlugin.quickLaunchState=this.quickLaunchState;ORYX.Log.trace("quickLaunch - End");},showQuickDeleteButton:function(elements){ORYX.Log.trace("showQuickDeleteButton - Begin");if(elements.length!=1||this.noStencilSelected){return}
if(typeof elements[0].getStencil!='function'){this.setNoStencilSelected();return};var stencil=elements[0].getStencil();var stencilId=stencil.idWithoutNs();ORYX.Log.debug("showQuickDeleteButton - stencil id = "+stencilId);var buttoncfg={align:ORYX.CONFIG.SHAPEMENU_BOTTOM,group:0,icon:ORYX.PATH+'images/trash-o.png',buttonsPerLevel:3};var button=new ORYX.Plugins.ShapeMenuButton({callback:ORYX.Plugins.Edit.editDelete,icon:buttoncfg.icon,align:buttoncfg.align,group:buttoncfg.group,msg:"Remove"});this.shapeMenu.setNumberOfButtonsPerLevel(buttoncfg.align,buttoncfg.buttonsPerLevel);this.shapeMenu.addButton(button);this.quickDeleteButton=button;ORYX.Log.debug("showQuickDeleteButton - buttonsPerLevel("+buttoncfg.align+"): "+
this.shapeMenu.getNumberOfButtonsPerLevel(buttoncfg.align));this.quickDeleteButton.prepareToShow();},showQuickLaneButtons:function(elements){ORYX.Log.trace("showQuickLaneButtons - Begin");if(elements.length!=1||this.noStencilSelected){return}
if(typeof elements[0].getStencil!='function'){this.setNoStencilSelected();return};var stencil=elements[0].getStencil();var stencilId=stencil.idWithoutNs();var pattern=/pool$/i;if(!pattern.test(stencilId)){return;}
ORYX.Log.debug("showQuickLaneButtons - stencil id = "+stencilId);var poolButtonsConfig=[{id:'AddLaneAbove',title:'Add lane above',icon:'/images/pool-add-lane-above.png'},{id:'AddLaneBelow',title:'Add lane below',icon:'/images/pool-add-lane-below.png'},{id:'SplitLane2',title:'Divide into two lanes',icon:'/images/pool-split-2.png'},{id:'SplitLane3',title:'Divide into three lanes',icon:'/images/pool-split-3.png'}];poolButtonsConfig.each((function(config){var button=this.createdPoolButtons[config.id];if(button!==undefined){button.prepareToShow();}}).bind(this));if(elements[0].isPoolDivided()){this.hideSplitLaneButtons();}},showQuickLaunchButton:function(elements){ORYX.Log.trace("showQuickLaunchButton - Begin");if(elements.length!=1||this.noStencilSelected){return}
if(typeof elements[0].getStencil!='function'){this.setNoStencilSelected();return};var selectedProcessId=this.getCommonPropertyValue("oryx-processid"),stencil=elements[0].getStencil(),stencilId=elements[0].getStencil().idWithoutNs();var selectedCallActivityId=this.getCommonPropertyValue("oryx-callactivitycalledelement");if(selectedProcessId==null){selectedProcessId=selectedCallActivityId;}
var selectedBpModule=this.getCommonPropertyValue("oryx-bpwfmodule");if(selectedProcessId==null){selectedProcessId=selectedBpModule;}
var buttoncfg={"bpfLauncher":{align:ORYX.CONFIG.SHAPEMENU_BOTTOM,group:0,icon:"zoom.png",buttonsPerLevel:3},"subflow":{align:ORYX.CONFIG.SHAPEMENU_BOTTOM,group:0,icon:"zoom.png",buttonsPerLevel:3},"subproc-transfer":{align:ORYX.CONFIG.SHAPEMENU_RIGHT,group:1,icon:"zoom.png",buttonsPerLevel:2},"CallActivity":{align:ORYX.CONFIG.SHAPEMENU_BOTTOM,group:0,icon:"zoom.png",buttonsPerLevel:3}};ORYX.Log.debug("showQuickLaunchButton - stencil id = "+stencilId);var isEmbeddedFlowContainerNode=this._stencilHasRole(stencil,"EmbeddedFlowContainer");if(stencilId==="subflow"||stencilId==="subproc-transfer"||stencilId==="CallActivity"||stencilId==="bpfLauncher"||isEmbeddedFlowContainerNode){var quickLaunchCallback=this.quickLaunch.bind(this);if(isEmbeddedFlowContainerNode){quickLaunchCallback=this.openProcessBlock.bind({"element":elements[0],"plugin":this});buttoncfg={align:ORYX.CONFIG.SHAPEMENU_BOTTOM,group:0,icon:"zoom.png",buttonsPerLevel:3};}else{buttoncfg=buttoncfg[stencilId];}
var button=new ORYX.Plugins.ShapeMenuButton({hovercallback:undefined,resetcallback:undefined,callback:quickLaunchCallback,icon:ORYX.PATH+'images/silk/'+buttoncfg.icon,align:buttoncfg.align,group:buttoncfg.group,msg:"Quick Launch"});this.shapeMenu.setNumberOfButtonsPerLevel(buttoncfg.align,buttoncfg.buttonsPerLevel);this.shapeMenu.addButton(button);this.quickLaunchButton=button;ORYX.Log.debug("showQuickLaunchButton - buttonsPerLevel("+buttoncfg.align+"): "+
this.shapeMenu.getNumberOfButtonsPerLevel(buttoncfg.align));ORYX.Log.debug("showQuickLaunchButton - selectedProcessId = "+selectedProcessId);if((selectedProcessId!==""&&selectedProcessId!==null&&selectedProcessId!==undefined)||isEmbeddedFlowContainerNode){this.quickLaunchButton.prepareToShow();}}
ORYX.Log.trace("showQuickLaunchButton - End");},showQuickDocumentationButton:function(elements){ORYX.Log.trace("showQuickDocumentationButton - Begin");if(elements.length!=1||this.noStencilSelected){return}
if(typeof elements[0].getStencil!='function'){this.setNoStencilSelected();return};this.onlineDocsLoaded=ORYX.Plugins.OnlineDocumentation.getServiceOperationList()!==undefined;var stencil=elements[0].getStencil(),stencilId=elements[0].getStencil().idWithoutNs();if(!this.soStencilIdPattern.test(stencilId)||!this.onlineDocsLoaded||!ORYX.Plugins.OnlineDocumentation.hasTitle(stencilId.replace(this.soStencilIdPattern,"")))return;var button=new ORYX.Plugins.ShapeMenuButton({callback:this.launchQuickDocumentation.bind(this,stencil),iconCls:ORYX.Plugins.OnlineDocumentation.getIconClass(),align:ORYX.CONFIG.SHAPEMENU_BOTTOM,group:0,msg:ORYX.I18N.ShapeMenuPlugin.quickDocumentationMsg});this.shapeMenu.addButton(button);this.quickDocumentationButton=button;ORYX.Log.debug("showQuickDocumentationButton");this.quickDocumentationButton.prepareToShow();ORYX.Log.trace("showQuickDocumentationButton - End");},launchQuickDocumentation:function(stencil){ORYX.Plugins.OnlineDocumentation.show({name:stencil.idWithoutNs().replace(this.soStencilIdPattern,""),title:stencil._jsonStencil.title,offset:this.currentShapes[0].bounds.b});},createQuickTransitionMenu:function(){this.qtMenu=new Ext.menu.Menu({id:'Oryx_qt_menu',items:[]});this.qtMenu.on("mouseover",function(){this.qtMenuHovered=true;},this);this.qtMenu.on("mouseout",function(){this.qtMenuHovered=false;},this);var button=new ORYX.Plugins.ShapeMenuButton({hovercallback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?this.showQuickTransitionMenu.bind(this):undefined),resetcallback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?this.hideQuickTransitionMenu.bind(this):undefined),callback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?undefined:this.toggleQuickTransitionMenu.bind(this)),icon:ORYX.PATH+'images/silk/arrow_branch.png',align:ORYX.CONFIG.SHAPEMENU_BOTTOM,group:0,msg:ORYX.I18N.ShapeMenuPlugin.quickTransitionMsg});this.shapeMenu.addButton(button);this.qtMenu.getEl().appendTo(button.node);this.quickTransitionButton=button;},showQuickTransitionMenu:function(){var enableAllMenuItems=false;var _group=null;if(this.currentShapes[0].currentQTNode){_group=this.currentShapes[0].currentQTNode.group;enableAllMenuItems=false;}else{enableAllMenuItems=true;}
this.qtMenu.items.each(function(menuItem){if(enableAllMenuItems||menuItem.shapeType=='edge'||menuItem.group=="clear"||(_group!=null&&menuItem.group==_group))
menuItem.enable();else
menuItem.disable();});this.qtMenu.show(this.quickTransitionButton.node);this._qtMenuShown=true;},hideQuickTransitionMenu:function(){this.qtMenu.hide();this._qtMenuShown=false;},toggleQuickTransitionMenu:function(){if(this._qtMenuShown)
this.hideQuickTransitionMenu();else
this.showQuickTransitionMenu();},hideQuickTransitionButton:function(){this.quickTransitionButton.prepareToHide();},showQuickTransitionButton:function(elements){ORYX.Log.trace("showQuickTransitionButton - Begin");if(elements.length!=1||this.noStencilSelected){return}
if(typeof elements[0].getStencil!='function'){this.setNoStencilSelected();return};var stencil=elements[0].getStencil(),stencilId=elements[0].getStencil().idWithoutNs();var _namespace=elements[0]._stencil._namespace;if(_namespace!="http://b3mn.org/stencilset/motive1.0#"||!stencil.generateOutgoing)return;ORYX.Log.debug("showQuickTransitionButton - stencil id = "+stencilId);var quickTransitionCallback=this.quickTransitionCallback.bind(this);var clearCallback=this.clearTransitions.bind(this,elements[0]);this.qtMenu.removeAll();var stencilset=this.facade.getStencilSets()[_namespace];var morphGroups=[];var morphGroupIndex=0;var possibleTransitionEndNodes=[];stencilset._availableStencils.values().each(function(stencil){if(stencil.quickTransitionNode){var possibleMorphs=this.facade.getRules().morphStencils({stencil:stencil});var groupFound=false;if(morphGroups.length){morphGroups.each(function(group,index){if(group.indexOf(stencil.idWithoutNs())!=-1){morphGroupIndex=index;groupFound=true;return false;}});}
if(!groupFound){morphGroups.push([]);morphGroupIndex=morphGroups.length-1;possibleMorphs.each(function(possibleMorphStencil,j){if(possibleMorphStencil.quickTransitionNode)
morphGroups[morphGroupIndex].push(possibleMorphStencil.idWithoutNs());});}
var _group=morphGroupIndex;possibleTransitionEndNodes.push({title:stencil.title(),type:stencil.idWithoutNs(),shapeType:stencil.type(),icon:stencil.icon(),group:_group});}}.bind(this));possibleTransitionEndNodes.sort(function(a,b){if(a.group<b.group)
return-1;if(a.group>b.group)
return 1;return 0;});var lastGroup=0;possibleTransitionEndNodes.each((function(node,index){if(morphGroups.length>1&&index>0&&index<possibleTransitionEndNodes.length-1&&node.group!=lastGroup){this.qtMenu.add(new Ext.menu.Separator());}
var menuItem=new Ext.menu.Item({text:node.title,icon:node.icon,type:node.type,shapeType:node.shapeType,group:node.group,handler:quickTransitionCallback,disabled:true});this.qtMenu.add(menuItem);lastGroup=node.group;}).bind(this));this.qtMenu.add(new Ext.menu.Separator());var menuItemClear=new Ext.menu.Item({text:"Clear Outgoing Transitions",icon:null,group:"clear",handler:clearCallback,disabled:true});this.qtMenu.add(menuItemClear);this.qtMenu.items.each(function(menuItem){if(menuItem.disabled)
menuItem.disable();else
menuItem.enable();});ORYX.Log.debug("showQuickTransitionButton");this.quickTransitionButton.prepareToShow();ORYX.Log.trace("showQuickTransitionButton - End");},quickTransitionCallback:function(node){this.currentShapes[0].currentQTNode=node;var generatorShape=this.currentShapes[0];var generatorShapeStencil=generatorShape.getStencil();var generatorShapeId=generatorShapeStencil.idWithoutNs();var _namespace=generatorShapeStencil._namespace;var _removeNodes=node.shapeType=="edge";var _type=_namespace+((node.shapeType=="edge")?"EndEvent":node.type);var _transitions=[];var generatorShapeOutgoing=generatorShapeStencil.outgoingTransitionNames;this.hideQuickTransitionMenu();if(generatorShapeOutgoing.length){generatorShapeOutgoing.each(function(transitionName,i){_transitions.push({"name":transitionName,"index":i});});this.handleQuickTransactionSuccessfulRequest({type:_type,namespace:_namespace,transitions:_transitions,removeNodes:_removeNodes});}else{Ext.Msg.wait(ORYX.I18N.ShapeMenuPlugin.quickTransitionWaitTitle,ORYX.I18N.ShapeMenuPlugin.quickTransitionWaitMsg,{interval:100,increment:50});Ext.Ajax.request({url:ORYX.PATH+"poem/outgoingTransitions",method:"POST",scope:this,success:function(response){Ext.Msg.hide();var obj=Ext.decode(response.responseText);var transitionsList=obj.transitionsList;if(transitionsList!=null){for(var i=0;i<transitionsList.length;i++){var transition=transitionsList[i];transition['index']=i;_transitions.push(transition);}}
this.handleQuickTransactionSuccessfulRequest({type:_type,namespace:_namespace,transitions:_transitions,removeNodes:_removeNodes});},failure:function(response){Ext.Msg.hide().show({title:ORYX.I18N.ShapeMenuPlugin.error,msg:String.format(ORYX.I18N.ShapeMenuPlugin.quickTransitionFailureMsg,response.status,response.statusText),icon:Ext.MessageBox.ERROR,buttons:Ext.MessageBox.OK});},params:{data:Ext.encode(generatorShape.properties),stencilId:generatorShapeId}});}},handleQuickTransactionSuccessfulRequest:function(option){if(option.transitions.length==0){this.currentShapes[0].currentQTNode=null;Ext.Msg.show({title:ORYX.I18N.ShapeMenuPlugin.warning,msg:ORYX.I18N.ShapeMenuPlugin.quickTransitionNoTransitionsMsg,icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.OK});return null;}
var generatorShape=this.currentShapes[0];var stencil=this.facade.getStencilSets()[option.namespace].stencil(option.type);var qtShapes=[];var sequencesToDelete=[];var removeFromTransitions=function(sequence){for(var i=0;i<option.transitions.length;i++){if(option.transitions[i].name==sequence.properties['oryx-conditionexpression']){option.transitions.splice(i,1);break;}}};var outgoing=generatorShape.getOutgoingShapes();if(outgoing.length>0){outgoing.each(function(sequence,index){var sequenceName=sequence.properties['oryx-conditionexpression'];var outShapes=sequence.getOutgoingShapes();var sequenceFound=false;for(var i=0;i<option.transitions.length;i++){sequenceFound=(option.transitions[i].name==sequenceName);break;}
if(!sequenceFound){if(option.transitions.length>=outgoing.length){if(outShapes.length>0){outShapes.each(function(outShape,index){if(outShape.outgoing.length)
outShape.qtDocker=outShape.outgoing[0].dockers.first();qtShapes.push(outShape);if(option.transitions.length>outgoing.length)
option.transitions.pop();this.facade.deleteShape(outShape);}.bind(this));}
this.facade.deleteShape(sequence);}else{if(outShapes.length>0){outShapes.each(function(outShape,index){if(outShape.outgoing.length)
outShape.qtDocker=outShape.outgoing[0].dockers.first();if(qtShapes.length<option.transitions.length){qtShapes.push(outShape);this.facade.deleteShape(outShape);}
sequencesToDelete.push(sequence);}.bind(this));}}}else{if(outShapes.length>0){outShapes.each(function(outShape,index){if(option.removeNodes){this.facade.deleteShape(outShape);}else if(outShape._stencil.id()!==stencil.id()){this.morphShape(outShape,stencil);}}.bind(this));}else{this.facade.setSelection([sequence],null,true);this.newShape({type:option.type,namespace:option.namespace});}
removeFromTransitions(sequence);}}.bind(this));}
if(sequencesToDelete.length){sequencesToDelete.each(function(sequence,index){this.facade.deleteShape(sequence);removeFromTransitions(sequence);}.bind(this));}
if(option.transitions.length||qtShapes.length){if(qtShapes.length){for(var i=0;i<qtShapes.length;i++){option.properties=qtShapes[i].properties;option.currentReference=qtShapes[i];option.position=qtShapes[i].bounds.center();this.newShape(option);if(qtShapes[i].qtDocker&&this.newShapeCommand.shape){qtShapes[i].qtDocker.setDockedShape(this.newShapeCommand.shape);this.dockOutshape(qtShapes[i].qtDocker);}}
if(option.transitions.length&&option.transitions.length>qtShapes.length){option.properties=null;option.currentReference=null;option.position=null;this.facade.setSelection([generatorShape],null,true);this.newShape(option);}}else
this.newShape(option);}
this.facade.setSelection([generatorShape],null,true);},dockOutshape:function(docker){var dockerCenter=docker.bounds.center();var dockedShapeCenter=docker._dockedShapeBounds.center();var pluginDragDocker=new ORYX.Plugins.DragDocker(this.facade,false);pluginDragDocker.handleMouseDown(new MouseEvent("mousedown",{"clientX":dockerCenter.x,"clientY":dockerCenter.y}),docker,true);pluginDragDocker.dockerMoved(new MouseEvent("mousemove",{"clientX":dockedShapeCenter.x,"clientY":dockedShapeCenter.y}));pluginDragDocker.dockerMovedFinished(new MouseEvent("mouseup",{"clientX":dockedShapeCenter.x,"clientY":dockedShapeCenter.y}));delete pluginDragDocker;},resizeCanvasAfterQuickTransition:function(){var canvas=this.facade.getCanvas();var canvasHeight=canvas.bounds.height();var canvasWidth=canvas.bounds.width();var topY=0;var bottomY=0;var leftX=0;var offsetX=20;var offsetY=5;var scrollY=false;var scrollX=false;var scrollNode=canvas.getHTMLContainer().parentNode.parentNode.parentNode;var canvasShapes=canvas.getChildShapes(true,function(shape){var b=shape.bounds;topY=Math.min(topY,b.upperLeft().y-offsetY);bottomY=Math.max(bottomY,b.lowerRight().y+offsetY);leftX=Math.max(leftX,b.lowerRight().x+offsetX);});if(topY<(offsetY* -1)&&canvasHeight>topY){canvasHeight=canvasHeight+Math.abs(topY);this.facade.executeCommands([new ORYX.Core.Command.Move(canvasShapes,{x:0,y:Math.abs(topY)},null,canvasShapes,this)]);}
if(canvasHeight<bottomY){canvasHeight=Math.abs(bottomY)+offsetY;scrollY=true;}
if(canvasWidth<leftX){canvasWidth=Math.abs(leftX)+offsetX;scrollX=true;}
var resizeCanvasCommandClass=ORYX.Core.Command.extend({construct:function(width,height,canvas){this.width=width;this.height=height;this.canvas=canvas;this.rollbackWidth=this.canvas.bounds.width();this.rollbackHeight=this.canvas.bounds.height();this.rollbackPrevious=true;},execute:function(){this.canvas.setSize({width:this.width,height:this.height});},rollback:function(){this.canvas.setSize({width:this.rollbackWidth,height:this.rollbackHeight});}});this.facade.executeCommands([new resizeCanvasCommandClass(canvasWidth*canvas.zoomLevel,canvasHeight*canvas.zoomLevel,canvas)]);var scrollCanvasCommandClass=ORYX.Core.Command.extend({construct:function(scrollX,scrollY,width,height,scrollNode){this.scrollX=scrollX;this.scrollY=scrollY;this.width=width;this.height=height;this.scrollNode=scrollNode;this.rollbackWidth=this.scrollNode.scrollLeft;this.rollbackHeight=this.scrollNode.scrollTop;this.rollbackPrevious=true;},execute:function(){if(this.scrollX)
this.scrollNode.scrollLeft=this.width;if(this.scrollY)
this.scrollNode.scrollTop=this.height;},rollback:function(){this.scrollNode.scrollLeft=this.rollbackWidth;this.scrollNode.scrollTop=this.rollbackHeight;}});this.facade.executeCommands([new scrollCanvasCommandClass(scrollX,scrollY,canvasWidth,canvasHeight,scrollNode)]);},clearTransitions:function(node){try{this.currentShapes[0].currentQTNode=null;var outgoing=node.getOutgoingShapes();var deleteFxn=this.facade.deleteShape;if(outgoing.length>0){outgoing.each(function(sequence,index){var outShapes=sequence.getOutgoingShapes();if(outShapes.length>0){outShapes.each(function(outShape,index){deleteFxn(outShape);});}
deleteFxn(sequence);});}}catch(e){Ext.Msg.show({title:ORYX.I18N.ShapeMenuPlugin.error,msg:ORYX.I18N.ShapeMenuPlugin.quickTransitionClearFailureMsg,icon:Ext.MessageBox.ERROR,buttons:Ext.MessageBox.OK});ORYX.Log.error(ORYX.I18N.ShapeMenuPlugin.quickTransitionClearFailureMsg+' Error: '+e);}},getGoToReferenceTarget:function(elements){ORYX.Log.trace("getGoToReferenceTarget - Begin");if(elements.length!=1||this.noStencilSelected){return}
if(typeof elements[0].getStencil!='function'){this.setNoStencilSelected();return null};if(!elements[0].getStencil().showFocusReference())return null;return elements[0].properties["oryx-target"];},showFocusReferenceButton:function(elements){ORYX.Log.trace("showFocusReferenceButton - Begin");var target=this.getGoToReferenceTarget(elements);if(!target)return;var focusReferenceCallback=this.focusReference.bind(this,target,elements[0].resourceId,true);var button=new ORYX.Plugins.ShapeMenuButton({callback:focusReferenceCallback,icon:ORYX.PATH+'images/silk/magnifier.png',align:ORYX.CONFIG.SHAPEMENU_BOTTOM,group:0,msg:ORYX.I18N.ShapeMenuPlugin.focusReference});this.shapeMenu.addButton(button);this.focusReferenceButton=button;this.focusReferenceButton.prepareToShow();},focusReference:function(referenceResourceId,goToReferenceResourceId){var focusReferenceCommandClass=ORYX.Core.Command.extend({construct:function(facade,referenceResourceId,goToReferenceResourceId){this.facade=facade;this.referenceResourceId=referenceResourceId;this.goToReferenceResourceId=goToReferenceResourceId;},execute:function(){this.facade.displayShapeInCanvas(this.referenceResourceId,true);},rollback:function(){this.facade.displayShapeInCanvas(this.goToReferenceResourceId,true);}});this.facade.executeCommands([new focusReferenceCommandClass(this.facade,referenceResourceId,goToReferenceResourceId)]);this.goToReferenceResourceId=goToReferenceResourceId;},focusBackReference:function(referenceResourceId){var backReferenceCommandClass=ORYX.Core.Command.extend({construct:function(plugin,facade,referenceResourceId,goToReferenceResourceId){this.plugin=plugin;this.facade=facade;this.referenceResourceId=referenceResourceId;this.goToReferenceResourceId=goToReferenceResourceId;},execute:function(){this.facade.displayShapeInCanvas(this.goToReferenceResourceId,true);},rollback:function(){this.plugin.goToReferenceResourceId=this.goToReferenceResourceId;this.facade.displayShapeInCanvas(this.referenceResourceId,true);}});this.facade.executeCommands([new backReferenceCommandClass(this,this.facade,referenceResourceId,this.goToReferenceResourceId)]);this.goToReferenceResourceId=null;},showBackReferenceButton:function(elements){ORYX.Log.trace("showBackReferenceButton - Begin");if(elements.length!=1||this.noStencilSelected){return}
if(typeof elements[0].getStencil!='function'){this.setNoStencilSelected();return};if(!elements[0].getStencil().hasBackFocus()||!this.goToReferenceResourceId)return;var backReferenceCallback=this.focusBackReference.bind(this,elements[0].resourceId);var button=new ORYX.Plugins.ShapeMenuButton({callback:backReferenceCallback,icon:ORYX.PATH+'images/silk/magifier_zoom_out.png',align:ORYX.CONFIG.SHAPEMENU_BOTTOM,group:0,msg:ORYX.I18N.ShapeMenuPlugin.backReference});this.shapeMenu.addButton(button);this.backReferenceButton=button;this.backReferenceButton.prepareToShow();},registryChanged:function(pluginsData){ORYX.Log.debug("registryChanged - Begin");if(pluginsData){pluginsData=pluginsData.each(function(value){value.group=value.group?value.group:'unknown'});this.pluginsData=pluginsData.sortBy(function(value){return(value.group+""+value.index);});}
this.shapeMenu.removeAllButtons();this.shapeMenu.setNumberOfButtonsPerLevel(ORYX.CONFIG.SHAPEMENU_RIGHT,2);this.createdButtons={};this.createMorphMenu();this.createQuickEditMenu();this.createQuickTransitionMenu();if(!this.pluginsData){this.pluginsData=[];}
this.baseMorphStencils=this.facade.getRules().baseMorphs();var isMorphing=this.facade.getRules().containsMorphingRules();var stencilsets=this.facade.getStencilSets();stencilsets.values().each((function(stencilSet){var nodes=stencilSet.nodes();nodes.each((function(stencil){var option={type:stencil.id(),namespace:stencil.namespace(),connectingType:true};var button=new ORYX.Plugins.ShapeMenuButton({callback:this.newShape.bind(this,option),icon:stencil.icon(),align:ORYX.CONFIG.SHAPEMENU_RIGHT,group:0,msg:stencil.title()+" - "+ORYX.I18N.ShapeMenuPlugin.clickDrag});this.shapeMenu.addButton(button);this.createdButtons[stencil.namespace()+stencil.type()+stencil.id()]=button;Ext.dd.Registry.register(button.node.lastChild,option);}).bind(this));var edges=stencilSet.edges();edges.each((function(stencil){var option={type:stencil.id(),namespace:stencil.namespace()};var button=new ORYX.Plugins.ShapeMenuButton({callback:this.newShape.bind(this,option),icon:(isMorphing&&!this.facade.isBPMN4())?ORYX.PATH+"images/edges.png":stencil.icon(),align:ORYX.CONFIG.SHAPEMENU_RIGHT,group:0,msg:((isMorphing&&!this.facade.isBPMN4())?ORYX.I18N.Edge:stencil.title())+" - "+ORYX.I18N.ShapeMenuPlugin.drag});this.shapeMenu.addButton(button);this.createdButtons[stencil.namespace()+stencil.type()+stencil.id()]=button;Ext.dd.Registry.register(button.node.lastChild,option);}).bind(this));}).bind(this));this.createdPoolButtons={};var poolButtonsConfig=[{id:'AddLaneAbove',title:'Add lane above',icon:'/images/pool-add-lane-above.png',callback:this.addLaneAbove.bind(this)},{id:'AddLaneBelow',title:'Add lane below',icon:'/images/pool-add-lane-below.png',callback:this.splitTwoLane.bind(this)},{id:'SplitLane2',title:'Divide into two lanes',icon:'/images/pool-split-2.png',callback:this.splitTwoLane.bind(this)},{id:'SplitLane3',title:'Divide into three lanes',icon:'/images/pool-split-3.png',callback:this.splitThreeLane.bind(this)}];poolButtonsConfig.each((function(config){var button=new ORYX.Plugins.ShapeMenuButton({callback:config.callback,icon:ORYX.PATH+config.icon,align:ORYX.CONFIG.SHAPEMENU_RIGHT,group:0,msg:config.title});this.shapeMenu.addButton(button);this.createdPoolButtons[config.id]=button;}).bind(this));ORYX.Log.debug("registryChanged - End");},addLaneAbove:function(){var dragDropShape=this.facade.getSelectedPool();this.selectedPool=dragDropShape;var laneHeight=125;var pool=this.currentShapes[0];var poolNode=dragDropShape.node;var poolDashedArea=dragDropShape.dashedArea;var parentSvg=pool._svgShapes[0].element.parentElement;var topSvg=parentSvg.parentElement;var parentNode=pool.parent.node;var bbox=parentSvg.getBBox();var newHeight=bbox.height+laneHeight;var newBounds=pool.absoluteBounds();newBounds.b.y+=laneHeight;var swimlanes=document.getElementsByClassName("swimlanes");var count=swimlanes.length;var fillColors=['white','#ccc','green','blue','yellow','#FF33FF','#CC3300'];var border=pool._svgShapes.filter(function(svg){return/border$/.test(svg.element.id);})[0].element;var laneToAdd=pool._svgShapes.filter(function(svg){return/addLane$/.test(svg.element.id);})[0].element.cloneNode();var mainLane=pool._svgShapes.filter(function(svg){return/c$/.test(svg.element.id);})[0].element;var caption=pool._svgShapes.filter(function(svg){return/captionDisableAntialiasing$/.test(svg.element.id);})[0].element;var namespace=pool._stencil._namespace;var stencilset=this.facade.getStencilSets()[namespace];var laneId=laneToAdd.id+count;laneToAdd.setAttributeNS(null,'id',laneId);laneToAdd.setAttributeNS(null,'visibility','visible');laneToAdd.setAttributeNS(null,'height',laneHeight);dragDropShape.resize(newBounds);pool.bounds.set(newBounds.a,newBounds.b);parentSvg.appendChild(laneToAdd);laneToAdd.setAttributeNS(null,'y',0);this.facade.getCanvas().update();this.facade.updateSelection();for(var i=2;i<count;i++){var yPos=laneHeight*(i-1);var swimlane=swimlanes[i];swimlanes[i].setAttributeNS(null,'y',yPos);}
var svgLaneShape=new ORYX.Core.SVG.SVGShape(laneToAdd);pool._svgShapes.push(svgLaneShape);this.addClick(laneToAdd);},addClick:function(laneToAdd){laneToAdd.onclick=this.laneClickHandler.bind(this);},laneClickHandler:function(e){var laneIdDisplay=e.target.id.replace(/^.+(addLane\d+)$/,"$1");this.selectedPool.hide();this.laneSelect(e.target.id);},laneSelect:function(id){var pool=this.currentShapes[0];var selectedLanes=[];pool._svgShapes.each(function(svg){var element=svg.element;if(id&&element.id===id){element.setAttributeNS(null,'fill','#ffff66');selectedLanes.push(new ORYX.Core.SVG.SVGShape(element));}else{element.setAttributeNS(null,'fill','#ffffff');}});if(selectedLanes.length){this.facade.setSelection(selectedLanes);this.facade.updateSelection();}},splitTwoLane:function(){var pool=this.currentShapes[0];var svgElems=pool._svgShapes.filter(function(svg){return svg.element.classList.contains('twoLanes');});if(svgElems!==undefined&&svgElems.length){this.showLaneDividers(svgElems);this.hideSplitLaneButtons();pool.setPoolDivided(true);}},splitThreeLane:function(){var pool=this.currentShapes[0];var svgElems=this.currentShapes[0]._svgShapes.filter(function(svg){return svg.element.classList.contains('threeLanes');});if(svgElems!==undefined&&svgElems.length){this.showLaneDividers(svgElems);this.hideSplitLaneButtons();pool.setPoolDivided(true);}},hideSplitLaneButtons:function(){this.createdPoolButtons['SplitLane2'].prepareToHide();this.createdPoolButtons['SplitLane3'].prepareToHide();},showLaneDividers:function(svgElems){svgElems.each(function(svg){svg.element.style.opacity="0.5";});},createMorphMenu:function(){this.morphMenu=new Ext.menu.Menu({id:'Oryx_morph_menu',items:[]});this.morphMenu.on("mouseover",function(){this.morphMenuHovered=true;},this);this.morphMenu.on("mouseout",function(){this.morphMenuHovered=false;},this);var button=new ORYX.Plugins.ShapeMenuButton({hovercallback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?this.showMorphMenu.bind(this):undefined),resetcallback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?this.hideMorphMenu.bind(this):undefined),callback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?undefined:this.toggleMorphMenu.bind(this)),icon:ORYX.PATH+'images/wrench_orange.png',align:ORYX.CONFIG.SHAPEMENU_BOTTOM,group:0,msg:ORYX.I18N.ShapeMenuPlugin.morphMsg});this.shapeMenu.setNumberOfButtonsPerLevel(ORYX.CONFIG.SHAPEMENU_BOTTOM,3);this.shapeMenu.addButton(button);this.morphMenu.getEl().appendTo(button.node);this.morphButton=button;},showMorphMenu:function(){this.morphMenu.show(this.morphButton.node);this._morphMenuShown=true;},hideMorphMenu:function(){this.morphMenu.hide();this._morphMenuShown=false;},toggleMorphMenu:function(){if(this._morphMenuShown)
this.hideMorphMenu();else
this.showMorphMenu();},onSelectionChanged:function(event){var elements=event.elements;this.hideShapeMenu();this.hideMorphMenu();this.hideQuickEditMenu();if(this.currentShapes.inspect()!==elements.inspect()){this.currentShapes=elements;this.resetElements=true;this.showShapeMenu();}else{this.showShapeMenu(true)}
if(elements.length===1&&elements[0]._stencil!==undefined&&elements[0]._stencil.idWithoutNs()==='Pool'){this.laneSelect();}},showMorphButton:function(elements){if(elements.length!=1||this.noStencilSelected){return}
if(typeof elements[0].getStencil!='function'){this.setNoStencilSelected();return};var possibleMorphs=this.facade.getRules().morphStencils({stencil:elements[0].getStencil()});possibleMorphs=possibleMorphs.select(function(morph){if(elements[0].getStencil().type()==="node"){return this.facade.getRules().canContain({containingShape:elements[0].parent,containedStencil:morph});}else{return this.facade.getRules().canConnect({sourceShape:elements[0].dockers.first().getDockedShape(),edgeStencil:morph,targetShape:elements[0].dockers.last().getDockedShape()});}}.bind(this));if(possibleMorphs.size()<=1)return;this.morphMenu.removeAll();possibleMorphs=possibleMorphs.sortBy(function(stencil){return stencil.position();});possibleMorphs.each((function(morph){var menuItem=new Ext.menu.Item({text:morph.title(),icon:morph.icon(),disabled:morph.id()==elements[0].getStencil().id(),disabledClass:ORYX.CONFIG.MORPHITEM_DISABLED,handler:(function(){this.morphShape(elements[0],morph);}).bind(this)});this.morphMenu.add(menuItem);}).bind(this));this.morphButton.prepareToShow();},createQuickEditMenu:function(){ORYX.Log.trace("createQuickEditMenu - Begin");this.quickEditMenu=new Ext.menu.Menu({id:'Oryx_quickedit_menu',items:[]});this.quickEditMenu.on("mouseover",function(){this.quickEditMenuHovered=true;},this);this.quickEditMenu.on("mouseout",function(){this.quickEditMenuHovered=false;},this);var button=new ORYX.Plugins.ShapeMenuButton({hovercallback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?this.showQuickEditMenu.bind(this):undefined),resetcallback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?this.hideQuickEditMenu.bind(this):undefined),callback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?undefined:this.toggleQuickEditMenu.bind(this)),icon:ORYX.PATH+'images/pencil.png',align:ORYX.CONFIG.SHAPEMENU_BOTTOM,group:0,msg:'Quick Edit'});this.shapeMenu.setNumberOfButtonsPerLevel(ORYX.CONFIG.SHAPEMENU_BOTTOM,3);this.shapeMenu.addButton(button);this.quickEditMenu.getEl().appendTo(button.node);this.quickEditButton=button;ORYX.Log.trace("createQuickEditMenu - End");},showQuickEditMenu:function(){this.quickEditMenu.show(this.quickEditButton.node);this._quickEditMenuShown=true;},hideQuickEditMenu:function(){this.quickEditMenu.hide();this._quickEditMenuShown=false;},toggleQuickEditMenu:function(){ORYX.Log.trace("toggleQuickEditMenu - Begin");if(this._quickEditMenuShown)
this.hideQuickEditMenu();else
this.showQuickEditMenu();ORYX.Log.trace("toggleQuickEditMenu - End");},showQuickEditButton:function(elements){ORYX.Log.trace("showQuickEditButton - Begin");if(elements.length!=1||this.noStencilSelected){return}
if(typeof elements[0].getStencil!='function'){this.setNoStencilSelected();return};var stencil=elements[0].getStencil();var propertyWindow=this.facade.getPropertyWindow();var channel=propertyWindow.getChannel();ORYX.Log.debug("showQuickEditButton - channel filter is "+channel);if(!stencil.showQuickEdit())return;ORYX.Plugins.ShapeMenuPlugin._selectedElement=elements[0];ORYX.Plugins.ShapeMenuPlugin._selectedStencil=stencil;var channelProps=[];var signalcfgProps=[];var quickEditProps=stencil.properties();quickEditProps=quickEditProps.select(function(prop){var includeProp=false;if((prop.type().include("html")||prop.type().include("text"))){if(prop.channel().include(channel)){includeProp=true;channelProps.push(prop);}}else if(prop.type().include("signalcfg")){includeProp=true;signalcfgProps.push(prop);}
return includeProp;}.bind(this));var typeOrdering=["html","signalcfg"];quickEditProps.sort(function(a,b){var aType=a.type();var bType=b.type();if(aType==bType)return 0;var aIndex=typeOrdering.indexOf(aType);var bIndex=typeOrdering.indexOf(bType);if(aIndex==bIndex)return 0;if(aIndex==-1)return 1;if(bIndex==-1)return-1;return(aIndex<bIndex)?-1:1;});var sortByTitle=function(a,b){var aName=a.title();var bName=b.title();if(aName==bName)return 0;if(aName==-1)return 1;if(bName==-1)return-1;return(aName<bName)?-1:1;};channelProps.sort(sortByTitle);signalcfgProps.sort(sortByTitle);ORYX.Log.debug("showQuickEditButton - quickEditProps.size() = "+quickEditProps.size());if(quickEditProps.size()<1)return;this.quickEditMenu.removeAll();channelProps.each((function(prop){var menuItem;if(prop.type().include("html")){menuItem=new Ext.menu.Item({text:prop.title(),icon:ORYX.CONFIG.ROOT_PATH+"images/html.png",handler:(function(){this.quickEdit(elements[0],prop);}).bind(this)});}else if(prop.type().include("text")){menuItem=new Ext.menu.Item({text:prop.title(),icon:ORYX.CONFIG.ROOT_PATH+"images/silk/page_white_text.png",handler:(function(){this.quickEdit(elements[0],prop);}).bind(this)});}
this.quickEditMenu.add(menuItem);ORYX.Log.debug("showQuickEditButton - added channel prop "+prop.title());}).bind(this));signalcfgProps.each((function(prop){var menuItem;if(quickEditProps.size()>1){this.quickEditMenu.add(new Ext.menu.Separator());}
menuItem=new Ext.menu.Item({text:"Edge Properties",icon:ORYX.CONFIG.ROOT_PATH+"images/edges.png",handler:(function(){this.quickEdit(elements[0],prop);}).bind(this)});this.quickEditMenu.add(menuItem);ORYX.Log.debug("showQuickEditButton - added signalcfg prop "+prop.title());}).bind(this));this.quickEditButton.prepareToShow();ORYX.Log.trace("showQuickEditButton - End");},quickEdit:function(selection,property){var key=property.prefix()+"-"+property.id();ORYX.Log.debug("ShapeMenuPlugin.quickEdit - key is "+key);var idx=ORYX.Plugins.PropertyWindow.dataSource.findBy(function(rec,idx){if(rec.data.gridProperties.propId==key){return true;}});if(idx>-1){Ext.getCmp("oryx-editor-grid").startEditing(idx,1);var triggered=false;var task={run:function(){var triggers=Ext.query(".x-trigger-wrap-focus .x-form-focus");ORYX.Log.trace("ShapeMenuPlugin.quickEdit - num triggers "+triggers.length);if(triggers.length>0){var trigger=triggers[0];if(!triggered){Ext.getCmp(trigger.id).onTriggerClick();triggered=true;Ext.TaskMgr.stop(this);}}},interval:100,duration:2000}
Ext.TaskMgr.start(task);}},getCompensationValue:function(value){if(typeof value==='string'){return(value.trim().toLowerCase()==='true');}
return value;},isForCompensation:function(shape){var propertyName='oryx-isforcompensation';if(shape.properties.hasOwnProperty(propertyName)){return this.getCompensationValue(shape.properties[propertyName]);}
return false;},handleCompensationProperty:function(value){var rightButtonGroup=$j('.Oryx_Right:first');if(this.getCompensationValue(value)){rightButtonGroup.hide();}else{rightButtonGroup.show();}},showStencilButtons:function(elements){if(elements.length!=1||this.noStencilSelected){return}
if(typeof elements[0].getStencil!='function'){this.setNoStencilSelected();return};var stencil=elements[0].getStencil();if(/(pool|lane)$/.test(stencil.idWithoutNs().toLowerCase())){return;}
var sset=this.facade.getStencilSets()[stencil.namespace()];var edges=this.facade.getRules().outgoingEdgeStencils({canvas:this.facade.getCanvas(),sourceShape:elements[0]});var targets=new Array();var addedEdges=new Array();var isMorphing=this.facade.getRules().containsMorphingRules();edges.each((function(edge){if(isMorphing){if(this.baseMorphStencils.include(edge)){var shallAppear=true;}else{var possibleMorphs=this.facade.getRules().morphStencils({stencil:edge});var shallAppear=!possibleMorphs.any((function(morphStencil){if(this.baseMorphStencils.include(morphStencil)&&edges.include(morphStencil))return true;return addedEdges.include(morphStencil);}).bind(this));}}
if(shallAppear||!isMorphing){if(this.createdButtons[edge.namespace()+edge.type()+edge.id()])
this.createdButtons[edge.namespace()+edge.type()+edge.id()].prepareToShow();addedEdges.push(edge);}
targets=targets.concat(this.facade.getRules().targetStencils({canvas:this.facade.getCanvas(),sourceShape:elements[0],edgeStencil:edge}));}).bind(this));targets.uniq();var addedTargets=new Array();targets.each((function(target){if(isMorphing){if(target.type()==="edge")return;if(!this.facade.getRules().showInShapeMenu(target))return
if(!this.baseMorphStencils.include(target)){var possibleMorphs=this.facade.getRules().morphStencils({stencil:target});if(possibleMorphs.size()==0)return;var baseMorphInTargets=possibleMorphs.any((function(morphStencil){if(this.baseMorphStencils.include(morphStencil)&&targets.include(morphStencil))return true;return addedTargets.include(morphStencil);}).bind(this));if(baseMorphInTargets)return;}}
if(this.createdButtons[target.namespace()+target.type()+target.id()]){this.createdButtons[target.namespace()+target.type()+target.id()].prepareToShow();}
addedTargets.push(target);}).bind(this));this.handleCompensationProperty(this.isForCompensation(elements[0]));},beforeDragOver:function(dragZone,target,event){if(this.shapeMenu.isVisible){this.hideShapeMenu();}
var coord=this.facade.eventCoordinates(event.browserEvent);var aShapes=this.facade.getCanvas().getAbstractShapesAtPosition(coord);if(aShapes.length<=0){return false;}
var el=aShapes.last();if(this._lastOverElement==el){return false;}else{var option=Ext.dd.Registry.getHandle(target.DDM.currentTarget);if(option.backupOptions){for(key in option.backupOptions){option[key]=option.backupOptions[key];}
delete option.backupOptions;}
var stencilSet=this.facade.getStencilSets()[option.namespace];var stencil=stencilSet.stencil(option.type);var candidate=aShapes.last();if(stencil.type()==="node"){var canContain=this.facade.getRules().canContain({containingShape:candidate,containedStencil:stencil});if(!canContain){var possibleMorphs=this.facade.getRules().morphStencils({stencil:stencil});for(var i=0;i<possibleMorphs.size();i++){canContain=this.facade.getRules().canContain({containingShape:candidate,containedStencil:possibleMorphs[i]});if(canContain){option.backupOptions=Object.clone(option);option.type=possibleMorphs[i].id();option.namespace=possibleMorphs[i].namespace();break;}}}
this._currentReference=canContain?candidate:undefined;}else{var curCan=candidate,orgCan=candidate;var canConnect=false;while(!canConnect&&curCan&&!(curCan instanceof ORYX.Core.Canvas)){candidate=curCan;canConnect=this.facade.getRules().canConnect({sourceShape:this.currentShapes.first(),edgeStencil:stencil,targetShape:curCan});curCan=curCan.parent;}
if(!canConnect){candidate=orgCan;var possibleMorphs=this.facade.getRules().morphStencils({stencil:stencil});for(var i=0;i<possibleMorphs.size();i++){var curCan=candidate;var canConnect=false;while(!canConnect&&curCan&&!(curCan instanceof ORYX.Core.Canvas)){candidate=curCan;canConnect=this.facade.getRules().canConnect({sourceShape:this.currentShapes.first(),edgeStencil:possibleMorphs[i],targetShape:curCan});curCan=curCan.parent;}
if(canConnect){option.backupOptions=Object.clone(option);option.type=possibleMorphs[i].id();option.namespace=possibleMorphs[i].namespace();break;}else{candidate=orgCan;}}}
this._currentReference=canConnect?candidate:undefined;}
this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:'shapeMenu',elements:[candidate],color:this._currentReference?ORYX.CONFIG.SELECTION_VALID_COLOR:ORYX.CONFIG.SELECTION_INVALID_COLOR});var pr=dragZone.getProxy();pr.setStatus(this._currentReference?pr.dropAllowed:pr.dropNotAllowed);pr.sync();}
this._lastOverElement=el;return false;},afterDragging:function(dragZone,target,event){if(!(this.currentShapes instanceof Array)||this.currentShapes.length<=0){return;}
var sourceShape=this.currentShapes;this._lastOverElement=undefined;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:'shapeMenu'});var proxy=dragZone.getProxy()
if(proxy.dropStatus==proxy.dropNotAllowed){return this.facade.updateSelection();}
if(!this._currentReference){return}
var option=Ext.dd.Registry.getHandle(target.DDM.currentTarget);option['parent']=this._currentReference;var xy=event.getXY();var pos={x:xy[0],y:xy[1]};var a=this.facade.getCanvas().node.getScreenCTM();pos.x-=a.e;pos.y-=a.f;pos.x/=a.a;pos.y/=a.d;pos.x-=document.documentElement.scrollLeft;pos.y-=document.documentElement.scrollTop;var parentAbs=this._currentReference.absoluteXY();pos.x-=parentAbs.x;pos.y-=parentAbs.y;if(!event.ctrlKey){var cShape=this.currentShapes[0].bounds.center();if(20>Math.abs(cShape.x-pos.x)){pos.x=cShape.x;}
if(20>Math.abs(cShape.y-pos.y)){pos.y=cShape.y;}}
option['position']=pos;option['connectedShape']=this.currentShapes[0];if(option['connectingType']){var stencilset=this.facade.getStencilSets()[option.namespace];var containedStencil=stencilset.stencil(option.type);var args={sourceShape:this.currentShapes[0],targetStencil:containedStencil};option['connectingType']=this.facade.getRules().connectMorph(args).id();}
if(ORYX.CONFIG.SHAPEMENU_DISABLE_CONNECTED_EDGE===true){delete option['connectingType'];}
var command=new ORYX.Plugins.ShapeMenuPlugin.CreateCommand(Object.clone(option),this._currentReference,pos,this);this.facade.executeCommands([command]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_SHAPE_MENU_CLOSE,source:sourceShape,destination:this.currentShapes});if(option.backupOptions){for(key in option.backupOptions){option[key]=option.backupOptions[key];}
delete option.backupOptions;}
this._currentReference=undefined;},newShape:function(option,event){var stencilset=this.facade.getStencilSets()[option.namespace];var containedStencil=stencilset.stencil(option.type);var containingShape=this.currentShapes.first().parent;if(containingShape&&containedStencil&&this.facade.getRules().canContain({containingShape:containingShape,containedStencil:containedStencil})){option['connectedShape']=this.currentShapes[0];option['parent']=this.currentShapes.first().parent;option['containedStencil']=containedStencil;var args={sourceShape:this.currentShapes[0],targetStencil:containedStencil};var targetStencil=this.facade.getRules().connectMorph(args);if(!targetStencil){return}
option['connectingType']=targetStencil.id();if(ORYX.CONFIG.SHAPEMENU_DISABLE_CONNECTED_EDGE===true){delete option['connectingType'];}
this.newShapeCommand=new ORYX.Plugins.ShapeMenuPlugin.CreateCommand(option,option.currentReference,option.position,this);this.facade.executeCommands([this.newShapeCommand]);}},morphShape:function(shape,stencil){var MorphTo=ORYX.Core.Command.extend({construct:function(shape,stencil,facade){this.shape=shape;this.stencil=stencil;this.facade=facade;},execute:function(){var shape=this.shape;var stencil=this.stencil;var resourceId=shape.resourceId;var parent=shape.parent;var serialized=shape.serialize();stencil.properties().each((function(prop){if(prop.readonly()){serialized=serialized.reject(function(serProp){return serProp.name==prop.id();});}}).bind(this));if(this.newShape){newShape=this.newShape;this.facade.getCanvas().add(newShape);}else{newShape=this.facade.createShape({type:stencil.id(),namespace:stencil.namespace(),resourceId:resourceId,parent:parent});}
var boundsObj=serialized.find(function(serProp){return(serProp.prefix==="oryx"&&serProp.name==="bounds");});var changedBounds=null;if(!this.facade.getRules().preserveBounds(shape.getStencil())){var bounds=boundsObj.value.split(",");if(parseInt(bounds[0],10)>parseInt(bounds[2],10)){var tmp=bounds[0];bounds[0]=bounds[2];bounds[2]=tmp;tmp=bounds[1];bounds[1]=bounds[3];bounds[3]=tmp;}
bounds[2]=parseInt(bounds[0],10)+newShape.bounds.width();bounds[3]=parseInt(bounds[1],10)+newShape.bounds.height();boundsObj.value=bounds.join(",");}else{var height=shape.bounds.height();var width=shape.bounds.width();if(newShape.minimumSize){if(shape.bounds.height()<newShape.minimumSize.height){height=newShape.minimumSize.height;}
if(shape.bounds.width()<newShape.minimumSize.width){width=newShape.minimumSize.width;}}
if(newShape.maximumSize){if(shape.bounds.height()>newShape.maximumSize.height){height=newShape.maximumSize.height;}
if(shape.bounds.width()>newShape.maximumSize.width){width=newShape.maximumSize.width;}}
changedBounds={a:{x:shape.bounds.a.x,y:shape.bounds.a.y},b:{x:shape.bounds.a.x+width,y:shape.bounds.a.y+height}};}
var oPos=shape.bounds.center();if(changedBounds!==null){newShape.bounds.set(changedBounds);}
this.setRelatedDockers(shape,newShape);var parentNode=shape.node.parentNode;var nextSibling=shape.node.nextSibling;var childShapes=shape.getChildShapes();this.facade.deleteShape(shape);newShape.resourceId=resourceId;var newShapeSerialized=serialized;serialized.each((function(serProp){var oProp=newShape.getStencil().properties().find(function(prop){if(prop.id()!='type'){return(serProp.name==prop.id());}});if(oProp==null){newShapeSerialized=newShapeSerialized.reject(function(newSerProp){return newSerProp.name==serProp.name;});}}).bind(this));newShape.deserialize(newShapeSerialized);if(changedBounds!==null){newShape.bounds.set(changedBounds);}
if(newShape.getStencil().type()==="edge"||(newShape.dockers.length==0||!newShape.dockers[0].getDockedShape())){newShape.bounds.centerMoveTo(oPos);}
if(newShape.getStencil().type()==="node"&&(newShape.dockers.length==0||!newShape.dockers[0].getDockedShape())){this.setRelatedDockers(newShape,newShape);}
if(nextSibling)parentNode.insertBefore(newShape.node,nextSibling);else parentNode.appendChild(newShape.node);if(!stencil.roles().member(stencil.namespace()+"sequence_start")&&!stencil.roles().member(stencil.namespace()+"sequence_end")){this.removeTransitions(newShape);}
this.facade.setSelection([newShape]);this.facade.getCanvas().update();this.facade.updateSelection();this.newShape=newShape;},rollback:function(){if(!this.shape||!this.newShape||!this.newShape.parent){return}
this.newShape.parent.add(this.shape);this.setRelatedDockers(this.newShape,this.shape);this.facade.deleteShape(this.newShape);this.facade.setSelection([this.shape]);this.facade.getCanvas().update();this.facade.updateSelection();},removeTransitions:function(node){try{var transitions=node.getIncomingShapes().concat(node.getOutgoingShapes());var deleteFxn=this.facade.deleteShape;if(transitions.length>0){transitions.each(function(sequence,index){deleteFxn(sequence);});}}catch(e){Ext.Msg.show({title:ORYX.I18N.ShapeMenuPlugin.error,msg:"Transitions not removed",icon:Ext.MessageBox.ERROR,buttons:Ext.MessageBox.OK});}},setRelatedDockers:function(shape,newShape){if(shape.getStencil().type()==="node"){(shape.incoming||[]).concat(shape.outgoing||[]).each(function(i){i.dockers.each(function(docker){if(docker.getDockedShape()==shape){var rPoint=Object.clone(docker.referencePoint);var rPointNew={x:rPoint.x*newShape.bounds.width()/shape.bounds.width(),y:rPoint.y*newShape.bounds.height()/shape.bounds.height()};docker.setDockedShape(newShape);docker.setReferencePoint(rPointNew);if(i instanceof ORYX.Core.Edge){docker.bounds.centerMoveTo(rPointNew);}else{var absXY=shape.absoluteXY();docker.bounds.centerMoveTo({x:rPointNew.x+absXY.x,y:rPointNew.y+absXY.y});}}});});if(shape.dockers.length>0&&shape.dockers.first().getDockedShape()){newShape.dockers.first().setDockedShape(shape.dockers.first().getDockedShape());newShape.dockers.first().setReferencePoint(Object.clone(shape.dockers.first().referencePoint));}}else{newShape.dockers.first().setDockedShape(shape.dockers.first().getDockedShape());newShape.dockers.first().setReferencePoint(shape.dockers.first().referencePoint);newShape.dockers.last().setDockedShape(shape.dockers.last().getDockedShape());newShape.dockers.last().setReferencePoint(shape.dockers.last().referencePoint);}}});var command=new MorphTo(shape,stencil,this.facade);this.facade.executeCommands([command]);},_stencilHasRole:function(stencil,role){return stencil.roles().member(stencil.namespace()+role);},showWarningModal:function(msgBox){Ext.Msg.show({title:ORYX.I18N.ShapeMenuPlugin.warning,msg:msgBox.prop('outerHTML'),buttons:Ext.Msg.OK,animEl:'elId',icon:Ext.MessageBox.WARNING});}}
ORYX.Plugins.ShapeMenuPlugin=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.ShapeMenuPlugin);ORYX.Plugins.ShapeMenu={construct:function(parentNode){this.bounds=undefined;this.shapes=undefined;this.buttons=[];this.isVisible=false;this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",$(parentNode),['div',{id:ORYX.Editor.provideId(),'class':'Oryx_ShapeMenu'}]);this.alignContainers=new Hash();this.numberOfButtonsPerLevel=new Hash();},addButton:function(button){this.buttons.push(button);if(!this.alignContainers[button.align]){this.alignContainers[button.align]=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.node,['div',{'class':button.align}]);this.node.appendChild(this.alignContainers[button.align]);var onBubble=false;this.alignContainers[button.align].addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,this.hoverAlignContainer.bind(this,button.align),onBubble);this.alignContainers[button.align].addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,this.resetAlignContainer.bind(this,button.align),onBubble);this.alignContainers[button.align].addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.hoverAlignContainer.bind(this,button.align),onBubble);}
this.alignContainers[button.align].appendChild(button.node);},deleteButton:function(button){this.buttons=this.buttons.without(button);this.node.removeChild(button.node);},removeAllButtons:function(){var me=this;this.buttons.each(function(value){if(value.node&&value.node.parentNode)
value.node.parentNode.removeChild(value.node);});this.buttons=[];},closeAllButtons:function(){this.buttons.each(function(value){value.prepareToHide()});this.isVisible=false;},show:function(shapes){if(shapes.length<=0)
return
this.shapes=shapes;var newBounds=undefined;var tmpBounds=undefined;this.shapes.each(function(value){var a=value.node.getScreenCTM();var upL=value.absoluteXY();a.e=a.a*upL.x;a.f=a.d*upL.y;tmpBounds=new ORYX.Core.Bounds(a.e,a.f,a.e+a.a*value.bounds.width(),a.f+a.d*value.bounds.height());if(!newBounds)
newBounds=tmpBounds
else
newBounds.include(tmpBounds);});this.bounds=newBounds;var bounds=this.bounds;var a=this.bounds.upperLeft();var left=0,leftButtonGroup=0;var top=0,topButtonGroup=0;var bottom=0,bottomButtonGroup;var right=0
rightButtonGroup=0;var size=22;this.getWillShowButtons().sortBy(function(button){return button.group;});this.getWillShowButtons().each(function(button){var numOfButtonsPerLevel=this.getNumberOfButtonsPerLevel(button.align);if(button.align==ORYX.CONFIG.SHAPEMENU_LEFT){if(button.group!=leftButtonGroup){left=0;leftButtonGroup=button.group;}
var x=Math.floor(left/numOfButtonsPerLevel)
var y=left%numOfButtonsPerLevel;button.setLevel(x);button.setPosition(a.x-5-(x+1)*size,a.y+numOfButtonsPerLevel*button.group*size+button.group*0.3*size+y*size);left++;}else if(button.align==ORYX.CONFIG.SHAPEMENU_TOP){if(button.group!=topButtonGroup){top=0;topButtonGroup=button.group;}
var x=top%numOfButtonsPerLevel;var y=Math.floor(top/numOfButtonsPerLevel);button.setLevel(y);button.setPosition(a.x+numOfButtonsPerLevel*button.group*size+button.group*0.3*size+x*size,a.y-5-(y+1)*size);top++;}else if(button.align==ORYX.CONFIG.SHAPEMENU_BOTTOM){if(button.group!=bottomButtonGroup){bottom=0;bottomButtonGroup=button.group;}
var x=bottom%numOfButtonsPerLevel;var y=Math.floor(bottom/numOfButtonsPerLevel);button.setLevel(y);button.setPosition(a.x+numOfButtonsPerLevel*button.group*size+button.group*0.3*size+x*size,a.y+bounds.height()+10+y*size);bottom++;}else{if(button.group!=rightButtonGroup){right=0;rightButtonGroup=button.group;}
var x=Math.floor(right/numOfButtonsPerLevel)
var y=right%numOfButtonsPerLevel;button.setLevel(x);button.setPosition(a.x+bounds.width()+5+x*size,a.y+numOfButtonsPerLevel*button.group*size+button.group*0.3*size+y*size-5);right++;}
button.show();}.bind(this));this.isVisible=true;},hide:function(){this.buttons.each(function(button){button.hide();});this.isVisible=false;},hoverAlignContainer:function(align,evt){this.buttons.each(function(button){if(button.align==align)button.showOpaque();});},resetAlignContainer:function(align,evt){this.buttons.each(function(button){if(button.align==align){button.showTransparent();}});},isHover:function(){return this.buttons.any(function(value){return value.isHover();});},getWillShowButtons:function(){return this.buttons.findAll(function(value){return value.willShow});},getButtons:function(align,group){return this.getWillShowButtons().findAll(function(b){return b.align==align&&(group===undefined||b.group==group)})},setNumberOfButtonsPerLevel:function(align,number){ORYX.Log.trace("ShapeMenu.setNumberOfButtonsPerLevel()::align="+align+"; levels="+number);this.numberOfButtonsPerLevel[align]=number;},getNumberOfButtonsPerLevel:function(align){var numLevels=1,numButtons=this.getButtons(align,0).length,numLevelsAlign=(this.numberOfButtonsPerLevel[align]!==undefined)?this.numberOfButtonsPerLevel[align]:null;if(numLevelsAlign!==null){numLevels=Math.min(numButtons,numLevelsAlign);}
ORYX.Log.trace("ShapeMenu.getNumberOfButtonsPerLevel()::numButtons="+numButtons+"; numLevelsAlign="+numLevelsAlign+"; numLevels="+numLevels);return numLevels;}}
ORYX.Plugins.ShapeMenu=Clazz.extend(ORYX.Plugins.ShapeMenu);ORYX.Plugins.ShapeMenuButton={construct:function(option){if(option){this.option=option;if(!this.option.arguments)
this.option.arguments=[];}else{}
this.parentId=this.option.id?this.option.id:null;var buttonClassName=this.option.caption?"Oryx_button_with_caption":"Oryx_button";this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",$(this.parentId),['div',{'class':buttonClassName}]);var imgOptions={src:this.option.icon};if(this.option.msg){imgOptions.title=this.option.msg;}
if(this.option.icon)
ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.node,['img',imgOptions]);if(this.option.iconCls){var iconClsOptions={class:this.option.iconCls};if(this.option.msg){iconClsOptions.title=this.option.msg;}
ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.node,['i',iconClsOptions]);}
if(this.option.caption){var captionNode=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.node,['span']);ORYX.Editor.graft("http://www.w3.org/1999/xhtml",captionNode,this.option.caption);}
var onBubble=false;this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,this.hover.bind(this),onBubble);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,this.reset.bind(this),onBubble);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this.activate.bind(this),onBubble);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.hover.bind(this),onBubble);this.node.addEventListener('click',this.trigger.bind(this),onBubble);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.move.bind(this),onBubble);this.align=this.option.align?this.option.align:ORYX.CONFIG.SHAPEMENU_RIGHT;this.group=this.option.group?this.option.group:0;this.hide();this.dragStart=false;this.isVisible=false;this.willShow=false;this.resetTimer;this.isSubmenuVisible=false;this.isMenuVisible=false;},setMenuVisible:function(isVisible){this.isMenuVisible=isVisible;},setSubmenuVisible:function(isVisible){this.isSubmenuVisible=isVisible;},hide:function(){ORYX.Log.trace("ORYX.Plugins.ShapeMenuButton.hide");this.node.style.display="none";this.isVisible=false;},show:function(){ORYX.Log.trace("ORYX.Plugins.ShapeMenuButton.show");this.node.style.display="";this.node.style.opacity=this.opacity;this.isVisible=true;},showOpaque:function(){ORYX.Log.trace("ORYX.Plugins.ShapeMenuButton.showOpaque");this.node.style.opacity=1.0;},showTransparent:function(){if(this.isMenuVisible||this.isSubmenuVisible){ORYX.Log.debug("ORYX.Plugins.ShapeMenuButton.showTransparent: submenu is visible, showTransparent will be ignored");return;}
ORYX.Log.trace("ORYX.Plugins.ShapeMenuButton.showTransparent: opacity = "+this.opacity);this.node.style.opacity=this.opacity;},prepareToShow:function(){this.willShow=true;},prepareToHide:function(){this.willShow=false;this.hide();},setPosition:function(x,y){this.node.style.left=x+"px";this.node.style.top=y+"px";},setLevel:function(level){if(level==0)this.opacity=0.5;else if(level==1)this.opacity=0.2;else this.opacity=0.0;ORYX.Log.trace("ORYX.Plugins.ShapeMenuButton.setLevel: level="+level+", opacity="+this.opacity);},setChildWidth:function(width){this.childNode.style.width=width+"px";ORYX.Log.trace("ORYX.Plugins.ShapeMenuButton.setChildWidth - "+width);},reset:function(evt){if(this.isSubmenuVisible){ORYX.Log.trace("ORYX.Plugins.ShapeMenuButton.reset: submenu is visible, menu will not be reset");return;}
ORYX.Log.trace("ORYX.Plugins.ShapeMenuButton.reset");window.clearTimeout(this.resetTimer)
this.resetTimer=window.setTimeout(this.doReset.bind(this),100);if(this.option.resetcallback){this.option.arguments.push(evt);var state=this.option.resetcallback.apply(this,this.option.arguments);this.option.arguments.remove(evt);}},doReset:function(){if(this.isSubmenuVisible){ORYX.Log.trace("ORYX.Plugins.ShapeMenuButton.doReset: submenu is visible, menu will not be reset");return;}
ORYX.Log.trace("ORYX.Plugins.ShapeMenuButton.doReset");if(this.node.hasClassName('Oryx_down'))
this.node.removeClassName('Oryx_down');if(this.node.hasClassName('Oryx_hover'))
this.node.removeClassName('Oryx_hover');this.showTransparent();},activate:function(evt){this.node.addClassName('Oryx_down');this.dragStart=true;},isHover:function(){return this.node.hasClassName('Oryx_hover')?true:false;},hover:function(evt){ORYX.Log.trace("ORYX.Plugins.ShapeMenuButton.hover");window.clearTimeout(this.resetTimer)
this.resetTimer=null;this.node.addClassName('Oryx_hover');this.dragStart=false;if(this.option.hovercallback){this.option.arguments.push(evt);var state=this.option.hovercallback.apply(this,this.option.arguments);this.option.arguments.remove(evt);}},move:function(evt){if(this.dragStart&&this.option.dragcallback){this.option.arguments.push(evt);var state=this.option.dragcallback.apply(this,this.option.arguments);this.option.arguments.remove(evt);}},trigger:function(evt){ORYX.Log.debug("ORYX.Plugins.ShapeMenuButton.trigger");if(this.option.callback){this.option.arguments.push(evt);var state=this.option.callback.apply(this,this.option.arguments);this.option.arguments.remove(evt);}
this.dragStart=false;},toString:function(){return"HTML-Button "+this.id;}}
ORYX.Plugins.ShapeMenuButton=Clazz.extend(ORYX.Plugins.ShapeMenuButton);ORYX.Plugins.ShapeMenuPlugin.CreateCommand=ORYX.Core.Command.extend({construct:function(option,currentReference,position,plugin){this.option=option;this.currentReference=currentReference;this.position=position;this.plugin=plugin;this.shape;this.edge;this.targetRefPos;this.sourceRefPos;this.shapeCount=this.option.transitions?this.option.transitions.length:1;},execute:function(){var nameEdge=function(i){if(this.option.transitions){this.edge.properties['oryx-conditionexpression']=this.option.transitions[i].name;this.edge.propertiesChanged['oryx-conditionexpression']=true;if(this.option.transitions[i].index!==undefined)
alignDir=align[this.option.transitions[i].index];}}.bind(this);var resume=false;var align=["east","north","northeast","southeast","south","northXnortheast","southXsoutheast","eastXsoutheast","eastXnortheast"];var alignDir="east";if(this.shape){if(this.shape instanceof ORYX.Core.Node){this.option.parent.add(this.shape);if(this.edge){this.plugin.facade.getCanvas().add(this.edge);this.edge.dockers.first().setDockedShape(this.option.connectedShape);this.edge.dockers.first().setReferencePoint(this.sourceRefPos);this.edge.dockers.last().setDockedShape(this.shape);this.edge.dockers.last().setReferencePoint(this.targetRefPos);}
this.plugin.facade.setSelection([this.shape]);}else if(this.shape instanceof ORYX.Core.Edge){this.plugin.facade.getCanvas().add(this.shape);this.shape.dockers.first().setDockedShape(this.option.connectedShape);this.shape.dockers.first().setReferencePoint(this.sourceRefPos);}
resume=true;}
else{this.shape=this.plugin.facade.createShape(this.option);this.edge=(!(this.shape instanceof ORYX.Core.Edge))?this.shape.getIncomingShapes().first():undefined;}
if(this.currentReference&&this.position){if(this.shape instanceof ORYX.Core.Edge){if(!(this.currentReference instanceof ORYX.Core.Canvas)){this.shape.dockers.last().setDockedShape(this.currentReference);var upL=this.currentReference.absoluteXY();var refPos={x:this.position.x-upL.x,y:this.position.y-upL.y};this.shape.dockers.last().setReferencePoint(this.currentReference.bounds.midPoint());}
else{this.shape.dockers.last().bounds.centerMoveTo(this.position);}
this.sourceRefPos=this.shape.dockers.first().referencePoint;this.targetRefPos=this.shape.dockers.last().referencePoint;}else if(this.edge){this.sourceRefPos=this.edge.dockers.first().referencePoint;this.targetRefPos=this.edge.dockers.last().referencePoint;for(var i=0;i<this.shapeCount;i++){nameEdge(i);}}}else{var containedStencil=this.option.containedStencil;var connectedShape=this.option.connectedShape;var bc=connectedShape.bounds;var bs=this.shape.bounds;var shapeArray=[this.shape];for(var i=0;i<this.shapeCount;i++){if(i>0){this.shape=this.plugin.facade.createShape(this.option);shapeArray.push(this.shape);this.edge=(!(this.shape instanceof ORYX.Core.Edge))?this.shape.getIncomingShapes().first():undefined;}
nameEdge(i);var pos=bc.center();if(containedStencil.defaultAlign()==="north"||alignDir==="north"){pos.y-=(bc.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(bs.height()/2);}else if(alignDir==="northXnortheast"){pos.x+=(bc.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(bs.width()/2);pos.y-=bc.height()+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+bs.height();}else if(containedStencil.defaultAlign()==="northeast"||alignDir==="northeast"){pos.x+=(bc.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(bs.width()/2);pos.y-=(bc.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(bs.height()/2);}else if(alignDir==="eastXnortheast"){pos.x+=bc.width()+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+bs.width();pos.y-=(bc.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(bs.height()/2);}else if(alignDir==="eastXsoutheast"){pos.x+=bc.width()+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+bs.width();pos.y+=(bc.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(bs.height()/2);}else if(containedStencil.defaultAlign()==="southeast"||alignDir==="southeast"){pos.x+=(bc.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(bs.width()/2);pos.y+=(bc.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(bs.height()/2);}else if(alignDir==="southXsoutheast"){pos.x+=(bc.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(bs.width()/2);pos.y+=bc.height()+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+bs.height();}else if(containedStencil.defaultAlign()==="south"||alignDir==="south"){pos.y+=(bc.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(bs.height()/2);}else if(containedStencil.defaultAlign()==="southwest"||alignDir==="southwest"){pos.x-=(bc.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(bs.width()/2);pos.y+=(bc.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(bs.height()/2);}else if(containedStencil.defaultAlign()==="west"){pos.x-=(bc.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(bs.width()/2);}else if(containedStencil.defaultAlign()==="northwest"||alignDir==="northwest"){pos.x-=(bc.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(bs.width()/2);pos.y-=(bc.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(bs.height()/2);}else{pos.x+=(bc.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(bs.width()/2);}
this.shape.bounds.centerMoveTo(pos);if(this.shape instanceof ORYX.Core.Node){(this.shape.dockers||[]).each(function(docker){docker.bounds.centerMoveTo(pos);})}
this.position=pos;if(this.edge){this.sourceRefPos=this.edge.dockers.first().referencePoint;this.targetRefPos=this.edge.dockers.last().referencePoint;}}
this.shapeArray=shapeArray;}
this.plugin.facade.getCanvas().update();if(this.option.transitions){this.plugin.resizeCanvasAfterQuickTransition();this.plugin.facade.setSelection([connectedShape],null,true);if(this.option.removeNodes){for(var i=0;i<shapeArray.length;i++){this.plugin.facade.deleteShape(shapeArray[i]);}}}else{this.plugin.facade.updateSelection();}
if(!resume){if(this.edge){this.plugin.doLayout(this.edge);}else if(this.shape instanceof ORYX.Core.Edge){this.plugin.doLayout(this.shape);}}},rollback:function(){var quickTransitionHostShape=null;var deleteShapeFxn=this.plugin.facade.deleteShape;if(this.shapeArray.length){for(var i=0;i<this.shapeArray.length;i++){var shape=this.shapeArray[i];shape.getIncomingShapes().each(function(edge){if(!quickTransitionHostShape){quickTransitionHostShape=edge.getIncomingShapes()[0];}
deleteShapeFxn(edge);});deleteShapeFxn(shape);}
this.plugin.facade.setSelection([quickTransitionHostShape],null,true);}else{this.plugin.facade.deleteShape(this.shape);if(this.edge){this.plugin.facade.deleteShape(this.edge);}
this.plugin.facade.setSelection(this.plugin.facade.getSelection().without(this.shape,this.edge));}}});var $j=jQuery.noConflict();if(!ORYX.Plugins){ORYX.Plugins={}}
if(!ORYX.Plugins.Layouter){ORYX.Plugins.Layouter={}}
new function(){ORYX.Plugins.Layouter.EdgeLayouter=ORYX.Plugins.AbstractLayouter.extend({layouted:["http://b3mn.org/stencilset/bpmn1.1#SequenceFlow","http://b3mn.org/stencilset/bpmn1.1#MessageFlow","http://b3mn.org/stencilset/bpmn2.0#MessageFlow","http://b3mn.org/stencilset/bpmn2.0#SequenceFlow","http://b3mn.org/stencilset/bpmn2.0conversation#ConversationLink","http://b3mn.org/stencilset/epc#ControlFlow","http://www.signavio.com/stencilsets/processmap#ProcessLink","http://www.signavio.com/stencilsets/organigram#connection"],layout:function(edges){edges.each(function(edge){this.doLayout(edge)}.bind(this))},doLayout:function(edge){var from=edge.getIncomingNodes()[0];var to=edge.getOutgoingNodes()[0];if(!from||!to){return}
var positions=this.getPositions(from,to,edge);if(positions.length>0){this.setDockers(edge,positions[0].a,positions[0].b);}},getPositions:function(from,to,edge){var ab=from.absoluteBounds();var bb=to.absoluteBounds();var a=ab.center();var b=bb.center();var am=ab.midPoint();var bm=bb.midPoint();var first=Object.clone(edge.dockers.first().referencePoint);var last=Object.clone(edge.dockers.last().referencePoint);var aFirst=edge.dockers.first().getAbsoluteReferencePoint();var aLast=edge.dockers.last().getAbsoluteReferencePoint();if(Math.abs(aFirst.x-aLast.x)<1||Math.abs(aFirst.y-aLast.y)<1){return[]}
var m={}
m.x=a.x<b.x?(((b.x-bb.width()/2)-(a.x+ab.width()/2))/2)+(a.x+ab.width()/2):(((a.x-ab.width()/2)-(b.x+bb.width()/2))/2)+(b.x+bb.width()/2);m.y=a.y<b.y?(((b.y-bb.height()/2)-(a.y+ab.height()/2))/2)+(a.y+ab.height()/2):(((a.y-ab.height()/2)-(b.y+bb.height()/2))/2)+(b.y+bb.height()/2);ab.widen(5);bb.widen(20);var positions=[];var off=this.getOffset.bind(this);if(!ab.isIncluded(b.x,a.y)&&!bb.isIncluded(b.x,a.y)){positions.push({a:{x:b.x+off(last,bm,"x"),y:a.y+off(first,am,"y")},z:this.getWeight(from,a.x<b.x?"r":"l",to,a.y<b.y?"t":"b",edge)});}
if(!ab.isIncluded(a.x,b.y)&&!bb.isIncluded(a.x,b.y)){positions.push({a:{x:a.x+off(first,am,"x"),y:b.y+off(last,bm,"y")},z:this.getWeight(from,a.y<b.y?"b":"t",to,a.x<b.x?"l":"r",edge)});}
if(!ab.isIncluded(m.x,a.y)&&!bb.isIncluded(m.x,b.y)){positions.push({a:{x:m.x,y:a.y+off(first,am,"y")},b:{x:m.x,y:b.y+off(last,bm,"y")},z:this.getWeight(from,"r",to,"l",edge,a.x>b.x)});}
if(!ab.isIncluded(a.x,m.y)&&!bb.isIncluded(b.x,m.y)){positions.push({a:{x:a.x+off(first,am,"x"),y:m.y},b:{x:b.x+off(last,bm,"x"),y:m.y},z:this.getWeight(from,"b",to,"t",edge,a.y>b.y)});}
return positions.sort(function(a,b){return a.z<b.z?1:(a.z==b.z?-1:-1)});},getOffset:function(pos,pos2,dir){return pos[dir]-pos2[dir];},getWeight:function(from,d1,to,d2,edge,reverse){d1=(d1||"").toLowerCase();d2=(d2||"").toLowerCase();if(!["t","r","b","l"].include(d1)){d1="r"}
if(!["t","r","b","l"].include(d2)){d1="l"}
if(reverse){d1=d1=="t"?"b":(d1=="r"?"l":(d1=="b"?"t":(d1=="l"?"r":"r")))
d2=d2=="t"?"b":(d2=="r"?"l":(d2=="b"?"t":(d2=="l"?"r":"r")))}
var weight=0;var dr1=this.facade.getRules().getLayoutingRules(from,edge)["out"];var dr2=this.facade.getRules().getLayoutingRules(to,edge)["in"];var fromWeight=dr1[d1];var toWeight=dr2[d2];var sameDirection=function(direction,center1,center2){switch(direction){case"t":return Math.abs(center1.x-center2.x)<2&&center1.y<center2.y
case"r":return center1.x>center2.x&&Math.abs(center1.y-center2.y)<2
case"b":return Math.abs(center1.x-center2.x)<2&&center1.y>center2.y
case"l":return center1.x<center2.x&&Math.abs(center1.y-center2.y)<2
default:return false;}}
var sameIncomingFrom=from.getIncomingShapes().findAll(function(a){return a instanceof ORYX.Core.Edge}).any(function(e){return sameDirection(d1,e.dockers[e.dockers.length-2].bounds.center(),e.dockers.last().bounds.center());});var sameOutgoingTo=to.getOutgoingShapes().findAll(function(a){return a instanceof ORYX.Core.Edge}).any(function(e){return sameDirection(d2,e.dockers[1].bounds.center(),e.dockers.first().bounds.center());});return(sameIncomingFrom||sameOutgoingTo?0:fromWeight+toWeight);},setDockers:function(edge,a,b){if(!edge){return}
edge.dockers.each(function(r){edge.removeDocker(r);});[a,b].compact().each(function(pos){var docker=edge.createDocker(undefined,pos);docker.bounds.centerMoveTo(pos);});edge.dockers.each(function(docker){docker.update()})
edge._update(true);}});}()
if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.LanguageSelectorPlugin=ORYX.Plugins.AbstractPlugin.extend({selectedCls:"languageselector-menuitem-selected",getLabelText:null,construct:function(facade){arguments.callee.$.construct.apply(this,arguments);this.facade=facade;var languageButton={'id':'LanguageSelector','name':"Language Selector",'group':'Language','description':'Language','index':1,'minShape':0,'isEnabled':function(){return true;},'customButtonCreateCallback':this.createLocaleSelectionButton.bind(this)};ORYX.Plugins.LanguageSelectorPlugin.getLabelText=this.getLabelText.bind(this);this.facade.offer(languageButton);this.languageButton=languageButton;},getLocaleKey:function(languagecode,countrycode){return languagecode+(countrycode?"_"+countrycode:"");},createLocaleSelectionButton:function(){var localeMenuButtonItems=[];var localeConfig=this.facade.getLocaleConfig();var defaultLocale=this.facade.getCurrentLocale();var defaultLocaleKey=this.getLocaleKey(defaultLocale.languagecode,defaultLocale.countrycode);localeConfig.sort(function(a,b){return a.displayName.toLowerCase()>b.displayName.toLowerCase();});localeConfig.each(function(locale){var localeStr=this.getLocaleKey(locale.languagecode,locale.countrycode);var localeStyle=(localeStr==defaultLocaleKey)?"font-style: italic;":"";var localeIconCls=(localeStr==defaultLocaleKey)?this.selectedCls:"";var mItem=new Ext.menu.Item({text:locale.displayName,iconCls:localeIconCls,style:localeStyle,data:locale,handler:this._setLocale.bind(this)});localeMenuButtonItems.push(mItem);}.bind(this));this.splitButton=new Ext.Toolbar.DynamicIconSplitButton({text:String.format(MOTV.I18N.LocaleMenuButton.text,defaultLocale.displayName),icon:ORYX.PATH+"images/silk/world.png",iconCls:"x-btn-text-icon",showText:true,menu:new Ext.menu.Menu({items:localeMenuButtonItems,}),listeners:{click:function(button,event){if(!button.menu.isVisible()&&!button.ignoreNextClick){button.showMenu();}else{button.hideMenu();}}}});return this.splitButton;},_getStringFromJson:function(prop){var returnStr=prop,json,pattern,matches,localeStr,locale=this.facade.getCurrentLocale();if(locale&&/"values":\[/.test(prop)){localeStr=locale.languagecode+((locale.countrycode!==undefined)?("_"+locale.countrycode):"");pattern=new RegExp("({\"locale\":\""+localeStr+"\",\s*\"value\":\"[^{]*\"})");matches=pattern.exec(prop);if(matches){json=Ext.util.JSON.decode(matches[1]);returnStr=json.value;}}
return returnStr;},_setLocale:function(button){var data=button.data;var locale=(data!==undefined)?{key:this.getLocaleKey(data.languagecode,data.countrycode),displayName:data.displayName,languagecode:data.languagecode,countrycode:data.countrycode}:{displayName:button.text};this.facade.setCurrentLocale(locale);this.splitButton.menu.items["items"].each(function(tempItem){tempItem.setIconClass("");});this.splitButton.menu.activeItem.setIconClass(this.selectedCls);this.splitButton.setText(String.format(MOTV.I18N.LocaleMenuButton.text,button.text));var flow=this.facade.getCurrentFlowView(),flowView=this.facade.getFlowViewByName(flow),shape,displayNameValue;$j.each(flowView.flowViewShapes,function(fIdx,fItem){shape=this.facade.getCanvas().getShape(fItem.resourceId);if(shape&&shape.properties.hasOwnProperty("oryx-displayname")){displayNameValue=this._getStringFromJson(shape.properties["oryx-displayname"]);shape._labels.values().each(function(label){if(/.*title$/.test(label.id)){label.text(displayNameValue);label.update();return;}});}}.bind(this));this.facade.getCanvas().update();},getLabelText:function(shape,type){var returnValue;if(type==='oryx-displayname'){if(shape.properties[type]){returnValue=this._getStringFromJson(shape.properties[type]);}else{return""}}
return returnValue;}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.RDFExport=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);},exportRDF:function(){this.openDownloadWindow(window.document.title+".rdf",this.getRDFFromDOM());}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.MergeToolbar=ORYX.Plugins.AbstractPlugin.extend({setMergeData:null,removeAllMergeData:null,raiseOverlay:null,setup:function(){try{this.handlerURL=ORYX.PATH+"poem/searchContent";}catch(e){}},construct:function(){arguments.callee.$.construct.apply(this,arguments);this.active=false;ORYX.Plugins.MergeToolbar.setMergeData=this.setMergeData.bind(this);ORYX.Plugins.MergeToolbar.removeAllMergeData=this.removeAllMergeData.bind(this);ORYX.Plugins.MergeToolbar.raiseOverlay=this.removeAllMergeData.bind(this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_FLOW_VIEW_CHANGE,function(){this.raiseOverlay();}.bind(this));},removeAllMergeData:function(){if(this.mergeGrid&&this.mergeGrid.store){this.removeFromDock();}},setMergeData:function(data){if(data){this.convertMergeData(data);this.initTabView();this.addToDock();$j('#mergeToolBarSearchBtn').off();$j('#mergeToolBarSearchBtn').keyup(this.filterMergeList.bind(this));this.resourceIdArray=[];ORYX.Plugins.Merge.removeMergeIconOverlay();$j(this.mergeData.data).each(function(idx,item){this.resourceIdArray.push(item.resourceId);}.bind(this));this.raiseOverlay();}},raiseOverlay:function(){if(this.resourceIdArray&&this.resourceIdArray.length){var shapes=ORYX.Plugins.Merge.getShapesFromResourceId(this.resourceIdArray);ORYX.Plugins.Merge.raiseOverlay(shapes);}},convertMergeData:function(data){var mData=[],mergeItem;$j.each(data.flowView,function(idx,fItem){$j.each(fItem.changeSummary,function(cIdx,cItem){switch(cItem.changeCategory){case"deleted":case"added":{mergeItem=this.parseMergeAddDelete(cItem,fItem);mergeItem.namespace=data.namespace;mData.push(mergeItem);break}
case"updated":{$j.each(cItem.nodeProperties,function(pIdx,pItem){mergeItem=this.parseMergeUpdate(pItem,cItem,fItem);mergeItem.namespace=data.namespace;mData.push(mergeItem);}.bind(this));break;}}}.bind(this));if(fItem.hasOwnProperty('activityImplMetaData')&&fItem.activityImplMetaData!=null&&fItem.activityImplMetaData.length>0){var aItem=fItem.activityImplMetaData[0];aItem.changeCategory="implView";mergeItem=this.parseMergeAddDeleteActivityImp(aItem,fItem);mData.push(mergeItem);}}.bind(this));this.mergeData={};this.mergeData.data=mData;},parseMergeAddDeleteActivityImp:function(changeItem,flow){changeItem.propertyDef={};changeItem.propertyDef.propertyName=changeItem.activityName;changeItem.propertyDef.displayName=changeItem.activityName;if(!changeItem.activityName){changeItem.activityName="";}
changeItem.value={rightValue:"Activity Updated"};changeItem.channel="Default";changeItem.channelLabel=flow.flowViewName;return changeItem;},parseMergeAddDelete:function(changeItem,flow){changeItem.propertyDef={};changeItem.propertyDef.propertyName=changeItem.propertyName;changeItem.propertyDef.displayName=changeItem.propertyName;if(!changeItem.propertyName){changeItem.propertyName="";}
if(flow.flowViewName==="Default"){changeItem.channel="Default";}else{changeItem.channel=flow.flowViewName.match(/(.*) \[.*]/);if(changeItem.channel&&changeItem.channel.length===2){changeItem.channel=changeItem.channel[1];}else{changeItem.channel=flow.flowViewName;}}
$j.each(changeItem.nodeProperties,function(pIdx,pItem){if(!pItem.value&&pItem.locale){var rightValue={values:[]};$j.each(pItem.locale,function(idx,lItem){var obj={};if(lItem.localeName==="Default"){obj.locale="!!";}else{obj.locale=lItem.localeName;}
obj.value=lItem.localeValue.rightValue;rightValue.values.push(obj);});pItem.value={rightValue:Ext.util.JSON.encode(rightValue)}}}.bind(this));changeItem.channelLabel=flow.flowViewName;return changeItem;},parseMergeUpdate:function(pItem,changeItem,flow){pItem.propertyDef={};pItem.propertyDef.propertyName=pItem.propertyName;pItem.propertyDef.displayName=pItem.propertyName;pItem.resourceId=changeItem.resourceId;pItem.nodeName=changeItem.nodeName;if(flow.flowViewName==="Default"){pItem.channel="Default"}else{pItem.channel=flow.flowViewName.match(/(.*) \[.*]/);if(pItem.channel&&pItem.channel.length===2){pItem.channel=pItem.channel[1];}else{pItem.channel=flow.flowViewName;}}
pItem.channelLabel=flow.flowViewName;if(pItem.value===null){var clone,propertyDef={};if(pItem.locale){$j.each(pItem.locale,function(lIdx,lItem){clone=$j.extend(true,{},pItem);clone.value={};propertyDef={};clone.value.rightValue=lItem.localeValue.rightValue;if(lItem.localeValue.leftValue===null){clone.value.leftValue="";}else{clone.value.leftValue=lItem.localeValue.leftValue;}
propertyDef.type='locale';propertyDef.propertyName=lItem.localeName;propertyDef.displayName=pItem.propertyName+'-locale['+lItem.localeName+']';clone.propertyDef=propertyDef;pItem=clone});}}else{if(!pItem.value.leftValue){pItem.value.leftValue="";}}
return pItem;},initTabView:function(){this.initSearch();this.initButtons();this.flowNameLabel=new Ext.Panel({autoHeight:false,border:false,bodyStyle:'margin-left:15px; font-size: medium; background-color:transparent',html:'<p><b>Flow</b>: '+this.facade.getJSON().properties.name+'</p>'});this.mergeGrid=new Ext.form.FlowTabGrid({title:ORYX.I18N.Merge.title,facade:this.facade,autoCreate:true,refreshHandler:function(){if(this.currentSearchString){this.sendRequest(this.currentSearchString,this.currentOptions);}}.bind(this),data:this.mergeData,frame:false,iconCls:'icon-grid',tbar:[this.mergeBtn,this.closeBtn,'-',this.searchForm,this.flowNameLabel]});this.addToDock();$j('#mergeToolBarSearchBtn').keyup(this.filterMergeList.bind(this))},initButtons:function(){this.mergeBtn=new Ext.Button({text:ORYX.I18N.Merge.mergeAll,id:'mergeAllBtn',style:'display:inline-block;padding-left:5px',cls:'x-btn-text-icon',icon:ORYX.PATH+"images/silk/information.png",handler:function(){var itemArray=[],isMergeAll=false,btnText;if($j('#mergeAllBtn').text().trim()===ORYX.I18N.Merge.mergeAll){isMergeAll=true;}
this.mergeGrid.data.data.each(function(item){btnText=$j('#mergeBtn-'+item.resourceId+'_'+item.propertyName+' .x-btn-center button').text();if(isMergeAll&&btnText===ORYX.I18N.Merge.revert||!isMergeAll&&(btnText===ORYX.I18N.Merge.name||btnText===ORYX.I18N.Merge.btnAdd||btnText===ORYX.I18N.Merge.btnDelete)){return;}
var property={};property.resourceId=item.resourceId;property.changeType=item.changeCategory;property.propertyName=item.propertyName;property.nodeType=item.nodeType;property.nodeBounds=item.nodeBounds;property.namespace=item.namespace;property.nodeProperties=item.nodeProperties;if(item.value){if(item.value.rightValue){property.oldValue=item.value.rightValue;}
if(item.value.leftValue){property.newValue=item.value.leftValue;}}
if(item.locale){property.locale=item.locale}
property.channel=item.channel;property.propertyDef=item.propertyDef;itemArray.push(property);});if(isMergeAll){ORYX.Plugins.Merge.mergeProperty(itemArray,true,false);}else{ORYX.Plugins.Merge.mergeProperty(itemArray,true,true);}
var mergeAllBtn=$j('#mergeAllBtn .x-btn-center button');if(mergeAllBtn){if($j(mergeAllBtn).text()===ORYX.I18N.Merge.mergeAll){$j(mergeAllBtn).text(ORYX.I18N.Merge.revertAll);}else{$j(mergeAllBtn).text(ORYX.I18N.Merge.mergeAll);}}}.bind(this)});this.closeBtn=new Ext.Button({text:ORYX.I18N.Merge.btnCloseMerge,cls:'x-btn-text-icon',style:'display:inline-block;padding-left:5px',icon:ORYX.PATH+"images/silk/cross.png",handler:function(){var shapes=this.facade.getCanvas().getChildShapes();$j.each(shapes,function(index,shape){$j(shape.node).fadeTo(0,1);});ORYX.Plugins.Merge.removeMergeIconOverlay();this.resourceIdArray=[];this.removeFromDock();}.bind(this)});},initSearch:function(){this.searchInput=new Ext.form.TextField({inputType:'text',id:'mergeToolBarSearchBtn',fieldLabel:ORYX.I18N.Merge.btnSearch,style:'display:inline-block; padding-left:0px',});this.searchForm=new Ext.FormPanel({border:false,style:'padding-top:5px; padding-left:5px',bodyStyle:'padding:5px;display:inline-block;',labelPad:10,labelWidth:40,autoHeight:true,height:'auto',region:'north',items:[this.searchInput]});},addToDock:function(){this.facade.dockToolPanel(this.mergeGrid,true);},removeFromDock:function(){this.facade.removeToolFromPanel(this.mergeGrid);this.mergeGrid.destroy();},filterMergeList:function(){var regEx=new RegExp('^'+$j('#mergeToolBarSearchBtn').val()+'.*','i');this.mergeGrid.store.filterBy(function(item){var match=item.get('nodeName').match(regEx)!=null||item.get('propertyName').match(regEx)||item.get('channel').match(regEx);if(item.get('value').rightValue){match=match||item.get('value').rightValue.match(regEx)}
if(item.get('value').leftValue){match=match||item.get('value').leftValue.match(regEx)}
return match});}});Ext.form.FlowTabGrid=Ext.extend(Ext.grid.GridPanel,{data:null,url:null,flowSwitchDialogTitle:ORYX.I18N.ShapeDetailsGridPanel.FlowSwitchDialog.title,flowSwitchDialogOkButtonText:ORYX.I18N.ShapeDetailsGridPanel.FlowSwitchDialog.ok_btn,flowSwitchDialogCancelButtonText:ORYX.I18N.ShapeDetailsGridPanel.FlowSwitchDialog.cancel_btn,flowSwitchDialogMsg:ORYX.I18N.SyntaxChecker.SyntaxErrorTool.FlowSwitchDialog.message,initComponent:function(){var columns=[],storeCfg;function renderInstall(value,obj,fn,row,col,jsonStore)
{var rowData=jsonStore.data.items[row].data,id=Ext.id();createGridButton.defer(1,this,[id,rowData,jsonStore.data]);return('<div id="'+id+'"></div>');};function createGridButton(id,record,tableData){var text=getMergeButtonText(record.changeCategory);if($j('#'+id).length===0){return}
new Ext.Button({id:"mergeBtn-"+record.resourceId+'_'+record.propertyName,cls:'tableMergeBtn',rowData:record,tableData:tableData,text:text,listeners:{render:function(cmp){cmp.getEl().set({"change-category":this.rowData.changeCategory,});}},handler:function(btn,e){if(btn.text===ORYX.I18N.Merge.btnViewImpl){ORYX.Plugins.ActivityImplEditor.openEditorWindow()
return}
var property={};property.resourceId=this.rowData.resourceId;property.changeType=this.rowData.changeCategory;property.propertyName=this.rowData.propertyName;property.nodeType=this.rowData.nodeType;property.nodeBounds=this.rowData.nodeBounds;property.nodeProperties=this.rowData.nodeProperties;property.newValue=this.rowData.value.leftValue;property.oldValue=this.rowData.value.rightValue;property.channel=this.rowData.channel;property.namespace=this.rowData.namespace;property.propertyDef=this.rowData.propertyDef;if(this.rowData.locale){property.locale=this.rowData.locale}
var btnText=$j('#'+this.id+' .x-btn-center button').text()
if(btnText===ORYX.I18N.Merge.name||btnText===ORYX.I18N.Merge.btnAdd||btnText===ORYX.I18N.Merge.btnDelete){ORYX.Plugins.Merge.mergeProperty(property);}else{ORYX.Plugins.Merge.mergeProperty(property,false,true);}
var resourceIdArray=[],shapes;$j(tableData.items).each(function(idx,item){resourceIdArray.push(item.data.resourceId)}.bind(this));shapes=ORYX.Plugins.Merge.getShapesFromResourceId(resourceIdArray);ORYX.Plugins.Merge.raiseOverlay(shapes);}}).render(document.body,id);};function getMergeButtonText(changeCategory){if(changeCategory==='updated'){return ORYX.I18N.Merge.btnMerge;}else if(changeCategory==='deleted'){return ORYX.I18N.Merge.btnAdd;}else if(changeCategory==='added'){return ORYX.I18N.Merge.btnDelete;}
else if(changeCategory==='implView'){return ORYX.I18N.Merge.btnViewImpl;}};columns.push({header:ORYX.I18N.Merge.btnMerge,dataIndex:'',align:'center',width:75,renderer:renderInstall},{header:ORYX.I18N.Merge.workflowMergeTypeHeader,dataIndex:'changeCategory',align:'center',sortable:true,width:80,renderer:function(value){if(value==="updated"){return'<div class="mergeUpdateIcon" title="Updated" ></div>';}else if(value==="added"){return'<div class="mergeAddedIcon" title="Added" ></div>';}else if(value==="deleted"){return'<div class="mergeDeletedIcon" title="Deleted" ></div>';}}},{id:'nodeName',header:ORYX.I18N.Merge.workflowNameHeader,width:225,sortable:true,dataIndex:'nodeName',renderer:function(value){return Ext.util.Format.htmlEncode(value);}},{id:'propertyDef',header:ORYX.I18N.Merge.workflowPropertyHeader,width:150,sortable:true,dataIndex:'propertyDef',renderer:function(value){return Ext.util.Format.htmlEncode(value.displayName);}},{id:'channelLabel',header:ORYX.I18N.Merge.workflowChannelHeader,width:175,sortable:true,dataIndex:'channelLabel',renderer:function(value){return Ext.util.Format.htmlEncode(value);}},{id:'oldValue',header:ORYX.I18N.Merge.workflowCurrentValueHeader,width:300,sortable:true,dataIndex:'value',renderer:function(value){if(value){return Ext.util.Format.htmlEncode(value.rightValue);}else{return'';}}},{id:'rightValue',header:ORYX.I18N.Merge.workflowCurrentNewValueHeader+" from "+ORYX.Plugins.Merge.getCompareWorkFlowname(),width:300,sortable:true,dataIndex:'value',renderer:function(value){if(value){return Ext.util.Format.htmlEncode(value.leftValue);}else{return'';}}});storeCfg={root:'data',sortInfo:{field:'changeCategory',direction:'DESC'},fields:['',new Ext.data.Field({name:'nodeName',sortType:Ext.data.SortTypes.asUCString}),new Ext.data.Field({name:'propertyName',sortType:Ext.data.SortTypes.asUCString}),new Ext.data.Field({name:'channelLabel',sortType:Ext.data.SortTypes.asUCString}),'value','changeCategory','resourceId','propertyDef','channel','nodeProperties','nodeType','nodeBounds','locale','namespace']};if(this.cm==null){var columns=columns;if(this.autoExpandColumn==null||!this.autoExpandColumn)
this.autoExpandColumn=columns[columns.length-1].id;this.cm=new Ext.grid.ColumnModel(columns);}
if(this.data!=null){Ext.apply(storeCfg,{data:this.data});}else if(this.url!=null){Ext.apply(storeCfg,{url:this.url,autoLoad:true});}
try{var store=new Ext.data.JsonStore(storeCfg);}catch(e){console.log(e)}
var cfg={enableDragDrop:false,enableColumnHide:false,enableColumnMove:false,enableHdMenu:false,store:store,clicksToEdit:1,stripeRows:true};Ext.apply(this,cfg);Ext.form.FlowGrid.superclass.initComponent.call(this);this.on({"rowclick":{fn:function(grid,rowID,e){this.viewRowOnCanvas(rowID);},scope:this}});},viewRowOnCanvas:function(rowidx){var row=this.getStore().getAt(rowidx),rowFlow=row.get("channel");if(row.get('changeCategory')!='updated'){return;}
if(rowFlow!=this.facade.getCurrentFlowView()){this._showFlowSwitchDialog(rowFlow,rowidx,row);}else{var resourceid=row.get("resourceId");if(this.facade.displayShapeInCanvas(resourceid,true)){this.getSelectionModel().selectRow(rowidx);}}},_showFlowSwitchDialog:function(flowToSwitchTo,rowidx,row){Ext.Msg.show(this._getFlowSwitchDialogConfig(flowToSwitchTo,rowidx,row));},_getFlowSwitchDialogConfig:function(flowToSwitchTo,rowidx,row){return{title:this.flowSwitchDialogTitle,msg:this.flowSwitchDialogMsg,buttons:{ok:this.flowSwitchDialogOkButtonText,cancel:this.flowSwitchDialogCancelButtonText},icon:Ext.MessageBox.WARNING,fn:function(btn){if(btn=="ok"){this.facade.setCurrentFlowView(flowToSwitchTo);var resourceid=row.get("resourceId");this.facade.displayShapeInCanvas(resourceid,true);var resourceIdArray=[],shapes;$j(this.data.data).each(function(idx,item){resourceIdArray.push(item.resourceId)}.bind(this));shapes=ORYX.Plugins.Merge.getShapesFromResourceId(resourceIdArray);ORYX.Plugins.Merge.raiseOverlay(shapes);}}.bind(this)};}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.DragDropResize=ORYX.Plugins.AbstractPlugin.extend({construct:function(facade){this.facade=facade;this.currentShapes=[];this.toMoveShapes=[];this.distPoints=[];this.isResizing=false;this.dragEnable=false;this.dragIntialized=false;this.edgesMovable=true;this.offSetPosition={x:0,y:0};this.faktorXY={x:1,y:1};this.containmentParentNode;this.isAddingAllowed=false;this.isAttachingAllowed=false;this.callbackMouseMove=this.handleMouseMove.bind(this);this.callbackMouseUp=this.handleMouseUp.bind(this);var containerNode=this.facade.getCanvas().getSvgContainer();this.selectedRect=new ORYX.Plugins.SelectedRect(containerNode);if(ORYX.CONFIG.SHOW_GRIDLINE){this.vLine=new ORYX.Plugins.GridLine(containerNode,ORYX.Plugins.GridLine.DIR_VERTICAL);this.hLine=new ORYX.Plugins.GridLine(containerNode,ORYX.Plugins.GridLine.DIR_HORIZONTAL);}
containerNode=this.facade.getCanvas().getHTMLContainer();this.scrollNode=this.facade.getCanvas().rootNode.parentNode.parentNode.parentNode;this.resizerSE=new ORYX.Plugins.Resizer(containerNode,"southeast",this.facade);this.resizerSE.registerOnResize(this.onResize.bind(this));this.resizerSE.registerOnResizeEnd(this.onResizeEnd.bind(this));this.resizerSE.registerOnResizeStart(this.onResizeStart.bind(this));this.resizerNW=new ORYX.Plugins.Resizer(containerNode,"northwest",this.facade);this.resizerNW.registerOnResize(this.onResize.bind(this));this.resizerNW.registerOnResizeEnd(this.onResizeEnd.bind(this));this.resizerNW.registerOnResizeStart(this.onResizeStart.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));},handleMouseDown:function(event,uiObj){this.mousedownDelay=new Ext.util.DelayedTask(this.startDrag,this,[event,uiObj]);this.mousedownDelay.delay(200);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.callbackMouseMove,false);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.callbackMouseUp,true);},startDrag:function(event,uiObj){if(this.mousedownDelay!=null){this.mousedownDelay.cancel();this.mousedownDelay=null;}
if(!this.dragBounds||!this.currentShapes.member(uiObj)||!this.toMoveShapes.length){return};this.dragEnable=true;this.dragIntialized=true;this.edgesMovable=true;var a=this.facade.getCanvas().node.getScreenCTM();this.faktorXY.x=a.a;this.faktorXY.y=a.d;var upL=this.dragBounds.upperLeft();this.offSetPosition={x:Event.pointerX(event)-(upL.x*this.faktorXY.x),y:Event.pointerY(event)-(upL.y*this.faktorXY.y)};this.offsetScroll={x:this.scrollNode.scrollLeft,y:this.scrollNode.scrollTop};return;},handleMouseUp:function(event){if(this.mousedownDelay!=null){this.mousedownDelay.cancel();this.mousedownDelay=null;}
this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.contain"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.attached"});if(this.dragEnable){if(!this.dragIntialized){this.afterDrag();if(this.isAttachingAllowed&&this.toMoveShapes.length==1&&this.toMoveShapes[0]instanceof ORYX.Core.Node&&this.toMoveShapes[0].dockers.length>0){var position=this.facade.eventCoordinates(event);var docker=this.toMoveShapes[0].dockers[0];var dockCommand=ORYX.Core.Command.extend({construct:function(docker,position,newDockedShape,facade){this.docker=docker;this.newPosition=position;this.newDockedShape=newDockedShape;this.newParent=newDockedShape.parent||facade.getCanvas();this.oldPosition=docker.parent.bounds.center();this.oldDockedShape=docker.getDockedShape();this.oldParent=docker.parent.parent||facade.getCanvas();this.facade=facade;if(this.oldDockedShape){this.oldPosition=docker.parent.absoluteBounds().center();}},execute:function(){this.dock(this.newDockedShape,this.newParent,this.newPosition);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_ARRANGEMENT_TOP,excludeCommand:true})},rollback:function(){this.dock(this.oldDockedShape,this.oldParent,this.oldPosition);},dock:function(toDockShape,parent,pos){parent.add(this.docker.parent)
this.docker.setDockedShape(undefined);this.docker.bounds.centerMoveTo(pos)
this.docker.setDockedShape(toDockShape);this.facade.setSelection([this.docker.parent]);this.facade.getCanvas().update();this.facade.updateSelection();}});var commands=[new dockCommand(docker,position,this.containmentParentNode,this.facade)];this.facade.executeCommands(commands);}else if(this.isAddingAllowed){this.refreshSelectedShapes();}
this.facade.updateSelection();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_DRAGDROP_END});}
if(this.vLine)
this.vLine.hide();if(this.hLine)
this.hLine.hide();}
this.dragEnable=false;document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.callbackMouseUp,true);document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.callbackMouseMove,false);return;},handleMouseMove:function(event){if(!this.dragEnable){return};if(this.dragIntialized){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_DRAGDROP_START});this.dragIntialized=false;this.resizerSE.hide();this.resizerNW.hide();this._onlyEdges=this.currentShapes.all(function(currentShape){return(currentShape instanceof ORYX.Core.Edge);});this.beforeDrag();this._currentUnderlyingNodes=[];}
var position={x:Event.pointerX(event)-this.offSetPosition.x,y:Event.pointerY(event)-this.offSetPosition.y}
position.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;position.y-=this.offsetScroll.y-this.scrollNode.scrollTop;var modifierKeyPressed=event.shiftKey||event.ctrlKey;if(ORYX.CONFIG.GRID_ENABLED&&!modifierKeyPressed){position=this.snapToGrid(position);}else{if(this.vLine)
this.vLine.hide();if(this.hLine)
this.hLine.hide();}
position.x/=this.faktorXY.x;position.y/=this.faktorXY.y;position.x=Math.max(0,position.x)
position.y=Math.max(0,position.y)
var c=this.facade.getCanvas();position.x=Math.min(c.bounds.width()-this.dragBounds.width(),position.x)
position.y=Math.min(c.bounds.height()-this.dragBounds.height(),position.y)
this.dragBounds.moveTo(position);this.resizeRectangle(this.dragBounds);this.isAttachingAllowed=false;var underlyingNodes=$A(this.facade.getCanvas().getAbstractShapesAtPosition(this.facade.eventCoordinates(event)));var checkIfAttachable=this.toMoveShapes.length==1&&this.toMoveShapes[0]instanceof ORYX.Core.Node&&this.toMoveShapes[0].dockers.length>0
checkIfAttachable=checkIfAttachable&&underlyingNodes.length!=1
if(!checkIfAttachable&&underlyingNodes.length===this._currentUnderlyingNodes.length&&underlyingNodes.all(function(node,index){return this._currentUnderlyingNodes[index]===node}.bind(this))){return}else if(this._onlyEdges){this.isAddingAllowed=true;this.containmentParentNode=this.facade.getCanvas();}else{var options={event:event,underlyingNodes:underlyingNodes,checkIfAttachable:checkIfAttachable};this.checkRules(options);}
this._currentUnderlyingNodes=underlyingNodes.reverse();if(this.isAttachingAllowed){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"dragdropresize.attached",elements:[this.containmentParentNode],style:ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE,color:ORYX.CONFIG.SELECTION_VALID_COLOR});}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.attached"});}
if(!this.isAttachingAllowed){if(this.isAddingAllowed){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"dragdropresize.contain",elements:[this.containmentParentNode],color:ORYX.CONFIG.SELECTION_VALID_COLOR});}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"dragdropresize.contain",elements:[this.containmentParentNode],color:ORYX.CONFIG.SELECTION_INVALID_COLOR});}}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.contain"});}
return;},checkRules:function(options){var event=options.event;var underlyingNodes=options.underlyingNodes;var checkIfAttachable=options.checkIfAttachable;var noEdges=options.noEdges;this.containmentParentNode=underlyingNodes.reverse().find((function(node){return(node instanceof ORYX.Core.Canvas)||(((node instanceof ORYX.Core.Node)||((node instanceof ORYX.Core.Edge)&&!noEdges))&&(!(this.currentShapes.member(node)||this.currentShapes.any(function(shape){return(shape.children.length>0&&shape.getChildNodes(true).member(node));}))));}).bind(this));if(checkIfAttachable){this.isAttachingAllowed=this.facade.getRules().canConnect({sourceShape:this.containmentParentNode,edgeShape:this.toMoveShapes[0],targetShape:this.toMoveShapes[0]});if(this.isAttachingAllowed){var point=this.facade.eventCoordinates(event);this.isAttachingAllowed=this.containmentParentNode.isPointOverOffset(point.x,point.y);}}
if(!this.isAttachingAllowed){this.isAddingAllowed=this.toMoveShapes.all((function(currentShape){if(currentShape instanceof ORYX.Core.Edge||currentShape instanceof ORYX.Core.Controls.Docker||this.containmentParentNode===currentShape.parent){return true;}else if(this.containmentParentNode!==currentShape){if(!(this.containmentParentNode instanceof ORYX.Core.Edge)||!noEdges){if(this.facade.getRules().canContain({containingShape:this.containmentParentNode,containedShape:currentShape})){return true;}}}
return false;}).bind(this));}
if(!this.isAttachingAllowed&&!this.isAddingAllowed&&(this.containmentParentNode instanceof ORYX.Core.Edge)){options.noEdges=true;options.underlyingNodes.reverse();this.checkRules(options);}},refreshSelectedShapes:function(){if(!this.dragBounds){return}
var upL=this.dragBounds.upperLeft();var oldUpL=this.oldDragBounds.upperLeft();var offset={x:upL.x-oldUpL.x,y:upL.y-oldUpL.y};var commands=[new ORYX.Core.Command.Move(this.toMoveShapes,offset,this.containmentParentNode,this.currentShapes,this)];if(this._undockedEdgesCommand instanceof ORYX.Core.Command){commands.unshift(this._undockedEdgesCommand);}
this.facade.executeCommands(commands);if(this.dragBounds)
this.oldDragBounds=this.dragBounds.clone();},onResize:function(bounds){if(!this.dragBounds){return}
this.dragBounds=bounds;this.isResizing=true;this.resizeRectangle(this.dragBounds);},onResizeStart:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_RESIZE_START});},onResizeEnd:function(){if(!(this.currentShapes instanceof Array)||this.currentShapes.length<=0){return;}
if(this.isResizing){var commandClass=ORYX.Core.Command.extend({construct:function(shape,newBounds,plugin){this.shape=shape;this.oldBounds=shape.bounds.clone();this.newBounds=newBounds;this.plugin=plugin;},execute:function(){this.shape.bounds.set(this.newBounds.a,this.newBounds.b);this.update(this.getOffset(this.oldBounds,this.newBounds));},rollback:function(){this.shape.bounds.set(this.oldBounds.a,this.oldBounds.b);this.update(this.getOffset(this.newBounds,this.oldBounds))},getOffset:function(b1,b2){return{x:b2.a.x-b1.a.x,y:b2.a.y-b1.a.y,xs:b2.width()/b1.width(),ys:b2.height()/b1.height()}},update:function(offset){this.shape.getLabels().each(function(label){label.changed();});var allEdges=[].concat(this.shape.getIncomingShapes()).concat(this.shape.getOutgoingShapes()).findAll(function(r){return r instanceof ORYX.Core.Edge}.bind(this))
this.plugin.layoutEdges(this.shape,allEdges,offset);this.plugin.facade.setSelection([this.shape]);this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection();}});var bounds=this.dragBounds.clone();var shape=this.currentShapes[0];if(shape.parent){var parentPosition=shape.parent.absoluteXY();bounds.moveBy(-parentPosition.x,-parentPosition.y);}
var command=new commandClass(shape,bounds,this);this.facade.executeCommands([command]);this.isResizing=false;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_RESIZE_END});}},beforeDrag:function(){var undockEdgeCommand=ORYX.Core.Command.extend({construct:function(moveShapes){this.dockers=moveShapes.collect(function(shape){return shape instanceof ORYX.Core.Controls.Docker?{docker:shape,dockedShape:shape.getDockedShape(),refPoint:shape.referencePoint}:undefined}).compact();},execute:function(){this.dockers.each(function(el){el.docker.setDockedShape(undefined);})},rollback:function(){this.dockers.each(function(el){el.docker.setDockedShape(el.dockedShape);el.docker.setReferencePoint(el.refPoint);})}});this._undockedEdgesCommand=new undockEdgeCommand(this.toMoveShapes);this._undockedEdgesCommand.execute();},hideAllLabels:function(shape){shape.getLabels().each(function(label){label.hide();});shape.getAllDockedShapes().each(function(dockedShape){var labels=dockedShape.getLabels();if(labels.length>0){labels.each(function(label){label.hide();});}});shape.getChildren().each((function(value){if(value instanceof ORYX.Core.Shape)
this.hideAllLabels(value);}).bind(this));},afterDrag:function(){},showAllLabels:function(shape){for(var i=0;i<shape.length;i++){var label=shape[i];label.show();}
var allDockedShapes=shape.getAllDockedShapes()
for(var i=0;i<allDockedShapes.length;i++){var dockedShape=allDockedShapes[i];var labels=dockedShape.getLabels();if(labels.length>0){labels.each(function(label){label.show();});}}
for(var i=0;i<shape.children.length;i++){var value=shape.children[i];if(value instanceof ORYX.Core.Shape)
this.showAllLabels(value);}},onSelectionChanged:function(event){var elements=event.elements;this.dragEnable=false;this.dragIntialized=false;this.resizerSE.hide();this.resizerNW.hide();if(!elements||elements.length==0){this.selectedRect.hide();this.currentShapes=[];this.toMoveShapes=[];this.dragBounds=undefined;this.oldDragBounds=undefined;}else{this.currentShapes=elements;var topLevelElements=this.facade.getCanvas().getShapesWithSharedParent(elements);this.toMoveShapes=topLevelElements;this.toMoveShapes=this.toMoveShapes.findAll(function(shape){return shape instanceof ORYX.Core.Node&&(shape.dockers.length===0||!elements.member(shape.dockers.first().getDockedShape()))});elements.each((function(shape){if(!(shape instanceof ORYX.Core.Edge)){return}
var dks=shape.getDockers()
var hasF=elements.member(dks.first().getDockedShape());var hasL=elements.member(dks.last().getDockedShape());if(!hasF&&!hasL){var isUndocked=!dks.first().getDockedShape()&&!dks.last().getDockedShape()
if(isUndocked){this.toMoveShapes=this.toMoveShapes.concat(dks);}}
if(shape.dockers.length>2&&hasF&&hasL){this.toMoveShapes=this.toMoveShapes.concat(dks.findAll(function(el,index){return index>0&&index<dks.length-1}))}}).bind(this));var newBounds=undefined;this.toMoveShapes.each(function(value){var shape=value;if(value instanceof ORYX.Core.Controls.Docker){shape=value.parent;}
if(!newBounds){newBounds=shape.absoluteBounds();}
else{newBounds.include(shape.absoluteBounds());}}.bind(this));if(!newBounds){elements.each(function(value){if(!newBounds){newBounds=value.absoluteBounds();}else{newBounds.include(value.absoluteBounds());}});}
this.dragBounds=newBounds;this.oldDragBounds=newBounds.clone();this.resizeRectangle(newBounds);this.selectedRect.show();if(this.currentShapes[0].getStencil().idWithoutNs().toLowerCase()==="pool"){this.facade.setSelectedPool(this.selectedRect);}
if(elements.length==1&&elements[0].isResizable){var aspectRatio=elements[0].getStencil().fixedAspectRatio()?elements[0].bounds.width()/elements[0].bounds.height():undefined;this.resizerSE.setBounds(this.dragBounds,elements[0].minimumSize,elements[0].maximumSize,aspectRatio);this.resizerSE.show();this.resizerNW.setBounds(this.dragBounds,elements[0].minimumSize,elements[0].maximumSize,aspectRatio);this.resizerNW.show();}else{this.resizerSE.setBounds(undefined);this.resizerNW.setBounds(undefined);}
if(ORYX.CONFIG.GRID_ENABLED){this.distPoints=[];if(this.distPointTimeout)
window.clearTimeout(this.distPointTimeout)
this.distPointTimeout=window.setTimeout(function(){var distShapes=this.facade.getCanvas().getChildShapes(true).findAll(function(value){var parentShape=value.parent;while(parentShape){if(elements.member(parentShape))return false;parentShape=parentShape.parent}
return true;})
distShapes.each((function(value){if(!(value instanceof ORYX.Core.Edge)){var ul=value.absoluteXY();var width=value.bounds.width();var height=value.bounds.height();this.distPoints.push({ul:{x:ul.x,y:ul.y},c:{x:ul.x+(width/2),y:ul.y+(height/2)},lr:{x:ul.x+width,y:ul.y+height}});}}).bind(this));}.bind(this),10)}}},snapToGrid:function(position){var bounds=this.dragBounds;var point={};var ulThres=6;var cThres=10;var lrThres=6;var scale=this.vLine?this.vLine.getScale():1;var ul={x:(position.x/scale),y:(position.y/scale)};var c={x:(position.x/scale)+(bounds.width()/2),y:(position.y/scale)+(bounds.height()/2)};var lr={x:(position.x/scale)+(bounds.width()),y:(position.y/scale)+(bounds.height())};var offsetX,offsetY;var gridX,gridY;this.distPoints.each(function(value){var x,y,gx,gy;if(Math.abs(value.c.x-c.x)<cThres){x=value.c.x-c.x;gx=value.c.x;}
if(Math.abs(value.c.y-c.y)<cThres){y=value.c.y-c.y;gy=value.c.y;}
if(x!==undefined){offsetX=offsetX===undefined?x:(Math.abs(x)<Math.abs(offsetX)?x:offsetX);if(offsetX===x)
gridX=gx;}
if(y!==undefined){offsetY=offsetY===undefined?y:(Math.abs(y)<Math.abs(offsetY)?y:offsetY);if(offsetY===y)
gridY=gy;}});if(offsetX!==undefined){ul.x+=offsetX;ul.x*=scale;if(this.vLine&&gridX)
this.vLine.update(gridX);}else{ul.x=(position.x-(position.x%(ORYX.CONFIG.GRID_DISTANCE/2)));if(this.vLine)
this.vLine.hide()}
if(offsetY!==undefined){ul.y+=offsetY;ul.y*=scale;if(this.hLine&&gridY)
this.hLine.update(gridY);}else{ul.y=(position.y-(position.y%(ORYX.CONFIG.GRID_DISTANCE/2)));if(this.hLine)
this.hLine.hide();}
return ul;},showGridLine:function(){},resizeRectangle:function(bounds){this.selectedRect.resize(bounds);}});ORYX.Plugins.SelectedRect=Clazz.extend({construct:function(parentId){this.parentId=parentId;this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",$(parentId),['g']);this.dashedArea=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,['rect',{x:0,y:0,'id':'dashedArea','stroke-width':1,stroke:'#777777',fill:'none','fill-opacity':0.0,'stroke-dasharray':'2,2','pointer-events':'none'}]);this.swimlanes=[];this.hide();},hide:function(){this.node.setAttributeNS(null,'display','none');},show:function(){this.node.setAttributeNS(null,'display','');},resize:function(bounds){var upL=bounds.upperLeft();var padding=ORYX.CONFIG.SELECTED_AREA_PADDING;this.dashedArea.setAttributeNS(null,'width',bounds.width()+2*padding);this.dashedArea.setAttributeNS(null,'height',bounds.height()+2*padding);this.node.setAttributeNS(null,'transform',"translate("+(upL.x-padding)+", "+(upL.y-padding)+")");}});ORYX.Plugins.GridLine=Clazz.extend({construct:function(parentId,direction){if(ORYX.Plugins.GridLine.DIR_HORIZONTAL!==direction&&ORYX.Plugins.GridLine.DIR_VERTICAL!==direction){direction=ORYX.Plugins.GridLine.DIR_HORIZONTAL}
this.parent=$(parentId);this.direction=direction;this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parent,['g']);this.line=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,['path',{'stroke-width':1,stroke:'silver',fill:'none','stroke-dasharray':'5,5','pointer-events':'none'}]);this.hide();},hide:function(){this.node.setAttributeNS(null,'display','none');},show:function(){this.node.setAttributeNS(null,'display','');},getScale:function(){try{return this.parent.parentNode.transform.baseVal.getItem(0).matrix.a;}catch(e){return 1;}},update:function(pos){if(this.direction===ORYX.Plugins.GridLine.DIR_HORIZONTAL){var y=pos instanceof Object?pos.y:pos;var cWidth=this.parent.parentNode.parentNode.width.baseVal.value/this.getScale();this.line.setAttributeNS(null,'d','M 0 '+y+' L '+cWidth+' '+y);}else{var x=pos instanceof Object?pos.x:pos;var cHeight=this.parent.parentNode.parentNode.height.baseVal.value/this.getScale();this.line.setAttributeNS(null,'d','M'+x+' 0 L '+x+' '+cHeight);}
this.show();}});ORYX.Plugins.GridLine.DIR_HORIZONTAL="hor";ORYX.Plugins.GridLine.DIR_VERTICAL="ver";ORYX.Plugins.Resizer=Clazz.extend({construct:function(parentId,orientation,facade){this.parentId=parentId;this.orientation=orientation;this.facade=facade;this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",$(this.parentId),['div',{'class':'resizer_'+this.orientation,style:'left:0px; top:0px;'}]);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this),true);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.handleMouseUp.bind(this),true);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.handleMouseMove.bind(this),false);this.dragEnable=false;this.offSetPosition={x:0,y:0};this.bounds=undefined;this.canvasNode=this.facade.getCanvas().node;this.minSize=undefined;this.maxSize=undefined;this.aspectRatio=undefined;this.resizeCallbacks=[];this.resizeStartCallbacks=[];this.resizeEndCallbacks=[];this.hide();this.scrollNode=this.node.parentNode.parentNode.parentNode;},handleMouseDown:function(event){this.dragEnable=true;this.offsetScroll={x:this.scrollNode.scrollLeft,y:this.scrollNode.scrollTop};this.offSetPosition={x:Event.pointerX(event)-this.position.x,y:Event.pointerY(event)-this.position.y};this.resizeStartCallbacks.each((function(value){value(this.bounds);}).bind(this));},handleMouseUp:function(event){this.dragEnable=false;this.containmentParentNode=null;this.resizeEndCallbacks.each((function(value){value(this.bounds);}).bind(this));},handleMouseMove:function(event){if(!this.dragEnable){return}
if(event.shiftKey||event.ctrlKey){this.aspectRatio=this.bounds.width()/this.bounds.height();}else{this.aspectRatio=undefined;}
var position={x:Event.pointerX(event)-this.offSetPosition.x,y:Event.pointerY(event)-this.offSetPosition.y}
position.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;position.y-=this.offsetScroll.y-this.scrollNode.scrollTop;position.x=Math.min(position.x,this.facade.getCanvas().bounds.width())
position.y=Math.min(position.y,this.facade.getCanvas().bounds.height())
var offset={x:position.x-this.position.x,y:position.y-this.position.y}
if(this.aspectRatio){newAspectRatio=(this.bounds.width()+offset.x)/(this.bounds.height()+offset.y);if(newAspectRatio>this.aspectRatio){offset.x=this.aspectRatio*(this.bounds.height()+offset.y)-this.bounds.width();}else if(newAspectRatio<this.aspectRatio){offset.y=(this.bounds.width()+offset.x)/this.aspectRatio-this.bounds.height();}}
if(this.orientation==="northwest"){if(this.bounds.width()-offset.x>this.maxSize.width){offset.x=-(this.maxSize.width-this.bounds.width());if(this.aspectRatio)
offset.y=this.aspectRatio*offset.x;}
if(this.bounds.width()-offset.x<this.minSize.width){offset.x=-(this.minSize.width-this.bounds.width());if(this.aspectRatio)
offset.y=this.aspectRatio*offset.x;}
if(this.bounds.height()-offset.y>this.maxSize.height){offset.y=-(this.maxSize.height-this.bounds.height());if(this.aspectRatio)
offset.x=offset.y/this.aspectRatio;}
if(this.bounds.height()-offset.y<this.minSize.height){offset.y=-(this.minSize.height-this.bounds.height());if(this.aspectRatio)
offset.x=offset.y/this.aspectRatio;}}else{if(this.bounds.width()+offset.x>this.maxSize.width){offset.x=this.maxSize.width-this.bounds.width();if(this.aspectRatio)
offset.y=this.aspectRatio*offset.x;}
if(this.bounds.width()+offset.x<this.minSize.width){offset.x=this.minSize.width-this.bounds.width();if(this.aspectRatio)
offset.y=this.aspectRatio*offset.x;}
if(this.bounds.height()+offset.y>this.maxSize.height){offset.y=this.maxSize.height-this.bounds.height();if(this.aspectRatio)
offset.x=offset.y/this.aspectRatio;}
if(this.bounds.height()+offset.y<this.minSize.height){offset.y=this.minSize.height-this.bounds.height();if(this.aspectRatio)
offset.x=offset.y/this.aspectRatio;}}
if(this.orientation==="northwest"){var oldLR={x:this.bounds.lowerRight().x,y:this.bounds.lowerRight().y};this.bounds.extend({x:-offset.x,y:-offset.y});this.bounds.moveBy(offset);}else{this.bounds.extend(offset);}
this.update();this.resizeCallbacks.each((function(value){value(this.bounds);}).bind(this));Event.stop(event);},registerOnResizeStart:function(callback){if(!this.resizeStartCallbacks.member(callback)){this.resizeStartCallbacks.push(callback);}},unregisterOnResizeStart:function(callback){if(this.resizeStartCallbacks.member(callback)){this.resizeStartCallbacks=this.resizeStartCallbacks.without(callback);}},registerOnResizeEnd:function(callback){if(!this.resizeEndCallbacks.member(callback)){this.resizeEndCallbacks.push(callback);}},unregisterOnResizeEnd:function(callback){if(this.resizeEndCallbacks.member(callback)){this.resizeEndCallbacks=this.resizeEndCallbacks.without(callback);}},registerOnResize:function(callback){if(!this.resizeCallbacks.member(callback)){this.resizeCallbacks.push(callback);}},unregisterOnResize:function(callback){if(this.resizeCallbacks.member(callback)){this.resizeCallbacks=this.resizeCallbacks.without(callback);}},hide:function(){this.node.style.display="none";},show:function(){if(this.bounds)
this.node.style.display="";},setBounds:function(bounds,min,max,aspectRatio){this.bounds=bounds;if(!min)
min={width:ORYX.CONFIG.MINIMUM_SIZE,height:ORYX.CONFIG.MINIMUM_SIZE};if(!max)
max={width:ORYX.CONFIG.MAXIMUM_SIZE,height:ORYX.CONFIG.MAXIMUM_SIZE};this.minSize=min;this.maxSize=max;this.aspectRatio=aspectRatio;this.update();},update:function(){if(!this.bounds){return;}
var upL=this.bounds.upperLeft();if(this.bounds.width()<this.minSize.width){this.bounds.set(upL.x,upL.y,upL.x+this.minSize.width,upL.y+this.bounds.height())};if(this.bounds.height()<this.minSize.height){this.bounds.set(upL.x,upL.y,upL.x+this.bounds.width(),upL.y+this.minSize.height)};if(this.bounds.width()>this.maxSize.width){this.bounds.set(upL.x,upL.y,upL.x+this.maxSize.width,upL.y+this.bounds.height())};if(this.bounds.height()>this.maxSize.height){this.bounds.set(upL.x,upL.y,upL.x+this.bounds.width(),upL.y+this.maxSize.height)};var a=this.canvasNode.getScreenCTM();upL.x*=a.a;upL.y*=a.d;if(this.orientation==="northwest"){upL.x-=13;upL.y-=26;}else{upL.x+=(a.a*this.bounds.width())+3;upL.y+=(a.d*this.bounds.height())+3;}
this.position=upL;this.node.style.left=this.position.x+"px";this.node.style.top=this.position.y+"px";}});ORYX.Core.Command.Move=ORYX.Core.Command.extend({construct:function(moveShapes,offset,parent,selectedShapes,plugin){this.moveShapes=moveShapes;this.selectedShapes=selectedShapes;this.offset=offset;this.plugin=plugin;this.newParents=moveShapes.collect(function(t){return parent||t.parent});this.oldParents=moveShapes.collect(function(shape){return shape.parent});this.dockedNodes=moveShapes.findAll(function(shape){return shape instanceof ORYX.Core.Node&&shape.dockers.length==1}).collect(function(shape){return{docker:shape.dockers[0],dockedShape:shape.dockers[0].getDockedShape(),refPoint:shape.dockers[0].referencePoint}});},execute:function(){this.dockAllShapes()
this.move(this.offset);this.addShapeToParent(this.newParents);this.selectCurrentShapes();this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection();},rollback:function(){var offset={x:-this.offset.x,y:-this.offset.y};this.move(offset);this.addShapeToParent(this.oldParents);this.dockAllShapes(true)
this.selectCurrentShapes();this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection();},move:function(offset,doLayout){for(var i=0;i<this.moveShapes.length;i++){var value=this.moveShapes[i];value.bounds.moveBy(offset);if(value instanceof ORYX.Core.Node){(value.dockers||[]).each(function(d){d.bounds.moveBy(offset);})
var allEdges=[].concat(value.getIncomingShapes()).concat(value.getOutgoingShapes()).findAll(function(r){return r instanceof ORYX.Core.Edge&&!this.moveShapes.any(function(d){return d==r||(d instanceof ORYX.Core.Controls.Docker&&d.parent==r)})}.bind(this)).findAll(function(r){return(r.dockers.first().getDockedShape()==value||!this.moveShapes.include(r.dockers.first().getDockedShape()))&&(r.dockers.last().getDockedShape()==value||!this.moveShapes.include(r.dockers.last().getDockedShape()))}.bind(this))
this.plugin.layoutEdges(value,allEdges,offset);var allSameEdges=[].concat(value.getIncomingShapes()).concat(value.getOutgoingShapes()).findAll(function(r){return r instanceof ORYX.Core.Edge&&r.dockers.first().isDocked()&&r.dockers.last().isDocked()&&!this.moveShapes.include(r)&&!this.moveShapes.any(function(d){return d==r||(d instanceof ORYX.Core.Controls.Docker&&d.parent==r)})}.bind(this)).findAll(function(r){return this.moveShapes.indexOf(r.dockers.first().getDockedShape())>i||this.moveShapes.indexOf(r.dockers.last().getDockedShape())>i}.bind(this))
for(var j=0;j<allSameEdges.length;j++){for(var k=1;k<allSameEdges[j].dockers.length-1;k++){var docker=allSameEdges[j].dockers[k];if(!docker.getDockedShape()&&!this.moveShapes.include(docker)){docker.bounds.moveBy(offset);}}}}}},dockAllShapes:function(shouldDocked){for(var i=0;i<this.dockedNodes.length;i++){var docker=this.dockedNodes[i].docker;docker.setDockedShape(shouldDocked?this.dockedNodes[i].dockedShape:undefined)
if(docker.getDockedShape()){docker.setReferencePoint(this.dockedNodes[i].refPoint);}}},addShapeToParent:function(parents){for(var i=0;i<this.moveShapes.length;i++){var currentShape=this.moveShapes[i];if(currentShape instanceof ORYX.Core.Node&&currentShape.parent!==parents[i]){var unul=parents[i].absoluteXY();var csul=currentShape.absoluteXY();var x=csul.x-unul.x;var y=csul.y-unul.y;parents[i].add(currentShape);currentShape.getOutgoingShapes((function(shape){if(shape instanceof ORYX.Core.Node&&!this.moveShapes.member(shape)){parents[i].add(shape);}}).bind(this));if(currentShape instanceof ORYX.Core.Node&&currentShape.dockers.length==1){var b=currentShape.bounds;x+=b.width()/2;y+=b.height()/2
currentShape.dockers.first().bounds.centerMoveTo(x,y);}else{currentShape.bounds.moveTo(x,y);}}}},selectCurrentShapes:function(){this.plugin.facade.setSelection(this.selectedShapes);}});Ext.namespace("ORYX.Plugins");ORYX.Plugins.MotivePlugin=ORYX.Plugins.AbstractPlugin.extend({construct:function(){this._getAvailableFlows();this._getAvailableWfResolutions();this._getAvailableInteractiveWfModules();this._getAvailableBpFlows();this._getAvailableBpWfModules();this._getAvailableMsgRefs();ORYX.Plugins.MotivePlugin.facade=this.facade;arguments.callee.$.construct.apply(this,arguments);var cfg={'id':'PublishBtn','name':"Publish",'functionality':this.publish.bind(this),'group':ORYX.I18N.File.group,'icon':ORYX.PATH+"images/cog_go.png",'description':"Publish current saved to the runtime environment",'index':2,'toggle':false,'minShape':0,'maxShape':0,'isEnabled':function(){var enabled=false;if(location.hash.slice(1)&&ORYX.Editor.Cookie.getParams().publisher==="true"){enabled=true;}
return enabled;}};this.facade.offer(cfg);ORYX.Plugins.MotivePlugin.PublishButton=cfg;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_STATUS,function(options){if(cfg.isEnabled())
cfg["buttonInstance"].enable();else
cfg["buttonInstance"].disable();}.bind(this));},publish:function(button,pressed){console.log('readonly',this.facade.isReadonly)
if(this.facade.isReadonly){var readonlyInstructionPanel=new Ext.Panel({html:'<p>'+MOTV.I18N.PublishPlugin.readonlyPublishAlert+'</p>',border:false,cls:'publish-alert-msg'});var readonlyWin=new Ext.Window({title:MOTV.I18N.PublishPlugin.alertTitle,iconCls:"publish-alert-window",modal:true,shadow:true,items:[readonlyInstructionPanel],width:640,buttons:[{text:"<b>"+MOTV.I18N.PublishPlugin.button.publishWithoutSave+"</b>",handler:function(){this._doPublish();readonlyWin.destroy();}.bind(this)},{text:MOTV.I18N.PublishPlugin.button.cancel,handler:function(){readonlyWin.destroy();}}]});readonlyWin.show();return;}else if(this.facade.getChangeDifference()>0||this.facade.isAutoSave()){var maxLen=512;var instructionPanel=new Ext.Panel({html:'<p>'+MOTV.I18N.PublishPlugin.unsavedChanges+'</p>'+'<p class="description">'+MOTV.I18N.PublishPlugin.savingDescription+'</p>',border:false,cls:'publish-alert-msg'});var descriptionField=new Ext.form.TextArea({fieldLabel:ORYX.I18N.Save.dialogLabelDesc,width:500,validationDelay:0,validator:function(val){var remainder=maxLen-val.length;var charCountMsg=(remainder>=0)?String.format(MOTV.I18N.PublishPlugin.descriptionCharsRemaining,remainder):String.format(MOTV.I18N.PublishPlugin.descriptionMaxCharsExeeded,Math.abs(remainder));$j('.charCount').html(charCountMsg);if(val.length>maxLen){win.buttons[0].disable();return String.format(MOTV.I18N.PublishPlugin.descriptionMaxCharaters,maxLen);}
win.buttons[0].enable();return true;}});var subTextPanel=new Ext.Panel({bodyCfg:{cls:'x-panel-subtext-body',},border:false,html:'<span class="description">'+String.format(MOTV.I18N.PublishPlugin.descriptionMaxCharaters,maxLen)+'</span>'+'<span class="charCount"></span>'});var formPanel=new Ext.FormPanel({border:false,cls:'publish-alert-msg',items:[descriptionField,subTextPanel]});var win=new Ext.Window({title:MOTV.I18N.PublishPlugin.alertTitle,iconCls:"publish-alert-window",modal:true,shadow:true,items:[instructionPanel,formPanel],width:640,buttons:[{text:"<b>"+MOTV.I18N.PublishPlugin.button.saveAndPublish+"</b>",handler:function(){this._doSaveAndPublish(descriptionField.getValue());win.destroy();}.bind(this)},{text:"<b>"+MOTV.I18N.PublishPlugin.button.publishWithoutSave+"</b>",handler:function(){this._doPublish();win.destroy();}.bind(this)},{text:MOTV.I18N.PublishPlugin.button.cancel,handler:function(){win.destroy();}}]});win.show();return;}
this._doPublish();},_doForcePublish:function(modelId,ignoreParents){this._doPublish(modelId,ignoreParents,true);},_doPublish:function(modelId,ignoreParents,forcePublish){this.model_id=modelId;if(this.model_id==undefined||this.model_id==null)
this.model_id=(location.hash.slice(1).replace(/^\/?/,"").replace(/\/?$/,""))
var publishURL=ORYX.PATH+"poem/"+this.model_id+(forcePublish?"/publish?force=true":"/publish");this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:MOTV.I18N.PublishPlugin.loadingText});if(ignoreParents==undefined||ignoreParents==null||ignoreParents==false)
this.ignoreParentFlows=false;else this.ignoreParentFlows=true;Ext.Ajax.timeout=ORYX.CONFIG.PUBLISH_TIMEOUT;var vers="-1";var activeFlag=true;if(this.ignoreParentFlows==false){if(this.facade.isAutoSave()){vers=this.facade.getOrigContentVersion();activeFlag=false;}else{vers=ORYX.contentVersion;activeFlag=false;}}
Ext.Ajax.request({url:publishURL,method:"POST",encoding:"UTF-8",params:{version:vers,active:activeFlag},scope:this,callback:function(options,isSuccess,response){Ext.Ajax.timeout=ORYX.CONFIG.EXT_AJAX_TIMEOUT;},success:this._onPublishSuccess.bind(this),failure:this._onPublishFailure.bind(this)});},_doSaveAndPublish:function(summary){this.facade.setSavingPromise();ORYX.Plugins.Save.saveForPublish.functionality(true,summary);$j.when(this.facade.getSavingPromise()).done(function(){this._doPublish();}.bind(this));},_doValidate:function(modelId,ignoreParents,forcePublish){this.model_id=modelId;if(this.model_id==undefined||this.model_id==null)
this.model_id=(location.hash.slice(1).replace(/^\/?/,"").replace(/\/?$/,""))
var validateURL=ORYX.CONFIG.SYNTAXCHECKER_URL;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:MOTV.I18N.ValidatePlugin.loadingText});this.ignoreParentFlows=true;Ext.Ajax.timeout=ORYX.CONFIG.PUBLISH_TIMEOUT;var vers="-1";var activeFlag=true;Ext.Ajax.request({url:validateURL,method:"POST",encoding:"UTF-8",params:{version:vers,active:activeFlag,modelId:"/"+this.model_id},scope:this,callback:function(options,isSuccess,response){Ext.Ajax.timeout=ORYX.CONFIG.EXT_AJAX_TIMEOUT;},success:this._onValidateSuccess.bind(this),failure:this._onValidateFailure.bind(this)});},_onPublishFailure:function(response){ORYX.Log.debug("ORYX.Plugins.MotivePlugin._doPublish()::ajax failure, status "+response.status+" "+response.statusText);ORYX.Plugins.MotivePlugin.publishFailureHandler(this,[response,this.ignoreParentFlows,this.model_id,'bld']);},_onPublishSuccess:function(response){this.facade.raiseEvent({type:ORYX.Plugins.MotivePlugin.PUBLISH.PUBLISH_SUCCESS});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE,text:MOTV.I18N.PublishPlugin.publishSuccess});ORYX.Plugins.MotivePlugin.publishSuccessHandler(this,[response,this.ignoreParentFlows,this.model_id,'bld']);},_onValidateFailure:function(response){ORYX.Log.debug("ORYX.Plugins.MotivePlugin._doValidate()::ajax failure, status "+response.status+" "+response.statusText);ORYX.Plugins.MotivePlugin.validateFailureHandler(this,[response,this.ignoreParentFlows,this.model_id,'bld']);},_onValidateSuccess:function(response){this.facade.raiseEvent({type:ORYX.Plugins.MotivePlugin.PUBLISH.PUBLISH_SUCCESS});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE,text:MOTV.I18N.ValidatePlugin.validateSuccess});ORYX.Plugins.MotivePlugin.publishSuccessHandler(this,[response,this.ignoreParentFlows,this.model_id,'bld']);},_getAvailableFlows:function(){if(__availableModels!=null)
ORYX.Plugins.MotivePlugin._AVAILABLE_FLOWS=__availableModels.models;else{ORYX.Plugins.MotivePlugin._AVAILABLE_FLOWS=[];Ext.Ajax.request({url:ORYX.PATH+"poem/queryModels",method:"POST",encoding:"UTF-8",scope:this,success:function(response){var availFlows=Ext.util.JSON.decode(response.responseText);ORYX.Plugins.MotivePlugin._AVAILABLE_FLOWS=availFlows.models;},failure:function(response){}});}},_getAvailableWfResolutions:function(){ORYX.Plugins.MotivePlugin._AVAILABLE_WF_RESOLUTIONS=[];Ext.Ajax.request({url:ORYX.PATH+"poem/queryConfiguration",method:"POST",encoding:"UTF-8",scope:this,success:function(response){if(response.responseText){var availWfRes=Ext.util.JSON.decode(response.responseText);ORYX.Plugins.MotivePlugin._AVAILABLE_WF_RESOLUTIONS=availWfRes.workflow_resolution;}},failure:function(response){}});},_getAvailableInteractiveWfModules:function(){ORYX.Plugins.MotivePlugin._AVAILABLE_INTERACTIVE_WFMODULES=[];Ext.Ajax.request({url:ORYX.PATH+"poem/htProperties?htQueryType=wfList",method:"POST",encoding:"UTF-8",scope:this,success:function(response){if(response.responseText){var availWfModules=Ext.util.JSON.decode(response.responseText);ORYX.Plugins.MotivePlugin._AVAILABLE_INTERACTIVE_WFMODULES=availWfModules.wfModuleList;}},failure:function(response){}});},_getAvailableBpWfModules:function(){ORYX.Plugins.MotivePlugin._AVAILABLE_BP_WFMODULES=[];Ext.Ajax.request({url:ORYX.PATH+"poem/bpfProperties",method:"POST",encoding:"UTF-8",scope:this,success:function(response){if(response.responseText){var availWfModules=Ext.util.JSON.decode(response.responseText);ORYX.Plugins.MotivePlugin._AVAILABLE_BP_WFMODULES=availWfModules.wfModuleList;}},failure:function(response){}});},_getAvailableBpFlows:function(){if(__availableBpModels!=null)
ORYX.Plugins.MotivePlugin._AVAILABLE_BP_FLOWS=__availableBpModels.models;else{ORYX.Plugins.MotivePlugin._AVAILABLE_BP_FLOWS=[];Ext.Ajax.request({url:ORYX.PATH+"poem/callActProperties?callActQueryType=wfList",method:"POST",encoding:"UTF-8",scope:this,success:function(response){if(response.responseText){var availBpFlows=Ext.util.JSON.decode(response.responseText);ORYX.Plugins.MotivePlugin._AVAILABLE_BP_FLOWS=availBpFlows.models;}},failure:function(response){}});}},_getAvailableMsgRefs:function(){ORYX.Plugins.MotivePlugin._AVAILABLE_MSG_REFS=[];Ext.Ajax.request({url:ORYX.PATH+"poem/throwEventProperties?queryType=msgRefList",method:"POST",encoding:"UTF-8",scope:this,success:function(response){if(response.responseText){var availMsgRefs=Ext.util.JSON.decode(response.responseText);ORYX.Plugins.MotivePlugin._AVAILABLE_MSG_REFS=availMsgRefs.messages;}},failure:function(response){}});}});ORYX.Plugins.MotivePlugin.goToItemFunc=function(property){var facade=top_editor;var items=new Hash();var refNodes=ORYX.Plugins.MotivePlugin.getNodesOfType(facade,["reference"]);for(var i=0;i<refNodes.length;i++){items[refNodes[i].resourceId]=new ORYX.Core.StencilSet.PropertyItem({"id":refNodes[i].resourceId,"title":refNodes[i].properties["oryx-name"],"value":refNodes[i].resourceId,},"http://b3mn.org/stencilset/motive1.0#",property);}
return items;}
ORYX.Plugins.MotivePlugin.processTransferItemFunc=function(property){var items=new Hash();var availableFlows=ORYX.Plugins.MotivePlugin.getAvailableFlows();var availableFlows=availableFlows.sort(function(a,b){var x=a.title.toLowerCase();var y=b.title.toLowerCase();return((x<y)?-1:((x>y)?1:0));});for(var i=0;i<availableFlows.length;i++){items[availableFlows[i].value]=new ORYX.Core.StencilSet.PropertyItem({"id":availableFlows[i].value,"title":availableFlows[i].title,"value":availableFlows[i].value,},"http://b3mn.org/stencilset/motive1.0#",property);}
return items;}
ORYX.Plugins.MotivePlugin.wfResolutions=function(property){var items=new Hash();var availableWfRes=ORYX.Plugins.MotivePlugin._AVAILABLE_WF_RESOLUTIONS;var availableWfRes=availableWfRes.sort(function(a,b){var x=a.title.toLowerCase();var y=b.title.toLowerCase();return((x<y)?-1:((x>y)?1:0));});for(var i=0;i<availableWfRes.length;i++){items[availableWfRes[i].value]=new ORYX.Core.StencilSet.PropertyItem({"id":availableWfRes[i].value,"title":availableWfRes[i].title,"value":availableWfRes[i].value,},"http://b3mn.org/stencilset/motive1.0#",property);}
return items;}
ORYX.Plugins.MotivePlugin.interactiveWfModules=function(property){var items=new Hash();var availableWfModules=ORYX.Plugins.MotivePlugin._AVAILABLE_INTERACTIVE_WFMODULES;var availableWfModules=availableWfModules.sort(function(a,b){var x=a.title.toLowerCase();var y=b.title.toLowerCase();return((x<y)?-1:((x>y)?1:0));});for(var i=0;i<availableWfModules.length;i++){items[availableWfModules[i].value]=new ORYX.Core.StencilSet.PropertyItem({"id":availableWfModules[i].value,"title":availableWfModules[i].title,"value":availableWfModules[i].value,},"http://b3mn.org/stencilset/motivebpmn2.0#",property);}
return items;}
ORYX.Plugins.MotivePlugin.bpWfModules=function(property){var items=new Hash();var availableWfModules=ORYX.Plugins.MotivePlugin._AVAILABLE_BP_WFMODULES;var availableWfModules=availableWfModules.sort(function(a,b){var x=a.title.toLowerCase();var y=b.title.toLowerCase();return((x<y)?-1:((x>y)?1:0));});for(var i=0;i<availableWfModules.length;i++){items[availableWfModules[i].value]=new ORYX.Core.StencilSet.PropertyItem({"id":availableWfModules[i].value,"title":availableWfModules[i].title,"value":availableWfModules[i].value,},"http://b3mn.org/stencilset/motive1.0#",property);}
return items;}
ORYX.Plugins.MotivePlugin.callActivityItemFunc=function(property){var items=new Hash();var availableBpFlows=ORYX.Plugins.MotivePlugin.getAvailableBpFlows();var availableBpFlows=availableBpFlows.sort(function(a,b){var x=a.title.toLowerCase();var y=b.title.toLowerCase();return((x<y)?-1:((x>y)?1:0));});for(var i=0;i<availableBpFlows.length;i++){items[availableBpFlows[i].value]=new ORYX.Core.StencilSet.PropertyItem({"id":availableBpFlows[i].value,"title":availableBpFlows[i].title,"value":availableBpFlows[i].value,},"http://b3mn.org/stencilset/motivebpmn2.0#",property);}
return items;}
ORYX.Plugins.MotivePlugin.throwMsgItemFunc=function(property){var items=new Hash();var availableMsgRefs=ORYX.Plugins.MotivePlugin.getAvailableMsgRefs();var availableMsgRefs=availableMsgRefs.sort(function(a,b){var x=a.title.toLowerCase();var y=b.title.toLowerCase();return((x<y)?-1:((x>y)?1:0));});for(var i=0;i<availableMsgRefs.length;i++){items[availableMsgRefs[i].value]=new ORYX.Core.StencilSet.PropertyItem({"id":availableMsgRefs[i].value,"title":availableMsgRefs[i].title,"value":availableMsgRefs[i].value,},"http://b3mn.org/stencilset/motivebpmn2.0#",property);}
return items;}
ORYX.Plugins.MotivePlugin.subflowItemFunc=function(property){var items=new Hash();var availableFlows=ORYX.Plugins.MotivePlugin.getAvailableFlows();var availableFlows=availableFlows.sort(function(a,b){var x=a.title.toLowerCase();var y=b.title.toLowerCase();return((x<y)?-1:((x>y)?1:0));});for(var i=0;i<availableFlows.length;i++){items[availableFlows[i].value]=new ORYX.Core.StencilSet.PropertyItem({"id":availableFlows[i].value,"title":availableFlows[i].title,"value":availableFlows[i].value,},"http://b3mn.org/stencilset/motive1.0#",property);}
return items;}
ORYX.Plugins.MotivePlugin.isSummaryDataVisible=Motive.environment['Workflow.isSummaryDataNameVisible']==='true';ORYX.Plugins.MotivePlugin.getNodesOfType=function(facade,types,nodes){if(nodes==null)
nodes=facade.getCanvas().getChildNodes();var nodesOfType=[];for(var i=0;i<nodes.length;i++){var node=nodes[i];var stencilID=node.getStencil().id();if(node instanceof ORYX.Core.Shape){for(var j=0;j<types.length;j++){if(stencilID.search("#"+types[j])>-1){nodesOfType[nodesOfType.length]=node;}}}
nodesOfType=nodesOfType.concat(ORYX.Plugins.MotivePlugin.getNodesOfType(facade,types,node.getChildNodes()));}
return nodesOfType;};ORYX.Plugins.MotivePlugin.getAvailableFlows=function(){return ORYX.Plugins.MotivePlugin._AVAILABLE_FLOWS;};ORYX.Plugins.MotivePlugin.getAvailableBpFlows=function(){return ORYX.Plugins.MotivePlugin._AVAILABLE_BP_FLOWS;};ORYX.Plugins.MotivePlugin.getAvailableMsgRefs=function(){return ORYX.Plugins.MotivePlugin._AVAILABLE_MSG_REFS;};ORYX.Plugins.MotivePlugin.publishSuccessHandler=function(facade,arguments){return Motive.CommonPublishHandler.success(facade,arguments);};ORYX.Plugins.MotivePlugin.publishFailureHandler=function(facade,arguments){return Motive.CommonPublishHandler.failure(facade,arguments);};ORYX.Plugins.MotivePlugin.validateFailureHandler=function(facade,arguments){return Motive.CommonPublishHandler.validatefailure(facade,arguments);};ORYX.Plugins.MotivePlugin.PUBLISH={};ORYX.Plugins.MotivePlugin.PUBLISH.PUBLISH_SUCCESS="Motive.Publish.publishSuccess";if(!ORYX.Plugins){ORYX.Plugins=new Object();}
ORYX.Plugins.ShapeRepository={facade:undefined,construct:function(facade){this.facade=facade;this._currentParent;this._canContain=undefined;this._canAttach=undefined;this._isPOF=this.facade.isPOF();this.shapeList=new Ext.tree.TreeNode({});this.treeNodeDDConfigs={};this.treeNodeIdRoot="tree-node-";this.soStencilIdRoot="motv-so-";this.soStencilIdPattern=new RegExp("^"+this.soStencilIdRoot);this.treeNodeServiceOpIdPattern=new RegExp("^"+this.treeNodeIdRoot
+this.soStencilIdRoot);ORYX.Plugins.ShapeRepository.disableTreeNodeByShape=this.disableTreeNodeByShape.bind(this);ORYX.Plugins.ShapeRepository.enableTreeNodeByShape=this.enableTreeNodeByShape.bind(this);var panel=new Ext.tree.TreePanel({cls:'shaperepository',loader:new Ext.tree.TreeLoader(),root:this.shapeList,autoScroll:true,rootVisible:false,lines:false,useArrows:false,anchors:'0, -30'});if(this._isPOF){new Ext.tree.TreeSorter(panel,{folderSort:false,dir:"asc"});}
var region=this.facade.addToRegion("west",panel,ORYX.I18N.ShapeRepository.title);var DragZone=new Ext.dd.DragZone(this.shapeList.getUI().getEl(),{shadow:!Ext.isMac});DragZone.afterDragDrop=this.drop.bind(this,DragZone);DragZone.beforeDragOver=this.beforeDragOver.bind(this,DragZone);DragZone.beforeDragEnter=function(){this._lastOverElement=false;return true}.bind(this);if(this.facade.isPOF()){this.setStencilSets();}else{$j.when(ORYX.Plugins.OnlineDocumentation.setServiceOperationList()).done(function(){this.setStencilSets();}.bind(this));}
this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,this.setStencilSets.bind(this));},setStencilSets:function(){var child=this.shapeList.firstChild;while(child){this.shapeList.removeChild(child);child=this.shapeList.firstChild;}
this.facade.getStencilSets().values().each((function(sset){var stencilSetNode
var typeTitle=sset.title();var extensions=sset.extensions();if(extensions&&extensions.size()>0){typeTitle+=" / "
+ORYX.Core.StencilSet.getTranslation(extensions.values()[0],"title");}
this.shapeList.appendChild(stencilSetNode=new Ext.tree.TreeNode({text:typeTitle,allowDrag:false,allowDrop:false,iconCls:'headerShapeRepImg g-stencilset-header-icon',cls:'headerShapeRep g-stencilset-header',singleClickExpand:true}));stencilSetNode.render();stencilSetNode.expand();var stencils=sset.stencils(this.facade.getCanvas().getStencil(),this.facade.getRules());var treeGroups=new Hash();stencils=stencils.sortBy(function(value){return value.position();});stencils.each((function(value){if(stencils.length<=ORYX.CONFIG.MAX_NUM_SHAPES_NO_GROUP){this.createStencilTreeNode(stencilSetNode,value);return;}
var groups=value.groups();groups.each((function(group){if(!treeGroups[group]){treeGroups[group]=new Ext.tree.TreeNode({text:group,allowDrag:false,allowDrop:false,iconCls:'headerShapeRepImg g-stencilset-group-icon',cls:'headerShapeRepChild g-stencilset-group',singleClickExpand:true});stencilSetNode.appendChild(treeGroups[group]);treeGroups[group].render();}
this.createStencilTreeNode(treeGroups[group],value);}).bind(this));if(groups.length==0){this.createStencilTreeNode(stencilSetNode,value);}}).bind(this));}).bind(this));if(this._isPOF&&this.shapeList.firstChild.childNodes.length){var entryGroup=this.shapeList.firstChild.childNodes.find(function(child){return child.text.toLowerCase()==="entry";});var exitGroup=this.shapeList.firstChild.childNodes.find(function(child){return child.text.toLowerCase()==="exit";});if(entryGroup!==undefined){entryGroup.expand();}
if(exitGroup!==undefined){exitGroup.expand();}}else if(this.shapeList.firstChild.firstChild){this.shapeList.firstChild.firstChild.expand(false,true);}
$j(ORYX.Plugins.OnlineDocumentation.getIconClassSelector()).on('click',function(e){var treeNode=$j(e.target).parents('.x-tree-node:first').find('.ShapeRepEntree:first');var subject={name:treeNode.attr('ext:tree-node-id').replace(this.treeNodeServiceOpIdPattern,""),title:$j(e.target).parents('.x-tree-node:first').find('.x-tree-node-anchor').text()};ORYX.Plugins.OnlineDocumentation.show(subject);}.bind(this));$j(ORYX.Plugins.OnlineDocumentation.getIconClassSelector()).on('mouseover',function(e){$j(e.target).parents('.x-tree-node:first').find('.ShapeRepEntree:first').addClass('hover');});$j(ORYX.Plugins.OnlineDocumentation.getIconClassSelector()).on('mouseout',function(e){$j(e.target).parents('.x-tree-node:first').find('.ShapeRepEntree:first').removeClass('hover');});},createStencilTreeNode:function(parentTreeNode,stencil){var domId=stencil.id().replace(/^.+#/,this.treeNodeIdRoot).replace(/[^a-zA-Z0-9 ._-]/g,"");var newElement=new Ext.tree.TreeNode({id:domId,text:stencil.title(),icon:stencil.icon(),allowDrag:false,allowDrop:false,iconCls:'ShapeRepEntreeImg',cls:'ShapeRepEntree'});parentTreeNode.appendChild(newElement);newElement.render();var ui=newElement.getUI();ui.elNode.setAttributeNS(null,"title",stencil.description());var stencilId=stencil.idWithoutNs();if(this.treeNodeServiceOpIdPattern.test(ui.node.id)&&ORYX.Plugins.OnlineDocumentation.hasTitle(stencilId.replace(this.soStencilIdPattern,""))){var buttonBack=$j('<div/>',{class:'buttonBack'});$j(ui.elNode).parent().prepend($j('<i/>',{class:ORYX.Plugins.OnlineDocumentation.getIconClass(),title:ORYX.I18N.ShapeRepository.quickDocumentation}));}
this.treeNodeDDConfigs[newElement.text]={node:ui.node,handles:[ui.elNode,ui.textNode].concat($A(ui.elNode.childNodes)),isHandle:false,type:stencil.id(),namespace:stencil.namespace()}
Ext.dd.Registry.register(ui.elNode,this.treeNodeDDConfigs[newElement.text]);},drop:function(dragZone,target,event){this._lastOverElement=undefined;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:'shapeRepo.added'});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:'shapeRepo.attached'});var proxy=dragZone.getProxy()
if(proxy.dropStatus==proxy.dropNotAllowed){return}
if(!this._currentParent){return}
var option=Ext.dd.Registry.getHandle(target.DDM.currentTarget);var xy=event.getXY();var pos={x:xy[0],y:xy[1]};var a=this.facade.getCanvas().node.getScreenCTM();pos.x-=a.e;pos.y-=a.f;pos.x/=a.a;pos.y/=a.d;pos.x-=document.documentElement.scrollLeft;pos.y-=document.documentElement.scrollTop;var parentAbs=this._currentParent.absoluteXY();pos.x-=parentAbs.x;pos.y-=parentAbs.y;option['position']=pos
if(this._canAttach&&this._currentParent instanceof ORYX.Core.Node){option['parent']=undefined;}else{option['parent']=this._currentParent;}
var commandClass=ORYX.Core.Command.extend({construct:function(option,currentParent,canAttach,position,facade,isPOF,dragNode,treeNodeDDConfigs){this.option=option;this.currentParent=currentParent;this.canAttach=canAttach;this.position=position;this.facade=facade;this.isPOF=isPOF;this.dragNode=dragNode;this.treeNodeDDConfigs=treeNodeDDConfigs;this.selection=this.facade.getSelection();this.shape;this.parent;},execute:function(){if(!this.shape){this.shape=this.facade.createShape(option);this.parent=this.shape.parent;}else{this.parent.add(this.shape);}
if(this.facade.isBPMN4()){ORYX.Plugins.Swimlanes.dropInLane({option:this.option,parent:this.currentParent,shape:this.shape});}
if(this.canAttach&&this.currentParent instanceof ORYX.Core.Node&&this.shape.dockers.length>0){var docker=this.shape.dockers[0];if(this.currentParent.parent instanceof ORYX.Core.Node){this.currentParent.parent.add(docker.parent);}
docker.bounds.centerMoveTo(this.position);docker.setDockedShape(this.currentParent);}
if(this.isPOF){this.dragNode.disable();Ext.dd.Registry.unregister(this.dragNode.ui.elNode);ORYX.Plugins.PropertyWindow.addToActivityOrder([this.shape]);}
this.facade.setSelection([this.shape]);this.facade.getCanvas().update();this.facade.updateSelection();},rollback:function(){this.facade.deleteShape(this.shape);if(this.isPOF){this.dragNode.enable();Ext.dd.Registry.register(this.dragNode.ui.elNode,this.treeNodeDDConfigs[this.dragNode.text]);ORYX.Plugins.PropertyWindow.deleteFromActivityOrder([this.shape]);}
this.facade.setSelection(this.selection.without(this.shape));this.facade.getCanvas().update();this.facade.updateSelection();}});var position=this.facade.eventCoordinates(event.browserEvent);var command=new commandClass(option,this._currentParent,this._canAttach,position,this.facade,this._isPOF,dragZone.dragData.node,this.treeNodeDDConfigs);this.facade.executeCommands([command]);this._currentParent=undefined;},beforeDragOver:function(dragZone,target,event){var coord=this.facade.eventCoordinates(event.browserEvent);var aShapes=this.facade.getCanvas().getAbstractShapesAtPosition(coord);if(aShapes.length<=0){var pr=dragZone.getProxy();pr.setStatus(pr.dropNotAllowed);pr.sync();return false;}
var option=Ext.dd.Registry.getHandle(target.DDM.currentTarget);var stencilSet=this.facade.getStencilSets()[option.namespace];var stencil=stencilSet.stencil(option.type);if(stencil.type()==="node"){var parentCandidate=aShapes.reverse().find(function(candidate){return(candidate instanceof ORYX.Core.Canvas||candidate instanceof ORYX.Core.Node||candidate instanceof ORYX.Core.Edge);});if(parentCandidate!==this._lastOverElement){this._canAttach=undefined;this._canContain=undefined;}
if(parentCandidate){if(!(parentCandidate instanceof ORYX.Core.Canvas)&&parentCandidate.isPointOverOffset(coord.x,coord.y)&&this._canAttach==undefined){this._canAttach=this.facade.getRules().canConnect({sourceShape:parentCandidate,edgeStencil:stencil,targetStencil:stencil});if(this._canAttach){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"shapeRepo.attached",elements:[parentCandidate],style:ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE,color:ORYX.CONFIG.SELECTION_VALID_COLOR});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.added"});this._canContain=undefined;}}
if(!(parentCandidate instanceof ORYX.Core.Canvas)&&!parentCandidate.isPointOverOffset(coord.x,coord.y)){this._canAttach=this._canAttach==false?this._canAttach:undefined;}
if(this._canContain==undefined&&!this._canAttach){this._canContain=this.facade.getRules().canContain({containingShape:parentCandidate,containedStencil:stencil});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:'shapeRepo.added',elements:[parentCandidate],color:this._canContain?ORYX.CONFIG.SELECTION_VALID_COLOR:ORYX.CONFIG.SELECTION_INVALID_COLOR});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.attached"});}
this._currentParent=this._canContain||this._canAttach?parentCandidate:undefined;this._lastOverElement=parentCandidate;var pr=dragZone.getProxy();pr.setStatus(this._currentParent?pr.dropAllowed:pr.dropNotAllowed);pr.sync();}}else{this._currentParent=this.facade.getCanvas();var pr=dragZone.getProxy();pr.setStatus(pr.dropAllowed);pr.sync();}
return false},disableTreeNodeByShape:function(shapes){this.toggleTreeNodeByShape(shapes,false);},enableTreeNodeByShape:function(shapes){this.toggleTreeNodeByShape(shapes,true);},toggleTreeNodeByShape:function(shapes,enable){$j.each(shapes,function(i,shape){var treeNodeDDConfig=this.treeNodeDDConfigs[shape._stencil._jsonStencil.internalName];var dragNode=treeNodeDDConfig.node;if(enable){dragNode.enable();Ext.dd.Registry.register(dragNode.ui.elNode,treeNodeDDConfig);}else{dragNode.disable();Ext.dd.Registry.unregister(dragNode.ui.elNode);}}.bind(this));}}
ORYX.Plugins.ShapeRepository=Clazz.extend(ORYX.Plugins.ShapeRepository);var $j=jQuery.noConflict();if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.ShapeHighlighting=Clazz.extend({construct:function(facade){this.parentNode=facade.getCanvas().getSvgContainer();this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parentNode,['g']);this.highlightNodes={};facade.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,this.setHighlight.bind(this));facade.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,this.hideHighlight.bind(this));},setHighlight:function(options){if(options&&options.highlightId){var node=this.highlightNodes[options.highlightId];if(!node){node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,['path',{"stroke-width":2.0,"fill":"none"}]);this.highlightNodes[options.highlightId]=node;}
if(options.elements&&options.elements.length>0){this.setAttributesByStyle(node,options);this.show(node);}else{this.hide(node);}}},hideHighlight:function(options){if(options&&options.highlightId&&this.highlightNodes[options.highlightId]){this.hide(this.highlightNodes[options.highlightId]);}},hide:function(node){node.setAttributeNS(null,'display','none');},show:function(node){node.setAttributeNS(null,'display','');},setAttributesByStyle:function(node,options){if(options.style&&options.style==ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE){var bo=options.elements[0].absoluteBounds();var strWidth=options.strokewidth?options.strokewidth:ORYX.CONFIG.BORDER_OFFSET
node.setAttributeNS(null,"d",this.getPathRectangle(bo.a,bo.b,strWidth));node.setAttributeNS(null,"stroke",options.color?options.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);node.setAttributeNS(null,"stroke-opacity",options.opacity?options.opacity:0.2);node.setAttributeNS(null,"stroke-width",strWidth);}else if(options.elements.length==1&&options.elements[0]instanceof ORYX.Core.Edge&&options.highlightId!="selection"){node.setAttributeNS(null,"d",this.getPathEdge(options.elements[0].dockers));node.setAttributeNS(null,"stroke",options.color?options.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);node.setAttributeNS(null,"stroke-opacity",options.opacity?options.opacity:0.2);node.setAttributeNS(null,"stroke-width",ORYX.CONFIG.OFFSET_EDGE_BOUNDS);}else{node.setAttributeNS(null,"d",this.getPathByElements(options.elements));node.setAttributeNS(null,"stroke",options.color?options.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);node.setAttributeNS(null,"stroke-opacity",options.opacity?options.opacity:1.0);node.setAttributeNS(null,"stroke-width",options.strokewidth?options.strokewidth:2.0);}},getPathByElements:function(elements){if(!elements||elements.length<=0){return undefined}
var padding=ORYX.CONFIG.SELECTED_AREA_PADDING;var path=""
elements.each((function(element){if(!element){return}
var bounds=element.absoluteBounds();bounds.widen(padding)
var a=bounds.upperLeft();var b=bounds.lowerRight();path=path+this.getPath(a,b);}).bind(this));return path;},getPath:function(a,b){return this.getPathCorners(a,b);},getPathCorners:function(a,b){var size=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var path=""
path=path+"M"+a.x+" "+(a.y+size)+" l0 -"+size+" l"+size+" 0 ";path=path+"M"+a.x+" "+(b.y-size)+" l0 "+size+" l"+size+" 0 ";path=path+"M"+b.x+" "+(b.y-size)+" l0 "+size+" l-"+size+" 0 ";path=path+"M"+b.x+" "+(a.y+size)+" l0 -"+size+" l-"+size+" 0 ";return path;},getPathRectangle:function(a,b,strokeWidth){var size=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var path=""
var offset=strokeWidth/2.0;path=path+"M"+(a.x+offset)+" "+(a.y);path=path+" L"+(a.x+offset)+" "+(b.y-offset);path=path+" L"+(b.x-offset)+" "+(b.y-offset);path=path+" L"+(b.x-offset)+" "+(a.y+offset);path=path+" L"+(a.x+offset)+" "+(a.y+offset);return path;},getPathEdge:function(edgeDockers){var length=edgeDockers.length;var path="M"+edgeDockers[0].bounds.center().x+" "
+edgeDockers[0].bounds.center().y;for(i=1;i<length;i++){var dockerPoint=edgeDockers[i].bounds.center();path=path+" L"+dockerPoint.x+" "+dockerPoint.y;}
return path;}});ORYX.Plugins.HighlightingSelectedShapes=Clazz.extend({construct:function(facade){this.facade=facade;this.opacityFull=0.9;this.opacityLow=0.4;},onSelectionChanged:function(event){if(event.elements&&event.elements.length>1){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:'selection',elements:event.elements.without(event.subSelection),color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:!event.subSelection?this.opacityFull:this.opacityLow});if(event.subSelection){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:'subselection',elements:[event.subSelection],color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:this.opacityFull});}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:'subselection'});}}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:'selection'});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:'subselection'});}}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.MotiveFlowMapping={construct:function(facade){this.facade=facade;var cfg={'name':"Parent Flows",'functionality':this.showParentFlows.bind(this),'group':ORYX.I18N.Save.group,'icon':ORYX.PATH+"images/silk/chart_organisation_child.png",'description':ORYX.I18N.ParentFlow.desc,'index':4,'minShape':0,'maxShape':0,'isEnabled':function(){var enabled=false;if(location.hash.slice(1)){enabled=true;}
return enabled;}};this.facade.offer(cfg);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_STATUS,function(options){if(cfg.isEnabled())
cfg["buttonInstance"].enable();else
cfg["buttonInstance"].disable();}.bind(this));},showParentFlows:function(){Ext.Ajax.request({url:this.getContextURL()+"flowMappings",method:'GET',success:this.buildParentGrid.bind(this),failure:this.showError.bind(this)});},buildParentGrid:function(result,request){var json=Ext.util.JSON.decode(result.responseText);if(json.parents.length<=0){Ext.MessageBox.show({title:ORYX.I18N.ParentFlow.status,msg:ORYX.I18N.ParentFlow.noChildren,buttons:Ext.MessageBox.OK,fn:Ext.MessageBox.hide(),icon:Ext.MessageBox.INFO});}else{this.gridPanel=new Ext.form.FlowMappingGrid({data:json,viewConfig:{forceFit:true},width:600,height:300,frame:false,region:"center",iconCls:'icon-grid'});this.mappingWindow=new Ext.Window({layout:'border',autoCreate:true,title:ORYX.I18N.ParentFlow.title,height:480,width:776,modal:true,collapsible:false,closable:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){this.mappingWindow.hide()}.bind(this)}],items:[this.gridPanel],listeners:{hide:{"fn":function(){},scope:this},show:{fn:function(){},scope:this}},buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){this.mappingWindow.hide();}.bind(this)}]});this.mappingWindow.show();}},getContextURL:function(){if(!location.hash.slice(1)){return null;}
return ORYX.PATH+'poem/'+(location.hash.slice(1).replace(/^\/?/,"").replace(/\/?$/,""))+"/";},showError:function(result,request){Ext.Msg.show({title:ORYX.I18N.ParentFlow.error,msg:ORYX.I18N.ParentFlow.loadError,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}};Ext.form.FlowMappingGrid=Ext.extend(Ext.grid.GridPanel,{allowPublish:false,data:null,url:null,initComponent:function(){if(this.cm==null){var columns=[{id:'flowName',header:ORYX.I18N.ParentFlow.name,width:55,sortable:true,renderer:function(val,metadata,record,rowIndex,colIndex,store){var flowLink=ORYX.PATH+'poem/model/'+record.get("id")+"/self?activeversion=true";return"<a href='"+flowLink+"' target='_blank' style='text-decoration:none;color:black;'>"+Ext.util.Format.htmlEncode(val)+" ("+Ext.util.Format.htmlEncode(record.get("type"))+")"+"</a>";},dataIndex:'name'}];if(this.allowPublish){columns.push({id:"displayname",header:"Display Name",width:150,sortable:false,dataIndex:'displayName',tooltip:"The text to display when referring to this signal to the user.  If not specified then the ID will be displayed to the user",renderer:Ext.util.Format.htmlEncode,editor:new Ext.form.TextField({allowBlank:true,width:150})});}
if(this.autoExpandColumn==null||!this.autoExpandColumn)
this.autoExpandColumn=columns[columns.length-1].id;this.cm=new Ext.grid.ColumnModel(columns);}
var grid=this;var storeCfg={root:'parents',fields:['guid','name','id','type']};if(this.data!=null){Ext.apply(storeCfg,{data:this.data});}else if(this.url!=null){Ext.apply(storeCfg,{url:this.url,autoLoad:true});}
var store=new Ext.data.JsonStore(storeCfg);var cfg={enableDragDrop:false,enableColumnHide:false,enableColumnMove:false,enableHdMenu:false,store:store,clicksToEdit:1,stripeRows:true,selModel:new Ext.grid.RowSelectionModel({singleSelect:true,listeners:{beforerowselect:function(sm,i,ke,row){}}})};Ext.apply(this,cfg);Ext.form.FlowMappingGrid.superclass.initComponent.call(this);}});ORYX.Plugins.MotiveFlowMapping=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.MotiveFlowMapping);if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.Undo=Clazz.extend({facade:undefined,undoStack:[],redoStack:[],construct:function(facade){this.facade=facade;this.facade.offer({name:ORYX.I18N.Undo.undo,description:ORYX.I18N.Undo.undoDesc,icon:ORYX.PATH+"images/arrow_undo.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:90,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.doUndo.bind(this),group:ORYX.I18N.Undo.group,isEnabled:function(){return this.undoStack.length>0}.bind(this),index:0});this.facade.offer({name:ORYX.I18N.Undo.redo,description:ORYX.I18N.Undo.redoDesc,icon:ORYX.PATH+"images/arrow_redo.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:89,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.doRedo.bind(this),group:ORYX.I18N.Undo.group,isEnabled:function(){return this.redoStack.length>0}.bind(this),index:1});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_EXECUTE_COMMANDS,this.handleExecuteCommands.bind(this));},handleExecuteCommands:function(evt){if(!evt.commands){return}
this.undoStack.push(evt.commands);this.redoStack=[];},doUndo:function(){var lastCommands=this.undoStack.pop();if(lastCommands){this.redoStack.push(lastCommands);lastCommands.each(function(command){command.rollback();});}
this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_UNDO_ROLLBACK,commands:lastCommands});if(lastCommands&&(lastCommands[0].rollbackPrevious||(lastCommands[0].moveShapes&&lastCommands[0].plugin.quickTransitionButton))){this.doUndo();}},doRedo:function(){var lastCommands=this.redoStack.pop();if(lastCommands){this.undoStack.push(lastCommands);lastCommands.each(function(command){command.execute();});}
this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_UNDO_EXECUTE,commands:lastCommands});}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.Grouping=Clazz.extend({facade:undefined,construct:function(facade){this.facade=facade;this.facade.offer({'name':ORYX.I18N.Grouping.group,'functionality':this.createGroup.bind(this),'group':ORYX.I18N.Grouping.grouping,'icon':ORYX.PATH+"images/shape_group.png",'description':ORYX.I18N.Grouping.groupDesc,'index':1,'minShape':2,'isEnabled':this.isEnabled.bind(this,false)});this.facade.offer({'name':ORYX.I18N.Grouping.ungroup,'functionality':this.deleteGroup.bind(this),'group':ORYX.I18N.Grouping.grouping,'icon':ORYX.PATH+"images/shape_ungroup.png",'description':ORYX.I18N.Grouping.ungroupDesc,'index':2,'minShape':2,'isEnabled':this.isEnabled.bind(this,true)});this.selectedElements=[];this.groups=[];},isEnabled:function(handles){var selectedEl=this.selectedElements;return handles===this.groups.any(function(group){return group.length===selectedEl.length&&group.all(function(grEl){return selectedEl.member(grEl)})});},onSelectionChanged:function(event){var newSelection=event.elements;this.selectedElements=this.groups.findAll(function(group){return group.any(function(grEl){return newSelection.member(grEl)})});this.selectedElements.push(newSelection)
this.selectedElements=this.selectedElements.flatten().uniq();if(this.selectedElements.length!==newSelection.length){this.facade.setSelection(this.selectedElements);}},createGroup:function(){var selectedElements=this.facade.getSelection();var commandClass=ORYX.Core.Command.extend({construct:function(selectedElements,groups,setGroupsCB,facade){this.selectedElements=selectedElements;this.groups=groups;this.callback=setGroupsCB;this.facade=facade;},execute:function(){var g=this.groups.findAll(function(group){return!group.any(function(grEl){return selectedElements.member(grEl)})});g.push(selectedElements);this.callback(g.clone());this.facade.setSelection(this.selectedElements);},rollback:function(){this.callback(this.groups.clone());this.facade.setSelection(this.selectedElements);}})
var command=new commandClass(selectedElements,this.groups.clone(),this.setGroups.bind(this),this.facade);this.facade.executeCommands([command]);},deleteGroup:function(){var selectedElements=this.facade.getSelection();var commandClass=ORYX.Core.Command.extend({construct:function(selectedElements,groups,setGroupsCB,facade){this.selectedElements=selectedElements;this.groups=groups;this.callback=setGroupsCB;this.facade=facade;},execute:function(){var groupPartition=this.groups.partition(function(group){return group.length!==selectedElements.length||!group.all(function(grEl){return selectedElements.member(grEl)})});this.callback(groupPartition[0]);this.facade.setSelection(this.selectedElements);},rollback:function(){this.callback(this.groups.clone());this.facade.setSelection(this.selectedElements);}})
var command=new commandClass(selectedElements,this.groups.clone(),this.setGroups.bind(this),this.facade);this.facade.executeCommands([command]);},setGroups:function(groups){this.groups=groups;}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.DragDocker=Clazz.extend({construct:function(facade,plugin){this.facade=facade;this.VALIDCOLOR=ORYX.CONFIG.SELECTION_VALID_COLOR;this.INVALIDCOLOR=ORYX.CONFIG.SELECTION_INVALID_COLOR;this.shapeSelection=undefined;this.docker=undefined;this.dockerParent=undefined;this.dockerSource=undefined;this.dockerTarget=undefined;this.lastUIObj=undefined;this.isStartDocker=undefined;this.isEndDocker=undefined;this.undockTreshold=10;this.initialDockerPosition=undefined;this.outerDockerNotMoved=undefined;this.isValid=false;if(plugin){this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOVER,this.handleMouseOver.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOUT,this.handleMouseOut.bind(this));}},handleMouseOut:function(event,uiObj){if(!this.docker&&uiObj instanceof ORYX.Core.Controls.Docker){uiObj.hide()}else if(!this.docker&&uiObj instanceof ORYX.Core.Edge){uiObj.dockers.each(function(docker){docker.hide();})}},handleMouseOver:function(event,uiObj){if(!this.docker&&uiObj instanceof ORYX.Core.Controls.Docker){uiObj.show()}else if(!this.docker&&uiObj instanceof ORYX.Core.Edge){uiObj.dockers.each(function(docker){docker.show();})}},handleMouseDown:function(event,uiObj,noCallback){if(uiObj instanceof ORYX.Core.Controls.Docker&&uiObj.isMovable){this.shapeSelection=this.facade.getSelection();this.facade.setSelection();this.docker=uiObj;this.initialDockerPosition=this.docker.bounds.center();this.outerDockerNotMoved=false;this.dockerParent=uiObj.parent;this._commandArg={docker:uiObj,dockedShape:uiObj.getDockedShape(),refPoint:uiObj.referencePoint||uiObj.bounds.center()};this.docker.show();if(uiObj.parent instanceof ORYX.Core.Edge&&(uiObj.parent.dockers.first()==uiObj||uiObj.parent.dockers.last()==uiObj)){if(uiObj.parent.dockers.first()==uiObj&&uiObj.parent.dockers.last().getDockedShape()){this.dockerTarget=uiObj.parent.dockers.last().getDockedShape()}else if(uiObj.parent.dockers.last()==uiObj&&uiObj.parent.dockers.first().getDockedShape()){this.dockerSource=uiObj.parent.dockers.first().getDockedShape()}}else{this.dockerSource=undefined;this.dockerTarget=undefined;}
this.isStartDocker=this.docker.parent.dockers.first()===this.docker
this.isEndDocker=this.docker.parent.dockers.last()===this.docker
this.facade.getCanvas().add(this.docker.parent);this.docker.parent.getLabels().each(function(label){label.hide();});if((!this.isStartDocker&&!this.isEndDocker)||!this.docker.isDocked()){this.docker.setDockedShape(undefined)
var evPos=this.facade.eventCoordinates(event);this.docker.bounds.centerMoveTo(evPos);this.dockerParent._update();}else{this.outerDockerNotMoved=true;}
var option=noCallback?null:{movedCallback:this.dockerMoved.bind(this),upCallback:this.dockerMovedFinished.bind(this)}
ORYX.Core.UIEnableDrag(event,uiObj,option);}},dockerMoved:function(event){this.outerDockerNotMoved=false;var snapToMagnet=undefined;if(this.docker.parent){if(this.isStartDocker||this.isEndDocker){var evPos=this.facade.eventCoordinates(event);if(this.docker.isDocked()){var distanceDockerPointer=ORYX.Core.Math.getDistancePointToPoint(evPos,this.initialDockerPosition);if(distanceDockerPointer<this.undockTreshold){this.outerDockerNotMoved=true;return;}
this.docker.setDockedShape(undefined)
this.dockerParent._update();}
var shapes=this.facade.getCanvas().getAbstractShapesAtPosition(evPos);var uiObj=shapes.pop();if(this.docker.parent===uiObj){uiObj=shapes.pop();}
if(this.lastUIObj==uiObj){}
else
if(uiObj instanceof ORYX.Core.Shape){var sset=this.docker.parent.getStencil().stencilSet();if(this.docker.parent instanceof ORYX.Core.Edge){var highestParent=this.getHighestParentBeforeCanvas(uiObj);if(highestParent instanceof ORYX.Core.Edge&&this.docker.parent===highestParent){this.isValid=false;this.dockerParent._update();return;}
this.isValid=false;var curObj=uiObj,orgObj=uiObj;while(!this.isValid&&curObj&&!(curObj instanceof ORYX.Core.Canvas)){uiObj=curObj;this.isValid=this.facade.getRules().canConnect({sourceShape:this.dockerSource?this.dockerSource:(this.isStartDocker?uiObj:undefined),edgeShape:this.docker.parent,targetShape:this.dockerTarget?this.dockerTarget:(this.isEndDocker?uiObj:undefined)});curObj=curObj.parent;}
if(!this.isValid){uiObj=orgObj;}}
else{this.isValid=this.facade.getRules().canConnect({sourceShape:uiObj,edgeShape:this.docker.parent,targetShape:this.docker.parent});}
if(this.lastUIObj){this.hideMagnets(this.lastUIObj)}
if(this.isValid){this.showMagnets(uiObj)}
this.showHighlight(uiObj,this.isValid?this.VALIDCOLOR:this.INVALIDCOLOR);this.lastUIObj=uiObj;}
else{this.hideHighlight();this.lastUIObj?this.hideMagnets(this.lastUIObj):null;this.lastUIObj=undefined;this.isValid=false;}
if(this.lastUIObj&&this.isValid&&!(event.shiftKey||event.ctrlKey)){snapToMagnet=this.lastUIObj.magnets.find(function(magnet){return magnet.absoluteBounds().isIncluded(evPos)});if(snapToMagnet){this.docker.bounds.centerMoveTo(snapToMagnet.absoluteCenterXY());}}}}
if(!(event.shiftKey||event.ctrlKey)&&!snapToMagnet){var minOffset=ORYX.CONFIG.DOCKER_SNAP_OFFSET;var nearestX=minOffset+1
var nearestY=minOffset+1
var dockerCenter=this.docker.bounds.center();if(this.docker.parent){this.docker.parent.dockers.each((function(docker){if(this.docker==docker){return};var center=docker.referencePoint?docker.getAbsoluteReferencePoint():docker.bounds.center();nearestX=Math.abs(nearestX)>Math.abs(center.x-dockerCenter.x)?center.x-dockerCenter.x:nearestX;nearestY=Math.abs(nearestY)>Math.abs(center.y-dockerCenter.y)?center.y-dockerCenter.y:nearestY;}).bind(this));if(Math.abs(nearestX)<minOffset||Math.abs(nearestY)<minOffset){nearestX=Math.abs(nearestX)<minOffset?nearestX:0;nearestY=Math.abs(nearestY)<minOffset?nearestY:0;this.docker.bounds.centerMoveTo(dockerCenter.x+nearestX,dockerCenter.y+nearestY);}else{var previous=this.docker.parent.dockers[Math.max(this.docker.parent.dockers.indexOf(this.docker)-1,0)]
var next=this.docker.parent.dockers[Math.min(this.docker.parent.dockers.indexOf(this.docker)+1,this.docker.parent.dockers.length-1)]
if(previous&&next&&previous!==this.docker&&next!==this.docker){var cp=previous.bounds.center();var cn=next.bounds.center();var cd=this.docker.bounds.center();if(ORYX.Core.Math.isPointInLine(cd.x,cd.y,cp.x,cp.y,cn.x,cn.y,10)){var raise=(Number(cn.y)-Number(cp.y))/(Number(cn.x)-Number(cp.x));var intersecX=((cp.y-(cp.x*raise))-(cd.y-(cd.x*(-Math.pow(raise,-1)))))/((-Math.pow(raise,-1))-raise);var intersecY=(cp.y-(cp.x*raise))+(raise*intersecX);if(isNaN(intersecX)||isNaN(intersecY)){return;}
this.docker.bounds.centerMoveTo(intersecX,intersecY);}}}}}
this.dockerParent._update();},dockerMovedFinished:function(event){this.facade.setSelection(this.shapeSelection);this.hideHighlight();this.dockerParent.getLabels().each(function(label){label.show();});if(this.lastUIObj&&(this.isStartDocker||this.isEndDocker)){if(this.isValid){this.docker.setDockedShape(this.lastUIObj);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED,docker:this.docker,parent:this.docker.parent,target:this.lastUIObj});}
this.hideMagnets(this.lastUIObj)}
this.docker.hide();if(this.outerDockerNotMoved){var evPos=this.facade.eventCoordinates(event);var shapes=this.facade.getCanvas().getAbstractShapesAtPosition(evPos);var shapeWithoutEdges=shapes.findAll(function(node){return node instanceof ORYX.Core.Node;});shapes=shapeWithoutEdges.length?shapeWithoutEdges:shapes;this.facade.setSelection(shapes);}else{var dragDockerCommand=ORYX.Core.Command.extend({construct:function(docker,newPos,oldPos,newDockedShape,oldDockedShape,facade){this.docker=docker;this.index=docker.parent.dockers.indexOf(docker);this.newPosition=newPos;this.newDockedShape=newDockedShape;this.oldPosition=oldPos;this.oldDockedShape=oldDockedShape;this.facade=facade;this.index=docker.parent.dockers.indexOf(docker);this.shape=docker.parent;},execute:function(){if(!this.docker.parent){this.docker=this.shape.dockers[this.index];}
this.dock(this.newDockedShape,this.newPosition);this.removedDockers=this.shape.removeUnusedDockers();this.facade.updateSelection();},rollback:function(){this.dock(this.oldDockedShape,this.oldPosition);(this.removedDockers||$H({})).each(function(d){this.shape.add(d.value,Number(d.key));this.shape._update(true);}.bind(this))
this.facade.updateSelection();},dock:function(toDockShape,pos){this.docker.setDockedShape(undefined);if(toDockShape){this.docker.setDockedShape(toDockShape);this.docker.setReferencePoint(pos);}else{this.docker.bounds.centerMoveTo(pos);}
this.facade.getCanvas().update();}});if(this.docker.parent){var newPos=this.docker.getDockedShape()?this.docker.referencePoint:this.docker.bounds.center();var command=new dragDockerCommand(this.docker,newPos,this._commandArg.refPoint,this.docker.getDockedShape(),this._commandArg.dockedShape,this.facade);this.facade.executeCommands([command]);}}
this.docker=undefined;this.dockerParent=undefined;this.dockerSource=undefined;this.dockerTarget=undefined;this.lastUIObj=undefined;},hideHighlight:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:'validDockedShape'});},showHighlight:function(uiObj,color){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:'validDockedShape',elements:[uiObj],color:color});},showMagnets:function(uiObj){uiObj.magnets.each(function(magnet){magnet.show();});},hideMagnets:function(uiObj){uiObj.magnets.each(function(magnet){magnet.hide();});},getHighestParentBeforeCanvas:function(shape){if(!(shape instanceof ORYX.Core.Shape)){return undefined;}
var parent=shape.parent;while(parent&&!(parent.parent instanceof ORYX.Core.Canvas)){parent=parent.parent;}
return parent;}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.MotiveChildFlowMapping={construct:function(facade){this.facade=facade;var cfg={'name':"Dependency View",'functionality':this.showDependentFlows.bind(this),'group':ORYX.I18N.Save.group,'icon':ORYX.PATH+"images/silk/chart_organisation.png",'description':ORYX.I18N.ChildFlow.desc,'index':5,'minShape':0,'maxShape':0,'isEnabled':function(){var enabled=false;if(location.hash.slice(1)){enabled=true;}
return enabled;}};this.facade.offer(cfg);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_STATUS,function(options){if(cfg.isEnabled())
cfg["buttonInstance"].enable();else
cfg["buttonInstance"].disable();}.bind(this));},showDependentFlows:function(){Ext.Ajax.request({url:this.getContextURL()+"childFlowMappings",method:'POST',params:{version:ORYX.contentVersion},success:this.buildTree.bind(this),failure:this.showError.bind(this)});},getChildFlows:function(node){var contextUrl=this.getContextURL();var url=contextUrl.substring(0,contextUrl.indexOf("model/")+6)+node.modelid+"/childFlowMappings";Ext.Ajax.request({url:url,method:'POST',params:{version:node.version},success:this.addTreeBranches.bind(this,node.id),failure:this.showError.bind(this)});},addTreeBranches:function(nodeId,result,request){var jsonData=Ext.util.JSON.decode(result.responseText);var getChildFxn=this.getChildFlows.bind(this);var dumpChildrenFxn=this.dumpChildren.bind(this);var treeNode=this.tree.getNodeById(nodeId);if(jsonData.children.length){for(var i=0;i<jsonData.children.length;i++){var child=jsonData.children[i];var node=new Ext.tree.TreeNode({id:child.id,modelid:child.modelid,version:child.version,text:child.text+" v"+child.version,iconCls:child.iconCls,leaf:false,listeners:{beforeexpand:function(n){if(n.attributes.modelid!=undefined){getChildFxn(n.attributes);}},collapse:function(n){dumpChildrenFxn(n.attributes.id);}}});node.appendChild(new Ext.tree.TreeNode({cls:'hidden'}));if(i==0&&treeNode.childNodes.length>0)
treeNode.replaceChild(node,treeNode.firstChild);else
treeNode.appendChild(node);}}else{if(treeNode&&treeNode.hasChildNodes())
treeNode.removeChild(treeNode.firstChild);Ext.MessageBox.show({title:ORYX.I18N.ChildFlow.Finder.title,msg:String.format(ORYX.I18N.ChildFlow.Finder.emptyMsg,treeNode.text),buttons:Ext.MessageBox.OK,fn:Ext.MessageBox.hide(),icon:Ext.MessageBox.INFO});}},dumpChildren:function(id){var treeNode=this.tree.getNodeById(id);var makeExpandable=treeNode.hasChildNodes();while(treeNode.firstChild){treeNode.removeChild(treeNode.firstChild);}
if(makeExpandable)
treeNode.appendChild(new Ext.tree.TreeNode({cls:'hidden'}));treeNode.collapse();},buildTree:function(result,request){if(result!=null&&result.responseText!=null){var jsonData=Ext.util.JSON.decode(result.responseText);if(jsonData.children!=null&&jsonData.children.length>0){this.root=new Ext.tree.AsyncTreeNode({text:'Root',expandable:true,expanded:true,children:jsonData.children,listeners:{beforeexpand:function(n){for(var i=0;i<n.childNodes.length;i++){var childNode=n.childNodes[i];n.childNodes[i].setText(n.childNodes[i].attributes.text+" v"+n.childNodes[i].attributes.version);}}}});var getChildFxn=this.getChildFlows.bind(this);var dumpChildrenFxn=this.dumpChildren.bind(this);this.tree=new Ext.tree.TreePanel({region:'center',collapsible:false,xtype:'treepanel',animate:true,useArrows:false,autoScroll:true,loader:new Ext.tree.TreeLoader(),root:this.root,rootVisible:false,listeners:{click:function(n){window.open(this.getFlowEditorURL(n.attributes.modelid));}.bind(this),beforeexpandnode:function(n){if(n.attributes.modelid!=undefined){getChildFxn(n.attributes);}},collapsenode:function(n){dumpChildrenFxn(n.attributes.id);}}});this.mappingWindow=new Ext.Window({layout:'border',autoCreate:true,title:ORYX.I18N.ChildFlow.title,height:480,width:776,modal:true,collapsible:false,closable:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){this.mappingWindow.hide()}.bind(this)}],items:[this.tree],listeners:{hide:{"fn":function(){},scope:this},show:{fn:function(){},scope:this}},buttons:[{text:ORYX.I18N.ChildFlow.collapseTree,handler:function(){this.tree.collapseAll();}.bind(this)},{text:ORYX.I18N.PropertyWindow.ok,handler:function(){this.mappingWindow.hide();}.bind(this)}]});this.mappingWindow.show();}else{Ext.MessageBox.show({title:ORYX.I18N.ChildFlow.status,msg:ORYX.I18N.ChildFlow.noChildren,buttons:Ext.MessageBox.OK,fn:Ext.MessageBox.hide(),icon:Ext.MessageBox.INFO});}}else{this.showError(result,request);}},getContextURL:function(){if(!location.hash.slice(1)){return null;}
return ORYX.PATH+'poem/'+(location.hash.slice(1).replace(/^\/?/,"").replace(/\/?$/,""))+"/";},getFlowEditorURL:function(id){return ORYX.PATH+"poem/model/"+id+"/self?activeversion=true";},showError:function(result,request){Ext.Msg.show({title:ORYX.I18N.ChildFlow.error,msg:ORYX.I18N.ChildFlow.loadError,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}};ORYX.Plugins.MotiveChildFlowMapping=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.MotiveChildFlowMapping);Ext.namespace("ORYX.Plugins");ORYX.Plugins.HelpMenu=ORYX.Plugins.AbstractPlugin.extend({construct:function(facade){ORYX.Log.debug("ORYX.Plugins.HelpMenu.construct");this.licenseContent=null;this.facade=facade;arguments.callee.$.construct.apply(this,arguments);var aboutButton={'id':'motv-aboutButton','name':Repository.I18N.HelpMenu.about,'functionality':this._showAbout.bind(this),'group':'Help','icon':ORYX.CONFIG.ROOT_PATH+"favicon.png",'description':Repository.I18N.HelpMenu.about,'index':1,'minShape':0,'isEnabled':function(){return true;}};this.facade.offer(aboutButton);this.aboutButton=aboutButton;var helpButton={'id':'motv-helpButton','name':Repository.I18N.HelpMenu.helpContents,'functionality':this._showHelp.bind(this),'group':'Help','icon':ORYX.CONFIG.ROOT_PATH+"images/silk/help.png",'description':Repository.I18N.HelpMenu.helpContents,'index':2,'minShape':0,'isEnabled':function(){return true;}};this.facade.offer(helpButton);this.helpButton=helpButton;},_showHelp:function(){var url=ORYX.CONFIG.ROOT_PATH+Repository.I18N.HelpMenu.editorHelp;window.open(url,"editorHelp","width=800,height=600,toolbar=no,status=no,menubar=no,location=no");},_showAbout:function(){var url=ORYX.CONFIG.ROOT_PATH+"/commonScripts/help.js";$j.getScript(url).done(function(script,textStatus){_showAbout(ORYX.CONFIG.ROOT_PATH);}).fail(function(jqxhr,settings,exception){$("div.log").text("Triggered ajaxError handler.");});}});Ext.form.EmbeddedListMapField=function(config){Ext.form.EmbeddedListMapField.superclass.constructor.call(this);this.type=config.propertyType;this.allowBlank=config.allowBlank;this.validateFn=config.validateFn;this.dataMap={};this.key=config.key;this.id=config.id;this.index=config.index;this.parent=config.parent;this.facade=config.facade;this.commonColWidth=200;switch(this.type){case'list':this.title="List Editor";this.items=[{id:'listvalue',type:'string'}];this.colConfigs=[{id:'listvalue',dataIndex:'listvalue',header:'Value'}];this.triggerClass='x-form-list-trigger';this.gridRowClassRoot="embedded-list-row-";break;case'map':this.title="Map Editor";this.items=[{id:'mapkey',type:'string'},{id:'mapvalue',type:'string'}];this.colConfigs=[{id:'mapkey',dataIndex:'mapkey',header:'Key'},{id:'mapvalue',dataIndex:'mapvalue',header:'Value'}];this.triggerClass='x-form-map-trigger';this.gridRowClassRoot="embedded-map-row-";break;default:this.title="Editor";this.items=[];this.colConfigs=[];this.triggerClass='x-form-trigger';}
this.setRecordType();};Ext.extend(Ext.form.EmbeddedListMapField,Ext.form.TriggerField,{triggerClass:this.triggerClass,readOnly:true,emptyText:ORYX.I18N.PropertyWindow.clickIcon,setRecordType:function(){this.recordType=[];this.items.each(function(item){this.recordType.push({name:item.id,type:item.type});}.bind(this));},buildValue:function(){var ds=this.grid.getStore();ds.commitChanges();if(ds.getCount()==0){return"";}
var jsonString="[";for(var i=0;i<ds.getCount();i++){var data=ds.getAt(i);jsonString+="{";for(var j=0;j<this.items.length;j++){var key=this.items[j].id;jsonString+=key+':'+(""+data.get(key)).toJSON();if(j<(this.items.length-1)){jsonString+=", ";}}
jsonString+="}";if(i<(ds.getCount()-1)){jsonString+=", ";}}
jsonString+="]";jsonString="{'totalCount':"+ds.getCount().toJSON()+", 'items':"+jsonString+"}";return Object.toJSON(jsonString.evalJSON());},getFieldKey:function(){return this.key;},getRowIndex:function(){var pattern=new RegExp(this.type+'(\\d+)');var matches=pattern.exec($j('.x-grid3-row-selected:first').attr('class'));if(matches){return parseInt(matches[1]);}
return-1;},getSelectedName:function(){return $j('.x-grid3-row-selected:first').find('.x-grid3-td-name').text();},getValue:function(){var value="";var rowIndex=this.getRowIndex();if(rowIndex!==-1){if(this.dataMap[rowIndex]!==undefined&&this.dataMap[rowIndex][this.id]!==undefined){value=this.dataMap[rowIndex][this.id];}else{value=this.parent.dataStore.getAt(rowIndex).get(this.id);this.setDataMapValue(rowIndex,value);}}
return value;},setDataMapValue:function(rowIndex,value){if(this.dataMap[rowIndex]===undefined){this.dataMap[rowIndex]={};}
this.dataMap[rowIndex][this.id]=value;},setValue:function(value){if(value.length>0&&this.data==undefined){this.data=value;}},keydownHandler:function(event){return false;},dialogListeners:{show:function(){this.onFocus();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_KEYDOWN,this.keydownHandler.bind(this));this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);return;},hide:function(){var dl=this.dialogListeners;this.dialog.un("show",dl.show,this);this.dialog.un("hide",dl.hide,this);this.dialog.destroy(true);this.grid.destroy(true);delete this.grid;delete this.dialog;this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_KEYDOWN,this.keydownHandler.bind(this));this.facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);this.fireEvent('dialogClosed',this.data);}},buildInitial:function(){var initial=new Hash();for(var i=0;i<this.items.length;i++){initial[this.items[i].id]='';}
var RecordTemplate=Ext.data.Record.create(this.recordType);return new RecordTemplate(initial);},buildColumnModel:function(){this.rowDeleter=new Ext.form.EmbeddedRowDeleter();this.rowDeleter.setPlugin(this);var cols=[this.rowDeleter];this.colConfigs.each(function(colConfig){cols.push({id:colConfig.id,header:colConfig.header,dataIndex:colConfig.dataIndex,resizable:true,sortable:true,width:this.commonColWidth,editor:new Ext.form.TextField({allowBlank:false,width:this.commonColWidth})});}.bind(this));var cm=new Ext.grid.ColumnModel({columns:cols});return cm;},afterEdit:function(option){option.grid.getStore().commitChanges();},beforeEdit:function(option){this.grid.getColumnModel().getCellEditor(option.column,option.row).enable();},onTriggerClick:function(e){if(this.disabled){return;}
if(!this.dialog){var data=this.getValue();if(data==""){data="{}";}
this.datastore=new Ext.data.Store({proxy:new Ext.data.MemoryProxy(eval("("+data+")")),reader:new Ext.data.JsonReader({root:'items',totalProperty:'totalCount'},this.recordType)});this.datastore.load();var cm=this.buildColumnModel();this.grid=new Ext.grid.EditorGridPanel({store:this.datastore,cm:cm,stripeRows:true,clicksToEdit:1,autoHeight:true,selModel:this.rowDeleter,viewConfig:{forceFit:true,getRowClass:function(record,rowIndex,rowParams,store){return this.gridRowClassRoot+rowIndex;}.bind(this)},listeners:{cellmousedown:function(grid,rowIndex,columnIndex,e){return false;}}});var toolbar=new Ext.Toolbar([{text:ORYX.I18N.PropertyWindow.add,ctCls:'motiveEditorBtnAdd',handler:function(){var ds=this.grid.getStore();var index=ds.getCount();this.grid.stopEditing();var p=this.buildInitial();ds.insert(index,p);ds.commitChanges();this.grid.startEditing(index,0);}.bind(this)}]);var windowTitle=this.title+" | ";switch(this.key){case"oryx-inputparameters":windowTitle+="Input";break;case"oryx-outputparameters":windowTitle+="Output";break;case"oryx-executionlisteners":windowTitle+="Execution Listeners";break;}
windowTitle+=": "+this.getSelectedName();this.dialog=new Ext.Window({autoScroll:true,autoCreate:true,title:windowTitle,height:350,width:cm.getTotalWidth(),maximizable:true,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){this.dialog.hide}.bind(this)}],items:[toolbar,this.grid],bodyStyle:"background-color:#FFFFFF",buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){this.grid.stopEditing();var value=this.buildValue();this.setValue(value);if(this.parent){var row=this.getRowIndex();var store=this.parent.dataStore;this.setDataMapValue(row,value);store.getAt(row).set(this.id,value);store.commitChanges();}
this.dialog.hide();}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.dialog.hide();}.bind(this)}],listeners:{scope:this,maximize:function(window){ORYX.Plugins.PropertyWindow.maximizeEditor(window);},hide:function(){this.parent.validateListRow(this.id,this.getValue().length>0);}}});this.dialog.on(Ext.apply({},this.dialogListeners,{scope:this}));this.dialog.show();this.grid.on('beforeedit',this.beforeEdit,this,true);this.grid.on('afteredit',this.afterEdit,this,true);this.grid.render();}else{this.dialog.show();}}});Ext.form.EmbeddedRowDeleter=Ext.extend(Ext.grid.RowSelectionModel,{width:22,sortable:false,dataIndex:0,menuDisabled:true,fixed:true,id:'deleter',initEvents:function(){Ext.form.EmbeddedRowDeleter.superclass.initEvents.call(this);this.grid.on('cellclick',function(grid,rowIndex,columnIndex,e){var record=grid.getStore().getAt(rowIndex);var mbContent="";var name;switch(this.plugin.type){case"list":name=record.data.listvalue;break;case"map":name=record.data.mapkey;break;default:name="";}
if(columnIndex==grid.getColumnModel().getIndexById('deleter')){mbContent+='Are you sure you want to delete '+name+'?'
Ext.Msg.show({title:'Confirm',msg:mbContent,buttons:Ext.Msg.YESNO,fn:function(btn){if(btn=='yes'){grid.getStore().remove(record);grid.getView().refresh();}}.bind(this),animEl:'elId',icon:Ext.MessageBox.QUESTION});$j('.ext-mb-content').css({float:'left'});}}.bind(this));},renderer:function(v,p,record,rowIndex){return'<img class="extensive-remove" src="images/trash-o.png" title="Delete"/>';},setPlugin:function(plugin){this.plugin=plugin;}});var $j=jQuery.noConflict();Array.prototype.insertFrom=function(from,to){to=Math.max(0,to);from=Math.min(Math.max(0,from),this.length-1);var el=this[from];var old=this.without(el);var newA=old.slice(0,to);newA.push(el);if(old.length>to){newA=newA.concat(old.slice(to))};return newA;}
if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.Arrangement=Clazz.extend({facade:undefined,construct:function(facade){this.facade=facade;this.facade.offer({'name':ORYX.I18N.Arrangement.btf,'functionality':this.setZLevel.bind(this,this.setToTop),'group':ORYX.I18N.Arrangement.groupZ,'icon':ORYX.PATH+"images/shape_move_front.png",'description':ORYX.I18N.Arrangement.btfDesc,'index':1,'minShape':1});this.facade.offer({'name':ORYX.I18N.Arrangement.btb,'functionality':this.setZLevel.bind(this,this.setToBack),'group':ORYX.I18N.Arrangement.groupZ,'icon':ORYX.PATH+"images/shape_move_back.png",'description':ORYX.I18N.Arrangement.btbDesc,'index':2,'minShape':1});this.facade.offer({'name':ORYX.I18N.Arrangement.bf,'functionality':this.setZLevel.bind(this,this.setForward),'group':ORYX.I18N.Arrangement.groupZ,'icon':ORYX.PATH+"images/shape_move_forwards.png",'description':ORYX.I18N.Arrangement.bfDesc,'index':3,'minShape':1});this.facade.offer({'name':ORYX.I18N.Arrangement.bb,'functionality':this.setZLevel.bind(this,this.setBackward),'group':ORYX.I18N.Arrangement.groupZ,'icon':ORYX.PATH+"images/shape_move_backwards.png",'description':ORYX.I18N.Arrangement.bbDesc,'index':4,'minShape':1});this.facade.offer({'name':ORYX.I18N.Arrangement.ab,'functionality':this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_BOTTOM]),'group':ORYX.I18N.Arrangement.groupA,'icon':ORYX.PATH+"images/shape_align_bottom.png",'description':ORYX.I18N.Arrangement.abDesc,'index':1,'minShape':2});this.facade.offer({'name':ORYX.I18N.Arrangement.am,'functionality':this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_MIDDLE]),'group':ORYX.I18N.Arrangement.groupA,'icon':ORYX.PATH+"images/shape_align_middle.png",'description':ORYX.I18N.Arrangement.amDesc,'index':2,'minShape':2});this.facade.offer({'name':ORYX.I18N.Arrangement.at,'functionality':this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_TOP]),'group':ORYX.I18N.Arrangement.groupA,'icon':ORYX.PATH+"images/shape_align_top.png",'description':ORYX.I18N.Arrangement.atDesc,'index':3,'minShape':2});this.facade.offer({'name':ORYX.I18N.Arrangement.al,'functionality':this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_LEFT]),'group':ORYX.I18N.Arrangement.groupA,'icon':ORYX.PATH+"images/shape_align_left.png",'description':ORYX.I18N.Arrangement.alDesc,'index':4,'minShape':2});this.facade.offer({'name':ORYX.I18N.Arrangement.ac,'functionality':this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_CENTER]),'group':ORYX.I18N.Arrangement.groupA,'icon':ORYX.PATH+"images/shape_align_center.png",'description':ORYX.I18N.Arrangement.acDesc,'index':5,'minShape':2});this.facade.offer({'name':ORYX.I18N.Arrangement.ar,'functionality':this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_RIGHT]),'group':ORYX.I18N.Arrangement.groupA,'icon':ORYX.PATH+"images/shape_align_right.png",'description':ORYX.I18N.Arrangement.arDesc,'index':6,'minShape':2});this.facade.offer({'name':ORYX.I18N.Arrangement.as,'functionality':this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_SIZE]),'group':ORYX.I18N.Arrangement.groupA,'icon':ORYX.PATH+"images/shape_align_size.png",'description':ORYX.I18N.Arrangement.asDesc,'index':7,'minShape':2});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_TOP,this.setZLevel.bind(this,this.setToTop));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_BACK,this.setZLevel.bind(this,this.setToBack));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_FORWARD,this.setZLevel.bind(this,this.setForward));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_BACKWARD,this.setZLevel.bind(this,this.setBackward));},setZLevel:function(callback,event){var zLevelCommand=ORYX.Core.Command.extend({construct:function(callback,elements,facade){this.callback=callback;this.elements=elements;this.elAndIndex=elements.map(function(el){return{el:el,previous:el.parent.children[el.parent.children.indexOf(el)-1]}})
this.facade=facade;},execute:function(){this.callback(this.elements)
this.facade.setSelection(this.elements)},rollback:function(){var sortedEl=this.elAndIndex.sortBy(function(el){var value=el.el;var t=$A(value.node.parentNode.childNodes);return t.indexOf(value.node);});for(var i=0;i<sortedEl.length;i++){var el=sortedEl[i].el;var p=el.parent;var oldIndex=p.children.indexOf(el);var newIndex=p.children.indexOf(sortedEl[i].previous);newIndex=newIndex||0
p.children=p.children.insertFrom(oldIndex,newIndex)
el.node.parentNode.insertBefore(el.node,el.node.parentNode.childNodes[newIndex+1]);}
this.facade.setSelection(this.elements)}});var command=new zLevelCommand(callback,this.facade.getSelection(),this.facade);if(event.excludeCommand){command.execute();}else{this.facade.executeCommands([command]);}},setToTop:function(elements){var tmpElem=elements.sortBy(function(value,index){var t=$A(value.node.parentNode.childNodes);return t.indexOf(value.node);});tmpElem.each(function(value){var p=value.parent
p.children=p.children.without(value)
p.children.push(value);value.node.parentNode.appendChild(value.node);});},setToBack:function(elements){var tmpElem=elements.sortBy(function(value,index){var t=$A(value.node.parentNode.childNodes);return t.indexOf(value.node);});tmpElem=tmpElem.reverse();tmpElem.each(function(value){var p=value.parent
p.children=p.children.without(value)
p.children.unshift(value);value.node.parentNode.insertBefore(value.node,value.node.parentNode.firstChild);});},setBackward:function(elements){var tmpElem=elements.sortBy(function(value,index){var t=$A(value.node.parentNode.childNodes);return t.indexOf(value.node);});tmpElem=tmpElem.reverse();var compactElem=tmpElem.findAll(function(el){return!tmpElem.some(function(checkedEl){return checkedEl.node==el.node.previousSibling})});compactElem.each(function(el){if(el.node.previousSibling===null){return;}
var p=el.parent;var index=p.children.indexOf(el);p.children=p.children.insertFrom(index,index-1)
el.node.parentNode.insertBefore(el.node,el.node.previousSibling);});},setForward:function(elements){var tmpElem=elements.sortBy(function(value,index){var t=$A(value.node.parentNode.childNodes);return t.indexOf(value.node);});var compactElem=tmpElem.findAll(function(el){return!tmpElem.some(function(checkedEl){return checkedEl.node==el.node.nextSibling})});compactElem.each(function(el){var nextNode=el.node.nextSibling
if(nextNode===null){return;}
var index=el.parent.children.indexOf(el);var p=el.parent;p.children=p.children.insertFrom(index,index+1)
el.node.parentNode.insertBefore(nextNode,el.node);});},alignShapes:function(way){var elements=this.facade.getSelection();elements=this.facade.getCanvas().getShapesWithSharedParent(elements);elements=elements.findAll(function(value){return(value instanceof ORYX.Core.Node)});elements=elements.findAll(function(value){var d=value.getIncomingShapes()
return d.length==0||!elements.include(d[0])});if(elements.length<2){return;}
var bounds=elements[0].absoluteBounds().clone();elements.each(function(shape){bounds.include(shape.absoluteBounds().clone());});var maxWidth=0;var maxHeight=0;elements.each(function(shape){maxWidth=Math.max(shape.bounds.width(),maxWidth);maxHeight=Math.max(shape.bounds.height(),maxHeight);});var commandClass=ORYX.Core.Command.extend({construct:function(elements,bounds,maxHeight,maxWidth,way,facade){this.elements=elements;this.bounds=bounds;this.maxHeight=maxHeight;this.maxWidth=maxWidth;this.way=way;this.facade=facade;this.orgPos=[];},setBounds:function(shape,maxSize){if(!maxSize)
maxSize={width:ORYX.CONFIG.MAXIMUM_SIZE,height:ORYX.CONFIG.MAXIMUM_SIZE};if(!shape.bounds){throw"Bounds not definined."}
var newBounds={a:{x:shape.bounds.upperLeft().x-(this.maxWidth-shape.bounds.width())/2,y:shape.bounds.upperLeft().y-(this.maxHeight-shape.bounds.height())/2},b:{x:shape.bounds.lowerRight().x+(this.maxWidth-shape.bounds.width())/2,y:shape.bounds.lowerRight().y+(this.maxHeight-shape.bounds.height())/2}}
if(this.maxWidth>maxSize.width){newBounds.a.x=shape.bounds.upperLeft().x-
(maxSize.width-shape.bounds.width())/2;newBounds.b.x=shape.bounds.lowerRight().x+(maxSize.width-shape.bounds.width())/2}
if(this.maxHeight>maxSize.height){newBounds.a.y=shape.bounds.upperLeft().y-
(maxSize.height-shape.bounds.height())/2;newBounds.b.y=shape.bounds.lowerRight().y+(maxSize.height-shape.bounds.height())/2}
shape.bounds.set(newBounds);},execute:function(){this.elements.each(function(shape,index){this.orgPos[index]=shape.bounds.upperLeft();var relBounds=this.bounds.clone();if(shape.parent&&!(shape.parent instanceof ORYX.Core.Canvas)){var upL=shape.parent.absoluteBounds().upperLeft();relBounds.moveBy(-upL.x,-upL.y);}
switch(this.way){case ORYX.CONFIG.EDITOR_ALIGN_BOTTOM:shape.bounds.moveTo({x:shape.bounds.upperLeft().x,y:relBounds.b.y-shape.bounds.height()});break;case ORYX.CONFIG.EDITOR_ALIGN_MIDDLE:shape.bounds.moveTo({x:shape.bounds.upperLeft().x,y:(relBounds.a.y+relBounds.b.y-shape.bounds.height())/2});break;case ORYX.CONFIG.EDITOR_ALIGN_TOP:shape.bounds.moveTo({x:shape.bounds.upperLeft().x,y:relBounds.a.y});break;case ORYX.CONFIG.EDITOR_ALIGN_LEFT:shape.bounds.moveTo({x:relBounds.a.x,y:shape.bounds.upperLeft().y});break;case ORYX.CONFIG.EDITOR_ALIGN_CENTER:shape.bounds.moveTo({x:(relBounds.a.x+relBounds.b.x-shape.bounds.width())/2,y:shape.bounds.upperLeft().y});break;case ORYX.CONFIG.EDITOR_ALIGN_RIGHT:shape.bounds.moveTo({x:relBounds.b.x-shape.bounds.width(),y:shape.bounds.upperLeft().y});break;case ORYX.CONFIG.EDITOR_ALIGN_SIZE:if(shape.isResizable){this.orgPos[index]={a:shape.bounds.upperLeft(),b:shape.bounds.lowerRight()};this.setBounds(shape,shape.maximumSize);}
break;}}.bind(this));this.facade.getCanvas().update();this.facade.updateSelection();},rollback:function(){this.elements.each(function(shape,index){if(this.way==ORYX.CONFIG.EDITOR_ALIGN_SIZE){if(shape.isResizable){shape.bounds.set(this.orgPos[index]);}}else{shape.bounds.moveTo(this.orgPos[index]);}}.bind(this));this.facade.getCanvas().update();this.facade.updateSelection();}})
var command=new commandClass(elements,bounds,maxHeight,maxWidth,parseInt(way),this.facade);this.facade.executeCommands([command]);}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}
ORYX.Plugins.PropertyWindow={facade:undefined,construct:function(facade){this.facade=facade;this.channel=null;this.localizedValues=null;this.selectedChannelByFlowView=new Hash();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHOW_PROPERTYWINDOW,this.init.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.selectDiagram.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_FLOW_VIEW_CHANGE,this.rebuildFilter.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_FLOW_VIEW_UPDATE,this.resetFilter.bind(this));this.init();},init:function(){ORYX.Log.debug("PropertyWindow.init");this.facade.getChannels();this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",null,['div']);this.currentDateFormat;this.popularProperties=[];this.properties=[];this.propertyGroups={};this.formFields={};this.auxiliaryPropertyButtonsHash={};this.workflowNameComboBoxDisabledValue=false;this.shapeSelection=new Hash();this.shapeSelection.shapes=new Array();this.shapeSelection.commonProperties=new Array();this.shapeSelection.commonPropertiesValues=new Hash();this.shapeSelection.hierarchicalProperties=new Array();this.updaterFlag=false;this.hierarchyIdChainDelimiter="!!";this.hierarchyDataRootArray=new Array();this.hierarchyDataRootArray[0]="items";this.hierarchyMultiListRestUrlRoot="/wfe/rest/7.0/multilist/";this.columnModel=new Ext.grid.ColumnModel([{header:ORYX.I18N.PropertyWindow.name,dataIndex:'name',width:90,sortable:true,renderer:this.tooltipRenderer.bind(this)},{header:ORYX.I18N.PropertyWindow.value,dataIndex:'value',id:'propertywindow_column_value',width:110,editor:new Ext.form.TextField({allowBlank:false}),renderer:this.renderer.bind(this)},{header:"Pop",dataIndex:'popular',hidden:true,sortable:true},{header:"Channel",dataIndex:'channel',hidden:true,sortable:true}]);this.dataSource=new Ext.data.GroupingStore({proxy:new Ext.data.MemoryProxy(this.properties),reader:new Ext.data.ArrayReader({},[{name:'channel'},{name:'groupPriority'},{name:'popular'},{name:'name'},{name:'value'},{name:'icons'},{name:'gridProperties'}]),sortInfo:{field:'name',direction:"ASC"},sortData:function(f,direction){direction=direction||'ASC';var st=this.fields.get(f).sortType;var fn=function(r1,r2){var v1=st(r1.data[f]),v2=st(r2.data[f]);var p1=r1.data['name'],p2=r2.data['name'];var gp1=r1.data['groupPriority'],gp2=r2.data['groupPriority'];if((gp1-gp2)!=0){return gp1-gp2;}else{return p1&&!p2?-1:(!p1&&p2?1:(v1>v2?1:(v1<v2?-1:0)));}};this.data.sort(direction,fn);if(this.snapshot&&this.snapshot!=this.data){this.snapshot.sort(direction,fn);}},groupField:'channel'});this.dataSource.load();ORYX.Plugins.PropertyWindow.facade=this.facade;ORYX.Plugins.PropertyWindow.dataSource=this.dataSource;ORYX.Plugins.PropertyWindow.selectedTestModule=null;ORYX.Plugins.PropertyWindow.maximizeEditor=this.maximizeEditor.bind(this);ORYX.Plugins.PropertyWindow.scrollGridBottom=this.scrollGridBottom.bind(this);ORYX.Plugins.PropertyWindow.addToActivityOrder=this.addToActivityOrder.bind(this);ORYX.Plugins.PropertyWindow.deleteFromActivityOrder=this.deleteFromActivityOrder.bind(this);ORYX.Plugins.PropertyWindow.isPofActivity=this.isPofActivity.bind(this);ORYX.Plugins.PropertyWindow.propertyGroups=this.propertyGroups;this.groupingView=new Ext.grid.GroupingView({forceFit:true,groupTextTpl:'{[(values.rs.first().data.channel !== "") ? ORYX.Plugins.PropertyWindow.groupTextFunction(values.rs.first().data.channel) : ORYX.I18N.PropertyWindow.oftenUsed]}'});this.channel=this.getInitialChannel();var channelMenuButtonItems=this.getChannelFilterList();this.channelMenuButton=new Ext.menu.Menu({id:"channelMenuButton",items:channelMenuButtonItems});var loadedStencilSetsNamespaces=this.facade.getStencilSets().keys();if(loadedStencilSetsNamespaces[0].substr(loadedStencilSetsNamespaces[0].lastIndexOf('/')+1)===ORYX.CONFIG.INTERACTIVE_FLOW_STENCIL_NS)
var showChannels=true;var toolbar={id:"channelMenuButtonInstance",text:ORYX.I18N.PropertyWindow.channel.filterButtonDefaultText,menu:this.channelMenuButton,iconCls:"channel-menu-icon",disabled:channelMenuButtonItems.length===0};var toolbarArr=showChannels?[toolbar]:[];this.grid=new Ext.grid.EditorGridPanel({id:"oryx-editor-grid",clicksToEdit:1,stripeRows:true,autoExpandColumn:"propertywindow_column_value",width:'auto',colModel:this.columnModel,enableHdMenu:false,view:this.groupingView,propertyWindow:this,store:this.dataSource,xtype:"editorgrid",tbar:toolbarArr});region=this.facade.addToRegion('east',new Ext.Panel({width:220,layout:"fit",border:false,items:[this.grid]}),ORYX.I18N.PropertyWindow.title);this.grid.on('beforeedit',this.beforeEdit,this,true);this.grid.on('afteredit',this.afterEdit,this,true);this.grid.view.on('refresh',this.hideMoreAttrs,this,true);this.grid.enableColumnMove=false;this.facade.setPropertyWindow(this);this.applyChannelFilter();this.selectedChannelByFlowView[this.facade.getCurrentFlowView()]=this.getChannel();this.comboboxStore=null;},applyChannelFilter:function(){ORYX.Log.debug("applyChannelFilter::begin");var channel=this.getChannel();var channelsToDisplay=[channel];for(var key in this.propertyGroups){channelsToDisplay.push(this.propertyGroups[key].label);}
var channelMeta=null;if(channel){channelMeta=this.facade.getChannelMetaData(channel);}
this.dataSource.filterBy(function(rec,id){var ch=rec.get("channel");if(ch===""||channelsToDisplay.findIndex(function(ctd){return ctd===ch;})!==-1){return true;}
return false;});this.showAuxiliaryPropertyButtons();this.trimHMLTitles();var channelMenuButton=Ext.getCmp("channelMenuButtonInstance");if(channelMenuButton!==undefined){if(channelMeta){channelMenuButton.setText(String.format(ORYX.I18N.PropertyWindow.channel.filterButtonText,channelMeta.name));}else{channelMenuButton.setText(ORYX.I18N.PropertyWindow.channel.filterButtonDefaultText);}}
ORYX.Log.debug("applyChannelFilter::filter applied for channel: "+channel);},onChannelSelected:function(item,checked){ORYX.Log.debug("onChannelSelected::begin");if(checked){var channelId=item.getId().replace("propertywindow-channel-","");var _oldChannel=this.getChannel();var firstShape=this.shapeSelection.shapes.first();this.selectedChannelByFlowView[this.facade.getCurrentFlowView()]=channelId;this.setChannel(channelId);if(firstShape.getStencil().hasHierarchicalProperties){this.identifyCommonProperties();this.setCommonPropertiesValues();this.createPropertiesAndApplyChannelFilter();}else{this.applyChannelFilter();}
this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_CHANNEL_CHANGED,oldChannel:_oldChannel,newChannel:channelId});}},getInitialChannel:function(){var initialChannel="desktop";var groupItems=this.facade.getCurrentFlowViewGroupItems();if(groupItems.length===0){initialChannel=null;}else if(groupItems.indexOf(initialChannel)===-1){initialChannel=groupItems[0];}
return initialChannel;},getChannel:function(){return this.channel;},setChannel:function(channel){this.channel=channel;},getFormFieldInformation:function(formId){return this.formFields[formId];},setFormFieldInformation:function(formId,extId){this.formFields[formId]=extId;},getWorkflowNameComboBoxDisabledValue:function(){return this.workflowNameComboBoxDisabledValue;},setWorkflowNameComboBoxDisabledValue:function(value){this.workflowNameComboBoxDisabledValue=value;},rebuildFilter:function(){var menu=this.channelMenuButton;menu.removeAll();var channelFilterList=this.getChannelFilterList();var channelMenuButtonCmp=Ext.getCmp("channelMenuButtonInstance");if(channelFilterList.length===0){channelMenuButtonCmp.setText(ORYX.I18N.PropertyWindow.channel.filterButtonDefaultText);channelMenuButtonCmp.disable();this.setChannel(null);return;}else{channelMenuButtonCmp.enable();}
var hasChecked=false;Ext.each(channelFilterList,function(channelMenuButtonItem){if(channelMenuButtonItem.checked){hasChecked=true;}
menu.add(channelMenuButtonItem);});if(!hasChecked&&channelFilterList.length>0){var selectedChannel=this.selectedChannelByFlowView[this.facade.getCurrentFlowView()];var channelSet=false;if(selectedChannel){var selectedChannelId='propertywindow-channel-'+selectedChannel;menu.items.each(function(item){if(item.getId()===selectedChannelId){item.setChecked(true);channelSet=true;}});}
if(!channelSet){menu.items.first().setChecked(true);}}},getChannelFilterList:function(){var channels=this.facade.getCurrentFlowViewGroupItems();var channelMenuButtonItems=[];channels.each(function(ch){var channelMeta=this.facade.getChannelMetaData(ch);var _checked=(channelMeta.id===this.getChannel())?true:false;channelMenuButtonItems.push({id:'propertywindow-channel-'+channelMeta.id,text:channelMeta.name,checked:_checked,group:'channel',checkHandler:this.onChannelSelected.bind(this)});}.bind(this));return channelMenuButtonItems;},resetFilter:function(){this.selectedChannelByFlowView=new Hash();this.rebuildFilter();},getSpecialtyChoiceItems:function(key){var items=[];if(this.shapeSelection.shapes.first()._stencil._properties[key]!==undefined){items=this.shapeSelection.shapes.first()._stencil._properties[key].items();}
return items;},getSpecialtyProperty:function(key){var propertyStringVal,propertyObj;if(this.shapeSelection.shapes.first().properties[key]!==undefined){propertyStringVal=this.shapeSelection.shapes.first().properties[key];if(typeof propertyStringVal=='object'){propertyObj=propertyStringVal;}}else{propertyStringVal=(this.shapeSelection.commonPropertiesValues[key].length)?this.shapeSelection.commonPropertiesValues[key]:"";}
if(!propertyObj){propertyObj=(propertyStringVal.length)?JSON.parse(propertyStringVal):{};}
return propertyObj;},getSpecialtyEditor:function(key,combo,value){var complexPropertyKey,eventPropertyKey,type;type=combo?combo.getValue():value;switch(key){case'oryx-input_type':complexPropertyKey="oryx-inputparameters";break;case'oryx-output_type':complexPropertyKey="oryx-outputparameters";break;case'oryx-execution_listener_type':complexPropertyKey="oryx-executionlisteners";eventPropertyKey="oryx-executionlistener_events";break;case'oryx-task_listener_type':complexPropertyKey="oryx-tasklisteners";eventPropertyKey="oryx-tasklistener_events";break;}
var config={complexPropertyKey:complexPropertyKey,propertyType:type,propertyObject:this.getSpecialtyProperty(complexPropertyKey),events:this.getSpecialtyChoiceItems(eventPropertyKey),facade:this.facade,saveFn:this.editDirectly.bind(this)};return new Ext.form.SpecialtyEditor(config);},hideSpecialtyCombo:function(combo,elName){combo.hide();$j("[name="+elName+"]").parents('.x-editor:first').parent().find('.x-shadow').remove();},selectDiagram:function(){this.shapeSelection.shapes=[this.facade.getCanvas()];this.setPropertyWindowTitle();this.identifyCommonProperties();this.setCommonPropertiesValues();this.createProperties();},specialKeyDown:function(field,event){if(field instanceof Ext.form.TextArea&&event.button==ORYX.CONFIG.KEY_Code_enter){return false}},tooltipRenderer:function(value,p,record){p.cellAttr='title="'+record.data.gridProperties.tooltip+'"';return value;},renderer:function(value,p,record){if(record.data.gridProperties.editor!==undefined&&record.data.gridProperties.editor.field!==undefined&&record.data.gridProperties.editor.field.selectedIndex!==undefined&&record.data.gridProperties.editor.field.selectedIndex>=0&&record.data.gridProperties.editor.field.store!==undefined){var selectedIndex=record.data.gridProperties.editor.field.selectedIndex;if(record.data.gridProperties.editor.field.store.data.items[selectedIndex]!==undefined&&record.data.gridProperties.editor.field.store.data.items[selectedIndex].data!==undefined&&record.data.gridProperties.editor.field.store.data.items[selectedIndex].data.title!==undefined){value=record.data.gridProperties.editor.field.store.data.items[selectedIndex].data.title;}}
this.tooltipRenderer(value,p,record);if(value instanceof Date){value=value.dateFormat(ORYX.I18N.PropertyWindow.dateFormat);}else if(String(value).search("<a href='")<0){value=Ext.util.Format.htmlEncode(String(value));if(record.data.gridProperties.renderer){return record.data.gridProperties.renderer();}
if(record.data.gridProperties.type==ORYX.CONFIG.TYPE_COLOR){value="<div class='prop-background-color' style='background-color:"+value+"' />";}
record.data.icons.each(function(each){if(each.name==value){if(each.icon){value="<img src='"+each.icon+"' /> "+value;}}});}
return value;},beforeEdit:function(option){ORYX.Log.debug("PropertyWindow.beforeEdit - Begin");var editorGrid=this.dataSource.getAt(option.row).data.gridProperties.editor;var editorRenderer=this.dataSource.getAt(option.row).data.gridProperties.renderer;if(editorGrid){this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);option.grid.getColumnModel().setEditor(1,editorGrid);editorGrid.field.row=option.row;editorGrid.render(this.grid);editorGrid.setSize(option.grid.getColumnModel().getColumnWidth(1),editorGrid.height);}else{return false;}
var key=this.dataSource.getAt(option.row).data.gridProperties.propId;this.oldValues=new Hash();this.shapeSelection.shapes.each(function(shape){this.oldValues[shape.getId()]=shape.properties[key];}.bind(this));ORYX.Log.debug("PropertyWindow.beforeEdit - End");},afterEdit:function(option){if(!option.abbreviated){option.grid.getStore().commitChanges();}
var key=option.record.data.gridProperties.propId;var selectedElements=this.shapeSelection.shapes;var oldValues=this.oldValues;var newValue=option.value;var facade=this.facade;var channel=this.channel;var commandClass=ORYX.Core.Command.extend({construct:function(){this.key=key;this.selectedElements=selectedElements;this.oldValues=oldValues;this.newValue=newValue;this.facade=facade;this.channel=channel;},execute:function(){this.selectedElements.each(function(shape){if(Object.getOwnPropertyNames(shape.getStencil().property(this.key)._valuesByChannel).length!==0){shape.setChannelsBasedPropetyValues(this.key,this.channel,this.newValue);}else if(!shape.getStencil().property(this.key).readonly()){shape.setProperty(this.key,this.newValue);}}.bind(this));this.facade.setSelection(this.selectedElements);this.facade.getCanvas().update();this.facade.updateSelection();},rollback:function(){this.selectedElements.each(function(shape){if(Object.getOwnPropertyNames(shape.getStencil().property(this.key)._valuesByChannel).length!==0){shape.setChannelsBasedPropetyValues(this.key,this.channel,this.oldValues[shape.getId()]);}else
shape.setProperty(this.key,this.oldValues[shape.getId()]);}.bind(this));this.facade.setSelection(this.selectedElements);this.facade.getCanvas().update();this.facade.updateSelection();}})
var command=new commandClass();this.facade.executeCommands([command]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,elements:selectedElements,key:key,value:option.value});},editDirectly:function(key,value){this.shapeSelection.shapes.each(function(shape){var stencil=shape.getStencil();var prop=stencil.property(key);if(prop!==undefined){var valuesByChannel=prop._valuesByChannel;if(valuesByChannel[this.channel]!==undefined){shape.setChannelsBasedPropetyValues(key,this.channel,value);}else if(!shape.getStencil().property(key).readonly()){shape.setProperty(key,value);}}else{return;}}.bind(this));var selectedElements=this.shapeSelection.shapes;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,elements:selectedElements,key:key,value:value});if(key=='oryx-processid'){var option={record:{data:{gridProperties:{propId:key}}},value:value,abbreviated:true};this.afterEdit(option);}},editDirectlyByType:function(key,type,value){this.shapeSelection.shapes.each(function(shape){var stencil=shape.getStencil();var prop=stencil.property(key);var valuesByChannel=prop._valuesByChannel;if(!shape.getStencil().property(key).readonly()){shape.setPropertyByType(key,type,value[type]);this.shapeSelection.commonPropertiesValues[key]=JSON.stringify(value);}}.bind(this));var selectedElements=this.shapeSelection.shapes;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,elements:selectedElements,key:key,value:value});},updateAfterInvalid:function(key){this.shapeSelection.shapes.each(function(shape){if(!shape.getStencil().property(key).readonly()){shape.setProperty(key,this.oldValues[shape.getId()]);shape.update();}}.bind(this));this.facade.getCanvas().update();},dialogClosed:function(data,cancelled){if(cancelled==null)
cancelled=false;var row=this.field?this.field.row:this.row;if(!cancelled){this.scope.afterEdit({grid:this.scope.grid,record:this.scope.grid.getStore().getAt(row),value:data});}
if(!this.field.hotKey){this.scope.grid.startEditing(row,this.col);}},setPropertyWindowTitle:function(){if(this.shapeSelection.shapes.length==1){region.setTitle(ORYX.I18N.PropertyWindow.title+' ('+this.shapeSelection.shapes.first().getStencil().title()+')');}else{region.setTitle(ORYX.I18N.PropertyWindow.title+' ('
+this.shapeSelection.shapes.length
+' '
+ORYX.I18N.PropertyWindow.selected
+')');}},getChannelButtonVisibility:function(){var stencilId=this.shapeSelection.shapes.first().getStencil().idWithoutNs();var visibility=/^motv-so/.test(stencilId)?"hidden":"visible";return visibility;},showChannelButton:function(){$j('#channelMenuButtonInstance').css({'visibility':this.getChannelButtonVisibility()});},setCommonPropertiesValues:function(){this.shapeSelection.commonPropertiesValues=new Hash();var firstShape=this.shapeSelection.shapes.first();this.shapeSelection.commonProperties.each(function(property){var key=property.prefix()+"-"+property.id();var groupKey=property.group();var emptyValue=false;if(groupKey!==""){if(!this.propertyGroups.hasOwnProperty(groupKey.toLowerCase())){this.propertyGroups[groupKey.toLowerCase()]={};this.propertyGroups[groupKey.toLowerCase()].label=ORYX.I18N.PropertyWindow.group[groupKey]||groupKey;this.propertyGroups[groupKey.toLowerCase()].priority=property.groupPriority();}
if(!this.propertyGroups[groupKey.toLowerCase()].hasOwnProperty('shapes')){this.propertyGroups[groupKey.toLowerCase()].shapes=[];}
if(this.propertyGroups[groupKey.toLowerCase()].shapes.indexOf(firstShape._stencil._jsonStencil.title)==-1){this.propertyGroups[groupKey.toLowerCase()].shapes.push(firstShape._stencil._jsonStencil.title);}}
this.shapeSelection.shapes.each(function(shape){if(property._jsonProp.hierarchy!==undefined){if(firstShape.properties[key][this.channel]!=shape.properties[key][this.channel]){emptyValue=true;}}else{if(firstShape.properties[key]!=shape.properties[key]){emptyValue=true;}}}.bind(this));if(!emptyValue){var commonPropertyValue="";if(property._jsonProp.hierarchy!=null){if(this.hierarchicalProperties[firstShape.id]!==undefined&&this.hierarchicalProperties[firstShape.id][key]!==undefined&&this.hierarchicalProperties[firstShape.id][key][this.channel]!==undefined&&this.hierarchicalProperties[firstShape.id][key][this.channel].title!==null){commonPropertyValue=this.hierarchicalProperties[firstShape.id][key][this.channel].title;}else if(firstShape.properties[key]!==""){var valueObj=Ext.decode(firstShape.properties[key]);commonPropertyValue=(valueObj[this.channel])?valueObj[this.channel]:"";}}else{commonPropertyValue=firstShape.properties[key];if(property._jsonProp.type===ORYX.CONFIG.TYPE_SORTLIST){var commonPropertyValueArr=commonPropertyValue.split(ORYX.CONFIG.LIST_DELIMITER);var canvasShapes=this.facade.getCanvas().getChildShapes(true);var i=commonPropertyValueArr.length;while(i--){var aShape=commonPropertyValueArr[i];if(canvasShapes.findIndex(function(cShape){return cShape._stencil._jsonStencil.internalName===aShape;})===-1){commonPropertyValueArr.splice(i,1);}}
canvasShapes.each(function(cShape){var internalName=cShape._stencil._jsonStencil.internalName;if(ORYX.Plugins.PropertyWindow.isPofActivity(cShape)){if(commonPropertyValueArr.indexOf(internalName)===-1){commonPropertyValueArr.push(internalName);}}});commonPropertyValue=commonPropertyValueArr.join(ORYX.CONFIG.LIST_DELIMITER);}}
this.shapeSelection.commonPropertiesValues[key]=commonPropertyValue;}}.bind(this));},printPropertyGroupPriorities:function(){function compareGroupPriority(a,b){if(a.priority!=b.priority){return a.priority-b.priority;}
if(a.label<b.label){return-1;}
if(a.label>b.label){return 1;}
return 0;}
var propertyGroupArr=[{label:ORYX.I18N.PropertyWindow.oftenUsed,priority:0}];for(var key in this.propertyGroups){if(this.propertyGroups.hasOwnProperty(key)){propertyGroupArr.push(this.propertyGroups[key]);}}
console.clear();console.log('Property group priorities');propertyGroupArr.sort(compareGroupPriority).each(function(group){if(group.shapes!==undefined&&group.shapes.length){console.log("%d\t\t%s\t\tStencils[%s]",group.priority,group.label,group.shapes.join(', '));}else{console.log("%d\t\t%s",group.priority,group.label);}});console.log('Edit groupPriority attribute in propertyPackages.json');},setHierarchicalPropertiesValues:function(){var firstShape=this.shapeSelection.shapes.first();firstShape.hierarchicalPropertiesValues=new Array();this.shapeSelection.hierarchicalProperties.each(function(property){var key=property.prefix()+"-"+property.id();this.shapeSelection.shapes.each(function(shape){if(firstShape.properties[key]!==undefined&&firstShape.properties[key]==shape.properties[key]&&firstShape.properties[key]!==""){firstShape.hierarchicalPropertiesValues.push(firstShape.properties[key]);firstShape.channelsBasedPropetyValues[key]=firstShape.properties[key];}}.bind(this));}.bind(this));},setHierarchicalPropertiesHash:function(channels){var firstShape=this.shapeSelection.shapes.first();if(firstShape.getStencil()._jsonStencil.groups.indexOf("Service Operations")!==-1&&firstShape.hierarchicalPropertiesValues.length){this.getMultiListData(channels);}else{if(firstShape.hierarchicalPropertiesValues.length>0){var valuesByChannel=new Hash();var selectedIdsChain="";channels.each(function(channel){valuesByChannel[channel]=[];for(var i=0;i<firstShape.hierarchicalPropertiesValues.length;i++){var valueObj=Ext.decode(firstShape.hierarchicalPropertiesValues[i]);if(valueObj[channel]!==undefined&&valueObj[channel].length>0)
valuesByChannel[channel].push(valueObj[channel]);}
if(valuesByChannel[channel].length>0)
valuesByChannel[channel]=valuesByChannel[channel].join(this.hierarchyIdChainDelimiter);else
delete valuesByChannel[channel];}.bind(this));if(valuesByChannel.values().length>0){var selectedIdsChain=Ext.encode(valuesByChannel);var urlString=ORYX.PATH+"poem/loadCallResolutionSavedProps"
+"?stencilId="+firstShape.getStencil().idWithoutNs()
+"&selectedIdsByChannel="+selectedIdsChain
+"&delimiter="+this.hierarchyIdChainDelimiter;new Ajax.Request(urlString,{method:'POST',asynchronous:true,onSuccess:this.onGetHierarchicalValuesSuccess.bind(this),onFailure:this.onGetHierarchicalValuesFailure.bind(this)});}}}},getMultiListData:function(channels){var firstShape=this.shapeSelection.shapes.first();var resourceNames=this.getHierarchicalMultiListResourceNames();resourceNames.each(function(resourceName){Ext.Ajax.request({url:this.hierarchyMultiListRestUrlRoot+resourceName,success:function(data){this.onGetMultiListDataSuccess(data,channels);}.bind(this),failure:function(){alert("getMultiListData failure");}});}.bind(this));},onGetMultiListDataSuccess:function(data,channels){var firstShape=this.shapeSelection.shapes.first();var hmlData=JSON.parse(data.responseText),key,value;var channel="desktop";for(var i=1;i<firstShape.hierarchicalPropertiesValues.length;i++){var jsonObj=JSON.parse(firstShape.hierarchicalPropertiesValues[i]);value=jsonObj[channel];key=this.getHierarchicalMultilistJsonKey(hmlData,value);if(key){this.hierarchyDataRootArray[i]=key;}}
if(firstShape.hierarchicalPropertiesHash===undefined){firstShape.hierarchicalPropertiesHash=new Hash();}
channels.each(function(channel){firstShape.hierarchicalPropertiesHash[channel]=new Hash();for(var i=0;i<this.shapeSelection.hierarchicalProperties.length;i++){var valueObj=Ext.decode(firstShape.hierarchicalPropertiesValues[i]);var property=this.shapeSelection.hierarchicalProperties[i];firstShape.hierarchicalPropertiesHash[channel][property.id()]=new ORYX.Core.StencilSet.PropertyItem({id:valueObj["desktop"],value:valueObj["desktop"],title:valueObj["desktop"],hasChildren:true,nextData:""},property.namespace(),property);}}.bind(this));this.createPropertiesAndApplyChannelFilter();},getHierarchicalMultilistJsonKey:function(dataObj,val){for(key in dataObj){if(dataObj.hasOwnProperty(key)&&dataObj[key].some(function(obj){return obj.value===val;})){return key;}}
return null;},getHierarchicalMultiListResourceNames:function(){var key="resourceName";var hmlResourceNames=[];var hmlProperties=this.shapeSelection.commonProperties.filter(function(prop){return prop._jsonProp[key]!==undefined;});for(var i=0,x=hmlProperties.length;i<x;i++){var prop=hmlProperties[i]._jsonProp;if(prop.hasOwnProperty(key)&&hmlResourceNames.indexOf(prop[key])===-1){hmlResourceNames.push(prop[key]);}}
return hmlResourceNames;},getStencilSetOfSelection:function(){var stencils=new Hash();this.shapeSelection.shapes.each(function(shape){stencils[shape.getStencil().id()]=shape.getStencil();})
return stencils;},identifyCommonProperties:function(){this.shapeSelection.commonProperties.clear();var stencils=this.getStencilSetOfSelection();var firstStencil=stencils.values().first();var comparingStencils=stencils.values().without(firstStencil);if(comparingStencils.length==0){if(this.shapeSelection.shapes.length>1&&firstStencil.hasHierarchicalProperties){var properties=new Hash();firstStencil.properties().each(function(property){if(property._jsonProp.hierarchy===undefined)
properties[property.namespace()+'-'+property.id()+'-'+property.type()]=property;});this.shapeSelection.commonProperties=properties.values();}else{this.shapeSelection.commonProperties=firstStencil.properties();}}else{var properties=new Hash();firstStencil.properties().each(function(property){if(property._jsonProp.hierarchy===undefined)
properties[property.namespace()+'-'+property.id()+'-'+property.type()]=property;});comparingStencils.each(function(stencil){var intersection=new Hash();stencil.properties().each(function(property){var key=property.namespace()+'-'+property.id()+'-'+property.type();if(properties[key]){intersection[key]=property;}});properties=intersection;});this.shapeSelection.commonProperties=properties.values();}},identifyHierarchicalProperties:function(){this.shapeSelection.hierarchicalProperties.clear();if(this.shapeSelection.commonProperties){this.shapeSelection.commonProperties.each(function(pair,index){if(pair._jsonProp.hierarchy!=null)
this.shapeSelection.hierarchicalProperties.push(pair);}.bind(this));}},onSelectionChanged:function(event){if(!event.elements.length){this.selectedElementId=null;}else{if(!this.selectedElementId||this.selectedElementId!==event.elements[0].id){this.selectedElementId=event.elements[0].id;}}
this.grid.stopEditing();if(this.comboList){this.comboList.prev('.x-shadow').remove();this.comboList.remove();}
if(this.inputHolder){this.inputHolder.remove();}
this.shapeSelection.shapes=event.elements;if(event.elements.length==0){this.shapeSelection.shapes=[this.facade.getCanvas()];}
if(event.subSelection){this.shapeSelection.shapes=[event.subSelection];}
this.setPropertyWindowTitle();this.showChannelButton();this.identifyCommonProperties();this.setCommonPropertiesValues();var firstShape=this.shapeSelection.shapes.first();if(firstShape.hierarchicalPropertiesValues===undefined){this.identifyHierarchicalProperties();this.setHierarchicalPropertiesValues();var channels=this.facade.getCurrentFlowViewGroupItems();this.setHierarchicalPropertiesHash(channels);}
this.createPropertiesAndApplyChannelFilter();},onGetHierarchicalValuesSuccess:function(response){if(response.responseText){var namespace="http://b3mn.org/stencilset/motive1.0#";var responseObj=Ext.util.JSON.decode(response.responseText);var firstShape=this.shapeSelection.shapes.first();var incompleteHierarchySets=new Array();if(firstShape.hierarchicalPropertiesHash===undefined)
firstShape.hierarchicalPropertiesHash=new Hash();for(var channel in responseObj){if(responseObj.hasOwnProperty(channel)){var obj=responseObj[channel];firstShape.hierarchicalPropertiesHash[channel]=new Hash();for(var i=0;i<obj.levelData.length;i++){var levelData=obj.levelData[i];var property=this.shapeSelection.hierarchicalProperties[i];firstShape.hierarchicalPropertiesHash[channel][property.id()]=new ORYX.Core.StencilSet.PropertyItem({id:levelData.id,value:levelData.id,title:levelData.value,hasChildren:levelData.hasChildren},namespace,property);}
if(!obj.complete){incompleteHierarchySets.push({namespace:namespace,channel:channel,levelIndex:obj.levelData.length});}}}}
this.createPropertiesAndApplyChannelFilter();if(incompleteHierarchySets.length>0){this.handleIncompleteHierarchicalDataLoad(incompleteHierarchySets);}},onGetHierarchicalValuesFailure:function(channels,response){ORYX.Log.error("Hierarchical values could not be loaded.");this.createPropertiesAndApplyChannelFilter();},handleIncompleteHierarchicalDataLoad:function(incompleteHierarchySets){var firstShape=this.shapeSelection.shapes.first();var property,key,levelN,messages=[];incompleteHierarchySets.each(function(ih){levelN=parseInt(ih.levelIndex)+1;messages.push(String.format(ORYX.I18N.PropertyWindow.alert.levelDataChanged,levelN,ih.channel));for(var i=firstShape.hierarchicalPropertiesValues.length-1;i>=ih.levelIndex;i--){property=this.shapeSelection.hierarchicalProperties[i];key=property.prefix()+"-"+property.id();this.shapeSelection.commonPropertiesValues[key]="";firstShape.properties[key]="";firstShape.hierarchicalPropertiesValues.pop();}}.bind(this));this.createProperties();messages.push(String.format(ORYX.I18N.PropertyWindow.alert.updateSelections));Ext.Msg.show({title:ORYX.I18N.PropertyWindow.alert.information,msg:messages.join("<br />"),buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO});return false;},createPropertiesAndApplyChannelFilter:function(){this.createProperties();this.applyChannelFilter();},getComboCell:function(wrapper){return wrapper.parents('td').next().find('.x-grid3-cell-inner');},getComboLabelWrapper:function(){var wrapper=$j('.x-grid3-cell-inner.x-grid3-col-0').filter(function(){return $j(this).text()==="Flow ID";});return wrapper;},getInputHolder:function(){return this.inputHolder;},setInputHolder:function(inputId){this.inputHolder=$j('#'+inputId).parents('.x-layer.x-editor');},showComboboxRefreshButton:function(inputId,key,attribute){this.setInputHolder(inputId);var that=this;var refreshButton=$j('<span/>').addClass('property-combobox-refresh').attr('title','Refresh');var refreshHandler=this.handleComboboxRefreshButton.bind(this,key,attribute);var labelWrapper=this.getComboLabelWrapper();var combobox=this.editorCombos[key];labelWrapper.find('.property-combobox-refresh').remove();labelWrapper.prepend(refreshButton);refreshButton.on('click',refreshHandler);$j(window).resize(function(){if(combobox!==undefined&&combobox.isVisible()){combobox.collapse();combobox.hide();$j('.x-shadow').hide();that.positionComboElements(that.getComboCell(that.getComboLabelWrapper()).offset());combobox.show();}});},handleComboboxRefreshButton:function(key,attribute,e){if(e!==undefined){$j(e.target).parents('.x-grid3-cell-selected').removeClass('x-grid3-cell-selected');}
var that=this;var combobox=this.editorCombos[key];var comboLabelWrapper=this.getComboLabelWrapper();this.positionComboElements(this.getComboCell(comboLabelWrapper).offset());combobox.on('blur',function(){that.positionComboElements();});combobox.store.on('load',function(){that.comboboxStore=this;combobox.focus();combobox.expand();clearTimeout(alertTimeout)
Ext.Msg.hide();});var alertTimeout=setTimeout(function(){Ext.Msg.show({title:ORYX.I18N.PropertyWindow.RefreshProcessIds.alertTitle,msg:ORYX.I18N.PropertyWindow.RefreshProcessIds.waitMsg,animEl:'elId',icon:Ext.MessageBox.INFO,minWidth:250});},500);combobox.store.load();},positionComboElements:function(offset){var hiddenConfig={visibility:'hidden',left:'-1000px',top:'-1000px'};var config=(offset&&offset.left&&offset.top)?{visibility:'visible',left:offset.left,top:offset.top}:hiddenConfig;this.inputHolder.css(config);if(this.comboList){this.comboList.css(hiddenConfig);}},createProperties:function(){this.properties=[];this.popularProperties=[];this.hierarchicalProperties=this.hierarchicalProperties||[];this.editorCombos=[];if(this.shapeSelection.commonProperties){this.shapeSelection.commonProperties.each((function(pair,index){var key=pair.prefix()+"-"+pair.id();var name=pair.title();var icons=[];var attribute=this.shapeSelection.commonPropertiesValues[key];var editorGrid=undefined;var editorRenderer=null;var refToViewFlag=false;if(!pair.readonly()){switch(pair.type()){case ORYX.CONFIG.TYPE_STRING:if(pair.wrapLines()){var editorTextArea=new Ext.form.TextArea({alignment:"tl-tl",allowBlank:pair.optional(),msgTarget:'title',maxLength:pair.length()});editorTextArea.on('keyup',function(textArea,event){this.editDirectly(key,textArea.getValue());}.bind(this));editorGrid=new Ext.Editor(editorTextArea);}else{var editorInput;if(pair._jsonProp.group=='forms'){editorInput=new Ext.form.TextField({allowBlank:pair.optional(),msgTarget:'title',maxLength:pair.length(),name:key,disabled:true});this.popularProperties.each((prop)=>{if(prop[6].propId==="oryx-form_type"){if(prop[4]=='Form Key'){editorInput=new Ext.form.TextField({allowBlank:pair.optional(),msgTarget:'title',maxLength:pair.length(),name:key});}}});this.setFormFieldInformation(pair._jsonProp.id,editorInput.getId());}else{editorInput=new Ext.form.TextField({allowBlank:pair.optional(),msgTarget:'title',maxLength:pair.length()});}
editorInput.on('keyup',function(input,event){this.editDirectly(key,input.getValue());}.bind(this));editorInput.on('blur',function(input){if(!input.isValid(false))
this.updateAfterInvalid(key);}.bind(this));editorInput.on("specialkey",function(input,e){if(!input.isValid(false))
this.updateAfterInvalid(key);}.bind(this));editorGrid=new Ext.Editor(editorInput);}
break;case ORYX.CONFIG.TYPE_BOOLEAN:if(typeof attribute=="string"){attribute=(attribute=="true"||attribute=="Default");}
var editorCheckbox=new Ext.form.Checkbox({boxLabel:"false"});editorCheckbox.on('check',function(c,checked){editorCheckbox.setBoxLabel(checked.toString());this.editDirectly(key,checked);c.blur();}.bind(this));Ext.override(Ext.form.Checkbox,{setBoxLabel:function(boxLabel){this.boxLabel=boxLabel;if(this.rendered){this.wrap.child('.x-form-cb-label').update(boxLabel);}}});editorGrid=new Ext.Editor(editorCheckbox);break;case ORYX.CONFIG.TYPE_INTEGER:var numberField=new Ext.form.NumberField({allowBlank:pair.optional(),allowDecimals:false,msgTarget:'title',minValue:pair.min(),maxValue:pair.max()});numberField.on('keyup',function(input,event){this.editDirectly(key,input.getValue());}.bind(this));editorGrid=new Ext.Editor(numberField);break;case ORYX.CONFIG.TYPE_FLOAT:var numberField=new Ext.form.NumberField({allowBlank:pair.optional(),allowDecimals:true,msgTarget:'title',minValue:pair.min(),maxValue:pair.max()});numberField.on('keyup',function(input,event){this.editDirectly(key,input.getValue());}.bind(this));editorGrid=new Ext.Editor(numberField);break;case ORYX.CONFIG.TYPE_COLOR:var editorPicker=new Ext.ux.ColorField({allowBlank:pair.optional(),msgTarget:'title',facade:this.facade});editorGrid=new Ext.Editor(editorPicker);break;case ORYX.CONFIG.TYPE_CHOICE:var store=null;var mode=null;var autoComplete=null;var comboListeners=null;var urlPath="";var namespace="";var jsonRoot="";var modelId=(location.hash.slice(1).replace(/^\/?/,"").replace(/\/?$/,"")).replace(/model\//,"");if(pair._jsonProp.id=='processid'){urlPath=ORYX.PATH+"poem/queryModels";if(modelId!=null){urlPath=urlPath+"?modelId="+modelId;}
namespace="http://b3mn.org/stencilset/motive1.0#";}else if(pair._jsonProp.id=='callactivitycalledelement'){urlPath=ORYX.PATH+"poem/callActProperties?callActQueryType=wfList";if(modelId!=null){urlPath=urlPath+"&modelId="+modelId;}
namespace="http://b3mn.org/stencilset/motivebpmn2.0#";}else if(pair._jsonProp.id=='messageref'){urlPath=ORYX.PATH+"poem/throwEventProperties?queryType=msgRefList";if(modelId!=null){urlPath=urlPath+"&modelId="+modelId;}
namespace="http://b3mn.org/stencilset/motivebpmn2.0#";}else if(pair._jsonProp.hierarchy!=null&&pair._jsonProp.hierarchy>=0){if(pair._jsonProp.resourceName!==undefined){urlPath=this.hierarchyMultiListRestUrlRoot+pair._jsonProp.resourceName;jsonRoot=this.hierarchyDataRootArray[pair._jsonProp.hierarchy];}else{jsonRoot="levelData";urlPath=ORYX.PATH+"poem/callResolutionProperties?channelId="+this.getChannel()
+"&stencilId="+this.shapeSelection.shapes.first().getStencil().idWithoutNs()
+"&targetId="+pair.id();}
namespace="http://b3mn.org/stencilset/motive1.0#";}
if(pair._jsonProp.dataURL!=null){store=new Ext.data.JsonStore({url:pair._jsonProp.dataURL});}else{var firstShape=this.shapeSelection.shapes.first();var shapeKey=firstShape.id;var items=null;items=pair.items();if(pair._jsonProp.hierarchy!=null&&firstShape.hierarchicalPropertiesHash!==undefined&&firstShape.hierarchicalPropertiesHash[this.channel]!==undefined&&firstShape.hierarchicalPropertiesHash[this.channel].values()!==null&&firstShape.hierarchicalPropertiesHash[this.channel].values().length>=pair._jsonProp.hierarchy){var propertyItem=firstShape.hierarchicalPropertiesHash[this.channel][pair._jsonProp.parent];if(pair._jsonProp.parent!=null&&propertyItem!==undefined){var parentKey=pair.prefix()+"-"+pair._jsonProp.parent;if(this.hierarchicalProperties[shapeKey]===undefined)
this.hierarchicalProperties[shapeKey]=[];if(this.hierarchicalProperties[shapeKey][parentKey]===undefined)
this.hierarchicalProperties[shapeKey][parentKey]=new Hash();if(this.hierarchicalProperties[shapeKey][parentKey][this.channel]===undefined)
this.hierarchicalProperties[shapeKey][parentKey][this.channel]=new ORYX.Plugins.PropertyHierarchy(this.hierarchyIdChainDelimiter);this.hierarchicalProperties[shapeKey][parentKey][this.channel].level=pair._jsonProp.hierarchy;this.hierarchicalProperties[shapeKey][parentKey][this.channel].depth=firstShape.hierarchicalPropertiesHash[this.channel].values().length-pair._jsonProp.hierarchy;this.hierarchicalProperties[shapeKey][parentKey][this.channel].values=[];for(var i=0;i<pair._jsonProp.hierarchy;i++){if(firstShape.hierarchicalPropertiesValues.length>0&&firstShape.hierarchicalPropertiesValues[i]!==undefined){var val=Ext.decode(firstShape.hierarchicalPropertiesValues[i])[this.channel];this.hierarchicalProperties[shapeKey][parentKey][this.channel].values.push(val);}}
this.hierarchicalProperties[shapeKey][parentKey][this.channel].title=propertyItem.title();this.hierarchicalProperties[shapeKey][parentKey][this.channel].properties.push(pair);this.hierarchicalProperties[shapeKey][parentKey][this.channel].enabled=propertyItem.hasChildren();}
items=firstShape.hierarchicalPropertiesHash[this.channel].values();}else{items=pair.items();}
var options=[];if(pair._jsonProp.deselectable)
options.push([null,'No Selection','']);items.each(function(value){if(value.value()==attribute)
attribute=value.title();if(value.refToView()[0])
refToViewFlag=true;if(value.visible()){options.push([value.icon(),value.title(),value.value()]);}
icons.push({name:value.title(),icon:value.icon()});});if(pair._jsonProp.id=='processid'||pair._jsonProp.id=='callactivitycalledelement'||pair._jsonProp.id=='messageref'){if(pair._jsonProp.id=='processid'||pair._jsonProp.id=='callactivitycalledelement'){store=(this.comboboxStore)?this.comboboxStore:new Ext.data.Store({url:urlPath,autoLoad:false,reader:new Ext.data.JsonReader({root:'models',idProperty:'identId'},[{name:'title',type:'string',mapping:'title'},{name:'identId',type:'string',mapping:'identId'},{name:'value',type:'string',mapping:'value'}]),sortInfo:{field:'title',direction:'ASC'}});}else if(pair._jsonProp.id=='messageref'){store=new Ext.data.Store({url:urlPath,autoLoad:false,reader:new Ext.data.JsonReader({root:'messages',idProperty:'value'},[{name:'title',type:'string',mapping:'title'},{name:'value',type:'string',mapping:'value'}]),sortInfo:{field:'title',direction:'ASC'}});}
mode='local';autoComplete=true;comboListeners={beforeshow:function(qe){if(qe.lastSize.width!==undefined){this.showComboboxRefreshButton(qe.id,key,attribute);if(!this.comboboxStore){this.handleComboboxRefreshButton(key,attribute);}}}.bind(this),expand:function(combo){this.comboList=this.inputHolder.siblings('.x-combo-list');}.bind(this)};}else if(pair._jsonProp.hierarchy!=null&&pair._jsonProp.hierarchy>=0){var shapeId=this.shapeSelection.shapes.first().id;if(pair._jsonProp.parent!=null){var parentId=pair.prefix()+"-"+pair._jsonProp.parent;}
var valueMapping=pair._jsonProp.resourceName?'value':'id';store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:urlPath,method:'GET'}),autoLoad:false,reader:new Ext.data.JsonReader({root:jsonRoot,idProperty:'id'},[{name:'title',type:'string',mapping:'value'},{name:'id',type:'string',mapping:'id'},{name:'value',type:'string',mapping:valueMapping},{name:'hasChildren',type:'boolean',mapping:'hasChildren'},{name:'nextData',type:'string',mapping:'nextData'}]),sortInfo:{field:'value',direction:'ASC'}});mode='remote';autoComplete=true;comboListeners={beforequery:function(qe){var combo=qe.combo;var selectIndex=-1;var url=combo.store.proxy.conn.url;delete combo.lastQuery;if(parentId!==undefined&&pair._jsonProp.resourceName===undefined&&!/delimiter/.test(url)){url+="&delimiter="+this.hierarchyIdChainDelimiter;}
if(parentId!==undefined){if(/&parentIdChain/.test(url)){var index=url.indexOf("&parentIdChain");url=url.substring(0,index);}
if(pair._jsonProp.resourceName===undefined){url+="&parentIdChain="+this.hierarchicalProperties[shapeId][parentId][this.channel].getValuesChain();}
combo.store.proxy.conn.url=url;}
if(qe.query==""){combo.store.on('load',function(){Ext.each(this.data.items,function(item,index){if(item.json.value==attribute){selectIndex=index;return false;}});combo.select(selectIndex,true);});}}.bind(this),select:function(combo,record,index){this.showHierarchicalProp({name:combo.name,value:combo.value,title:record.json.value,hasChildren:record.json.hasChildren,nextData:record.json.nextData});if(combo.getValue()!==""){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_MOUSEDOWN,currentTarget:{id:combo.id}});this.facade.updateSelection();}}.bind(this)};}else{var optionObj={"options":[]};for(var i=0;i<options.length;i++){optionObj["options"].push({"icon":options[i][0],"title":options[i][1],"value":options[i][2]});}
store=new Ext.data.Store({data:optionObj,autoLoad:true,reader:new Ext.data.JsonReader({root:"options",idProperty:'value'},[{name:'icon',type:'string',mapping:'icon'},{name:'title',type:'string',mapping:'title'},{name:'value',type:'string',mapping:'value'}]),sortInfo:{field:'title',direction:'ASC'}});mode='local';autoComplete=true;if(comboListeners===undefined){comboListeners=pair._jsonProp.listeners;}}}
var editorCombo=new Ext.form.ComboBox({tpl:'<tpl for="."><div class="x-combo-list-item" title="{title}">{[(values.icon) ? "<img src=\'" + values.icon + "\' />" : ""]} {title:htmlEncode}</div></tpl>',name:key,store:store,displayField:'title',valueField:'value',editable:autoComplete,typeAhead:autoComplete,mode:mode,triggerAction:'all',selectOnFocus:true,forceSelection:true,lazyRender:true,autoSelect:false,height:300,minHeight:100,maxHeight:300,listeners:comboListeners});this.editorCombos[key]=editorCombo;Ext.override(Ext.form.ComboBox,{onTypeAhead:function(){var that=this;var selectIndex=0;var selectValue="";var itemsToRemove=[];var regexp=new RegExp(this.lastQuery,"i");Ext.each(this.store.data.items,function(item,index){if(regexp.test(item.json.title)){if(selectValue==""){selectIndex=index;selectValue=item.json.value;}}else{itemsToRemove.push(item);}});Ext.each(itemsToRemove,function(item,index){that.store.remove(item);});}});if(pair._jsonProp.dataURL!=null){editorCombo.store.on('beforeload',function(combo,options){options.params=this.shapeSelection.commonPropertiesValues;return true;}.bind(this));}
if(pair._jsonProp.id=='processid'||pair._jsonProp.id=='callactivitycalledelement'){editorCombo.store.on('load',function(combo,records,options){var items=new Hash();var flows=[];for(var i=0;i<records.length;i++){var record=records[i];flows[i]=record.data;items[record.data.value]=new ORYX.Core.StencilSet.PropertyItem({"id":record.data.id,"title":record.data.title,"value":record.data.value},namespace,pair);}
pair.setItems(items);if(pair._jsonProp.id=='processid'){ORYX.Plugins.MotivePlugin._AVAILABLE_FLOWS=flows;}else if(pair._jsonProp.id=='callactivitycalledelement'){ORYX.Plugins.MotivePlugin._AVAILABLE_BP_FLOWS=flows;}else if(pair._jsonProp.id=='messageref'){ORYX.Plugins.MotivePlugin._AVAILABLE_MSG_REFS=flows;}
return true;}.bind(this));}else if(pair._jsonProp.hierarchy!=null&&pair._jsonProp.hierarchy>=0){editorCombo.store.on('load',function(combo,records,options){var items=new Hash();if(records.length==0){Ext.Msg.show({title:"Attention",msg:String.format(ORYX.I18N.PropertyWindow.alert.noLevelDataForChannel,this.channel),buttons:Ext.Msg.OK,animEl:'elId',icon:Ext.MessageBox.WARNING,minWidth:350});}else{for(var i=0;i<records.length;i++){var record=records[i];items[record.data.id]=new ORYX.Core.StencilSet.PropertyItem({"id":record.data.value,"title":record.data.title,"value":record.data.value,"hasChildren":record.data.hasChildren,"nextData":record.data.nextData},namespace,pair);}}
pair.setItems(items);return true;}.bind(this));}else if(pair._jsonProp.id=="wfnamedefinition"){editorCombo=new Ext.form.ComboBox({tpl:'<tpl for="."><div class="x-combo-list-item" title="{title}">{[(values.icon) ? "<img src=\'" + values.icon + "\' />" : ""]} {title:htmlEncode}</div></tpl>',name:key,store:store,displayField:'title',valueField:'value',mode:mode,triggerAction:'all',selectOnFocus:true,forceSelection:true,lazyRender:true,autoSelect:false,height:300,minHeight:100,maxHeight:300,disabled:this.getWorkflowNameComboBoxDisabledValue(),listeners:comboListeners});this.setFormFieldInformation(pair._jsonProp.id,editorCombo.getId());}
if(key=='oryx-input_type'||key=='oryx-output_type'||key=='oryx-execution_listener_type'||key=='oryx-task_listener_type'){Ext.form.ComboBox.override({updateItemText:function(value,newText){var record=this.findRecord(this.valueField,value);if(record==null){return;}
record.set(this.displayField,newText);record.commit();if(this.getValue()==value){this.setValue(value);}
return record;}});var buttonBody,buttonTitle,propertyKey,suffix;switch(key){case'oryx-input_type':buttonBody="[id$='Input/Output-bd']";buttonTitle=pair._jsonProp.description;propertyKey="oryx-inputparameters";suffix="input_";break;case'oryx-output_type':buttonBody="[id$='Input/Output-bd']";buttonTitle=pair._jsonProp.description;propertyKey="oryx-outputparameters";suffix="output_";break;case'oryx-execution_listener_type':buttonBody="[id$='Listeners-bd']";buttonTitle=pair._jsonProp.description;propertyKey="oryx-executionlisteners";suffix="execution_listener_";break;case'oryx-task_listener_type':buttonBody="[id$='Listeners-bd']";buttonTitle=pair._jsonProp.description;propertyKey="oryx-tasklisteners";suffix="task_listener_";break;}
if(attribute.length){targetSelectors={body:buttonBody,el:'.x-grid3-td-0',title:buttonTitle,value:this.shapeSelection.commonPropertiesValues[key]};this.auxiliaryPropertyButtonsHash[key]=targetSelectors;}else{attribute="Select";delete this.auxiliaryPropertyButtonsHash[key];}
editorCombo.on('expand',function(combo){var propertyObj=this.shapeSelection.shapes.first().properties[propertyKey];if(typeof propertyObj==='string'){if(propertyObj.length){propertyObj=JSON.parse(propertyObj);}else{propertyObj={items:[],totalCount:0};pair.items().each(function(item){propertyObj.items.push({id:item._jsonItem.id,title:item._jsonItem.title,value:item._jsonItem.value});});propertyObj.totalCount=propertyObj.items.length;}}
var typeKey=key.replace("oryx-","");var propItems=propertyObj.items;combo.store.data.items.each(function(item){var index=propItems.findIndex(function(i){if(item.data.value==='script-inline-javascript'){return(i[typeKey]==='script'&&i[suffix+"script_format"]==='javascript'&&i[suffix+"script_type"]==='inlinescript');}else if(item.data.value==='script-inline-juel'){return(i[typeKey]==='script'&&i[suffix+"script_format"]==='juel'&&i[suffix+"script_body"].length);}else if(item.data.value==='script-resource'){return(i[typeKey]==='script'&&i[suffix+"script_format"].length&&i[suffix+"script_resource"].length);}else if(item.data.value==='delegate_expression'){return i[typeKey]===item.data.value||i[typeKey]==='delegateExpression';}else{return i[typeKey]===item.data.value;}});var comboOption=$j(".x-combo-list-item").filter("div[title='"+item.data.title+"']");comboOption.addClass('specialtyCombo');comboOption.removeClass('populated');if(index!==-1){comboOption.addClass('populated');}}.bind(this));}.bind(this));}
editorCombo.on('select',function(combo,record,index){if(key=='oryx-form_type'){var keyToShow=record.data.value;var itemId=this.getFormFieldInformation(keyToShow);Object.keys(this.formFields).forEach((formkey,index)=>{let editor=Ext.getCmp(this.getFormFieldInformation(formkey));if(formkey=='wfnamedefinition'){let disabledValue=(formkey==keyToShow)?false:true;this.setWorkflowNameComboBoxDisabledValue(disabledValue);}
if(editor.name!==undefined){this.editDirectly(editor.name,"");}else if(editor.key!==undefined){this.editDirectly(editor.key,"");}
if(formkey==keyToShow){editor.enable();editor.hide();}else{editor.setDisabled(true);editor.show();}});}
if(key=='oryx-input_type'||key=='oryx-output_type'||key=='oryx-execution_listener_type'||key=='oryx-task_listener_type'){var complexPropertyKey,eventPropertyKey;switch(key){case'oryx-input_type':complexPropertyKey="oryx-inputparameters";break;case'oryx-output_type':complexPropertyKey="oryx-outputparameters";break;case'oryx-execution_listener_type':complexPropertyKey="oryx-executionlisteners";eventPropertyKey="oryx-executionlistener_events";break;case'oryx-task_listener_type':complexPropertyKey="oryx-tasklisteners";eventPropertyKey="oryx-tasklistener_events";break;}
var config={complexPropertyKey:complexPropertyKey,propertyType:combo.getValue(),propertyObject:this.getSpecialtyProperty(complexPropertyKey),events:this.getSpecialtyChoiceItems(eventPropertyKey),facade:this.facade,saveFn:this.editDirectly.bind(this)};this.hideSpecialtyCombo(combo,key);var editor=new Ext.form.SpecialtyEditor(config);}else{this.editDirectly(key,combo.getValue());combo.render();}}.bind(this))
editorGrid=new Ext.Editor(editorCombo);break;case ORYX.CONFIG.TYPE_DATE:var currFormat=ORYX.I18N.PropertyWindow.dateFormat
if(!(attribute instanceof Date))
attribute=Date.parseDate(attribute,currFormat)
editorGrid=new Ext.Editor(new Ext.form.DateField({allowBlank:pair.optional(),format:currFormat,msgTarget:'title'}));break;case ORYX.CONFIG.TYPE_TEXT:var cf=new Ext.form.ComplexTextField({allowBlank:pair.optional(),dataSource:this.dataSource,grid:this.grid,row:index,facade:this.facade});cf.on('dialogClosed',this.dialogClosed,{scope:this,row:index,col:1,field:cf});editorGrid=new Ext.Editor(cf);break;case ORYX.CONFIG.TYPE_HTML:var cf;if(pair._jsonProp.group=='forms'){cf=new Ext.form.HtmlField({name:key,allowBlank:pair.optional(),dataSource:this.dataSource,grid:this.grid,row:index,propertyTitle:name,facade:this.facade,stencilType:pair.type(),hasDictionary:true,readOnly:true,disabled:true});this.popularProperties.each((prop)=>{if(prop[6].propId==="oryx-form_type"){if(prop[4]=='Form HTML'){cf=new Ext.form.HtmlField({allowBlank:pair.optional(),dataSource:this.dataSource,grid:this.grid,row:index,propertyTitle:name,facade:this.facade,stencilType:pair.type(),hasDictionary:true,readOnly:true});}}});this.setFormFieldInformation(pair._jsonProp.id,cf.getId());}else{cf=new Ext.form.HtmlField({allowBlank:pair.optional(),dataSource:this.dataSource,grid:this.grid,row:index,propertyTitle:name,facade:this.facade,stencilType:pair.type(),hasDictionary:true,readOnly:true});}
if(pair._jsonProp.localizable)
cf.availableLanguagesCfg=this.facade.getLocaleConfigString();cf.on('dialogClosed',this.dialogClosed,{scope:this,row:index,col:1,field:cf,key:key});editorGrid=new Ext.Editor(cf);break;case ORYX.CONFIG.TYPE_HTML_MIN:var cf=new Ext.form.HtmlField({allowBlank:pair.optional(),dataSource:this.dataSource,grid:this.grid,row:index,propertyTitle:name,facade:this.facade,stencilType:pair.type(),hasDictionary:true,readOnly:true});if(pair._jsonProp.localizable)
cf.availableLanguagesCfg=this.facade.getLocaleConfigString();cf.on('dialogClosed',this.dialogClosed,{scope:this,row:index,col:1,field:cf,key:key});editorGrid=new Ext.Editor(cf);break;case ORYX.CONFIG.TYPE_HTML_FULL:var cf=new Ext.form.HtmlField({allowBlank:pair.optional(),dataSource:this.dataSource,grid:this.grid,row:index,facade:this.facade,stencilType:pair.type(),hasDictionary:true,readOnly:true});if(pair._jsonProp.localizable)
cf.availableLanguagesCfg=this.facade.getLocaleConfigString();cf.on('dialogClosed',this.dialogClosed,{scope:this,row:index,col:1,field:cf});editorGrid=new Ext.Editor(cf);break;case ORYX.CONFIG.TYPE_EXPRESSION:var cf=new Ext.form.ExpressionField({allowBlank:pair.optional(),dataSource:this.dataSource,grid:this.grid,row:index,facade:this.facade,stencilType:pair.type(),readOnly:true,language:pair.language(),scriptLanguage:pair.scriptLanguage()});cf.on('dialogClosed',this.dialogClosed,{scope:this,row:index,col:1,field:cf});editorGrid=new Ext.Editor(cf);break;case ORYX.CONFIG.TYPE_MODEL_INPUT:var cf=new Ext.form.ModelInputField({allowBlank:pair.optional(),dataSource:this.dataSource,grid:this.grid,row:index,facade:this.facade,stencilType:pair.type(),readOnly:true});cf.on('dialogClosed',this.dialogClosed,{scope:this,row:index,col:1,field:cf});editorGrid=new Ext.Editor(cf);break;case ORYX.CONFIG.TYPE_SIGNAL_CONFIG:var current_signals=ORYX.Plugins.PropertyWindow.getNamedSequences(this.shapeSelection.shapes.first());var sig_names=[];Ext.each(current_signals,function(item){if(item.expression!=null&&item.expression!="")
sig_names.push({id:item.id,name:item.expression});});var cf=new Ext.form.SignalCfgField({allowBlank:pair.optional(),fields:pair._jsonProp["signal_fields"],dataSource:this.dataSource,grid:this.grid,row:index,facade:this.facade,current_signal_names:sig_names,readOnly:true,parentscope:this});cf.on('dialogClosed',this.dialogClosed,{scope:this,row:index,col:1,field:cf});editorGrid=new Ext.Editor(cf);cf.on('editoropened',function(field){editorGrid.hide();});break;case ORYX.CONFIG.TYPE_SORTLIST:var editorSortList=new Ext.form.SortList({facade:this.facade,title:name,dataSource:this.dataSource,order:attribute});editorGrid=new Ext.Editor(editorSortList);break;case ORYX.CONFIG.TYPE_COMPLEX:var cf;if(pair._jsonProp.group=='forms'){cf=new Ext.form.ComplexListField({name:key,allowBlank:pair.optional(),disabled:true},pair.complexItems(),pair._jsonProp.contingencies,key,this.facade);this.popularProperties.each((prop)=>{if(prop[6].propId==="oryx-form_type"){if(prop[4]=='Form Properties'){cf=new Ext.form.ComplexListField({allowBlank:pair.optional()},pair.complexItems(),pair._jsonProp.contingencies,key,this.facade);}}});this.setFormFieldInformation(pair._jsonProp.id,cf.getId());}else{cf=new Ext.form.ComplexListField({allowBlank:pair.optional()},pair.complexItems(),pair._jsonProp.contingencies,key,this.facade);}
cf.on('dialogClosed',this.dialogClosed,{scope:this,row:index,col:1,field:cf});editorGrid=new Ext.Editor(cf);break;case ORYX.CONFIG.TYPE_MULTIPLECOMPLEX:var cf=new Ext.form.MultipleComplexListField({allowBlank:pair.optional()},pair.complexItems(),key,this.facade);cf.on('dialogClosed',this.dialogClosed,{scope:this,row:index,col:1,field:cf});editorGrid=new Ext.Editor(cf);break;case ORYX.CONFIG.TYPE_CONDITIONAL:var parentScope=this;var editorCheckbox=new Ext.form.Checkbox({boxLabel:"false"});Ext.override(Ext.form.Checkbox,{setBoxLabel:function(boxLabel){this.boxLabel=boxLabel;if(this.rendered){this.wrap.child('.x-form-cb-label').update(boxLabel);}}});var initialParents=[];if(pair._jsonProp.hasOwnProperty('conditionalParents')){pair._jsonProp.conditionalParents.each(function(parent){initialParents.push('oryx-'+parent.toLowerCase());});var initialSet=false;initialParents.each(function(parent){if(parentScope.shapeSelection.shapes[0].properties[parent]){initialSet=true;}});if(!initialSet){parentScope.editDirectly(key,"");pair.conditionallyEnabled=false;editorCheckbox.disabled=true;pair.customRenderer=function(){var shapeProps=parentScope.shapeSelection.shapes[0];var tempValue=shapeProps.properties['oryx-'+pair._jsonProp.id].toString();if(pair.conditionallyEnabled){return(tempValue.length>0)?tempValue:'false';}else{return"";}}}}
editorCheckbox.on('check',function(c,checked){editorCheckbox.setBoxLabel(checked.toString())
parentScope.editDirectly(key,checked);parentScope.handleConditionalInputs(parentScope,pair);});editorGrid=new Ext.Editor(editorCheckbox);break;default:var editorInput=new Ext.form.TextField({allowBlank:pair.optional(),msgTarget:'title',maxLength:pair.length(),enableKeyEvents:true});editorInput.on('keyup',function(input,event){this.editDirectly(key,input.getValue());}.bind(this));editorGrid=new Ext.Editor(editorInput);}
editorGrid.on('beforehide',this.facade.enableEvent.bind(this,ORYX.CONFIG.EVENT_KEYDOWN));editorGrid.on('specialkey',this.specialKeyDown.bind(this));}else if(pair.type()===ORYX.CONFIG.TYPE_URL||pair.type()===ORYX.CONFIG.TYPE_DIAGRAM_LINK){attribute=String(attribute).search("http")!==0?("http://"+attribute):attribute;attribute="<a href='"+attribute+"' target='_blank'>"+attribute.split("://")[1]+"</a>"}
if(!pair.customRenderer){pair.customRenderer=editorRenderer;}
if(pair.visible()){if(pair._jsonProp.parent===undefined||(this.hierarchicalProperties[shapeId]!==undefined&&this.hierarchicalProperties[shapeId][parentId]!==undefined&&this.hierarchicalProperties[shapeId][parentId][this.channel]!==undefined&&this.hierarchicalProperties[shapeId][parentId][this.channel].enabled)){if(pair.refToView()[0]||refToViewFlag||pair.popular()){pair.setPopular();}
if(pair.popular()){this.popularProperties.push([this.getPropertyChannel(pair),pair.groupPriority(),pair.popular(),name,attribute,icons,{editor:editorGrid,propId:key,type:pair.type(),tooltip:pair.description(),renderer:pair.customRenderer,language:pair.language()}]);}
else{this.properties.push([this.getPropertyChannel(pair),pair.groupPriority(),pair.popular(),name,attribute,icons,{editor:editorGrid,propId:key,type:pair.type(),tooltip:pair.description(),renderer:pair.customRenderer,language:pair.language()}]);}}else if(pair._jsonProp.parent!=null&&pair._jsonProp.hierarchy!=null&&pair._jsonProp.hierarchy>0){if(this.hierarchicalProperties[shapeId]===undefined)
this.hierarchicalProperties[shapeId]=[];if(this.hierarchicalProperties[shapeId][parentId]===undefined)
this.hierarchicalProperties[shapeId][parentId]=new Hash();if(this.hierarchicalProperties[shapeId][parentId][this.channel]===undefined){this.hierarchicalProperties[shapeId][parentId][this.channel]=new ORYX.Plugins.PropertyHierarchy(this.hierarchyIdChainDelimiter);this.hierarchicalProperties[shapeId][parentId][this.channel].editor=editorGrid;this.hierarchicalProperties[shapeId][parentId][this.channel].level=pair._jsonProp.hierarchy;this.hierarchicalProperties[shapeId][parentId][this.channel].properties.push(pair);}}}}).bind(this));}
this.setProperties();},handleConditionalInputs:function(context,pair){var shapeProps=context.shapeSelection.shapes[0];var ds=context.grid.getStore();var partners=[];var parents=[];var children=[];if(pair._jsonProp.hasOwnProperty('conditionalPartners')){partners.push('oryx-'+pair._jsonProp.id.toLowerCase());pair._jsonProp.conditionalPartners.each(function(partner){partners.push('oryx-'+partner.toLowerCase());})}
if(pair._jsonProp.hasOwnProperty('conditionalChildren')){pair._jsonProp.conditionalChildren.each(function(child){children.push('oryx-'+child.toLowerCase());})}
if(pair._jsonProp.hasOwnProperty('conditionalParents')){pair._jsonProp.conditionalParents.each(function(parent){parents.push('oryx-'+parent.toLowerCase());})}
var parentEnabled=false;parents.each(function(parent){if(shapeProps.properties[parent]){parentEnabled=true;}});var partnerEnabled=false;partners.each(function(partner){if(shapeProps.properties[partner]){partnerEnabled=true;}})
for(let i=0;i<context.popularProperties.length;i++){if(children.indexOf(context.popularProperties[i][5].propId)>-1){context.shapeSelection.commonProperties.each(function(pair){var elementName='oryx-'+pair._jsonProp.id;if(children.indexOf(elementName)>-1){pair.conditionallyEnabled=partnerEnabled;}});var otherId=context.popularProperties[i][5].editor.getId();var editor=Ext.getCmp(otherId);if(partnerEnabled){try{editor.enable();editor.hide();editor.render();}catch(ex){editor.render();console.log(ex);}}else{try{editor.disable(true);editor.show();pair.conditionallyEnabled=false;editor.render();}catch(ex){editor.render();console.log(ex);}}}}
context.facade.getCanvas().update();},getPropertyChannel:function(property){var propChannel=property.channel();if(property._jsonProp.channel===""&&property._jsonProp.group!==undefined&&this.propertyGroups[property._jsonProp.group.toLowerCase()]!=undefined&&this.propertyGroups[property._jsonProp.group.toLowerCase()].label!==undefined){propChannel=this.propertyGroups[property._jsonProp.group.toLowerCase()].label;}
return propChannel;},hideMoreAttrs:function(panel){if(this.properties.length<=0){return}
this.grid.view.un("refresh",this.hideMoreAttrs,this);},clearHierarchicalProperties:function(){this.hierarchicalProperties=new Array();},showHierarchicalProp:function(parent){var getPropertyValueById=function(id){firstShape.decodeChannelsBasedPropetyValues(id);return firstShape.channelsBasedPropetyValues[id][this.channel];}.bind(this);var getPropertyHierarchyArray=function(index,parent){var arrHier=[];if(this.hierarchicalProperties[shapeId][parent.name]==undefined){this.hierarchicalProperties[shapeId][parent.name]=new Hash();this.hierarchicalProperties[shapeId][parent.name][this.channel]=new ORYX.Plugins.PropertyHierarchy();this.hierarchicalProperties[shapeId][parent.name][this.channel].title=parent.title;return this.hierarchicalProperties[shapeId][parent.name][this.channel];}
arrHier[index]=this.hierarchicalProperties[shapeId][parent.name][this.channel];if(arrHier[index]===undefined||arrHier[index].length==0||arrHier[index].properties===undefined)return;var childHierarchy=parseInt(arrHier[index].level);return arrHier[index].properties.filter(function(obj){return obj._jsonProp.hierarchy==childHierarchy;});}.bind(this);var removeProperty=function(prop){this.editDirectly(prop.name,"");if(this.hierarchicalProperties[shapeId][prop.name]!==undefined&&this.hierarchicalProperties[shapeId][prop.name][this.channel]!==undefined)
this.hierarchicalProperties[shapeId][prop.name][this.channel].title="";this.properties.splice(index,1);var parentName=prop._jsonProp.prefix+"-"+prop._jsonProp.parent;this.hierarchicalProperties[shapeId][parentName][this.channel].values=[];this.hierarchicalProperties[shapeId][parentName][this.channel].enabled=false;}.bind(this);var setHierarchyDataRoot=function(index,parent){if(parent.nextData){this.hierarchyDataRootArray[index]=parent.nextData;}}.bind(this);var namespace="http://b3mn.org/stencilset/motive1.0#";var firstShape=this.shapeSelection.shapes.first();var shapeId=firstShape.id;var result=getPropertyHierarchyArray(0,parent);if(result!==undefined&&result.length>=1){if(this.hierarchicalProperties[shapeId][parent.name][this.channel].enabled){if(firstShape.hierarchicalPropertiesHash!==undefined&&firstShape.hierarchicalPropertiesHash[this.channel]!==undefined)
firstShape.hierarchicalPropertiesHash[this.channel]=new Hash();this.hierarchicalProperties[shapeId][parent.name][this.channel].values.pop();this.hierarchicalProperties[shapeId][parent.name][this.channel].values.push(parent.value);this.hierarchicalProperties[shapeId][parent.name][this.channel].title=parent.title;var hideProp=parent;if(parent.hasChildren){hideProp=result[0];hideProp.name=hideProp._jsonProp.prefix+"-"+hideProp._jsonProp.id;this.editDirectly(hideProp.name,"");if(this.hierarchicalProperties[shapeId]===undefined){this.hierarchicalProperties[shapeId]=new Hash();}
if(this.hierarchicalProperties[shapeId][hideProp.name]===undefined){this.hierarchicalProperties[shapeId][hideProp.name]=new Hash();}
if(this.hierarchicalProperties[shapeId][hideProp.name][this.channel]===undefined){this.hierarchicalProperties[shapeId][hideProp.name][this.channel]=new Hash();}
this.hierarchicalProperties[shapeId][hideProp.name][this.channel].title="";setHierarchyDataRoot(hideProp._jsonProp.hierarchy,parent);}
var depth=this.hierarchicalProperties[shapeId][parent.name][this.channel].depth;for(var i=1;i<=depth;i++){result=getPropertyHierarchyArray(i,hideProp);if(result!==undefined&&result.length>=1){var hideProp=result[0];var propTitle=hideProp.title();var index=-1;this.properties.each(function(prop,i){if(hideProp.title()==prop[2])
index=i;});hideProp.name=hideProp._jsonProp.prefix+"-"+hideProp._jsonProp.id;if(index>=0){removeProperty(hideProp);}}}}else if(parent.hasChildren){var newProp=result[0];var newPropChannel=newProp.channel();this.hierarchicalProperties[shapeId][parent.name][this.channel].shapeId=shapeId;this.hierarchicalProperties[shapeId][parent.name][this.channel].enabled=true;this.hierarchicalProperties[shapeId][parent.name][this.channel].title=parent.title;setHierarchyDataRoot(newProp._jsonProp.hierarchy,parent);var key=newProp.prefix()+"-"+newProp.id();var group="";var matches=/^(\w+)(\d+)$/.exec(newProp.id());if(!matches){matches=/^([a-zA-Z-]+)(\d+)$/.exec(newProp.id());}
if(matches){group=matches[1];}
var name=newProp.title();var icons=[];this.hierarchicalProperties[shapeId][parent.name][this.channel].values=[];for(var i=0;i<newProp._jsonProp.hierarchy;i++){var propId=group+(i+1);var propKey=(parent.nextData!==undefined)?parent.name:newProp.prefix()+"-"+propId;if(parent.nextData===undefined&&i+1<newProp._jsonProp.hierarchy){this.hierarchicalProperties[shapeId][parent.name][this.channel].values.push(getPropertyValueById(propKey));}else{this.hierarchicalProperties[shapeId][parent.name][this.channel].values.push(parent.value);}
this.hierarchicalProperties[shapeId][propKey][this.channel].depth=newProp._jsonProp.hierarchy-i;}
this.editDirectly(key,"");this.properties.push([newProp.channel(),newProp.popular(),name,"",icons,{editor:this.hierarchicalProperties[shapeId][parent.name][this.channel].editor,propId:key,type:newProp.type(),tooltip:newProp.description(),renderer:null}]);}else{this.hierarchicalProperties[shapeId][parent.name][this.channel].title=parent.title;}}else if(result!==undefined){this.hierarchicalProperties[shapeId][parent.name][this.channel].title=parent.title;}else{this.hierarchicalProperties[shapeId][parent.name][this.channel]=new ORYX.Plugins.PropertyHierarchy();this.hierarchicalProperties[shapeId][parent.name][this.channel].title=parent.title;}},setProperties:function(){var props=this.popularProperties.concat(this.properties);this.dataSource.loadData(props);ORYX.Plugins.PropertyWindow.dataSource=this.dataSource;},trimHMLTitles:function(){var panel=$j('.x-panel-editor-east');if(panel.length){var regex=new RegExp("^hml\\d+-([-a-zA-Z0-9 _]+)$");$j("div.x-grid3-cell-inner").each(function(index,label){var matches=regex.exec($j(label).text());if(matches){$j(label).text(matches[1]);}});}},handleSpecialtyComboLaunchButton:function(key,value){var editor=this.getSpecialtyEditor(key,null,value);},showAuxiliaryPropertyButtons:function(){if(!$j.isEmptyObject(this.auxiliaryPropertyButtonsHash)){for(var key in this.auxiliaryPropertyButtonsHash){var button=this.auxiliaryPropertyButtonsHash[key];var body=$j(button.body);var td=body.find(button.el).filter("[title='"+button.title+"']");var launchButton=$j('<span/>').addClass('property-specialty-editor-launch').attr('title','Launch Selection');var launchHandler=this.handleSpecialtyComboLaunchButton.bind(this,key,button.value);td.addClass('property-auxiliary-button').append(launchButton);launchButton.on('click',launchHandler);delete button;}}},addToActivityOrder:function(shapes){var activityOrder=this.facade.getActivityOrder();var nextIndex=0;$j.each(shapes,function(i,shape){if(this.isPofActivity(shape)){activityOrder.push(shape._stencil._jsonStencil.internalName);}}.bind(this));},deleteFromActivityOrder:function(shapes){var index;var activityOrder=this.facade.getActivityOrder();$j.each(shapes,function(i,shape){index=activityOrder.indexOf(shape._stencil._jsonStencil.internalName);activityOrder.splice(index,1);}.bind(this));},isPofActivity:function(shape){return shape.properties['oryx-type']!=='ENTRY'&&shape.properties['oryx-type']!=='EXIT';},maximizeEditor:function(window){var editorHeaderHeight=$j('#oryx_editor_header').height();var size=window.getSize();size.height=size.height-editorHeaderHeight;window.setSize(size);window.setPosition(0,editorHeaderHeight);},scrollGridBottom:function(){var visibleProperties=this.shapeSelection.commonProperties.filter(function(prop){return prop._jsonProp.visible;});this.grid.getView().focusRow(visibleProperties.length-1);}}
ORYX.Plugins.PropertyWindow=Clazz.extend(ORYX.Plugins.PropertyWindow);ORYX.Plugins.PropertyHierarchy={construct:function(delimiter){this.shapeId=null;this.editor=null;this.depth=0;this.level=0;this.enabled=false;this.properties=[];this.delimiter=delimiter;this.title=null;this.values=[];this.init();},init:function(){ORYX.Log.debug("PropertyHierarchy.init");},getValuesChain:function(){return this.values.join(this.delimiter);}};ORYX.Plugins.PropertyHierarchy=Clazz.extend(ORYX.Plugins.PropertyHierarchy);ORYX.Plugins.PropertyWindow.getNamedSequences=function(node){var named=[];try{var outgoing=node.getOutgoingShapes();if(outgoing.length>0){outgoing.each(function(shape,index){if(shape instanceof ORYX.Core.Shape){var stencil=shape.getStencil();if(stencil.id().search("#SequenceFlow")>-1&&shape.properties!==undefined&&shape.properties["oryx-conditiontype"]==="Named"){var shapeExpression=(shape.properties["oryx-name"]!==undefined)?shape.properties["oryx-name"]:shape.properties["oryx-conditionexpression"];named.push({expression:shapeExpression,type:shape.properties["oryx-conditiontype"],id:shape.resourceId});}}});}}catch(e){Ext.Msg.alert('Error','Live preview failed to get outgoing transitions.');ORYX.Log.error('Live preview failed to get outgoing transitions. Error: '+e);}
return named;};Ext.form.ExpressionBuilderPanel=Ext.extend(Ext.Panel,{value:null,language:null,_initialized:false,initComponent:function(){Motive.Dictionary.init({language:this.language,useScriptDelimiters:false,editorName:"aceEditor"});var dictionaryPanel=Motive.Dictionary.getDictionaryPanel();this.txtEditor=new Ext.form.TextArea({value:Ext.util.Format.htmlEncode(this.value),listeners:{focus:function(){this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);}.bind(this)}});this.searchField=new Ext.form.TextField({id:'scriptTbSearchField',emptyText:'enter search term'});this.searchButton=new Ext.SplitButton({text:'Find Next',cls:'x-btn-text-icon',icon:ORYX.PATH+"images/silk/find.png",handler:function(){this.find();}.bind(this),menu:{items:[{id:'findNext',text:'Find Next',iconCls:'menuItemOn',handler:function(){this.findNext();}.bind(this)},{id:'findPrevious',text:'Find Previous',handler:function(){this.findPrevious();}.bind(this)},{id:'findAll',text:'Find All',handler:function(){this.findAll();}.bind(this)}]}});var tb=new Ext.Toolbar({items:[{text:'Insert',menu:{xtype:'menu',plain:true,items:[{text:'function',handler:function(){this.insertFunction();}.bind(this)},{text:'if',handler:function(){this.insertIf();}.bind(this)},{text:'if/else',handler:function(){this.insertIfElse();}.bind(this)}]}},'-',{tooltip:'Undo',cls:"x-btn-icon",icon:ORYX.PATH+"images/silk/arrow_undo.png",handler:function(){this.undo();}.bind(this)},{tooltip:'Redo',cls:"x-btn-icon",icon:ORYX.PATH+"images/silk/arrow_redo.png",handler:function(){this.redo();}.bind(this)},'->',this.searchField,this.searchButton]});this.editorFindOptions={wrap:true,caseSensitive:false,wholeWord:false,regExp:false};var cfg={layout:'border',tbar:tb,items:[{region:'center',layout:'fit',items:this.txtEditor},dictionaryPanel]};Ext.apply(this,cfg);Ext.form.ExpressionBuilderPanel.superclass.initComponent.call(this);},isInitialized:function(){return this._initialized;},insertFunction:function(){this.editor.insert('function() {\r\n}\r\n');this.editor.focus();},insertIf:function(){this.editor.insert('if() {\r\n}\r\n');this.editor.focus();},insertIfElse:function(){this.editor.insert("if() {\r\n} else {\r\n}\r\n");this.editor.focus();},find:function(){var searchString=this.searchField.getValue();if(searchString.length){var range=null;switch(this.searchButton.getText()){case'Find Previous':this.editorFindOptions.backwards=true;range=this.editor.find(searchString,this.editorFindOptions);break;case'Find All':this.editorFindOptions.backwards=false;range=this.editor.findAll(searchString,this.editorFindOptions,false);break;default:this.editorFindOptions.backwards=false;range=this.editor.find(searchString,this.editorFindOptions);}
if(!range)
Ext.Msg.show({title:"Attention",msg:searchString+" not found",buttons:Ext.Msg.OK,animEl:'elId',icon:Ext.MessageBox.WARNING,minWidth:250});}else{Ext.Msg.show({title:"Attention",msg:"No search term was entered.",buttons:Ext.Msg.OK,animEl:'elId',icon:Ext.MessageBox.WARNING,minWidth:250});}
this.editor.focus();},findNext:function(){this.searchButton.setText('Find Next');this.selectSearchButtonMenuItem('findNext');this.find();},findPrevious:function(){this.searchButton.setText('Find Previous');this.selectSearchButtonMenuItem('findPrevious');this.find();},findAll:function(){this.searchButton.setText('Find All');this.selectSearchButtonMenuItem('findAll');this.find();},selectSearchButtonMenuItem:function(id){this.searchButton.menu.items.items._each(function(item){var className=(item.getId()==id)?'menuItemOn':'';item.setIconClass(className);});},redo:function(){this.editor.redo();this.editor.focus();},undo:function(){this.editor.undo();this.editor.focus();},show:function(){this._initialized=false;Ext.form.ExpressionBuilderPanel.superclass.show.call(this);var fixSize={height:0,width:0};this.editor=ace.edit(this.txtEditor.container.id);this.editor.setTheme("ace/theme/chrome");this.editor.getSession().setValue(this.value);this.editor.focus();if(this.language=='Javascript'){this.editor.getSession().setMode("ace/mode/javascript");}
this.txtEditor.onResize=function(){this.editor.resize();}.bind(this);this._initialized=true;Motive.Dictionary.load(this.editor);},destroy:function(){this.editor.remove();Ext.form.ExpressionBuilderPanel.superclass.destroy.call(this);},getValue:function(){return this.editor.getSession().getValue();}});Ext.form.ExpressionField=Ext.extend(Ext.form.TriggerField,{defaultAutoCreate:{tag:"textarea",rows:1,style:"height:16px;overflow:hidden;"},scriptLanguage:null,initComponent:function(){var cfg={triggerClass:'icon-function'};Ext.apply(this,cfg);Ext.form.ExpressionField.superclass.initComponent.call(this);},onTriggerClick:function(e){this.suspendEvents();scriptLanguage='Juel';if(this.language){scriptLanguage=this.language;}
if(this.scriptLanguage){if(this.dataSource){for(var i=0;i<this.dataSource.data.items.length;i++){var dataObj=this.dataSource.data.items[i].data;if('Language'==dataObj.name){scriptLanguage=dataObj.value;}else{var fieldIds=['execution_listener_script_format','input_script_format','output_script_format','task_listener_script_format'];$j.each(fieldIds,function(i,id){if(dataObj.hasOwnProperty(id)){scriptLanguage=dataObj[id].capitalizeFirstLetter();return false;}});}}}}
this.showExpressionBuilder();},showExpressionBuilder:function(){var expBuilderPanel=new Ext.form.ExpressionBuilderPanel({value:this.getRawValue(),language:scriptLanguage});var dialog=null;var self=this;var closingDialog=false;function closeDialog(cancel,forceCancel){if(!forceCancel&&closingDialog)return;closingDialog=true;if(cancel==null)
cancel=true;if(!expBuilderPanel.isInitialized()){window.setTimeout(function(){closeDialog(cancel,true)},100);return;}
self.resumeEvents();dialog.close();self.fireEvent('dialogClosed',self.value,cancel);}
dialog=new Ext.Window({layout:'fit',autoCreate:true,title:ORYX.I18N.PropertyWindow.expression_builder+' | '+scriptLanguage,height:480,width:776,modal:true,collapsible:false,closable:false,resizable:true,fixedcenter:true,shadow:true,proxyDrag:true,maximizable:true,keys:[{key:27,fn:function(){closeDialog(true);}}],items:[expBuilderPanel],listeners:{scope:this,show:function(){expBuilderPanel.show();if(this.grid!==undefined){this.grid.stopEditing();}},hide:function(){if(this.validateFn!==undefined&&typeof this.validateFn=='function'){this.validateFn();}}},buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){var value=expBuilderPanel.getValue();this.focus();this.setValue(value);if(this.dataSource&&this.row!==undefined){this.dataSource.getAt(this.row).set('value',value);this.dataSource.commitChanges();}
closeDialog(false);}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.setValue(this.value);closeDialog(true);}.bind(this)}]});dialog.show();}});Ext.form.CondensedMultiSelectField=Ext.extend(Ext.form.TextField,{});Ext.form.SignalCfgGrid=Ext.extend(Ext.grid.EditorGridPanel,{fields:null,activeRow:-1,removedSignals:[],view:new Ext.grid.GridView({getRowClass:function(record,rowParams,store){if(record.data['default']==true){return"default-edge";}}}),_editObj:null,_facade:null,initComponent:function(){var autoExpandColumn=null;this._facade=ORYX.Plugins.PropertyWindow.facade;if(this.cm==null){this.selModel=new Ext.grid.RowSelectionModel({singleSelect:true,listeners:{beforerowselect:function(sm,i,ke,row){this.selectedIndex=i;var ele=Ext.fly(grid.getView().getRow(i)).child("table");grid.ddText="<table>"+ele.dom.innerHTML.replace(/&nbsp;/g,"")+"</table>";}}});var columns=[{id:'order',header:"Order",width:55,sortable:false,dataIndex:'order',editor:new Ext.form.TextField({regex:/^[1-9][0-9]*$/,regexText:'Value must be a number greater than 0'})},{header:"Signal Name",width:100,sortable:false,renderer:Ext.util.Format.htmlEncode,dataIndex:'name'}];if(this.fields!=null){if(this.fields.indexOf("displayName")>=0){var cf=new Ext.form.HtmlField({allowBlank:true,dataSource:this.store,dataIndex:'displayName',grid:this.grid,selectionModel:this.selModel,propertyTitle:'Signal Display Name',facade:this._facade,stencilType:ORYX.CONFIG.TYPE_HTML_MIN,hasDictionary:true,readOnly:true});cf.availableLanguagesCfg=this._facade.getLocaleConfigString();var editor=new Ext.Editor(cf);columns.push({id:"displayname",header:"Display Name",width:150,sortable:false,dataIndex:'displayName',tooltip:"The text to display when referring to this signal to the user.  If not specified then the ID will be displayed to the user",renderer:Ext.util.Format.htmlEncode,editor:editor});}
if(this.fields.indexOf("helpText")>=0){var cf=new Ext.form.HtmlField({allowBlank:true,dataSource:this.store,dataIndex:'helpText',grid:this.grid,selectionModel:this.selModel,propertyTitle:'Signal Help Text',facade:this._facade,stencilType:ORYX.CONFIG.TYPE_HTML_MIN,hasDictionary:true,readOnly:true});cf.availableLanguagesCfg=this._facade.getLocaleConfigString();var editor=new Ext.Editor(cf);columns.push({id:"helptext",header:"Help Text",width:150,dataIndex:'helpText',tooltip:"Text to display to the user to provide additional information about the signal",sortable:false,renderer:Ext.util.Format.htmlEncode,editor:editor});}
if(this.fields.indexOf("expression")>=0){columns.push({id:"expression",header:"Expression",width:200,dataIndex:'expression',tooltip:"Expression to evaluate to determine if the signal should be taken if the expression resolves to true at runtime.",sortable:false,renderer:Ext.util.Format.htmlEncode,editor:new Ext.form.ExpressionField({allowBlank:true,width:200,grid:this.grid})});}
if(this.fields.indexOf("roles")>=0){var rolesArray=[];if(Motive.applicationRoles){Motive.applicationRoles.each(function(s,index){rolesArray.push([s,s]);});}
var rolesStore=new Ext.data.SimpleStore({data:rolesArray,sortInfo:{field:'text'},fields:['value','text']});columns.push({id:"roles",header:"Roles",width:200,dataIndex:'roles',sortable:false,renderer:Ext.util.Format.htmlEncode,editor:new Ext.form.MultiSelectField({allowBlank:true,store:rolesStore,containerHeight:300})});}
if(this.fields.indexOf("rrcodes")>=0){var msfDisabled=false;var selectedTestModule=this.testModule;ORYX.Log.debug("Ext.form.SignalCfgGrid.initComponent: selectedTestModule = "+selectedTestModule);var _getModelAnalysesFromStencil=function(testModule){var returnArray=[];this._facade.getStencilSets().values().each(function(sset){sset.stencils().each(function(stencil){if(stencil.type()==="node"&&stencil.id().indexOf("motv-so-")>=0){var id="";var matches=/^http.+#motv-so-(.+)$/.exec(stencil.id());if(matches)
id=matches[1];if(id===testModule){var modelAnalysesProp=stencil.property('oryx-modelanalyses');if(modelAnalysesProp!==undefined&&modelAnalysesProp.items()){modelAnalysesProp.items().each(function(it){returnArray.push([it.value(),it.value()]);ORYX.Log.debug("Ext.form.SignalCfgGrid.initComponent: modelAnalysesProp > "+it.value());});}}}});});return returnArray;}.bind(this);var rrCodesArray=[];rrCodesArray=_getModelAnalysesFromStencil(selectedTestModule);msfDisabled=(rrCodesArray.length<1||selectedTestModule==null)?true:false;var rrCodesStore=new Ext.data.SimpleStore({data:rrCodesArray,sortInfo:{field:'text'},fields:['value','text']});columns.push({id:"testModule",header:"Service Operation",width:100,dataIndex:"testModule",sortable:false,renderer:Ext.util.Format.htmlEncode,hidden:true});columns.push({id:"rrcodes",header:"Recommended Resolution Codes",width:200,dataIndex:'rrcodes',sortable:false,renderer:Ext.util.Format.htmlEncode,editor:new Ext.form.MultiSelectField({allowBlank:true,store:rrCodesStore,disabled:msfDisabled,containerHeight:300})});}}
if(this.autoExpandColumn==null||!this.autoExpandColumn)
this.autoExpandColumn=columns[columns.length-1].id;this.cm=new Ext.grid.ColumnModel(columns);}
var grid=this;var cfg={enableDragDrop:true,enableColumnHide:false,enableColumnMove:false,enableHdMenu:false,clicksToEdit:1,stripeRows:true,ddGroup:'signalcfggrid-dd',bbar:(this.fields.indexOf("default")>=0)?[{iconCls:"icon-add",text:"Set Default Signal",handler:function(){var ds=this.getStore();var selected=this.selModel.getSelected();var selectedIndex=-1;for(var r=0;r<ds.data.length;r++){if(ds.data.itemAt(r)===selected){if(ds.data.itemAt(r).data['default']===true||ds.data.itemAt(r).data['default']===false){ds.data.itemAt(r).data['default']=!ds.data.itemAt(r).data['default'];}
else{ds.data.itemAt(r).data['default']=true;}}
else{ds.data.itemAt(r).data['default']=false;}}
this.getView().refresh();},scope:this}]:[]};Ext.apply(this,cfg);Ext.form.SignalCfgGrid.superclass.initComponent.call(this);this.on('keydown',function(e){var stopProp=true;var sm=this.getSelectionModel();var selectedRow=sm.getSelected();if(selectedRow!=null){var store=this.getStore();switch(e.keyCode){case e.ENTER:case e.SPACE:this.toggleRowActivation(store.indexOf(selectedRow));break;default:stopProp=false;};}
if(stopProp)
e.stopPropagation();});this.on('validateedit',function(e){if(e.field==='order'){var rowIndex=e.row;var newIndex=this.reorderRow(rowIndex,parseInt(e.value));var sm=this.getSelectionModel();sm.selectRow(newIndex);return false;}
return true;});this.on({"beforeedit":{fn:function(obj){this._editObj=obj;},scope:this},"afteredit":{fn:function(obj){this._editObj=null;},scope:this}});},getRemovedSignalIds:function(){return this.removedSignals;},toggleRowActivation:function(rowIndex){var activate=this.activeRow!=rowIndex;if(this.activeRow>-1){this.activeRow=-1;}
if(activate&&rowIndex>=0){this.activeRow=rowIndex;}},reorderRow:function(rowIndex,newOrder){var store=this.getStore();var rowData=store.getAt(rowIndex);if(rowData==null)return rowIndex;var oldOrder=rowData.get("order");if(oldOrder==newOrder)return rowIndex;var nextAvailableOrder=this.getNextAvailableOrder();if(newOrder<=0||newOrder>nextAvailableOrder)
newOrder=nextAvailableOrder;var targetIndex=this._getRecordIndexByOrder(newOrder);if(targetIndex==-1){targetIndex=store.getCount()-1;}
if(oldOrder<newOrder){var lastOrder=-1;for(var i=rowIndex+1;i<=targetIndex;i++){var record=store.getAt(i);lastOrder=record.get("order")-1;record.set("order",lastOrder);}
newOrder=lastOrder+1;rowData.set("order",newOrder);}else{rowData.set("order",newOrder);for(var i=targetIndex;i<rowIndex;i++){var record=store.getAt(i);record.set("order",record.get("order")+1);}}
store.sort("order","ASC");return this._getRecordIndexByOrder(newOrder);},getNextAvailableOrder:function(){var store=this.getStore();if(store.getCount()<=0)
return 1;return store.getAt(store.getCount()-1).get("order")+1;},_getRecordIndexByOrder:function(order){var store=this.getStore();return store.find("order",String(order));},afterRender:function(){Ext.form.SignalCfgGrid.superclass.afterRender.apply(this,arguments);var grid=this;this.dtarget=new Ext.dd.DropTarget(this.getView().mainBody,{ddGroup:'signalcfggrid-dd',notifyDrop:function(dd,e,data){var sm=grid.getSelectionModel();var row=sm.getSelected();if(row!=null){var store=grid.getStore();var selectedIndex=store.indexOfId(row.id);var cindex=dd.getDragData(e).rowIndex;var targetRow=store.getAt(cindex);sm.selectRow(grid.reorderRow(selectedIndex,targetRow.get("order")));}}});this.rowNav=new Ext.KeyNav(this.getGridEl(),{"up":function(e){var sm=this.getSelectionModel();var store=this.getStore();if(this.activeRow>0){this.activeRow=this.reorderRow(this.activeRow,store.getAt(this.activeRow).get("order")-1);sm.selectRow(this.activeRow);e.stopEvent();}},"down":function(e){var sm=this.getSelectionModel();var store=this.getStore();if(this.activeRow>=0&&this.activeRow<store.getCount()-1){this.activeRow=this.reorderRow(this.activeRow,store.getAt(this.activeRow).get("order")+1);sm.selectRow(this.activeRow);e.stopEvent();}},"scope":this});this.focus(false,500);if(this.getStore().getCount()>0){if(this.selectRec){this.getSelectionModel().selectRecords([this.store.data.items[this.selectRec]],false);}
else{this.getSelectionModel().selectRow(0);this.getView().focusRow(0);}}}});Ext.form.SignalCfgField=Ext.extend(Ext.form.TriggerField,{current_signal_names:[],fields:null,initComponent:function(){var cfg={};this.addEvents("editoropened","editorclosed");Ext.apply(this,cfg);Ext.form.SignalCfgField.superclass.initComponent.call(this);},onTriggerClick:function(){try{if(this.disabled){return;}
if(this.fields==null){this.fields=['displayName','helpText'];}
if(this.current_signal_names==null)
this.current_signal_names=[];var sigIdToNameMap={};Ext.each(this.current_signal_names,function(sig){sigIdToNameMap[sig.id]=sig.name;});var selectedTestModule=null;if(this.fields.indexOf("rrcodes")>=0){selectedTestModule=this.parentscope.shapeSelection.commonPropertiesValues['oryx-testmodule'];if(selectedTestModule==null){Ext.Msg.alert('Signal Properties','You must select a <b>Service Operation</b> before configuring this property.');return;}}
ORYX.Plugins.PropertyWindow.selectedTestModule=selectedTestModule;var currentData=this.value;if(currentData==null||currentData==""){currentData="{signals:[]}";}
currentData=Ext.util.JSON.decode(currentData);var current_signals=this.current_signal_names.slice(0);var sigsToConfig=[];var unconfiguredSigs={};Ext.apply(unconfiguredSigs,sigIdToNameMap);Ext.each(currentData.signals,function(sig){if(unconfiguredSigs[sig.id]!=null){for(var key in sig){var thing=sig[key];if(typeof thing==='object'&&thing.hasOwnProperty("values")){var newValue=JSON.stringify(thing).replace(/\\"/g,'"');newValue=newValue.replace(/"\[/,'[').replace(/\]"/,']');sig[key]=newValue;}}
sigsToConfig.push(sig);delete unconfiguredSigs[sig.id];}});sigsToConfig.sort(function(a,b){if(a.order<b.order)return-1;if(a.order==b.order)return 0;return 1;});for(var sigid in unconfiguredSigs){var obj={id:sigid,name:unconfiguredSigs[sigid]};if(selectedTestModule!=null){obj.testModule=selectedTestModule;}
sigsToConfig.push(obj);}
var currentOrd=1;for(var i=0;i<sigsToConfig.length;i++){sigsToConfig[i].order=currentOrd;currentOrd++;}
var storeFields=[{name:'order',type:'int'},'id',{name:'name',type:'string',convert:function(v,rec){return sigIdToNameMap[rec.id]||"New Signal";}}];storeFields=storeFields.concat(this.fields);var ds=new Ext.data.JsonStore({root:'signals',fields:storeFields,data:{signals:sigsToConfig},sortInfo:{field:'order',direction:'ASC'}});var centerPanel=new Ext.form.SignalCfgGrid({region:'center',layout:'fit',store:ds,grid:this.grid,currentSignals:this.current_signal_names,fields:this.fields,testModule:selectedTestModule});var dialog=null;var self=this;var closingDialog=false;function closeDialog(cancel,forceCancel){if(!forceCancel&&closingDialog)return;closingDialog=true;if(cancel==null)
cancel=true;self.fireEvent("editorclosed",this);self.facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);dialog.close();self.fireEvent('dialogClosed',self.value,cancel);}
dialog=new Ext.Window({layout:'border',autoCreate:true,title:ORYX.I18N.PropertyWindow.signalconfig,height:480,width:776,modal:true,collapsible:false,closable:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){closeDialog(true);}}],items:[centerPanel],listeners:{show:{fn:function(){this.fireEvent("editoropened",this);this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);},scope:this}},buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){var val=[];ds.each(function(rec){val.push(rec.data);});var removedSignals=centerPanel.getRemovedSignalIds();var value=Ext.util.JSON.encode({signals:val});this.setValue(value);this.dataSource.getAt(this.row).set('value',value)
this.dataSource.commitChanges()
closeDialog(false);}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){closeDialog(true);}.bind(this)}]});dialog.show();this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);}catch(e){ORYX.Log.error("Ext.form.SignalCfgField.onTriggerClick: "+e);}}});Ext.form.MultipleComplexListField=function(config,items,key,facade){Ext.form.MultipleComplexListField.superclass.constructor.call(this,config);this.items=items;this.key=key;this.facade=facade;};Ext.extend(Ext.form.MultipleComplexListField,Ext.form.TriggerField,{triggerClass:'x-form-complex-trigger',readOnly:true,emptyText:ORYX.I18N.PropertyWindow.clickIcon,buildValue:function(){var ds=this.grid.getStore();ds.commitChanges();if(ds.getCount()==0){return"";}
var jsonString="[";for(var i=0;i<ds.getCount();i++){var data=ds.getAt(i);jsonString+="{";for(var j=0;j<this.items.length;j++){var key=this.items[j].id();jsonString+=key+':'+(""+data.get(key)).toJSON();if(j<(this.items.length-1)){jsonString+=", ";}}
jsonString+="}";if(i<(ds.getCount()-1)){jsonString+=", ";}}
jsonString+="]";jsonString="{'totalCount':"+ds.getCount().toJSON()+", 'items':"+jsonString+"}";return Object.toJSON(jsonString.evalJSON());},getFieldKey:function(){return this.key;},getValue:function(){if(this.grid){return this.buildValue();}else if(this.data==undefined){return"";}else{return this.data;}},setValue:function(value){if(value.length>0&&value.indexOf('<')==-1){if(this.data==undefined){this.data=value;}}},keydownHandler:function(event){return false;},dialogListeners:{show:function(){this.onFocus();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_KEYDOWN,this.keydownHandler.bind(this));this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);return;},hide:function(){var dl=this.dialogListeners;this.dialog.un("show",dl.show,this);this.dialog.un("hide",dl.hide,this);this.dialog.destroy(true);this.grid.destroy(true);delete this.grid;delete this.dialog;this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_KEYDOWN,this.keydownHandler.bind(this));this.facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);this.fireEvent('dialogClosed',this.data);Ext.form.ComplexListField.superclass.setValue.call(this,this.data);}},buildInitial:function(recordType,items){var initial=new Hash();for(var i=0;i<items.length;i++){var id=items[i].id();initial[id]=items[i].value();}
var RecordTemplate=Ext.data.Record.create(recordType);return new RecordTemplate(initial);},buildColumnModel:function(parent){var cols=[];for(var i=0;i<this.items.length;i++){var id=this.items[i].id();var header=this.items[i].name();var width=this.items[i].width();var type=this.items[i].type();var editor;if(type==ORYX.CONFIG.TYPE_STRING){editor=new Ext.form.TextField({allowBlank:this.items[i].optional(),width:width});}else if(type==ORYX.CONFIG.TYPE_CHOICE){var items=this.items[i].items();var select=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",parent,['select',{style:'display:none'}]);var optionTmpl=new Ext.Template('<option value="{value}">{title}</option>');items.each(function(value){optionTmpl.append(select,{title:value.title(),value:value.value()});});editor=new Ext.form.ComboBox({typeAhead:true,triggerAction:'all',transform:select,lazyRender:true,msgTarget:'title',width:width});}else if(type==ORYX.CONFIG.TYPE_BOOLEAN){editor=new Ext.form.Checkbox({width:width});}else if(type==ORYX.CONFIG.TYPE_COMPLEX){continue;}
cols.push({id:id,header:header,dataIndex:id,resizable:true,editor:editor,width:width});}
return new Ext.grid.ColumnModel(cols);},buildSecondColumnModel:function(parent){var cols=[];for(var i=0;i<this.items.length;i++){var parentType=this.items[i].type();if(parentType!=ORYX.CONFIG.TYPE_COMPLEX){continue;}
var complexItems=this.items[i].complexItems();for(var j=0;j<complexItems.length;j++){var id=complexItems[j].id();var header=complexItems[j].name();var type=complexItems[j].type();var width=complexItems[j].width();var editor;if(type==ORYX.CONFIG.TYPE_STRING){editor=new Ext.form.TextField({allowBlank:complexItems[j].optional(),width:width});}else if(type==ORYX.CONFIG.TYPE_CHOICE){var items=complexItems[j].items();var select=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",parent,['select',{style:'display:none'}]);var optionTmpl=new Ext.Template('<option value="{value}">{title}</option>');items.each(function(value){optionTmpl.append(select,{title:value.title(),value:value.value()});});editor=new Ext.form.ComboBox({typeAhead:true,triggerAction:'all',transform:select,lazyRender:true,msgTarget:'title',width:width});}else if(type==ORYX.CONFIG.TYPE_BOOLEAN){editor=new Ext.form.Checkbox({width:width});}else if(type==ORYX.CONFIG.TYPE_COMPLEX){continue;}
cols.push({id:id,header:header,dataIndex:id,resizable:true,editor:editor,width:width});}}
return new Ext.grid.ColumnModel(cols);},afterEdit:function(option){option.grid.getStore().commitChanges();},afterEditSecondGrid:function(option){this.secondGrid.getStore().commitChanges();var selectedCell=this.grid.getSelectionModel().getSelectedCell();if(selectedCell.length==2){var row=selectedCell[0];var jsonString="[";for(var i=0;i<this.secondGrid.getStore().getCount();i++){var data=this.secondGrid.getStore().getAt(i);jsonString+="{";for(var j=0;j<this.items.length;j++){var parentType=this.items[j].type();if(parentType!=ORYX.CONFIG.TYPE_COMPLEX){continue;}
var complexItems=this.items[j].complexItems();for(var k=0;k<complexItems.length;k++){var key=complexItems[k].id();jsonString+=key+':'+(""+data.get(key)).toJSON();if(k<(complexItems.length-1)){jsonString+=", ";}}}
jsonString+="}";if(i<(this.secondGrid.getStore().getCount()-1)){jsonString+=", ";}}
jsonString+="]";jsonString="{'totalCount':"+this.secondGrid.getStore().getCount().toJSON()+", 'items':"+jsonString+"}";var activeRecord=this.grid.getStore().getAt(row);activeRecord.set(this.complexFieldId,Object.toJSON(jsonString.evalJSON()));}},beforeEdit:function(option){var state=this.grid.getView().getScrollState();var col=option.column;var row=option.row;var editId=this.grid.getColumnModel().config[col].id;for(var i=0;i<this.items.length;i++){if(this.items[i].type()==ORYX.CONFIG.TYPE_COMPLEX){continue;}
var item=this.items[i];var disables=item.disable();if(disables!=undefined){var value=this.grid.getStore().getAt(row).get(item.id());for(var j=0;j<disables.length;j++){var disable=disables[j];if(disable.value==value){for(var k=0;k<disable.items.length;k++){var disItem=disable.items[k];if(disItem==editId){this.grid.getColumnModel().getCellEditor(col,row).disable();return;}}}}}}
this.grid.getColumnModel().getCellEditor(col,row).enable();},onTriggerClick:function(){if(this.disabled){return;}
var dialogWidth=0;var recordType=[];var secondRecordType=[];this.complexFieldId;var complexItems;for(var i=0;i<this.items.length;i++){var id=this.items[i].id();var width=this.items[i].width();var type=this.items[i].type();if(type==ORYX.CONFIG.TYPE_CHOICE){type=ORYX.CONFIG.TYPE_STRING;}
if(type==ORYX.CONFIG.TYPE_COMPLEX){this.complexFieldId=id;type=ORYX.CONFIG.TYPE_STRING;complexItems=this.items[i].complexItems();for(var j=0;j<complexItems.length;j++){var secondId=complexItems[j].id();var secondWidth=complexItems[j].width();var secondType=complexItems[j].type();if(secondType==ORYX.CONFIG.TYPE_CHOICE){secondType=ORYX.CONFIG.TYPE_STRING;}
secondRecordType[j]={name:secondId,type:secondType};}}else{dialogWidth+=width;}
recordType[i]={name:id,type:type};}
if(dialogWidth>800){dialogWidth=800;}
dialogWidth+=22;var data=this.data;if(data==""){data="{}";}
var ds=new Ext.data.Store({proxy:new Ext.data.MemoryProxy(eval("("+data+")")),reader:new Ext.data.JsonReader({root:'items',totalProperty:'totalCount'},recordType)});ds.load();var secondDs=new Ext.data.Store();var cm=this.buildColumnModel();var secondCm=this.buildSecondColumnModel();var toolbar=new Ext.Toolbar([{text:ORYX.I18N.PropertyWindow.add,ctCls:'motiveEditorBtnAdd',handler:function(){var ds=this.grid.getStore();var index=ds.getCount();this.grid.stopEditing();var p=this.buildInitial(recordType,this.items);ds.insert(index,p);ds.commitChanges();this.grid.startEditing(index,0);}.bind(this)},{text:ORYX.I18N.PropertyWindow.rem,ctCls:'motiveEditorBtnRemove',handler:function(){var ds=this.grid.getStore();var selection=this.grid.getSelectionModel().getSelectedCell();if(selection==undefined){return;}
this.grid.getSelectionModel().clearSelections();this.grid.stopEditing();var record=ds.getAt(selection[0]);ds.remove(record);ds.commitChanges();}.bind(this)}]);this.grid=new Ext.grid.EditorGridPanel({store:ds,cm:cm,stripeRows:true,clicksToEdit:1,autoScroll:true,stateId:"x-editor-complex-grid",height:280,anchor:'100%',enableHdMenu:false,selModel:new Ext.grid.CellSelectionModel({listeners:{scope:this,cellselect:function(sm,row,col){secondDs.removeAll(true);var masterRecord=ds.getAt(row);if(masterRecord.get(''+this.complexFieldId)!=undefined&&masterRecord.get(''+this.complexFieldId)!='undefined'){var newDs=new Ext.data.Store({proxy:new Ext.data.MemoryProxy(eval("("+masterRecord.get(''+this.complexFieldId)+")")),reader:new Ext.data.JsonReader({root:'items',totalProperty:'totalCount'},secondRecordType)});newDs.load();secondDs.removeAll(true);for(var i=0;i<newDs.getCount();i++){secondDs.add(newDs.getAt(i));}}
secondDs.commitChanges();}}}),tbar:toolbar});var secondToolbar=new Ext.Toolbar([{text:ORYX.I18N.PropertyWindow.add,ctCls:'motiveEditorBtnAdd',handler:function(){var ds=this.secondGrid.getStore();var index=ds.getCount();this.secondGrid.stopEditing();var p=this.buildInitial(secondRecordType,complexItems);ds.insert(index,p);ds.commitChanges();this.secondGrid.startEditing(index,0);}.bind(this)},{text:ORYX.I18N.PropertyWindow.rem,ctCls:'motiveEditorBtnRemove',handler:function(){var ds=this.secondGrid.getStore();var selection=this.secondGrid.getSelectionModel().getSelectedCell();if(selection==undefined){return;}
this.secondGrid.getSelectionModel().clearSelections();this.secondGrid.stopEditing();var record=ds.getAt(selection[0]);ds.remove(record);ds.commitChanges();this.afterEditSecondGrid();}.bind(this)}]);this.secondGrid=new Ext.grid.EditorGridPanel({store:secondDs,cm:secondCm,stripeRows:true,clicksToEdit:1,autoScroll:true,stateId:"x-editor-complex-grid",height:280,anchor:'100%',enableHdMenu:false,selModel:new Ext.grid.CellSelectionModel(),tbar:secondToolbar});this.dialog=new Ext.Window({autoCreate:true,layout:"anchor",title:ORYX.I18N.PropertyWindow.complex+" | "+this.items[0]._property._jsonProp.title,height:600,width:dialogWidth,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){this.dialog.hide}.bind(this)}],items:[this.grid,this.secondGrid],bodyStyle:"background-color:#FFFFFF",buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){this.grid.stopEditing();this.data=this.buildValue();this.dialog.hide()}.bind(this)}]});this.dialog.on(Ext.apply({},this.dialogListeners,{scope:this}));this.dialog.show();this.grid.on('beforeedit',this.beforeEdit,this,true);this.grid.on('afteredit',this.afterEdit,this,true);this.secondGrid.on('beforeedit',this.beforeEdit,this,true);this.secondGrid.on('afteredit',this.afterEditSecondGrid,this,true);this.grid.render();this.secondGrid.render();if(ds.getCount()>0){this.grid.getSelectionModel().select(0,0);}}});Ext.form.ComplexListField=function(config,items,contingencies,key,facade){Ext.form.ComplexListField.superclass.constructor.call(this,config);this.items=items;this.contingencies=contingencies;this.key=key;this.facade=facade;this.gridRowClassRoot="listener-row-";ORYX.Plugins.PropertyWindow.getSelectedName=this.getSelectedName.bind(this);ORYX.Plugins.PropertyWindow.setSelectedName=this.setSelectedName.bind(this);this.setContingentFields=function(){var mapOnContingencyDriver=function(fieldIds,driver,value,editable){fieldIds.each(function(id){if(!this.contingentFields.hasOwnProperty(id)){this.contingentFields[id]=[];}
var index=this.contingentFields[id].findIndex(function(x){return x.driver===driver&&x.editable===editable;});if(index===-1){this.contingentFields[id].push({"driver":driver,"editable":editable,"values":[value]});}else{this.contingentFields[id][index]["values"].push(value);}}.bind(this));};this.contingentFields={};this.contingencies.each(function(c){c.trailers.each(function(t){mapOnContingencyDriver.call(this,t.disable,c.driver,t.value,false);mapOnContingencyDriver.call(this,t.enable,c.driver,t.value,true);}.bind(this));}.bind(this));};if(this.contingencies){this.setContingentFields();}};Ext.extend(Ext.form.ComplexListField,Ext.form.TriggerField,{triggerClass:'x-form-complex-trigger',readOnly:true,emptyText:ORYX.I18N.PropertyWindow.clickIcon,buildValue:function(){var ds=this.grid.getStore();ds.commitChanges();if(ds.getCount()==0){return"";}
var jsonString="[";for(var i=0;i<ds.getCount();i++){var data=ds.getAt(i);jsonString+="{";for(var j=0;j<this.items.length;j++){var key=this.items[j].id();jsonString+=key+':'+(""+data.get(key)).toJSON();if(j<(this.items.length-1)){jsonString+=", ";}}
jsonString+="}";if(i<(ds.getCount()-1)){jsonString+=", ";}}
jsonString+="]";jsonString="{'totalCount':"+ds.getCount().toJSON()+", 'items':"+jsonString+"}";return Object.toJSON(jsonString.evalJSON());},getFieldKey:function(){return this.key;},getValue:function(){if(this.grid){return this.buildValue();}else if(this.data==undefined){return"";}else{return this.data;}},setValue:function(value){if(value.length>0){if(this.data==undefined){this.data=value;}}},keydownHandler:function(event){return false;},dialogListeners:{show:function(){this.onFocus();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_KEYDOWN,this.keydownHandler.bind(this));this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);return;},hide:function(){var dl=this.dialogListeners;this.dialog.un("show",dl.show,this);this.dialog.un("hide",dl.hide,this);this.dialog.destroy(true);this.grid.destroy(true);delete this.grid;delete this.dialog;this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_KEYDOWN,this.keydownHandler.bind(this));this.facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);this.fireEvent('dialogClosed',this.data);Ext.form.ComplexListField.superclass.setValue.call(this,this.data);}},buildInitial:function(recordType,items){var initial=new Hash();for(var i=0;i<items.length;i++){var id=items[i].id();initial[id]=items[i].value();}
var RecordTemplate=Ext.data.Record.create(recordType);return new RecordTemplate(initial);},buildColumnModel:function(parent){var cols=[];var titles={};var contingencies=this.contingencies;var contingentFields=this.contingentFields;var gridRowClassRoot=this.gridRowClassRoot;var isCellEditableFn=this.isCellEditable.bind(this);var setCellEditableFn=this.setCellEditable.bind(this);for(var i=0;i<this.items.length;i++){var id=this.items[i].id();var header=this.items[i].name();var width=this.items[i].width();var type=this.items[i].type();var editor;this.items[i].dataType=ORYX.CONFIG.TYPE_STRING;if(type==ORYX.CONFIG.TYPE_STRING){editor=new Ext.form.TextField({allowBlank:this.items[i].optional(),width:width});}else if(type==ORYX.CONFIG.TYPE_CHOICE){var items=this.items[i].items();var select=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",parent,['select',{style:'display:none'}]);var optionTmpl=new Ext.Template('<option value="{value}">{title}</option>');titles[id]={};items.each(function(value){optionTmpl.append(select,{title:value.title(),value:value.value()});titles[id][value.value()]=value.title();});editor=new Ext.form.ComboBox({id:'complexCombo-'+id,typeAhead:true,triggerAction:'all',transform:select,lazyRender:true,msgTarget:'title',width:width,listeners:{"collapse":function(){this.fireEvent('blur');}}});}else if(type==ORYX.CONFIG.TYPE_EXPRESSION){editor=new Ext.form.ExpressionField({allowBlank:true,width:width,grid:Ext.getCmp('oryx-editor-grid'),dataSource:this.datastore,scriptLanguage:true,language:'Javascript'});}else if(type==ORYX.CONFIG.TYPE_BOOLEAN){editor=new Ext.form.Checkbox({width:width});}else if(type==ORYX.CONFIG.TYPE_LIST||type==ORYX.CONFIG.TYPE_MAP){var config={propertyType:type,parent:this,id:id,key:this.key,facade:this.facade};editor=new Ext.form.EmbeddedListMapField(config);}
cols.push({id:id,header:header,dataIndex:id,resizable:true,sortable:true,editor:editor,width:width,renderer:function(value,metaData,record,rowIndex,colIndex,store){if(value.length&&titles[this.id]!==undefined){return titles[this.id][value];}
if(contingentFields!==undefined&&contingentFields[this.id]!==undefined){contingentFields[this.id].each(function(contingency){var cVal=record.get(contingency.driver);if(cVal&&contingency.values.indexOf(cVal)!==-1){metaData.css=contingency.editable?'':'gridCellDisabled';setCellEditableFn(rowIndex,colIndex,contingency.editable);}}.bind(this));}
return value;}});}
var editMap={};var cm=new Ext.grid.ColumnModel({columns:cols,isCellEditable:function(col,row){if(editMap!==undefined&&editMap[row]!==undefined&&editMap[row][col]!==undefined){return editMap[row][col];}
return Ext.grid.ColumnModel.prototype.isCellEditable.call(this,col,row);}});Ext.apply(cm,{setCellEditable:function(col,row,editable){if(!editMap.hasOwnProperty(row)){editMap[row]={};}
editMap[row][col]=editable;}.bind(this)});return cm;},isCellEditable:function(rowIndex,colIndex){return this.grid.getColumnModel().isCellEditable(colIndex,rowIndex);},setCellEditable:function(rowIndex,colIndex,editable){this.grid.getColumnModel().setCellEditable(colIndex,rowIndex,editable);},getSelectedName:function(){return this.selectedName;},setSelectedName:function(name){this.selectedName=name;},afterEdit:function(option){option.grid.getStore().commitChanges();if(this.contingencies!==undefined){var cDriver=this.contingencies.find(function(c){return c.driver===option.field;});if(cDriver!==undefined){var contingent=cDriver.trailers.find(function(t){return t.value===option.value;});if(contingent!==undefined){contingent.enable.each(function(id){var colIndex=option.grid.getColumnModel().getIndexById(id);option.grid.getColumnModel().setCellEditable(colIndex,option.row,true);});contingent.disable.each(function(id){var colIndex=option.grid.getColumnModel().getIndexById(id);option.grid.getColumnModel().setCellEditable(colIndex,option.row,false);option.grid.getStore().getAt(option.row).set(id,'');});}}}},beforeEdit:function(option){var state=this.grid.getView().getScrollState();var col=option.column;var row=option.row;var editId=this.grid.getColumnModel().config[col].id;for(var i=0;i<this.items.length;i++){var item=this.items[i];var disables=item.disable();if(disables!=undefined){var value=this.grid.getStore().getAt(row).get(item.id());for(var j=0;j<disables.length;j++){var disable=disables[j];if(disable.value==value){for(var k=0;k<disable.items.length;k++){var disItem=disable.items[k];if(disItem==editId){this.grid.getColumnModel().getCellEditor(col,row).disable();return;}}}}}}
var editor=this.grid.getColumnModel().getCellEditor(col,row);if(editor.disabled){editor.disable();editor.cancelEdit(false);}else{editor.enable();}},onTriggerClick:function(){if(this.disabled){return;}
if(!this.dialog){var dialogWidth=0;var recordType=[];for(var i=0;i<this.items.length;i++){var item=this.items[i];var id=this.items[i].id();var width=this.items[i].width();var type=this.items[i].type();dialogWidth+=(width!==undefined)?width:150;recordType[i]={name:id,type:this.items[i].dataType};}
dialogWidth+=22;var data=this.data;if(data==""){data="{}";}
this.datastore=new Ext.data.Store({proxy:new Ext.data.MemoryProxy(eval("("+data+")")),reader:new Ext.data.JsonReader({root:'items',totalProperty:'totalCount'},recordType)});this.datastore.load();var cm=this.buildColumnModel();this.grid=new Ext.grid.EditorGridPanel({store:this.datastore,cm:cm,stripeRows:true,clicksToEdit:1,autoHeight:true,selModel:new Ext.grid.CellSelectionModel(),viewConfig:{getRowClass:function(record,rowIndex,rowParams,store){return this.gridRowClassRoot+rowIndex;}.bind(this)},listeners:{scope:this,cellmousedown:function(grid,rowIndex,columnIndex,e){var listClass=e.target.className.split(' ').find(function(c){return/(_list_value|_map_value)$/.test(c);});if(listClass!==undefined){var matches=/-(\w+)_(list|map)_value$/.exec(listClass);if(matches){var paramType=matches[1];var nameKey=paramType+"_name";var inputName=grid.getStore().data.items[rowIndex].data[nameKey];ORYX.Plugins.PropertyWindow.setSelectedName(inputName);var editor=grid.getColumnModel().getCellEditor(columnIndex,rowIndex);}}
return false;}}});var toolbar=new Ext.Toolbar([{text:ORYX.I18N.PropertyWindow.add,ctCls:'motiveEditorBtnAdd',handler:function(){var ds=this.grid.getStore();var index=ds.getCount();this.grid.stopEditing();var p=this.buildInitial(recordType,this.items);ds.insert(index,p);ds.commitChanges();this.grid.startEditing(index,0);}.bind(this)},{text:ORYX.I18N.PropertyWindow.rem,ctCls:'motiveEditorBtnRemove',handler:function(){var ds=this.grid.getStore();var selection=this.grid.getSelectionModel().getSelectedCell();if(selection==undefined){return;}
this.grid.getSelectionModel().clearSelections();this.grid.stopEditing();var record=ds.getAt(selection[0]);ds.remove(record);ds.commitChanges();}.bind(this)}]);this.dialog=new Ext.Window({autoScroll:true,autoCreate:true,title:ORYX.I18N.PropertyWindow.complex+" | "+this.items[0]._property._jsonProp.title,height:350,width:dialogWidth,maximizable:true,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){this.dialog.hide}.bind(this)}],items:[toolbar,this.grid],bodyStyle:"background-color:#FFFFFF",buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){this.grid.stopEditing();this.data=this.buildValue();this.dialog.hide();}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.dialog.hide();}.bind(this)}],listeners:{maximize:function(window){ORYX.Plugins.PropertyWindow.maximizeEditor(window);}}});this.dialog.on(Ext.apply({},this.dialogListeners,{scope:this}));this.dialog.show();this.grid.on('beforeedit',this.beforeEdit,this,true);this.grid.on('afteredit',this.afterEdit,this,true);this.grid.render();}else{this.dialog.show();}}});Ext.form.ComplexTextField=Ext.extend(Ext.form.TriggerField,{defaultAutoCreate:{tag:"textarea",rows:1,style:"height:16px;overflow:hidden;"},onTriggerClick:function(){if(this.disabled){return;}
var grid=new Ext.form.TextArea({anchor:'100% 100%',value:this.value,listeners:{focus:function(){this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);}.bind(this)}})
var dialog=null;var self=this;var closingDialog=false;function closeDialog(cancel,forceCancel){if(!forceCancel&&closingDialog)return;closingDialog=true;if(cancel==null)
cancel=true;dialog.close();self.fireEvent('dialogClosed',self.value,cancel);}
dialog=new Ext.Window({layout:'anchor',autoCreate:true,title:ORYX.I18N.PropertyWindow.text,height:500,width:500,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){closeDialog(true);}.bind(this)}],items:[grid],listeners:{},buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){var value=grid.getValue();this.setValue(value);this.dataSource.getAt(this.row).set('value',value)
this.dataSource.commitChanges()
closeDialog(false);}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.setValue(this.value);closeDialog(true);}.bind(this)}]});dialog.show();grid.render();this.grid.stopEditing();grid.focus(false,100);}});Ext.form.HtmlField=Ext.extend(Ext.form.TriggerField,{defaultAutoCreate:{tag:"textarea",rows:1,style:"height:16px;overflow:hidden;"},onTriggerClick:function(){if(this.disabled){return;}
Motive.Dictionary.init({editor:tinyMCE,editorName:'tinyMCE',language:'juel'});var propertyJSONRegex=/^"?\{"values":\[\{"locale":\s*"[a-zA-Z!]{2,}_?[a-zA-Z]{0,2}",\s*"value":\s*".*"\}"?/;function getLocaleKey(locale){if(locale.key!==undefined)
return locale.key;return locale.languagecode+(locale.countrycode?"_"+locale.countrycode:"");}
function filterValuesByLocale(data,l){var results;l=getLocaleKey(l).toLowerCase();results=data.filter(function(entry){return entry.locale.toLowerCase().indexOf(l)!==-1;});if(results.length==0)
results.push({locale:l,value:''});return results;}
function filterValuesIndexByLocale(data,l){l=getLocaleKey(l);var i=data.length;while(i--){if(data[i].locale===l)break;}
return i;}
function filterValuesIndexByDefaultLocale(data){var i=data.length;while(i--){if(data[i].locale==='!!')break;}
return i;}
function getEmptyLocalizationData(localeConfig){var valueObjects=[];localeConfig.each(function(pkg){valueObjects.push({locale:getLocaleKey(pkg),value:''});});return{values:valueObjects};}
var currentData=this.value;if(!currentData&&this.hotKey){currentData=this.grid.propertyWindow.popularProperties[1][3];}
var currentLocale=this.facade.getCurrentLocale();var textAreaString=currentData;var editorTitleString=ORYX.I18N.PropertyWindow.html+'<span>'+this.propertyTitle+'</span>';if(this.availableLanguagesCfg!=null){if(currentData==null||currentData==""){currentData=getEmptyLocalizationData(this.facade.getLocaleConfig());}else if(!propertyJSONRegex.test(currentData)){var defaultString=currentData;currentData=getEmptyLocalizationData(this.facade.getLocaleConfig());var localeIndex=filterValuesIndexByDefaultLocale(currentData.values);currentData.values[localeIndex].value=defaultString;}else{currentData=Ext.util.JSON.decode(currentData);}
textAreaString=filterValuesByLocale(currentData.values,currentLocale)[0].value;editorTitleString+='<span class="locale">'+currentLocale.displayName+'</span>';}
var dictionaryPanel=Motive.Dictionary.getDictionaryPanel();var dialogWidth=this.stencilType==ORYX.CONFIG.TYPE_HTML_MIN?(this.hasDictionary?600:400):1050;var dialogHeight=this.stencilType==ORYX.CONFIG.TYPE_HTML_MIN?(this.hasDictionary?400:200):580;var grid=new Ext.form.TextArea({anchor:'100% 100%',value:textAreaString,listeners:{focus:function(){this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);}.bind(this)}});var centerPanel=new Ext.Panel({region:'center',layout:'fit',items:[grid]});var dialogItems=[centerPanel];if(this.hasDictionary)
dialogItems.push(dictionaryPanel);var mceContentLoaded=false;var dialog=null;var self=this;var closingDialog=false;function closeDialog(cancel,forceCancel){if(!forceCancel&&closingDialog)return;closingDialog=true;if(cancel==null)
cancel=true;if(mceContentLoaded==false){window.setTimeout(function(){closeDialog(cancel,true)},100);return;}
if(tinyMCE.activeEditor){tinyMCE.activeEditor.remove();}
dialog.close();self.fireEvent('dialogClosed',self.value,cancel);}
function updateDialogTitle(dialog,locale){var dialogTitle=dialog.title;var matches=/([a-zA-Z0-9 ]+\s*<span>[a-zA-Z0-9 ]+<\/span>\s*)<span\s*(class=[a-zA-Z0-9 '"]+)?>([a-zA-Z0-9 ()_-]+)<\/span>/.exec(dialogTitle);if(matches!=null){dialogTitle=matches[1];var oldLocaleTitle=matches[3];}
dialog.setTitle(dialogTitle+'<span class="locale">'+locale+'</span>');}
function getPropertyValueFromEditorBody(body){var value=body.innerHTML;if(self.stencilType==ORYX.CONFIG.TYPE_HTML_MIN){value=value.replace(/<\/p><p>/g,"\r\n");value=value.replace(/(<p>|<\/p>)/g,"");}
value=value.replace(/<br\s+_mce_bogus="1"\s*\/?>/g,"");if(/^<p><\/p>$/.test(value)){return"";}
return value;}
function saveLocalizedValue(locale){var value=getPropertyValueFromEditorBody(tinyMCE.activeEditor.getBody());var currentData=tinyMCE.currentData;var localeIndex=filterValuesIndexByLocale(currentData.values,locale);if(localeIndex<0)
currentData.values.push({locale:getLocaleKey(locale),value:value});else
currentData.values[localeIndex].value=value;ORYX.Plugins.PropertyWindow.localizedValues=Ext.util.JSON.encode(currentData);}
dialog=new Ext.Window({layout:'border',autoCreate:true,title:editorTitleString,ctCls:'htmlEditor',height:dialogHeight,width:dialogWidth,modal:true,collapsible:false,closable:false,resizable:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){closeDialog(true);}}],items:dialogItems,listeners:{show:function(){grid.render();this.grid.stopEditing();tinyMCE.dialog=dialog;tinyMCE.currentLocale={key:getLocaleKey(currentLocale),title:currentLocale.displayName}
tinyMCE.currentData=currentData;tinyMCE.parseHtml=function(source){var matches=/^(.+>)?([^<]+)(<.+)?$/.exec(source);return matches?matches[2]:"";}
tinyMCE.create('tinymce.plugins.LanguageSupportPlugin',{createControl:function(n,cm){switch(n){case'languagelistbox':var mlb=cm.createListBox('languagelistbox',{title:'Language',onselect:function(v){var locale={key:v};tinyMCE.activeEditor.setContent(filterValuesByLocale(tinyMCE.currentData.values,locale)[0].value);}});var locales=Ext.util.JSON.decode(tinyMCE.activeEditor.settings.theme_advanced_available_languages);for(var i=0;i<locales.length;i++){mlb.add(locales[i].displayName,locales[i].key);}
return mlb;case'languagesplitbutton':var c=cm.createSplitButton('languagesplitbutton',{title:'Locale',image:ORYX.PATH+"images/silk/world.png",onclick:function(){c.showMenu();}});c.onRenderMenu.add(function(c,m){m.add({title:'Locale','class':'mceMenuItemTitle'}).setDisabled(1);var locales=Ext.util.JSON.decode(tinyMCE.activeEditor.settings.theme_advanced_available_languages);for(var i=0;i<locales.length;i++){m.add({index:i,title:locales[i].displayName,value:locales[i].key,style:((locales[i].key=="!!")?"font-style: italic;":""),onclick:function(item){var processResult=function(response){if(response=="yes"){saveLocalizedValue(prevLocale);}
if(response!="cancel"){var locale={key:this.value};m.title=this.title;m.value=this.value;updateDialogTitle(tinyMCE.dialog,this.title);var items=m.items;item.siblings().each(function(tempItem){items[tempItem.id].setSelected(0);});items[item.id].setSelected(1);var currentData=(ORYX.Plugins.PropertyWindow.localizedValues!=null)?Ext.util.JSON.decode(ORYX.Plugins.PropertyWindow.localizedValues):tinyMCE.currentData;tinyMCE.activeEditor.setContent(filterValuesByLocale(currentData.values,locale)[0].value);}}
var editorContent=tinyMCE.parseHtml(tinyMCE.activeEditor.getContent());var prevLocaleKey=m.value?m.value:tinyMCE.currentLocale.key;var prevLocale={key:prevLocaleKey};var prevContent=tinyMCE.parseHtml(filterValuesByLocale(tinyMCE.currentData.values,prevLocale)[0].value);if(editorContent!=prevContent){Ext.Msg.show({title:ORYX.I18N.PropertyWindow.alert.saveChanges,msg:ORYX.I18N.PropertyWindow.alert.saveLocaleChanges,buttons:Ext.Msg.YESNOCANCEL,fn:processResult.bind(this),animEl:'elId',icon:Ext.MessageBox.QUESTION});}else{this.processResult=processResult;this.processResult("no");}}}).setSelected(locales[i].key==tinyMCE.currentLocale.key);}});return c;}
return null;}});tinyMCE.create('tinymce.plugins.CustomButtonPlugin',{createControl:function(n,cm){switch(n){case'copyrightbutton':var c=cm.createButton('copyrightbutton',{title:ORYX.I18N.tinyMCE.customButton.copyright.title,image:ORYX.PATH+"images/silk/copyright.png",onclick:function(){tinyMCE.activeEditor.formatter.toggle('copyright');}});return c;case'alertbutton':var c=cm.createButton('alertbutton',{title:ORYX.I18N.tinyMCE.customButton.alert.title,image:ORYX.PATH+"images/silk/exclamation.png",onclick:function(){tinyMCE.activeEditor.formatter.toggle('alert');}});return c;}
return null;}});tinyMCE.PluginManager.add('languageSupport',tinymce.plugins.LanguageSupportPlugin);tinyMCE.PluginManager.add('customButtons',tinymce.plugins.CustomButtonPlugin);if(this.stencilType==ORYX.CONFIG.TYPE_HTML_FULL){this.editor=new tinyMCE.Editor(grid.getEl().id,{mode:'exact',theme:'advanced',plugins:"-customButtons,-languageSupport,safari,spellchecker,pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template",theme_advanced_buttons1:"bold,italic,underline,strikethrough,copyrightbutton,alertbutton,removeformat,|,justifyleft,justifycenter,justifyright,justifyfull,|,formatselect,fontselect,fontsizeselect,|,forecolor,backcolor"+((this.availableLanguagesCfg!=null)?",|,languagesplitbutton":""),theme_advanced_buttons2:"search,replace,|,bullist,numlist,|,outdent,indent,blockquote,|,undo,redo,|,link,unlink,anchor,image,cleanup,|,insertdate,inserttime",theme_advanced_buttons3:"tablecontrols,|,hr,removeformat,visualaid,|,sub,sup,|,charmap,iespell,media,advhr,|,ltr,rtl",theme_advanced_buttons4:"insertlayer,moveforward,movebackward,absolute,|,styleprops,spellchecker,|,cite,abbr,acronym,del,ins,attribs,|,visualchars,nonbreaking,template,blockquote,pagebreak,|,code,fullscreen,|,help",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"bottom",theme_advanced_resizing:true,width:"100%",convert_urls:false,template_external_list_url:ORYX.CONFIG.CLIENT_RESOURCES_PATH+"/tiny_mce/templates/templates.js",external_image_list_url:ORYX.CONFIG.CLIENT_RESOURCES_PATH+"/tiny_mce/images/images.js",verify_html:false});this.editor.fixSize={height:-18,width:0};}else if(this.stencilType==ORYX.CONFIG.TYPE_HTML_MIN){this.editor=new tinyMCE.Editor(grid.getEl().id,{mode:'exact',theme:'advanced',plugins:"-languageSupport,safari,spellchecker,pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template",theme_advanced_buttons1:(this.availableLanguagesCfg!=null?"languagesplitbutton":""),theme_advanced_buttons2:"",theme_advanced_buttons3:"",theme_advanced_buttons4:"",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_resizing:true,theme_advanced_available_languages:this.availableLanguagesCfg,width:"100%",convert_urls:false,verify_html:false});this.editor.fixSize={height:-2,width:0};}else{this.editor=new tinyMCE.Editor(grid.getEl().id,{mode:'exact',theme:'advanced',plugins:"-customButtons,-languageSupport,pagebreak,style,save,advhr,advlink,iespell,inlinepopups,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras",theme_advanced_buttons1:"bold,italic,underline,strikethrough,copyrightbutton,alertbutton,removeformat,|,justifyleft,justifycenter,justifyright,justifyfull,|,outdent,indent,|,formatselect,|,search,replace,|,bullist,numlist,|,undo,redo,|,link,unlink,anchor,image,|,code,fullscreen,|,"+((this.availableLanguagesCfg!=null)?"languagesplitbutton,|,":"")+"help",theme_advanced_buttons2:"",theme_advanced_buttons3:"",theme_advanced_buttons4:"",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"none",theme_advanced_resizing:true,theme_advanced_available_languages:this.availableLanguagesCfg,width:"100%",convert_urls:false,content_css:Motive.HTML_Editor.content_css,style_formats:Motive.HTML_Editor.style_formats,formats:Motive.HTML_Editor.formats,verify_html:false});this.editor.fixSize={height:-12,width:8};}
this.editor.onInit.add(function(){mceContentLoaded=true;});this.editor.onPostRender.add(function(){this.onNodeChange.add(function(ed,cm,node){cm.setActive('alertbutton',/alert/.test(node.className));cm.setActive('copyrightbutton',/copyright/.test(node.className));});});this.editor.doResize=function(ed,cm){var arr=Ext.query("td.mceIframeContainer iframe");var ifr=Ext.get(arr[0].id);var s=ifr.getSize();if(ed.fixSize.height!=0){ifr.setHeight(s.height+ed.fixSize.height);}
if(ed.fixSize.width!=0){ifr.setWidth(s.width+ed.fixSize.width);}};this.editor.onPostRender.add(this.editor.doResize);this.editor.render();Motive.Dictionary.load();}.bind(this)},buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){var index=(this.row!=null)?this.row:this.selectionModel.selectedIndex;var dataRecord=this.dataSource.getAt(index);var localeKey,selectedLanguage;if(tinyMCE.activeEditor){var body=tinyMCE.activeEditor.getBody();var imgItems=Ext.DomQuery.select("img[_mce_src]",body)
Ext.each(imgItems,function(item,i){var originalSrc=item.getAttribute("_mce_src");if(originalSrc.indexOf("#{")!=-1){item.setAttribute("src","images/motive-logo.png");}});var value=getPropertyValueFromEditorBody(body);var languageSplitButton=tinyMCE.activeEditor.controlManager.get("languagesplitbutton");if(languageSplitButton!=null){var localeMenu=languageSplitButton.menu;if(localeMenu!==undefined){localeKey=localeMenu.value;selectedLanguage=localeMenu.title;}else{localeKey=getLocaleKey(currentLocale);selectedLanguage=currentLocale.displayName;}
if(ORYX.Plugins.PropertyWindow.localizedValues!=null){currentData=Ext.util.JSON.decode(ORYX.Plugins.PropertyWindow.localizedValues);ORYX.Plugins.PropertyWindow.localizedValues=null;}
var localeIndex=filterValuesIndexByLocale(currentData.values,{displayName:selectedLanguage,key:localeKey});if(localeIndex<0)
currentData.values.push({locale:localeKey,value:value});else
currentData.values[localeIndex].value=value;for(var j=0;j<currentData.values.length;j++){var localeObj=currentData.values[j];if(localeObj.locale==undefined)
currentData.values.splice(j,1);}
this.setValue(Ext.util.JSON.encode(currentData));}else{this.setValue(value);}}
if(this.dataIndex==null)
dataRecord.set('value',value);else
dataRecord.set(this.dataIndex,Ext.util.JSON.encode(currentData));this.dataSource.commitChanges();closeDialog(false);}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.setValue(this.value);ORYX.Plugins.PropertyWindow.localizedValues=null;closeDialog(true);Motive.Dictionary.cancelPendingOperations();}.bind(this)}]});dialog.show();}});Ext.form.ModelInputPanel=Ext.extend(Ext.Panel,{value:null,_initialized:false,initComponent:function(){try{Motive.Dictionary.init({editor:tinyMCE,editorName:"tinyMCE",useScriptDelimiters:true});var dictionaryPanel=Motive.Dictionary.getDictionaryPanel();this.txtEditor=new Ext.form.TextArea({value:Ext.util.Format.htmlEncode(this.value),listeners:{focus:function(){this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);}.bind(this)}});var cfg={layout:'border',items:[{region:'center',layout:'fit',items:this.txtEditor},dictionaryPanel]};Ext.apply(this,cfg);Ext.form.ModelInputPanel.superclass.initComponent.call(this);}catch(e){ORYX.Log.debug("Ext.form.ModelInputPanel.initComponent - Error: "+e);}},isInitialized:function(){return this._initialized;},show:function(){this._initialized=false;try{Ext.form.ModelInputPanel.superclass.show.call(this);var fixSize={height:0,width:0};this.editor=new tinyMCE.Editor(this.txtEditor.getEl().id,{mode:'exact',theme:'advanced',theme_advanced_buttons1:''});fixSize.width=8;this.editor.onPostRender.add(function(ed,cm){var arr=Ext.query("td.mceIframeContainer iframe");var ifr=Ext.get(arr[0].id);var s=ifr.getSize();if(fixSize.height!=0){ifr.setHeight(s.height+fixSize.height);}
if(fixSize.width!=0){ifr.setWidth(s.width+fixSize.width);}});this.editor.onInit.add(function(){this._initialized=true;}.bind(this));this.editor.render();Motive.Dictionary.load();}catch(e){ORYX.Log.debug("Ext.form.ModelInputPanel.show - Error: "+e);}},destroy:function(){this.editor.remove();Ext.form.ModelInputPanel.superclass.destroy.call(this);},getValue:function(){try{var val=this.editor.getContent({format:'text'});val=val.stripTags();return Ext.util.Format.htmlDecode(val);}catch(e){ORYX.Log.debug("Ext.form.ModelInputPanel.getValue - Error: "+e);}}});Ext.form.ModelInputField=Ext.extend(Ext.form.TriggerField,{initComponent:function(){var cfg={triggerClass:'icon-modelinput'};Ext.apply(this,cfg);Ext.form.ModelInputField.superclass.initComponent.call(this);},onTriggerClick:function(e){this.suspendEvents();this.showModelInputPanel();},showModelInputPanel:function(){var modelInputPanel=new Ext.form.ModelInputPanel({value:this.getRawValue()});var dialog=null;var self=this;var closingDialog=false;function closeDialog(cancel,forceCancel){if(!forceCancel&&closingDialog)return;closingDialog=true;if(cancel==null)
cancel=true;if(!modelInputPanel.isInitialized()){window.setTimeout(function(){closeDialog(cancel,true)},100);return;}
self.resumeEvents();dialog.close();self.fireEvent('dialogClosed',self.value,cancel);}
dialog=new Ext.Window({layout:'fit',autoCreate:true,title:ORYX.I18N.PropertyWindow.modelInput,height:480,width:776,modal:true,collapsible:false,closable:false,resizable:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){closeDialog(true);}}],items:[modelInputPanel],listeners:{show:function(){modelInputPanel.show();}.bind(this)},buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){var value=modelInputPanel.getValue();this.focus();this.setRawValue(value);closeDialog(false);}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.setValue(this.value);closeDialog(true);}.bind(this)}]});dialog.show();}});Ext.form.SortList=Ext.extend(Ext.form.TriggerField,{initComponent:function(){this.initActivityOrder();this.initPofParams();Ext.form.SortList.superclass.initComponent.call(this);},initActivityOrder:function(){this.activityData=[];var activityOrder=[];var oldActivityOrder=this.facade.getActivityOrder();var shapes=this.order.split(',');if(shapes.length){var cntr=0;$j.each(shapes,function(i,shape){var name=shape.trim();if(name.length){this.activityData.push([name,cntr++]);activityOrder.push(name);}}.bind(this));}
this.facade.setActivityOrder(activityOrder);},initPofParams:function(){var json=this.facade.getJSON();var pofParams=json.pofParams;if(pofParams!==undefined){var pofParamsClean={};var shapes=this.facade.getCanvas().getChildShapes(true);if(shapes.length){$j.each(shapes,function(i,shape){$j.each(pofParams.pofInputs,function(j,input){if(!pofParamsClean.hasOwnProperty("pofInputs")){pofParamsClean["pofInputs"]={};}
if(!pofParamsClean.pofInputs.hasOwnProperty(j)){pofParamsClean.pofInputs[j]=$j.extend(true,{},pofParams.pofInputs[j]);pofParamsClean.pofInputs[j]["actParams"]=[];}
$j.each(input.actParams,function(k,act){if(act.actName===shape._stencil._jsonStencil.internalName){pofParamsClean.pofInputs[j]["actParams"].push(act);}});});});}
if(pofParams.hasOwnProperty("pofOutputs")){pofParamsClean["pofOutputs"]=pofParams.pofOutputs;}
this.facade.setPofParams(pofParamsClean);}},onFocus:function(){this.setValue(this.value);this.focus();},onTriggerClick:function(e){if(!this.dialog){this.showSortListPanel();}},showSortListPanel:function(){var rt=Ext.data.Record.create([{name:'activityName'},{name:'activityOrder'}]);var activityStore=new Ext.data.Store({reader:new Ext.data.ArrayReader({idIndex:0},rt),sortInfo:{field:'activityOrder',direction:'ASC'}});activityStore.loadData(this.activityData);Ext.override(Ext.grid.RowNumberer,{renderer:function(value,metaData,record,rowIdx,colIdx,store){return store.indexOf(record)+1;}});var grid=new Ext.grid.GridPanel({id:'activity-order-grid',store:activityStore,colModel:new Ext.grid.ColumnModel({columns:[new Ext.grid.RowNumberer(),{header:'Activity Name',flex:true,sortable:true,dataIndex:'activityName'}]}),ddGroup:'dd',enableDragDrop:true,viewConfig:{forceFit:true},frame:false,iconCls:'icon-grid',listeners:{"render":{scope:this,fn:function(grid){var ddrow=new Ext.dd.DropTarget(grid.container,{ddGroup:'dd',copy:false,notifyOver:function(dd,e,data){var dragSource=$j('#activity-order-grid .x-grid3-row-selected');var dropTarget=dragSource.siblings().filter('.x-grid3-row-over');var className;dragSource.css({opacity:0.5});if(dropTarget.length===1){className=(dragSource.index()<dropTarget.index())?"dropTargetDown":"dropTargetUp";dropTarget.addClass(className);return"x-dd-drop-ok";}
return"x-dd-drop-nodrop";},notifyDrop:function(dd,e,data){var ds=grid.store;var sm=grid.getSelectionModel();var rows=sm.getSelections();if(dd.getDragData(e)){var cindex=dd.getDragData(e).rowIndex;if(typeof(cindex)!="undefined"){for(i=0;i<rows.length;i++){ds.remove(ds.getById(rows[i].id));}
ds.insert(cindex,data.selections);sm.clearSelections();}}
grid.getView().refresh();}});}}}});var oldActivityOrder=activityOrder=this.facade.getActivityOrder();var propertywindowWidth=window.opener.RepositoryCookie.getUserPreference('wfEditorRightPanelWidth',ORYX.CONFIG.PANEL_RIGHT_WIDTH||200)-20;var dialog=new Ext.Window({layout:'fit',autoCreate:true,title:this.title,height:300,width:propertywindowWidth,modal:true,collapsible:false,constrain:true,closable:true,resizable:true,fixedcenter:true,shadow:true,proxyDrag:true,items:grid,buttons:[{text:"Cancel",icon:'images/silk/cancel.png',cls:'x-btn-text-icon',handler:function(){dialog.close();}},{text:"Save",icon:'images/silk/disk.png',cls:'x-btn-text-icon',handler:function(button){var grid=Ext.getCmp('activity-order-grid');var activityOrder=[];grid.store.data.items.each(function(actData,index){activityOrder.push(actData.data.activityName);});var value=activityOrder.join(ORYX.CONFIG.LIST_DELIMITER);this.setValue(value);this.dataSource.getAt(this.row).set('value',value);this.dataSource.commitChanges();var command=new ORYX.Plugins.PropertyWindow.activityOrderCommand(this.facade,activityOrder,oldActivityOrder);this.facade.executeCommands([command]);dialog.close();}.bind(this)}],listeners:{close:function(){delete this.dialog;}.bind(this)}});dialog.show();dialog.alignTo(this.container,'tr-br');this.dialog=dialog;}});Ext.override(Ext.DatePicker,{'style':'width:196px','cls':'chromeFixForDatePicker'})
ORYX.Plugins.PropertyWindow.groupTextFunction=function(ch){var channelMetaData=ORYX.Plugins.PropertyWindow.facade.getChannelMetaData(ch);if(channelMetaData!==undefined){return ORYX.Utils.I18NHelper.getChannel(channelMetaData);}else if(ORYX.Plugins.PropertyWindow.propertyGroups.hasOwnProperty(ch.toLowerCase())){return ORYX.Plugins.PropertyWindow.propertyGroups[ch.toLowerCase()].label;}else if(typeof ch=='string'&&ch.length){return ch;}
return null;};ORYX.Plugins.PropertyWindow.activityOrderCommand=ORYX.Core.Command.extend({construct:function(facade,newActivityOrder,oldActivityOrder){this.facade=facade;this.newActivityOrder=newActivityOrder;this.oldActivityOrder=oldActivityOrder;},execute:function(){this.facade.setActivityOrder(this.newActivityOrder);this.facade.updateSelection();},rollback:function(){this.facade.setActivityOrder(this.oldActivityOrder);this.facade.updateSelection();}});String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1);};var $j=jQuery.noConflict();$j(document).ready(function(){});if(!ORYX.Plugins){ORYX.Plugins=new Object();}
ORYX.Plugins.Toolbar=Clazz.extend({facade:undefined,plugs:[],construct:function(facade,ownPluginData){this.facade=facade;this.groupIndex=new Hash();ownPluginData.properties.each((function(value){if(value.group&&value.index!=undefined){this.groupIndex[value.group]=value.index}}).bind(this));Ext.QuickTips.init();this.buttons=[];this.facade.registerOnEvent(ORYX.CONFIG.EVENT_BUTTON_UPDATE,this.onButtonUpdate.bind(this));},onButtonUpdate:function(event){var button=this.buttons.find(function(button){return button.id===event.id;});if(event.pressed!==undefined){button.buttonInstance.toggle(event.pressed);}},registryChanged:function(pluginsData){var newPlugs=pluginsData.sortBy((function(value){return((this.groupIndex[value.group]!=undefined?this.groupIndex[value.group]:"")+value.group+""+value.index).toLowerCase();}).bind(this));var plugs=$A(newPlugs).findAll(function(value){return!this.plugs.include(value)}.bind(this));if(plugs.length<1)
return;this.buttons=[];ORYX.Log.trace("Creating a toolbar.")
if(!this.toolbar){this.toolbar=new Ext.ux.SlicedToolbar({height:24});var region=this.facade.addToRegion("north",this.toolbar,"Toolbar");}
var currentGroupsName=this.plugs.last()?this.plugs.last().group:plugs[0].group;var currentGroupsDropDownButton={};plugs.each((function(value){if(!value.name){return}
this.plugs.push(value);if(currentGroupsName!=value.group){this.toolbar.add('-');currentGroupsName=value.group;currentGroupsDropDownButton={};}
var tmp=value.functionality;value.functionality=function(){if("undefined"!=typeof(pageTracker)&&"function"==typeof(pageTracker._trackEvent))
{pageTracker._trackEvent("ToolbarButton",value.name)}
return tmp.apply(this,arguments);}
if(value.customButtonCreateCallback){var button=value.customButtonCreateCallback();this.toolbar.add(button);button.getEl().onclick=function(){this.blur()};}else
if(value.dropDownGroupIcon){var splitButton=currentGroupsDropDownButton[value.dropDownGroupIcon];if(splitButton===undefined){splitButton=currentGroupsDropDownButton[value.dropDownGroupIcon]=new Ext.Toolbar.SplitButton({cls:"x-btn-icon",icon:value.dropDownGroupIcon,menu:new Ext.menu.Menu({items:[]}),listeners:{click:function(button,event){if(!button.menu.isVisible()&&!button.ignoreNextClick){button.showMenu();}else{button.hideMenu();}}}});this.toolbar.add(splitButton);}
var buttonCfg={icon:value.icon,text:value.name,itemId:value.id,handler:value.toggle?undefined:value.functionality,checkHandler:value.toggle?value.functionality:undefined,listeners:{render:function(item){if(value.description){new Ext.ToolTip({target:item.getEl(),title:value.description})}}}}
if(value.toggle){var button=new Ext.menu.CheckItem(buttonCfg);}else{var button=new Ext.menu.Item(buttonCfg);}
splitButton.menu.add(button);}else{var button=new Ext.Toolbar.Button({icon:value.icon,cls:'x-btn-icon',itemId:value.id,tooltip:value.description,tooltipType:'title',handler:value.toggle?null:value.functionality,enableToggle:value.toggle,toggleHandler:value.toggle?value.functionality:null});this.toolbar.add(button);button.getEl().onclick=function(){this.blur()}}
value['buttonInstance']=button;this.buttons.push(value);}).bind(this));this.enableButtons([]);this.toolbar.calcSlices();window.addEventListener("resize",function(event){this.toolbar.calcSlices()}.bind(this),false);window.addEventListener("onresize",function(event){this.toolbar.calcSlices()}.bind(this),false);},onSelectionChanged:function(event){ORYX.Log.trace("ORYX.Plugins.Toolbar.onSelectionChanged");this.enableButtons(event.elements);},enableButtons:function(elements){Ext.Ajax.request({url:ORYX.PATH+"poem/isReadOnly",method:'post',success:function(response){this.onIsReadOnlySuccess(response,elements)}.bind(this),failure:function(response){this.onIsReadOnlyFailure(response,elements)}.bind(this)});},onIsReadOnlySuccess:function(response,elements){this.facade.isReadOnly=Ext.util.JSON.decode(response.responseText).isReadOnly;this.showButtons(elements);},onIsReadOnlyFailure:function(response,elements){ORYX.Log.debug('Error getting isReadOnly: '+response.responseText);this.showButtons(elements);},showButtons:function(elements){this.buttons.each((function(value){ORYX.Log.debug("ORYX.Plugins.Toolbar.enableButtons - "+value.name);value.buttonInstance.enable();if(value.minShape&&value.minShape>elements.length)
value.buttonInstance.disable();if(value.maxShape&&value.maxShape<elements.length)
value.buttonInstance.disable();if(value.isEnabled&&!value.isEnabled())
value.buttonInstance.disable();if(this.facade.isReadOnly&&(value.id=="saveButton"||value.id=="saveAsButton"||value.id=="PublishBtn")){value.buttonInstance.disable();}}).bind(this));}});Ext.ns("Ext.ux");Ext.ux.SlicedToolbar=Ext.extend(Ext.Toolbar,{currentSlice:0,iconStandardWidth:22,seperatorStandardWidth:2,toolbarStandardPadding:2,initComponent:function(){Ext.apply(this,{});Ext.ux.SlicedToolbar.superclass.initComponent.apply(this,arguments);},onRender:function(){Ext.ux.SlicedToolbar.superclass.onRender.apply(this,arguments);},onResize:function(){Ext.ux.SlicedToolbar.superclass.onResize.apply(this,arguments);},calcSlices:function(){var slice=0;this.sliceMap={};var sliceWidth=0;var toolbarWidth=this.getEl().getWidth();this.items.getRange().each(function(item,index){if(item.helperItem){item.destroy();return;}
var itemWidth=item.getEl().getWidth();if(sliceWidth+itemWidth+5*this.iconStandardWidth>toolbarWidth){var itemIndex=this.items.indexOf(item);this.insertSlicingButton("next",slice,itemIndex);if(slice!==0){this.insertSlicingButton("prev",slice,itemIndex);}
this.insertSlicingSeperator(slice,itemIndex);slice+=1;sliceWidth=0;}
this.sliceMap[item.id]=slice;sliceWidth+=itemWidth;}.bind(this));if(slice>0){this.insertSlicingSeperator(slice,this.items.getCount()+1);this.insertSlicingButton("prev",slice,this.items.getCount()+1);var spacer=new Ext.Toolbar.Spacer();this.insertSlicedHelperButton(spacer,slice,this.items.getCount()+1);Ext.get(spacer.id).setWidth(this.iconStandardWidth);}
this.maxSlice=slice;this.setCurrentSlice(this.currentSlice);},insertSlicedButton:function(button,slice,index){this.insertButton(index,button);this.sliceMap[button.id]=slice;},insertSlicedHelperButton:function(button,slice,index){button.helperItem=true;this.insertSlicedButton(button,slice,index);},insertSlicingSeperator:function(slice,index){this.insertSlicedHelperButton(new Ext.Toolbar.Fill(),slice,index);},insertSlicingButton:function(type,slice,index){var nextHandler=function(){this.setCurrentSlice(this.currentSlice+1)}.bind(this);var prevHandler=function(){this.setCurrentSlice(this.currentSlice-1)}.bind(this);var button=new Ext.Toolbar.Button({cls:"x-btn-icon",icon:ORYX.CONFIG.ROOT_PATH+"images/toolbar_"+type+".png",handler:(type==="next")?nextHandler:prevHandler});this.insertSlicedHelperButton(button,slice,index);},setCurrentSlice:function(slice){if(slice>this.maxSlice||slice<0)return;this.currentSlice=slice;this.items.getRange().each(function(item){item.setVisible(slice===this.sliceMap[item.id]);}.bind(this));}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.AddDocker=Clazz.extend({construct:function(facade){this.facade=facade;this.facade.offer({'name':ORYX.I18N.AddDocker.add,'functionality':this.enableAddDocker.bind(this),'group':ORYX.I18N.AddDocker.group,'icon':ORYX.PATH+"images/vector_add.png",'description':ORYX.I18N.AddDocker.addDesc,'index':1,'toggle':true,'minShape':0,'maxShape':0});this.facade.offer({'name':ORYX.I18N.AddDocker.del,'functionality':this.enableDeleteDocker.bind(this),'group':ORYX.I18N.AddDocker.group,'icon':ORYX.PATH+"images/vector_delete.png",'description':ORYX.I18N.AddDocker.delDesc,'index':2,'toggle':true,'minShape':0,'maxShape':0});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));},enableAddDocker:function(button,pressed){this.addDockerButton=button;if(pressed&&this.deleteDockerButton)
this.deleteDockerButton.toggle(false);},enableDeleteDocker:function(button,pressed){this.deleteDockerButton=button;if(pressed&&this.addDockerButton)
this.addDockerButton.toggle(false);},enabledAdd:function(){return this.addDockerButton?this.addDockerButton.pressed:false;},enabledDelete:function(){return this.deleteDockerButton?this.deleteDockerButton.pressed:false;},handleMouseDown:function(event,uiObj){if(this.enabledAdd()&&uiObj instanceof ORYX.Core.Edge){this.newDockerCommand({edge:uiObj,position:this.facade.eventCoordinates(event)});}else if(this.enabledDelete()&&uiObj instanceof ORYX.Core.Controls.Docker&&uiObj.parent instanceof ORYX.Core.Edge){this.newDockerCommand({edge:uiObj.parent,docker:uiObj});}else if(this.enabledAdd()){this.addDockerButton.toggle(false);}else if(this.enabledDelete()){this.deleteDockerButton.toggle(false);}},newDockerCommand:function(options){if(!options.edge)
return;var commandClass=ORYX.Core.Command.extend({construct:function(addEnabled,deleteEnabled,edge,docker,pos,facade){this.addEnabled=addEnabled;this.deleteEnabled=deleteEnabled;this.edge=edge;this.docker=docker;this.pos=pos;this.facade=facade;},execute:function(){if(this.addEnabled){this.docker=this.edge.addDocker(this.pos,this.docker);this.index=this.edge.dockers.indexOf(this.docker);}
else if(this.deleteEnabled){this.index=this.edge.dockers.indexOf(this.docker);this.pos=this.docker.bounds.center();this.edge.removeDocker(this.docker);}
this.facade.getCanvas().update();this.facade.updateSelection();},rollback:function(){if(this.addEnabled){if(this.docker instanceof ORYX.Core.Controls.Docker){this.edge.removeDocker(this.docker);}}
else if(this.deleteEnabled){this.edge.add(this.docker,this.index);}
this.facade.getCanvas().update();this.facade.updateSelection();}})
var command=new commandClass(this.enabledAdd(),this.enabledDelete(),options.edge,options.docker,options.position,this.facade);this.facade.executeCommands([command]);}});Ext.namespace("ORYX.Plugins");Ext.namespace("ORYX.Config");ORYX.Plugins.LockHandler=ORYX.Plugins.AbstractPlugin.extend({stop:function(unlock){ORYX.Log.debug("LockHandler.stop()");Ext.TaskMgr.stop(this.pollTask);Ext.TaskMgr.stop(this.keepAliveTask);Event.stopObserving(window,'unload',this.eventListeners.onUnloadFn);if(unlock){this.unlockModel(Ext.emptyFn);}},setup:function(){try{this.modelId=(location.hash.slice(1).replace(/^\/?/,"").replace(/\/?$/,"")).replace(/model\//,"");this.handlerURL=ORYX.PATH+"poem/model/"+this.modelId+"/lockHandler";}catch(e){}},keepAlive:function(){ORYX.Log.debug("LockHandler.keepAlive()::begin");var self=this;var intervalInMilliseconds=ORYX.CONFIG.KEEPALIVE_INTERVAL_MINUTES*60*1000;this.keepAliveTask=Ext.TaskMgr.start({run:function(){new Ajax.Request(self.handlerURL,{method:'get',parameters:{action:'keep-alive'}});},interval:intervalInMilliseconds});},poll:function(){var self=this;var intervalInMilliseconds=ORYX.CONFIG.POLL_INTERVAL_MINUTES*60*1000;this.pollTask=Ext.TaskMgr.start({run:function(){var thisObj=arguments[0];var now=new Date();new Ajax.Request(self.handlerURL,{method:'get',parameters:{action:"poll"},onSuccess:function(response){ORYX.Log.debug("LockHandler.poll()::pollTask >> success. status="+response.status);var data=null;try{data=response.responseText.evalJSON();}catch(e){ORYX.Log.warn("LockHandler.poll()::pollTask >> evalJSON failed");}
if(response.responseText.indexOf("<div id=\"loginBody\"></div>")>0){ORYX.Log.debug("LockHandler.poll()::pollTask >> session ended");new Ajax.Request(ORYX.PATH,{method:"get",onComplete:function(){self.stop(false);}});}else if(data!=null){var rep=data.representation;var repLock=rep.lock;if(data.success==true&&data.result=="broken"){Ext.Msg.show({title:'Warning',msg:'Your lock has been broken by '+repLock.lockedBy+'.<br/>Please use <b>Save as...</b> to avoid losing your changes.',buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING});Ext.TaskMgr.stop(thisObj.pollTask);if(ORYX.Plugins.Save&&ORYX.Plugins.Save.buttons){var saveButton=ORYX.Plugins.Save.buttons.save;saveButton["buttonInstance"].disable();}
thisObj.keepAlive();}}},onFailure:function(response){ORYX.Log.error("LockHandler.poll()::pollTask >> request failed. status "+response.status);}});},interval:intervalInMilliseconds,args:[self]});},construct:function(facade,data){var self=this;this.modelId=null;this.handlerURL=null;this.lastActivityTime=null;this.pollTask=null;this.facade=facade;this.isInitialized=false;this.keepAliveTask=null;this.eventListeners={onUnload:function(event){this.stop.apply(this,[true]);}};this.setup();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEMOVE,this.mouseMoved.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_STATUS,function(options){ORYX.Log.debug("LockHandler.construct()::ORYX.CONFIG.EVENT_LOADING_STATUS");if(!this.isInitialized){this.setup();this.init();}}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,function(){ORYX.Log.debug("LockHandler.construct()::ORYX.CONFIG.EVENT_LOADED");if(!this.isInitialized){this.init();}}.bind(this));},init:function(){ORYX.Log.debug("LockHandler.init()");if(this.modelId==null||this.modelId.strip().length<1){ORYX.Log.debug("LockHandler.init()::No model id found during init. Returning...");return;}
window.onbeforeunload=function(e){this.unlockModel().bind(this);}.bind(this);var self=this;this.lastActivityTime=new Date();this.lockModel(function(status){var responseJSON=this.responseText.evalJSON();var breakLock=null;var queryVars=location.search.substring(1).split('&');for(let i=0;i<queryVars.length;i++){var querySet=queryVars[i].split('=');if(querySet[0]==='breakLock'){breakLock=(querySet[1]==1)?true:false;}}
if(breakLock===true){self.breakLock(function(status){if(status=="success"){self.poll();}});}else if(breakLock===false){self.facade.isReadonly=true;Event.stopObserving(window,'unload',self.eventListeners.onUnloadFn);if(ORYX.Plugins.Save&&ORYX.Plugins.Save.buttons){var saveButton=ORYX.Plugins.Save.buttons.save;saveButton["buttonInstance"].disable();}}else if(responseJSON.result==="readonly"){var rep=responseJSON.representation;var repLock=rep.lock;Ext.Msg.show({title:'Notice',msg:'<b>This workflow is currently locked by '+repLock.lockedBy+'</b>.<br />Click <b>Ok</b> to break the lock or click <b>Cancel</b> to continue in read-only mode.',buttons:Ext.Msg.OKCANCEL,icon:Ext.Msg.INFO,fn:function(btn,text){if(btn=='ok'){self.breakLock(function(status){if(status=="success"){self.poll();}});}else{self.facade.isReadonly=true;Event.stopObserving(window,'unload',self.eventListeners.onUnloadFn);if(ORYX.Plugins.Save&&ORYX.Plugins.Save.buttons){var saveButton=ORYX.Plugins.Save.buttons.save;saveButton["buttonInstance"].disable();}
if(ORYX.Plugins.MotivePlugin&&ORYX.Plugins.MotivePlugin.PublishButton){var publishButton=ORYX.Plugins.MotivePlugin.PublishButton;publishButton["buttonInstance"].disable();}}}});}else{self.poll();}});this.isInitialized=true;},mouseMoved:function(){this.lastActivityTime=new Date();},lockModel:function(callback){var self=this;if(this.modelId!=null&&this.modelId.strip().length>0){new Ajax.Request(this.handlerURL,{method:'get',parameters:{action:"lock"},onSuccess:function(response){ORYX.Log.debug("LockHandler.lock()::Successfully locked model "+self.modelId);if(callback){callback.call(response,"success");}},onFailure:function(response){ORYX.Log.error("LockHandler.lock()::Error locking model "+self.modelId);if(callback){callback.call(response,"failure");}}});}},unlockModel:function(callback){var self=this;if(this.modelId!=null&&this.modelId.strip().length>0){new Ajax.Request(this.handlerURL,{method:'get',parameters:{action:"unlock"},onSuccess:function(response){ORYX.Log.debug("LockHandler.unlock()::Successfully unlocked model "+self.modelId);if(callback){callback.call(response,"success");}},onFailure:function(response){ORYX.Log.error("LockHandler.unlock()::Error unlocking model "+self.modelId);if(callback){callback.call(response,"failure");}}});}},breakLock:function(callback){var self=this;if(this.modelId!=null&&this.modelId.strip().length>0){new Ajax.Request(this.handlerURL,{method:'get',parameters:{action:"break"},onSuccess:function(response){ORYX.Log.debug("LockHandler.break()::Successfully broke lock for model "+self.modelId);if(callback){callback.call(response,"success");}},onFailure:function(response){ORYX.Log.error("LockHandler.unlock()::Error breaking the lock for model "+self.modelId);if(callback){callback.call(response,"failure");}}});}}});if(!ORYX.Plugins)
ORYX.Plugins={};ORYX.Plugins.ContainerLayouter={construct:function(facade){this.facade=facade;this.facade.registerOnEvent('layout.container.minBounds',this.handleLayoutContainerMinBounds.bind(this));this.facade.registerOnEvent('layout.container.dockers',this.handleLayoutContainerDockers.bind(this));this.hashedContainers=new Hash();},handleLayoutContainerDockers:function(event){var sh=event.shape;if(!this.hashedContainers[sh.resourceId]){this.hashedContainers[sh.resourceId]=sh.bounds.clone();return;}
var offset=sh.bounds.upperLeft();offset.x-=this.hashedContainers[sh.resourceId].upperLeft().x;offset.y-=this.hashedContainers[sh.resourceId].upperLeft().y;this.hashedContainers[sh.resourceId]=sh.bounds.clone();this.moveChildDockers(sh,offset);},handleLayoutContainerMinBounds:function(event){var shape=event.shape;var topOffset=event.topOffset;var oldBounds=shape._oldBounds;var options=event.options;var ignoreList=(options.ignoreChildsWithId?options.ignoreChildsWithId:[]);var childsBounds=this.retrieveChildsIncludingBounds(shape,ignoreList);if(!childsBounds){return;}
var ulShape=this.getChildShapesWithout(shape,ignoreList).find(function(node){return childsBounds.upperLeft().y==node.bounds.upperLeft().y;});if(this.ensureContainersMinimumSize(shape,childsBounds,ulShape.absoluteBounds(),ignoreList,options)){return;}
var childsUl=childsBounds.upperLeft();var childsLr=childsBounds.lowerRight();var bottomTopSpaceRatio=(childsUl.y?childsUl.y:1)/((oldBounds.height()-childsLr.y)?(oldBounds.height()-childsLr.y):1);var newYValue=bottomTopSpaceRatio*(shape.bounds.height()-childsBounds.height())/(1+bottomTopSpaceRatio);this.getChildShapesWithout(shape,ignoreList).each(function(childShape){var innerOffset=childShape.bounds.upperLeft().y-childsUl.y;childShape.bounds.moveTo({x:childShape.bounds.upperLeft().x,y:newYValue+innerOffset});});var yAdjustment=ulShape.bounds.upperLeft().y-ulShape._oldBounds.upperLeft().y;this.moveChildDockers(shape,{x:0,y:yAdjustment});},ensureContainersMinimumSize:function(shape,childsBounds,ulChildAbsBounds,ignoreList,options){var bounds=shape.bounds;var ulShape=bounds.upperLeft();var lrShape=bounds.lowerRight();var ulChilds=childsBounds.upperLeft();var lrChilds=childsBounds.lowerRight();var absBounds=shape.absoluteBounds();var ulx;var uly;var lrx;var lry;var changeBounds=false;if(!options){options={};}
if(!shape.isResized){var yMovement=0;var xMovement=0;ulx=ulShape.x;uly=ulShape.y;lrx=lrShape.x;lry=lrShape.y;if(ulChilds.x<0){ulx+=ulChilds.x;xMovement-=ulChilds.x;changeBounds=true;}
if(ulChilds.y<0){uly+=ulChilds.y;yMovement-=ulChilds.y;changeBounds=true;}
var xProtrusion=xMovement+ulChilds.x+childsBounds.width()-
bounds.width();if(xProtrusion>0){lrx+=xProtrusion;changeBounds=true;}
var yProtrusion=yMovement+ulChilds.y+childsBounds.height()-
bounds.height();if(yProtrusion>0){lry+=yProtrusion;changeBounds=true;}
bounds.set(ulx,uly,lrx,lry);if(changeBounds){this.hashedContainers[shape.resourceId]=bounds.clone();}
this.moveChildsBy(shape,{x:xMovement,y:yMovement},ignoreList);return true;}
ulx=ulShape.x;uly=ulShape.y;lrx=lrShape.x;lry=lrShape.y;changeBounds=false;if(bounds.height()<childsBounds.height()){if(ulShape.y!=shape._oldBounds.upperLeft().y&&lrShape.y==shape._oldBounds.lowerRight().y){uly=lry-childsBounds.height()-1;if(options.fixedY){uly-=childsBounds.upperLeft().y;}
changeBounds=true;}
else if(ulShape.y==shape._oldBounds.upperLeft().y&&lrShape.y!=shape._oldBounds.lowerRight().y){lry=uly+childsBounds.height()+1;if(options.fixedY){lry+=childsBounds.upperLeft().y;}
changeBounds=true;}
else if(ulChildAbsBounds){var ulyDiff=absBounds.upperLeft().y-ulChildAbsBounds.upperLeft().y;var lryDiff=absBounds.lowerRight().y-ulChildAbsBounds.lowerRight().y;uly-=ulyDiff;lry-=lryDiff;uly--;lry++;changeBounds=true;}}
if(bounds.width()<childsBounds.width()){if(ulShape.x!=shape._oldBounds.upperLeft().x&&lrShape.x==shape._oldBounds.lowerRight().x){ulx=lrx-childsBounds.width()-1;if(options.fixedX){ulx-=childsBounds.upperLeft().x;}
changeBounds=true;}
else if(ulShape.x==shape._oldBounds.upperLeft().x&&lrShape.x!=shape._oldBounds.lowerRight().x){lrx=ulx+childsBounds.width()+1;if(options.fixedX){lrx+=childsBounds.upperLeft().x;}
changeBounds=true;}
else if(ulChildAbsBounds){var ulxDiff=absBounds.upperLeft().x-ulChildAbsBounds.upperLeft().x;var lrxDiff=absBounds.lowerRight().x-ulChildAbsBounds.lowerRight().x;ulx-=ulxDiff;lrx-=lrxDiff;ulx--;lrx++;changeBounds=true;}}
bounds.set(ulx,uly,lrx,lry);if(changeBounds){this.handleLayoutContainerDockers({shape:shape});}},moveChildsBy:function(shape,relativeMovePoint,ignoreList){if(!shape||!relativeMovePoint){return;}
this.getChildShapesWithout(shape,ignoreList).each(function(child){child.bounds.moveBy(relativeMovePoint);});},getAbsoluteBoundsForChildShapes:function(shape){},moveChildDockers:function(shape,offset){if(!offset.x&&!offset.y){return;}
shape.getChildNodes(true).map(function(node){return[].concat(node.getIncomingShapes()).concat(node.getOutgoingShapes());}).flatten().uniq().map(function(edge){return edge.dockers.length>2?edge.dockers.slice(1,edge.dockers.length-1):[];}).flatten().each(function(docker){docker.bounds.moveBy(offset);});},retrieveChildsIncludingBounds:function(shape,ignoreList){var childsBounds;this.getChildShapesWithout(shape,ignoreList).each(function(childShape,i){if(i===0){childsBounds=childShape.bounds.clone();return;}
childsBounds.include(childShape.bounds);});return childsBounds;},getChildShapesWithout:function(shape,ignoreList){var childs=shape.getChildShapes(false);return childs.findAll(function(child){return!ignoreList.member(child.getStencil().id());});}};ORYX.Plugins.ContainerLayouter=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.ContainerLayouter);if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.RenameShapes=Clazz.extend({facade:undefined,construct:function(facade){ORYX.Plugins.RenameShapes.debug={};this.facade=facade;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DBLCLICK,this.actOnDBLClick.bind(this));this.facade.offer({keyCodes:[{keyCode:113,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.renamePerF2.bind(this)});document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this.hide.bind(this),true)},renamePerF2:function(){var selectedShapes=this.facade.getSelection();this.actOnDBLClick(undefined,selectedShapes.first());},actOnDBLClick:function(evt,shape){if(!(shape instanceof ORYX.Core.Shape)){return}
this.destroy();var props=shape.getStencil().properties().findAll(function(item){return(item.refToView()&&item.refToView().length>0&&item.directlyEditable());});props=props.findAll(function(item){return!item.readonly()&&item.type()==ORYX.CONFIG.TYPE_STRING});var allRefToViews=props.collect(function(prop){return prop.refToView()}).flatten().compact();var labels=shape.getLabels().findAll(function(label){return allRefToViews.any(function(toView){return label.id.endsWith(toView)});})
ORYX.Plugins.RenameShapes.debug.labels=labels;if(labels.length==0){return}
var nearestLabel=labels.length<=1?labels[0]:null;ORYX.Plugins.RenameShapes.debug.nearestLabel=nearestLabel;if(!nearestLabel){nearestLabel=labels.find(function(label){return label.node==evt.target||label.node==evt.target.parentNode})
if(!nearestLabel){var evtCoord=this.facade.eventCoordinates(evt);var trans=this.facade.getCanvas().rootNode.lastChild.getScreenCTM();evtCoord.x*=trans.a;evtCoord.y*=trans.d;var diff=labels.collect(function(label){var center=this.getCenterPosition(label.node);var len=Math.sqrt(Math.pow(center.x-evtCoord.x,2)+Math.pow(center.y-evtCoord.y,2));return{diff:len,label:label}}.bind(this));diff.sort(function(a,b){return a.diff>b.diff})
nearestLabel=diff[0].label;}}
var prop=props.find(function(item){return item.refToView().any(function(toView){return nearestLabel.id==shape.id+toView})});var htmlCont=this.facade.getCanvas().getHTMLContainer().id;ORYX.Plugins.RenameShapes.debug.htmlCont=htmlCont;var width=shape.bounds.width();var center=this.getCenterPosition(nearestLabel.node);center.x-=(width/2);var propId=prop.prefix()+"-"+prop.id();if(center.x<=0&&nearestLabel.x>0){center.x=nearestLabel.x;}
if(center.y<=0&&nearestLabel.y>0){center.y=nearestLabel.y;}
var config={renderTo:htmlCont,value:shape.properties[propId],x:(center.x<10)?10:center.x,y:center.y,width:Math.max(100,width),style:'position:absolute',allowBlank:prop.optional(),maxLength:prop.length(),emptyText:prop.title(),cls:'x_form_text_set_absolute'}
if(prop.wrapLines()){config.y-=(60/2);config['grow']=true;this.shownTextField=new Ext.form.TextArea(config);}else{config.y-=(20/2);this.shownTextField=new Ext.form.TextField(config);}
ORYX.Plugins.RenameShapes.debug.txtConfig=config;this.shownTextField.focus();this.shownTextField.on('blur',this.destroy.bind(this))
this.shownTextField.on('change',function(node,value){var currentEl=shape;var oldValue=currentEl.properties[propId];var newValue=value;var facade=this.facade;if(oldValue!=newValue){var commandClass=ORYX.Core.Command.extend({construct:function(){this.el=currentEl;this.propId=propId;this.oldValue=oldValue;this.newValue=newValue;this.facade=facade;},execute:function(){this.el.setProperty(this.propId,this.newValue);this.facade.setSelection([this.el]);this.facade.getCanvas().update();this.facade.updateSelection();},rollback:function(){this.el.setProperty(this.propId,this.oldValue);this.facade.setSelection([this.el]);this.facade.getCanvas().update();this.facade.updateSelection();}})
var command=new commandClass();this.facade.executeCommands([command]);}}.bind(this))
this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);},getCenterPosition:function(svgNode){var center={x:0,y:0};var trans=svgNode.getTransformToElement(this.facade.getCanvas().rootNode.lastChild);var scale=this.facade.getCanvas().rootNode.lastChild.getScreenCTM();var transLocal=svgNode.getTransformToElement(svgNode.parentNode);center.x=trans.e-transLocal.e;center.y=trans.f-transLocal.f;try{var bounds=svgNode.getBBox();bounds.y-=1;}catch(e){var bounds={x:Number(svgNode.getAttribute('x')),y:Number(svgNode.getAttribute('y')),width:0,height:0};}
center.x+=bounds.x;center.y+=bounds.y;center.x+=bounds.width/2;center.y+=bounds.height/2;center.x*=scale.a;center.y*=scale.d;ORYX.Plugins.RenameShapes.debug.centerPosition={'center':center,'trans':trans,'scale':scale,'transLocal':transLocal,'bounds':bounds};return center},hide:function(e){if(this.shownTextField&&(!e||!this.shownTextField.el||e.target!==this.shownTextField.el.dom)){this.shownTextField.onBlur();}},destroy:function(e){if(this.shownTextField){this.shownTextField.destroy();delete this.shownTextField;this.facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);}}});SVGElement.prototype.getTransformToElement=SVGElement.prototype.getTransformToElement||function(elem){return elem.getScreenCTM().inverse().multiply(this.getScreenCTM());};if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.Merge=ORYX.Plugins.AbstractPlugin.extend({mergeProperty:null,unMergeProperty:null,raiseOverlay:null,getShapesFromResourceId:null,removeMergeIconOverlay:null,construct:function(facade){this.addedMergeShapes=[];this.facade=facade;arguments.callee.$.construct.apply(this,arguments);ORYX.Plugins.Merge.mergeProperty=this.mergeProperty.bind(this);ORYX.Plugins.Merge.unMergeProperty=this.unMergeProperty.bind(this);ORYX.Plugins.Merge.raiseOverlay=this.raiseOverlay.bind(this);ORYX.Plugins.Merge.getShapesFromResourceId=this.getShapesFromResourceId.bind(this);ORYX.Plugins.Merge.removeMergeIconOverlay=this.removeMergeIconOverlay.bind(this);ORYX.Plugins.Merge.getCompareWorkFlowname=this.getMergeWorkFlowName.bind(this);this.isVersionWindow=false;this.facade.offer({'name':ORYX.I18N.Merge.name,'functionality':this.getPublishedWorkFlows.bind(this),'group':'Workflow Test','icon':ORYX.PATH+"images/silk/arrow_join.png",'description':ORYX.I18N.Merge.desc,'index':3,'toggle':false});},getMergeWorkFlowName:function(){return"Workflow: "+this.mergeWorkFlow.title+" Version: "+this.selectedMergeVersion.version},getPublishedWorkFlows:function(){ORYX.Plugins.Save.autoSave.functionality();Ext.Ajax.request({url:ORYX.PATH+"poem/queryModels",method:'GET',success:this.onModelSuccess.bind(this),failure:this.showError.bind(this)});},onModelSuccess:function(result){this.mergeWorkflowModel=Ext.util.JSON.decode(result.responseText);if(this.mergeWorkflowModel.models.length<=0){Ext.MessageBox.show({title:ORYX.I18N.ParentFlow.status,msg:ORYX.I18N.ParentFlow.noChildren,buttons:Ext.MessageBox.OK,fn:Ext.MessageBox.hide(),icon:Ext.MessageBox.INFO});}else{this.buildFlowGrid()}},buildFlowGrid:function(){this.removeAllMergeButtons();this.initMergeButtons();this.initSearch();if(this.mergeGrid){this.gridPanel.remove(this.mergeGrid)}
var mergeData=this.mergeWorkflowModel;if(this.isVersionWindow){mergeData=this.versionData;}
this.mergeGrid=new Ext.form.FlowGrid({viewConfig:{forceFit:true},data:mergeData,isVersionWindow:this.isVersionWindow,listeners:{rowclick:function(row,idx,e){if(this.isVersionWindow){this.mergeBtn.enable();this.selectedMergeVersion=this.mergeGrid.getSelectionModel().getSelected().data;return};if(this.mergeGrid.getSelectionModel().hasSelection()){this.mergeWorkFlow=this.mergeGrid.getSelectionModel().getSelected().data;this.mergeWorkflowVersionModel=this.mergeGrid.getSelectionModel().getSelected().data;this.getWorkFlowVersions();};}.bind(this)},width:800,height:700,frame:false,iconCls:'icon-grid',tbar:[this.searchPanel]});if(this.isVersionWindow){this.instructionPanel.body.update('<h1>'+ORYX.I18N.Merge.workflowVersionInstruction+'</h1>');this.gridPanel.data=this.versionData;this.buttonPanel.add(this.closeBtn);this.buttonPanel.add(this.backBtn);this.buttonPanel.add(this.mergeBtn);this.buttonPanel.doLayout();}else{if(!this.mappingWindow){this.initMergePanels();this.buttonPanel.add(this.closeBtn);this.buttonPanel.add(this.nextBtn);this.mappingWindow.show();}else{this.buttonPanel.add(this.closeBtn);this.buttonPanel.add(this.nextBtn);this.buttonPanel.doLayout();}
this.instructionPanel.body.update('<h1>'+ORYX.I18N.Merge.workflowInstruction+'</h1>');}
this.gridPanel.add(this.mergeGrid);this.gridPanel.doLayout();$j('#mergeSearchBtn').val("");},removeAllMergeButtons:function(){if(this.buttonPanel){this.buttonPanel.remove(this.backBtn);this.buttonPanel.remove(this.mergeBtn);this.buttonPanel.remove(this.nextBtn);this.buttonPanel.remove(this.closeBtn);}},destroyMergePanel:function(){if(this.mappingWindow){this.mappingWindow.destroy();this.mappingWindow=null;this.gridPanel=null;this.instructionPanel=null;this.mergeGrid=null;this.buttonPanel=null;}},compareWorkflows:function(){Ext.Ajax.request({url:ORYX.PATH+"poem/workflow-merge?version1="+this.selectedMergeVersion.version+"&leftModelId="+this.mergeWorkflowVersionModel.identId+'&rightModelId='+this.facade.getModelID(),method:'GET',success:function(result){this.facade.openSouthPanel();ORYX.Plugins.MergeToolbar.removeAllMergeData();ORYX.Plugins.MergeToolbar.setMergeData(JSON.parse(result.responseText).resultData);this.closeWindow();}.bind(this),failure:function(e){ORYX.Plugins.MergeToolbar.setMergeData()}});},initMergePanels:function(){this.instructionPanel=new Ext.Panel({region:'north',autoHeight:true,height:'auto',border:false,bodyStyle:'padding:15px; border-bottom:0;',});this.gridPanel=new Ext.Panel({layout:'fit',region:'center',height:'auto',width:550,border:false,bodyStyle:'padding-top:5px; border-bottom:0;'});this.buttonPanel=new Ext.Panel({border:false,style:'padding-top:5px',bodyStyle:'padding:5px;display:inline-block; text-align:right',autoHeight:true,height:'auto',region:'south'});this.mappingWindow=new Ext.Window({layout:'border',autoCreate:true,title:ORYX.I18N.Merge.title,height:480,width:550,modal:true,collapsible:false,closable:false,fixedcenter:true,shadow:true,proxyDrag:true,items:[this.instructionPanel,this.gridPanel,this.buttonPanel]});},initMergeButtons:function(){this.mergeBtn=new Ext.Button({text:ORYX.I18N.Merge.btnMerge,id:'mergeBtn',style:'display:inline-block;padding-left:5px',cls:'x-btn-text-icon',disabled:true,icon:ORYX.PATH+"images/silk/information.png",handler:function(){this.compareWorkflows();}.bind(this)});this.nextBtn=new Ext.Button({text:ORYX.I18N.Merge.btnNext,id:'mergeNextBtn',style:'display:inline-block;padding-left:5px',cls:'x-btn-text-icon',disabled:true,icon:ORYX.PATH+"images/silk/arrow_right.png",handler:function(){this.isVersionWindow=true;this.buildFlowGrid()}.bind(this)});this.backBtn=new Ext.Button({text:ORYX.I18N.Merge.btnBack,id:'mergeBackBtn',style:'display:inline-block;padding-left:5px',cls:'x-btn-text-icon',icon:ORYX.PATH+"images/silk/arrow_left.png",handler:function(){this.isVersionWindow=false;this.buildFlowGrid()}.bind(this)});this.closeBtn=new Ext.Button({text:ORYX.I18N.Merge.btnCancelMerge,cls:'x-btn-text-icon',style:'display:inline-block;padding-left:5px',icon:ORYX.PATH+"images/silk/cross.png",handler:function(){this.closeWindow();}.bind(this)});},initSearch:function(){this.searchInput=new Ext.form.TextField({inputType:'text',id:'mergeSearchBtn',fieldLabel:'Search',style:'display:inline-block; padding-left:0px',width:470,listeners:{render:function(){$j('#mergeSearchBtn').off();$j('#mergeSearchBtn').keyup(this.filterMergeList.bind(this))}.bind(this)}});this.searchPanel=new Ext.FormPanel({border:false,style:'padding-top:5px; padding-left:5px',bodyStyle:'padding:5px;display:inline-block;',labelPad:10,labelWidth:40,autoHeight:true,height:'auto',items:[this.searchInput]});},filterMergeList:function(){var regEx=new RegExp('^'+$j('#mergeSearchBtn').val()+'.*','i');if(this.isVersionWindow){this.mergeGrid.store.filterBy(function(item){return item.get('version').match(regEx)!=null||item.get('description').match(regEx)});}else{this.mergeGrid.store.filter('title',regEx);}},showError:function(result,request){Ext.Msg.show({title:ORYX.I18N.ParentFlow.error,msg:ORYX.I18N.ParentFlow.loadError,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});},getWorkFlowVersions:function(){Ext.Ajax.request({url:ORYX.PATH+"poem/model/"+this.mergeWorkflowVersionModel.identId+"/versions?limit=-1",method:'GET',success:function(result){this.nextBtn.enable();this.versionData=JSON.parse(result.responseText)}.bind(this),failure:function(e){this.showError();}});},closeWindow:function(){this.isVersionWindow=false;this.destroyMergePanel();},unMergeProperty:function(){this.facade.raiseEvent({type:"key.event.down.metactrl.90",event:KeyboardEvent})},mergeProperty:function(propertyItem,isMergeAll,revert){var facade=this.facade,mergeSingle=this.mergeSingleFunction.bind(this),mergeAll=this.mergeAllFunction.bind(this);var commandClass=ORYX.Core.Command.extend({construct:function(){this.property=propertyItem;this.facade=facade;},execute:function(){if(!isMergeAll){mergeSingle(this.property,revert);}else{mergeAll(this.property,revert)}
return true;},rollback:function(){if(!isMergeAll){mergeSingle(this.property,true);}else{mergeAll(this.property,true)}}});var command=new commandClass();this.facade.executeCommands([command]);},mergeSingleFunction:function(propertyObj,useOldValue){this.mergeByType(propertyObj,useOldValue)},mergeAllFunction:function(propertyArray,useOldValue){$j.each(propertyArray,function(idx,property){this.mergeByType(property,useOldValue);}.bind(this));},mergeByType:function(propertyObj,useOldValue){switch(propertyObj.changeType){case"updated":{this.updateNode(propertyObj,useOldValue);break;}
case"added":{if(!useOldValue){this.deleteNode(propertyObj);}else{this.addNode(propertyObj)}
break;}
case"deleted":{if(!useOldValue){this.addNode(propertyObj)}else{this.deleteNode(propertyObj)}}}
var btn=$j('#mergeBtn-'+propertyObj.resourceId+'_'+propertyObj.propertyName+' .x-btn-center button'),btnText=$j(btn).text();if(btn){if(btnText===ORYX.I18N.Merge.name||btnText===ORYX.I18N.Merge.btnAdd||btnText===ORYX.I18N.Merge.btnDelete){$j(btn).text(ORYX.I18N.Merge.revert);}else{if(propertyObj.changeType==='updated'){$j(btn).text(ORYX.I18N.Merge.name);}else if(propertyObj.changeType==='deleted'){$j(btn).text(ORYX.I18N.Merge.btnAdd);}else if(propertyObj.changeType==='added'){$j(btn).text(ORYX.I18N.Merge.btnDelete);}}}},updateNode:function(property,useOldValue){var flowView=this.facade.getFlowViewByName(property.channel),shape;$j.each(flowView.flowViewShapes,function(fIdx,fItem){if(fItem.resourceId!=property.resourceId){return;}
shape=this.facade.getCanvas().getShape(property.resourceId);if(shape){this.facade.displayShapeInCanvas(property.resourceId,true);if(property.propertyName==='displayname'){if(useOldValue&&!property.oldValue){shape.setProperty('oryx-'+property.propertyName,"");}else{var newDisplay={values:[]},locale={locale:'',value:''};$j.each(property.locale,function(idx,item){if(item.localeName==="Default"){locale.locale="!!"}else{locale.locale=item.localeName;}
if(useOldValue){locale.value=item.localeValue.rightValue;}else{locale.value=item.localeValue.leftValue;}
if(!locale.value){locale.value="";}
newDisplay.values.push(locale)});shape.setProperty('oryx-'+property.propertyName,Ext.util.JSON.encode(newDisplay));}}else if(this.isTypeHTML(shape.getStencil().property('oryx-'+property.propertyName).type())){try{var pProperties=Ext.util.JSON.decode(shape.properties['oryx-'+property.propertyName]);$j(pProperties.values).each(function(idx,item){if(item[property.propertyDef.type]===property.propertyDef.propertyName||(item[property.propertyDef.type]==="!!"&&property.propertyDef.propertyName==="Default")){if(useOldValue){if(!property.oldValue){item.value=""}else{item.value=property.oldValue;}}else{if(!property.newValue){item.value=""}else{item.value=property.newValue;}}}});shape.setProperty('oryx-'+property.propertyName,Ext.util.JSON.encode(pProperties));}catch(e){if(useOldValue){if(!property.oldValue){property.oldValue="";}
shape.setProperty('oryx-'+property.propertyName,property.oldValue);}else{if(!property.newValue){property.newValue="";}
shape.setProperty('oryx-'+property.propertyName,property.newValue);}}}else if(property.propertyName==='signalcfg'){if(useOldValue&&!property.oldValue){shape.setProperty('oryx-'+property.propertyName,"");}else{var signalConfig=this.mergeSignalConfig(property,useOldValue);shape.setProperty('oryx-'+property.propertyName,Ext.util.JSON.encode(signalConfig));}}
else
{if(useOldValue){if(!property.oldValue){property.oldValue=""}
shape.setProperty('oryx-'+property.propertyName,property.oldValue);}else{if(!property.newValue){property.newValue=""}
shape.setProperty('oryx-'+property.propertyName,property.newValue);}}
this.facade.getCanvas().update();this.facade.updateSelection();}else if(fItem.resourceId===property.resourceId){var stencil=ORYX.Core.StencilSet.stencil(this.facade.getCanvas().getStencil().namespace()+fItem.stencil.id);var type=stencil.property('oryx-'+property.propertyName).type();if(property.propertyName==='displayname'){if(useOldValue&&!property.oldValue){fItem.properties[property.propertyName]=""}else{var newDisplay={values:[]},locale={locale:'',value:''};$j.each(property.locale,function(idx,item){if(item.localeName==="Default"){locale.locale="!!"}else{locale.locale=item.localeName;}
if(useOldValue){locale.value=item.localeValue.rightValue;}else{locale.value=item.localeValue.leftValue;}
if(!locale.value){locale.value="";}
newDisplay.values.push(locale)});fItem.properties[property.propertyName]=Ext.util.JSON.encode(newDisplay)}}else if(this.isTypeHTML(type)){var pProperties=Ext.util.JSON.decode(fItem.properties[property.propertyName]);$j(pProperties.values).each(function(idx,item){if(item[property.propertyDef.type]===property.propertyDef.propertyName||(item[property.propertyDef.type]==="!!"&&property.propertyDef.propertyName==="Default")){if(useOldValue){item.value=property.oldValue;}else{item.value=property.newValue;}}});fItem.properties[property.propertyName]=Ext.util.JSON.encode(pProperties);}else if(property.propertyName==='signalcfg'){if(useOldValue&&!property.oldValue){fItem.properties[property.propertyName]=""}else{var signalConfig=this.mergeSignalConfig(property,useOldValue)
fItem.properties[property.propertyName]=Ext.util.JSON.encode(signalConfig)}}else{if(useOldValue){fItem.properties[property.propertyName]=property.oldValue;}else{fItem.properties[property.propertyName]=property.newValue;}}}else{console.log('signal')}}.bind(this));},mergeSignalConfig:function(property,useOldValue){var config;if(useOldValue){config=Ext.util.JSON.decode(property.oldValue);}else{config=Ext.util.JSON.decode(property.newValue);}
var flowView=this.facade.getFlowViewByName(property.channel);$j.each(flowView.flowViewShapes,function(fIdx,fItem){if(fItem.properties.hasOwnProperty('conditionexpression')){if(!config){fItem.properties.conditionexpression=""}else{$j.each(config.signals,function(idx,signal){if(signal.name===fItem.properties.conditionexpression){signal.id=fItem.resourceId;return}})}}});return config},deleteNode:function(property){var shape=this.facade.getCanvas().getShape(property.resourceId);if(!shape){var shapeIdx;$j.each(this.addedMergeShapes,function(idx,item){if(item.resourceId===property.resourceId){shape=this.facade.getCanvas().getShape(item.resourceId);shapeIdx=idx;return;}}.bind(this));this.addedMergeShapes.splice(shapeIdx,1);}
if(shape){var selectedShape=this.facade.getSelection(),newSelectedShape=[];$j.each(selectedShape,function(idx,sItem){if(shape.resourceId!=sItem.resourceId){newSelectedShape.push(sItem);}});this.facade.setSelection([]);this.facade.deleteShape(shape);}else{var flowView=this.facade.getFlowViewByName(property.channel),shapeIdx=-1;$j.each(flowView.flowViewShapes,function(fIdx,fItem){if(fItem.resourceId!=property.resourceId){return;}
shapeIdx=fIdx;return;});flowView.flowViewShapes.splice(shapeIdx,1)}},addNode:function(property){property.type=property.nodeType;property.type=property.namespace+property.type;if(property.nodeBounds&&property.nodeBounds.upperLeft&&property.nodeBounds.upperLeft.x&&property.nodeBounds.upperLeft.y){property.position={x:property.nodeBounds.upperLeft.x,y:property.nodeBounds.upperLeft.y};}
var flowView=this.facade.getCurrentFlowView(),addToCanvas=property.channel==flowView,flow=this.facade.getFlowViewByName(property.channel),shapeJSON;if(!addToCanvas){var shape=this.facade.createShape(property,false);}else{var shape=this.facade.createShape(property);}
$j.each(property.nodeProperties,function(idx,property){shape.setProperty('oryx-'+property.propertyName,property.value.rightValue);});shape.resourceId=property.resourceId;this.addedMergeShapes.push(shape);this.facade.getCanvas().update();if(addToCanvas){this.facade.displayShapeInCanvas(shape.resourceId,true);this.facade.updateSelection();}else{shapeJSON=shape.toJSON();shapeJSON.resourceId=property.resourceId;flow.flowViewShapes.push(shapeJSON);this.facade.setSelection([]);}},isTypeHTML:function(type){switch(type){case ORYX.CONFIG.TYPE_HTML_MIN:case ORYX.CONFIG.TYPE_HTML_FULL:case ORYX.CONFIG.TYPE_HTML:return true;break;default:return false}},getShapesFromResourceId:function(resourceIdArray){var shapeArray=[],shape;$j(resourceIdArray).each(function(idx,item){shape=this.facade.getCanvas().getShape(item);if(shape){shapeArray.push(shape);}}.bind(this));return shapeArray},raiseOverlay:function(shapeArray,errorMsg){this.raisedEventIds=[];var canvas=this.facade.getCanvas();var shapes=canvas.getChildShapes();$j.each(shapes,function(index,shape){$j(shape.node).fadeTo(0,0.3);});var id="merge.";var crossId=ORYX.Editor.provideId();var cross;$j.each(this.addedMergeShapes,function(idx,item){var shape=this.facade.getCanvas().getShape(item.resourceId);if(shape){shapeArray.push(shape)}}.bind(this));$j.each(shapeArray,function(idx,shape){$j(shape.node).fadeTo(0,1);var nodePosition="NE";if(shape._stencil._jsonStencil.id.indexOf("SequenceFlow")!=-1){cross=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,['image',{"id":crossId,"class":"mergeIndicator","xlink:href":ORYX.PATH+"images/silk/arrow_join.png",x:"-12",y:"-20",height:"25px",width:"25px"}]);nodePosition="C"}else if(shape._svgShapes&&shape._svgShapes.type==="Circle"){cross=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,['image',{"id":crossId,"class":"mergeIndicator","xlink:href":ORYX.PATH+"images/silk/arrow_join.png",x:"-18",y:"-15",height:"25px",width:"25px"}]);}else{cross=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,['image',{"id":crossId,"class":"mergeIndicator","xlink:href":ORYX.PATH+"images/silk/arrow_join.png",x:"-20",y:"-10",height:"25px",width:"25px"}]);}
this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:id,shapes:[shape],node:cross,nodePosition:nodePosition});this.raisedEventIds.push(id);}.bind(this));},removeMergeIconOverlay:function(){$j(this.raisedEventIds).each(function(idx,id){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:id});}.bind(this))}});Ext.form.FlowGrid=Ext.extend(Ext.grid.GridPanel,{data:null,url:null,initComponent:function(){var columns=[],storeCfg;if(!this.initialConfig.isVersionWindow){columns.push({id:'title',header:ORYX.I18N.Merge.workflowNameHeader,width:55,sortable:true,sortType:Ext.data.SortTypes.asUCString,dataIndex:'title'});storeCfg={root:'models',sortInfo:{field:'title',direction:'ASC'},fields:['identId',new Ext.data.Field({name:'title',sortType:Ext.data.SortTypes.asUCString}),new Ext.data.Field({name:'title',sortType:Ext.data.SortTypes.asUCString})]};}else{columns.push({id:'version',header:ORYX.I18N.Merge.version,width:20,sortable:true,dataIndex:'version'},{id:'description',header:ORYX.I18N.Merge.description,width:55,sortable:true,dataIndex:'description'});storeCfg={root:'rows',fields:['id','description','version','thumbnailUri','subject_name']};}
if(this.cm==null){var columns=columns;if(this.autoExpandColumn==null||!this.autoExpandColumn)
this.autoExpandColumn=columns[columns.length-1].id;this.cm=new Ext.grid.ColumnModel(columns);}
if(this.data!=null){Ext.apply(storeCfg,{data:this.data});}else if(this.url!=null){Ext.apply(storeCfg,{url:this.url,autoLoad:true});}
var store=new Ext.data.JsonStore(storeCfg);var cfg={enableDragDrop:false,enableColumnHide:false,enableColumnMove:false,enableHdMenu:false,store:store,clicksToEdit:1,stripeRows:true,selModel:new Ext.grid.RowSelectionModel({singleSelect:true,listeners:{beforerowselect:function(sm,i,ke,row){}}})};Ext.apply(this,cfg);Ext.form.FlowGrid.superclass.initComponent.call(this);}});var $j=jQuery.noConflict();if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.OnlineDocumentation=ORYX.Plugins.AbstractPlugin.extend({construct:function(facade){this.facade=facade;this.docWindows={};this.gridKeyList=[];this.urlGetServiceOperation='/configweb/rest/7.0/serviceoperations/';this.urlGetServiceOperationsAll='/configweb/rest/7.0/serviceoperations?fields=name';this.iconClass='documentationIcon ko-info-circle';this.docWindowIdRoot='documentationWindow-';this.docWindowMargin=20;ORYX.Plugins.OnlineDocumentation.getIconClass=this.getIconClass.bind(this);ORYX.Plugins.OnlineDocumentation.getIconClassSelector=this.getIconClassSelector.bind(this);ORYX.Plugins.OnlineDocumentation.hasTitle=this.hasTitle.bind(this);ORYX.Plugins.OnlineDocumentation.getServiceOperationList=this.getServiceOperationList.bind(this);ORYX.Plugins.OnlineDocumentation.setServiceOperationList=this.setServiceOperationList.bind(this);ORYX.Plugins.OnlineDocumentation.show=this.show.bind(this);},getDocumentation:function(){var that=this;var complete=$j.Deferred();var fieldsRequired=["info","metadata","roleDescription","modelInputs","resultProperties","resultAnalysis","actionProperties","southBoundSystems","userRoles"];var url=this.urlGetServiceOperation+
this.subject.name+"?fields="+fieldsRequired.join(',');$j.when($j.getJSON(url)).done(function(dataArray){that.docData=dataArray;complete.resolve();}).fail(function(response){var errBox=$j('<div/>').css({'display':'inline-block'}).text(response.statusText).append($j('<div/>').text(String.format(ORYX.I18N.OnlineDocumentation.Modal.status,response.status))).append($j('<div/>').text(String.format(ORYX.I18N.OnlineDocumentation.Modal.method,this.type))).append($j('<div/>').text(String.format(ORYX.I18N.OnlineDocumentation.Modal.url,this.url)));that.showErrorModal(errBox);complete.reject();});return complete.promise();},getEmptyDataHeader:function(){return new Ext.Panel({border:false,html:"<h5>"+ORYX.I18N.OnlineDocumentation.noData+"</h5>",bodyStyle:{"padding":"15px"}});},getGrid:function(config){return new Ext.grid.GridPanel({id:config.id,store:config.store,colModel:config.colModel,frame:false,style:{'margin-top':'10px'},viewConfig:{forceFit:true,scrollOffset:0}});},getIconClass:function(){return this.iconClass;},getIconClassSelector:function(){return"."+this.iconClass.replace(/\s+/,".");},getSection:function(header,classes){var section=$j('<div/>').append(header);if(classes!==undefined&&classes.length){section.addClass(classes);}
return section;},getStore:function(config){var rt=Ext.data.Record.create(config.fieldsArray);return new Ext.data.Store({reader:new Ext.data.ArrayReader({idIndex:0},rt),sortInfo:{field:config.sortOn,direction:'ASC'}});},hasTitle:function(title){if(!this.serviceOperationList){return false;}
return(this.serviceOperationList.findIndex(function(soDoc){return soDoc.name===title;})!==-1);},getWindowCount:function(){return Object.keys(this.docWindows).length;},getOffsetPair:function(){var windowCnt=this.getWindowCount();var offsetX=this.docWindowMargin+(this.docWindowMargin*windowCnt);var offsetY=this.docWindowMargin+(this.docWindowMargin*windowCnt);return[offsetX,offsetY];},alignWindow:function(){var canvas=Ext.getCmp('x-panel-editor-center-cmp-id').getEl();this.docWindows[this.subject.name].alignTo(canvas,'tl-tl',this.getOffsetPair());},buildWindow:function(){this.setDocumentSections();var panel=new Ext.Panel({items:this.documentSections,bodyStyle:{'overflow':'auto'}});var editorHeaderHeight=$j('#oryx_editor_header').height();var docWin=new Ext.Window({id:this.docWindowIdRoot+this.subject.name,cls:'documentationWindowCls',layout:'fit',title:String.format(ORYX.I18N.OnlineDocumentation.windowTitle,this.subject.title),iconCls:'documentationWindow',height:400,width:800,minHeight:300,minWidth:400,modal:false,maximizable:true,closable:true,shadow:true,items:[panel],buttons:[{text:ORYX.I18N.OnlineDocumentation.windowClose,handler:function(){docWin.close();}.bind(this)}],listeners:{scope:this,maximize:function(window){var size=window.getSize();size.height=size.height-editorHeaderHeight;window.setSize(size);window.setPosition(0,editorHeaderHeight);},resize:function(window){var resizeWidth=$j(window.getEl().dom).width()-53;$j.each(this.gridKeyList,function(i,gridId){var grid=Ext.getCmp(gridId);if(grid!==undefined){grid.setWidth(resizeWidth);}});},show:function(window){$j(window.getEl().dom).find('.x-panel-icon.documentationWindow').prepend($j('<i/>',{class:this.iconClass}));},close:function(window){var key=window.id.replace(new RegExp(this.docWindowIdRoot),'');delete this.docWindows[key];}}});this.docWindows[this.subject.name]=docWin;},pushSection:function(config){var panelItems=[];panelItems.push({xtype:'panel',border:false,html:config.header.prop('outerHTML')});if(config.key!==undefined&&config.store!==undefined){var str=config.key;var key='docGrid-'+str.toCamelCase();this.gridKeyList.push(key);var grid=(config.store.getTotalCount()>0)?this.getGrid({id:key,store:config.store,colModel:config.colModel}):this.getEmptyDataHeader();panelItems.push(grid);}
var panel=new Ext.Panel({border:false,cls:'quickDocumentationSection',items:panelItems});this.documentSections.push(panel);},pushSectionActionProperties:function(){var data=[];var header=$j('<h3/>').text(ORYX.I18N.OnlineDocumentation.actionProperties);$j.each(this.docData.actionProprties,function(i,o){if(o.roles===undefined){o.roles=[];}
data.push([i,o.id,o.displayName,o.description,o.roles.join(', ')]);});var store=this.getStore({fieldsArray:[{name:'id'},{name:'oid'},{name:'displayName'},{name:'description'},{name:'roles'}],sortOn:'displayName'});store.loadData(data);var colModel=new Ext.grid.ColumnModel({columns:[{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.name,sortable:true,dataIndex:'displayName'},{header:ORYX.I18N.OnlineDocumentation.id,sortable:true,dataIndex:'oid',width:20},{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.description,sortable:true,dataIndex:'description'},{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.roles,sortable:true,dataIndex:'roles'}]});this.pushSection({key:ORYX.I18N.OnlineDocumentation.actionProperties,store:store,colModel:colModel,header:header});},pushSectionInputParameters:function(){var data=[];var header=$j('<h3/>').text(ORYX.I18N.OnlineDocumentation.inputParameters);$j.each(this.docData.modelInputs,function(i,o){data.push([i,o.key,o.name,o.type,o.properties,o.description]);});var store=this.getStore({fieldsArray:[{name:'id'},{name:'key'},{name:'name'},{name:'type'},{name:'properties'},{name:'description'}],sortOn:'name'});store.loadData(data);var colModel=new Ext.grid.ColumnModel({columns:[{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.name,sortable:true,dataIndex:'name'},{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.key,sortable:true,dataIndex:'key'},{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.type,sortable:true,dataIndex:'type'},{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.properties,sortable:true,dataIndex:'properties'},{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.description,sortable:true,dataIndex:'description'}]});this.pushSection({key:ORYX.I18N.OnlineDocumentation.inputParameters,store:store,colModel:colModel,header:header});},pushSectionResultAnalysis:function(){var data=[];var header=$j('<h3/>').text(ORYX.I18N.OnlineDocumentation.resultAnalysis);$j.each(this.docData.resultAnalysis,function(i,o){data.push([i,o.priority,o.displayName,o.report]);});var store=this.getStore({fieldsArray:[{name:'id'},{name:'priority'},{name:'displayName'},{name:'report'}],sortOn:'priority'});store.loadData(data);var colModel=new Ext.grid.ColumnModel({columns:[{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.priority,sortable:true,dataIndex:'priority',width:20},{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.name,sortable:true,dataIndex:'displayName'},{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.report,sortable:true,dataIndex:'report',width:20}]});this.pushSection({key:ORYX.I18N.OnlineDocumentation.resultAnalysis,store:store,colModel:colModel,header:header});},pushSectionResultProperties:function(){var data=[];var header=$j('<h3/>').text(ORYX.I18N.OnlineDocumentation.resultProperties);$j.each(this.docData.resultProperties,function(i,o){data.push([i,o.name,o.description,o.persistentName,o.report]);});var store=this.getStore({fieldsArray:[{name:'id'},{name:'name'},{name:'description'},{name:'persistentName'},{name:'report'}],sortOn:'name'});store.loadData(data);var colModel=new Ext.grid.ColumnModel({columns:[{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.name,sortable:true,dataIndex:'name'},{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.description,sortable:true,dataIndex:'description'},{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.persistentName,sortable:true,dataIndex:'persistentName'},{header:ORYX.I18N.OnlineDocumentation.ColumnHeader.report,sortable:true,dataIndex:'report',width:20}]});this.pushSection({key:ORYX.I18N.OnlineDocumentation.resultProperties,store:store,colModel:colModel,header:header});},pushSectionName:function(){this.pushSection({header:$j('<h1/>').text(this.subject.title)});},pushSectionRoleDescriptions:function(){var header=$j('<h3/>').text(ORYX.I18N.OnlineDocumentation.description);var hasRoleDescription=this.docData.roleDescription.some(function(o){return o.description!==undefined;});var section,panel;if(hasRoleDescription){section=this.getSection(header,'quickDocumentationSection');$j.each(this.docData.roleDescription,function(i,o){if(o.description!==undefined){if(this.docData.roleDescription.length>1){section.append($j('<h4>').text(String.format(ORYX.I18N.OnlineDocumentation.role,o.roleId)));}
var paragraph=$j('<p/>').html(o.description.replace(/\n/g,"<br />"));section.append(paragraph);}}.bind(this));panel=new Ext.Panel({border:false,html:section.prop('outerHTML')});}else{section=this.getSection(header);var panelItems=[];var subpanel=new Ext.Panel({border:false,html:section.prop('outerHTML')});panelItems.push(subpanel);panelItems.push(this.getEmptyDataHeader());panel=new Ext.Panel({border:false,cls:'quickDocumentationSection',items:panelItems});}
this.documentSections.push(panel);},setDocumentSections:function(){this.documentSections=[];this.pushSectionName();this.pushSectionRoleDescriptions();this.pushSectionInputParameters();this.pushSectionResultProperties();this.pushSectionActionProperties();this.pushSectionResultAnalysis();},getServiceOperationList:function(){return this.serviceOperationList;},setServiceOperationList:function(){var that=this;var complete=$j.Deferred();$j.when($j.getJSON(this.urlGetServiceOperationsAll)).done(function(dataArray){that.serviceOperationList=dataArray;complete.resolve();}).fail(function(response){var errBox=$j('<div/>').css({'display':'inline-block'}).text(ORYX.I18N.OnlineDocumentation.Modal.documentationFailedToLoad).append($j('<div/>').text(String.format(ORYX.I18N.OnlineDocumentation.Modal.status,response.status))).append($j('<div/>').text(String.format(ORYX.I18N.OnlineDocumentation.Modal.method,this.type))).append($j('<div/>').text(String.format(ORYX.I18N.OnlineDocumentation.Modal.url,this.url)));complete.resolve();});return complete.promise();},show:function(subject){this.subject=subject;if(this.docWindows.hasOwnProperty(this.subject.name)){this.docWindows[this.subject.name].show();}else{var loading=Ext.Msg.wait(String.format(ORYX.I18N.OnlineDocumentation.loading,this.subject.name));$j.when(this.getDocumentation()).done(function(){loading.hide();this.buildWindow();this.docWindows[this.subject.name].show();this.alignWindow();}.bind(this));}},showErrorModal:function(msgBox){Ext.Msg.show({title:ORYX.I18N.OnlineDocumentation.Modal.error,msg:msgBox.prop('outerHTML'),buttons:Ext.Msg.OK,animEl:'elId',icon:Ext.MessageBox.ERROR});},showWarningModal:function(msgBox){Ext.Msg.show({title:ORYX.I18N.OnlineDocumentation.Modal.warning,msg:msgBox.prop('outerHTML'),buttons:Ext.Msg.OK,animEl:'elId',icon:Ext.MessageBox.WARNING});}});String.prototype.toCamelCase=function(){return this.replace(/(?:^\w|[A-Z]|\b\w|\s+)/g,function(match,index){if(+match===0)return"";return index==0?match.toLowerCase():match.toUpperCase();});};var $j=jQuery.noConflict();if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.AutoSave=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,interval:null,construct:function(facade){this.facade=facade;ORYX.Plugins.AutoSave.facade=this.facade;ORYX.Plugins.AutoSave.autoSave=this.autoSave.run.bind(this);this.autoSave.interval=ORYX.autoSaveIntervalSeconds*1000;this.start();},stop:function(){ORYX.Log.trace("AutoSave.stop(): "+new Date().format('g:i:s A'));Ext.TaskMgr.stop(this.autoSave);},start:function(){ORYX.Log.trace("AutoSave.start(): "+new Date().format('g:i:s A'));Ext.TaskMgr.start(this.autoSave);},autoSave:{run:function(){if(location.hash.slice(1)&&!ORYX.Plugins.AutoSave.facade.isReadOnly&&ORYX.Plugins.AutoSave.facade.getChangeDifference()){ORYX.Log.debug("AutoSave");ORYX.Plugins.Save.autoSave.functionality();}else{ORYX.Plugins.AutoSave.facade.resolveSavingPromise();}}}});Ext.namespace("ORYX.Plugins");ORYX.Plugins.StatusBar=ORYX.Plugins.AbstractPlugin.extend({construct:function(){ORYX.Log.trace("ORYX.Plugins.StatusBar.construct() - Begin");arguments.callee.$.construct.apply(this,arguments);this.lastSave=null;this.lastSaveTask=null;this.facade.statusbar=function(){var dom=null;var items=new Ext.util.MixedCollection(false);var itemPrefix="oryx-plugins-statusbar-";var status=null;var seperator='<span class="item-sep"></span>';return{init:function(){ORYX.Log.trace("ORYX.Plugins.StatusBar.statusbar.init() - Begin");dom=Ext.DomQuery.selectNode('#x-panel-editor-south-statusbar tr');var html='<td nowrap="nowrap" id="'+itemPrefix+'main" width="100%">'+MOTV.I18N.StatusBar.ready+'</td>';status=Ext.DomHelper.append(dom,html);},addItem:function(key,item){ORYX.Log.trace("ORYX.Plugins.StatusBar.statusbar.addItem() - Begin");var txt=(Ext.util.Format.undef(item.text)==="")?"      ":item.text;var html='<td nowrap="nowrap" id="'+itemPrefix+key+'">';if(item.label!==undefined){html+='<span class="label">'+item.label+':</span>';}
html+='<span class="text">'+txt+'</span>';html+='</td>';Ext.DomHelper.append(dom,seperator);item.dom=Ext.DomHelper.append(dom,html);items.add(key,item);},setStatus:function(text,options){ORYX.Log.trace("ORYX.Plugins.StatusBar.statusbar.setStatus() - Begin");var opts=(options)?options:{};var wait=(opts.delay)?opts.delay:0;window.setTimeout(function(){Ext.fly(itemPrefix+'main').update(text);},wait);},setStatusAndReset:function(text){this.setStatus(text);this.setStatus(MOTV.I18N.StatusBar.ready,{delay:10000});},setItemText:function(key,text){Ext.DomQuery.selectNode('#x-panel-editor-south-statusbar #'+itemPrefix+key+' span.text').update(text);},getItems:function(){return items;}};}();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_STATUS,function(options){if(options.text===ORYX.I18N.Save.saved){this.handleSave();}
if(options.text!==undefined){this.facade.statusbar.setStatusAndReset(options.text);}}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_ENABLE,function(options){if(options.text!==undefined){this.facade.statusbar.setStatus(options.text);}}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_DISABLE,function(options){if(options.text!==undefined){this.facade.statusbar.setStatusAndReset(options.text);}else{this.facade.statusbar.setStatus(MOTV.I18N.StatusBar.ready);}}.bind(this));this.init();},init:function(){ORYX.Log.trace("ORYX.Plugins.StatusBar.init() - Begin");this.lastSave=[];this.facade.statusbar.init();var conversions={aSecond:1000,aMinute:1000*60,anHour:1000*60*60,aDay:1000*60*60*24};var versionInitial="0";if(ORYX.RepositoryHelper.modelMeta){if(ORYX.RepositoryHelper.modelMeta.lastUpdateMilliseconds!==undefined){this.lastSave.push(new Date(ORYX.RepositoryHelper.modelMeta.lastUpdateMilliseconds));}
if(ORYX.RepositoryHelper.modelMeta.version!==undefined){versionInitial=ORYX.RepositoryHelper.modelMeta.version;}
if(ORYX.RepositoryHelper.modelMeta.autosave){versionInitial=ORYX.I18N.Save.autoSave;}}
this.facade.statusbar.addItem('lastSave',{label:MOTV.I18N.StatusBar.lastSaved,text:''});this.facade.statusbar.addItem('version',{label:MOTV.I18N.StatusBar.version,text:versionInitial});this.lastSaveTask={run:function(){var info="";var units="";var numSaves=this.lastSave.length;var currDate=new Date();if(this.lastSave.length==0){info=MOTV.I18N.StatusBar.never;}else{var n="",u="";var diff=currDate.getElapsed(this.lastSave[numSaves-1]);if(diff<conversions.aSecond){n=MOTV.I18N.StatusBar.lessThan;u=MOTV.I18N.StatusBar.second;}else if(diff<conversions.aMinute){n=Math.floor((diff/conversions.aSecond));u=(n==1)?MOTV.I18N.StatusBar.second:MOTV.I18N.StatusBar.seconds;}else if(diff<conversions.anHour){n=Math.floor((diff/conversions.aMinute));u=(n==1)?MOTV.I18N.StatusBar.minute:MOTV.I18N.StatusBar.minutes;}else if(diff<conversions.aDay){n=Math.floor((diff/conversions.anHour));u=(n==1)?MOTV.I18N.StatusBar.hour:MOTV.I18N.StatusBar.hours;}else{n=Math.floor((diff/conversions.aDay));u=(n==1)?MOTV.I18N.StatusBar.day:MOTV.I18N.StatusBar.days;}
info=String.format(MOTV.I18N.StatusBar.lastSavedFormat,n,u);}
this.facade.statusbar.setItemText('lastSave',info);}.bind(this),interval:30000};Ext.TaskMgr.start(this.lastSaveTask);},handleSave:function(){ORYX.Log.trace("ORYX.Plugins.StatusBar.init() - Begin");Ext.TaskMgr.stop(this.lastSaveTask);this.lastSave.push(new Date());Ext.TaskMgr.start(this.lastSaveTask);}});if(!ORYX.Plugins)
ORYX.Plugins=new Object();ORYX.Plugins.Edit=Clazz.extend({construct:function(facade){this.facade=facade;this.clipboard=window.opener.RepositoryClipBoard;this.pofActivityCut=false;this.facade.offer({name:ORYX.I18N.Edit.cut,description:ORYX.I18N.Edit.cutDesc,icon:ORYX.PATH+"images/cut.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:88,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editCut),group:ORYX.I18N.Edit.group,index:1,minShape:1});this.facade.offer({name:ORYX.I18N.Edit.copy,description:ORYX.I18N.Edit.copyDesc,icon:ORYX.PATH+"images/page_copy.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:67,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editCopy,[true,false]),group:ORYX.I18N.Edit.group,index:2,minShape:1});this.facade.offer({name:ORYX.I18N.Edit.paste,description:ORYX.I18N.Edit.pasteDesc,icon:ORYX.PATH+"images/page_paste.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:86,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editPaste),isEnabled:this.clipboard.isOccupied.bind(this.clipboard),group:ORYX.I18N.Edit.group,index:3,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.Edit.del,description:ORYX.I18N.Edit.delDesc,icon:ORYX.PATH+"images/cross.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:8,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN},{keyCode:46,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editDelete),group:ORYX.I18N.Edit.group,index:4,minShape:1});ORYX.Plugins.Edit.editDelete=this.editDelete.bind(this);},callEdit:function(fn,args){window.setTimeout(function(){fn.apply(this,(args instanceof Array?args:[]));}.bind(this),1);},handleMouseDown:function(event){if(this._controlPressed){this._controlPressed=false;this.editCopy();console.log("copiedEle: %0",this.clipboard.shapesAsJson)
console.log("mousevent: %o",event)
this.editPaste();event.forceExecution=true;this.facade.raiseEvent(event,this.clipboard.shapesAsJson);}},getAllShapesToConsider:function(shapes){var shapesToConsider=[];var childShapesToConsider=[];shapes.each(function(shape){isChildShapeOfAnother=shapes.any(function(s2){return s2.hasChildShape(shape);});if(isChildShapeOfAnother)return;shapesToConsider.push(shape);if(shape instanceof ORYX.Core.Node){var attached=shape.getOutgoingNodes();attached=attached.findAll(function(a){return!shapes.include(a)});shapesToConsider=shapesToConsider.concat(attached);}
childShapesToConsider=childShapesToConsider.concat(shape.getChildShapes(true));}.bind(this));var edgesToConsider=this.facade.getCanvas().getChildEdges().select(function(edge){if(shapesToConsider.include(edge))return false;if(edge.getAllDockedShapes().size()===0)return false;return edge.getAllDockedShapes().all(function(shape){return shape instanceof ORYX.Core.Edge||childShapesToConsider.include(shape);});});shapesToConsider=shapesToConsider.concat(edgesToConsider);return shapesToConsider;},editCut:function(){this.editCopy(false,true);this.editDelete(true);if(this.facade.isPOF()){this.pofActivityCut=true;}
return false;},editCopy:function(will_update,useNoOffset){var selection=this.facade.getSelection();if(selection.length==0)return;this.clipboard.setId(this.facade.getCanvas().id);this.clipboard.refresh(selection,this.getAllShapesToConsider(selection),this.facade.getCanvas().getStencil().stencilSet().namespace(),useNoOffset);if(will_update)this.facade.updateSelection();},editPaste:function(){var pasteToOriginalCanvas=this.facade.getCanvas().id==this.clipboard.getId();if(this.facade.isPOF()){if(pasteToOriginalCanvas&&!this.pofActivityCut){var msgBox=$j('<div/>').css({'display':'inline-block'}).append($j('<div/>').text(ORYX.I18N.Edit.activitiesUnique));this.showInfoModal(msgBox);return false;}else{this.pofActivityCut=false;var index=-1;var duplicateShapeNames=[];var shapes=this.facade.getCanvas().getChildShapes(true);if(shapes.length){shapes.each(function(canvasShape){var canvasShapeName=canvasShape.getStencil()._jsonStencil.internalName;index=this.clipboard.shapesAsJson.findIndex(function(copy){var copyShapeName=copy.getShape()._stencil._jsonStencil.internalName;return copyShapeName===canvasShapeName;});if(index!==-1){this.clipboard.removeShapeAt(index);duplicateShapeNames.push(canvasShapeName);}}.bind(this));}
if(duplicateShapeNames.length){var duplicateShapeNamesUl=$j('<ul/>',{class:'modalList'});$j.each(duplicateShapeNames,function(i,name){duplicateShapeNamesUl.append($j('<li/>').text(name));});var msgBox=$j('<div/>').css({'display':'inline-block'}).append($j('<div/>').text(ORYX.I18N.Edit.activitiesUnique)).append($j('<p/>').text(ORYX.I18N.Edit.activitiesDuplicatePaste)).append(duplicateShapeNamesUl);this.showInfoModal(msgBox);}}}
var canvas={childShapes:this.clipboard.shapesAsJson,stencilset:{namespace:this.clipboard.SSnamespace}}
Ext.apply(canvas,ORYX.Core.AbstractShape.JSONHelper);var childShapeResourceIds=canvas.getChildShapes(true).pluck("resourceId");var shapesWithSignal=[];var outgoings={};var signalIdMap={};var tempSigIdPrefix="idFor_";canvas.eachChild(function(shape,parent){if(shape.properties.overrideid){shape.properties.overrideid=shape.stencil.id+ORYX.Editor.provideId().substring(4);}else if(shape.properties.name){var alteredName=shape.properties.name;var tailString="";if(alteredName.lastIndexOf("_"))
{tailString=alteredName.substring(alteredName.lastIndexOf("_")+1,alteredName.length);}
if(ORYX.Editor.isGUUID(tailString))
{alteredName=alteredName.substring(0,alteredName.lastIndexOf("_"+tailString));}
if(ORYX.Editor.autoUUID(shape.stencil.id))
{shape.properties.name=alteredName+ORYX.Editor.provideId().substring(4);}}else if(shape.properties.conditionexpression&&shape.properties.conditiontype=="Named"){if(!signalIdMap[shape.resourceId])signalIdMap[shape.resourceId]=tempSigIdPrefix+escape(shape.properties.conditionexpression.replace(/\s/g,''));}
if(shape.properties.signalcfg){shapesWithSignal.push(shape);}
shape.outgoing=shape.outgoing.select(function(out){return childShapeResourceIds.include(out.resourceId);});shape.outgoing.each(function(out){if(!outgoings[out.resourceId]){outgoings[out.resourceId]=[]}
outgoings[out.resourceId].push(shape)});return shape;}.bind(this),true,true);Ext.each(shapesWithSignal,function(shapeWithSig){var signalcfg=shapeWithSig.properties.signalcfg;if(Object.keys(signalIdMap).length){Ext.each(Object.keys(signalIdMap),function(sequenceFlowResourceId){signalcfg=signalcfg.replace(sequenceFlowResourceId,signalIdMap[sequenceFlowResourceId]);});}else{signalcfg="";}
shapeWithSig.properties.signalcfg=signalcfg;});canvas.eachChild(function(shape,parent){if(shape.target&&!(childShapeResourceIds.include(shape.target.resourceId))){shape.target=undefined;shape.targetRemoved=true;}
if(shape.dockers&&shape.dockers.length>=1&&shape.dockers[0].getDocker&&((shape.dockers[0].getDocker().getDockedShape()&&!childShapeResourceIds.include(shape.dockers[0].getDocker().getDockedShape().resourceId))||!shape.getShape().dockers[0].getDockedShape()&&!outgoings[shape.resourceId])){shape.sourceRemoved=true;}
return shape;}.bind(this),true,true);canvas.eachChild(function(shape,parent){if(this.clipboard.useOffset){shape.bounds={lowerRight:{x:shape.bounds.lowerRight.x+ORYX.CONFIG.COPY_MOVE_OFFSET,y:shape.bounds.lowerRight.y+ORYX.CONFIG.COPY_MOVE_OFFSET},upperLeft:{x:shape.bounds.upperLeft.x+ORYX.CONFIG.COPY_MOVE_OFFSET,y:shape.bounds.upperLeft.y+ORYX.CONFIG.COPY_MOVE_OFFSET}};}
if(shape.dockers){shape.dockers=shape.dockers.map(function(docker,i){if((shape.targetRemoved===true&&i==shape.dockers.length-1&&docker.getDocker)||(shape.sourceRemoved===true&&i==0&&docker.getDocker)){docker=docker.getDocker().bounds.center();}
if((i==0&&docker.getDocker instanceof Function&&shape.sourceRemoved!==true&&(docker.getDocker().getDockedShape()||((outgoings[shape.resourceId]||[]).length>0&&(!(shape.getShape()instanceof ORYX.Core.Node)||outgoings[shape.resourceId][0].getShape()instanceof ORYX.Core.Node))))||(i==shape.dockers.length-1&&docker.getDocker instanceof Function&&shape.targetRemoved!==true&&(docker.getDocker().getDockedShape()||shape.target))){return{x:docker.x,y:docker.y,getDocker:docker.getDocker}}else if(this.clipboard.useOffset&&(pasteToOriginalCanvas||(i>0&&i<shape.dockers.length-1))){return{x:docker.x+ORYX.CONFIG.COPY_MOVE_OFFSET,y:docker.y+ORYX.CONFIG.COPY_MOVE_OFFSET,getDocker:docker.getDocker};}else{return{x:docker.x,y:docker.y,getDocker:docker.getDocker};}}.bind(this));}else if(shape.getShape()instanceof ORYX.Core.Node&&shape.dockers&&shape.dockers.length>0&&(!shape.dockers.first().getDocker||shape.sourceRemoved===true||!(shape.dockers.first().getDocker().getDockedShape()||outgoings[shape.resourceId]))){shape.dockers=shape.dockers.map(function(docker,i){if((shape.sourceRemoved===true&&i==0&&docker.getDocker)){docker=docker.getDocker().bounds.center();}
if(this.clipboard.useOffset){return{x:docker.x+ORYX.CONFIG.COPY_MOVE_OFFSET,y:docker.y+ORYX.CONFIG.COPY_MOVE_OFFSET,getDocker:docker.getDocker};}else{return{x:docker.x,y:docker.y,getDocker:docker.getDocker};}}.bind(this));}
return shape;}.bind(this),false,true);this.clipboard.useOffset=true;this.facade.importJSON(canvas);if(shapesWithSignal.length){var signalShapesToUpdate=this.facade.getCanvas().getChildShapes(true).findAll(function(shape){var regexp=new RegExp(tempSigIdPrefix);return(shape.properties!==undefined&&shape.properties["oryx-signalcfg"]!==undefined&&regexp.test(shape.properties["oryx-signalcfg"]));});Ext.each(signalShapesToUpdate,function(shape){var signalCfgJSONArray=Ext.util.JSON.decode(shape.properties["oryx-signalcfg"]).signals;var updatedSignalCfgJSONArray=[];Ext.each(shape.outgoing,function(sOut){var sig=signalCfgJSONArray.find(function(tempSig){return tempSig.id==tempSigIdPrefix+escape(sOut.properties["oryx-conditionexpression"].replace(/\s/g,''));});if(sig){sig.id=sOut.resourceId;updatedSignalCfgJSONArray.push(sig);}});if(updatedSignalCfgJSONArray.length){shape.properties["oryx-signalcfg"]='{"signals":'+Ext.util.JSON.encode(updatedSignalCfgJSONArray)+"}";}else{shape.properties["oryx-signalcfg"]="";}});}},editDelete:function(){var selection=this.facade.getSelection();var clipboard=new ORYX.Plugins.Edit.ClipBoard();clipboard.refresh(selection,this.getAllShapesToConsider(selection));var command=new ORYX.Plugins.Edit.DeleteCommand(this,clipboard);this.facade.executeCommands([command]);},setPofActivityCut:function(booleanState){this.pofActivityCut=booleanState;},showInfoModal:function(msgBox){Ext.Msg.show({title:ORYX.I18N.Edit.information,msg:msgBox.prop('outerHTML'),buttons:Ext.Msg.OK,animEl:'elId',icon:Ext.MessageBox.INFO});}});ORYX.Plugins.Edit.ClipBoard=Clazz.extend({construct:function(){this.shapesAsJson=[];this.selection=[];this.SSnamespace="";this.useOffset=true;},isOccupied:function(){return this.shapesAsJson.length>0;},refresh:function(selection,shapes,namespace,useNoOffset){this.selection=selection;this.SSnamespace=namespace;this.outgoings={};this.parents={};this.targets={};this.useOffset=useNoOffset!==true;this.shapesAsJson=shapes.map(function(shape){var s=shape.toJSON();s.parent={resourceId:shape.getParentShape().resourceId};s.parentIndex=shape.getParentShape().getChildShapes().indexOf(shape)
return s;});}});ORYX.Plugins.Edit.DeleteCommand=ORYX.Core.Command.extend({construct:function(plugin,clipboard){this.plugin=plugin;this.clipboard=clipboard;this.shapesAsJson=clipboard.shapesAsJson;this.facade=plugin.facade;this._isPOF=this.facade.isPOF();this.dockers=this.shapesAsJson.map(function(shapeAsJson){var shape=shapeAsJson.getShape();var incomingDockers=shape.getIncomingShapes().map(function(s){return s.getDockers().last()})
var outgoingDockers=shape.getOutgoingShapes().map(function(s){return s.getDockers().first()})
var dockers=shape.getDockers().concat(incomingDockers,outgoingDockers).compact().map(function(docker){return{object:docker,referencePoint:docker.referencePoint,dockedShape:docker.getDockedShape()};});return dockers;}).flatten();},execute:function(){if(this._isPOF&&ORYX.Plugins.PofMapper.hasMappedActivity(this.clipboard.selection)){var msgBox=$j('<div/>').css({'display':'inline-block'}).html(ORYX.I18N.Edit.delPofWarning);Ext.Msg.show({title:ORYX.I18N.Edit.warning,msg:msgBox.prop('outerHTML'),buttons:Ext.Msg.YESNO,animEl:'elId',icon:Ext.MessageBox.WARNING,fn:function(button){if(button==='yes'){this.doPOFJsonEdit();this.doExecute();}},scope:this});}else{this.doExecute();}},doExecute:function(){this.shapesAsJson.each(function(shapeAsJson){this.facade.deleteShape(shapeAsJson.getShape());}.bind(this));this.facade.setSelection([]);this.facade.getCanvas().update();this.facade.updateSelection();if(this._isPOF){this.plugin.setPofActivityCut(true);ORYX.Plugins.ShapeRepository.enableTreeNodeByShape(this.clipboard.selection);this.deleteFromActivityOrderJson(this.clipboard.selection);}},deleteFromActivityOrderJson:function(shapes){this.oldActivityOrder=this.facade.getActivityOrder();this.newActivityOrder=[];$j.each(this.oldActivityOrder,function(i,activityName){if(shapes.findIndex(function(shape){return shape._stencil._jsonStencil.internalName===activityName;})===-1){this.newActivityOrder.push(activityName);}}.bind(this));this.facade.setActivityOrder(this.newActivityOrder);},doPOFJsonEdit:function(){ORYX.Plugins.PofMapper.deleteActivitiesFromPofParam(this.clipboard.selection);},rollback:function(){var shapes=[];this.shapesAsJson.each(function(shapeAsJson){var shape=shapeAsJson.getShape();var parent=this.facade.getCanvas().getChildShapeByResourceId(shapeAsJson.parent.resourceId)||this.facade.getCanvas();parent.add(shape,shape.parentIndex);shapes.push(shape);}.bind(this));this.dockers.each(function(d){d.object.setDockedShape(d.dockedShape);d.object.setReferencePoint(d.referencePoint);}.bind(this));this.facade.setSelection(this.selectedShapes);this.facade.getCanvas().update();this.facade.updateSelection();if(this._isPOF){this.plugin.setPofActivityCut(false);ORYX.Plugins.ShapeRepository.disableTreeNodeByShape(shapes);this.facade.setActivityOrder(this.oldActivityOrder);}}});var $j=jQuery.noConflict();